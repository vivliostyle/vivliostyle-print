{
  "version": 3,
  "sources": ["../node_modules/node_modules/fast-diff/diff.js", "../node_modules/@vivliostyle/core/src/vivliostyle.ts", "../node_modules/@vivliostyle/core/src/vivliostyle/constants.ts", "../node_modules/@vivliostyle/core/src/vivliostyle/logging.ts", "../node_modules/@vivliostyle/core/src/vivliostyle/plugin.ts", "../node_modules/@vivliostyle/core/src/vivliostyle/profile.ts", "../node_modules/@vivliostyle/core/src/vivliostyle/base.ts", "../node_modules/@vivliostyle/core/src/vivliostyle/cfi.ts", "../node_modules/@vivliostyle/core/src/vivliostyle/exprs.ts", "../node_modules/@vivliostyle/core/src/vivliostyle/css.ts", "../node_modules/@vivliostyle/core/src/vivliostyle/geometry-util.ts", "../node_modules/@vivliostyle/core/src/vivliostyle/css-prop.ts", "../node_modules/@vivliostyle/core/src/vivliostyle/counters.ts", "../node_modules/@vivliostyle/core/src/vivliostyle/css-tokenizer.ts", "../node_modules/@vivliostyle/core/src/vivliostyle/task.ts", "../node_modules/@vivliostyle/core/src/vivliostyle/task-util.ts", "../node_modules/@vivliostyle/core/src/vivliostyle/assets.ts", "../node_modules/@vivliostyle/core/src/vivliostyle/net.ts", "../node_modules/@vivliostyle/core/src/vivliostyle/css-parser.ts", "../node_modules/@vivliostyle/core/src/vivliostyle/css-logical-util.ts", "../node_modules/@vivliostyle/core/src/vivliostyle/sizing.ts", "../node_modules/@vivliostyle/core/src/vivliostyle/break.ts", "../node_modules/@vivliostyle/core/src/vivliostyle/diff.ts", "../node_modules/@vivliostyle/core/src/vivliostyle/types.ts", "../node_modules/@vivliostyle/core/src/vivliostyle/vtree.ts", "../node_modules/@vivliostyle/core/src/vivliostyle/page-floats.ts", "../node_modules/@vivliostyle/core/src/vivliostyle/footnotes.ts", "../node_modules/@vivliostyle/core/src/vivliostyle/display.ts", "../node_modules/@vivliostyle/core/src/vivliostyle/layout-helper.ts", "../node_modules/@vivliostyle/core/src/vivliostyle/break-position.ts", "../node_modules/@vivliostyle/core/src/vivliostyle/layout-processor.ts", "../node_modules/@vivliostyle/core/src/vivliostyle/layout-retryers.ts", "../node_modules/@vivliostyle/core/src/vivliostyle/layout-util.ts", "../node_modules/@vivliostyle/core/src/vivliostyle/shared.ts", "../node_modules/@vivliostyle/core/src/vivliostyle/matchers.ts", "../node_modules/@vivliostyle/core/src/vivliostyle/css-cascade.ts", "../node_modules/@vivliostyle/core/src/vivliostyle/text-polyfill.ts", "../node_modules/@vivliostyle/core/src/vivliostyle/pseudo-element.ts", "../node_modules/@vivliostyle/core/src/vivliostyle/layout.ts", "../node_modules/@vivliostyle/core/src/vivliostyle/repetitive-element.ts", "../node_modules/@vivliostyle/core/src/vivliostyle/table.ts", "../node_modules/@vivliostyle/core/src/vivliostyle/math-util.ts", "../node_modules/@vivliostyle/core/src/vivliostyle/columns.ts", "../node_modules/@vivliostyle/core/src/vivliostyle/counter-style.ts", "../node_modules/@vivliostyle/core/src/vivliostyle/css-styler.ts", "../node_modules/@vivliostyle/core/src/vivliostyle/css-validator.ts", "../node_modules/@vivliostyle/core/src/vivliostyle/font.ts", "../node_modules/@vivliostyle/core/src/vivliostyle/page-master.ts", "../node_modules/@vivliostyle/core/src/vivliostyle/css-page.ts", "../node_modules/@vivliostyle/core/src/vivliostyle/scripts.ts", "../node_modules/@vivliostyle/core/src/vivliostyle/urls.ts", "../node_modules/@vivliostyle/core/src/vivliostyle/vgen.ts", "../node_modules/@vivliostyle/core/src/vivliostyle/xml-doc.ts", "../node_modules/@vivliostyle/core/src/vivliostyle/ops.ts", "../node_modules/@vivliostyle/core/src/vivliostyle/toc.ts", "../node_modules/@vivliostyle/core/src/vivliostyle/epub.ts", "../node_modules/@vivliostyle/core/src/vivliostyle/adaptive-viewer.ts", "../node_modules/@vivliostyle/core/src/vivliostyle/core-viewer.ts", "../node_modules/@vivliostyle/core/src/vivliostyle/print.ts", "../src/index.js", "index.js"],
  "sourcesContent": ["/**\n * This library modifies the diff-patch-match library by Neil Fraser\n * by removing the patch and match functionality and certain advanced\n * options in the diff function. The original license is as follows:\n *\n * ===\n *\n * Diff Match and Patch\n *\n * Copyright 2006 Google Inc.\n * http://code.google.com/p/google-diff-match-patch/\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *   http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * The data structure representing a diff is an array of tuples:\n * [[DIFF_DELETE, 'Hello'], [DIFF_INSERT, 'Goodbye'], [DIFF_EQUAL, ' world.']]\n * which means: delete 'Hello', add 'Goodbye' and keep ' world.'\n */\nvar DIFF_DELETE = -1;\nvar DIFF_INSERT = 1;\nvar DIFF_EQUAL = 0;\n\n/**\n * Find the differences between two texts.  Simplifies the problem by stripping\n * any common prefix or suffix off the texts before diffing.\n * @param {string} text1 Old string to be diffed.\n * @param {string} text2 New string to be diffed.\n * @param {Int|Object} [cursor_pos] Edit position in text1 or object with more info\n * @param {boolean} [cleanup] Apply semantic cleanup before returning.\n * @return {Array} Array of diff tuples.\n */\nfunction diff_main(text1, text2, cursor_pos, cleanup, _fix_unicode) {\n  // Check for equality\n  if (text1 === text2) {\n    if (text1) {\n      return [[DIFF_EQUAL, text1]];\n    }\n    return [];\n  }\n\n  if (cursor_pos != null) {\n    var editdiff = find_cursor_edit_diff(text1, text2, cursor_pos);\n    if (editdiff) {\n      return editdiff;\n    }\n  }\n\n  // Trim off common prefix (speedup).\n  var commonlength = diff_commonPrefix(text1, text2);\n  var commonprefix = text1.substring(0, commonlength);\n  text1 = text1.substring(commonlength);\n  text2 = text2.substring(commonlength);\n\n  // Trim off common suffix (speedup).\n  commonlength = diff_commonSuffix(text1, text2);\n  var commonsuffix = text1.substring(text1.length - commonlength);\n  text1 = text1.substring(0, text1.length - commonlength);\n  text2 = text2.substring(0, text2.length - commonlength);\n\n  // Compute the diff on the middle block.\n  var diffs = diff_compute_(text1, text2);\n\n  // Restore the prefix and suffix.\n  if (commonprefix) {\n    diffs.unshift([DIFF_EQUAL, commonprefix]);\n  }\n  if (commonsuffix) {\n    diffs.push([DIFF_EQUAL, commonsuffix]);\n  }\n  diff_cleanupMerge(diffs, _fix_unicode);\n  if (cleanup) {\n    diff_cleanupSemantic(diffs);\n  }\n  return diffs;\n}\n\n/**\n * Find the differences between two texts.  Assumes that the texts do not\n * have any common prefix or suffix.\n * @param {string} text1 Old string to be diffed.\n * @param {string} text2 New string to be diffed.\n * @return {Array} Array of diff tuples.\n */\nfunction diff_compute_(text1, text2) {\n  var diffs;\n\n  if (!text1) {\n    // Just add some text (speedup).\n    return [[DIFF_INSERT, text2]];\n  }\n\n  if (!text2) {\n    // Just delete some text (speedup).\n    return [[DIFF_DELETE, text1]];\n  }\n\n  var longtext = text1.length > text2.length ? text1 : text2;\n  var shorttext = text1.length > text2.length ? text2 : text1;\n  var i = longtext.indexOf(shorttext);\n  if (i !== -1) {\n    // Shorter text is inside the longer text (speedup).\n    diffs = [\n      [DIFF_INSERT, longtext.substring(0, i)],\n      [DIFF_EQUAL, shorttext],\n      [DIFF_INSERT, longtext.substring(i + shorttext.length)],\n    ];\n    // Swap insertions for deletions if diff is reversed.\n    if (text1.length > text2.length) {\n      diffs[0][0] = diffs[2][0] = DIFF_DELETE;\n    }\n    return diffs;\n  }\n\n  if (shorttext.length === 1) {\n    // Single character string.\n    // After the previous speedup, the character can't be an equality.\n    return [\n      [DIFF_DELETE, text1],\n      [DIFF_INSERT, text2],\n    ];\n  }\n\n  // Check to see if the problem can be split in two.\n  var hm = diff_halfMatch_(text1, text2);\n  if (hm) {\n    // A half-match was found, sort out the return data.\n    var text1_a = hm[0];\n    var text1_b = hm[1];\n    var text2_a = hm[2];\n    var text2_b = hm[3];\n    var mid_common = hm[4];\n    // Send both pairs off for separate processing.\n    var diffs_a = diff_main(text1_a, text2_a);\n    var diffs_b = diff_main(text1_b, text2_b);\n    // Merge the results.\n    return diffs_a.concat([[DIFF_EQUAL, mid_common]], diffs_b);\n  }\n\n  return diff_bisect_(text1, text2);\n}\n\n/**\n * Find the 'middle snake' of a diff, split the problem in two\n * and return the recursively constructed diff.\n * See Myers 1986 paper: An O(ND) Difference Algorithm and Its Variations.\n * @param {string} text1 Old string to be diffed.\n * @param {string} text2 New string to be diffed.\n * @return {Array} Array of diff tuples.\n * @private\n */\nfunction diff_bisect_(text1, text2) {\n  // Cache the text lengths to prevent multiple calls.\n  var text1_length = text1.length;\n  var text2_length = text2.length;\n  var max_d = Math.ceil((text1_length + text2_length) / 2);\n  var v_offset = max_d;\n  var v_length = 2 * max_d;\n  var v1 = new Array(v_length);\n  var v2 = new Array(v_length);\n  // Setting all elements to -1 is faster in Chrome & Firefox than mixing\n  // integers and undefined.\n  for (var x = 0; x < v_length; x++) {\n    v1[x] = -1;\n    v2[x] = -1;\n  }\n  v1[v_offset + 1] = 0;\n  v2[v_offset + 1] = 0;\n  var delta = text1_length - text2_length;\n  // If the total number of characters is odd, then the front path will collide\n  // with the reverse path.\n  var front = delta % 2 !== 0;\n  // Offsets for start and end of k loop.\n  // Prevents mapping of space beyond the grid.\n  var k1start = 0;\n  var k1end = 0;\n  var k2start = 0;\n  var k2end = 0;\n  for (var d = 0; d < max_d; d++) {\n    // Walk the front path one step.\n    for (var k1 = -d + k1start; k1 <= d - k1end; k1 += 2) {\n      var k1_offset = v_offset + k1;\n      var x1;\n      if (k1 === -d || (k1 !== d && v1[k1_offset - 1] < v1[k1_offset + 1])) {\n        x1 = v1[k1_offset + 1];\n      } else {\n        x1 = v1[k1_offset - 1] + 1;\n      }\n      var y1 = x1 - k1;\n      while (\n        x1 < text1_length &&\n        y1 < text2_length &&\n        text1.charAt(x1) === text2.charAt(y1)\n      ) {\n        x1++;\n        y1++;\n      }\n      v1[k1_offset] = x1;\n      if (x1 > text1_length) {\n        // Ran off the right of the graph.\n        k1end += 2;\n      } else if (y1 > text2_length) {\n        // Ran off the bottom of the graph.\n        k1start += 2;\n      } else if (front) {\n        var k2_offset = v_offset + delta - k1;\n        if (k2_offset >= 0 && k2_offset < v_length && v2[k2_offset] !== -1) {\n          // Mirror x2 onto top-left coordinate system.\n          var x2 = text1_length - v2[k2_offset];\n          if (x1 >= x2) {\n            // Overlap detected.\n            return diff_bisectSplit_(text1, text2, x1, y1);\n          }\n        }\n      }\n    }\n\n    // Walk the reverse path one step.\n    for (var k2 = -d + k2start; k2 <= d - k2end; k2 += 2) {\n      var k2_offset = v_offset + k2;\n      var x2;\n      if (k2 === -d || (k2 !== d && v2[k2_offset - 1] < v2[k2_offset + 1])) {\n        x2 = v2[k2_offset + 1];\n      } else {\n        x2 = v2[k2_offset - 1] + 1;\n      }\n      var y2 = x2 - k2;\n      while (\n        x2 < text1_length &&\n        y2 < text2_length &&\n        text1.charAt(text1_length - x2 - 1) ===\n          text2.charAt(text2_length - y2 - 1)\n      ) {\n        x2++;\n        y2++;\n      }\n      v2[k2_offset] = x2;\n      if (x2 > text1_length) {\n        // Ran off the left of the graph.\n        k2end += 2;\n      } else if (y2 > text2_length) {\n        // Ran off the top of the graph.\n        k2start += 2;\n      } else if (!front) {\n        var k1_offset = v_offset + delta - k2;\n        if (k1_offset >= 0 && k1_offset < v_length && v1[k1_offset] !== -1) {\n          var x1 = v1[k1_offset];\n          var y1 = v_offset + x1 - k1_offset;\n          // Mirror x2 onto top-left coordinate system.\n          x2 = text1_length - x2;\n          if (x1 >= x2) {\n            // Overlap detected.\n            return diff_bisectSplit_(text1, text2, x1, y1);\n          }\n        }\n      }\n    }\n  }\n  // Diff took too long and hit the deadline or\n  // number of diffs equals number of characters, no commonality at all.\n  return [\n    [DIFF_DELETE, text1],\n    [DIFF_INSERT, text2],\n  ];\n}\n\n/**\n * Given the location of the 'middle snake', split the diff in two parts\n * and recurse.\n * @param {string} text1 Old string to be diffed.\n * @param {string} text2 New string to be diffed.\n * @param {number} x Index of split point in text1.\n * @param {number} y Index of split point in text2.\n * @return {Array} Array of diff tuples.\n */\nfunction diff_bisectSplit_(text1, text2, x, y) {\n  var text1a = text1.substring(0, x);\n  var text2a = text2.substring(0, y);\n  var text1b = text1.substring(x);\n  var text2b = text2.substring(y);\n\n  // Compute both diffs serially.\n  var diffs = diff_main(text1a, text2a);\n  var diffsb = diff_main(text1b, text2b);\n\n  return diffs.concat(diffsb);\n}\n\n/**\n * Determine the common prefix of two strings.\n * @param {string} text1 First string.\n * @param {string} text2 Second string.\n * @return {number} The number of characters common to the start of each\n *     string.\n */\nfunction diff_commonPrefix(text1, text2) {\n  // Quick check for common null cases.\n  if (!text1 || !text2 || text1.charAt(0) !== text2.charAt(0)) {\n    return 0;\n  }\n  // Binary search.\n  // Performance analysis: http://neil.fraser.name/news/2007/10/09/\n  var pointermin = 0;\n  var pointermax = Math.min(text1.length, text2.length);\n  var pointermid = pointermax;\n  var pointerstart = 0;\n  while (pointermin < pointermid) {\n    if (\n      text1.substring(pointerstart, pointermid) ==\n      text2.substring(pointerstart, pointermid)\n    ) {\n      pointermin = pointermid;\n      pointerstart = pointermin;\n    } else {\n      pointermax = pointermid;\n    }\n    pointermid = Math.floor((pointermax - pointermin) / 2 + pointermin);\n  }\n\n  if (is_surrogate_pair_start(text1.charCodeAt(pointermid - 1))) {\n    pointermid--;\n  }\n\n  return pointermid;\n}\n\n/**\n * Determine if the suffix of one string is the prefix of another.\n * @param {string} text1 First string.\n * @param {string} text2 Second string.\n * @return {number} The number of characters common to the end of the first\n *     string and the start of the second string.\n * @private\n */\nfunction diff_commonOverlap_(text1, text2) {\n  // Cache the text lengths to prevent multiple calls.\n  var text1_length = text1.length;\n  var text2_length = text2.length;\n  // Eliminate the null case.\n  if (text1_length == 0 || text2_length == 0) {\n    return 0;\n  }\n  // Truncate the longer string.\n  if (text1_length > text2_length) {\n    text1 = text1.substring(text1_length - text2_length);\n  } else if (text1_length < text2_length) {\n    text2 = text2.substring(0, text1_length);\n  }\n  var text_length = Math.min(text1_length, text2_length);\n  // Quick check for the worst case.\n  if (text1 == text2) {\n    return text_length;\n  }\n\n  // Start by looking for a single character match\n  // and increase length until no match is found.\n  // Performance analysis: http://neil.fraser.name/news/2010/11/04/\n  var best = 0;\n  var length = 1;\n  while (true) {\n    var pattern = text1.substring(text_length - length);\n    var found = text2.indexOf(pattern);\n    if (found == -1) {\n      return best;\n    }\n    length += found;\n    if (\n      found == 0 ||\n      text1.substring(text_length - length) == text2.substring(0, length)\n    ) {\n      best = length;\n      length++;\n    }\n  }\n}\n\n/**\n * Determine the common suffix of two strings.\n * @param {string} text1 First string.\n * @param {string} text2 Second string.\n * @return {number} The number of characters common to the end of each string.\n */\nfunction diff_commonSuffix(text1, text2) {\n  // Quick check for common null cases.\n  if (!text1 || !text2 || text1.slice(-1) !== text2.slice(-1)) {\n    return 0;\n  }\n  // Binary search.\n  // Performance analysis: http://neil.fraser.name/news/2007/10/09/\n  var pointermin = 0;\n  var pointermax = Math.min(text1.length, text2.length);\n  var pointermid = pointermax;\n  var pointerend = 0;\n  while (pointermin < pointermid) {\n    if (\n      text1.substring(text1.length - pointermid, text1.length - pointerend) ==\n      text2.substring(text2.length - pointermid, text2.length - pointerend)\n    ) {\n      pointermin = pointermid;\n      pointerend = pointermin;\n    } else {\n      pointermax = pointermid;\n    }\n    pointermid = Math.floor((pointermax - pointermin) / 2 + pointermin);\n  }\n\n  if (is_surrogate_pair_end(text1.charCodeAt(text1.length - pointermid))) {\n    pointermid--;\n  }\n\n  return pointermid;\n}\n\n/**\n * Do the two texts share a substring which is at least half the length of the\n * longer text?\n * This speedup can produce non-minimal diffs.\n * @param {string} text1 First string.\n * @param {string} text2 Second string.\n * @return {Array.<string>} Five element Array, containing the prefix of\n *     text1, the suffix of text1, the prefix of text2, the suffix of\n *     text2 and the common middle.  Or null if there was no match.\n */\nfunction diff_halfMatch_(text1, text2) {\n  var longtext = text1.length > text2.length ? text1 : text2;\n  var shorttext = text1.length > text2.length ? text2 : text1;\n  if (longtext.length < 4 || shorttext.length * 2 < longtext.length) {\n    return null; // Pointless.\n  }\n\n  /**\n   * Does a substring of shorttext exist within longtext such that the substring\n   * is at least half the length of longtext?\n   * Closure, but does not reference any external variables.\n   * @param {string} longtext Longer string.\n   * @param {string} shorttext Shorter string.\n   * @param {number} i Start index of quarter length substring within longtext.\n   * @return {Array.<string>} Five element Array, containing the prefix of\n   *     longtext, the suffix of longtext, the prefix of shorttext, the suffix\n   *     of shorttext and the common middle.  Or null if there was no match.\n   * @private\n   */\n  function diff_halfMatchI_(longtext, shorttext, i) {\n    // Start with a 1/4 length substring at position i as a seed.\n    var seed = longtext.substring(i, i + Math.floor(longtext.length / 4));\n    var j = -1;\n    var best_common = \"\";\n    var best_longtext_a, best_longtext_b, best_shorttext_a, best_shorttext_b;\n    while ((j = shorttext.indexOf(seed, j + 1)) !== -1) {\n      var prefixLength = diff_commonPrefix(\n        longtext.substring(i),\n        shorttext.substring(j)\n      );\n      var suffixLength = diff_commonSuffix(\n        longtext.substring(0, i),\n        shorttext.substring(0, j)\n      );\n      if (best_common.length < suffixLength + prefixLength) {\n        best_common =\n          shorttext.substring(j - suffixLength, j) +\n          shorttext.substring(j, j + prefixLength);\n        best_longtext_a = longtext.substring(0, i - suffixLength);\n        best_longtext_b = longtext.substring(i + prefixLength);\n        best_shorttext_a = shorttext.substring(0, j - suffixLength);\n        best_shorttext_b = shorttext.substring(j + prefixLength);\n      }\n    }\n    if (best_common.length * 2 >= longtext.length) {\n      return [\n        best_longtext_a,\n        best_longtext_b,\n        best_shorttext_a,\n        best_shorttext_b,\n        best_common,\n      ];\n    } else {\n      return null;\n    }\n  }\n\n  // First check if the second quarter is the seed for a half-match.\n  var hm1 = diff_halfMatchI_(\n    longtext,\n    shorttext,\n    Math.ceil(longtext.length / 4)\n  );\n  // Check again based on the third quarter.\n  var hm2 = diff_halfMatchI_(\n    longtext,\n    shorttext,\n    Math.ceil(longtext.length / 2)\n  );\n  var hm;\n  if (!hm1 && !hm2) {\n    return null;\n  } else if (!hm2) {\n    hm = hm1;\n  } else if (!hm1) {\n    hm = hm2;\n  } else {\n    // Both matched.  Select the longest.\n    hm = hm1[4].length > hm2[4].length ? hm1 : hm2;\n  }\n\n  // A half-match was found, sort out the return data.\n  var text1_a, text1_b, text2_a, text2_b;\n  if (text1.length > text2.length) {\n    text1_a = hm[0];\n    text1_b = hm[1];\n    text2_a = hm[2];\n    text2_b = hm[3];\n  } else {\n    text2_a = hm[0];\n    text2_b = hm[1];\n    text1_a = hm[2];\n    text1_b = hm[3];\n  }\n  var mid_common = hm[4];\n  return [text1_a, text1_b, text2_a, text2_b, mid_common];\n}\n\n/**\n * Reduce the number of edits by eliminating semantically trivial equalities.\n * @param {!Array.<!diff_match_patch.Diff>} diffs Array of diff tuples.\n */\nfunction diff_cleanupSemantic(diffs) {\n  var changes = false;\n  var equalities = []; // Stack of indices where equalities are found.\n  var equalitiesLength = 0; // Keeping our own length var is faster in JS.\n  /** @type {?string} */\n  var lastequality = null;\n  // Always equal to diffs[equalities[equalitiesLength - 1]][1]\n  var pointer = 0; // Index of current position.\n  // Number of characters that changed prior to the equality.\n  var length_insertions1 = 0;\n  var length_deletions1 = 0;\n  // Number of characters that changed after the equality.\n  var length_insertions2 = 0;\n  var length_deletions2 = 0;\n  while (pointer < diffs.length) {\n    if (diffs[pointer][0] == DIFF_EQUAL) {\n      // Equality found.\n      equalities[equalitiesLength++] = pointer;\n      length_insertions1 = length_insertions2;\n      length_deletions1 = length_deletions2;\n      length_insertions2 = 0;\n      length_deletions2 = 0;\n      lastequality = diffs[pointer][1];\n    } else {\n      // An insertion or deletion.\n      if (diffs[pointer][0] == DIFF_INSERT) {\n        length_insertions2 += diffs[pointer][1].length;\n      } else {\n        length_deletions2 += diffs[pointer][1].length;\n      }\n      // Eliminate an equality that is smaller or equal to the edits on both\n      // sides of it.\n      if (\n        lastequality &&\n        lastequality.length <=\n          Math.max(length_insertions1, length_deletions1) &&\n        lastequality.length <= Math.max(length_insertions2, length_deletions2)\n      ) {\n        // Duplicate record.\n        diffs.splice(equalities[equalitiesLength - 1], 0, [\n          DIFF_DELETE,\n          lastequality,\n        ]);\n        // Change second copy to insert.\n        diffs[equalities[equalitiesLength - 1] + 1][0] = DIFF_INSERT;\n        // Throw away the equality we just deleted.\n        equalitiesLength--;\n        // Throw away the previous equality (it needs to be reevaluated).\n        equalitiesLength--;\n        pointer = equalitiesLength > 0 ? equalities[equalitiesLength - 1] : -1;\n        length_insertions1 = 0; // Reset the counters.\n        length_deletions1 = 0;\n        length_insertions2 = 0;\n        length_deletions2 = 0;\n        lastequality = null;\n        changes = true;\n      }\n    }\n    pointer++;\n  }\n\n  // Normalize the diff.\n  if (changes) {\n    diff_cleanupMerge(diffs);\n  }\n  diff_cleanupSemanticLossless(diffs);\n\n  // Find any overlaps between deletions and insertions.\n  // e.g: <del>abcxxx</del><ins>xxxdef</ins>\n  //   -> <del>abc</del>xxx<ins>def</ins>\n  // e.g: <del>xxxabc</del><ins>defxxx</ins>\n  //   -> <ins>def</ins>xxx<del>abc</del>\n  // Only extract an overlap if it is as big as the edit ahead or behind it.\n  pointer = 1;\n  while (pointer < diffs.length) {\n    if (\n      diffs[pointer - 1][0] == DIFF_DELETE &&\n      diffs[pointer][0] == DIFF_INSERT\n    ) {\n      var deletion = diffs[pointer - 1][1];\n      var insertion = diffs[pointer][1];\n      var overlap_length1 = diff_commonOverlap_(deletion, insertion);\n      var overlap_length2 = diff_commonOverlap_(insertion, deletion);\n      if (overlap_length1 >= overlap_length2) {\n        if (\n          overlap_length1 >= deletion.length / 2 ||\n          overlap_length1 >= insertion.length / 2\n        ) {\n          // Overlap found.  Insert an equality and trim the surrounding edits.\n          diffs.splice(pointer, 0, [\n            DIFF_EQUAL,\n            insertion.substring(0, overlap_length1),\n          ]);\n          diffs[pointer - 1][1] = deletion.substring(\n            0,\n            deletion.length - overlap_length1\n          );\n          diffs[pointer + 1][1] = insertion.substring(overlap_length1);\n          pointer++;\n        }\n      } else {\n        if (\n          overlap_length2 >= deletion.length / 2 ||\n          overlap_length2 >= insertion.length / 2\n        ) {\n          // Reverse overlap found.\n          // Insert an equality and swap and trim the surrounding edits.\n          diffs.splice(pointer, 0, [\n            DIFF_EQUAL,\n            deletion.substring(0, overlap_length2),\n          ]);\n          diffs[pointer - 1][0] = DIFF_INSERT;\n          diffs[pointer - 1][1] = insertion.substring(\n            0,\n            insertion.length - overlap_length2\n          );\n          diffs[pointer + 1][0] = DIFF_DELETE;\n          diffs[pointer + 1][1] = deletion.substring(overlap_length2);\n          pointer++;\n        }\n      }\n      pointer++;\n    }\n    pointer++;\n  }\n}\n\nvar nonAlphaNumericRegex_ = /[^a-zA-Z0-9]/;\nvar whitespaceRegex_ = /\\s/;\nvar linebreakRegex_ = /[\\r\\n]/;\nvar blanklineEndRegex_ = /\\n\\r?\\n$/;\nvar blanklineStartRegex_ = /^\\r?\\n\\r?\\n/;\n\n/**\n * Look for single edits surrounded on both sides by equalities\n * which can be shifted sideways to align the edit to a word boundary.\n * e.g: The c<ins>at c</ins>ame. -> The <ins>cat </ins>came.\n * @param {!Array.<!diff_match_patch.Diff>} diffs Array of diff tuples.\n */\nfunction diff_cleanupSemanticLossless(diffs) {\n  /**\n   * Given two strings, compute a score representing whether the internal\n   * boundary falls on logical boundaries.\n   * Scores range from 6 (best) to 0 (worst).\n   * Closure, but does not reference any external variables.\n   * @param {string} one First string.\n   * @param {string} two Second string.\n   * @return {number} The score.\n   * @private\n   */\n  function diff_cleanupSemanticScore_(one, two) {\n    if (!one || !two) {\n      // Edges are the best.\n      return 6;\n    }\n\n    // Each port of this function behaves slightly differently due to\n    // subtle differences in each language's definition of things like\n    // 'whitespace'.  Since this function's purpose is largely cosmetic,\n    // the choice has been made to use each language's native features\n    // rather than force total conformity.\n    var char1 = one.charAt(one.length - 1);\n    var char2 = two.charAt(0);\n    var nonAlphaNumeric1 = char1.match(nonAlphaNumericRegex_);\n    var nonAlphaNumeric2 = char2.match(nonAlphaNumericRegex_);\n    var whitespace1 = nonAlphaNumeric1 && char1.match(whitespaceRegex_);\n    var whitespace2 = nonAlphaNumeric2 && char2.match(whitespaceRegex_);\n    var lineBreak1 = whitespace1 && char1.match(linebreakRegex_);\n    var lineBreak2 = whitespace2 && char2.match(linebreakRegex_);\n    var blankLine1 = lineBreak1 && one.match(blanklineEndRegex_);\n    var blankLine2 = lineBreak2 && two.match(blanklineStartRegex_);\n\n    if (blankLine1 || blankLine2) {\n      // Five points for blank lines.\n      return 5;\n    } else if (lineBreak1 || lineBreak2) {\n      // Four points for line breaks.\n      return 4;\n    } else if (nonAlphaNumeric1 && !whitespace1 && whitespace2) {\n      // Three points for end of sentences.\n      return 3;\n    } else if (whitespace1 || whitespace2) {\n      // Two points for whitespace.\n      return 2;\n    } else if (nonAlphaNumeric1 || nonAlphaNumeric2) {\n      // One point for non-alphanumeric.\n      return 1;\n    }\n    return 0;\n  }\n\n  var pointer = 1;\n  // Intentionally ignore the first and last element (don't need checking).\n  while (pointer < diffs.length - 1) {\n    if (\n      diffs[pointer - 1][0] == DIFF_EQUAL &&\n      diffs[pointer + 1][0] == DIFF_EQUAL\n    ) {\n      // This is a single edit surrounded by equalities.\n      var equality1 = diffs[pointer - 1][1];\n      var edit = diffs[pointer][1];\n      var equality2 = diffs[pointer + 1][1];\n\n      // First, shift the edit as far left as possible.\n      var commonOffset = diff_commonSuffix(equality1, edit);\n      if (commonOffset) {\n        var commonString = edit.substring(edit.length - commonOffset);\n        equality1 = equality1.substring(0, equality1.length - commonOffset);\n        edit = commonString + edit.substring(0, edit.length - commonOffset);\n        equality2 = commonString + equality2;\n      }\n\n      // Second, step character by character right, looking for the best fit.\n      var bestEquality1 = equality1;\n      var bestEdit = edit;\n      var bestEquality2 = equality2;\n      var bestScore =\n        diff_cleanupSemanticScore_(equality1, edit) +\n        diff_cleanupSemanticScore_(edit, equality2);\n      while (edit.charAt(0) === equality2.charAt(0)) {\n        equality1 += edit.charAt(0);\n        edit = edit.substring(1) + equality2.charAt(0);\n        equality2 = equality2.substring(1);\n        var score =\n          diff_cleanupSemanticScore_(equality1, edit) +\n          diff_cleanupSemanticScore_(edit, equality2);\n        // The >= encourages trailing rather than leading whitespace on edits.\n        if (score >= bestScore) {\n          bestScore = score;\n          bestEquality1 = equality1;\n          bestEdit = edit;\n          bestEquality2 = equality2;\n        }\n      }\n\n      if (diffs[pointer - 1][1] != bestEquality1) {\n        // We have an improvement, save it back to the diff.\n        if (bestEquality1) {\n          diffs[pointer - 1][1] = bestEquality1;\n        } else {\n          diffs.splice(pointer - 1, 1);\n          pointer--;\n        }\n        diffs[pointer][1] = bestEdit;\n        if (bestEquality2) {\n          diffs[pointer + 1][1] = bestEquality2;\n        } else {\n          diffs.splice(pointer + 1, 1);\n          pointer--;\n        }\n      }\n    }\n    pointer++;\n  }\n}\n\n/**\n * Reorder and merge like edit sections.  Merge equalities.\n * Any edit section can move as long as it doesn't cross an equality.\n * @param {Array} diffs Array of diff tuples.\n * @param {boolean} fix_unicode Whether to normalize to a unicode-correct diff\n */\nfunction diff_cleanupMerge(diffs, fix_unicode) {\n  diffs.push([DIFF_EQUAL, \"\"]); // Add a dummy entry at the end.\n  var pointer = 0;\n  var count_delete = 0;\n  var count_insert = 0;\n  var text_delete = \"\";\n  var text_insert = \"\";\n  var commonlength;\n  while (pointer < diffs.length) {\n    if (pointer < diffs.length - 1 && !diffs[pointer][1]) {\n      diffs.splice(pointer, 1);\n      continue;\n    }\n    switch (diffs[pointer][0]) {\n      case DIFF_INSERT:\n        count_insert++;\n        text_insert += diffs[pointer][1];\n        pointer++;\n        break;\n      case DIFF_DELETE:\n        count_delete++;\n        text_delete += diffs[pointer][1];\n        pointer++;\n        break;\n      case DIFF_EQUAL:\n        var previous_equality = pointer - count_insert - count_delete - 1;\n        if (fix_unicode) {\n          // prevent splitting of unicode surrogate pairs.  when fix_unicode is true,\n          // we assume that the old and new text in the diff are complete and correct\n          // unicode-encoded JS strings, but the tuple boundaries may fall between\n          // surrogate pairs.  we fix this by shaving off stray surrogates from the end\n          // of the previous equality and the beginning of this equality.  this may create\n          // empty equalities or a common prefix or suffix.  for example, if AB and AC are\n          // emojis, `[[0, 'A'], [-1, 'BA'], [0, 'C']]` would turn into deleting 'ABAC' and\n          // inserting 'AC', and then the common suffix 'AC' will be eliminated.  in this\n          // particular case, both equalities go away, we absorb any previous inequalities,\n          // and we keep scanning for the next equality before rewriting the tuples.\n          if (\n            previous_equality >= 0 &&\n            ends_with_pair_start(diffs[previous_equality][1])\n          ) {\n            var stray = diffs[previous_equality][1].slice(-1);\n            diffs[previous_equality][1] = diffs[previous_equality][1].slice(\n              0,\n              -1\n            );\n            text_delete = stray + text_delete;\n            text_insert = stray + text_insert;\n            if (!diffs[previous_equality][1]) {\n              // emptied out previous equality, so delete it and include previous delete/insert\n              diffs.splice(previous_equality, 1);\n              pointer--;\n              var k = previous_equality - 1;\n              if (diffs[k] && diffs[k][0] === DIFF_INSERT) {\n                count_insert++;\n                text_insert = diffs[k][1] + text_insert;\n                k--;\n              }\n              if (diffs[k] && diffs[k][0] === DIFF_DELETE) {\n                count_delete++;\n                text_delete = diffs[k][1] + text_delete;\n                k--;\n              }\n              previous_equality = k;\n            }\n          }\n          if (starts_with_pair_end(diffs[pointer][1])) {\n            var stray = diffs[pointer][1].charAt(0);\n            diffs[pointer][1] = diffs[pointer][1].slice(1);\n            text_delete += stray;\n            text_insert += stray;\n          }\n        }\n        if (pointer < diffs.length - 1 && !diffs[pointer][1]) {\n          // for empty equality not at end, wait for next equality\n          diffs.splice(pointer, 1);\n          break;\n        }\n        if (text_delete.length > 0 || text_insert.length > 0) {\n          // note that diff_commonPrefix and diff_commonSuffix are unicode-aware\n          if (text_delete.length > 0 && text_insert.length > 0) {\n            // Factor out any common prefixes.\n            commonlength = diff_commonPrefix(text_insert, text_delete);\n            if (commonlength !== 0) {\n              if (previous_equality >= 0) {\n                diffs[previous_equality][1] += text_insert.substring(\n                  0,\n                  commonlength\n                );\n              } else {\n                diffs.splice(0, 0, [\n                  DIFF_EQUAL,\n                  text_insert.substring(0, commonlength),\n                ]);\n                pointer++;\n              }\n              text_insert = text_insert.substring(commonlength);\n              text_delete = text_delete.substring(commonlength);\n            }\n            // Factor out any common suffixes.\n            commonlength = diff_commonSuffix(text_insert, text_delete);\n            if (commonlength !== 0) {\n              diffs[pointer][1] =\n                text_insert.substring(text_insert.length - commonlength) +\n                diffs[pointer][1];\n              text_insert = text_insert.substring(\n                0,\n                text_insert.length - commonlength\n              );\n              text_delete = text_delete.substring(\n                0,\n                text_delete.length - commonlength\n              );\n            }\n          }\n          // Delete the offending records and add the merged ones.\n          var n = count_insert + count_delete;\n          if (text_delete.length === 0 && text_insert.length === 0) {\n            diffs.splice(pointer - n, n);\n            pointer = pointer - n;\n          } else if (text_delete.length === 0) {\n            diffs.splice(pointer - n, n, [DIFF_INSERT, text_insert]);\n            pointer = pointer - n + 1;\n          } else if (text_insert.length === 0) {\n            diffs.splice(pointer - n, n, [DIFF_DELETE, text_delete]);\n            pointer = pointer - n + 1;\n          } else {\n            diffs.splice(\n              pointer - n,\n              n,\n              [DIFF_DELETE, text_delete],\n              [DIFF_INSERT, text_insert]\n            );\n            pointer = pointer - n + 2;\n          }\n        }\n        if (pointer !== 0 && diffs[pointer - 1][0] === DIFF_EQUAL) {\n          // Merge this equality with the previous one.\n          diffs[pointer - 1][1] += diffs[pointer][1];\n          diffs.splice(pointer, 1);\n        } else {\n          pointer++;\n        }\n        count_insert = 0;\n        count_delete = 0;\n        text_delete = \"\";\n        text_insert = \"\";\n        break;\n    }\n  }\n  if (diffs[diffs.length - 1][1] === \"\") {\n    diffs.pop(); // Remove the dummy entry at the end.\n  }\n\n  // Second pass: look for single edits surrounded on both sides by equalities\n  // which can be shifted sideways to eliminate an equality.\n  // e.g: A<ins>BA</ins>C -> <ins>AB</ins>AC\n  var changes = false;\n  pointer = 1;\n  // Intentionally ignore the first and last element (don't need checking).\n  while (pointer < diffs.length - 1) {\n    if (\n      diffs[pointer - 1][0] === DIFF_EQUAL &&\n      diffs[pointer + 1][0] === DIFF_EQUAL\n    ) {\n      // This is a single edit surrounded by equalities.\n      if (\n        diffs[pointer][1].substring(\n          diffs[pointer][1].length - diffs[pointer - 1][1].length\n        ) === diffs[pointer - 1][1]\n      ) {\n        // Shift the edit over the previous equality.\n        diffs[pointer][1] =\n          diffs[pointer - 1][1] +\n          diffs[pointer][1].substring(\n            0,\n            diffs[pointer][1].length - diffs[pointer - 1][1].length\n          );\n        diffs[pointer + 1][1] = diffs[pointer - 1][1] + diffs[pointer + 1][1];\n        diffs.splice(pointer - 1, 1);\n        changes = true;\n      } else if (\n        diffs[pointer][1].substring(0, diffs[pointer + 1][1].length) ==\n        diffs[pointer + 1][1]\n      ) {\n        // Shift the edit over the next equality.\n        diffs[pointer - 1][1] += diffs[pointer + 1][1];\n        diffs[pointer][1] =\n          diffs[pointer][1].substring(diffs[pointer + 1][1].length) +\n          diffs[pointer + 1][1];\n        diffs.splice(pointer + 1, 1);\n        changes = true;\n      }\n    }\n    pointer++;\n  }\n  // If shifts were made, the diff needs reordering and another shift sweep.\n  if (changes) {\n    diff_cleanupMerge(diffs, fix_unicode);\n  }\n}\n\nfunction is_surrogate_pair_start(charCode) {\n  return charCode >= 0xd800 && charCode <= 0xdbff;\n}\n\nfunction is_surrogate_pair_end(charCode) {\n  return charCode >= 0xdc00 && charCode <= 0xdfff;\n}\n\nfunction starts_with_pair_end(str) {\n  return is_surrogate_pair_end(str.charCodeAt(0));\n}\n\nfunction ends_with_pair_start(str) {\n  return is_surrogate_pair_start(str.charCodeAt(str.length - 1));\n}\n\nfunction remove_empty_tuples(tuples) {\n  var ret = [];\n  for (var i = 0; i < tuples.length; i++) {\n    if (tuples[i][1].length > 0) {\n      ret.push(tuples[i]);\n    }\n  }\n  return ret;\n}\n\nfunction make_edit_splice(before, oldMiddle, newMiddle, after) {\n  if (ends_with_pair_start(before) || starts_with_pair_end(after)) {\n    return null;\n  }\n  return remove_empty_tuples([\n    [DIFF_EQUAL, before],\n    [DIFF_DELETE, oldMiddle],\n    [DIFF_INSERT, newMiddle],\n    [DIFF_EQUAL, after],\n  ]);\n}\n\nfunction find_cursor_edit_diff(oldText, newText, cursor_pos) {\n  // note: this runs after equality check has ruled out exact equality\n  var oldRange =\n    typeof cursor_pos === \"number\"\n      ? { index: cursor_pos, length: 0 }\n      : cursor_pos.oldRange;\n  var newRange = typeof cursor_pos === \"number\" ? null : cursor_pos.newRange;\n  // take into account the old and new selection to generate the best diff\n  // possible for a text edit.  for example, a text change from \"xxx\" to \"xx\"\n  // could be a delete or forwards-delete of any one of the x's, or the\n  // result of selecting two of the x's and typing \"x\".\n  var oldLength = oldText.length;\n  var newLength = newText.length;\n  if (oldRange.length === 0 && (newRange === null || newRange.length === 0)) {\n    // see if we have an insert or delete before or after cursor\n    var oldCursor = oldRange.index;\n    var oldBefore = oldText.slice(0, oldCursor);\n    var oldAfter = oldText.slice(oldCursor);\n    var maybeNewCursor = newRange ? newRange.index : null;\n    editBefore: {\n      // is this an insert or delete right before oldCursor?\n      var newCursor = oldCursor + newLength - oldLength;\n      if (maybeNewCursor !== null && maybeNewCursor !== newCursor) {\n        break editBefore;\n      }\n      if (newCursor < 0 || newCursor > newLength) {\n        break editBefore;\n      }\n      var newBefore = newText.slice(0, newCursor);\n      var newAfter = newText.slice(newCursor);\n      if (newAfter !== oldAfter) {\n        break editBefore;\n      }\n      var prefixLength = Math.min(oldCursor, newCursor);\n      var oldPrefix = oldBefore.slice(0, prefixLength);\n      var newPrefix = newBefore.slice(0, prefixLength);\n      if (oldPrefix !== newPrefix) {\n        break editBefore;\n      }\n      var oldMiddle = oldBefore.slice(prefixLength);\n      var newMiddle = newBefore.slice(prefixLength);\n      return make_edit_splice(oldPrefix, oldMiddle, newMiddle, oldAfter);\n    }\n    editAfter: {\n      // is this an insert or delete right after oldCursor?\n      if (maybeNewCursor !== null && maybeNewCursor !== oldCursor) {\n        break editAfter;\n      }\n      var cursor = oldCursor;\n      var newBefore = newText.slice(0, cursor);\n      var newAfter = newText.slice(cursor);\n      if (newBefore !== oldBefore) {\n        break editAfter;\n      }\n      var suffixLength = Math.min(oldLength - cursor, newLength - cursor);\n      var oldSuffix = oldAfter.slice(oldAfter.length - suffixLength);\n      var newSuffix = newAfter.slice(newAfter.length - suffixLength);\n      if (oldSuffix !== newSuffix) {\n        break editAfter;\n      }\n      var oldMiddle = oldAfter.slice(0, oldAfter.length - suffixLength);\n      var newMiddle = newAfter.slice(0, newAfter.length - suffixLength);\n      return make_edit_splice(oldBefore, oldMiddle, newMiddle, oldSuffix);\n    }\n  }\n  if (oldRange.length > 0 && newRange && newRange.length === 0) {\n    replaceRange: {\n      // see if diff could be a splice of the old selection range\n      var oldPrefix = oldText.slice(0, oldRange.index);\n      var oldSuffix = oldText.slice(oldRange.index + oldRange.length);\n      var prefixLength = oldPrefix.length;\n      var suffixLength = oldSuffix.length;\n      if (newLength < prefixLength + suffixLength) {\n        break replaceRange;\n      }\n      var newPrefix = newText.slice(0, prefixLength);\n      var newSuffix = newText.slice(newLength - suffixLength);\n      if (oldPrefix !== newPrefix || oldSuffix !== newSuffix) {\n        break replaceRange;\n      }\n      var oldMiddle = oldText.slice(prefixLength, oldLength - suffixLength);\n      var newMiddle = newText.slice(prefixLength, newLength - suffixLength);\n      return make_edit_splice(oldPrefix, oldMiddle, newMiddle, oldSuffix);\n    }\n  }\n\n  return null;\n}\n\nfunction diff(text1, text2, cursor_pos, cleanup) {\n  // only pass fix_unicode=true at the top level, not when diff_main is\n  // recursively invoked\n  return diff_main(text1, text2, cursor_pos, cleanup, true);\n}\n\ndiff.INSERT = DIFF_INSERT;\ndiff.DELETE = DIFF_DELETE;\ndiff.EQUAL = DIFF_EQUAL;\n\nmodule.exports = diff;\n", "/*\n * Copyright 2018 Vivliostyle Foundation\n *\n * Vivliostyle.js is free software: you can redistribute it and/or modify\n * it under the terms of the GNU Affero General Public License as published by\n * the Free Software Foundation, either version 3 of the License, or\n * (at your option) any later version.\n *\n * Vivliostyle.js is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n * GNU Affero General Public License for more details.\n *\n * You should have received a copy of the GNU Affero General Public License\n * along with Vivliostyle.js.  If not, see <http://www.gnu.org/licenses/>.\n *\n */\n\nexport * from \"./vivliostyle/constants\";\nexport * from \"./vivliostyle/plugin\";\nexport * from \"./vivliostyle/profile\";\nexport * from \"./vivliostyle/core-viewer\";\nexport * from \"./vivliostyle/print\";\nexport * from \"./vivliostyle/assets\";\n", "/**\n * Copyright 2015 Daishinsha Inc.\n * Copyright 2019 Vivliostyle Foundation\n *\n * Vivliostyle.js is free software: you can redistribute it and/or modify\n * it under the terms of the GNU Affero General Public License as published by\n * the Free Software Foundation, either version 3 of the License, or\n * (at your option) any later version.\n *\n * Vivliostyle.js is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n * GNU Affero General Public License for more details.\n *\n * You should have received a copy of the GNU Affero General Public License\n * along with Vivliostyle.js.  If not, see <http://www.gnu.org/licenses/>.\n *\n * @fileoverview Constants\n */\n\n/**\n * Debug flag.\n */\nexport let isDebug: boolean = false;\nexport function setDebug(value: boolean): void {\n  isDebug = value;\n}\n\n/**\n * Page progression direction.\n * @enum {string}\n */\nexport enum PageProgression {\n  LTR = \"ltr\",\n  RTL = \"rtl\",\n}\n\n/**\n * Return PageProgression corresponding to the specified string\n */\nexport function pageProgressionOf(str: string): PageProgression {\n  switch (str) {\n    case \"ltr\":\n      return PageProgression.LTR;\n    case \"rtl\":\n      return PageProgression.RTL;\n    default:\n      throw new Error(`unknown PageProgression: ${str}`);\n  }\n}\n\n/**\n * Page side (left/right).\n * @enum {string}\n */\nexport enum PageSide {\n  LEFT = \"left\",\n  RIGHT = \"right\",\n}\n\n/**\n * Viewer ready state.\n * @enum {string}\n */\nexport enum ReadyState {\n  LOADING = \"loading\",\n  INTERACTIVE = \"interactive\",\n  COMPLETE = \"complete\",\n}\n", "/**\n * Copyright 2015 Daishinsha Inc.\n * Copyright 2019 Vivliostyle Foundation\n *\n * Vivliostyle.js is free software: you can redistribute it and/or modify\n * it under the terms of the GNU Affero General Public License as published by\n * the Free Software Foundation, either version 3 of the License, or\n * (at your option) any later version.\n *\n * Vivliostyle.js is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n * GNU Affero General Public License for more details.\n *\n * You should have received a copy of the GNU Affero General Public License\n * along with Vivliostyle.js.  If not, see <http://www.gnu.org/licenses/>.\n *\n * @fileoverview Logging - Logging utility\n */\n\n/**\n * Log level.\n * @enum {number}\n */\nexport enum LogLevel {\n  DEBUG = 1,\n  INFO,\n  WARN,\n  ERROR,\n}\n\nexport type ErrorInfo = {\n  error: Error;\n  messages: any[];\n};\n\n/**\n * Class logging error, warning, information or debug messages.\n */\nexport class Logger {\n  private listeners: { [key in LogLevel]?: (p1: ErrorInfo) => void } = {};\n\n  constructor(private opt_console?: Console) {}\n\n  private consoleDebug(msg: any[]) {\n    if (this.opt_console) {\n      if (this.opt_console.debug) {\n        this.opt_console.debug(...msg);\n      } else {\n        this.opt_console.log(...msg);\n      }\n    } else {\n      console.debug(...msg); // eslint-disable-line no-console\n    }\n  }\n\n  private consoleInfo(msg: any[]) {\n    if (this.opt_console) {\n      if (this.opt_console.info) {\n        this.opt_console.info(...msg);\n      } else {\n        this.opt_console.log(...msg);\n      }\n    } else {\n      console.info(...msg); // eslint-disable-line no-console\n    }\n  }\n\n  private consoleWarn(msg: any[]) {\n    if (this.opt_console) {\n      if (this.opt_console.warn) {\n        this.opt_console.warn(...msg);\n      } else {\n        this.opt_console.log(...msg);\n      }\n    } else {\n      console.warn(...msg); // eslint-disable-line no-console\n    }\n  }\n\n  private consoleError(msg: any[]) {\n    if (this.opt_console) {\n      if (this.opt_console.error) {\n        this.opt_console.error(...msg);\n      } else {\n        this.opt_console.log(...msg);\n      }\n    } else {\n      console.error(...msg); // eslint-disable-line no-console\n    }\n  }\n\n  private triggerListeners(level: LogLevel, args: ErrorInfo) {\n    const listener = this.listeners[level];\n    if (listener) {\n      listener(args);\n    }\n  }\n\n  /**\n   * Add a listener function invoked when a log event with the specified level\n   * occurs.\n   */\n  addListener(level: LogLevel, listener: (p1: ErrorInfo) => void) {\n    this.listeners[level] = listener;\n  }\n\n  debug(...var_args: any[]) {\n    const args = argumentsToErrorInfo(arguments);\n    this.consoleDebug(buildMessageAndStackTrace(args));\n    this.triggerListeners(LogLevel.DEBUG, args);\n  }\n\n  info(...var_args: any[]) {\n    const args = argumentsToErrorInfo(arguments);\n    this.consoleInfo(buildMessageAndStackTrace(args));\n    this.triggerListeners(LogLevel.INFO, args);\n  }\n\n  warn(...var_args: any[]) {\n    const args = argumentsToErrorInfo(arguments);\n    this.consoleWarn(buildMessageAndStackTrace(args));\n    this.triggerListeners(LogLevel.WARN, args);\n  }\n\n  error(...var_args: any[]) {\n    const args = argumentsToErrorInfo(arguments);\n    this.consoleError(buildMessageAndStackTrace(args));\n    this.triggerListeners(LogLevel.ERROR, args);\n  }\n}\n\n/**\n * @param args\n */\nfunction argumentsToErrorInfo(args: IArguments): ErrorInfo {\n  const a = Array.from(args);\n  let e: Error = null;\n  if (a[0] instanceof Error) {\n    e = a.shift();\n  }\n  return { error: e, messages: a };\n}\n\nfunction buildMessageAndStackTrace(args: ErrorInfo): string[] {\n  const e = args.error;\n  const stack = e && (e[\"frameTrace\"] || e[\"stack\"]);\n  let messages = [].concat(args[\"messages\"]);\n  if (e) {\n    if (messages.length > 0) {\n      messages = messages.concat([\"\\n\"]);\n    }\n    messages = messages.concat([e[\"toString\"]()]);\n    if (stack) {\n      messages = messages.concat([\"\\n\"]).concat(stack);\n    }\n  }\n  return messages;\n}\n\nexport const logger = new Logger();\n", "/**\n * Copyright 2016 Daishinsha Inc.\n * Copyright 2019 Vivliostyle Foundation\n *\n * Vivliostyle.js is free software: you can redistribute it and/or modify\n * it under the terms of the GNU Affero General Public License as published by\n * the Free Software Foundation, either version 3 of the License, or\n * (at your option) any later version.\n *\n * Vivliostyle.js is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n * GNU Affero General Public License for more details.\n *\n * You should have received a copy of the GNU Affero General Public License\n * along with Vivliostyle.js.  If not, see <http://www.gnu.org/licenses/>.\n *\n * @fileoverview Plugin - Plugin mechanism\n */\nimport * as Base from \"./base\";\nimport * as Css from \"./css\";\nimport * as LayoutProcessor from \"./layout-processor\";\nimport * as Logging from \"./logging\";\nimport * as Task from \"./task\";\nimport { Layout, Vtree } from \"./types\";\n\n/**\n * Type of implemented hooks.\n * @enum {string}\n */\nexport enum HOOKS {\n  /**\n   * Called when a single property declaration is parsed.\n   *\n   * The hook is called with an object with the following properties:\n   *   {string} name: Property name\n   *   {!Css.Val} value: Property value\n   *   {boolean} important: Whether '!important' flag is present or not\n   * Functions called by this hook are expected to return a value with the same\n   * type as the above. The declaration is then replaced by the returned value.\n   *\n   * Note that a shorthand declaration is not directly passed to this hook.\n   * After the shorthand declaration is interpreted and broken into\n   * non-shorthand declarations, the hook is called for each of the\n   * non-shorthand declarations.\n   */\n  SIMPLE_PROPERTY = \"SIMPLE_PROPERTY\",\n\n  /**\n   * Called when a single document (i.e. a single spine item) has been fetched,\n   * before parsing.\n   *\n   * The hook is called with the Document object.\n   */\n  PREPROCESS_SINGLE_DOCUMENT = \"PREPROCESS_SINGLE_DOCUMENT\",\n\n  /**\n   * Called before creating a text node for modifying a text content.\n   *\n   * The hook is called with an object with the following properties:\n   *   {Vtree.NodeContext} nodeContext\n   *   {string} sourceTextContent\n   *\n   * Functions called by this hook are expected to return a\n   * Task.Result.<string>. The text content is then replaced by the\n   * returned value.\n   */\n  PREPROCESS_TEXT_CONTENT = \"PREPROCESS_TEXT_CONTENT\",\n\n  /**\n   * Called before creating a element for modifying a element style.\n   *\n   * The hook is called with an object with the following properties:\n   *   {Vtree.NodeContext} nodeContext\n   *   {!Object} style\n   */\n  PREPROCESS_ELEMENT_STYLE = \"PREPROCESS_ELEMENT_STYLE\",\n\n  /**\n   * Called before geting CssCascade.polyfilledInheritedProps.\n   *\n   * The hook return a array of polyfilled inherited property name.\n   */\n  POLYFILLED_INHERITED_PROPS = \"POLYFILLED_INHERITED_PROPS\",\n\n  /**\n   * Called when a Viewer is configured.\n   *\n   * The hook is called with an object with the following properties:\n   *  {Base.JSON} command\n   */\n  CONFIGURATION = \"CONFIGURATION\",\n\n  /**\n   * Called when resolving a text node breaker\n   * which detects an acceptable breakpoint and break text node at this point.\n   *\n   * The hook is called with an object with the following properties:\n   *  {Vtree.NodeContext} nodeContext\n   *\n   * Functions called by this hook are expected to\n   * return an instnce of {Layout.TextNodeBreaker} or null.\n   */\n  RESOLVE_TEXT_NODE_BREAKER = \"RESOLVE_TEXT_NODE_BREAKER\",\n\n  /**\n   * Called when resolving a formatting context.\n   *\n   * The hook is called with the following parameters:\n   *   nodeContext: a NodeContext object\n   *   firstTime: a boolean flag representing whether this node is encountered\n   * for the first time or not display: an Css.Ident value representing\n   * 'display' value of the node position: an Css.Ident value representing\n   * 'position' value of the node float: an Css.Ident value representing\n   * 'float' value of the node isRoot: a boolean flag representing whether this\n   * node is a root (of a flow) or not Functions called by this hook are\n   * expected to return a formatting context for the NodeContext.\n   */\n  RESOLVE_FORMATTING_CONTEXT = \"RESOLVE_FORMATTING_CONTEXT\",\n\n  /**\n   * Called when resolving a layout processor (LayoutProcessor) for\n   * a formatting context.\n   *\n   * The hook is called with a formatting context\n   * (Vtree.FormattingContext). Functions called by this hook are expected\n   * to return a layout processor corresponding to the formatting context.\n   */\n  RESOLVE_LAYOUT_PROCESSOR = \"RESOLVE_LAYOUT_PROCESSOR\",\n\n  /**\n   * Called after laid out a block contents.\n   *\n   * The hook is called with an object with the following properties:\n   *  {Vtree.NodeContext} nodeContext\n   *  {Array.<Vtree.NodeContext>} checkPoints\n   *  {Layout.Column} column\n   */\n  POST_LAYOUT_BLOCK = \"POST_LAYOUT_BLOCK\",\n}\n\nexport type PreProcessSingleDocumentHook = (p1: Document) => any;\n\nexport type PreProcessTextContentHook = (\n  p1: Vtree.NodeContext,\n  p2: string,\n) => Task.Result<string>;\n\nexport type PreProcessElementStyleHook = (\n  p1: Vtree.NodeContext,\n  p2: object,\n) => void;\n\nexport type PolyfilledInheritedPropsHook = () => string[];\n\nexport type ConfigurationHook = (p1: Base.JSON) => {\n  needResize: boolean | null | undefined;\n  needRefresh: boolean | null | undefined;\n};\n\nexport type ResolveTextNodeBreakerHook = (\n  p1: Vtree.NodeContext,\n) => Layout.TextNodeBreaker;\n\nexport type ResolveFormattingContextHook = (\n  p1: Vtree.NodeContext,\n  p2: boolean,\n  p3: Css.Val,\n  p4: Css.Ident,\n  p5: Css.Val,\n  p6: boolean,\n) => Vtree.FormattingContext;\n\nexport type ResolveLayoutProcessorHook = (\n  p1: Vtree.FormattingContext,\n) => LayoutProcessor.LayoutProcessor;\n\nexport type PostLayoutBlockHook = (\n  p1: Vtree.NodeContext,\n  p2: Vtree.NodeContext[],\n  p3: Layout.Column,\n) => void;\n\nconst hooks = {};\n\n/**\n * Register a function to a hook with the specified name.\n * The registered function is called at appropriate timings by the core code.\n * Arguments passed to the function depend on the hook.\n * When multiple functions are registered, they are called by the order in which\n * they are registered.\n * @param name Name of the hook.\n * @param fn Function to be registered to the hook.\n * @param atFirst If true, the function is registered at the first of the hook array.\n */\nexport function registerHook(\n  name: string,\n  fn: (...p1) => any,\n  atFirst?: boolean,\n): void {\n  if (!HOOKS[name]) {\n    Logging.logger.warn(new Error(`Skipping unknown plugin hook '${name}'.`));\n  } else {\n    let hooksForName = hooks[name];\n    if (!hooksForName) {\n      hooksForName = hooks[name] = [];\n    }\n    if (atFirst) {\n      hooksForName.unshift(fn);\n    } else {\n      hooksForName.push(fn);\n    }\n  }\n}\n\n/**\n * Remove a function already registered to the specified name.\n * Note that even if the same function are registered multiple times, this\n * method removes only the first one.\n * @param name Name of the hook.\n * @param fn Function to be removed from the hook.\n */\nexport function removeHook(name: string, fn: (...p1) => any): void {\n  if (!HOOKS[name]) {\n    Logging.logger.warn(new Error(`Ignoring unknown plugin hook '${name}'.`));\n  } else {\n    const hooksForName = hooks[name];\n    if (hooksForName) {\n      const index = hooksForName.indexOf(fn);\n      if (index >= 0) {\n        hooksForName.splice(index, 1);\n      }\n    }\n  }\n}\n\n/**\n * Get all hooks registered to the specified name.\n * This method is for internal use (from the core code).\n */\nexport function getHooksForName(name: string): ((...p1) => any)[] {\n  const hooksForName = hooks[name];\n  return hooksForName || [];\n}\n\n/**\n * Pubilc members of the bundled library.\n */\nexport const plugin = {\n  registerHook,\n  removeHook,\n};\n", "/**\n * Copyright 2015 Daishinsha Inc.\n * Copyright 2019 Vivliostyle Foundation\n *\n * Vivliostyle.js is free software: you can redistribute it and/or modify\n * it under the terms of the GNU Affero General Public License as published by\n * the Free Software Foundation, either version 3 of the License, or\n * (at your option) any later version.\n *\n * Vivliostyle.js is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n * GNU Affero General Public License for more details.\n *\n * You should have received a copy of the GNU Affero General Public License\n * along with Vivliostyle.js.  If not, see <http://www.gnu.org/licenses/>.\n *\n * @fileoverview Profile - Utility for profiling\n */\nimport * as Logging from \"./logging\";\n\n/**\n * Performance profiler measuring execution time of the script.\n */\nexport class Profiler {\n  timestamps: { [key: string]: { [key: string]: number } } = {};\n  private registerTiming: (p1: string, p2: string, p3?: number) => any;\n  registerStartTiming: (name: string, timestamp?: number) => any;\n  registerEndTiming: (name: string, timestamp?: number) => any;\n\n  constructor(public readonly performanceInstance: Performance) {\n    this.registerTiming = noop;\n\n    // hack to export (non-prototype) methods\n    this[\"registerStartTiming\"] = this.registerStartTiming = noop;\n    this[\"registerEndTiming\"] = this.registerEndTiming = noop;\n  }\n\n  /**\n   * Registers start timing of some event, even if profile is disabled.\n   * @param name Name of event\n   * @param timestamp Used as the actual timestamp of the event if specified,\n   *     instead of \"now\"\n   */\n  forceRegisterStartTiming(name: string, timestamp?: number) {\n    registerTiming.call(this, name, \"start\", timestamp);\n  }\n\n  /**\n   * Registers end timing of some event, even if profile is disabled.\n   * @param name Name of event\n   * @param timestamp Used as the actual timestamp of the event if specified,\n   *     instead of \"now\"\n   */\n  forceRegisterEndTiming(name: string, timestamp?: number) {\n    registerTiming.call(this, name, \"end\", timestamp);\n  }\n\n  /**\n   * Log registered timings (start/end/duration).\n   * All values are printed in ms unit.\n   */\n  printTimings() {\n    const timestamps = this.timestamps;\n    let st = \"\";\n    Object.keys(timestamps).forEach((name) => {\n      const stamps = timestamps[name];\n      const l = stamps.length;\n      for (let i = 0; i < l; i++) {\n        const t = stamps[i];\n        st += name;\n        if (l > 1) {\n          st += `(${i})`;\n        }\n        st += ` => start: ${t[\"start\"]}, end: ${t[\"end\"]}, duration: ${\n          t[\"end\"] - t[\"start\"]\n        }\\n`;\n      }\n    });\n    Logging.logger.info(st);\n  }\n\n  /**\n   * Disable profiling.\n   */\n  disable() {\n    this.registerTiming = noop;\n\n    // hack to export (non-prototype) methods\n    this[\"registerStartTiming\"] = this.registerStartTiming = noop;\n    this[\"registerEndTiming\"] = this.registerEndTiming = noop;\n  }\n\n  /**\n   * Enable profiling.\n   */\n  enable() {\n    this.registerTiming = registerTiming;\n\n    // hack to export (non-prototype) methods\n    this[\"registerStartTiming\"] = this.registerStartTiming =\n      registerStartTiming;\n    this[\"registerEndTiming\"] = this.registerEndTiming = registerEndTiming;\n  }\n\n  /**\n   * Returns if profiling is enabled or not.\n   */\n  isEnabled(): boolean {\n    return this.registerStartTiming === registerStartTiming;\n  }\n}\n\nfunction noop(): void {}\n\n/**\n * Registers start/end timing of some event.\n * @this {Profile.Profiler}\n * @param name Name of event\n * @param startEnd Either of \"start\" or \"end\"\n * @param timestamp Used as the actual timestamp of the event if specified,\n *     instead of \"now\"\n */\nfunction registerTiming(\n  name: string,\n  startEnd: string,\n  timestamp?: number,\n): void {\n  if (!timestamp) {\n    timestamp = this.performanceInstance.now();\n  }\n  let timestamps = this.timestamps[name];\n  if (!timestamps) {\n    timestamps = this.timestamps[name] = [];\n  }\n  let t;\n  const l = timestamps.length;\n  for (let i = l - 1; i >= 0; i--) {\n    t = timestamps[i];\n    if (t && !t[startEnd]) {\n      break;\n    }\n    t = null;\n  }\n  if (!t) {\n    t = {};\n    timestamps.push(t);\n  }\n  t[startEnd] = timestamp;\n}\n\n/**\n * Registers start timing of some event.\n * @this {Profile.Profiler}\n * @param name Name of event\n * @param timestamp Used as the actual timestamp of the event if specified,\n *     instead of \"now\"\n */\nfunction registerStartTiming(name: string, timestamp?: number): void {\n  this.registerTiming(name, \"start\", timestamp);\n}\n\n/**\n * Registers end timing of some event.\n * @this {Profile.Profiler}\n * @param name Name of event\n * @param timestamp Used as the actual timestamp of the event if specified,\n *     instead of \"now\"\n */\nfunction registerEndTiming(name: string, timestamp?: number): void {\n  this.registerTiming(name, \"end\", timestamp);\n}\nconst fallbackPerformanceInstance = { now: Date.now } as Performance;\nconst performanceInstance = window && window.performance;\nexport const profiler = new Profiler(\n  performanceInstance || fallbackPerformanceInstance,\n);\nprofiler.forceRegisterStartTiming(\"load_vivliostyle\");\n\n/**\n * Pubilc members of the bundled library.\n */\nexport const profile = {\n  profiler: {\n    registerStartTiming: profiler.registerStartTiming,\n    registerEndTiming: profiler.registerEndTiming,\n    printTimings: profiler.printTimings,\n    disable: profiler.disable,\n    enable: profiler.enable,\n  },\n};\n", "/**\n * Copyright 2013 Google, Inc.\n * Copyright 2015 Daishinsha Inc.\n * Copyright 2019 Vivliostyle Foundation\n *\n * Vivliostyle.js is free software: you can redistribute it and/or modify\n * it under the terms of the GNU Affero General Public License as published by\n * the Free Software Foundation, either version 3 of the License, or\n * (at your option) any later version.\n *\n * Vivliostyle.js is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n * GNU Affero General Public License for more details.\n *\n * You should have received a copy of the GNU Affero General Public License\n * along with Vivliostyle.js.  If not, see <http://www.gnu.org/licenses/>.\n *\n * @fileoverview Base - Common utilities.\n */\nimport * as Logging from \"./logging\";\nimport * as Asserts from \"./asserts\";\n\n/**\n * Browser type detection\n */\nexport const browserType: \"chromium\" | \"firefox\" | \"webkit\" | \"unknown\" =\n  navigator.userAgent.includes(\"Chrome\")\n    ? \"chromium\"\n    : navigator.userAgent.includes(\"Firefox\")\n      ? \"firefox\"\n      : navigator.userAgent.includes(\"AppleWebKit\")\n        ? \"webkit\"\n        : \"unknown\";\n\n/**\n * RegExp pattern for ::first-letter pseudo element:\n * https://drafts.csswg.org/css-pseudo-4/#first-letter-pseudo\n */\nexport const firstLetterPattern =\n  /^[\\s\\p{Zs}\\p{P}\\p{Mn}]*[\\p{L}\\p{N}]\\p{Mn}*(?:[\\s\\p{Zs}]*\\p{P}\\p{Mn}*)*/u;\n/**\n * Indicates the offset position of an element in a document\n */\nexport const ELEMENT_OFFSET_ATTR = \"data-adapt-eloff\";\n\nexport let emptyObj = {};\n\nexport type JSON = any;\n\nexport function jsonToString(json: JSON): string {\n  return JSON.stringify(json);\n}\n\nexport function stringToJSON(str: string): JSON {\n  return JSON.parse(str);\n}\n\nexport function stripFragment(url: string): string {\n  const r = url.match(/^([^#]*)/);\n  if (r) {\n    return r[1];\n  }\n  return url;\n}\n\nexport function stripFragmentAndQuery(url: string): string {\n  const r = url.match(/^([^#?]*)/);\n  if (r) {\n    return r[1];\n  }\n  return url;\n}\n\n/**\n * Base URL relative to which URLs of resources are resolved.\n */\nexport let baseURL = window.location.href;\nexport function setBaseURL(value: string): void {\n  baseURL = value;\n}\n\n/**\n * Base URL relative to which URLs of resources such as validation.txt and\n * user-agent.css are resolved.\n */\nexport let resourceBaseURL = window.location.href;\nexport function setResourceBaseURL(value: string): void {\n  resourceBaseURL = value;\n}\n\n/**\n * @param relURL relative URL\n * @param baseURL base (absolute) URL\n * @return resolved (absolute) URL\n */\nexport function resolveURL(relURL: string, baseURL: string): string {\n  if (/^data:/i.test(baseURL)) {\n    return relURL || baseURL;\n  }\n  if (!baseURL || relURL.match(/^\\w{2,}:/)) {\n    if (relURL.toLowerCase().match(\"^javascript:\")) {\n      return \"#\";\n    }\n    if (relURL.match(/^\\w{2,}:\\/\\/[^\\/]+$/)) {\n      relURL = `${relURL}/`;\n    }\n    return relURL;\n  }\n  if (baseURL.match(/^\\w{2,}:\\/\\/[^\\/]+$/)) {\n    baseURL = `${baseURL}/`;\n  }\n  let r: string[];\n  if (relURL.match(/^\\/\\//)) {\n    r = baseURL.match(/^(\\w{2,}:)\\/\\//);\n    if (r) {\n      return r[1] + relURL;\n    }\n    return relURL;\n  }\n  if (relURL.match(/^\\//)) {\n    r = baseURL.match(/^(\\w{2,}:\\/\\/[^\\/]+)\\//);\n    if (r) {\n      return r[1] + relURL;\n    }\n    return relURL;\n  }\n  if (relURL.match(/^\\.(\\/|$)/)) {\n    relURL = relURL.substr(2); // './foo' => 'foo'\n  }\n  baseURL = stripFragmentAndQuery(baseURL);\n  if (relURL.match(/^#/)) {\n    return baseURL + relURL;\n  }\n  let i = baseURL.lastIndexOf(\"/\");\n  if (i < 0) {\n    return relURL;\n  }\n  let url = baseURL.substr(0, i + 1) + relURL;\n  let urlOption = \"\";\n  r = url.match(/^([^?#]*)([?#].*)$/);\n  if (r) {\n    url = r[1];\n    urlOption = r[2];\n  }\n\n  while (true) {\n    i = url.indexOf(\"/../\");\n    if (i <= 0) {\n      break;\n    }\n    const j = url.lastIndexOf(\"/\", i - 1);\n    if (j <= 0) {\n      break;\n    }\n    url = url.substr(0, j) + url.substr(i + 3);\n  }\n  return url.replace(/\\/(\\.\\/)+/g, \"/\") + urlOption;\n}\n\n/**\n * Convert special URLs (e.g. GitHub, Gist) to their raw equivalents.\n * This is useful for fetching content from these services in a format\n * that can be easily processed by Vivliostyle.js.\n *\n * @param url URL to convert\n * @return converted URL\n */\nexport function convertSpecialURL(url: string): string {\n  let r: RegExpMatchArray;\n  if (\n    (r =\n      /^(https?:)\\/\\/github\\.com\\/([^/]+\\/[^/]+)\\/(blob\\/|tree\\/|raw\\/)?(.*)$/.exec(\n        url,\n      ))\n  ) {\n    // Convert GitHub URL to GitHub raw URL\n    url = `${r[1]}//raw.githubusercontent.com/${r[2]}/${r[3] ? \"\" : \"master/\"}${\n      r[4]\n    }`;\n  } else if (\n    (r =\n      /^(https?:)\\/\\/www\\.aozora\\.gr\\.jp\\/(cards\\/[^/]+\\/files\\/[^/.]+\\.html)$/.exec(\n        url,\n      ))\n  ) {\n    // Convert Aozorabunko (X)HTML URL to GitHub raw URL\n    url = `${r[1]}//raw.githubusercontent.com/aozorabunko/aozorabunko/master/${r[2]}`;\n  } else if (\n    (r =\n      /^(https?:)\\/\\/gist\\.github\\.com\\/([^/]+\\/\\w+)(\\/|$)(raw(\\/|$))?(.*)$/.exec(\n        url,\n      ))\n  ) {\n    // Convert Gist URL to Gist raw URL\n    url = `${r[1]}//gist.githubusercontent.com/${r[2]}/raw/${r[6]}`;\n  } else if (\n    (r =\n      /^(https?:)\\/\\/gist\\.github\\.com\\/([^/]+\\/\\w+)(?:#|%23)file-(.*)-(\\w+)$/.exec(\n        url,\n      ))\n  ) {\n    // Convert Gist URL with fragment to Gist raw URL\n    url = `${r[1]}//gist.githubusercontent.com/${r[2]}/raw/${r[3]}.${r[4]}`;\n  } else if (\n    (r =\n      /^(https?:)\\/\\/(?:[^/.]+\\.)?jsbin\\.com\\/(?!(?:blog|help)\\b)(\\w+)((\\/\\d+)?).*$/.exec(\n        url,\n      ))\n  ) {\n    // Convert JS Bin URL to JS Bin output URL\n    url = `${r[1]}//output.jsbin.com/${r[2]}${r[3]}/`;\n  }\n  return url;\n}\n\nexport interface DocumentURLTransformer {\n  transformFragment(fragment: string, baseURL: string): string;\n\n  transformURL(url: string, baseURL: string): string;\n\n  restoreURL(encoded: string): string[];\n}\n\n/**\n * Various namespaces.\n * @enum {string}\n */\nexport enum NS {\n  epub = \"http://www.idpf.org/2007/ops\",\n  EV = \"http://www.w3.org/2001/xml-events\",\n  MATHML = \"http://www.w3.org/1998/Math/MathML\",\n  XML = \"http://www.w3.org/XML/1998/namespace\",\n  XHTML = \"http://www.w3.org/1999/xhtml\",\n  XLINK = \"http://www.w3.org/1999/xlink\",\n  SHADOW = \"http://www.pyroxy.com/ns/shadow\",\n  SVG = \"http://www.w3.org/2000/svg\",\n  DC = \"http://purl.org/dc/elements/1.1/\",\n}\n\n/**\n * @param name parameter name\n * @param opt_url URL; window.location.href is used if not provided\n * @return parameter value\n */\nexport function getURLParam(name: string, opt_url?: string): string | null {\n  const rg = new RegExp(`#(.*&)?${escapeRegExp(name)}=([^#&]*)`);\n  const url = opt_url || window.location.href;\n  const r = url.match(rg);\n  if (r) {\n    return r[2];\n  }\n  return null;\n}\n\n/**\n * @param name parameter name\n * @param value parameter value\n * @return new url\n */\nexport function setURLParam(url: string, name: string, value: string): string {\n  const rg = new RegExp(`#(.*&)?${escapeRegExp(name)}=([^#&]*)`);\n  const r = url.match(rg);\n  if (r) {\n    const length = r[2].length;\n    const index = r.index + r[0].length - length;\n    return url.substr(0, index) + value + url.substr(index + length);\n  }\n  if (!url.match(/#/)) {\n    return `${url}#${name}=${value}`;\n  } else {\n    return `${url}&${name}=${value}`;\n  }\n}\n\nexport function asString(v: any): string | null {\n  if (v == null) {\n    return v;\n  }\n  return v.toString();\n}\n\nexport interface Comparable {\n  /**\n   * @return -1 when this less then other, 0 when this equals other\n   */\n  compare(other: Comparable): number;\n}\n\n/**\n * A priority queue.\n */\nexport class PriorityQueue {\n  queue: Comparable[] = [null];\n\n  length(): number {\n    return this.queue.length - 1;\n  }\n\n  add(item: Comparable): void {\n    let index = this.queue.length;\n    while (index > 1) {\n      const parentIndex = Math.floor(index / 2);\n      const parent = this.queue[parentIndex];\n      if (parent.compare(item) > 0) {\n        this.queue[index] = item;\n        return;\n      }\n      this.queue[index] = parent;\n      index = parentIndex;\n    }\n    this.queue[1] = item;\n  }\n\n  /**\n   * @return highest priority Comparable.\n   */\n  peek(): Comparable {\n    return this.queue[1];\n  }\n\n  /**\n   * Remove the highest-priority item from the queue.\n   * @return removed item.\n   */\n  remove(): Comparable {\n    const result = this.queue[1] as Comparable;\n    const curr = this.queue.pop() as Comparable;\n    const size = this.queue.length;\n    if (size > 1) {\n      let index = 1;\n      while (true) {\n        let childIndex = index * 2;\n        if (childIndex >= size) {\n          break;\n        }\n        if (this.queue[childIndex].compare(curr) > 0) {\n          if (\n            childIndex + 1 < size &&\n            this.queue[childIndex + 1].compare(\n              this.queue[childIndex] as Comparable,\n            ) > 0\n          ) {\n            childIndex++;\n          }\n        } else if (\n          childIndex + 1 < size &&\n          this.queue[childIndex + 1].compare(curr) > 0\n        ) {\n          childIndex++;\n        } else {\n          break;\n        }\n        this.queue[index] = this.queue[childIndex];\n        index = childIndex;\n      }\n      this.queue[index] = curr;\n    }\n    return result;\n  }\n}\n\nexport const knownPrefixes = [\"\", \"-webkit-\", \"-moz-\"];\n\nexport const propNameMap: { [key: string]: string[] } = {};\n\nexport function checkIfPropertySupported(\n  prefix: string,\n  prop: string,\n): boolean {\n  return CSS.supports(prefix + prop, \"unset\");\n}\n\nexport function getPrefixedPropertyNames(prop: string): string[] | null {\n  let prefixed = propNameMap[prop];\n  if (prefixed || prefixed === null) {\n    // null means the browser does not support the property\n    return prefixed;\n  }\n  switch (prop) {\n    case \"behavior\":\n    case \"template\":\n    case \"ua-list-item-count\":\n    case \"x-first-pseudo\":\n      propNameMap[prop] = null;\n      return null;\n    case \"text-combine-upright\":\n      // Special case for Safari\n      if (\n        checkIfPropertySupported(\"-webkit-\", \"text-combine\") &&\n        !checkIfPropertySupported(\"\", \"text-combine-upright\")\n      ) {\n        propNameMap[prop] = [\"-webkit-text-combine\"];\n        return [\"-webkit-text-combine\"];\n      }\n      break;\n  }\n  for (const prefix of knownPrefixes) {\n    if (checkIfPropertySupported(prefix, prop)) {\n      prefixed = [prefix + prop];\n      propNameMap[prop] = prefixed;\n      return prefixed;\n    }\n  }\n\n  // Not supported by the browser\n  Logging.logger.warn(\"Property not supported by the browser: \", prop);\n  propNameMap[prop] = null;\n  return null;\n}\n\nexport function setCSSProperty(\n  elem: Element,\n  prop: string,\n  value: string,\n): void {\n  const elemStyle = (elem as HTMLElement)?.style;\n  if (!elemStyle) {\n    return;\n  }\n  if (prop.startsWith(\"--\")) {\n    elemStyle.setProperty(prop, value || \" \");\n    return;\n  }\n  const prefixedPropertyNames = getPrefixedPropertyNames(prop);\n  if (!prefixedPropertyNames) {\n    return;\n  }\n  for (const prefixed of prefixedPropertyNames) {\n    switch (prefixed) {\n      case \"-webkit-text-combine\": // for Safari\n        switch (value) {\n          case \"all\":\n            value = \"horizontal\";\n            break;\n        }\n        break;\n      case \"text-combine-upright\":\n        switch (value) {\n          case \"all\":\n            // workaround for Chrome 93 bug https://crbug.com/1242755\n            elemStyle.setProperty(\"text-indent\", \"0\");\n            break;\n        }\n        break;\n    }\n    elemStyle.setProperty(prefixed, value);\n  }\n}\n\nexport function getCSSProperty(\n  elem: Element,\n  prop: string,\n  opt_value?: string,\n): string {\n  try {\n    const propertyNames = propNameMap[prop];\n    return (elem as HTMLElement).style.getPropertyValue(\n      propertyNames ? propertyNames[0] : prop,\n    );\n  } catch (err) {}\n  return opt_value || \"\";\n}\n\nexport function getLangAttribute(element: Element): string {\n  let lang = element.getAttributeNS(NS.XML, \"lang\");\n  if (!lang && element.namespaceURI == NS.XHTML) {\n    lang = element.getAttribute(\"lang\");\n  }\n  return lang;\n}\n\nexport class StringBuffer {\n  list: string[] = [];\n\n  append(str: string): StringBuffer {\n    this.list.push(str);\n    return this;\n  }\n\n  clear(): void {\n    this.list = [];\n  }\n\n  /** @override */\n  toString(): string {\n    const str = this.list.join(\"\");\n    this.list = [str];\n    return str;\n  }\n}\n\nexport function escapeChar(str: string): string {\n  // not called for surrogate pairs, no need to worry about them\n  return `\\\\${str.charCodeAt(0).toString(16)} `;\n}\n\nexport function escapeCSSIdent(name: string): string {\n  return name.replace(/[^-_a-zA-Z0-9\\u0080-\\uFFFF]/g, escapeChar);\n}\n\nexport function escapeCSSStr(str: string): string {\n  return str.replace(/[\\u0000-\\u001F\"\\\\]/g, escapeChar);\n}\n\nexport function lightURLEncode(str: string): string {\n  return str.replace(/[\\s+&?=#\\u007F-\\uFFFF]+/g, encodeURIComponent);\n}\n\nexport function isLetter(ch: string): boolean {\n  return !!ch.match(\n    /^[a-zA-Z\\u009E\\u009F\\u00C0-\\u00D6\\u00D8-\\u00F6\\u00F8-\\u024F\\u037B-\\u037D\\u0386\\u0388-\\u0482\\u048A-\\u0527]$/,\n  );\n}\n\nexport function escapeCharToHex(str: string, prefix?: string): string {\n  prefix = typeof prefix === \"string\" ? prefix : \"\\\\u\";\n  return prefix + (65536 | str.charCodeAt(0)).toString(16).substr(1);\n}\n\nexport function escapeNameStrToHex(str: string, prefix?: string): string {\n  function escapeChar(s) {\n    return escapeCharToHex(s, prefix);\n  }\n  return str.replace(/[^-a-zA-Z0-9_]/g, escapeChar);\n}\n\nexport function escapeRegExp(str: string): string {\n  return escapeNameStrToHex(str);\n}\n\nexport function unescapeCharFromHex(str: string, prefix?: string): string {\n  prefix = typeof prefix === \"string\" ? prefix : \"\\\\u\";\n  if (str.indexOf(prefix) === 0) {\n    return String.fromCharCode(parseInt(str.substring(prefix.length), 16));\n  } else {\n    return str;\n  }\n}\n\nexport function unescapeStrFromHex(str: string, prefix?: string): string {\n  prefix = typeof prefix === \"string\" ? prefix : \"\\\\u\";\n\n  function unescapeChar(s) {\n    return unescapeCharFromHex(s, prefix);\n  }\n  const regexp = new RegExp(`${escapeRegExp(prefix)}[0-9a-fA-F]{4}`, \"g\");\n  return str.replace(regexp, unescapeChar);\n}\n\n/**\n * Function good is defined for ints from 0 to high-1. It is such that for\n * each i between 1 and high-1 !good(i-1) || good(i) is true. In other words,\n * it goes like false ... false true ... true.\n * Find i such that (i == 0 || !good(i-1)) && (i == h || good(i))\n * In other words, good(i) is the \"first\" good = true.\n */\nexport function binarySearch(\n  high: number,\n  good: (p1: number) => boolean,\n): number {\n  let l = 0;\n  let h = high;\n  while (true) {\n    Asserts.assert(l <= h);\n    Asserts.assert(l == 0 || !good(l - 1));\n    Asserts.assert(h == high || good(h));\n    if (l == h) {\n      return l;\n    }\n    const m = (l + h) >> 1;\n    if (good(m)) {\n      h = m;\n    } else {\n      l = m + 1;\n    }\n  }\n}\n\n/**\n * Function to sort numbers low to high\n */\nexport function numberCompare(a: number, b: number): number {\n  return a - b;\n}\n\n/**\n * Index array using key function. First encountered item wins on collision.\n * Elements with empty and null keys are dropped.\n */\nexport function indexArray<T>(\n  arr: T[],\n  key: (p1: T) => string | null,\n): { [key: string]: T } {\n  const map: { [key: string]: T } = {};\n  for (const v of arr) {\n    const k: string | null = key(v);\n    if (k && !map[k]) {\n      map[k] = v;\n    }\n  }\n  return map;\n}\n\n/**\n * Convert array of strings to an object with the values in the array set to\n * true.\n */\nexport function arrayToSet(arr: string[]): { [key: string]: boolean } {\n  const set: { [key: string]: boolean } = {};\n  for (let i = 0; i < arr.length; i++) {\n    set[arr[i]] = true;\n  }\n  return set;\n}\n\n/**\n * Index array using key function. Repeated indices are all combined into\n * arrays. Elements with empty and null keys are dropped. Ordering of the\n * elements in arrays is preserved.\n */\nexport function multiIndexArray<T>(\n  arr: T[],\n  key: (p1: T) => string | null,\n): { [key: string]: T[] } {\n  const map: { [key: string]: T[] } = {};\n  for (const v of arr) {\n    const k = key(v);\n    if (k) {\n      if (map[k]) {\n        map[k].push(v);\n      } else {\n        map[k] = [v];\n      }\n    }\n  }\n  return map;\n}\n\n/**\n * Apply function to each value of the object\n * @param fn second parameter is the key\n */\nexport function mapObj<P, R>(\n  obj: { [key: string]: P },\n  fn: (p1: P, p2: string) => R,\n): { [key: string]: R } {\n  const res: { [key: string]: R } = {};\n  for (const n in obj) {\n    res[n] = fn(obj[n], n);\n  }\n  return res;\n}\n\nexport function mapSize(obj: object): number {\n  let n = 0;\n  for (const key in obj) {\n    n++;\n  }\n  return n;\n}\n\nexport type Event = {\n  type: string;\n  target?;\n  currentTarget?;\n  preventDefault?;\n  newPage?;\n  anchorElement?;\n  href?;\n  content?;\n};\n\nexport type EventListener = (p1: Event) => void;\n\n/**\n * Extemely simple-minded EventTarget implementation. Consider using\n * goog.events.EventTarget if you are using Closure library.\n */\nexport class SimpleEventTarget {\n  listeners: { [key: string]: EventListener[] } = {};\n\n  dispatchEvent(evt: Event): void {\n    const list = this.listeners[evt.type];\n    if (list) {\n      evt.target = this;\n      evt.currentTarget = this;\n      for (let i = 0; i < list.length; i++) {\n        list[i](evt);\n      }\n    }\n  }\n\n  addEventListener(\n    type: string,\n    listener: EventListener,\n    capture?: boolean,\n  ): void {\n    if (capture) {\n      return;\n    }\n    const list = this.listeners[type];\n    if (list) {\n      if (!list.includes(listener)) {\n        list.push(listener);\n      }\n    } else {\n      this.listeners[type] = [listener];\n    }\n  }\n\n  removeEventListener(\n    type: string,\n    listener: EventListener,\n    capture?: boolean,\n  ): void {\n    if (capture) {\n      return;\n    }\n    const list = this.listeners[type];\n    if (list) {\n      const index = list.indexOf(listener);\n      if (index >= 0) {\n        list.splice(index, 1);\n      }\n    }\n  }\n}\nexport type EventTarget = SimpleEventTarget;\n\nexport const mediaTags = {\n  audio: true,\n  canvas: true,\n  embed: true,\n  iframe: true,\n  img: true,\n  math: true,\n  object: true,\n  picture: true,\n  svg: true,\n  video: true,\n};\n", "/**\n * Copyright 2013 Google, Inc.\n * Copyright 2015 Daishinsha Inc.\n * Copyright 2019 Vivliostyle Foundation\n *\n * Vivliostyle.js is free software: you can redistribute it and/or modify\n * it under the terms of the GNU Affero General Public License as published by\n * the Free Software Foundation, either version 3 of the License, or\n * (at your option) any later version.\n *\n * Vivliostyle.js is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n * GNU Affero General Public License for more details.\n *\n * You should have received a copy of the GNU Affero General Public License\n * along with Vivliostyle.js.  If not, see <http://www.gnu.org/licenses/>.\n *\n * @fileoverview Cfi - Support for EPUB Canonical Fragment Identifiers.\n */\nimport * as Base from \"./base\";\nimport * as Logging from \"./logging\";\n\nexport type Position = {\n  node: Node;\n  offset: number;\n  after: boolean;\n  sideBias: string | null;\n  ref: Fragment;\n};\n\nexport function getId(node: Node): string | null {\n  if (node.nodeType == 1) {\n    const idtxt = (node as Element).getAttribute(\"id\");\n    if (idtxt) {\n      return idtxt;\n    }\n  }\n  return null;\n}\n\nexport function escapeChar(ch: string): string {\n  return `^${ch}`;\n}\n\nexport function escape(str: string): string {\n  return str.replace(/[\\[\\]\\(\\),=;^]/g, escapeChar);\n}\n\nexport function unescapeChar(str: string): string {\n  return str.substr(1);\n}\n\nexport function unescape(str: string): string {\n  if (!str) {\n    return str;\n  }\n  return str.replace(/\\^[\\[\\]\\(\\),=;^]/g, unescapeChar);\n}\n\nexport function parseExtVal(extstr: string): string | string[] {\n  const result = [];\n  do {\n    const r = extstr.match(/^(\\^,|[^,])*/);\n    const p = unescape(r[0]);\n    extstr = extstr.substr(r[0].length + 1);\n    if (!extstr && !result.length) {\n      return p;\n    }\n    result.push(p);\n  } while (extstr);\n  return result;\n}\n\nexport function parseExt(extstr: string): { [key: string]: string | string[] } {\n  const ext = {};\n  while (extstr) {\n    const r = extstr.match(/^;([^;=]+)=(([^;]|\\^;)*)/);\n    if (!r) {\n      return ext;\n    }\n    ext[r[1]] = parseExtVal(r[2]);\n    extstr = extstr.substr(r[0].length);\n  }\n  return ext;\n}\n\nexport interface Step {\n  appendTo(sb: Base.StringBuffer): void;\n\n  applyTo(pos: Position): boolean;\n}\n\nexport class RefStep implements Step {\n  appendTo(sb: Base.StringBuffer) {\n    sb.append(\"!\");\n  }\n\n  /** @override */\n  applyTo(pos: Position): boolean {\n    return false;\n  }\n}\n\nexport class ChildStep implements Step {\n  constructor(\n    public readonly index: number,\n    public readonly id: string | null,\n    public readonly sideBias: string | null,\n  ) {}\n\n  /** @override */\n  appendTo(sb: Base.StringBuffer): void {\n    sb.append(\"/\");\n    sb.append(this.index.toString());\n    if (this.id || this.sideBias) {\n      sb.append(\"[\");\n      if (this.id) {\n        sb.append(this.id);\n      }\n      if (this.sideBias) {\n        sb.append(\";s=\");\n        sb.append(this.sideBias);\n      }\n      sb.append(\"]\");\n    }\n  }\n\n  /** @override */\n  applyTo(pos: Position): boolean {\n    if (pos.node.nodeType != 1) {\n      throw new Error(\"E_CFI_NOT_ELEMENT\");\n    }\n    const elem = pos.node as Element;\n    const childElements = elem.children;\n    const childElementCount = childElements.length;\n    let child: Node;\n    const childIndex = Math.floor(this.index / 2) - 1;\n    if (childIndex < 0 || childElementCount == 0) {\n      child = elem.firstChild;\n      pos.node = child || elem;\n    } else {\n      child = childElements[Math.min(childIndex, childElementCount - 1)];\n      if (this.index & 1) {\n        const next = child.nextSibling;\n        if (!next || next.nodeType == 1) {\n          pos.after = true;\n        } else {\n          child = next;\n        }\n      }\n      pos.node = child;\n    }\n    if (this.id && (pos.after || this.id != getId(pos.node))) {\n      const movedNode = elem.ownerDocument.getElementById(this.id);\n      if (movedNode) {\n        pos.node = movedNode;\n      } else {\n        Logging.logger.warn(\"E_CFI_ID_MISMATCH:\", this.id);\n      }\n    }\n    pos.sideBias = this.sideBias;\n    return true;\n  }\n}\n\nexport class OffsetStep implements Step {\n  constructor(\n    public readonly offset: number,\n    public readonly textBefore: string | null,\n    public readonly textAfter: string | null,\n    public readonly sideBias: string | null,\n  ) {}\n\n  applyTo(pos: Position): boolean {\n    if (this.offset > 0 && !pos.after) {\n      let offset = this.offset;\n      let node = pos.node;\n      while (true) {\n        const nodeType = node.nodeType;\n        if (nodeType == 1) {\n          break;\n        }\n        const next = node.nextSibling;\n        if (3 <= nodeType && nodeType <= 5) {\n          const textLength = node.textContent.length;\n          if (offset <= textLength) {\n            break;\n          }\n          if (!next) {\n            offset = textLength;\n            break;\n          }\n          offset -= textLength;\n        }\n        if (!next) {\n          offset = 0;\n          break;\n        }\n        node = next;\n      }\n      pos.node = node;\n      pos.offset = offset;\n    }\n    pos.sideBias = this.sideBias;\n    return true;\n  }\n\n  /** @override */\n  appendTo(sb: Base.StringBuffer): void {\n    sb.append(\":\");\n    sb.append(this.offset.toString());\n    if (this.textBefore || this.textAfter || this.sideBias) {\n      sb.append(\"[\");\n      if (this.textBefore || this.textAfter) {\n        if (this.textBefore) {\n          sb.append(escape(this.textBefore));\n        }\n        sb.append(\",\");\n        if (this.textAfter) {\n          sb.append(escape(this.textAfter));\n        }\n      }\n      if (this.sideBias) {\n        sb.append(\";s=\");\n        sb.append(this.sideBias);\n      }\n      sb.append(\"]\");\n    }\n  }\n}\n\nexport class Fragment {\n  steps: Step[] = null;\n\n  fromString(fragstr: string): void {\n    let r = fragstr.match(/^#?epubcfi\\((.*)\\)$/);\n    if (!r) {\n      throw new Error(\"E_CFI_NOT_CFI\");\n    }\n    const str = decodeURIComponent(r[1]);\n    let i = 0;\n    const steps = [];\n    while (true) {\n      let ext: {\n        [key: string]: string | string[];\n      };\n      switch (str.charAt(i)) {\n        case \"/\": {\n          i++;\n          r = str\n            .substr(i)\n            .match(/^(0|[1-9][0-9]*)(\\[(.*?)(;([^\\]]|\\^\\])*)?\\])?/);\n          if (!r) {\n            throw new Error(\"E_CFI_NUMBER_EXPECTED\");\n          }\n          i += r[0].length;\n          const index = parseInt(r[1], 10);\n          const id = r[3];\n          ext = parseExt(r[4]);\n          steps.push(new ChildStep(index, id, Base.asString(ext[\"s\"])));\n          break;\n        }\n        case \":\": {\n          i++;\n          r = str\n            .substr(i)\n            .match(\n              /^(0|[1-9][0-9]*)(\\[((([^\\];,]|\\^[\\];,])*)(,(([^\\];,]|\\^[\\];,])*))?)(;([^]]|\\^\\])*)?\\])?/,\n            );\n          if (!r) {\n            throw new Error(\"E_CFI_NUMBER_EXPECTED\");\n          }\n          i += r[0].length;\n          const offset = parseInt(r[1], 10);\n          let textBefore = r[4];\n          if (textBefore) {\n            textBefore = unescape(textBefore);\n          }\n          let textAfter = r[7];\n          if (textAfter) {\n            textAfter = unescape(textAfter);\n          }\n          ext = parseExt(r[10]);\n          steps.push(\n            new OffsetStep(\n              offset,\n              textBefore,\n              textAfter,\n              Base.asString(ext[\"s\"]),\n            ),\n          );\n          break;\n        }\n        case \"!\":\n          i++;\n          steps.push(new RefStep());\n          break;\n        case \"~\":\n        case \"@\":\n\n        // Time/space terminus; only useful for highlights/selections which are\n        // not yet supported, skip for now. fall through\n        case \"\":\n          this.steps = steps;\n          return;\n        default:\n          throw new Error(\"E_CFI_PARSE_ERROR\");\n      }\n    }\n  }\n\n  navigate(doc: Document): Position {\n    const pos = {\n      node: doc.documentElement,\n      offset: 0,\n      after: false,\n      sideBias: null,\n      ref: null,\n    };\n    for (let i = 0; i < this.steps.length; i++) {\n      if (!this.steps[i].applyTo(pos)) {\n        pos.ref = new Fragment();\n        pos.ref.steps = this.steps.slice(i + 1);\n        break;\n      }\n    }\n    return pos;\n  }\n\n  trim(text: string, after: boolean): string {\n    return text\n      .replace(/\\s+/g, \" \")\n      .match(\n        after\n          ? /^[ -\\uD7FF\\uE000-\\uFFFF]{0,8}/\n          : /[ -\\uD7FF\\uE000-\\uFFFF]{0,8}$/,\n      )[0]\n      .replace(/^\\s/, \"\")\n      .replace(/\\s$/, \"\");\n  }\n\n  /**\n   * Initialize from a node and an offset.\n   */\n  prependPathFromNode(\n    node: Node,\n    offset: number,\n    after: boolean,\n    sideBias: string | null,\n  ) {\n    const steps = [];\n    let parent = node.parentNode;\n    let textBefore = \"\";\n    let textAfter = \"\";\n    while (node) {\n      switch (node.nodeType) {\n        case 3: // Text nodes\n        case 4:\n        case 5: {\n          const text = node.textContent;\n          const textLength = text.length;\n          if (after) {\n            offset += textLength;\n            if (!textBefore) {\n              textBefore = text;\n            }\n          } else {\n            if (offset > textLength) {\n              offset = textLength;\n            }\n            after = true;\n            textBefore = text.substr(0, offset);\n            textAfter = text.substr(offset);\n          }\n          node = node.previousSibling;\n          continue;\n        }\n        case 8: // Comment Node\n          node = node.previousSibling;\n          continue;\n      }\n      break;\n    }\n    if (offset > 0 || textBefore || textAfter) {\n      textBefore = this.trim(textBefore, false);\n      textAfter = this.trim(textAfter, true);\n      steps.push(new OffsetStep(offset, textBefore, textAfter, sideBias));\n      sideBias = null;\n    }\n    while (parent) {\n      if (!parent || parent.nodeType == 9) {\n        break;\n      }\n      const id = after ? null : getId(node);\n      let index = after ? 1 : 0;\n      while (node) {\n        if (node.nodeType == 1) {\n          index += 2;\n        }\n        node = node.previousSibling;\n      }\n      steps.push(new ChildStep(index, id, sideBias));\n      sideBias = null;\n      node = parent;\n      parent = parent.parentNode;\n      after = false;\n    }\n    steps.reverse();\n    if (this.steps) {\n      steps.push(new RefStep());\n      this.steps = steps.concat(this.steps);\n    } else {\n      this.steps = steps;\n    }\n  }\n\n  toString(): string {\n    if (!this.steps) {\n      return \"\";\n    }\n    const sb = new Base.StringBuffer();\n    sb.append(\"epubcfi(\");\n    for (let i = 0; i < this.steps.length; i++) {\n      this.steps[i].appendTo(sb);\n    }\n    sb.append(\")\");\n    return sb.toString().replace(/%/g, \"%25\");\n  }\n}\n", "/**\n * Copyright 2013 Google, Inc.\n * Copyright 2015 Daishinsha Inc.\n * Copyright 2019 Vivliostyle Foundation\n *\n * Vivliostyle.js is free software: you can redistribute it and/or modify\n * it under the terms of the GNU Affero General Public License as published by\n * the Free Software Foundation, either version 3 of the License, or\n * (at your option) any later version.\n *\n * Vivliostyle.js is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n * GNU Affero General Public License for more details.\n *\n * You should have received a copy of the GNU Affero General Public License\n * along with Vivliostyle.js.  If not, see <http://www.gnu.org/licenses/>.\n *\n * @fileoverview Exprs - `-epubx-expr` Adaptive Layout expressions.\n */\nimport * as Base from \"./base\";\n\nexport type Preferences = {\n  fontFamily: string;\n  lineHeight: number;\n  margin: number;\n  hyphenate: boolean;\n  columnWidth: number;\n  horizontal: boolean;\n  nightMode: boolean;\n  spreadView: boolean;\n  pageBorder: number;\n  enabledMediaTypes: { [key: string]: boolean };\n  defaultPaperSize?: { [key: string]: number };\n};\n\nexport function defaultPreferences(): Preferences {\n  return {\n    fontFamily: \"serif\",\n    lineHeight: 1.25,\n    margin: 8,\n    hyphenate: false,\n    columnWidth: 25,\n    horizontal: false,\n    nightMode: false,\n    spreadView: false,\n    pageBorder: 1,\n    enabledMediaTypes: { vivliostyle: true, print: true },\n    defaultPaperSize: undefined,\n  };\n}\n\nexport function clonePreferences(pref: Preferences): Preferences {\n  return {\n    fontFamily: pref.fontFamily,\n    lineHeight: pref.lineHeight,\n    margin: pref.margin,\n    hyphenate: pref.hyphenate,\n    columnWidth: pref.columnWidth,\n    horizontal: pref.horizontal,\n    nightMode: pref.nightMode,\n    spreadView: pref.spreadView,\n    pageBorder: pref.pageBorder,\n    enabledMediaTypes: Object.assign({}, pref.enabledMediaTypes),\n    defaultPaperSize: pref.defaultPaperSize\n      ? Object.assign({}, pref.defaultPaperSize)\n      : undefined,\n  };\n}\n\nexport const defaultPreferencesInstance = defaultPreferences();\n\ninterface Pending {}\ntype Special = Pending;\n\n/**\n * Special marker value that indicates that the expression result is being\n * calculated.\n */\n// eslint-disable-next-line no-redeclare\nexport const Special = {\n  PENDING: {} as Pending,\n};\n\nexport type Result = string | number | boolean | undefined;\n\nexport type PendingResult = Special | Result;\n\nexport function letterbox(\n  viewW: number,\n  viewH: number,\n  objW: number,\n  objH: number,\n): string {\n  const scale = Math.min((viewW - 0) / objW, (viewH - 0) / objH);\n  return `matrix(${scale},0,0,${scale},0,0)`;\n}\n\n/**\n * @return string that can be parsed as CSS string with value str\n */\nexport function cssString(str: string): string {\n  return `\"${Base.escapeCSSStr(`${str}`)}\"`;\n}\n\n/**\n * @return string that can be parsed as CSS name\n */\nexport function cssIdent(name: string): string {\n  return Base.escapeCSSIdent(`${name}`);\n}\n\nexport function makeQualifiedName(\n  objName: string | null,\n  memberName: string,\n): string {\n  if (objName) {\n    return `${Base.escapeCSSIdent(objName)}.${Base.escapeCSSIdent(memberName)}`;\n  }\n  return Base.escapeCSSIdent(memberName);\n}\n\nexport let nextKeyIndex: number = 0;\n\n/**\n * Lexical scope of the expression.\n */\nexport class LexicalScope {\n  scopeKey: string;\n  children: LexicalScope[] = [];\n  zero: Const;\n  one: Const;\n  _true: Const;\n  _false: Const;\n  values: { [key: string]: Val } = {};\n  funcs: { [key: string]: Val } = {};\n  builtIns: { [key: string]: (...p1: Result[]) => Result } = {};\n\n  constructor(\n    public parent: LexicalScope,\n    public resolver?: (p1: string, p2: boolean) => Val,\n  ) {\n    this.scopeKey = `S${nextKeyIndex++}`;\n    this.zero = new Const(this, 0);\n    this.one = new Const(this, 1);\n    this._true = new Const(this, true);\n    this._false = new Const(this, false);\n    if (parent) {\n      parent.children.push(this);\n    }\n    if (!parent) {\n      // root scope\n      const builtIns = this.builtIns;\n      builtIns[\"floor\"] = Math.floor;\n      builtIns[\"ceil\"] = Math.ceil;\n      builtIns[\"round\"] = Math.round;\n      builtIns[\"sqrt\"] = Math.sqrt;\n      builtIns[\"min\"] = Math.min;\n      builtIns[\"max\"] = Math.max;\n      builtIns[\"letterbox\"] = letterbox;\n      builtIns[\"css-string\"] = cssString;\n      builtIns[\"css-name\"] = cssIdent;\n      builtIns[\"typeof\"] = (x) => typeof x;\n      this.defineBuiltInName(\"page-width\", function () {\n        return this.pageWidth();\n      });\n      this.defineBuiltInName(\"page-height\", function () {\n        return this.pageHeight();\n      });\n      this.defineBuiltInName(\"pref-font-family\", function () {\n        return this.pref.fontFamily;\n      });\n      this.defineBuiltInName(\"pref-night-mode\", function () {\n        return this.pref.nightMode;\n      });\n      this.defineBuiltInName(\"pref-hyphenate\", function () {\n        return this.pref.hyphenate;\n      });\n      this.defineBuiltInName(\"pref-margin\", function () {\n        return this.pref.margin;\n      });\n      this.defineBuiltInName(\"pref-line-height\", function () {\n        return this.pref.lineHeight;\n      });\n      this.defineBuiltInName(\"pref-column-width\", function () {\n        return this.pref.columnWidth * this.fontSize;\n      });\n      this.defineBuiltInName(\"pref-horizontal\", function () {\n        return this.pref.horizontal;\n      });\n      this.defineBuiltInName(\"pref-spread-view\", function () {\n        return this.pref.spreadView;\n      });\n\n      // For env(pub-title) and env(doc-title)\n      this.defineBuiltInName(\"pub-title\", function () {\n        return cssString(this.pubTitle ? this.pubTitle : \"\");\n      });\n      this.defineBuiltInName(\"doc-title\", function () {\n        return cssString(this.docTitle ? this.docTitle : \"\");\n      });\n    }\n  }\n\n  defineBuiltInName(name: string, fn: () => Result) {\n    this.values[name] = new Native(this, fn, name);\n  }\n\n  defineName(qualifiedName: string, val: Val): void {\n    this.values[qualifiedName] = val;\n  }\n\n  defineFunc(qualifiedName: string, val: Val): void {\n    this.funcs[qualifiedName] = val;\n  }\n\n  defineBuiltIn(qualifiedName: string, fn: (...p1: Result[]) => Result): void {\n    this.builtIns[qualifiedName] = fn;\n  }\n}\n\nexport function isAbsoluteLengthUnit(unit: string): boolean {\n  switch (unit?.toLowerCase()) {\n    case \"px\":\n    case \"in\":\n    case \"pt\":\n    case \"pc\":\n    case \"cm\":\n    case \"mm\":\n    case \"q\":\n      return true;\n    default:\n      return false;\n  }\n}\n\nexport function isViewportRelativeLengthUnit(unit: string): boolean {\n  switch (unit?.toLowerCase()) {\n    case \"vw\":\n    case \"vh\":\n    case \"vi\":\n    case \"vb\":\n    case \"vmin\":\n    case \"vmax\":\n    case \"pvw\":\n    case \"pvh\":\n    case \"pvi\":\n    case \"pvb\":\n    case \"pvmin\":\n    case \"pvmax\":\n      return true;\n    default:\n      return false;\n  }\n}\n\nexport function isFontRelativeLengthUnit(unit: string): boolean {\n  switch (unit?.toLowerCase()) {\n    case \"em\":\n    case \"rem\":\n    case \"lh\":\n    case \"rlh\":\n      return true;\n    default:\n      return false;\n  }\n}\n\nexport function isRootFontRelativeLengthUnit(unit: string): boolean {\n  switch (unit?.toLowerCase()) {\n    case \"rem\":\n    case \"rlh\":\n      return true;\n    default:\n      return false;\n  }\n}\n\nexport const defaultUnitSizes: { [key: string]: number } = {\n  px: 1,\n  in: 96,\n  pt: 4 / 3,\n  pc: 96 / 6,\n  cm: 96 / 2.54,\n  mm: 96 / 25.4,\n  q: 96 / 2.54 / 40,\n  em: 16,\n  rem: 16,\n  lh: 20,\n  rlh: 20,\n  // <resolution>\n  dppx: 1,\n  dpi: 1 / 96,\n  dpcm: 2.54 / 96,\n};\n\n/**\n * Returns if a unit should be converted to px before applied to the raw DOM.\n */\nexport function needUnitConversion(unit: string): boolean {\n  switch (unit) {\n    case \"q\":\n      return !CSS.supports(\"font-size\", \"1q\");\n    case \"lh\":\n      return !CSS.supports(\"line-height\", \"1lh\");\n    case \"rem\":\n    case \"rlh\":\n      return true;\n    default:\n      return false;\n  }\n}\n\nexport type ScopeContext = {\n  [key: string]: Result;\n};\n\n/**\n * Run-time instance of a scope and its children.\n */\nexport class Context {\n  protected actualPageWidth: number | null = null;\n  pageWidth: () => number;\n  protected actualPageHeight: number | null = null;\n  pageHeight: () => number;\n  initialFontSize: number;\n  rootFontSize: number | null = null;\n  isRelativeRootFontSize: boolean | null = null;\n  fontSize: () => number;\n  rootLineHeight: number | null = null;\n  pref: Preferences;\n  scopes: { [key: string]: ScopeContext } = {};\n  pageAreaWidth: number | null = null;\n  pageAreaHeight: number | null = null;\n  pageVertical: boolean | null = null;\n  pubTitle: string | null = null;\n  docTitle: string | null = null;\n\n  constructor(\n    public readonly rootScope: LexicalScope,\n    public readonly viewportWidth: number,\n    public readonly viewportHeight: number,\n    fontSize: number,\n  ) {\n    this.pageWidth = function () {\n      if (this.actualPageWidth) {\n        return this.actualPageWidth;\n      } else {\n        return this.pref.spreadView\n          ? Math.floor(viewportWidth / 2) - this.pref.pageBorder\n          : viewportWidth;\n      }\n    };\n    this.pageHeight = function () {\n      if (this.actualPageHeight) {\n        return this.actualPageHeight;\n      } else {\n        return viewportHeight;\n      }\n    };\n    this.initialFontSize = fontSize;\n    this.fontSize = function () {\n      if (this.rootFontSize) {\n        return this.rootFontSize;\n      } else {\n        return fontSize;\n      }\n    };\n    this.pref = defaultPreferencesInstance;\n  }\n\n  private getScopeContext(scope: LexicalScope): ScopeContext {\n    let s = this.scopes[scope.scopeKey];\n    if (!s) {\n      s = {};\n      this.scopes[scope.scopeKey] = s;\n    }\n    return s;\n  }\n\n  clearScope(scope: LexicalScope): void {\n    this.scopes[scope.scopeKey] = {};\n    for (let k = 0; k < scope.children.length; k++) {\n      this.clearScope(scope.children[k]);\n    }\n  }\n\n  queryUnitSize(unit: string, isRoot: boolean, vertical?: boolean): number {\n    if (isViewportRelativeLengthUnit(unit)) {\n      const pvw = this.pageWidth() / 100;\n      const pvh = this.pageHeight() / 100;\n      const vw = this.pageAreaWidth != null ? this.pageAreaWidth / 100 : pvw;\n      const vh = this.pageAreaHeight != null ? this.pageAreaHeight / 100 : pvh;\n      const isVertical = vertical ?? this.pageVertical;\n\n      switch (unit) {\n        case \"vw\":\n          return vw;\n        case \"vh\":\n          return vh;\n        case \"vi\":\n          return isVertical ? vh : vw;\n        case \"vb\":\n          return isVertical ? vw : vh;\n        case \"vmin\":\n          return vw < vh ? vw : vh;\n        case \"vmax\":\n          return vw > vh ? vw : vh;\n        case \"pvw\":\n          return pvw;\n        case \"pvh\":\n          return pvh;\n        case \"pvi\":\n          return isVertical ? pvh : pvw;\n        case \"pvb\":\n          return isVertical ? pvw : pvh;\n        case \"pvmin\":\n          return pvw < pvh ? pvw : pvh;\n        case \"pvmax\":\n          return pvw > pvh ? pvw : pvh;\n      }\n    }\n    if (unit == \"em\" || unit == \"rem\") {\n      return isRoot ? this.initialFontSize : this.fontSize();\n    }\n    if (unit == \"lh\" || unit == \"rlh\") {\n      // FIXME: \"lh\" unit is incorrect, treated same as \"rlh\"\n      return this.rootLineHeight;\n    }\n\n    return defaultUnitSizes[unit];\n  }\n\n  evalName(scope: LexicalScope, qualifiedName: string): Val {\n    do {\n      let val = scope.values[qualifiedName];\n      if (val) {\n        return val;\n      }\n      if (scope.resolver) {\n        val = scope.resolver.call(this, qualifiedName, false);\n        if (val) {\n          return val;\n        }\n      }\n      scope = scope.parent;\n    } while (scope);\n    throw new Error(`Name '${qualifiedName}' is undefined`);\n  }\n\n  /**\n   * @param noBuiltInEval don't evaluate built-ins (for dependency calculations)\n   */\n  evalCall(\n    scope: LexicalScope,\n    qualifiedName: string,\n    params: Val[],\n    noBuiltInEval: boolean,\n  ): Val {\n    do {\n      let body = scope.funcs[qualifiedName];\n      if (body) {\n        return body; // will be expanded by callee\n      }\n      if (scope.resolver) {\n        body = scope.resolver.call(this, qualifiedName, true);\n        if (body) {\n          return body;\n        }\n      }\n      const fn = scope.builtIns[qualifiedName];\n      if (fn) {\n        if (noBuiltInEval) {\n          return scope.zero;\n        }\n        const args = Array(params.length);\n        for (let i = 0; i < params.length; i++) {\n          args[i] = params[i].evaluate(this);\n        }\n        return new Const(scope, fn.apply(this, args));\n      }\n      scope = scope.parent;\n    } while (scope);\n    throw new Error(`Function '${qualifiedName}' is undefined`);\n  }\n\n  evalMediaName(name: string, not: boolean): boolean {\n    const enabled = name === \"all\" || !!this.pref.enabledMediaTypes[name];\n    return not ? !enabled : enabled;\n  }\n\n  evalMediaTest(feature: string, value: Val): boolean {\n    let prefix = \"\";\n    const r = feature.match(/^(min|max)-(.*)$/);\n    if (r) {\n      prefix = r[1];\n      feature = r[2];\n    }\n    let req: Result | null = null;\n    let actual: number | null = null;\n    switch (feature) {\n      case \"width\":\n      case \"height\":\n      case \"device-width\":\n      case \"device-height\":\n      case \"color\":\n        if (value) {\n          req = value.evaluate(this);\n        }\n        break;\n    }\n    switch (feature) {\n      case \"width\":\n        actual = this.pageWidth();\n        break;\n      case \"height\":\n        actual = this.pageHeight();\n        break;\n      case \"device-width\":\n        actual = window.screen.availWidth;\n        break;\n      case \"device-height\":\n        actual = window.screen.availHeight;\n        break;\n      case \"color\":\n        actual = window.screen.pixelDepth;\n        break;\n    }\n    if (actual != null && req != null) {\n      switch (prefix) {\n        case \"min\":\n          return actual >= Number(req);\n        case \"max\":\n          return actual <= Number(req);\n        default:\n          return actual == req;\n      }\n    } else if (actual != null && value == null) {\n      return actual !== 0;\n    }\n    return false;\n  }\n\n  evalSupportsTest(name: string, value: string, isFunc: boolean): boolean {\n    return false;\n  }\n\n  queryVal(scope: LexicalScope, key: string): Result | undefined {\n    const s = scope && this.scopes[scope.scopeKey];\n    return s ? s[key] : undefined;\n  }\n\n  storeVal(scope: LexicalScope, key: string, val: Result): void {\n    this.getScopeContext(scope)[key] = val;\n  }\n}\n\n//---------- name resolution --------------\nexport type DependencyCache = {\n  [key: string]: boolean | Special;\n};\n\nexport class Val {\n  key: string;\n\n  constructor(public scope: LexicalScope) {\n    this.scope = scope;\n    this.key = `_${nextKeyIndex++}`;\n  }\n\n  /** @override */\n  toString(): string {\n    const buf = new Base.StringBuffer();\n    this.appendTo(buf, 0);\n    return buf.toString();\n  }\n\n  appendTo(buf: Base.StringBuffer, priority: number): void {\n    throw new Error(\"F_ABSTRACT\");\n  }\n\n  protected evaluateCore(context: Context): Result {\n    throw new Error(\"F_ABSTRACT\");\n  }\n\n  expand(context: Context, params: Val[]): Val {\n    return this;\n  }\n\n  dependCore(\n    other: Val,\n    context: Context,\n    dependencyCache: DependencyCache,\n  ): boolean {\n    return other === this;\n  }\n\n  dependOuter(\n    other: Val,\n    context: Context,\n    dependencyCache: DependencyCache,\n  ): boolean {\n    const cached = dependencyCache[this.key];\n    if (cached != null) {\n      if (cached === Special.PENDING) {\n        return false;\n      }\n      return cached as boolean;\n    } else {\n      dependencyCache[this.key] = Special.PENDING;\n      const result = this.dependCore(other, context, dependencyCache);\n      dependencyCache[this.key] = result;\n      return result;\n    }\n  }\n\n  depend(other: Val, context: Context): boolean {\n    return this.dependOuter(other, context, {});\n  }\n\n  evaluate(context: Context): Result {\n    let result = context.queryVal(this.scope, this.key);\n    if (typeof result != \"undefined\") {\n      return result;\n    }\n    result = this.evaluateCore(context);\n    if (this.scope) {\n      context.storeVal(this.scope, this.key, result);\n    }\n    return result;\n  }\n\n  isMediaName(): boolean {\n    return false;\n  }\n}\n\nexport class Prefix extends Val {\n  constructor(\n    scope: LexicalScope,\n    public val: Val,\n  ) {\n    super(scope);\n  }\n\n  protected getOp(): string {\n    throw new Error(\"F_ABSTRACT\");\n  }\n\n  evalPrefix(val: Result): Result {\n    throw new Error(\"F_ABSTRACT\");\n  }\n\n  override evaluateCore(context: Context): Result {\n    const val = this.val.evaluate(context);\n    return this.evalPrefix(val);\n  }\n\n  override dependCore(\n    other: Val,\n    context: Context,\n    dependencyCache: DependencyCache,\n  ): boolean {\n    return (\n      other === this || this.val.dependOuter(other, context, dependencyCache)\n    );\n  }\n\n  override appendTo(buf: Base.StringBuffer, priority: number): void {\n    if (10 < priority) {\n      buf.append(\"(\");\n    }\n    buf.append(this.getOp());\n    this.val.appendTo(buf, 10);\n    if (10 < priority) {\n      buf.append(\")\");\n    }\n  }\n\n  override expand(context: Context, params: Val[]): Val {\n    const val = this.val.expand(context, params);\n    if (val === this.val) {\n      return this;\n    }\n    const r = new (this.constructor as any)(this.scope, val);\n    return r;\n  }\n}\n\nexport class Infix extends Val {\n  constructor(\n    scope: LexicalScope,\n    public lhs: Val,\n    public rhs: Val,\n  ) {\n    super(scope);\n  }\n\n  getPriority(): number {\n    throw new Error(\"F_ABSTRACT\");\n  }\n\n  getOp(): string {\n    throw new Error(\"F_ABSTRACT\");\n  }\n\n  evalInfix(lhs: Result, rhs: Result): Result {\n    throw new Error(\"F_ABSTRACT\");\n  }\n\n  override evaluateCore(context: Context): Result {\n    const lhs = this.lhs.evaluate(context);\n    const rhs = this.rhs.evaluate(context);\n    return this.evalInfix(lhs, rhs);\n  }\n\n  override dependCore(\n    other: Val,\n    context: Context,\n    dependencyCache: DependencyCache,\n  ): boolean {\n    return (\n      other === this ||\n      this.lhs.dependOuter(other, context, dependencyCache) ||\n      this.rhs.dependOuter(other, context, dependencyCache)\n    );\n  }\n\n  override appendTo(buf: Base.StringBuffer, priority: number): void {\n    const thisPriority = this.getPriority();\n    if (thisPriority <= priority) {\n      buf.append(\"(\");\n    }\n    this.lhs.appendTo(buf, thisPriority);\n    buf.append(this.getOp());\n    this.rhs.appendTo(buf, thisPriority);\n    if (thisPriority <= priority) {\n      buf.append(\")\");\n    }\n  }\n\n  override expand(context: Context, params: Val[]): Val {\n    const lhs = this.lhs.expand(context, params);\n    const rhs = this.rhs.expand(context, params);\n    if (lhs === this.lhs && rhs === this.rhs) {\n      return this;\n    }\n    const r = new (this.constructor as any)(this.scope, lhs, rhs);\n    return r;\n  }\n}\n\nexport class Logical extends Infix {\n  constructor(scope: LexicalScope, lhs: Val, rhs: Val) {\n    super(scope, lhs, rhs);\n  }\n\n  override getPriority(): number {\n    return 1;\n  }\n}\n\nexport class Comparison extends Infix {\n  constructor(scope: LexicalScope, lhs: Val, rhs: Val) {\n    super(scope, lhs, rhs);\n  }\n\n  override getPriority(): number {\n    return 2;\n  }\n}\n\nexport class Additive extends Infix {\n  constructor(scope: LexicalScope, lhs: Val, rhs: Val) {\n    super(scope, lhs, rhs);\n  }\n\n  override getPriority(): number {\n    return 3;\n  }\n}\n\nexport class Multiplicative extends Infix {\n  constructor(scope: LexicalScope, lhs: Val, rhs: Val) {\n    super(scope, lhs, rhs);\n  }\n\n  override getPriority(): number {\n    return 4;\n  }\n}\n\nexport class Not extends Prefix {\n  constructor(scope: LexicalScope, val: Val) {\n    super(scope, val);\n  }\n\n  override getOp(): string {\n    return \"!\";\n  }\n\n  override evalPrefix(val: Result): Result {\n    return !val;\n  }\n}\n\nexport class NotMedia extends Not {\n  constructor(scope: LexicalScope, val: Val) {\n    super(scope, val);\n  }\n\n  override getOp(): string {\n    return \"not \";\n  }\n}\n\nexport class Negate extends Prefix {\n  constructor(scope: LexicalScope, val: Val) {\n    super(scope, val);\n  }\n\n  override getOp(): string {\n    return \"-\";\n  }\n\n  override evalPrefix(val: Result): Result {\n    return -val;\n  }\n}\n\nexport class And extends Logical {\n  constructor(scope: LexicalScope, lhs: Val, rhs: Val) {\n    super(scope, lhs, rhs);\n  }\n\n  override getOp(): string {\n    return \"&&\";\n  }\n\n  override evaluateCore(context: Context): Result {\n    return this.lhs.evaluate(context) && this.rhs.evaluate(context);\n  }\n}\n\nexport class AndMedia extends And {\n  constructor(scope: LexicalScope, lhs: Val, rhs: Val) {\n    super(scope, lhs, rhs);\n  }\n\n  override getOp(): string {\n    return \" and \";\n  }\n}\n\nexport class Or extends Logical {\n  constructor(scope: LexicalScope, lhs: Val, rhs: Val) {\n    super(scope, lhs, rhs);\n  }\n\n  override getOp(): string {\n    return \"||\";\n  }\n\n  override evaluateCore(context: Context): Result {\n    return this.lhs.evaluate(context) || this.rhs.evaluate(context);\n  }\n}\n\nexport class Comma extends Or {\n  constructor(scope: LexicalScope, lhs: Val, rhs: Val) {\n    super(scope, lhs, rhs);\n  }\n\n  override getOp(): string {\n    return \", \";\n  }\n}\n\nexport class OrMedia extends Or {\n  constructor(scope: LexicalScope, lhs: Val, rhs: Val) {\n    super(scope, lhs, rhs);\n  }\n\n  override getOp(): string {\n    return \" or \";\n  }\n}\n\nexport class Lt extends Comparison {\n  constructor(scope: LexicalScope, lhs: Val, rhs: Val) {\n    super(scope, lhs, rhs);\n  }\n\n  override getOp(): string {\n    return \"<\";\n  }\n\n  override evalInfix(lhs: Result, rhs: Result): Result {\n    return lhs < rhs;\n  }\n}\n\nexport class Le extends Comparison {\n  constructor(scope: LexicalScope, lhs: Val, rhs: Val) {\n    super(scope, lhs, rhs);\n  }\n\n  override getOp(): string {\n    return \"<=\";\n  }\n\n  override evalInfix(lhs: Result, rhs: Result): Result {\n    return lhs <= rhs;\n  }\n}\n\nexport class Gt extends Comparison {\n  constructor(scope: LexicalScope, lhs: Val, rhs: Val) {\n    super(scope, lhs, rhs);\n  }\n\n  override getOp(): string {\n    return \">\";\n  }\n\n  override evalInfix(lhs: Result, rhs: Result): Result {\n    return lhs > rhs;\n  }\n}\n\nexport class Ge extends Comparison {\n  constructor(scope: LexicalScope, lhs: Val, rhs: Val) {\n    super(scope, lhs, rhs);\n  }\n\n  override getOp(): string {\n    return \">=\";\n  }\n\n  override evalInfix(lhs: Result, rhs: Result): Result {\n    return lhs >= rhs;\n  }\n}\n\nexport class Eq extends Comparison {\n  constructor(scope: LexicalScope, lhs: Val, rhs: Val) {\n    super(scope, lhs, rhs);\n  }\n\n  override getOp(): string {\n    return \"==\";\n  }\n\n  override evalInfix(lhs: Result, rhs: Result): Result {\n    return lhs == rhs;\n  }\n}\n\nexport class Ne extends Comparison {\n  constructor(scope: LexicalScope, lhs: Val, rhs: Val) {\n    super(scope, lhs, rhs);\n  }\n\n  override getOp(): string {\n    return \"!=\";\n  }\n\n  override evalInfix(lhs: Result, rhs: Result): Result {\n    return lhs != rhs;\n  }\n}\n\nexport class Add extends Additive {\n  constructor(scope: LexicalScope, lhs: Val, rhs: Val) {\n    super(scope, lhs, rhs);\n  }\n\n  override getOp(): string {\n    return \"+\";\n  }\n\n  override evalInfix(lhs: Result, rhs: Result): Result {\n    return (lhs as any) + rhs;\n  }\n}\n\nexport class Subtract extends Additive {\n  constructor(scope: LexicalScope, lhs: Val, rhs: Val) {\n    super(scope, lhs, rhs);\n  }\n\n  override getOp(): string {\n    return \" - \";\n  }\n\n  override evalInfix(lhs: Result, rhs: Result): Result {\n    return (lhs as any) - (rhs as any);\n  }\n}\n\nexport class Multiply extends Multiplicative {\n  constructor(scope: LexicalScope, lhs: Val, rhs: Val) {\n    super(scope, lhs, rhs);\n  }\n\n  override getOp(): string {\n    return \"*\";\n  }\n\n  override evalInfix(lhs: Result, rhs: Result): Result {\n    return (lhs as any) * (rhs as any);\n  }\n}\n\nexport class Divide extends Multiplicative {\n  constructor(scope: LexicalScope, lhs: Val, rhs: Val) {\n    super(scope, lhs, rhs);\n  }\n\n  override getOp(): string {\n    return \"/\";\n  }\n\n  override evalInfix(lhs: Result, rhs: Result): Result {\n    return (lhs as any) / (rhs as any);\n  }\n}\n\nexport class Modulo extends Multiplicative {\n  constructor(scope: LexicalScope, lhs: Val, rhs: Val) {\n    super(scope, lhs, rhs);\n  }\n\n  override getOp(): string {\n    return \"%\";\n  }\n\n  override evalInfix(lhs: Result, rhs: Result): Result {\n    return (lhs as any) % (rhs as any);\n  }\n}\n\n/**\n * Numerical value with a unit.\n */\nexport class Numeric extends Val {\n  unit: string;\n\n  constructor(\n    scope: LexicalScope,\n    public num: number,\n    unit: string,\n  ) {\n    super(scope);\n    this.unit = unit?.toLowerCase() ?? \"\";\n  }\n\n  override appendTo(buf: Base.StringBuffer, priority: number): void {\n    buf.append(this.num.toString());\n    buf.append(Base.escapeCSSIdent(this.unit));\n  }\n\n  override evaluateCore(context: Context): Result {\n    return this.num * context.queryUnitSize(this.unit, false);\n  }\n}\n\n/**\n * Named value.\n * @param qualifiedName CSS-escaped name sequence separated by dots.\n */\nexport class Named extends Val {\n  constructor(\n    scope: LexicalScope,\n    public qualifiedName: string,\n  ) {\n    super(scope);\n  }\n\n  override appendTo(buf: Base.StringBuffer, priority: number): void {\n    buf.append(this.qualifiedName);\n  }\n\n  override evaluateCore(context: Context): Result {\n    return context.evalName(this.scope, this.qualifiedName).evaluate(context);\n  }\n\n  override dependCore(\n    other: Val,\n    context: Context,\n    dependencyCache: DependencyCache,\n  ): boolean {\n    return (\n      other === this ||\n      context\n        .evalName(this.scope, this.qualifiedName)\n        .dependOuter(other, context, dependencyCache)\n    );\n  }\n}\n\n/**\n * Named value.\n */\nexport class MediaName extends Val {\n  constructor(\n    scope: LexicalScope,\n    public not: boolean,\n    public name: string,\n  ) {\n    super(scope);\n  }\n\n  override appendTo(buf: Base.StringBuffer, priority: number): void {\n    if (this.not) {\n      buf.append(\"not \");\n    }\n    buf.append(Base.escapeCSSIdent(this.name));\n  }\n\n  override evaluateCore(context: Context): Result {\n    return context.evalMediaName(this.name, this.not);\n  }\n\n  override isMediaName(): boolean {\n    return true;\n  }\n}\n\n/**\n * A value that is calculated by calling a JavaScript function. Note that the\n * result is cached and this function will be called only once between any\n * clears for its scope in the context.\n * @param fn function to call.\n * @param str a way to represent this value in toString() call.\n */\nexport class Native extends Val {\n  constructor(\n    scope: LexicalScope,\n    public fn: () => Result,\n    public str: string,\n  ) {\n    super(scope);\n  }\n\n  override appendTo(buf: Base.StringBuffer, priority: number): void {\n    buf.append(this.str);\n  }\n\n  override evaluateCore(context: Context): Result {\n    return this.fn.call(context);\n  }\n}\n\nexport function appendValArray(buf: Base.StringBuffer, arr: Val[]): void {\n  buf.append(\"(\");\n  for (let i = 0; i < arr.length; i++) {\n    if (i) {\n      buf.append(\",\");\n    }\n    arr[i].appendTo(buf, 0);\n  }\n  buf.append(\")\");\n}\n\nexport function expandValArray(\n  context: Context,\n  arr: Val[],\n  params: Val[],\n): Val[] {\n  let expanded: Val[] = arr;\n  for (let i = 0; i < arr.length; i++) {\n    const p = arr[i].expand(context, params);\n    if (arr !== expanded) {\n      expanded[i] = p;\n    } else if (p !== arr[i]) {\n      expanded = Array(arr.length);\n      for (let j = 0; j < i; j++) {\n        expanded[j] = arr[j];\n      }\n      expanded[i] = p;\n    }\n  }\n  return expanded;\n}\n\nexport function evalValArray(context: Context, arr: Val[]): Result[] {\n  const result: Result[] = Array(arr.length);\n  for (let i = 0; i < arr.length; i++) {\n    result[i] = arr[i].evaluate(context);\n  }\n  return result;\n}\n\nexport class Call extends Val {\n  constructor(\n    scope: LexicalScope,\n    public qualifiedName: string,\n    public params: Val[],\n  ) {\n    super(scope);\n  }\n\n  override appendTo(buf: Base.StringBuffer, priority: number): void {\n    buf.append(this.qualifiedName);\n    appendValArray(buf, this.params);\n  }\n\n  override evaluateCore(context: Context): Result {\n    const body = context.evalCall(\n      this.scope,\n      this.qualifiedName,\n      this.params,\n      false,\n    );\n    return body.expand(context, this.params).evaluate(context);\n  }\n\n  override dependCore(\n    other: Val,\n    context: Context,\n    dependencyCache: DependencyCache,\n  ): boolean {\n    if (other === this) {\n      return true;\n    }\n    for (let i = 0; i < this.params.length; i++) {\n      if (this.params[i].dependOuter(other, context, dependencyCache)) {\n        return true;\n      }\n    }\n    const body = context.evalCall(\n      this.scope,\n      this.qualifiedName,\n      this.params,\n      true,\n    );\n\n    // No expansion here!\n    return body.dependOuter(other, context, dependencyCache);\n  }\n\n  override expand(context: Context, params: Val[]): Val {\n    const expandedParams = expandValArray(context, this.params, params);\n    if (expandedParams === this.params) {\n      return this;\n    }\n    return new Call(this.scope, this.qualifiedName, expandedParams);\n  }\n}\n\nexport class Cond extends Val {\n  constructor(\n    scope: LexicalScope,\n    public cond: Val,\n    public ifTrue: Val,\n    public ifFalse: Val,\n  ) {\n    super(scope);\n  }\n\n  override appendTo(buf: Base.StringBuffer, priority: number): void {\n    if (priority > 0) {\n      buf.append(\"(\");\n    }\n    this.cond.appendTo(buf, 0);\n    buf.append(\"?\");\n    this.ifTrue.appendTo(buf, 0);\n    buf.append(\":\");\n    this.ifFalse.appendTo(buf, 0);\n    if (priority > 0) {\n      buf.append(\")\");\n    }\n  }\n\n  override evaluateCore(context: Context): Result {\n    if (this.cond.evaluate(context)) {\n      return this.ifTrue.evaluate(context);\n    } else {\n      return this.ifFalse.evaluate(context);\n    }\n  }\n\n  override dependCore(\n    other: Val,\n    context: Context,\n    dependencyCache: DependencyCache,\n  ): boolean {\n    return (\n      other === this ||\n      this.cond.dependOuter(other, context, dependencyCache) ||\n      this.ifTrue.dependOuter(other, context, dependencyCache) ||\n      this.ifFalse.dependOuter(other, context, dependencyCache)\n    );\n  }\n\n  override expand(context: Context, params: Val[]): Val {\n    const cond = this.cond.expand(context, params);\n    const ifTrue = this.ifTrue.expand(context, params);\n    const ifFalse = this.ifFalse.expand(context, params);\n    if (\n      cond === this.cond &&\n      ifTrue === this.ifTrue &&\n      ifFalse === this.ifFalse\n    ) {\n      return this;\n    }\n    const r = new Cond(this.scope, cond, ifTrue, ifFalse);\n    return r;\n  }\n}\n\nexport class Const extends Val {\n  constructor(\n    scope: LexicalScope,\n    public val: Result,\n  ) {\n    super(scope);\n  }\n\n  override appendTo(buf: Base.StringBuffer, priority: number): void {\n    switch (typeof this.val) {\n      case \"number\":\n      case \"boolean\":\n        buf.append(this.val.toString());\n        break;\n      case \"string\":\n        buf.append('\"');\n        buf.append(Base.escapeCSSStr(this.val));\n        buf.append('\"');\n        break;\n      default:\n        throw new Error(\"F_UNEXPECTED_STATE\");\n    }\n  }\n\n  override evaluateCore(context: Context): Result {\n    return this.val;\n  }\n}\n\nexport class MediaTest extends Val {\n  constructor(\n    scope: LexicalScope,\n    public name: MediaName,\n    public value: Val,\n  ) {\n    super(scope);\n  }\n\n  override appendTo(buf: Base.StringBuffer, priority: number): void {\n    buf.append(\"(\");\n    buf.append(Base.escapeCSSStr(this.name.name));\n    buf.append(\":\");\n    this.value.appendTo(buf, 0);\n    buf.append(\")\");\n  }\n\n  override evaluateCore(context: Context): Result {\n    return context.evalMediaTest(this.name.name, this.value);\n  }\n\n  override dependCore(\n    other: Val,\n    context: Context,\n    dependencyCache: DependencyCache,\n  ): boolean {\n    return (\n      other === this || this.value.dependOuter(other, context, dependencyCache)\n    );\n  }\n\n  override expand(context: Context, params: Val[]): Val {\n    const value = this.value.expand(context, params);\n    if (value === this.value) {\n      return this;\n    }\n    const r = new MediaTest(this.scope, this.name, value);\n    return r;\n  }\n}\n\nexport class SupportsTest extends Val {\n  constructor(\n    scope: LexicalScope,\n    public name: string,\n    public value: string,\n    public isFunc: boolean,\n  ) {\n    super(scope);\n  }\n\n  override appendTo(buf: Base.StringBuffer, priority: number): void {\n    if (this.isFunc) {\n      buf.append(this.name);\n    }\n    buf.append(\"(\");\n    if (!this.isFunc && this.name) {\n      buf.append(this.name);\n      buf.append(\":\");\n    }\n    buf.append(this.value);\n    buf.append(\")\");\n  }\n\n  override evaluateCore(context: Context): Result {\n    return context.evalSupportsTest(this.name, this.value, this.isFunc);\n  }\n}\n\nexport class Param extends Val {\n  constructor(\n    scope: LexicalScope,\n    public index: number,\n  ) {\n    super(scope);\n  }\n\n  override appendTo(buf: Base.StringBuffer, priority: number): void {\n    buf.append(\"$\");\n    buf.append(this.index.toString());\n  }\n\n  override expand(context: Context, params: Val[]): Val {\n    const v = params[this.index];\n    if (!v) {\n      throw new Error(`Parameter missing: ${this.index}`);\n    }\n    return v as Val;\n  }\n}\n\nexport function and(scope: LexicalScope, v1: Val, v2: Val): Val {\n  if (\n    v1 === scope._false ||\n    v1 === scope.zero ||\n    v2 == scope._false ||\n    v2 == scope.zero\n  ) {\n    return scope._false;\n  }\n  if (v1 === scope._true || v1 === scope.one) {\n    return v2;\n  }\n  if (v2 === scope._true || v2 === scope.one) {\n    return v1;\n  }\n  return new And(scope, v1, v2);\n}\n\nexport function add(scope: LexicalScope, v1: Val, v2: Val): Val {\n  if (v1 === scope.zero) {\n    return v2;\n  }\n  if (v2 === scope.zero) {\n    return v1;\n  }\n  return new Add(scope, v1, v2);\n}\n\nexport function sub(scope: LexicalScope, v1: Val, v2: Val): Val {\n  if (v1 === scope.zero) {\n    return new Negate(scope, v2);\n  }\n  if (v2 === scope.zero) {\n    return v1;\n  }\n  return new Subtract(scope, v1, v2);\n}\n\nexport function mul(scope: LexicalScope, v1: Val, v2: Val): Val {\n  if (v1 === scope.zero || v2 === scope.zero) {\n    return scope.zero;\n  }\n  if (v1 === scope.one) {\n    return v2;\n  }\n  if (v2 === scope.one) {\n    return v1;\n  }\n  return new Multiply(scope, v1, v2);\n}\n\nexport function div(scope: LexicalScope, v1: Val, v2: Val): Val {\n  if (v1 === scope.zero) {\n    return scope.zero;\n  }\n  if (v2 === scope.one) {\n    return v1;\n  }\n  return new Divide(scope, v1, v2);\n}\n", "/**\n * Copyright 2013 Google, Inc.\n * Copyright 2015 Daishinsha Inc.\n * Copyright 2019 Vivliostyle Foundation\n *\n * Vivliostyle.js is free software: you can redistribute it and/or modify\n * it under the terms of the GNU Affero General Public License as published by\n * the Free Software Foundation, either version 3 of the License, or\n * (at your option) any later version.\n *\n * Vivliostyle.js is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n * GNU Affero General Public License for more details.\n *\n * You should have received a copy of the GNU Affero General Public License\n * along with Vivliostyle.js.  If not, see <http://www.gnu.org/licenses/>.\n *\n * @fileoverview Css - CSS Values and utilities to handle them.\n */\nimport * as Base from \"./base\";\nimport * as Exprs from \"./exprs\";\n\nexport class Visitor {\n  visitValues(values: Val[]): Val[] {\n    for (let i = 0; i < values.length; i++) {\n      values[i].visit(this);\n    }\n    return null;\n  }\n\n  visitEmpty(empty: Val): Val {\n    return null;\n  }\n\n  visitSlash(slash: Val): Val {\n    return null;\n  }\n\n  visitStr(str: Str): Val {\n    return null;\n  }\n\n  visitIdent(ident: Ident): Val {\n    return null;\n  }\n\n  visitNumeric(numeric: Numeric): Val {\n    return null;\n  }\n\n  visitNum(num: Num): Val {\n    return null;\n  }\n\n  visitInt(num: Int): Val {\n    return this.visitNum(num);\n  }\n\n  visitHexColor(color: HexColor): Val {\n    return null;\n  }\n\n  visitURL(url: URL): Val {\n    return null;\n  }\n\n  visitURange(urange: URange): Val {\n    return null;\n  }\n\n  visitSpaceList(list: SpaceList): Val {\n    this.visitValues(list.values);\n    return null;\n  }\n\n  visitCommaList(list: CommaList): Val {\n    this.visitValues(list.values);\n    return null;\n  }\n\n  visitFunc(func: Func): Val {\n    this.visitValues(func.values);\n    return null;\n  }\n\n  visitExpr(expr: Expr): Val {\n    return null;\n  }\n}\n\nexport class FilterVisitor extends Visitor {\n  error: boolean = false;\n\n  constructor() {\n    super();\n  }\n\n  override visitValues(values: Val[]): Val[] {\n    let arr: Val[] = null;\n    for (let i = 0; i < values.length; i++) {\n      const before = values[i];\n      const after = before.visit(this);\n      if (this.error) {\n        return [];\n      }\n      if (arr) {\n        arr[i] = after;\n      } else if (before !== after) {\n        arr = new Array(values.length);\n        for (let k = 0; k < i; k++) {\n          arr[k] = values[k];\n        }\n        arr[i] = after;\n      }\n    }\n    return arr || values;\n  }\n\n  override visitEmpty(empty: Val): Val {\n    return empty;\n  }\n\n  override visitStr(str: Str): Val {\n    return str;\n  }\n\n  override visitIdent(ident: Ident): Val {\n    return ident;\n  }\n\n  override visitSlash(slash: Val): Val {\n    return slash;\n  }\n\n  override visitNumeric(numeric: Numeric): Val {\n    return numeric;\n  }\n\n  override visitNum(num: Num): Val {\n    return num;\n  }\n\n  override visitInt(num: Int): Val {\n    return num;\n  }\n\n  override visitHexColor(color: HexColor): Val {\n    return color;\n  }\n\n  override visitURL(url: URL): Val {\n    return url;\n  }\n\n  override visitURange(urange: URange): Val {\n    return urange;\n  }\n\n  override visitSpaceList(list: SpaceList): Val {\n    const values = this.visitValues(list.values);\n    if (this.error) {\n      return empty;\n    }\n    if (values === list.values) {\n      return list;\n    }\n    return new SpaceList(values);\n  }\n\n  override visitCommaList(list: CommaList): Val {\n    const values = this.visitValues(list.values);\n    if (this.error) {\n      return empty;\n    }\n    if (values === list.values) {\n      return list;\n    }\n    return new CommaList(values);\n  }\n\n  override visitFunc(func: Func): Val {\n    const values = this.visitValues(func.values);\n    if (this.error) {\n      return empty;\n    }\n    if (values === func.values) {\n      return func;\n    }\n    return new Func(func.name, values);\n  }\n\n  override visitExpr(expr: Expr): Val {\n    return expr;\n  }\n}\n\nexport class Val {\n  /** @override */\n  toString(): string {\n    const buf = new Base.StringBuffer();\n    this.appendTo(buf, true);\n    return buf.toString();\n  }\n\n  stringValue(): string {\n    const buf = new Base.StringBuffer();\n    this.appendTo(buf, false);\n    return buf.toString();\n  }\n\n  toExpr(scope: Exprs.LexicalScope, ref: Exprs.Val): Exprs.Val {\n    return null;\n  }\n\n  appendTo(buf: Base.StringBuffer, toString: boolean): void {\n    buf.append(\"[error]\");\n  }\n\n  isExpr(): boolean {\n    return false;\n  }\n\n  isNumeric(): boolean {\n    return false;\n  }\n\n  isNum(): boolean {\n    return false;\n  }\n\n  isIdent(): boolean {\n    return false;\n  }\n\n  isSpaceList(): boolean {\n    return false;\n  }\n\n  visit(visitor: Visitor): Val {\n    return this;\n  }\n}\n\nexport class Empty extends Val {\n  private static empty: Empty;\n\n  public static get instance(): Empty {\n    if (!this.empty) {\n      this.empty = new Empty();\n    }\n    return this.empty;\n  }\n\n  private constructor() {\n    super();\n  }\n\n  override toExpr(scope: Exprs.LexicalScope, ref: Exprs.Val): Exprs.Val {\n    return new Exprs.Const(scope, \"\");\n  }\n\n  override appendTo(buf: Base.StringBuffer, toString: boolean): void {}\n\n  override visit(visitor: Visitor): Val {\n    return visitor.visitEmpty(this);\n  }\n}\n\nexport const empty: Empty = Empty.instance;\n\nexport class Slash extends Val {\n  private static slash: Slash;\n\n  public static get instance(): Slash {\n    if (!this.slash) {\n      this.slash = new Slash();\n    }\n    return this.slash;\n  }\n\n  private constructor() {\n    super();\n  }\n\n  override toExpr(scope: Exprs.LexicalScope, ref: Exprs.Val): Exprs.Val {\n    return new Exprs.Const(scope, \"/\");\n  }\n\n  override appendTo(buf: Base.StringBuffer, toString: boolean): void {\n    buf.append(\"/\");\n  }\n\n  override visit(visitor: Visitor): Val {\n    return visitor.visitSlash(this);\n  }\n}\n\nexport const slash: Slash = Slash.instance;\n\nexport class Str extends Val {\n  constructor(public str: string) {\n    super();\n  }\n\n  override toExpr(scope: Exprs.LexicalScope, ref: Exprs.Val): Exprs.Val {\n    return new Exprs.Const(scope, this.str);\n  }\n\n  override appendTo(buf: Base.StringBuffer, toString: boolean): void {\n    if (toString) {\n      buf.append('\"');\n      buf.append(Base.escapeCSSStr(this.str));\n      buf.append('\"');\n    } else {\n      buf.append(this.str);\n    }\n  }\n\n  override visit(visitor: Visitor): Val {\n    return visitor.visitStr(this);\n  }\n}\n\nconst nameTable: { [key: string]: Ident } = {};\n\nexport class Ident extends Val {\n  constructor(public name: string) {\n    super();\n    if (nameTable[name]) {\n      throw new Error(\"E_INVALID_CALL\");\n    }\n    nameTable[name] = this;\n  }\n\n  override toExpr(scope: Exprs.LexicalScope, ref: Exprs.Val): Exprs.Val {\n    return new Exprs.Const(scope, this.name);\n  }\n\n  override appendTo(buf: Base.StringBuffer, toString: boolean): void {\n    if (toString) {\n      buf.append(Base.escapeCSSIdent(this.name));\n    } else {\n      buf.append(this.name);\n    }\n  }\n\n  override visit(visitor: Visitor): Val {\n    return visitor.visitIdent(this);\n  }\n\n  override isIdent(): boolean {\n    return true;\n  }\n}\n\nexport function getName(name: string): Ident {\n  let r = nameTable[name];\n  if (!r) {\n    r = new Ident(name);\n  }\n  return r;\n}\n\nexport class Numeric extends Val {\n  unit: string;\n\n  constructor(\n    public num: number,\n    unit: string,\n  ) {\n    super();\n    this.unit = unit?.toLowerCase() ?? \"\"; // units are case-insensitive in CSS\n  }\n\n  override toExpr(scope: Exprs.LexicalScope, ref: Exprs.Val): Exprs.Val {\n    if (this.num == 0) {\n      return scope.zero;\n    }\n    if (ref && this.unit == \"%\") {\n      if (this.num == 100) {\n        return ref;\n      }\n      return new Exprs.Multiply(\n        scope,\n        ref,\n        new Exprs.Const(scope, this.num / 100),\n      );\n    }\n    return new Exprs.Numeric(scope, this.num, this.unit);\n  }\n\n  override appendTo(buf: Base.StringBuffer, toString: boolean): void {\n    buf.append(this.num.toString());\n    buf.append(this.unit);\n  }\n\n  override visit(visitor: Visitor): Val {\n    return visitor.visitNumeric(this);\n  }\n\n  override isNumeric(): boolean {\n    return true;\n  }\n}\n\nexport class Num extends Val {\n  constructor(public num: number) {\n    super();\n  }\n\n  override toExpr(scope: Exprs.LexicalScope, ref: Exprs.Val): Exprs.Val {\n    if (this.num == 0) {\n      return scope.zero;\n    }\n    if (this.num == 1) {\n      return scope.one;\n    }\n    return new Exprs.Const(scope, this.num);\n  }\n\n  override appendTo(buf: Base.StringBuffer, toString: boolean): void {\n    buf.append(this.num.toString());\n  }\n\n  override visit(visitor: Visitor): Val {\n    return visitor.visitNum(this);\n  }\n\n  override isNum(): boolean {\n    return true;\n  }\n}\n\nexport class Int extends Num {\n  constructor(num: number) {\n    super(num);\n  }\n\n  override visit(visitor: Visitor): Val {\n    return visitor.visitInt(this);\n  }\n}\n\nexport class HexColor extends Val {\n  constructor(public hex: string) {\n    super();\n  }\n\n  override appendTo(buf: Base.StringBuffer, toString: boolean): void {\n    buf.append(\"#\");\n    buf.append(this.hex);\n  }\n\n  override visit(visitor: Visitor): Val {\n    return visitor.visitHexColor(this);\n  }\n}\n\nexport class URL extends Val {\n  constructor(public url: string) {\n    super();\n  }\n\n  override appendTo(buf: Base.StringBuffer, toString: boolean): void {\n    buf.append('url(\"');\n    buf.append(Base.escapeCSSStr(this.url));\n    buf.append('\")');\n  }\n\n  override visit(visitor: Visitor): Val {\n    return visitor.visitURL(this);\n  }\n}\n\nexport class URange extends Val {\n  constructor(public urangeText: string) {\n    super();\n  }\n\n  override appendTo(buf: Base.StringBuffer, toString: boolean): void {\n    buf.append(this.urangeText);\n  }\n\n  override visit(visitor: Visitor): Val {\n    return visitor.visitURange(this);\n  }\n}\n\nexport function appendList(\n  buf: Base.StringBuffer,\n  values: Val[],\n  separator: string,\n  toString: boolean,\n): void {\n  const length = values.length;\n  if (length > 0) {\n    values[0]?.appendTo(buf, toString);\n    for (let i = 1; i < length; i++) {\n      buf.append(separator);\n      values[i]?.appendTo(buf, toString);\n    }\n  }\n}\n\nexport class SpaceList extends Val {\n  constructor(public values: Val[]) {\n    super();\n  }\n\n  override appendTo(buf: Base.StringBuffer, toString: boolean): void {\n    appendList(buf, this.values, \" \", toString);\n  }\n\n  override visit(visitor: Visitor): Val {\n    return visitor.visitSpaceList(this);\n  }\n\n  override isSpaceList(): boolean {\n    return true;\n  }\n}\n\nexport class CommaList extends Val {\n  constructor(public values: Val[]) {\n    super();\n  }\n\n  override appendTo(buf: Base.StringBuffer, toString: boolean): void {\n    appendList(buf, this.values, \",\", toString);\n  }\n\n  override visit(visitor: Visitor): Val {\n    return visitor.visitCommaList(this);\n  }\n}\n\nexport class Func extends Val {\n  constructor(\n    public name: string,\n    public values: Val[],\n  ) {\n    super();\n  }\n\n  override appendTo(buf: Base.StringBuffer, toString: boolean): void {\n    buf.append(Base.escapeCSSIdent(this.name));\n    buf.append(\"(\");\n    appendList(buf, this.values, \",\", toString);\n    buf.append(\")\");\n  }\n\n  override visit(visitor: Visitor): Val {\n    return visitor.visitFunc(this);\n  }\n}\n\nexport class Expr extends Val {\n  constructor(public expr: Exprs.Val) {\n    super();\n  }\n\n  override toExpr(): Exprs.Val {\n    return this.expr;\n  }\n\n  override appendTo(buf: Base.StringBuffer, toString: boolean): void {\n    if (\n      this.expr instanceof Exprs.Const ||\n      this.expr instanceof Exprs.Numeric\n    ) {\n      this.expr.appendTo(buf, 0);\n    } else {\n      buf.append(\"-epubx-expr(\");\n      this.expr.appendTo(buf, 0);\n      buf.append(\")\");\n    }\n  }\n\n  override visit(visitor: Visitor): Val {\n    return visitor.visitExpr(this);\n  }\n\n  override isExpr(): boolean {\n    return true;\n  }\n}\n\n/**\n * Custom property value, may be arbitrary token\n */\nexport class AnyToken extends Val {\n  constructor(public text: string) {\n    super();\n  }\n\n  override appendTo(buf: Base.StringBuffer, toString: boolean): void {\n    buf.append(this.text || \" \");\n  }\n}\n\nexport function toNumber(val: Val, context: Exprs.Context): number {\n  if (val) {\n    if (val.isNumeric()) {\n      const numeric = val as Numeric;\n      return context.queryUnitSize(numeric.unit, false) * numeric.num;\n    }\n    if (val.isNum()) {\n      return (val as Num).num;\n    }\n  }\n  return 0;\n}\n\n/**\n * Convert numeric value to px\n */\nexport function convertNumericToPx(val: Val, context: Exprs.Context): Numeric {\n  return new Numeric(toNumber(val, context), \"px\");\n}\n\nexport const ident: { [key: string]: Ident } = {\n  absolute: getName(\"absolute\"),\n  all: getName(\"all\"),\n  always: getName(\"always\"),\n  anywhere: getName(\"anywhere\"),\n  auto: getName(\"auto\"),\n  avoid: getName(\"avoid\"),\n  balance: getName(\"balance\"),\n  balance_all: getName(\"balance-all\"),\n  block: getName(\"block\"),\n  block_end: getName(\"block-end\"),\n  block_start: getName(\"block-start\"),\n  both: getName(\"both\"),\n  bottom: getName(\"bottom\"),\n  border_box: getName(\"border-box\"),\n  break_all: getName(\"break-all\"),\n  break_word: getName(\"break-word\"),\n  clip: getName(\"clip\"),\n  crop: getName(\"crop\"),\n  cross: getName(\"cross\"),\n  column: getName(\"column\"),\n  discard: getName(\"discard\"),\n  exclusive: getName(\"exclusive\"),\n  _false: getName(\"false\"),\n  fixed: getName(\"fixed\"),\n  flex: getName(\"flex\"),\n  flow_root: getName(\"flow-root\"),\n  footnote: getName(\"footnote\"),\n  footer: getName(\"footer\"),\n  grid: getName(\"grid\"),\n  header: getName(\"header\"),\n  hidden: getName(\"hidden\"),\n  horizontal_tb: getName(\"horizontal-tb\"),\n  inherit: getName(\"inherit\"),\n  initial: getName(\"initial\"),\n  inline: getName(\"inline\"),\n  inline_block: getName(\"inline-block\"),\n  inline_end: getName(\"inline-end\"),\n  inline_start: getName(\"inline-start\"),\n  inside: getName(\"inside\"),\n  keep: getName(\"keep\"),\n  landscape: getName(\"landscape\"),\n  left: getName(\"left\"),\n  line: getName(\"line\"),\n  list_item: getName(\"list-item\"),\n  ltr: getName(\"ltr\"),\n  manual: getName(\"manual\"),\n  max_content: getName(\"max-content\"),\n  min_content: getName(\"min-content\"),\n  none: getName(\"none\"),\n  normal: getName(\"normal\"),\n  oeb_page_foot: getName(\"oeb-page-foot\"),\n  oeb_page_head: getName(\"oeb-page-head\"),\n  outside: getName(\"outside\"),\n  padding_box: getName(\"padding-box\"),\n  page: getName(\"page\"),\n  relative: getName(\"relative\"),\n  revert: getName(\"revert\"),\n  right: getName(\"right\"),\n  same: getName(\"same\"),\n  scale: getName(\"scale\"),\n  snap_block: getName(\"snap-block\"),\n  snap_inline: getName(\"snap-inline\"),\n  solid: getName(\"solid\"),\n  spread: getName(\"spread\"),\n  _static: getName(\"static\"),\n  rtl: getName(\"rtl\"),\n  table: getName(\"table\"),\n  table_caption: getName(\"table-caption\"),\n  table_cell: getName(\"table-cell\"),\n  table_footer_group: getName(\"table-footer-group\"),\n  table_header_group: getName(\"table-header-group\"),\n  table_row: getName(\"table-row\"),\n  top: getName(\"top\"),\n  transparent: getName(\"transparent\"),\n  unset: getName(\"unset\"),\n  vertical_lr: getName(\"vertical-lr\"),\n  vertical_rl: getName(\"vertical-rl\"),\n  visible: getName(\"visible\"),\n  _true: getName(\"true\"),\n};\n\nexport const hundredPercent: Numeric = new Numeric(100, \"%\");\n\nexport const fullWidth: Numeric = new Numeric(100, \"pvw\");\n\nexport const fullHeight: Numeric = new Numeric(100, \"pvh\");\n\nexport const numericZero: Numeric = new Numeric(0, \"px\");\n\nexport const fullURange: URange = new URange(\"U+0-10FFFF\");\n\nexport const processingOrder = {\n  \"font-size\": 1,\n  \"line-height\": 2,\n  color: 3,\n};\n\nexport function isDefaultingValue(value: Val): boolean {\n  return (\n    value === ident.inherit ||\n    value === ident.initial ||\n    value === ident.revert ||\n    value === ident.unset\n  );\n}\n\n/**\n * Function to sort property names in the order they should be processed\n */\nexport function processingOrderFn(name1: string, name2: string): number {\n  const n1 = processingOrder[name1] || Number.MAX_VALUE;\n  const n2 = processingOrder[name2] || Number.MAX_VALUE;\n  return n1 - n2;\n}\n\nexport function isCustomPropName(name: string): boolean {\n  return name?.length > 2 && name.startsWith(\"--\");\n}\n", "/**\n * Copyright 2013 Google, Inc.\n * Copyright 2016 Daishinsha Inc.\n * Copyright 2019 Vivliostyle Foundation\n *\n * Vivliostyle.js is free software: you can redistribute it and/or modify\n * it under the terms of the GNU Affero General Public License as published by\n * the Free Software Foundation, either version 3 of the License, or\n * (at your option) any later version.\n *\n * Vivliostyle.js is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n * GNU Affero General Public License for more details.\n *\n * You should have received a copy of the GNU Affero General Public License\n * along with Vivliostyle.js.  If not, see <http://www.gnu.org/licenses/>.\n *\n * @fileoverview GeometryUtil - Geometric utilities.\n */\nimport * as Logging from \"./logging\";\n\nexport class Rect {\n  constructor(\n    public x1: number,\n    public y1: number,\n    public x2: number,\n    public y2: number,\n  ) {}\n}\n\nexport class Point {\n  constructor(\n    public x: number,\n    public y: number,\n  ) {}\n}\n\nexport class Insets {\n  constructor(\n    public left: number,\n    public top: number,\n    public right: number,\n    public bottom: number,\n  ) {}\n}\n\nexport class Segment {\n  constructor(\n    public low: Point,\n    public high: Point,\n    public winding: number,\n    public shapeId: number,\n  ) {}\n}\n\n/**\n * A single band for exclusion result. Left float is from the left box edge\n * to x1. Right float is from x2 to the right box edge.\n */\nexport class Band {\n  /** Left float. */\n  left: Element | null = null;\n\n  /** Right float. */\n  right: Element | null = null;\n\n  constructor(\n    public y1: number,\n    public y2: number,\n    public x1: number,\n    public x2: number,\n  ) {}\n}\n\nexport function segmentCompare(s1: Segment, s2: Segment): number {\n  return s1.low.y - s2.low.y || s1.low.x - s2.low.x;\n}\n\nexport class Shape {\n  constructor(public points: Point[]) {}\n\n  /**\n   * Converts this shape to a sequence of Segments and adds segments to the\n   * given array.\n   * @param arr array to add segments.\n   * @param id shapeId to write into segments.\n   */\n  addSegments(arr: Segment[], id: number): void {\n    const points = this.points;\n    const length = points.length;\n    let prev = points[length - 1];\n    for (let i = 0; i < length; i++) {\n      const curr = points[i];\n      let s: Segment;\n      if (prev.y < curr.y) {\n        s = new Segment(prev, curr, 1, id);\n      } else {\n        s = new Segment(curr, prev, -1, id);\n      }\n      arr.push(s);\n      prev = curr;\n    }\n  }\n\n  withOffset(offsetX: number, offsetY: number): Shape {\n    const points = [];\n    for (const p of this.points) {\n      points.push(new Point(p.x + offsetX, p.y + offsetY));\n    }\n    return new Shape(points);\n  }\n}\n\nexport function shapeForEllipse(\n  cx: number,\n  cy: number,\n  rx: number,\n  ry: number,\n): Shape {\n  const count = 20;\n  const points: Point[] = [];\n  for (let i = 0; i < count; i++) {\n    const a = (i * 2 * Math.PI) / count;\n    points.push(new Point(cx + rx * Math.sin(a), cy + ry * Math.cos(a)));\n  }\n  return new Shape(points);\n}\n\nexport function shapeForRect(\n  x1: number,\n  y1: number,\n  x2: number,\n  y2: number,\n): Shape {\n  return new Shape([\n    new Point(x1, y1),\n    new Point(x2, y1),\n    new Point(x2, y2),\n    new Point(x1, y2),\n  ]);\n}\n\nexport function shapeForRectObj(r: Rect): Shape {\n  return new Shape([\n    new Point(r.x1, r.y1),\n    new Point(r.x2, r.y1),\n    new Point(r.x2, r.y2),\n    new Point(r.x1, r.y2),\n  ]);\n}\n\nexport class BandIntersection {\n  constructor(\n    public x: number,\n    public winding: number,\n    public shapeId: number,\n    public lowOrHigh: number,\n  ) {}\n}\n\nexport function intersectY(s: Segment, y: number): number {\n  const x =\n    s.low.x + ((s.high.x - s.low.x) * (y - s.low.y)) / (s.high.y - s.low.y);\n  if (isNaN(x)) {\n    throw new Error(\"Bad intersection\");\n  }\n  return x;\n}\n\nexport function addBandIntersections(\n  intersections: BandIntersection[],\n  s: Segment,\n  y1: number,\n  y2: number,\n): void {\n  let x1: number;\n  let w1: number;\n  let x2: number;\n  let w2: number;\n  if (s.high.y < y1) {\n    Logging.logger.warn(\"Error: inconsistent segment (1)\");\n  }\n  if (s.low.y <= y1) {\n    // outside\n    x1 = intersectY(s, y1);\n    w1 = s.winding;\n  } else {\n    x1 = s.low.x;\n    w1 = 0;\n  }\n  if (s.high.y >= y2) {\n    // outside\n    x2 = intersectY(s, y2);\n    w2 = s.winding;\n  } else {\n    x2 = s.high.x;\n    w2 = 0;\n  }\n  if (x1 < x2) {\n    intersections.push(new BandIntersection(x1, w1, s.shapeId, -1));\n    intersections.push(new BandIntersection(x2, w2, s.shapeId, 1));\n  } else {\n    intersections.push(new BandIntersection(x2, w2, s.shapeId, -1));\n    intersections.push(new BandIntersection(x1, w1, s.shapeId, 1));\n  }\n}\n\nexport function mergeIntersections(\n  intersections: BandIntersection[],\n  includeCount: number,\n  excludeCount: number,\n): number[] {\n  const shapeCount = includeCount + excludeCount;\n  const windings1: number[] = Array(shapeCount);\n  const windings2: number[] = Array(shapeCount);\n  let i: number;\n  for (i = 0; i <= shapeCount; i++) {\n    windings1[i] = 0;\n    windings2[i] = 0;\n  }\n  const xranges: number[] = [];\n  let inside: boolean = false;\n  const intersectionCount = intersections.length;\n  for (let k = 0; k < intersectionCount; k++) {\n    const intersection = intersections[k];\n    windings1[intersection.shapeId] += intersection.winding;\n    windings2[intersection.shapeId] += intersection.lowOrHigh;\n    let stillInside = false;\n    for (i = 0; i < includeCount; i++) {\n      if (windings1[i] && !windings2[i]) {\n        stillInside = true;\n        break;\n      }\n    }\n    if (stillInside) {\n      for (i = includeCount; i <= shapeCount; i++) {\n        if (windings1[i] || windings2[i]) {\n          stillInside = false;\n          break;\n        }\n      }\n    }\n    if (inside != stillInside) {\n      xranges.push(intersection.x);\n      inside = stillInside;\n    }\n  }\n  return xranges;\n}\n\n/**\n * Round v up to make it a multiple of unit. If unit is zero, return v.\n */\nexport function ceil(v: number, unit: number): number {\n  return unit ? Math.ceil(v / unit) * unit : v;\n}\n\n/**\n * Round v down to make it a multiple of unit. If unit is zero, return v.\n */\nexport function floor(v: number, unit: number): number {\n  return unit ? Math.floor(v / unit) * unit : v;\n}\n\nexport function rotatePoint(point: Point): Point {\n  return new Point(point.y, -point.x);\n}\n\n/**\n * Vertical box to pseudo-horizontal coords.\n */\nexport function rotateBox(box: Rect): Rect {\n  return new Rect(box.y1, -box.x2, box.y2, -box.x1);\n}\n\n/**\n * Pseudo-horizontal coords to vertical.\n */\nexport function unrotateBox(box: Rect): Rect {\n  return new Rect(-box.y2, box.x1, -box.y1, box.x2);\n}\n\nexport function rotateShape(shape: Shape): Shape {\n  return new Shape(shape.points.map((point) => rotatePoint(point)));\n}\n\nexport function shapesToBands(\n  box: Rect,\n  include: Shape[],\n  exclude: Shape[],\n  granularity: number,\n  snapHeight: number,\n  vertical: boolean,\n): Band[] {\n  if (vertical) {\n    box = rotateBox(box);\n    include = include.map((shape) => rotateShape(shape));\n    exclude = exclude.map((shape) => rotateShape(shape));\n  }\n  const includeCount = include.length;\n  const excludeCount = exclude ? exclude.length : 0;\n  const result: Band[] = [];\n  const segments: Segment[] = [];\n  let i: number;\n  let k: number;\n  let segment: Segment;\n  for (i = 0; i < includeCount; i++) {\n    include[i].addSegments(segments, i);\n  }\n  for (i = 0; i < excludeCount; i++) {\n    exclude[i].addSegments(segments, i + includeCount);\n  }\n  const segmentCount = segments.length;\n  segments.sort(segmentCompare);\n  let lowestIncludeIndex = 0;\n  while (segments[lowestIncludeIndex].shapeId >= includeCount) {\n    lowestIncludeIndex++;\n  }\n  let y = segments[lowestIncludeIndex].low.y;\n  if (y > box.y1) {\n    result.push(new Band(box.y1, y, box.x2, box.x2));\n  }\n  let segmentIndex = 0;\n  const activeSegments: Segment[] = [];\n  while (\n    segmentIndex < segmentCount &&\n    (segment = segments[segmentIndex]).low.y < y\n  ) {\n    if (segment.high.y > y) {\n      activeSegments.push(segment);\n    }\n    segmentIndex++;\n  }\n\n  // process the segments from low to high y values\n  while (segmentIndex < segmentCount || activeSegments.length > 0) {\n    // calculate the height of the band to work with\n    let y2 = box.y2; // band bottom\n    // min possible y2\n    const y2min = Math.min(\n      ceil(Math.ceil(y + granularity), snapHeight),\n      box.y2,\n    );\n    for (k = 0; k < activeSegments.length && y2 > y2min; k++) {\n      segment = activeSegments[k];\n      if (segment.low.x == segment.high.x) {\n        // vertical\n        if (segment.high.y < y2) {\n          y2 = Math.max(floor(segment.high.y, snapHeight), y2min);\n        }\n      } else if (segment.low.x != segment.high.x) {\n        // TODO: should we compare y???\n        // slanted (not horizontal)\n        y2 = y2min;\n      }\n    }\n    if (y2 > box.y2) {\n      y2 = box.y2;\n    }\n\n    // include new segments, decreasing y2 if needed\n    while (\n      segmentIndex < segmentCount &&\n      (segment = segments[segmentIndex]).low.y < y2\n    ) {\n      if (segment.high.y < y) {\n        segmentIndex++;\n        continue;\n      }\n      if (segment.low.y < y2min) {\n        if (segment.low.y == segment.high.y && segment.low.y == y) {\n          // Horizontal segment that goes right at y is not active,\n          // but consume it anyway\n        } else {\n          activeSegments.push(segment);\n          y2 = y2min;\n        }\n        segmentIndex++;\n      } else {\n        // Do not consume it, consider bottom edge \"outside\"\n        const yn = floor(segment.low.y, snapHeight);\n        if (yn < y2) {\n          y2 = yn;\n        }\n        break;\n      }\n    }\n\n    // now look at the band with top at y and bottom at y2\n    // activeSegments should list all segments that intersect that band\n\n    // find all intersections with the band\n    const bandIntersections: BandIntersection[] = [];\n    for (k = 0; k < activeSegments.length; k++) {\n      addBandIntersections(bandIntersections, activeSegments[k], y, y2);\n    }\n    bandIntersections.sort(\n      (bi1, bi2) => bi1.x - bi2.x || bi1.lowOrHigh - bi2.lowOrHigh,\n    );\n    const xranges = mergeIntersections(\n      bandIntersections,\n      includeCount,\n      excludeCount,\n    );\n    if (xranges.length == 0) {\n      result.push(new Band(y, y2, box.x2, box.x2));\n    } else {\n      // get the widest\n      let width = 0;\n      let x = box.x1;\n      for (k = 0; k < xranges.length; k += 2) {\n        const rx = Math.max(box.x1, xranges[k]);\n        const rw = Math.min(box.x2, xranges[k + 1]) - rx;\n        if (rw > width) {\n          width = rw;\n          x = rx;\n        }\n      }\n      if (width == 0) {\n        // no space left\n        result.push(new Band(y, y2, box.x2, box.x2));\n      } else {\n        result.push(\n          new Band(y, y2, Math.max(x, box.x1), Math.min(x + width, box.x2)),\n        );\n      }\n    }\n    if (y2 == box.y2) {\n      break;\n    }\n    y = y2;\n    for (k = activeSegments.length - 1; k >= 0; k--) {\n      if (activeSegments[k].high.y <= y2) {\n        activeSegments.splice(k, 1);\n      }\n    }\n  }\n  normalize(box, result);\n  return result;\n}\n\nexport function normalize(box: Rect, bands: Band[]): void {\n  let k = bands.length - 1;\n\n  // Merge bands with the same x1, x2 and remove unneeded bands at the end.\n  // Create fictious last band to merge unneeded bands at the end\n  let currBand = new Band(box.y2, box.y2, box.x1, box.x2);\n  while (k >= 0) {\n    const prevBand = currBand; // result[k+1]\n    currBand = bands[k];\n    if (\n      currBand.y2 - currBand.y1 < 1 || // Remove bands with height less than 1px\n      (currBand.x1 == prevBand.x1 && currBand.x2 == prevBand.x2)\n    ) {\n      prevBand.y1 = currBand.y1; // merge\n      bands.splice(k, 1);\n      currBand = prevBand;\n    }\n    k--;\n  }\n}\n\n/**\n * Find the index of the bottommost band so that y < band.y2\n */\nexport function findBand(bands: Band[], y: number): number {\n  let low = 0;\n  let high = bands.length;\n  while (low < high) {\n    const mid = Math.floor((low + high) / 2);\n    if (y >= bands[mid].y2) {\n      low = mid + 1;\n    } else {\n      high = mid;\n    }\n  }\n  return low;\n}\n\n/**\n * Find the uppermost rectangle contained in the specified rect which occupies\n * full width of the rect without overlapping with any band in the specified\n * bands.\n * @returns Returns null if such rectangle does not exist.\n */\nexport function findUppermostFullyOpenRect(\n  bands: Band[],\n  rect: Rect,\n): Rect | null {\n  if (!bands.length) {\n    return rect;\n  }\n  let topEdge = rect.y1;\n  let band: Band;\n  let i: number;\n  for (i = 0; i < bands.length; i++) {\n    band = bands[i];\n    if (\n      band.y2 > rect.y1 &&\n      band.x1 - 0.1 <= rect.x1 &&\n      band.x2 + 0.1 >= rect.x2\n    ) {\n      break;\n    } else {\n      topEdge = Math.max(topEdge, band.y2);\n    }\n  }\n  let bottomEdge = topEdge;\n  for (; i < bands.length; i++) {\n    band = bands[i];\n    if (\n      band.y1 >= rect.y2 ||\n      band.x1 - 0.1 > rect.x1 ||\n      band.x2 + 0.1 < rect.x2\n    ) {\n      break;\n    } else {\n      bottomEdge = band.y2;\n    }\n  }\n  if (i === bands.length) {\n    bottomEdge = rect.y2;\n  } else {\n    bottomEdge = Math.min(bottomEdge, rect.y2);\n  }\n  if (bottomEdge <= topEdge) {\n    return null;\n  } else {\n    return new Rect(rect.x1, topEdge, rect.x2, bottomEdge);\n  }\n}\n\n/**\n * Find the bottommost rectangle contained in the specified rect which occupies\n * full width of the rect without overlapping with any band in the specified\n * bands.\n * @returns Returns null if such rectangle does not exist.\n */\nexport function findBottommostFullyOpenRect(\n  bands: Band[],\n  rect: Rect,\n): Rect | null {\n  if (!bands.length) {\n    return rect;\n  }\n  let bottomEdge = rect.y2;\n  let band: Band;\n  let i: number;\n  for (i = bands.length - 1; i >= 0; i--) {\n    band = bands[i];\n    if (i === bands.length - 1 && band.y2 < rect.y2) {\n      break;\n    } else if (\n      band.y1 < rect.y2 &&\n      band.x1 - 0.1 <= rect.x1 &&\n      band.x2 + 0.1 >= rect.x2\n    ) {\n      break;\n    } else {\n      bottomEdge = Math.min(bottomEdge, band.y1);\n    }\n  }\n  let topEdge = Math.min(bottomEdge, band.y2);\n  for (; i >= 0; i--) {\n    band = bands[i];\n    if (\n      band.y2 <= rect.y1 ||\n      band.x1 - 0.1 > rect.x1 ||\n      band.x2 + 0.1 < rect.x2\n    ) {\n      break;\n    } else {\n      topEdge = band.y1;\n    }\n  }\n  topEdge = Math.max(topEdge, rect.y1);\n  if (bottomEdge <= topEdge) {\n    return null;\n  } else {\n    return new Rect(rect.x1, topEdge, rect.x2, bottomEdge);\n  }\n}\n\n/**\n * @param side either \"left\" or \"right\"\n */\nexport function positionFloat(\n  box: Rect,\n  bands: Band[],\n  floatBox: Rect,\n  side: string,\n): boolean {\n  let y = floatBox.y1;\n  const floatWidth = floatBox.x2 - floatBox.x1;\n  const floatHeight = floatBox.y2 - floatBox.y1;\n  let index = findBand(bands, y);\n  while (true) {\n    // Check if it fits\n    const floatBottom = y + floatHeight;\n    if (floatBottom > box.y2) {\n      return false;\n    }\n\n    // does not fit vertically\n    let x1 = box.x1;\n    let x2 = box.x2;\n    for (let i = index; i < bands.length && bands[i].y1 < floatBottom; i++) {\n      const band = bands[i];\n      if (band.x1 > x1) {\n        x1 = band.x1;\n      }\n      if (band.x2 < x2) {\n        x2 = band.x2;\n      }\n    }\n    if (x1 + floatWidth <= x2 || index >= bands.length) {\n      if (side == \"left\") {\n        floatBox.x1 = x1;\n        floatBox.x2 = x1 + floatWidth;\n      } else {\n        floatBox.x1 = x2 - floatWidth;\n        floatBox.x2 = x2;\n      }\n      floatBox.y2 += y - floatBox.y1;\n      floatBox.y1 = y;\n      return true;\n    }\n    y = bands[index].y2;\n    index++;\n  }\n}\n\nexport function addFloatToBands(\n  box: Rect,\n  bands: Band[],\n  floatBox: Rect,\n  floatBands: Band[],\n  side: string,\n): void {\n  if (!floatBands) {\n    floatBands = [new Band(floatBox.y1, floatBox.y2, floatBox.x1, floatBox.x2)];\n  }\n  while (floatBands.length > 0 && floatBands[0].y2 <= box.y1) {\n    floatBands.shift();\n  }\n  if (floatBands.length == 0) {\n    return;\n  }\n  if (floatBands[0].y1 < box.y1) {\n    floatBands[0].y1 = box.y1;\n  }\n  let band: Band;\n  const lastY = bands.length == 0 ? box.y1 : bands[bands.length - 1].y2;\n  if (lastY < box.y2) {\n    // add the tail band that we typically don't keep, it will be cleared by\n    // normalize()\n    bands.push(new Band(lastY, box.y2, box.x1, box.x2));\n  }\n  let index = findBand(bands, floatBands[0].y1);\n  for (const floatBand of floatBands) {\n    if (index == bands.length) {\n      break;\n    }\n    if (bands[index].y1 < floatBand.y1) {\n      // split it\n      band = bands[index];\n      index++;\n      bands.splice(index, 0, new Band(floatBand.y1, band.y2, band.x1, band.x2));\n      band.y2 = floatBand.y1;\n    }\n    while (index < bands.length) {\n      band = bands[index++];\n      if (band.y2 > floatBand.y2) {\n        // split it\n        bands.splice(\n          index,\n          0,\n          new Band(floatBand.y2, band.y2, band.x1, band.x2),\n        );\n        band.y2 = floatBand.y2;\n      }\n      if (floatBand.x1 != floatBand.x2) {\n        // non-empty floatBand\n        if (side == \"left\") {\n          band.x1 = Math.min(floatBand.x2, box.x2);\n        } else {\n          band.x2 = Math.max(floatBand.x1, box.x1);\n        }\n      }\n      if (band.y2 == floatBand.y2) {\n        break;\n      }\n    }\n  }\n  normalize(box, bands);\n}\n", "/**\n * Copyright 2013 Google, Inc.\n * Copyright 2015 Daishinsha Inc.\n * Copyright 2019 Vivliostyle Foundation\n *\n * Vivliostyle.js is free software: you can redistribute it and/or modify\n * it under the terms of the GNU Affero General Public License as published by\n * the Free Software Foundation, either version 3 of the License, or\n * (at your option) any later version.\n *\n * Vivliostyle.js is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n * GNU Affero General Public License for more details.\n *\n * You should have received a copy of the GNU Affero General Public License\n * along with Vivliostyle.js.  If not, see <http://www.gnu.org/licenses/>.\n *\n * @fileoverview CssProp - Support utilities to extract information\n * from various (parsed) CSS values.\n */\nimport * as Base from \"./base\";\nimport * as Css from \"./css\";\nimport * as Exprs from \"./exprs\";\nimport * as GeometryUtil from \"./geometry-util\";\nimport * as Logging from \"./logging\";\n\n//---------------------- value parsers ----------------------------------\nexport class SetVisitor extends Css.Visitor {\n  propSet: { [key: string]: boolean } = {};\n\n  constructor() {\n    super();\n  }\n\n  override visitIdent(ident: Css.Ident): Css.Val {\n    this.propSet[ident.name] = true;\n    return ident;\n  }\n\n  override visitSpaceList(list: Css.SpaceList): Css.Val {\n    this.visitValues(list.values);\n    return list;\n  }\n}\n\nexport function toSet(val: Css.Val): { [key: string]: boolean } {\n  if (val) {\n    const visitor = new SetVisitor();\n    try {\n      val.visit(visitor);\n      return visitor.propSet;\n    } catch (err) {\n      Logging.logger.warn(err, \"toSet:\");\n    }\n  }\n  return {};\n}\n\nexport class IntVisitor extends Css.Visitor {\n  constructor(public value: number) {\n    super();\n  }\n\n  override visitInt(num: Css.Int): Css.Val {\n    this.value = num.num;\n    return num;\n  }\n}\n\nexport function toInt(val: Css.Val, def: number): number {\n  if (val) {\n    const visitor = new IntVisitor(def);\n    try {\n      val.visit(visitor);\n      return visitor.value;\n    } catch (err) {\n      Logging.logger.warn(err, \"toInt: \");\n    }\n  }\n  return def;\n}\n\nexport class ShapeVisitor extends Css.Visitor {\n  collect: boolean = false;\n  coords: Css.Numeric[] = [];\n  name: string | null = null;\n\n  constructor() {\n    super();\n  }\n\n  override visitNumeric(numeric: Css.Numeric): Css.Val {\n    if (this.collect) {\n      this.coords.push(numeric);\n    }\n    return null;\n  }\n\n  override visitNum(num: Css.Num): Css.Val {\n    if (this.collect && num.num == 0) {\n      this.coords.push(new Css.Numeric(0, \"px\"));\n    }\n    return null;\n  }\n\n  override visitSpaceList(list: Css.SpaceList): Css.Val {\n    this.visitValues(list.values);\n    return null;\n  }\n\n  override visitFunc(func: Css.Func): Css.Val {\n    if (!this.collect) {\n      this.collect = true;\n      this.visitValues(func.values);\n      this.collect = false;\n      this.name = func.name.toLowerCase();\n    }\n    return null;\n  }\n\n  getShape(\n    x: number,\n    y: number,\n    width: number,\n    height: number,\n    context: Exprs.Context,\n  ): GeometryUtil.Shape {\n    if (this.coords.length > 0) {\n      const numbers: number[] = [];\n      this.coords.forEach((coord, i) => {\n        if (coord.unit == \"%\") {\n          let ref = i % 2 == 0 ? width : height;\n          if (i == 3 && this.name == \"circle\") {\n            ref = Math.sqrt((width * width + height * height) / 2);\n          }\n          numbers.push((coord.num * ref) / 100);\n        } else {\n          numbers.push(coord.num * context.queryUnitSize(coord.unit, false));\n        }\n      });\n      switch (this.name) {\n        case \"polygon\":\n          if (numbers.length % 2 == 0) {\n            const points: GeometryUtil.Point[] = [];\n            for (let k = 0; k < numbers.length; k += 2) {\n              points.push(\n                new GeometryUtil.Point(x + numbers[k], y + numbers[k + 1]),\n              );\n            }\n            return new GeometryUtil.Shape(points);\n          }\n          break;\n        case \"rectangle\":\n          if (numbers.length == 4) {\n            return GeometryUtil.shapeForRect(\n              x + numbers[0],\n              y + numbers[1],\n              x + numbers[0] + numbers[2],\n              y + numbers[1] + numbers[3],\n            );\n          }\n          break;\n        case \"ellipse\":\n          if (numbers.length == 4) {\n            return GeometryUtil.shapeForEllipse(\n              x + numbers[0],\n              y + numbers[1],\n              numbers[2],\n              numbers[3],\n            );\n          }\n          break;\n        case \"circle\":\n          if (numbers.length == 3) {\n            return GeometryUtil.shapeForEllipse(\n              x + numbers[0],\n              y + numbers[1],\n              numbers[2],\n              numbers[2],\n            );\n          }\n          break;\n      }\n    }\n    return null;\n  }\n}\n\nexport function toShape(\n  val: Css.Val,\n  x: number,\n  y: number,\n  width: number,\n  height: number,\n  context: Exprs.Context,\n): GeometryUtil.Shape {\n  if (val) {\n    const visitor = new ShapeVisitor();\n    try {\n      val.visit(visitor);\n      return visitor.getShape(x, y, width, height, context);\n    } catch (err) {\n      Logging.logger.warn(err, \"toShape:\");\n    }\n  }\n  return GeometryUtil.shapeForRect(x, y, x + width, y + height);\n}\n\nexport class CountersVisitor extends Css.Visitor {\n  counters: { [key: string]: number } = {};\n  name: string | null = null;\n\n  constructor(public readonly reset: boolean) {\n    super();\n  }\n\n  override visitIdent(ident: Css.Ident): Css.Val {\n    this.name = ident.toString();\n    if (this.reset) {\n      this.counters[this.name] = 0;\n    } else {\n      this.counters[this.name] = (this.counters[this.name] || 0) + 1;\n    }\n    return ident;\n  }\n\n  override visitInt(num: Css.Int): Css.Val {\n    if (this.name) {\n      this.counters[this.name] += num.num - (this.reset ? 0 : 1);\n    }\n    return num;\n  }\n\n  override visitSpaceList(list: Css.SpaceList): Css.Val {\n    this.visitValues(list.values);\n    return list;\n  }\n}\n\nexport function toCounters(\n  val: Css.Val,\n  reset: boolean,\n): { [key: string]: number } {\n  const visitor = new CountersVisitor(reset);\n  try {\n    val.visit(visitor);\n  } catch (err) {\n    Logging.logger.warn(err, \"toCounters:\");\n  }\n  return visitor.counters;\n}\n\nexport class UrlTransformVisitor extends Css.FilterVisitor {\n  constructor(\n    public baseUrl: string,\n    public transformer: Base.DocumentURLTransformer,\n  ) {\n    super();\n  }\n\n  override visitURL(url: Css.URL): Css.Val {\n    return new Css.URL(this.transformer.transformURL(url.url, this.baseUrl));\n  }\n}\n", "/**\n * Copyright 2016 Daishinsha Inc.\n * Copyright 2019 Vivliostyle Foundation\n *\n * Vivliostyle.js is free software: you can redistribute it and/or modify\n * it under the terms of the GNU Affero General Public License as published by\n * the Free Software Foundation, either version 3 of the License, or\n * (at your option) any later version.\n *\n * Vivliostyle.js is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n * GNU Affero General Public License for more details.\n *\n * You should have received a copy of the GNU Affero General Public License\n * along with Vivliostyle.js.  If not, see <http://www.gnu.org/licenses/>.\n *\n * @fileoverview Counters, named strings, and running elements\n */\nimport * as Asserts from \"./asserts\";\nimport * as Base from \"./base\";\nimport * as CssCascade from \"./css-cascade\";\nimport * as CssProp from \"./css-prop\";\nimport * as CssStyler from \"./css-styler\";\nimport * as Exprs from \"./exprs\";\nimport * as Vgen from \"./vgen\";\nimport * as Vtree from \"./vtree\";\nimport { Layout } from \"./types\";\n\n/**\n * Clone counter values.\n */\nfunction cloneCounterValues(\n  counters: CssCascade.CounterValues,\n): CssCascade.CounterValues {\n  const result = {};\n  Object.keys(counters).forEach((name) => {\n    result[name] = Array.from(counters[name]);\n  });\n  return result;\n}\n\n/**\n * Extract text content from an element for a specific pseudo-element.\n * @param element The DOM element to extract text from\n * @param pseudoElement The pseudo-element type: \"content\", \"before\", \"after\" or \"marker\"\n * @returns The extracted text, or empty string if not found\n */\nfunction extractPseudoElementText(\n  element: Element,\n  pseudoElement: \"content\" | \"before\" | \"after\" | \"marker\",\n): string {\n  if (pseudoElement === \"content\") {\n    // Get main content (excluding ::before and ::after)\n    const clone = element.cloneNode(true) as Element;\n    const pseudos = clone.querySelectorAll(\"[data-adapt-pseudo]\");\n    pseudos.forEach((pseudo) => pseudo.remove());\n    return clone.textContent || \"\";\n  } else {\n    // Extract ::before or ::after content\n    const pseudoElem = element.querySelector(\n      `[data-adapt-pseudo=\"${pseudoElement}\"]`,\n    );\n    return pseudoElem ? pseudoElem.textContent || \"\" : \"\";\n  }\n}\n\n/**\n * Class representing a reference by target-counter(s).\n * @param targetId ID of the referenced element (transformed by\n *     DocumentURLTransformer to handle a reference across multiple source\n *     documents)\n * @param resolved If the reference is already resolved or not\n */\nexport class TargetCounterReference {\n  pageCounters: CssCascade.CounterValues = null;\n  spineIndex: number = -1;\n  pageIndex: number = -1;\n\n  constructor(\n    public readonly targetId: string,\n    public resolved: boolean,\n  ) {}\n\n  equals(other: TargetCounterReference): boolean {\n    if (this === other) {\n      return true;\n    }\n    if (!other) {\n      return false;\n    }\n    return (\n      this.targetId === other.targetId &&\n      this.resolved === other.resolved &&\n      this.spineIndex === other.spineIndex &&\n      this.pageIndex === other.pageIndex\n    );\n  }\n\n  /**\n   * Returns if the reference is resolved or not.\n   */\n  isResolved(): boolean {\n    return this.resolved;\n  }\n\n  /**\n   * Marks that this reference is resolved.\n   */\n  resolve() {\n    this.resolved = true;\n  }\n\n  /**\n   * Marks that this reference is unresolved.\n   */\n  unresolve() {\n    this.resolved = false;\n  }\n}\n\nclass CounterListener implements CssCascade.CounterListener {\n  constructor(\n    public readonly counterStore: CounterStore,\n    public readonly baseURL: string,\n  ) {}\n\n  /** @override */\n  countersOfId(id: string, counters: CssCascade.CounterValues) {\n    id = this.counterStore.documentURLTransformer.transformFragment(\n      id,\n      this.baseURL,\n    );\n    this.counterStore.countersById[id] = counters;\n  }\n\n  getExprContentListener(): Vtree.ExprContentListener {\n    return this.counterStore.getExprContentListener();\n  }\n}\n\n/**\n * Map for named string name, element offset, and the string value\n */\ntype NamedRunningValues = {\n  [name: string]: { [elementOffset: number]: string };\n};\n\nclass CounterResolver implements CssCascade.CounterResolver {\n  styler: CssStyler.Styler | null = null;\n  namedStringValues: NamedRunningValues = {};\n  runningElements: NamedRunningValues = {};\n\n  constructor(\n    public readonly counterStore: CounterStore,\n    public readonly baseURL: string,\n    public readonly rootScope: Exprs.LexicalScope,\n    public readonly pageScope: Exprs.LexicalScope,\n  ) {}\n\n  setStyler(styler: CssStyler.Styler): void {\n    this.styler = styler;\n  }\n\n  private getFragment(url: string): string | null {\n    const r = url.match(/^[^#]*#(.*)$/);\n    return r ? r[1] : null;\n  }\n\n  private getTransformedId(url: string): string {\n    let transformedId = this.counterStore.documentURLTransformer.transformURL(\n      Base.resolveURL(url, this.baseURL),\n      this.baseURL,\n    );\n    if (transformedId.charAt(0) === \"#\") {\n      transformedId = transformedId.substring(1);\n    }\n    return transformedId;\n  }\n\n  /** @override */\n  getPageCounterVal(\n    name: string,\n    format: (p1: number | null) => string,\n  ): Exprs.Val {\n    const getCounterNumber = () => {\n      const values = this.counterStore.currentPageCounters[name];\n      return values && values.length ? values[values.length - 1] : null;\n    };\n\n    const expr = new Exprs.Native(\n      this.pageScope,\n      () => format(getCounterNumber()),\n      `page-counter-${name}`,\n    );\n\n    const arrayFormat = (arr: number[]) => {\n      return format(arr[arr.length - 1]);\n    };\n\n    this.counterStore.registerPageCounterExpr(name, arrayFormat, expr);\n    return expr;\n  }\n\n  /** @override */\n  getPageCountersVal(\n    name: string,\n    format: (p1: number[]) => string,\n  ): Exprs.Val {\n    const getCounterNumbers = () => {\n      return this.counterStore.currentPageCounters[name] || [];\n    };\n\n    const expr = new Exprs.Native(\n      this.pageScope,\n      () => format(getCounterNumbers()),\n      `page-counters-${name}`,\n    );\n    this.counterStore.registerPageCounterExpr(name, format, expr);\n    return expr;\n  }\n\n  /**\n   * Returns (non page-based) counter values for an element with the specified\n   * ID. Returns null if the style of the elements has not been calculated yet\n   * (i.e. the element does not exit or it is in a source document which is not\n   * loaded yet).\n   * @param id Original ID value\n   * @param transformedId ID transformed by DocumentURLTransformer to handle a\n   *     reference across multiple source documents\n   * @param lookForElement If true, look ahead for an element with the ID in the\n   *     current source document when such an element has not appeared yet. Do\n   *     not set to true during Styler.styleUntil is being called, since in that\n   *     case Styler.styleUntil can be called again and may lead to internal\n   *     inconsistency.\n   */\n  private getTargetCounters(\n    id: string | null,\n    transformedId: string,\n    lookForElement: boolean,\n  ): CssCascade.CounterValues | null {\n    let targetCounters = this.counterStore.countersById[transformedId];\n    if (!targetCounters && lookForElement && id) {\n      this.styler.styleUntilIdIsReached(id);\n      targetCounters = this.counterStore.countersById[transformedId];\n    }\n    return targetCounters || null;\n  }\n\n  /**\n   * Returns page-based counter values for an element with the specified ID.\n   * Returns null if the element has not been laid out yet.\n   * @param transformedId ID transformed by DocumentURLTransformer to handle a\n   *     reference across multiple source documents\n   */\n  private getTargetPageCounters(\n    transformedId: string,\n  ): CssCascade.CounterValues | null {\n    if (this.counterStore.currentPage.elementsById[transformedId]) {\n      return this.counterStore.currentPageCounters;\n    } else {\n      return this.counterStore.pageCountersById[transformedId] || null;\n    }\n  }\n\n  /**\n   * Returns page-based text content for an element with the specified ID.\n   * Returns null if the element has not been laid out yet.\n   * @param transformedId ID transformed by DocumentURLTransformer to handle a\n   *     reference across multiple source documents\n   * @param pseudoElement Pseudo-element to extract text from (content, before, after, first-letter, marker)\n   */\n  private getTargetPageText(\n    transformedId: string,\n    pseudoElement: string,\n  ): string | null {\n    if (this.counterStore.currentPage.elementsById[transformedId]) {\n      // Element is on current page - extract text for specific pseudo-element\n      const elements =\n        this.counterStore.currentPage.elementsById[transformedId];\n      if (elements && elements.length > 0) {\n        const element = elements[0];\n\n        if (\n          pseudoElement === \"before\" ||\n          pseudoElement === \"after\" ||\n          pseudoElement === \"marker\"\n        ) {\n          return extractPseudoElementText(element, pseudoElement);\n        }\n        // For content and other pseudo-elements, fall back to content (excluding ::before and ::after)\n        return extractPseudoElementText(element, \"content\");\n      }\n      return \"\";\n    } else {\n      // Check if the ID exists in pageTextById\n      // Need to distinguish between \"not yet laid out\" (undefined) and \"empty text\" (\"\")\n      if (transformedId in this.counterStore.pageTextById) {\n        const textMap = this.counterStore.pageTextById[transformedId];\n        return textMap[pseudoElement] !== undefined\n          ? textMap[pseudoElement]\n          : textMap[\"content\"] || \"\";\n      }\n      return null;\n    }\n  }\n\n  /** @override */\n  getTargetCounterVal(\n    url: string,\n    name: string,\n    format: (p1: number | null) => string,\n  ): Exprs.Val {\n    const id = this.getFragment(url);\n    const transformedId = this.getTransformedId(url);\n\n    // Since this method is executed during Styler.styleUntil is being called,\n    // set false to lookForElement argument.\n    let counters = this.getTargetCounters(id, transformedId, false);\n    if (counters && counters[name]) {\n      // Since an element-based counter is defined, any page-based counter is\n      // obscured even if it exists.\n      const countersOfName = counters[name];\n      return new Exprs.Const(\n        this.rootScope,\n        format(countersOfName[countersOfName.length - 1] || null),\n      );\n    }\n    const expr = new Exprs.Native(\n      this.pageScope,\n      () => {\n        // Since This block is evaluated during layout, lookForElement\n        // argument can be set to true.\n        counters = this.getTargetCounters(id, transformedId, true);\n\n        if (counters) {\n          if (counters[name]) {\n            // Since an element-based counter is defined, any page-based\n            // counter is obscured even if it exists.\n            const countersOfName = counters[name];\n            return format(countersOfName[countersOfName.length - 1] || null);\n          } else {\n            const pageCounters = this.getTargetPageCounters(transformedId);\n            if (pageCounters) {\n              // The target element has already been laid out.\n              this.counterStore.resolveReference(transformedId);\n\n              if (pageCounters[name]) {\n                const pageCountersOfName = pageCounters[name];\n                return format(\n                  pageCountersOfName[pageCountersOfName.length - 1] || null,\n                );\n              } else {\n                // No corresponding counter with the name.\n                return format(0);\n              }\n            } else {\n              // The target element has not been laid out yet.\n              this.counterStore.saveReferenceOfCurrentPage(\n                transformedId,\n                false,\n              );\n              return \"??\"; // TODO more reasonable placeholder?\n            }\n          }\n        } else {\n          // The style of target element has not been calculated yet.\n          // (The element is in another source document that is not parsed\n          // yet)\n          this.counterStore.saveReferenceOfCurrentPage(transformedId, false);\n          return \"??\"; // TODO more reasonable placeholder?\n        }\n      },\n      `target-counter-${name}-of-${url}`,\n    );\n\n    this.counterStore.registerTargetCounterExpr(\n      name,\n      format,\n      expr,\n      transformedId,\n    );\n    return expr;\n  }\n\n  /** @override */\n  getTargetCountersVal(\n    url: string,\n    name: string,\n    format: (p1: number[]) => string,\n  ): Exprs.Val {\n    const id = this.getFragment(url);\n    const transformedId = this.getTransformedId(url);\n    return new Exprs.Native(\n      this.pageScope,\n      () => {\n        const pageCounters = this.getTargetPageCounters(transformedId);\n\n        if (!pageCounters) {\n          // The target element has not been laid out yet.\n          this.counterStore.saveReferenceOfCurrentPage(transformedId, false);\n          return \"??\"; // TODO more reasonable placeholder?\n        } else {\n          this.counterStore.resolveReference(transformedId);\n          const pageCountersOfName = pageCounters[name] || [];\n          const elementCounters = this.getTargetCounters(\n            id,\n            transformedId,\n            true,\n          );\n          const elementCountersOfName = elementCounters[name] || [];\n          return format(pageCountersOfName.concat(elementCountersOfName));\n        }\n      },\n      `target-counters-${name}-of-${url}`,\n    );\n  }\n\n  /** @override */\n  getTargetTextVal(url: string, pseudoElement: string): Exprs.Val {\n    const transformedId = this.getTransformedId(url);\n\n    const expr = new Exprs.Native(\n      this.pageScope,\n      () => {\n        // Handle first-letter separately\n        if (pseudoElement === \"first-letter\") {\n          // Respect pseudo-elements\n          const beforeText = this.getTargetPageText(transformedId, \"before\");\n          const contentText = this.getTargetPageText(transformedId, \"content\");\n          const afterText = this.getTargetPageText(transformedId, \"after\");\n\n          // Check if target element has been laid out\n          if (\n            beforeText === null &&\n            contentText === null &&\n            afterText === null\n          ) {\n            this.counterStore.saveReferenceOfCurrentPage(transformedId, false);\n            return \"??\";\n          }\n\n          const text =\n            (beforeText ?? \"\") + (contentText ?? \"\") + (afterText ?? \"\");\n          this.counterStore.resolveReference(transformedId);\n\n          const match = text.match(Base.firstLetterPattern);\n          return match ? match[0] : \"\";\n        }\n\n        // For other pseudo-elements, get specific text\n        let pageText = this.getTargetPageText(transformedId, pseudoElement);\n        if (pageText !== null) {\n          // The target element has already been laid out.\n          this.counterStore.resolveReference(transformedId);\n          return pageText;\n        } else {\n          // The target element has not been laid out yet.\n          this.counterStore.saveReferenceOfCurrentPage(transformedId, false);\n          return \"??\"; // TODO more reasonable placeholder?\n        }\n      },\n      `target-text-${pseudoElement}-of-${url}`,\n    );\n\n    this.counterStore.registerTargetTextExpr(\n      pseudoElement,\n      expr,\n      transformedId,\n    );\n    return expr;\n  }\n\n  /**\n   * Get value of the CSS string() function\n   * https://drafts.csswg.org/css-gcpm-3/#using-named-strings\n   */\n  getNamedStringVal(name: string, retrievePosition: string): Exprs.Val {\n    return new Exprs.Native(\n      this.pageScope,\n      () =>\n        this.getRunningValue(this.namedStringValues, name, retrievePosition),\n      `named-string-${retrievePosition}-${name}`,\n    );\n  }\n\n  /**\n   * Get value of the CSS element() function\n   * https://drafts.csswg.org/css-gcpm-3/#running-elements\n   */\n  getRunningElementVal(name: string, retrievePosition: string): Exprs.Val {\n    return new Exprs.Native(\n      this.pageScope,\n      () => this.getRunningValue(this.runningElements, name, retrievePosition),\n      `running-element-${retrievePosition}-${name}`,\n    );\n  }\n\n  private getRunningValue(\n    namedRunningValues: NamedRunningValues,\n    name: string,\n    retrievePosition: string,\n  ): string {\n    const runningValues = namedRunningValues[name];\n    if (!runningValues) {\n      return \"\";\n    }\n    const offsets = Object.keys(runningValues)\n      .map((a) => parseInt(a, 10))\n      .sort(Base.numberCompare);\n\n    const currentPage = this.counterStore.currentPage;\n    const pageStartOffset = currentPage.isBlankPage\n      ? currentPage.offset - 1\n      : currentPage.offset;\n    const pageLastOffset = currentPage.isBlankPage\n      ? pageStartOffset\n      : Math.max(\n          pageStartOffset,\n          ...Array.from(\n            currentPage.container.querySelectorAll(\n              `[${Base.ELEMENT_OFFSET_ATTR}]`,\n            ),\n          ).map((e) => parseInt(e.getAttribute(Base.ELEMENT_OFFSET_ATTR), 10)),\n        );\n\n    let firstOffset = -1;\n    let startOffset = -1;\n    let lastOffset = -1;\n    let firstExceptOffset = -1;\n\n    for (let i = 0; i < offsets.length; i++) {\n      const offset = offsets[i];\n      const offsetPrev = i > 0 ? offsets[i - 1] : -1;\n      const offsetNext = i < offsets.length - 1 ? offsets[i + 1] : -1;\n      if (offset > pageLastOffset) {\n        break;\n      }\n      if (offset >= pageStartOffset) {\n        if (firstOffset < 0) {\n          firstOffset = offset;\n          firstExceptOffset = -1;\n        }\n        if (startOffset < 0) {\n          if (offset === pageStartOffset) {\n            startOffset = offset;\n          } else {\n            if (offsetPrev < firstOffset) {\n              startOffset = offsetPrev;\n            }\n            // Check if the element at the offset is at beginning of the page\n            const elementAtOffset = currentPage.container.querySelector(\n              `[${Base.ELEMENT_OFFSET_ATTR}=\"${offset}\"]`,\n            );\n            if (!elementAtOffset) {\n              // title or meta elements are not output, but should be treated as start\n              if (startOffset < 0) {\n                startOffset = offset;\n              }\n            } else {\n              let elementAtPageStartOffset =\n                currentPage.container.querySelector(\n                  `[${Base.ELEMENT_OFFSET_ATTR}=\"${pageStartOffset}\"]`,\n                );\n              if (!elementAtPageStartOffset) {\n                // The element at pageStartOffset is not found when page break occured\n                // within an element, so use the ancestor element with offset 0 instead.\n                elementAtPageStartOffset = currentPage.container.querySelector(\n                  `[${Base.ELEMENT_OFFSET_ATTR}=\"0\"]`,\n                );\n              }\n              if (elementAtPageStartOffset) {\n                // Find if the element at the offset is (the first child of)* the element at page start\n                for (\n                  let element = elementAtPageStartOffset;\n                  element;\n                  element = element.firstElementChild\n                ) {\n                  if (element === elementAtOffset) {\n                    startOffset = offset;\n                    break;\n                  }\n                }\n              }\n            }\n          }\n        }\n        lastOffset = offset;\n      } else if (offsetNext > pageLastOffset || offsetNext < 0) {\n        firstOffset = startOffset = lastOffset = firstExceptOffset = offset;\n      }\n    }\n\n    const runningValue =\n      runningValues[\n        {\n          first: firstOffset,\n          start: startOffset,\n          last: lastOffset,\n          \"first-except\": firstExceptOffset,\n        }[retrievePosition]\n      ] || \"\";\n\n    return runningValue;\n  }\n\n  /**\n   * Set named string for the CSS string-set property\n   * https://drafts.csswg.org/css-gcpm-3/#setting-named-strings-the-string-set-pro\n   */\n  setNamedString(\n    name: string,\n    stringValue: string,\n    elementOffset: number,\n  ): void {\n    const values =\n      this.namedStringValues[name] || (this.namedStringValues[name] = {});\n    values[elementOffset] = stringValue;\n  }\n\n  /**\n   * Set running element\n   * https://drafts.csswg.org/css-gcpm-3/#running-elements\n   */\n  setRunningElement(name: string, elementOffset: number): void {\n    const values =\n      this.runningElements[name] || (this.runningElements[name] = {});\n    values[elementOffset] = String(elementOffset);\n  }\n}\n\nexport class CounterStore {\n  countersById: { [key: string]: CssCascade.CounterValues } = {};\n  pageCountersById: { [key: string]: CssCascade.CounterValues } = {};\n  pageTextById: { [key: string]: { [pseudoElement: string]: string } } = {};\n  currentPageCounters: CssCascade.CounterValues = {};\n  previousPageCounters: CssCascade.CounterValues = {};\n  currentPageCountersStack: CssCascade.CounterValues[] = [];\n  pageIndicesById: {\n    [key: string]: { spineIndex: number; pageIndex: number };\n  } = {};\n  currentPage: Vtree.Page = null;\n  newReferencesOfCurrentPage: TargetCounterReference[] = [];\n  referencesToSolve: TargetCounterReference[] = [];\n  referencesToSolveStack: TargetCounterReference[][] = [];\n  unresolvedReferences: { [key: string]: TargetCounterReference[] } = {};\n  resolvedReferences: { [key: string]: TargetCounterReference[] } = {};\n  private pagesCounterExprs: {\n    expr: Exprs.Val;\n    format: (p1: number[]) => string;\n  }[] = [];\n  private pageCounterExprs: {\n    expr: Exprs.Val;\n    format: (p1: number[]) => string;\n  }[] = [];\n\n  private targetCounterExprs: {\n    name: string;\n    expr: Exprs.Val;\n    format: (p1: number) => string;\n    transformedId: string;\n  }[] = [];\n\n  private targetTextExprs: {\n    pseudoElement: string;\n    expr: Exprs.Val;\n    transformedId: string;\n  }[] = [];\n\n  constructor(\n    public readonly documentURLTransformer: Base.DocumentURLTransformer,\n  ) {\n    this.currentPageCounters[\"page\"] = [0];\n  }\n\n  createCounterListener(baseURL: string): CssCascade.CounterListener {\n    return new CounterListener(this, baseURL);\n  }\n\n  createCounterResolver(\n    baseURL: string,\n    rootScope: Exprs.LexicalScope,\n    pageScope: Exprs.LexicalScope,\n  ): CssCascade.CounterResolver {\n    return new CounterResolver(this, baseURL, rootScope, pageScope);\n  }\n\n  setCurrentPage(page: Vtree.Page) {\n    this.currentPage = page;\n  }\n\n  private definePageCounter(counterName: string, value: number) {\n    if (this.currentPageCounters[counterName]) {\n      this.currentPageCounters[counterName].push(value);\n    } else {\n      this.currentPageCounters[counterName] = [value];\n    }\n  }\n\n  /**\n   * Forcefully set the `page` page-based counter to the specified value.\n   */\n  forceSetPageCounter(pageNumber: number) {\n    const counters = this.currentPageCounters[\"page\"];\n    if (!counters || !counters.length) {\n      this.currentPageCounters[\"page\"] = [pageNumber];\n    } else {\n      counters[counters.length - 1] = pageNumber;\n    }\n  }\n\n  /**\n   * Update the page-based counters with 'counter-reset' and 'counter-increment'\n   * properties within the page context. Call before starting layout of the\n   * page.\n   */\n  updatePageCounters(\n    cascadedPageStyle: CssCascade.ElementStyle,\n    context: Exprs.Context,\n  ) {\n    // Save page counters to previousPageCounters before updating\n    this.previousPageCounters = cloneCounterValues(this.currentPageCounters);\n    let resetMap: { [key: string]: number };\n    const reset = cascadedPageStyle[\"counter-reset\"] as CssCascade.CascadeValue;\n    if (reset) {\n      const resetVal = reset.evaluate(context);\n      if (resetVal) {\n        resetMap = CssProp.toCounters(resetVal, true);\n      }\n    }\n    if (resetMap) {\n      for (const resetCounterName in resetMap) {\n        this.definePageCounter(resetCounterName, resetMap[resetCounterName]);\n      }\n    }\n    let incrementMap: { [key: string]: number };\n    const increment = cascadedPageStyle[\n      \"counter-increment\"\n    ] as CssCascade.CascadeValue;\n    if (increment) {\n      const incrementVal = increment.evaluate(context);\n      if (incrementVal) {\n        incrementMap = CssProp.toCounters(incrementVal, false);\n      }\n    }\n\n    // If 'counter-increment' for the builtin 'page' counter is absent, add it\n    // with value 1.\n    if (incrementMap) {\n      if (!(\"page\" in incrementMap)) {\n        incrementMap[\"page\"] = 1;\n      }\n    } else {\n      incrementMap = {};\n      incrementMap[\"page\"] = 1;\n    }\n    for (const incrementCounterName in incrementMap) {\n      if (!this.currentPageCounters[incrementCounterName]) {\n        this.definePageCounter(incrementCounterName, 0);\n      }\n      const counterValues = this.currentPageCounters[incrementCounterName];\n      counterValues[counterValues.length - 1] +=\n        incrementMap[incrementCounterName];\n    }\n  }\n\n  /**\n   * Save current page-based counters values and set them to the values passed\n   * in. The saved counter values can be restored by popPageCounters method.\n   */\n  pushPageCounters(counters: CssCascade.CounterValues) {\n    this.currentPageCountersStack.push(this.currentPageCounters);\n    this.currentPageCounters = cloneCounterValues(counters);\n  }\n\n  /**\n   * Restore previously saved page-based counter values.\n   */\n  popPageCounters() {\n    this.currentPageCounters = this.currentPageCountersStack.pop();\n  }\n\n  /**\n   * Resolve a reference with the specified ID.\n   */\n  resolveReference(id: string) {\n    const unresolvedRefs = this.unresolvedReferences[id];\n    let resolvedRefs = this.resolvedReferences[id];\n    if (!resolvedRefs) {\n      resolvedRefs = this.resolvedReferences[id] = [];\n    }\n    let pushed = false;\n    for (let i = 0; i < this.referencesToSolve.length; ) {\n      const ref = this.referencesToSolve[i];\n      if (ref.targetId === id) {\n        ref.resolve();\n        this.referencesToSolve.splice(i, 1);\n        if (unresolvedRefs) {\n          const j = unresolvedRefs.indexOf(ref);\n          if (j >= 0) {\n            unresolvedRefs.splice(j, 1);\n          }\n        }\n        resolvedRefs.push(ref);\n        pushed = true;\n      } else {\n        i++;\n      }\n    }\n    if (!pushed) {\n      this.saveReferenceOfCurrentPage(id, true);\n    }\n  }\n\n  /**\n   * Save a reference appeared in the current page.\n   * @param resolved If the reference is already resolved or not.\n   */\n  saveReferenceOfCurrentPage(id: string, resolved: boolean) {\n    if (!this.newReferencesOfCurrentPage.some((ref) => ref.targetId === id)) {\n      const ref = new TargetCounterReference(id, resolved);\n      this.newReferencesOfCurrentPage.push(ref);\n    }\n  }\n\n  /**\n   * Finish the current page; elements with ID are collected and saved with\n   * current page-based counter values internally.\n   * @param spineIndex Index of the currently laid out spine item\n   * @param pageIndex Index of the currently laid out page in its spine item\n   */\n  finishPage(spineIndex: number, pageIndex: number) {\n    const ids = Object.keys(this.currentPage.elementsById);\n    if (ids.length > 0) {\n      const currentPageCounters = cloneCounterValues(this.currentPageCounters);\n      ids.forEach((id) => {\n        this.pageCountersById[id] = currentPageCounters;\n\n        // Capture text content for target-text()\n        const elements = this.currentPage.elementsById[id];\n        if (elements && elements.length > 0) {\n          const element = elements[0];\n          this.pageTextById[id] = {\n            content: extractPseudoElementText(element, \"content\"),\n            before: extractPseudoElementText(element, \"before\"),\n            after: extractPseudoElementText(element, \"after\"),\n            marker: extractPseudoElementText(element, \"marker\"),\n          };\n        }\n\n        const oldPageIndex = this.pageIndicesById[id];\n        if (oldPageIndex && oldPageIndex.pageIndex < pageIndex) {\n          const resolvedRefs = this.resolvedReferences[id];\n          if (resolvedRefs) {\n            let unresolvedRefs = this.unresolvedReferences[id];\n            if (!unresolvedRefs) {\n              unresolvedRefs = this.unresolvedReferences[id] = [];\n            }\n            let ref: TargetCounterReference;\n            while ((ref = resolvedRefs.shift())) {\n              ref.unresolve();\n              unresolvedRefs.push(ref);\n            }\n          }\n        }\n        this.pageIndicesById[id] = { spineIndex, pageIndex };\n      });\n    }\n    const prevPageCounters = this.previousPageCounters;\n    let ref: TargetCounterReference;\n    while ((ref = this.newReferencesOfCurrentPage.shift())) {\n      ref.pageCounters = prevPageCounters;\n      ref.spineIndex = spineIndex;\n      ref.pageIndex = pageIndex;\n      let arr: TargetCounterReference[];\n      if (ref.isResolved()) {\n        arr = this.resolvedReferences[ref.targetId];\n        if (!arr) {\n          arr = this.resolvedReferences[ref.targetId] = [];\n        }\n      } else {\n        arr = this.unresolvedReferences[ref.targetId];\n        if (!arr) {\n          arr = this.unresolvedReferences[ref.targetId] = [];\n        }\n      }\n      if (arr.every((r) => !ref.equals(r))) {\n        arr.push(ref);\n      }\n    }\n    this.currentPage = null;\n  }\n\n  /**\n   * Returns unresolved references pointing to the specified page.\n   */\n  getUnresolvedRefsToPage(page: Vtree.Page): {\n    spineIndex: number;\n    pageIndex: number;\n    pageCounters: CssCascade.CounterValues;\n    refs: TargetCounterReference[];\n  }[] {\n    let refs: TargetCounterReference[] = [];\n    const ids = Object.keys(page.elementsById);\n    ids.forEach((id) => {\n      const idRefs = this.unresolvedReferences[id];\n      if (idRefs) {\n        refs = refs.concat(idRefs);\n      }\n    });\n    refs.sort(\n      (r1, r2) => r1.spineIndex - r2.spineIndex || r1.pageIndex - r2.pageIndex,\n    );\n    const result: {\n      spineIndex: number;\n      pageIndex: number;\n      pageCounters: CssCascade.CounterValues;\n      refs: TargetCounterReference[];\n    }[] = [];\n    let o: {\n      spineIndex: number;\n      pageIndex: number;\n      pageCounters: CssCascade.CounterValues;\n      refs: TargetCounterReference[];\n    } = null;\n    refs.forEach((ref) => {\n      if (\n        !o ||\n        o.spineIndex !== ref.spineIndex ||\n        o.pageIndex !== ref.pageIndex\n      ) {\n        o = {\n          spineIndex: ref.spineIndex,\n          pageIndex: ref.pageIndex,\n          pageCounters: ref.pageCounters,\n          refs: [ref],\n        };\n        result.push(o);\n      } else {\n        o.refs.push(ref);\n      }\n    });\n    return result;\n  }\n\n  /**\n   * Save current references to solve and set them to the values passed in.\n   * The saved references can be restored by popReferencesToSolve method.\n   */\n  pushReferencesToSolve(refs: TargetCounterReference[]) {\n    this.referencesToSolveStack.push(this.referencesToSolve);\n    this.referencesToSolve = refs;\n  }\n\n  /**\n   * Restore previously saved references to solve.\n   */\n  popReferencesToSolve() {\n    this.referencesToSolve = this.referencesToSolveStack.pop();\n  }\n\n  registerPageCounterExpr(\n    name: string,\n    format: (p1: number[]) => string,\n    expr: Exprs.Val,\n  ) {\n    if (name === \"pages\") {\n      this.pagesCounterExprs.push({ expr, format });\n    } else {\n      this.pageCounterExprs.push({ expr, format });\n    }\n  }\n  registerTargetCounterExpr(\n    name: string,\n    format: (p1: number) => string,\n    expr: Exprs.Val,\n    transformedId: string,\n  ) {\n    this.targetCounterExprs.push({ name, expr, format, transformedId });\n  }\n\n  registerTargetTextExpr(\n    pseudoElement: string,\n    expr: Exprs.Val,\n    transformedId: string,\n  ) {\n    this.targetTextExprs.push({ pseudoElement, expr, transformedId });\n  }\n\n  getExprContentListener(): Vtree.ExprContentListener {\n    return this.exprContentListener.bind(this);\n  }\n\n  private exprContentListener(\n    expr: Exprs.Val,\n    val: string,\n    document: Document,\n  ) {\n    if (expr instanceof Exprs.Native) {\n      if (expr.str == \"viv-leader\") {\n        const node = document.createElementNS(Base.NS.XHTML, \"span\");\n        node.textContent = val;\n        node.setAttribute(\"data-viv-leader\", expr.key);\n        node.setAttribute(\"data-viv-leader-value\", val);\n        return node;\n      } else if (expr.str.startsWith(\"running-element-\")) {\n        const elemList =\n          val &&\n          document.querySelectorAll(`[${Base.ELEMENT_OFFSET_ATTR}=\"${val}\"]`);\n        if (!elemList || elemList.length === 0) {\n          return null;\n        }\n        const lastElem = elemList[elemList.length - 1];\n        const clonedElem = lastElem.cloneNode(true) as HTMLElement;\n        this.fixPageCounterInRunningElement(clonedElem);\n        clonedElem.style.position = \"\";\n        clonedElem.style.visibility = \"\";\n        return clonedElem;\n      } else if (expr.str.startsWith(\"target-counter-\")) {\n        const node = document.createElementNS(Base.NS.XHTML, \"span\");\n        node.textContent = val;\n        node.setAttribute(TARGET_COUNTER_ATTR, expr.key);\n        return node;\n      } else if (expr.str.startsWith(\"target-text-\")) {\n        const node = document.createElementNS(Base.NS.XHTML, \"span\");\n        node.textContent = val;\n        node.setAttribute(TARGET_TEXT_ATTR, expr.key);\n        return node;\n      }\n    }\n\n    const foundPagesCounter =\n      this.pagesCounterExprs.findIndex((o) => o.expr === expr) >= 0;\n    const foundPageCounter =\n      !foundPagesCounter &&\n      this.pageCounterExprs.findIndex((o) => o.expr === expr) >= 0;\n\n    if (foundPagesCounter || foundPageCounter) {\n      const node = document.createElementNS(Base.NS.XHTML, \"span\");\n      node.textContent = val;\n      node.setAttribute(\n        foundPagesCounter ? PAGES_COUNTER_ATTR : PAGE_COUNTER_ATTR,\n        expr.key,\n      );\n      return node;\n    } else {\n      return null;\n    }\n  }\n\n  private fixPageCounterInRunningElement(runningElem: Element): void {\n    const nodes = runningElem.querySelectorAll(`[${PAGE_COUNTER_ATTR}]`);\n    for (const node of nodes) {\n      const key = node.getAttribute(PAGE_COUNTER_ATTR);\n      const counterExpr = this.pageCounterExprs.find((o) => o.expr.key === key);\n      const str = (counterExpr?.expr as Exprs.Native).str;\n      const counterName = str?.replace(/^page-counters?-/, \"\");\n      const counterValues = this.currentPageCounters[counterName];\n      if (counterValues) {\n        node.textContent = counterExpr.format(counterValues);\n      }\n    }\n    const targetNodes = runningElem.querySelectorAll(\n      `[${TARGET_COUNTER_ATTR}]`,\n    );\n\n    for (const node of targetNodes) {\n      node.setAttribute(TARGET_COUNTER_IN_RUNNING_ATTR, true);\n    }\n\n    const targetTextNodes = runningElem.querySelectorAll(\n      `[${TARGET_TEXT_ATTR}]`,\n    );\n\n    for (const node of targetTextNodes) {\n      node.setAttribute(TARGET_TEXT_IN_RUNNING_ATTR, true);\n    }\n  }\n\n  finishLastPage(viewport: Vgen.Viewport) {\n    const nodes = viewport.root.querySelectorAll(`[${PAGES_COUNTER_ATTR}]`);\n    const pages = viewport.contentContainer.childElementCount;\n    for (const node of nodes) {\n      const key = node.getAttribute(PAGES_COUNTER_ATTR);\n      const i = this.pagesCounterExprs.findIndex((o) => o.expr.key === key);\n      Asserts.assert(i >= 0);\n      node.textContent = this.pagesCounterExprs[i].format([pages]);\n    }\n\n    const runningNodes = viewport.root.querySelectorAll(\n      `[${TARGET_COUNTER_IN_RUNNING_ATTR}]`,\n    );\n\n    for (const node of runningNodes) {\n      const key = node.getAttribute(TARGET_COUNTER_ATTR);\n      const expr = this.targetCounterExprs.find((o) => o.expr.key === key);\n      if (expr && expr.transformedId) {\n        const counterValue = this.pageCountersById[expr.transformedId];\n        if (counterValue) {\n          const arr: number[] = counterValue[expr.name];\n          if (arr) {\n            node.textContent = expr.format(arr[arr.length - 1]);\n          }\n        }\n      }\n    }\n\n    const runningTextNodes = viewport.root.querySelectorAll(\n      `[${TARGET_TEXT_IN_RUNNING_ATTR}]`,\n    );\n\n    for (const node of runningTextNodes) {\n      const key = node.getAttribute(TARGET_TEXT_ATTR);\n      const expr = this.targetTextExprs.find((o) => o.expr.key === key);\n      if (expr && expr.transformedId) {\n        const text = this.pageTextById[expr.transformedId];\n        if (text) {\n          node.textContent = text[expr.pseudoElement] ?? \"\";\n        }\n      }\n    }\n  }\n\n  createLayoutConstraint(pageIndex: number): Layout.LayoutConstraint {\n    return new LayoutConstraint(this, pageIndex);\n  }\n}\n\nexport const PAGES_COUNTER_ATTR = \"data-vivliostyle-pages-counter\";\nexport const PAGE_COUNTER_ATTR = \"data-vivliostyle-page-counter\";\nexport const TARGET_COUNTER_ATTR = \"data-vivliostyle-target-counter\";\nexport const TARGET_TEXT_ATTR = \"data-vivliostyle-target-text\";\n\nexport const TARGET_COUNTER_IN_RUNNING_ATTR =\n  \"data-vivliostyle-target-counter-in-running\";\nexport const TARGET_TEXT_IN_RUNNING_ATTR =\n  \"data-vivliostyle-target-text-in-running\";\n\nclass LayoutConstraint implements Layout.LayoutConstraint {\n  constructor(\n    public readonly counterStore: CounterStore,\n    public readonly pageIndex: number,\n  ) {}\n\n  /** @override */\n  allowLayout(nodeContext: Vtree.NodeContext): boolean {\n    if (!nodeContext || nodeContext.after) {\n      return true;\n    }\n    const viewNode = nodeContext.viewNode;\n    if (!viewNode || viewNode.nodeType !== 1) {\n      return true;\n    }\n    const id =\n      (viewNode as Element).getAttribute(\"data-vivliostyle-id\") ||\n      (viewNode as Element).getAttribute(\"id\") ||\n      (viewNode as Element).getAttribute(\"name\");\n    if (!id) {\n      return true;\n    }\n    if (\n      !this.counterStore.resolvedReferences[id] &&\n      !this.counterStore.unresolvedReferences[id]\n    ) {\n      return true;\n    }\n    const pageIndex = this.counterStore.pageIndicesById[id];\n    if (!pageIndex) {\n      return true;\n    }\n    return this.pageIndex >= pageIndex.pageIndex;\n  }\n}\n", "/**\n * Copyright 2013 Google, Inc.\n * Copyright 2017 Daishinsha Inc.\n * Copyright 2019 Vivliostyle Foundation\n *\n * Vivliostyle.js is free software: you can redistribute it and/or modify\n * it under the terms of the GNU Affero General Public License as published by\n * the Free Software Foundation, either version 3 of the License, or\n * (at your option) any later version.\n *\n * Vivliostyle.js is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n * GNU Affero General Public License for more details.\n *\n * You should have received a copy of the GNU Affero General Public License\n * along with Vivliostyle.js.  If not, see <http://www.gnu.org/licenses/>.\n *\n * @fileoverview CssTokenizer - CSS Tokenizer.\n */\n\n/** */\nexport interface TokenizerHandler {\n  error(mnemonics: string, token: Token): void;\n}\n\nexport function escapeParseSingle(str: string): string {\n  str = str.substr(1);\n  if (str.match(/^[^0-9a-fA-F\\n\\r]$/)) {\n    return str;\n  }\n  const code = parseInt(str, 16);\n  if (isNaN(code)) {\n    return \"\";\n  }\n  if (code === 0 || (code >= 0xd800 && code <= 0xdfff) || code > 0x10ffff) {\n    return \"\\uFFFD\";\n  }\n  return String.fromCodePoint(code);\n}\n\nexport function escapeParse(str: string): string {\n  return str.replace(\n    /\\\\([0-9a-fA-F]{1,6}(\\r\\n|[ \\n\\r\\t\\f])?|[^0-9a-fA-F\\n\\r])/g,\n    escapeParseSingle,\n  );\n}\n\n/**\n * @enum {number}\n */\nexport enum TokenType {\n  EOF,\n  IDENT,\n  STR,\n  NUMERIC,\n  NUM,\n  INT,\n  FUNC,\n  HASH,\n  URL,\n  CLASS,\n  O_PAR,\n  C_PAR,\n  O_BRC,\n  C_BRC,\n  O_BRK,\n  C_BRK,\n  COMMA,\n  SEMICOL,\n  COLON,\n  SLASH,\n  AT,\n  PERCENT,\n  QMARK,\n  PLUS,\n  MINUS,\n  BAR_BAR,\n  AMP_AMP,\n  URANGE,\n\n  // those can have \"=\" at the end\n  BANG = 31,\n  DOLLAR,\n  HAT,\n  BAR,\n  TILDE,\n  STAR,\n  GT,\n  LT,\n  EQ,\n\n  // tokens above plus \"=\" at the end, order must be the same\n  BANG_EQ = 41,\n  DOLLAR_EQ,\n  HAT_EQ,\n  BAR_EQ,\n  TILDE_EQ,\n  STAR_EQ,\n  GT_EQ,\n  LT_EQ,\n  EQ_EQ,\n  COL_COL,\n  CDO,\n  CDC,\n  UNKNOWN,\n  INVALID,\n  LAST = 54,\n}\n\nexport class Token {\n  type: TokenType;\n  precededBySpace: boolean = false;\n  num: number = 0;\n  text: string = \"\";\n  position: number = 0;\n\n  constructor() {\n    this.type = TokenType.EOF;\n  }\n\n  toString(): string {\n    switch (this.type) {\n      case TokenType.O_PAR:\n        return \"(\";\n      case TokenType.C_PAR:\n        return \")\";\n      case TokenType.O_BRC:\n        return \"{\";\n      case TokenType.C_BRC:\n        return \"}\";\n      case TokenType.O_BRK:\n        return \"[\";\n      case TokenType.C_BRK:\n        return \"]\";\n      case TokenType.COMMA:\n        return \",\";\n      case TokenType.SEMICOL:\n        return \";\";\n      case TokenType.COLON:\n        return \":\";\n      case TokenType.SLASH:\n        return \"/\";\n      case TokenType.PERCENT:\n        return \"%\";\n      case TokenType.QMARK:\n        return \"?\";\n      case TokenType.PLUS:\n        return \"+\";\n      case TokenType.MINUS:\n        return \"-\";\n      case TokenType.BAR_BAR:\n        return \"||\";\n      case TokenType.AMP_AMP:\n        return \"&&\";\n      case TokenType.BANG:\n        return \"!\";\n      case TokenType.DOLLAR:\n        return \"$\";\n      case TokenType.HAT:\n        return \"^\";\n      case TokenType.BAR:\n        return \"|\";\n      case TokenType.TILDE:\n        return \"~\";\n      case TokenType.STAR:\n        return \"*\";\n      case TokenType.GT:\n        return \">\";\n      case TokenType.LT:\n        return \"<\";\n      case TokenType.EQ:\n        return \"=\";\n      case TokenType.BANG_EQ:\n        return \"!=\";\n      case TokenType.DOLLAR_EQ:\n        return \"$=\";\n      case TokenType.HAT_EQ:\n        return \"^=\";\n      case TokenType.BAR_EQ:\n        return \"|=\";\n      case TokenType.TILDE_EQ:\n        return \"~=\";\n      case TokenType.STAR_EQ:\n        return \"*=\";\n      case TokenType.GT_EQ:\n        return \">=\";\n      case TokenType.LT_EQ:\n        return \"<=\";\n      case TokenType.EQ_EQ:\n        return \"==\";\n      case TokenType.COL_COL:\n        return \"::\";\n      case TokenType.CDO:\n        return \"<!--\";\n      case TokenType.CDC:\n        return \"-->\";\n      case TokenType.NUMERIC:\n        return this.num.toString() + this.text;\n      case TokenType.NUM:\n      case TokenType.INT:\n        return this.num.toString();\n      case TokenType.AT:\n        return \"@\" + this.text;\n      case TokenType.HASH:\n        return \"#\" + this.text;\n      case TokenType.FUNC:\n        return this.text + \"(\";\n      case TokenType.CLASS:\n        return \".\" + this.text;\n      case TokenType.EOF:\n        return \"/*EOF*/\";\n      default:\n        return this.text;\n    }\n  }\n}\n\n/**\n * @enum {number}\n */\nexport enum Action {\n  SPACE = 1,\n  INT,\n  IDENT,\n  BANG,\n  HASH = 6,\n  DOLLAR,\n  PERCENT,\n  AMP,\n  O_PAR,\n  C_PAR,\n  STAR,\n  PLUS,\n  COMMA,\n  MINUS,\n  DOT,\n  SLASH,\n  COLON,\n  SEMICOL,\n  LT,\n  EQ,\n  GT,\n  QMARK,\n  AT,\n  O_BRK,\n  C_BRK,\n  O_BRC,\n  C_BRC,\n  BSLASH,\n  HAT,\n  BAR,\n  TILDE,\n  STR1,\n  STR2,\n  END,\n  EQTAIL,\n  ENDINT,\n  ENDNUM,\n  CONT,\n  UNIT,\n  PCUNIT,\n  NUMBER,\n  ENDIDNT,\n  IDNTESC,\n  ENDIDES,\n\n  // end of identifier with escapes\n  ENDSTR,\n  ENDESTR,\n\n  // end of string with escapes\n  STR1ESC,\n  STR2ESC,\n  BAR_BAR,\n  AMP_AMP,\n  FUNC,\n  FUNCES,\n  COMMENT,\n  COMMST,\n  ENDNOTK,\n  MINMIN,\n  TOINT,\n  TONUM,\n  TOIDENT,\n  TOIDES,\n  KILL1,\n  KILL2,\n  URL,\n  URL1,\n  URL2,\n  ENDURL,\n  TERMURL,\n  FINURL,\n  LT_BG,\n  LT_BG_M,\n  INVALID,\n  CHKPOSS,\n  CHKPOSN,\n  URLESC,\n  IDESCH,\n  COL_COL,\n  TOCLASS,\n  CHKSP,\n  EOF,\n  CDO,\n  CDC,\n}\n\nexport function makeActions(def: Action, spec: number[]): Action[] {\n  const a: number[] = Array(128);\n  let i: number;\n  for (i = 0; i < 128; i++) {\n    a[i] = def;\n  }\n  a[NaN] = def == Action.END ? Action.END : Action.INVALID;\n  for (i = 0; i < spec.length; i += 2) {\n    a[spec[i]] = spec[i + 1];\n  }\n  return a;\n}\n\n/**\n * Start of the token.\n */\nexport const actionsNormal: Action[] = [\n  Action.INVALID,\n  Action.INVALID,\n  Action.INVALID,\n  Action.INVALID,\n  Action.INVALID,\n  Action.INVALID,\n  Action.INVALID,\n  Action.INVALID, // 0x00-0x07\n  Action.INVALID,\n  Action.SPACE,\n  Action.SPACE,\n  Action.INVALID,\n  Action.SPACE,\n  Action.SPACE,\n  Action.INVALID,\n  Action.INVALID, // 0x08-0x0F\n  Action.INVALID,\n  Action.INVALID,\n  Action.INVALID,\n  Action.INVALID,\n  Action.INVALID,\n  Action.INVALID,\n  Action.INVALID,\n  Action.INVALID, // 0x10-0x17\n  Action.INVALID,\n  Action.INVALID,\n  Action.INVALID,\n  Action.INVALID,\n  Action.INVALID,\n  Action.INVALID,\n  Action.INVALID,\n  Action.INVALID, // 0x18-0x1F\n  Action.SPACE,\n  Action.BANG,\n  Action.STR2,\n  Action.HASH,\n  Action.DOLLAR,\n  Action.PERCENT,\n  Action.AMP,\n  Action.STR1, // 0x20-0x27\n  Action.O_PAR,\n  Action.C_PAR,\n  Action.STAR,\n  Action.PLUS,\n  Action.COMMA,\n  Action.MINUS,\n  Action.DOT,\n  Action.SLASH, // 0x28-0x2F\n  Action.INT,\n  Action.INT,\n  Action.INT,\n  Action.INT,\n  Action.INT,\n  Action.INT,\n  Action.INT,\n  Action.INT, // 0x30-0x37\n  Action.INT,\n  Action.INT,\n  Action.COLON,\n  Action.SEMICOL,\n  Action.LT,\n  Action.EQ,\n  Action.GT,\n  Action.QMARK, // 0x38-0x3F\n  Action.AT,\n  Action.IDENT,\n  Action.IDENT,\n  Action.IDENT,\n  Action.IDENT,\n  Action.IDENT,\n  Action.IDENT,\n  Action.IDENT, // 0x40-0x47\n  Action.IDENT,\n  Action.IDENT,\n  Action.IDENT,\n  Action.IDENT,\n  Action.IDENT,\n  Action.IDENT,\n  Action.IDENT,\n  Action.IDENT, // 0x48-0x4F\n  Action.IDENT,\n  Action.IDENT,\n  Action.IDENT,\n  Action.IDENT,\n  Action.IDENT,\n  Action.IDENT,\n  Action.IDENT,\n  Action.IDENT, // 0x50-0x57\n  Action.IDENT,\n  Action.IDENT,\n  Action.IDENT,\n  Action.O_BRK,\n  Action.BSLASH,\n  Action.C_BRK,\n  Action.HAT,\n  Action.IDENT, // 0x58-0x5F\n  Action.INVALID,\n  Action.IDENT,\n  Action.IDENT,\n  Action.IDENT,\n  Action.IDENT,\n  Action.IDENT,\n  Action.IDENT,\n  Action.IDENT, // 0x60-0x67\n  Action.IDENT,\n  Action.IDENT,\n  Action.IDENT,\n  Action.IDENT,\n  Action.IDENT,\n  Action.IDENT,\n  Action.IDENT,\n  Action.IDENT, // 0x68-0x6F\n  Action.IDENT,\n  Action.IDENT,\n  Action.IDENT,\n  Action.IDENT,\n  Action.IDENT,\n  Action.IDENT,\n  Action.IDENT,\n  Action.IDENT, // 0x70-0x77\n  Action.IDENT,\n  Action.IDENT,\n  Action.IDENT,\n  Action.O_BRC,\n  Action.BAR,\n  Action.C_BRC,\n  Action.TILDE,\n  Action.INVALID, // 0x78-0x7F\n];\n\nactionsNormal[NaN] = Action.EOF;\n\n/**\n * Inside identifier.\n */\nexport const actionsIdent: Action[] = [\n  Action.ENDIDNT,\n  Action.ENDIDNT,\n  Action.ENDIDNT,\n  Action.ENDIDNT,\n  Action.ENDIDNT,\n  Action.ENDIDNT,\n  Action.ENDIDNT,\n  Action.ENDIDNT, // 0x00-0x07\n  Action.ENDIDNT,\n  Action.ENDIDNT,\n  Action.ENDIDNT,\n  Action.ENDIDNT,\n  Action.ENDIDNT,\n  Action.ENDIDNT,\n  Action.ENDIDNT,\n  Action.ENDIDNT, // 0x08-0x0F\n  Action.ENDIDNT,\n  Action.ENDIDNT,\n  Action.ENDIDNT,\n  Action.ENDIDNT,\n  Action.ENDIDNT,\n  Action.ENDIDNT,\n  Action.ENDIDNT,\n  Action.ENDIDNT, // 0x10-0x17\n  Action.ENDIDNT,\n  Action.ENDIDNT,\n  Action.ENDIDNT,\n  Action.ENDIDNT,\n  Action.ENDIDNT,\n  Action.ENDIDNT,\n  Action.ENDIDNT,\n  Action.ENDIDNT, // 0x18-0x1F\n  Action.ENDIDNT,\n  Action.ENDIDNT,\n  Action.ENDIDNT,\n  Action.ENDIDNT,\n  Action.ENDIDNT,\n  Action.ENDIDNT,\n  Action.ENDIDNT,\n  Action.ENDIDNT, // 0x20-0x27\n  Action.FUNC,\n  Action.ENDIDNT,\n  Action.ENDIDNT,\n  Action.ENDIDNT,\n  Action.ENDIDNT,\n  Action.CONT,\n  Action.ENDIDNT,\n  Action.ENDIDNT, // 0x28-0x2F\n  Action.CONT,\n  Action.CONT,\n  Action.CONT,\n  Action.CONT,\n  Action.CONT,\n  Action.CONT,\n  Action.CONT,\n  Action.CONT, // 0x30-0x37\n  Action.CONT,\n  Action.CONT,\n  Action.ENDIDNT,\n  Action.ENDIDNT,\n  Action.ENDIDNT,\n  Action.ENDIDNT,\n  Action.ENDIDNT,\n  Action.ENDIDNT, // 0x38-0x3F\n  Action.ENDIDNT,\n  Action.CONT,\n  Action.CONT,\n  Action.CONT,\n  Action.CONT,\n  Action.CONT,\n  Action.CONT,\n  Action.CONT, // 0x40-0x47\n  Action.CONT,\n  Action.CONT,\n  Action.CONT,\n  Action.CONT,\n  Action.CONT,\n  Action.CONT,\n  Action.CONT,\n  Action.CONT, // 0x48-0x4F\n  Action.CONT,\n  Action.CONT,\n  Action.CONT,\n  Action.CONT,\n  Action.CONT,\n  Action.CONT,\n  Action.CONT,\n  Action.CONT, // 0x50-0x57\n  Action.CONT,\n  Action.CONT,\n  Action.CONT,\n  Action.ENDIDNT,\n  Action.IDNTESC,\n  Action.ENDIDNT,\n  Action.ENDIDNT,\n  Action.CONT, // 0x58-0x5F\n  Action.ENDIDNT,\n  Action.CONT,\n  Action.CONT,\n  Action.CONT,\n  Action.CONT,\n  Action.CONT,\n  Action.CONT,\n  Action.CONT, // 0x60-0x67\n  Action.CONT,\n  Action.CONT,\n  Action.CONT,\n  Action.CONT,\n  Action.CONT,\n  Action.CONT,\n  Action.CONT,\n  Action.CONT, // 0x68-0x6F\n  Action.CONT,\n  Action.CONT,\n  Action.CONT,\n  Action.CONT,\n  Action.CONT,\n  Action.CONT,\n  Action.CONT,\n  Action.CONT, // 0x70-0x77\n  Action.CONT,\n  Action.CONT,\n  Action.CONT,\n  Action.ENDIDNT,\n  Action.ENDIDNT,\n  Action.ENDIDNT,\n  Action.ENDIDNT,\n  Action.ENDIDNT, // 0x78-0x7F\n];\n\nactionsIdent[NaN] = Action.ENDIDNT;\n\n/**\n * After dot (either .class or .123)\n */\nexport const actionsNumOrClass: Action[] = [\n  Action.INVALID,\n  Action.INVALID,\n  Action.INVALID,\n  Action.INVALID,\n  Action.INVALID,\n  Action.INVALID,\n  Action.INVALID,\n  Action.INVALID, // 0x00-0x07\n  Action.INVALID,\n  Action.INVALID,\n  Action.INVALID,\n  Action.INVALID,\n  Action.INVALID,\n  Action.INVALID,\n  Action.INVALID,\n  Action.INVALID, // 0x08-0x0F\n  Action.INVALID,\n  Action.INVALID,\n  Action.INVALID,\n  Action.INVALID,\n  Action.INVALID,\n  Action.INVALID,\n  Action.INVALID,\n  Action.INVALID, // 0x10-0x17\n  Action.INVALID,\n  Action.INVALID,\n  Action.INVALID,\n  Action.INVALID,\n  Action.INVALID,\n  Action.INVALID,\n  Action.INVALID,\n  Action.INVALID, // 0x18-0x1F\n  Action.INVALID,\n  Action.INVALID,\n  Action.INVALID,\n  Action.INVALID,\n  Action.INVALID,\n  Action.INVALID,\n  Action.INVALID,\n  Action.INVALID, // 0x20-0x27\n  Action.INVALID,\n  Action.INVALID,\n  Action.INVALID,\n  Action.INVALID,\n  Action.INVALID,\n  Action.TOCLASS,\n  Action.TONUM,\n  Action.INVALID, // 0x28-0x2F\n  Action.TONUM,\n  Action.TONUM,\n  Action.TONUM,\n  Action.TONUM,\n  Action.TONUM,\n  Action.TONUM,\n  Action.TONUM,\n  Action.TONUM, // 0x30-0x37\n  Action.TONUM,\n  Action.TONUM,\n  Action.INVALID,\n  Action.INVALID,\n  Action.INVALID,\n  Action.INVALID,\n  Action.INVALID,\n  Action.INVALID, // 0x38-0x3F\n  Action.INVALID,\n  Action.TOCLASS,\n  Action.TOCLASS,\n  Action.TOCLASS,\n  Action.TOCLASS,\n  Action.TOCLASS,\n  Action.TOCLASS,\n  Action.TOCLASS, // 0x40-0x47\n  Action.TOCLASS,\n  Action.TOCLASS,\n  Action.TOCLASS,\n  Action.TOCLASS,\n  Action.TOCLASS,\n  Action.TOCLASS,\n  Action.TOCLASS,\n  Action.TOCLASS, // 0x48-0x4F\n  Action.TOCLASS,\n  Action.TOCLASS,\n  Action.TOCLASS,\n  Action.TOCLASS,\n  Action.TOCLASS,\n  Action.TOCLASS,\n  Action.TOCLASS,\n  Action.TOCLASS, // 0x50-0x57\n  Action.TOCLASS,\n  Action.TOCLASS,\n  Action.TOCLASS,\n  Action.INVALID,\n  Action.TOIDES,\n  Action.INVALID,\n  Action.INVALID,\n  Action.TOCLASS, // 0x58-0x5F\n  Action.INVALID,\n  Action.TOCLASS,\n  Action.TOCLASS,\n  Action.TOCLASS,\n  Action.TOCLASS,\n  Action.TOCLASS,\n  Action.TOCLASS,\n  Action.TOCLASS, // 0x60-0x67\n  Action.TOCLASS,\n  Action.TOCLASS,\n  Action.TOCLASS,\n  Action.TOCLASS,\n  Action.TOCLASS,\n  Action.TOCLASS,\n  Action.TOCLASS,\n  Action.TOCLASS, // 0x68-0x6F\n  Action.TOCLASS,\n  Action.TOCLASS,\n  Action.TOCLASS,\n  Action.TOCLASS,\n  Action.TOCLASS,\n  Action.TOCLASS,\n  Action.TOCLASS,\n  Action.TOCLASS, // 0x70-0x77\n  Action.TOCLASS,\n  Action.TOCLASS,\n  Action.TOCLASS,\n  Action.INVALID,\n  Action.INVALID,\n  Action.INVALID,\n  Action.INVALID,\n  Action.INVALID, // 0x78-0x7F\n];\n\nactionsIdent[NaN] = Action.ENDIDNT;\n\n/**\n * after '-'\n */\nexport const actionsMinus: Action[] = [\n  Action.END,\n  Action.END,\n  Action.END,\n  Action.END,\n  Action.END,\n  Action.END,\n  Action.END,\n  Action.END, // 0x00-0x07\n  Action.END,\n  Action.END,\n  Action.END,\n  Action.END,\n  Action.END,\n  Action.END,\n  Action.END,\n  Action.END, // 0x08-0x0F\n  Action.END,\n  Action.END,\n  Action.END,\n  Action.END,\n  Action.END,\n  Action.END,\n  Action.END,\n  Action.END, // 0x10-0x17\n  Action.END,\n  Action.END,\n  Action.END,\n  Action.END,\n  Action.END,\n  Action.END,\n  Action.END,\n  Action.END, // 0x18-0x1F\n  Action.END,\n  Action.END,\n  Action.END,\n  Action.END,\n  Action.END,\n  Action.END,\n  Action.END,\n  Action.END, // 0x20-0x27\n  Action.END,\n  Action.END,\n  Action.END,\n  Action.END,\n  Action.END,\n  Action.MINMIN,\n  Action.TONUM,\n  Action.END, // 0x28-0x2F\n  Action.TOINT,\n  Action.TOINT,\n  Action.TOINT,\n  Action.TOINT,\n  Action.TOINT,\n  Action.TOINT,\n  Action.TOINT,\n  Action.TOINT, // 0x30-0x37\n  Action.TOINT,\n  Action.TOINT,\n  Action.END,\n  Action.END,\n  Action.END,\n  Action.END,\n  Action.END,\n  Action.END, // 0x38-0x3F\n  Action.END,\n  Action.TOIDENT,\n  Action.TOIDENT,\n  Action.TOIDENT,\n  Action.TOIDENT,\n  Action.TOIDENT,\n  Action.TOIDENT,\n  Action.TOIDENT, // 0x40-0x47\n  Action.TOIDENT,\n  Action.TOIDENT,\n  Action.TOIDENT,\n  Action.TOIDENT,\n  Action.TOIDENT,\n  Action.TOIDENT,\n  Action.TOIDENT,\n  Action.TOIDENT, // 0x48-0x4F\n  Action.TOIDENT,\n  Action.TOIDENT,\n  Action.TOIDENT,\n  Action.TOIDENT,\n  Action.TOIDENT,\n  Action.TOIDENT,\n  Action.TOIDENT,\n  Action.TOIDENT, // 0x50-0x57\n  Action.TOIDENT,\n  Action.TOIDENT,\n  Action.TOIDENT,\n  Action.END,\n  Action.TOIDES,\n  Action.END,\n  Action.END,\n  Action.TOIDENT, // 0x58-0x5F\n  Action.END,\n  Action.TOIDENT,\n  Action.TOIDENT,\n  Action.TOIDENT,\n  Action.TOIDENT,\n  Action.TOIDENT,\n  Action.TOIDENT,\n  Action.TOIDENT, // 0x60-0x67\n  Action.TOIDENT,\n  Action.TOIDENT,\n  Action.TOIDENT,\n  Action.TOIDENT,\n  Action.TOIDENT,\n  Action.TOIDENT,\n  Action.TOIDENT,\n  Action.TOIDENT, // 0x68-0x6F\n  Action.TOIDENT,\n  Action.TOIDENT,\n  Action.TOIDENT,\n  Action.TOIDENT,\n  Action.TOIDENT,\n  Action.TOIDENT,\n  Action.TOIDENT,\n  Action.TOIDENT, // 0x70-0x77\n  Action.TOIDENT,\n  Action.TOIDENT,\n  Action.TOIDENT,\n  Action.END,\n  Action.END,\n  Action.END,\n  Action.END,\n  Action.END, // 0x78-0x7F\n];\n\nactionsMinus[NaN] = Action.END;\n\n/**\n * Inside identifier with escape sequence\n */\nexport const actionsIdentEsc: Action[] = [\n  Action.ENDIDES,\n  Action.ENDIDES,\n  Action.ENDIDES,\n  Action.ENDIDES,\n  Action.ENDIDES,\n  Action.ENDIDES,\n  Action.ENDIDES,\n  Action.ENDIDES, // 0x00-0x07\n  Action.ENDIDES,\n  Action.CHKPOSS,\n  Action.ENDIDES,\n  Action.ENDIDES,\n  Action.ENDIDES,\n  Action.ENDIDES,\n  Action.ENDIDES,\n  Action.ENDIDES, // 0x08-0x0F\n  Action.ENDIDES,\n  Action.ENDIDES,\n  Action.ENDIDES,\n  Action.ENDIDES,\n  Action.ENDIDES,\n  Action.ENDIDES,\n  Action.ENDIDES,\n  Action.ENDIDES, // 0x10-0x17\n  Action.ENDIDES,\n  Action.ENDIDES,\n  Action.ENDIDES,\n  Action.ENDIDES,\n  Action.ENDIDES,\n  Action.ENDIDES,\n  Action.ENDIDES,\n  Action.ENDIDES, // 0x18-0x1F\n  Action.CHKPOSS,\n  Action.ENDIDES,\n  Action.ENDIDES,\n  Action.ENDIDES,\n  Action.ENDIDES,\n  Action.ENDIDES,\n  Action.ENDIDES,\n  Action.ENDIDES, // 0x20-0x27\n  Action.FUNCES,\n  Action.ENDIDES,\n  Action.ENDIDES,\n  Action.ENDIDES,\n  Action.ENDIDES,\n  Action.ENDIDES,\n  Action.ENDIDES,\n  Action.ENDIDES, // 0x28-0x2F\n  Action.CONT,\n  Action.CONT,\n  Action.CONT,\n  Action.CONT,\n  Action.CONT,\n  Action.CONT,\n  Action.CONT,\n  Action.CONT, // 0x30-0x37\n  Action.CONT,\n  Action.CONT,\n  Action.ENDIDES,\n  Action.ENDIDES,\n  Action.ENDIDES,\n  Action.ENDIDES,\n  Action.ENDIDES,\n  Action.ENDIDES, // 0x38-0x3F\n  Action.ENDIDES,\n  Action.CONT,\n  Action.CONT,\n  Action.CONT,\n  Action.CONT,\n  Action.CONT,\n  Action.CONT,\n  Action.CONT, // 0x40-0x47\n  Action.CONT,\n  Action.CONT,\n  Action.CONT,\n  Action.CONT,\n  Action.CONT,\n  Action.CONT,\n  Action.CONT,\n  Action.CONT, // 0x48-0x4F\n  Action.CONT,\n  Action.CONT,\n  Action.CONT,\n  Action.CONT,\n  Action.CONT,\n  Action.CONT,\n  Action.CONT,\n  Action.CONT, // 0x50-0x57\n  Action.CONT,\n  Action.CONT,\n  Action.CONT,\n  Action.ENDIDES,\n  Action.IDNTESC,\n  Action.ENDIDES,\n  Action.ENDIDES,\n  Action.CONT, // 0x58-0x5F\n  Action.ENDIDES,\n  Action.CONT,\n  Action.CONT,\n  Action.CONT,\n  Action.CONT,\n  Action.CONT,\n  Action.CONT,\n  Action.CONT, // 0x60-0x67\n  Action.CONT,\n  Action.CONT,\n  Action.CONT,\n  Action.CONT,\n  Action.CONT,\n  Action.CONT,\n  Action.CONT,\n  Action.CONT, // 0x68-0x6F\n  Action.CONT,\n  Action.CONT,\n  Action.CONT,\n  Action.CONT,\n  Action.CONT,\n  Action.CONT,\n  Action.CONT,\n  Action.CONT, // 0x70-0x77\n  Action.CONT,\n  Action.CONT,\n  Action.CONT,\n  Action.ENDIDES,\n  Action.ENDIDES,\n  Action.ENDIDES,\n  Action.ENDIDES,\n  Action.ENDIDES, // 0x78-0x7F\n];\n\nactionsIdentEsc[NaN] = Action.ENDIDES;\n\n/**\n * Inside integer\n */\nexport const actionsInt: Action[] = [\n  Action.ENDINT,\n  Action.ENDINT,\n  Action.ENDINT,\n  Action.ENDINT,\n  Action.ENDINT,\n  Action.ENDINT,\n  Action.ENDINT,\n  Action.ENDINT, // 0x00-0x07\n  Action.ENDINT,\n  Action.ENDINT,\n  Action.ENDINT,\n  Action.ENDINT,\n  Action.ENDINT,\n  Action.ENDINT,\n  Action.ENDINT,\n  Action.ENDINT, // 0x08-0x0F\n  Action.ENDINT,\n  Action.ENDINT,\n  Action.ENDINT,\n  Action.ENDINT,\n  Action.ENDINT,\n  Action.ENDINT,\n  Action.ENDINT,\n  Action.ENDINT, // 0x10-0x17\n  Action.ENDINT,\n  Action.ENDINT,\n  Action.ENDINT,\n  Action.ENDINT,\n  Action.ENDINT,\n  Action.ENDINT,\n  Action.ENDINT,\n  Action.ENDINT, // 0x18-0x1F\n  Action.ENDINT,\n  Action.ENDINT,\n  Action.ENDINT,\n  Action.ENDINT,\n  Action.ENDINT,\n  Action.PCUNIT,\n  Action.ENDINT,\n  Action.ENDINT, // 0x20-0x27\n  Action.ENDINT,\n  Action.ENDINT,\n  Action.ENDINT,\n  Action.ENDINT,\n  Action.ENDINT,\n  Action.ENDINT,\n  Action.NUMBER,\n  Action.ENDINT, // 0x28-0x2F\n  Action.CONT,\n  Action.CONT,\n  Action.CONT,\n  Action.CONT,\n  Action.CONT,\n  Action.CONT,\n  Action.CONT,\n  Action.CONT, // 0x30-0x37\n  Action.CONT,\n  Action.CONT,\n  Action.ENDINT,\n  Action.ENDINT,\n  Action.ENDINT,\n  Action.ENDINT,\n  Action.ENDINT,\n  Action.ENDINT, // 0x38-0x3F\n  Action.ENDINT,\n  Action.UNIT,\n  Action.UNIT,\n  Action.UNIT,\n  Action.UNIT,\n  Action.UNIT,\n  Action.UNIT,\n  Action.UNIT, // 0x40-0x47\n  Action.UNIT,\n  Action.UNIT,\n  Action.UNIT,\n  Action.UNIT,\n  Action.UNIT,\n  Action.UNIT,\n  Action.UNIT,\n  Action.UNIT, // 0x48-0x4F\n  Action.UNIT,\n  Action.UNIT,\n  Action.UNIT,\n  Action.UNIT,\n  Action.UNIT,\n  Action.UNIT,\n  Action.UNIT,\n  Action.UNIT, // 0x50-0x57\n  Action.UNIT,\n  Action.UNIT,\n  Action.UNIT,\n  Action.ENDINT,\n  Action.ENDINT,\n  Action.ENDINT,\n  Action.ENDINT,\n  Action.UNIT, // 0x58-0x5F\n  Action.ENDINT,\n  Action.UNIT,\n  Action.UNIT,\n  Action.UNIT,\n  Action.UNIT,\n  Action.UNIT,\n  Action.UNIT,\n  Action.UNIT, // 0x60-0x67\n  Action.UNIT,\n  Action.UNIT,\n  Action.UNIT,\n  Action.UNIT,\n  Action.UNIT,\n  Action.UNIT,\n  Action.UNIT,\n  Action.UNIT, // 0x68-0x6F\n  Action.UNIT,\n  Action.UNIT,\n  Action.UNIT,\n  Action.UNIT,\n  Action.UNIT,\n  Action.UNIT,\n  Action.UNIT,\n  Action.UNIT, // 0x70-0x77\n  Action.UNIT,\n  Action.UNIT,\n  Action.UNIT,\n  Action.ENDINT,\n  Action.ENDINT,\n  Action.ENDINT,\n  Action.ENDINT,\n  Action.ENDINT, // 0x78-0x7F\n];\n\nactionsInt[NaN] = Action.ENDINT;\n\n/**\n * inside real, after dot\n */\nexport const actionsNumber: Action[] = [\n  Action.ENDNUM,\n  Action.ENDNUM,\n  Action.ENDNUM,\n  Action.ENDNUM,\n  Action.ENDNUM,\n  Action.ENDNUM,\n  Action.ENDNUM,\n  Action.ENDNUM, // 0x00-0x07\n  Action.ENDNUM,\n  Action.ENDNUM,\n  Action.ENDNUM,\n  Action.ENDNUM,\n  Action.ENDNUM,\n  Action.ENDNUM,\n  Action.ENDNUM,\n  Action.ENDNUM, // 0x08-0x0F\n  Action.ENDNUM,\n  Action.ENDNUM,\n  Action.ENDNUM,\n  Action.ENDNUM,\n  Action.ENDNUM,\n  Action.ENDNUM,\n  Action.ENDNUM,\n  Action.ENDNUM, // 0x10-0x17\n  Action.ENDNUM,\n  Action.ENDNUM,\n  Action.ENDNUM,\n  Action.ENDNUM,\n  Action.ENDNUM,\n  Action.ENDNUM,\n  Action.ENDNUM,\n  Action.ENDNUM, // 0x18-0x1F\n  Action.ENDNUM,\n  Action.ENDNUM,\n  Action.ENDNUM,\n  Action.ENDNUM,\n  Action.ENDNUM,\n  Action.PCUNIT,\n  Action.ENDNUM,\n  Action.ENDNUM, // 0x20-0x27\n  Action.ENDNUM,\n  Action.ENDNUM,\n  Action.ENDNUM,\n  Action.ENDNUM,\n  Action.ENDNUM,\n  Action.ENDNUM,\n  Action.ENDNUM,\n  Action.ENDNUM, // 0x28-0x2F\n  Action.CONT,\n  Action.CONT,\n  Action.CONT,\n  Action.CONT,\n  Action.CONT,\n  Action.CONT,\n  Action.CONT,\n  Action.CONT, // 0x30-0x37\n  Action.CONT,\n  Action.CONT,\n  Action.ENDNUM,\n  Action.ENDNUM,\n  Action.ENDNUM,\n  Action.ENDNUM,\n  Action.ENDNUM,\n  Action.ENDNUM, // 0x38-0x3F\n  Action.ENDNUM,\n  Action.UNIT,\n  Action.UNIT,\n  Action.UNIT,\n  Action.UNIT,\n  Action.UNIT,\n  Action.UNIT,\n  Action.UNIT, // 0x40-0x47\n  Action.UNIT,\n  Action.UNIT,\n  Action.UNIT,\n  Action.UNIT,\n  Action.UNIT,\n  Action.UNIT,\n  Action.UNIT,\n  Action.UNIT, // 0x48-0x4F\n  Action.UNIT,\n  Action.UNIT,\n  Action.UNIT,\n  Action.UNIT,\n  Action.UNIT,\n  Action.UNIT,\n  Action.UNIT,\n  Action.UNIT, // 0x50-0x57\n  Action.UNIT,\n  Action.UNIT,\n  Action.UNIT,\n  Action.ENDNUM,\n  Action.ENDNUM,\n  Action.ENDNUM,\n  Action.ENDNUM,\n  Action.UNIT, // 0x58-0x5F\n  Action.ENDNUM,\n  Action.UNIT,\n  Action.UNIT,\n  Action.UNIT,\n  Action.UNIT,\n  Action.UNIT,\n  Action.UNIT,\n  Action.UNIT, // 0x60-0x67\n  Action.UNIT,\n  Action.UNIT,\n  Action.UNIT,\n  Action.UNIT,\n  Action.UNIT,\n  Action.UNIT,\n  Action.UNIT,\n  Action.UNIT, // 0x68-0x6F\n  Action.UNIT,\n  Action.UNIT,\n  Action.UNIT,\n  Action.UNIT,\n  Action.UNIT,\n  Action.UNIT,\n  Action.UNIT,\n  Action.UNIT, // 0x70-0x77\n  Action.UNIT,\n  Action.UNIT,\n  Action.UNIT,\n  Action.ENDNUM,\n  Action.ENDNUM,\n  Action.ENDNUM,\n  Action.ENDNUM,\n  Action.ENDNUM, // 0x78-0x7F\n];\n\nactionsNumber[NaN] = Action.ENDNUM;\n\nexport const actionsCheckEq: Action[] = makeActions(Action.END, [\n  61 /*=*/,\n  Action.EQTAIL,\n]);\n\nexport const actionsColon: Action[] = makeActions(Action.END, [\n  58 /*:*/,\n  Action.COL_COL,\n]);\n\nexport const actionsBar: Action[] = makeActions(Action.END, [\n  61 /*=*/,\n  Action.EQTAIL,\n  124 /*|*/,\n  Action.BAR_BAR,\n]);\n\nexport const actionsAmp: Action[] = makeActions(Action.END, [\n  38 /*&*/,\n  Action.AMP_AMP,\n]);\n\nexport const actionsSlash: Action[] = makeActions(Action.END, [\n  42 /* * */,\n  Action.COMMENT,\n]);\n\nexport const actionsComment: Action[] = makeActions(Action.CONT, [\n  42 /* * */,\n  Action.COMMST,\n]);\n\nexport const actionsCommentStar: Action[] = makeActions(Action.COMMENT, [\n  42 /* * */,\n  Action.COMMST,\n  47 /* / */,\n  Action.ENDNOTK,\n]);\n\nexport const actionsMinusMinus: Action[] = makeActions(Action.KILL1, [\n  62 /* > */,\n  Action.CDC,\n]);\n\nexport const actionsLt: Action[] = makeActions(Action.END, [\n  61 /*=*/,\n  Action.EQTAIL,\n  33 /*!*/,\n  Action.LT_BG,\n]);\n\nexport const actionsLtBang: Action[] = makeActions(Action.KILL1, [\n  45 /*-*/,\n  Action.LT_BG_M,\n]);\n\nexport const actionsLtBangMinus: Action[] = makeActions(Action.KILL2, [\n  45 /*-*/,\n  Action.CDO,\n]);\n\nexport const actionsIdentEscChr: Action[] = makeActions(Action.IDESCH, [\n  10 /*LF*/,\n  Action.INVALID,\n  13 /*CR*/,\n  Action.INVALID,\n]);\n\nexport const actionsStr1: Action[] = makeActions(Action.CONT, [\n  39 /*'*/,\n  Action.ENDSTR,\n  10 /*LF*/,\n  Action.INVALID,\n  13 /*CR*/,\n  Action.INVALID,\n  92 /*\\*/,\n  Action.STR1ESC,\n]);\n\nexport const actionsStr2: Action[] = makeActions(Action.CONT, [\n  34 /*\"*/,\n  Action.ENDSTR,\n  10 /*LF*/,\n  Action.INVALID,\n  13 /*CR*/,\n  Action.INVALID,\n  92 /*\\*/,\n  Action.STR2ESC,\n]);\n\nexport const actionsStr1Esc: Action[] = makeActions(Action.CONT, [\n  39 /*'*/,\n  Action.ENDESTR,\n  10 /*LF*/,\n  Action.CHKPOSN,\n  13 /*CR*/,\n  Action.CHKPOSN,\n  92 /*\\*/,\n  Action.STR1ESC,\n]);\n\nexport const actionsStr2Esc: Action[] = makeActions(Action.CONT, [\n  34 /*\"*/,\n  Action.ENDESTR,\n  10 /*LF*/,\n  Action.CHKPOSN,\n  13 /*CR*/,\n  Action.CHKPOSN,\n  92 /*\\*/,\n  Action.STR2ESC,\n]);\n\nexport const actionsURL: Action[] = makeActions(Action.URL, [\n  9 /*tab*/,\n  Action.CONT,\n  32 /*sp*/,\n  Action.CONT,\n  34 /*\"*/,\n  Action.URL2,\n  39 /*'*/,\n  Action.URL1,\n  41 /*)*/,\n  Action.INVALID,\n  10 /*LF*/,\n  Action.CONT,\n  13 /*CR*/,\n  Action.CONT,\n]);\n\nexport const actionsURLInside: Action[] = makeActions(Action.CONT, [\n  41 /*)*/,\n  Action.ENDURL,\n  9 /*TAB*/,\n  Action.CHKSP,\n  10 /*LF*/,\n  Action.CHKSP,\n  13 /*CR*/,\n  Action.CHKSP,\n  32 /*sp*/,\n  Action.CHKSP,\n  92 /*\\*/,\n  Action.URLESC,\n  40 /*(*/,\n  Action.INVALID,\n  91 /*[*/,\n  Action.INVALID,\n  93 /*]*/,\n  Action.INVALID,\n  123 /*{*/,\n  Action.INVALID,\n  125 /*}*/,\n  Action.INVALID,\n  NaN,\n  Action.ENDURL,\n]);\n\nexport const actionsURLInside1: Action[] = makeActions(Action.CONT, [\n  39 /*'*/,\n  Action.TERMURL,\n  10 /*LF*/,\n  Action.CHKPOSN,\n  13 /*CR*/,\n  Action.CHKPOSN,\n  92 /*\\*/,\n  Action.URLESC,\n  NaN,\n  Action.ENDURL,\n]);\n\nexport const actionsURLInside2: Action[] = makeActions(Action.CONT, [\n  34 /*\"*/,\n  Action.TERMURL,\n  10 /*LF*/,\n  Action.CHKPOSN,\n  13 /*CR*/,\n  Action.CHKPOSN,\n  92 /*\\*/,\n  Action.URLESC,\n  NaN,\n  Action.ENDURL,\n]);\n\nexport const actionsURLTail: Action[] = makeActions(Action.INVALID, [\n  9 /*tab*/,\n  Action.CONT,\n  10 /*LF*/,\n  Action.CONT,\n  13 /*CR*/,\n  Action.CONT,\n  32 /*sp*/,\n  Action.CONT,\n  41 /*)*/,\n  Action.FINURL,\n]);\n\nexport const INITIAL_INDEX_MASK = 15;\n\nexport class Tokenizer {\n  indexMask: number;\n  buffer: Token[];\n  tail: number = 0; // available, ready to write\n  curr: number = 0; // ready to read\n  position: number = 0;\n\n  constructor(\n    public input: string,\n    public readonly handler: TokenizerHandler,\n  ) {\n    this.indexMask = INITIAL_INDEX_MASK;\n    this.buffer = Array(this.indexMask + 1);\n    for (let i = 0; i <= this.indexMask; i++) {\n      this.buffer[i] = new Token();\n    }\n  }\n\n  token(): Token {\n    if (this.tail == this.curr) {\n      this.fillBuffer();\n    }\n    return this.buffer[this.curr];\n  }\n\n  nthToken(n: number): Token {\n    if (((this.tail - this.curr) & this.indexMask) <= n) {\n      this.fillBuffer();\n    }\n    return this.buffer[(this.curr + n) & this.indexMask];\n  }\n\n  consume(): void {\n    this.curr = (this.curr + 1) & this.indexMask;\n  }\n\n  private fillBuffer(): void {\n    let tail = this.tail;\n    let head = this.curr;\n    let indexMask = this.indexMask;\n    if (tail >= head) {\n      head += indexMask;\n    } else {\n      head--;\n    }\n    if (head == tail) {\n      throw new Error(\"F_CSSTOK_INTERNAL\");\n    }\n    let actions = actionsNormal;\n    const input = this.input;\n    let position = this.position;\n    const buffer = this.buffer;\n    let tokenType: TokenType = TokenType.EOF;\n    let tokenPosition: number = 0;\n    let tokenText: string = \"\";\n    let tokenNum: number = 0;\n    let seenSpace = false;\n    let token: Token = buffer[tail];\n    let backslashPos = -9; // far enough before the start of the string\n    while (true) {\n      const charCode = input.charCodeAt(position);\n      switch (actions[charCode] || actions[65] /*A*/) {\n        case Action.INVALID:\n          tokenText = input.substring(tokenPosition, position);\n          if (isNaN(charCode)) {\n            // unclosed comment `/***[EOF]`, unclosed string `\"**[EOF]`\n            tokenType = TokenType.EOF;\n          } else {\n            // invalid, e.g, `.` in `:nth-child([.])` (Issue #597)\n            tokenType = TokenType.INVALID;\n          }\n          actions = actionsNormal;\n          break;\n        case Action.SPACE:\n          position++;\n          seenSpace = true;\n          continue;\n        case Action.INT:\n          tokenPosition = position++;\n          actions = actionsInt;\n          continue;\n        case Action.IDENT:\n          tokenType = TokenType.IDENT;\n          tokenPosition = position++;\n          actions = actionsIdent;\n          continue;\n        case Action.BANG:\n          tokenPosition = position++;\n          tokenType = TokenType.BANG;\n          actions = actionsCheckEq;\n          continue;\n        case Action.STR1:\n          tokenType = TokenType.STR;\n          tokenPosition = ++position; // after quote\n          actions = actionsStr1;\n          continue;\n        case Action.STR2:\n          tokenType = TokenType.STR;\n          tokenPosition = ++position; // after quote\n          actions = actionsStr2;\n          continue;\n        case Action.HASH:\n          tokenPosition = ++position; // after hash\n          tokenType = TokenType.HASH;\n          actions = actionsIdent;\n          continue;\n        case Action.DOLLAR:\n          tokenPosition = position++;\n          tokenType = TokenType.DOLLAR;\n          actions = actionsCheckEq;\n          continue;\n        case Action.PERCENT:\n          tokenPosition = position++;\n          tokenType = TokenType.PERCENT;\n          break;\n        case Action.AMP:\n          tokenPosition = position++;\n          tokenType = TokenType.DOLLAR;\n          actions = actionsAmp;\n          continue;\n        case Action.O_PAR:\n          tokenPosition = position++;\n          tokenType = TokenType.O_PAR;\n          break;\n        case Action.C_PAR:\n          tokenPosition = position++;\n          tokenType = TokenType.C_PAR;\n          break;\n        case Action.STAR:\n          tokenPosition = position++;\n          tokenType = TokenType.STAR;\n          actions = actionsCheckEq;\n          continue;\n        case Action.PLUS:\n          tokenPosition = position++;\n          tokenType = TokenType.PLUS;\n          break;\n        case Action.COMMA:\n          tokenPosition = position++;\n          tokenType = TokenType.COMMA;\n          break;\n        case Action.MINUS:\n          tokenType = TokenType.MINUS;\n          tokenPosition = position++;\n          actions = actionsMinus;\n          continue;\n        case Action.DOT:\n          tokenPosition = position++;\n          actions = actionsNumOrClass;\n          continue;\n        case Action.TOCLASS:\n          tokenPosition = position++;\n          tokenType = TokenType.CLASS;\n          actions = actionsIdent;\n          continue;\n        case Action.SLASH:\n          tokenPosition = position++;\n          tokenType = TokenType.SLASH;\n          actions = actionsSlash;\n          continue;\n        case Action.COLON:\n          tokenPosition = position++;\n          tokenType = TokenType.COLON;\n          actions = actionsColon;\n          continue;\n        case Action.COL_COL:\n          position++;\n          tokenType = TokenType.COL_COL;\n          break;\n        case Action.SEMICOL:\n          tokenPosition = position++;\n          tokenType = TokenType.SEMICOL;\n          break;\n        case Action.LT:\n          tokenPosition = position++;\n          tokenType = TokenType.LT;\n          actions = actionsLt;\n          continue;\n        case Action.EQ:\n          tokenPosition = position++;\n          tokenType = TokenType.EQ;\n          actions = actionsCheckEq;\n          continue;\n        case Action.GT:\n          tokenPosition = position++;\n          tokenType = TokenType.GT;\n          actions = actionsCheckEq;\n          continue;\n        case Action.QMARK:\n          tokenPosition = position++;\n          tokenType = TokenType.QMARK;\n          break;\n        case Action.AT:\n          tokenPosition = ++position; // after \"at\" sign\n          tokenType = TokenType.AT;\n          actions = actionsIdent;\n          continue;\n        case Action.O_BRK:\n          tokenPosition = position++;\n          tokenType = TokenType.O_BRK;\n          break;\n        case Action.C_BRK:\n          tokenPosition = position++;\n          tokenType = TokenType.C_BRK;\n          break;\n        case Action.O_BRC:\n          tokenPosition = position++;\n          tokenType = TokenType.O_BRC;\n          break;\n        case Action.C_BRC:\n          tokenPosition = position++;\n          tokenType = TokenType.C_BRC;\n          break;\n        case Action.BSLASH:\n          tokenPosition = position++;\n          backslashPos = tokenPosition;\n          tokenType = TokenType.IDENT;\n          actions = actionsIdentEscChr;\n          continue;\n        case Action.HAT:\n          tokenPosition = position++;\n          tokenType = TokenType.HAT;\n          actions = actionsCheckEq;\n          continue;\n        case Action.BAR:\n          tokenPosition = position++;\n          tokenType = TokenType.BAR;\n          actions = actionsBar;\n          continue;\n        case Action.TILDE:\n          tokenPosition = position++;\n          tokenType = TokenType.TILDE;\n          actions = actionsCheckEq;\n          continue;\n        case Action.END:\n          // don't consume current char\n          break;\n        case Action.EQTAIL:\n          position++;\n          tokenType = (tokenType +\n            TokenType.BANG_EQ -\n            TokenType.BANG) as TokenType;\n          break;\n        case Action.ENDINT:\n          // don't consume current char\n          tokenType = TokenType.INT;\n          tokenNum = parseInt(input.substring(tokenPosition, position), 10);\n          break;\n        case Action.ENDNUM:\n          // don't consume current char\n          tokenType = TokenType.NUM;\n          tokenNum = parseFloat(input.substring(tokenPosition, position));\n          break;\n        case Action.CONT:\n          // just consume current char\n          position++;\n          continue;\n        case Action.UNIT:\n          tokenType = TokenType.NUMERIC;\n          tokenNum = parseFloat(input.substring(tokenPosition, position));\n          tokenPosition = position++;\n          actions = actionsIdent;\n          continue;\n        case Action.PCUNIT:\n          tokenType = TokenType.NUMERIC;\n          tokenNum = parseFloat(input.substring(tokenPosition, position));\n          tokenText = \"%\";\n          tokenPosition = position++; // for consistency with alphabetic units\n          break;\n        case Action.NUMBER:\n          position++;\n          actions = actionsNumber;\n          continue;\n        case Action.ENDIDNT:\n          // don't consume current char\n          // tokenType should be set already\n          tokenText = escapeParse(input.substring(tokenPosition, position));\n\n          // unicode-range support\n          if (\n            (tokenType === TokenType.URANGE && charCode === 63) ||\n            (tokenType === TokenType.IDENT &&\n              tokenText.toLowerCase() === \"u\" &&\n              /^(\\bu\\+[?0-9a-f]+(-[?0-9a-f]+)?|,|\\s+|\\/\\*([^*]|\\*[^/])*\\*\\/)+[;}]/i.test(\n                input.substring(position - 1),\n              ))\n          ) {\n            tokenType = TokenType.URANGE;\n            position++;\n            continue;\n          }\n          break;\n        case Action.IDNTESC:\n          backslashPos = position++;\n          actions = actionsIdentEscChr;\n          continue;\n        case Action.ENDIDES:\n          // end of identifier with escapes\n          // don't consume current char\n          // tokenType should be set already\n          tokenText = escapeParse(input.substring(tokenPosition, position));\n          break;\n        case Action.ENDSTR:\n          tokenText = input.substring(tokenPosition, position); // consume closing quote\n          position++;\n          break;\n        case Action.ENDESTR:\n          tokenText = escapeParse(input.substring(tokenPosition, position)); // consume closing quote\n          position++;\n          break;\n        case Action.STR1ESC:\n          backslashPos = position;\n          position += 2; // consume character after backslash in any case\n          actions = actionsStr1Esc;\n          continue;\n        case Action.STR2ESC:\n          backslashPos = position;\n          position += 2; // consume character after backslash in any case\n          actions = actionsStr2Esc;\n          continue;\n        case Action.BAR_BAR:\n          position++;\n          tokenType = TokenType.BAR_BAR;\n          break;\n        case Action.AMP_AMP:\n          position++;\n          tokenType = TokenType.AMP_AMP;\n          break;\n        case Action.FUNC:\n          // tokenType can be TokenType.IDENT,\n          // TokenType.CLASS, TokenType.AT,\n          // TokenType.HASH, TokenType.NUMERIC\n          tokenText = input.substring(tokenPosition, position);\n          if (tokenType == TokenType.IDENT) {\n            position++; // consume\n            if (tokenText.toLowerCase() == \"url\") {\n              actions = actionsURL;\n              continue;\n            }\n            tokenType = TokenType.FUNC;\n          }\n          break;\n        case Action.FUNCES:\n          // tokenType can be TokenType.IDENT,\n          // TokenType.CLASS, TokenType.AT,\n          // TokenType.HASH, T_NUMERIC\n          tokenText = escapeParse(input.substring(tokenPosition, position));\n          if (tokenType == TokenType.IDENT) {\n            position++; // consume\n            if (tokenText.toLowerCase() == \"url\") {\n              actions = actionsURL;\n              continue;\n            }\n            tokenType = TokenType.FUNC;\n          }\n          break;\n        case Action.COMMENT:\n          actions = actionsComment;\n          position++;\n          continue;\n        case Action.COMMST:\n          actions = actionsCommentStar;\n          position++;\n          continue;\n        case Action.ENDNOTK:\n          actions = actionsNormal;\n          position++;\n          continue;\n        case Action.MINMIN:\n          actions = actionsMinusMinus;\n          position++;\n          if (input[position] !== \">\") {\n            // dashed-ident (custom property name)\n            tokenType = TokenType.IDENT;\n            actions = actionsIdent;\n          }\n          continue;\n        case Action.CDO:\n          tokenType = TokenType.CDO;\n          tokenText = input.substring(tokenPosition, ++position);\n          actions = actionsNormal;\n          break;\n        case Action.CDC:\n          tokenType = TokenType.CDC;\n          tokenText = input.substring(tokenPosition, ++position);\n          actions = actionsNormal;\n          break;\n        case Action.TOINT:\n          tokenType = TokenType.INT;\n          actions = actionsInt;\n          position++;\n          continue;\n        case Action.TONUM:\n          tokenType = TokenType.NUM;\n          actions = actionsNumber;\n          position++;\n          continue;\n        case Action.TOIDENT:\n          tokenType = TokenType.IDENT;\n          actions = actionsIdent;\n          position++;\n          continue;\n        case Action.TOIDES:\n          tokenType = TokenType.IDENT;\n          actions = actionsIdentEscChr;\n          backslashPos = position++;\n          continue;\n        case Action.KILL1:\n          position--;\n          break;\n        case Action.KILL2:\n          position -= 2;\n          break;\n        case Action.URL:\n          tokenPosition = position++;\n          actions = actionsURLInside;\n          continue;\n        case Action.URL1:\n          tokenPosition = ++position; // skip quote\n          actions = actionsURLInside1;\n          continue;\n        case Action.URL2:\n          tokenPosition = ++position; // skip quote\n          actions = actionsURLInside2;\n          continue;\n        case Action.ENDURL:\n          tokenType = TokenType.URL;\n          tokenText = escapeParse(input.substring(tokenPosition, position));\n          position++; // skip ')'\n          break;\n        case Action.FINURL:\n          position++; // skip ')'\n          break;\n        case Action.LT_BG:\n          actions = actionsLtBang;\n          position++;\n          continue;\n        case Action.LT_BG_M:\n          actions = actionsLtBangMinus;\n          position++;\n          continue;\n        case Action.CHKSP:\n          // newline in non-quoted URL - check if end of url\n          if (position - backslashPos < 8) {\n            // close enough: may be valid\n            if (\n              input\n                .substring(backslashPos + 1, position + 1)\n                .match(/^[0-9a-fA-F]{0,6}(\\r\\n|[\\n\\r])|[ \\t]$/)\n            ) {\n              // valid, keep going\n              position++;\n              continue;\n            }\n          }\n\n        // end of url\n        // fall through\n        case Action.TERMURL:\n          tokenType = TokenType.URL;\n          tokenText = escapeParse(input.substring(tokenPosition, position));\n          position++; // skip quote (or newline)\n          actions = actionsURLTail;\n          continue;\n        case Action.CHKPOSN:\n          // newline in string or quoted URL - check validity\n          position++;\n          if (position - backslashPos < 9) {\n            // close enough: may be valid\n            if (\n              input\n                .substring(backslashPos + 1, position)\n                .match(/^[0-9a-fA-F]{0,6}(\\r\\n|[\\n\\r])$/)\n            ) {\n              // valid, keep going\n              continue;\n            }\n          }\n\n          // invalid token\n          tokenType = TokenType.INVALID;\n          tokenText = \"E_CSS_UNEXPECTED_NEWLINE\";\n          actions = actionsNormal;\n          break;\n        case Action.CHKPOSS:\n          // space in identifier - check validity\n          if (position - backslashPos < 9) {\n            // close enough: may be valid\n            if (\n              input\n                .substring(backslashPos + 1, position + 1)\n                .match(/^[0-9a-fA-F]{0,6}[ \\t]$/)\n            ) {\n              // valid, keep going\n              position++;\n              actions = actionsIdent;\n              continue;\n            }\n          }\n\n          // end of identifier\n          // don't consume current char\n          // tokenType should be set already\n          tokenText = escapeParse(input.substring(tokenPosition, position));\n          break;\n        case Action.URLESC:\n          backslashPos = position++;\n          continue;\n        case Action.IDESCH:\n          position++;\n          actions = actionsIdentEsc;\n          continue;\n        default:\n          // EOF\n          if (actions !== actionsNormal) {\n            tokenType = TokenType.INVALID;\n            tokenText = \"E_CSS_UNEXPECTED_STATE\";\n            break;\n          }\n          tokenPosition = position;\n          tokenType = TokenType.EOF;\n      }\n      token.type = tokenType;\n      token.precededBySpace = seenSpace;\n      token.num = tokenNum;\n      token.text = tokenText;\n      token.position = tokenPosition;\n      tail++;\n      if (tail >= head) {\n        break;\n      }\n      actions = actionsNormal;\n      seenSpace = false;\n      token = buffer[tail & indexMask];\n    }\n    this.position = position;\n    this.tail = tail & indexMask;\n  }\n}\n", "/**\n * Copyright 2013 Google, Inc.\n * Copyright 2015 Daishinsha Inc.\n * Copyright 2019 Vivliostyle Foundation\n *\n * Vivliostyle.js is free software: you can redistribute it and/or modify\n * it under the terms of the GNU Affero General Public License as published by\n * the Free Software Foundation, either version 3 of the License, or\n * (at your option) any later version.\n *\n * Vivliostyle.js is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n * GNU Affero General Public License for more details.\n *\n * You should have received a copy of the GNU Affero General Public License\n * along with Vivliostyle.js.  If not, see <http://www.gnu.org/licenses/>.\n *\n * @fileoverview Task - Support for asynchronous execution and cooperative\n * multitasking.\n */\nimport * as Base from \"./base\";\nimport * as Logging from \"./logging\";\n\n/**\n * External timer. Only needed for testing.\n */\nexport interface Timer {\n  /**\n   * @return current time in milliseconds.\n   */\n  currentTime(): number;\n\n  /**\n   * Calls function after a given timeout.\n   * @param fn function to call.\n   * @param delay timeout in milliseconds.\n   * @return unique number that can be used to clear the timeout.\n   */\n  setTimeout(fn: () => void, delay: number): number;\n\n  /**\n   * Calls function after a given timeout.\n   * @param token timeout token.\n   */\n  clearTimeout(token: number): void;\n}\n\n/**\n * Result of an asynchronous function that may be available immediately or\n * some time later. Similar to Deferred.\n * @template T\n */\nexport interface Result<T> {\n  /**\n   * Call the given function when asynchronous function is finished. Callback\n   * is executed in the task's context.\n   */\n  then(callback: (p1: T) => void): void;\n\n  /**\n   * Call the given asynchronous function when some asynchronous function is\n   * finished. Callback is executed in the task's context.\n   * @template T1\n   */\n  thenAsync<T1>(callback: (p1: T) => Result<T1>): Result<T1>;\n\n  /**\n   * Produce a Result that resolves to the given value when this Result is\n   * resolved.\n   * @template T1\n   */\n  thenReturn<T1>(result: T1): Result<T1>;\n\n  /**\n   * Finish given frame with the result value when result becomes ready.\n   */\n  thenFinish(frame: Frame<T>): void;\n\n  /**\n   * Check if this Result is still pending.\n   */\n  isPending(): boolean;\n\n  /**\n   * If this Result is resolved, return the value that it holds.\n   */\n  get(): T | null;\n}\n\nexport let privateCurrentTask: Task | null = null;\n\nexport let primaryScheduler: Scheduler | null = null;\n\n/**\n * Returns current task.\n */\nexport function currentTask(): Task | null {\n  return privateCurrentTask;\n}\n\n/**\n * Create and return a new frame with the given name.\n */\nexport function newFrame<T>(name: string): Frame<T> {\n  if (!privateCurrentTask) {\n    throw new Error(\"E_TASK_NO_CONTEXT\");\n  }\n  if (!privateCurrentTask.name) {\n    privateCurrentTask.name = name;\n  }\n  const task = privateCurrentTask;\n  const frame = new Frame<T>(task, task.top, name);\n  task.top = frame;\n  frame.state = FrameState.ACTIVE;\n  return frame;\n}\n\nexport function newEventSource(): EventSource {\n  return new EventSource();\n}\n\nexport function newScheduler(opt_timer?: Timer): Scheduler {\n  return new Scheduler(opt_timer || new TimerImpl());\n}\n\n/**\n * @template T\n */\nexport function newResult<T>(opt_value: T): Result<T> {\n  return new SyncResultImpl<T>(opt_value);\n}\n\n/**\n * Creates a new frame and runs code in its context, catching synchronous and\n * asynchronous errors. If an error occurs, onErr is run (in the context of\n * the same frame). As usual, onErr is supposed either produce a result or raise\n * an exception.\n */\nexport function handle<T>(\n  name: any,\n  code: (p1: Frame<T>) => void,\n  onErr: (p1: Frame<T>, p2: Error) => void,\n): Result<T> {\n  const frame = newFrame<T>(name);\n  frame.handler = onErr;\n  try {\n    code(frame);\n  } catch (err) {\n    // synchronous exception\n    frame.task.raise(err as Error, frame);\n  }\n  return frame.result();\n}\n\nexport function start<T>(func: () => Result<T>, opt_name?: string): Task {\n  const scheduler = privateCurrentTask\n    ? privateCurrentTask.getScheduler()\n    : primaryScheduler || newScheduler();\n  return scheduler.run(func, opt_name);\n}\n\n/**\n * Frame state.\n * @enum {number}\n */\nexport enum FrameState {\n  INIT, // before newFrame call\n  ACTIVE, // before finish call\n  FINISHED, // before callback complete\n  DEAD, // when callback is complete\n}\nexport class TimerImpl implements Timer {\n  /** @override */\n  currentTime(): number {\n    return new Date().valueOf();\n  }\n\n  /** @override */\n  setTimeout(fn: () => void, delay: number) {\n    // HACK: casting to unknown type to prevent TypeScript error\n    // [TS2352] Conversion of type 'Timer' to type 'number' may be a mistake because neither type sufficiently overlaps with the other.\n    const timer: unknown = setTimeout(fn, delay);\n    return timer as number;\n  }\n\n  /** @override */\n  clearTimeout(token: number): void {\n    clearTimeout(token);\n  }\n}\n\n/**\n * A class to create tasks.\n */\nexport class Scheduler {\n  timeout: number = 1;\n  slice: number = 25;\n  sliceOverTime: number = 0;\n  queue: Base.PriorityQueue;\n  wakeupTime: number | null = null;\n  timeoutToken: number | null = null;\n  inTimeSlice: boolean = false;\n  order: number = 0;\n\n  constructor(public timer: Timer) {\n    this.queue = new Base.PriorityQueue();\n    if (!primaryScheduler) {\n      primaryScheduler = this;\n    }\n  }\n\n  /**\n   * Sets time slice length.\n   * @param slice length in milliseconds.\n   */\n  setSlice(slice: number) {\n    this.slice = slice;\n  }\n\n  /**\n   * Sets timeout between time slices.\n   * @param timeout in milliseconds.\n   */\n  setTimeout(timeout: number) {\n    this.timeout = timeout;\n  }\n\n  /**\n   * Checks if the current time slice is over.\n   */\n  isTimeSliceOver(): boolean {\n    const now = this.timer.currentTime();\n    return now >= this.sliceOverTime;\n  }\n\n  private arm(): void {\n    if (this.inTimeSlice) {\n      return;\n    }\n    const nextInQueue = this.queue.peek() as Continuation<any>;\n    const newTime = nextInQueue.scheduledTime;\n    const now = this.timer.currentTime();\n    if (this.timeoutToken != null) {\n      if (now + this.timeout > this.wakeupTime) {\n        return; // no use re-arming\n      }\n      this.timer.clearTimeout(this.timeoutToken);\n    }\n    let timeout = newTime - now;\n    if (timeout <= this.timeout) {\n      timeout = this.timeout;\n    }\n    this.wakeupTime = now + timeout;\n    this.timeoutToken = this.timer.setTimeout(() => {\n      this.timeoutToken = null;\n      this.doTimeSlice();\n    }, timeout);\n  }\n\n  schedule(continuation: Continuation<any>, opt_delay?: number): void {\n    const c = continuation as Continuation<any>;\n    const now = this.timer.currentTime();\n    c.order = this.order++;\n    c.scheduledTime = now + (opt_delay || 0);\n    this.queue.add(c);\n    this.arm();\n  }\n\n  private doTimeSlice(): void {\n    if (this.timeoutToken != null) {\n      this.timer.clearTimeout(this.timeoutToken);\n      this.timeoutToken = null;\n    }\n    this.inTimeSlice = true;\n    try {\n      let now = this.timer.currentTime();\n      this.sliceOverTime = now + this.slice;\n      while (this.queue.length()) {\n        const continuation = this.queue.peek() as Continuation<any>;\n        if (continuation.scheduledTime > now) {\n          break; // too early\n        }\n        this.queue.remove();\n        if (!continuation.canceled) {\n          continuation.resumeInternal();\n        }\n        now = this.timer.currentTime();\n        if (now >= this.sliceOverTime) {\n          break;\n        }\n      }\n    } catch (err) {\n      Logging.logger.error(err);\n    }\n    this.inTimeSlice = false;\n    if (this.queue.length()) {\n      this.arm();\n    }\n  }\n\n  run(func: () => Result<any>, opt_name?: string): Task {\n    const task = new Task(this, opt_name || \"\");\n    task.top = new Frame<any>(task, null, \"bootstrap\");\n    task.top.state = FrameState.ACTIVE;\n    task.top.then(() => {\n      const done = () => {\n        task.running = false;\n        for (const callback of task.callbacks) {\n          try {\n            callback();\n          } catch (err) {\n            Logging.logger.error(err);\n          }\n        }\n      };\n      try {\n        func().then((result) => {\n          task.result = result;\n          done();\n        });\n      } catch (err) {\n        task.raise(err as Error);\n        done();\n      }\n    });\n    const savedTask = privateCurrentTask;\n    privateCurrentTask = task;\n    this.schedule(task.top.suspend(\"bootstrap\"));\n    privateCurrentTask = savedTask;\n    return task;\n  }\n}\n\n/**\n * Task suspension point.\n * @template T\n */\nexport class Continuation<T> implements Base.Comparable {\n  scheduledTime: number = 0;\n  order: number = 0;\n  result: T = null;\n  canceled: boolean = false;\n\n  constructor(public task: Task) {}\n\n  /** @override */\n  compare(otherComp: Base.Comparable): number {\n    // earlier wins\n    const other = otherComp as Continuation<any>;\n    return other.scheduledTime - this.scheduledTime || other.order - this.order;\n  }\n\n  /**\n   * Continuation's task\n   */\n  getTask(): Task {\n    return this.task;\n  }\n\n  /**\n   * Schedule task continuation after the given (optional) delay.\n   * @param opt_delay optional delay in milliseconds.\n   */\n  schedule(result: T, opt_delay?: number) {\n    this.result = result;\n    this.task.scheduler.schedule(this, opt_delay);\n  }\n\n  resumeInternal(): boolean {\n    const task = this.task;\n    this.task = null;\n    if (task && task.continuation == this) {\n      task.continuation = null;\n      const savedTask = privateCurrentTask;\n      privateCurrentTask = task;\n      task.top.finish(this.result);\n      privateCurrentTask = savedTask;\n      return true;\n    }\n    return false;\n  }\n\n  /**\n   * Cancel continuation\n   */\n  cancel() {\n    this.canceled = true;\n  }\n}\n\n/**\n * An asynchronous, time-sliced task.\n */\nexport class Task {\n  callbacks: (() => void)[] = [];\n  exception: Error | null = null;\n  running: boolean = true;\n  result: any = null;\n  waitTarget: string | null = null;\n  top: Frame<any> | null = null;\n  continuation: Continuation<any> | null = null;\n\n  constructor(\n    public scheduler: Scheduler,\n    public name: string,\n  ) {}\n\n  /**\n   * @return task name.\n   */\n  getName(): string {\n    return this.name;\n  }\n\n  /**\n   * @param err exception to throw in the task's context.\n   */\n  interrupt(err: Error): void {\n    this.raise(err || new Error(\"E_TASK_INTERRUPT\"));\n    if (this !== privateCurrentTask && this.continuation) {\n      // blocked on something\n      this.continuation.cancel();\n      const continuation = new Continuation(this);\n      this.waitTarget = \"interrupt\";\n      this.continuation = continuation;\n      this.scheduler.schedule(continuation);\n    }\n  }\n\n  /**\n   * @return this task's scheduler.\n   */\n  getScheduler(): Scheduler {\n    return this.scheduler;\n  }\n\n  /**\n   * @return true if task is still running.\n   */\n  isRunning(): boolean {\n    return this.running;\n  }\n\n  /**\n   * Register a callback to be called when the task is done. Callback is not\n   * executed in any task context. Multiple callbacks can be registered and\n   * they will be called in the registration order.\n   */\n  whenDone(callback: () => void): void {\n    this.callbacks.push(callback);\n  }\n\n  /**\n   * Wait for task to finish (from another task).\n   */\n  join(): Result<any> {\n    const frame = newFrame<any>(\"Task.join\");\n    if (!this.running) {\n      frame.finish(this.result);\n    } else {\n      const continuation = frame.suspend(this);\n      this.whenDone(() => {\n        continuation.schedule(this.result);\n      });\n    }\n    return frame.result();\n  }\n\n  /**\n   * Unwind the stack. We have two stacks: async (maintained by frame\n   * parent link) and sync (regular JavaScript stack).\n   */\n  unwind() {\n    // We have a sequence of frames on the stack.\n    while (this.top && !this.top.handler) {\n      this.top = this.top.parent;\n    }\n    if (this.top && this.top.handler && this.exception) {\n      // found a handler\n      const err = this.exception;\n      this.exception = null;\n      this.top.handler(this.top, err);\n    } else {\n      if (this.exception) {\n        Logging.logger.error(\n          this.exception,\n          \"Unhandled exception in task\",\n          this.name,\n        );\n      }\n    }\n  }\n\n  raise(err: Error, opt_frame?: Frame<any>): void {\n    this.fillStack(err);\n    if (opt_frame) {\n      let f = this.top;\n      while (f && f != opt_frame) {\n        f = f.parent;\n      }\n      if (f == opt_frame) {\n        this.top = f;\n      }\n    }\n    this.exception = err;\n    this.unwind();\n  }\n\n  /**\n   * Fill the stack trace in the exception\n   * @param err exception\n   */\n  fillStack(err: Error) {\n    let out = err[\"frameTrace\"];\n    if (!out) {\n      out = err[\"stack\"] ? `${err[\"stack\"]}\\n\\t---- async ---\\n` : \"\";\n      for (let f = this.top; f; f = f.parent) {\n        out += \"\\t\";\n        out += f.getName();\n        out += \"\\n\";\n      }\n      err[\"frameTrace\"] = out;\n    }\n  }\n}\n\n/**\n * @template T\n */\nexport class SyncResultImpl<T> implements Result<T> {\n  constructor(public value: T) {}\n\n  /** @override */\n  then(callback: (T: any) => void) {\n    callback(this.value);\n  }\n\n  /** @override */\n  thenAsync<T1>(callback: (p1: T) => Result<T1>) {\n    return callback(this.value);\n  }\n\n  /** @override */\n  thenReturn<T1>(result: T1) {\n    return new SyncResultImpl(result);\n  }\n\n  /** @override */\n  thenFinish(frame: Frame<T>): void {\n    frame.finish(this.value);\n  }\n\n  /** @override */\n  isPending(): boolean {\n    return false;\n  }\n\n  /** @override */\n  get(): T | null {\n    return this.value;\n  }\n}\n\n/**\n * @template T\n */\nexport class ResultImpl<T> implements Result<T> {\n  constructor(public readonly frame: Frame<T>) {}\n\n  /** @override */\n  then(callback: (p1: T) => void): void {\n    this.frame.then(callback);\n  }\n\n  /** @override */\n  thenAsync<T1>(callback: (p1: T) => Result<T1>): Result<T1> {\n    if (this.isPending()) {\n      // thenAsync is special, do the trick with the context\n      const frame = new Frame<T | T1>(\n        this.frame.task,\n        this.frame.parent,\n        \"AsyncResult.thenAsync\",\n      );\n      frame.state = FrameState.ACTIVE;\n      this.frame.parent = frame as Frame<T>;\n      this.frame.then((res1) => {\n        callback(res1).then((res2) => {\n          frame.finish(res2);\n        });\n      });\n      return frame.result() as Result<T1>;\n    } else {\n      return callback(this.frame.res);\n    }\n  }\n\n  /** @override */\n  thenReturn<T1>(result: T1) {\n    if (this.isPending()) {\n      return this.thenAsync(() => new SyncResultImpl(result));\n    } else {\n      return new SyncResultImpl(result);\n    }\n  }\n\n  /** @override */\n  thenFinish(frame: Frame<T>): void {\n    if (this.isPending()) {\n      this.then((res) => {\n        frame.finish(res);\n      });\n    } else {\n      frame.finish(this.frame.res);\n    }\n  }\n\n  /** @override */\n  isPending(): boolean {\n    return this.frame.state == FrameState.ACTIVE;\n  }\n\n  /** @override */\n  get(): T | null {\n    if (this.isPending()) {\n      throw new Error(\"Result is pending\");\n    }\n    return this.frame.res;\n  }\n}\n\n/**\n * Asynchronous execution frame. Corresponds to an asynchronous function\n * invocation.\n * @template T\n */\nexport class Frame<T> {\n  res: T = null;\n  state: FrameState;\n  callback: ((p1: any) => void) | null = null;\n  handler: ((p1: Frame<any>, p2: Error) => void) | null = null;\n\n  constructor(\n    public task: Task,\n    public parent: Frame<T>,\n    public name: string,\n  ) {\n    this.state = FrameState.INIT;\n  }\n\n  private checkEnvironment(): void {\n    if (!privateCurrentTask) {\n      throw new Error(\"F_TASK_NO_CONTEXT\");\n    }\n    if (this !== privateCurrentTask.top) {\n      throw new Error(\"F_TASK_NOT_TOP_FRAME\");\n    }\n  }\n\n  /**\n   * @return to be returned as this asynchronous function return value.\n   */\n  result(): Result<T> {\n    return new ResultImpl<T>(this);\n  }\n\n  finish(res: T) {\n    this.checkEnvironment();\n    if (privateCurrentTask && !privateCurrentTask.exception) {\n      this.res = res;\n    }\n    this.state = FrameState.FINISHED;\n    const frame = this.parent;\n    if (privateCurrentTask) {\n      privateCurrentTask.top = frame;\n    }\n    if (this.callback) {\n      try {\n        this.callback(res);\n      } catch (err) {\n        this.task.raise(err as Error, frame);\n      }\n\n      // callback was called\n      this.state = FrameState.DEAD;\n    }\n  }\n\n  getTask(): Task {\n    return this.task;\n  }\n\n  /**\n   * @return frame name.\n   */\n  getName(): string {\n    return this.name;\n  }\n\n  getScheduler(): Scheduler {\n    return this.task.scheduler;\n  }\n\n  then(callback: (p1: T) => void): void {\n    // legal to call when currentTask is null\n    switch (this.state) {\n      case FrameState.ACTIVE:\n        if (this.callback) {\n          throw new Error(\"F_TASK_FRAME_ALREADY_HAS_CALLBACK\");\n        } else {\n          this.callback = callback;\n        }\n        break;\n      case FrameState.FINISHED: {\n        const task = this.task;\n        const frame = this.parent;\n        try {\n          callback(this.res);\n          this.state = FrameState.DEAD;\n        } catch (err) {\n          this.state = FrameState.DEAD;\n          task.raise(err as Error, frame);\n        }\n        break;\n      }\n      case FrameState.DEAD:\n        throw new Error(\"F_TASK_DEAD_FRAME\");\n      default:\n        throw new Error(`F_TASK_UNEXPECTED_FRAME_STATE ${this.state}`);\n    }\n  }\n\n  /**\n   * If this task was executed longer than task's slice parameter.\n   * @return holds true\n   */\n  timeSlice(): Result<boolean> {\n    const frame = newFrame<boolean>(\"Frame.timeSlice\");\n    const scheduler = frame.getScheduler();\n    if (scheduler.isTimeSliceOver()) {\n      Logging.logger.debug(\"-- time slice --\");\n      frame.suspend().schedule(true);\n    } else {\n      frame.finish(true);\n    }\n    return frame.result();\n  }\n\n  /**\n   * Yield to other tasks for the specified time.\n   * @param delay in milliseconds.\n   * @return holds true\n   */\n  sleep(delay: number): Result<boolean> {\n    const frame = newFrame<boolean>(\"Frame.sleep\");\n    frame.suspend().schedule(true, delay);\n    return frame.result();\n  }\n\n  /**\n   * Repeatedly execute the given function asynchronously until it returns\n   * false.\n   * @return holds true.\n   */\n  loop(func: () => Result<boolean>): Result<boolean> {\n    const frame = newFrame<boolean>(\"Frame.loop\");\n    const step = (more) => {\n      try {\n        while (more) {\n          const result = func();\n          if (result.isPending()) {\n            result.then(step);\n            return;\n          } else {\n            result.then((m) => {\n              more = m;\n            });\n          }\n        }\n        frame.finish(true);\n      } catch (err) {\n        frame.task.raise(err as Error, frame);\n      }\n    };\n    step(true);\n    return frame.result();\n  }\n\n  /**\n   * Similar to loop(), but provides a Frame for loop body function.\n   * @return holds true.\n   */\n  loopWithFrame(func: (p1: LoopBodyFrame) => void): Result<boolean> {\n    const task = privateCurrentTask;\n    if (!task) {\n      throw new Error(\"E_TASK_NO_CONTEXT\");\n    }\n    return this.loop(() => {\n      let result: Result<boolean>;\n      do {\n        const frame = new LoopBodyFrame(task as Task, task.top);\n        task.top = frame;\n        frame.state = FrameState.ACTIVE;\n        func(frame);\n        result = frame.result();\n      } while (!result.isPending() && result.get());\n      return result;\n    });\n  }\n\n  suspend(opt_waitTarget?: any): Continuation<T> {\n    this.checkEnvironment();\n    if (this.task.continuation) {\n      throw new Error(\"E_TASK_ALREADY_SUSPENDED\");\n    }\n    const continuation: Continuation<T> = new Continuation(this.task);\n    this.task.continuation = continuation;\n    privateCurrentTask = null;\n    this.task.waitTarget = opt_waitTarget || null;\n    return continuation;\n  }\n}\n\nexport class LoopBodyFrame extends Frame<boolean> {\n  constructor(task: Task, parent: Frame<boolean>) {\n    super(task, parent, \"loop\");\n  }\n\n  continueLoop(): void {\n    this.finish(true);\n  }\n\n  breakLoop(): void {\n    this.finish(false);\n  }\n}\n\nexport class EventItem {\n  next: EventItem = null;\n\n  constructor(public event: Base.Event) {}\n}\n\n/**\n * An class to listen to evens and present them as a readable asynchronous\n * stream to tasks.\n */\nexport class EventSource {\n  continuation: Continuation<boolean> = null;\n  listeners: {\n    target: Base.EventTarget;\n    type: string;\n    listener: Base.EventListener;\n  }[] = [];\n  head: EventItem;\n  tail: EventItem;\n\n  constructor() {\n    this.head = new EventItem(null);\n    this.tail = this.head;\n  }\n\n  /**\n   * Attaches as an event listener to an EventTarget.\n   */\n  attach(\n    target: Base.EventTarget,\n    type: string,\n    opt_preventDefault?: boolean,\n  ): void {\n    const listener = (event) => {\n      if (opt_preventDefault) {\n        event.preventDefault();\n      }\n      if (this.tail.event) {\n        this.tail.next = new EventItem(event);\n        this.tail = this.tail.next;\n      } else {\n        this.tail.event = event;\n        const continuation = this.continuation;\n        if (continuation) {\n          this.continuation = null;\n          continuation.schedule(true);\n        }\n      }\n    };\n    target.addEventListener(type, listener, false);\n    this.listeners.push({ target, type, listener });\n  }\n\n  detach(target: Base.EventTarget, type: string): void {\n    let i = 0;\n    let item: {\n      target: Base.SimpleEventTarget;\n      type: string;\n      listener: Base.EventListener;\n    } = null;\n    while (i < this.listeners.length) {\n      item = this.listeners[i];\n      if (item.type == type && item.target === target) {\n        this.listeners.splice(i, 1);\n        item.target.removeEventListener(item.type, item.listener, false);\n        return;\n      }\n      i++;\n    }\n    throw new Error(\"E_TASK_EVENT_SOURCE_NOT_ATTACHED\");\n  }\n\n  /**\n   * Read next dispatched event, blocking the current task if needed.\n   */\n  nextEvent(): Result<Base.Event> {\n    const frame: Frame<Base.Event> = newFrame(\"EventSource.nextEvent\");\n    const readEvent = () => {\n      if (this.head.event) {\n        const event = this.head.event;\n        if (this.head.next) {\n          this.head = this.head.next;\n        } else {\n          this.head.event = null;\n        }\n        frame.finish(event);\n      } else if (this.continuation) {\n        throw new Error(\"E_TASK_EVENT_SOURCE_OTHER_TASK_WAITING\");\n      } else {\n        const frameInternal: Frame<boolean> = newFrame(\n          \"EventSource.nextEventInternal\",\n        );\n        this.continuation = frameInternal.suspend(this);\n        frameInternal.result().then(readEvent);\n      }\n    };\n    readEvent();\n    return frame.result();\n  }\n}\n", "/**\n * Copyright 2013 Google, Inc.\n * Copyright 2015 Daishinsha Inc.\n * Copyright 2019 Vivliostyle Foundation\n *\n * Vivliostyle.js is free software: you can redistribute it and/or modify\n * it under the terms of the GNU Affero General Public License as published by\n * the Free Software Foundation, either version 3 of the License, or\n * (at your option) any later version.\n *\n * Vivliostyle.js is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n * GNU Affero General Public License for more details.\n *\n * You should have received a copy of the GNU Affero General Public License\n * along with Vivliostyle.js.  If not, see <http://www.gnu.org/licenses/>.\n *\n * @fileoverview TaskUtil - Utilities asynchronous execution and cooperative\n * multitasking.\n */\nimport * as Logging from \"./logging\";\nimport * as Task from \"./task\";\n\n/**\n * A class that can fetch or compute a resource that may be needed by multiple\n * tasks. The first time a resource is requested, it is fetched and then given\n * to everyone requesting it.\n * @template T\n * @param fetch function that fetches/computes\n *    a resource; it will be run in a separate task.\n */\nexport class Fetcher<T> {\n  name: string;\n  arrived: boolean = false;\n  resource: T = null;\n  task: Task.Task = null;\n  piggybacks: ((p1: any) => void)[] | null = [];\n\n  constructor(\n    public readonly fetch: () => Task.Result<T>,\n    opt_name?: string,\n  ) {\n    this.name = opt_name;\n  }\n\n  /**\n   * Start fetching/computing a resource, don't block current task.\n   */\n  start(): void {\n    if (!this.task) {\n      this.task = Task.currentTask()\n        .getScheduler()\n        .run(() => {\n          const frame = Task.newFrame(\"Fetcher.run\");\n          this.fetch().then((resource) => {\n            const piggibacks = this.piggybacks;\n            this.arrived = true;\n            this.resource = resource;\n            this.task = null;\n            this.piggybacks = [];\n            if (piggibacks) {\n              for (let i = 0; i < piggibacks.length; i++) {\n                try {\n                  piggibacks[i](resource);\n                } catch (err) {\n                  Logging.logger.error(err, \"Error:\");\n                }\n              }\n            }\n            frame.finish(resource);\n          });\n          return frame.result();\n        }, this.name);\n    }\n  }\n\n  piggyback(fn: (p1: T) => void): void {\n    if (this.arrived) {\n      fn(this.resource);\n    } else {\n      this.piggybacks.push(fn);\n    }\n  }\n\n  /**\n   * Fetches the resource, waits for it to arrive if it is already being\n   * fetched.\n   */\n  get(): Task.Result<T> {\n    if (this.arrived) {\n      return Task.newResult(this.resource);\n    }\n    this.start();\n    return this.task.join() as Task.Result<T>;\n  }\n\n  hasArrived(): boolean {\n    return this.arrived;\n  }\n}\n\n/**\n * Wait for all Fetcher objects in the array to arrive\n */\nexport const waitForFetchers = <T>(\n  fetchers: Fetcher<T>[],\n): Task.Result<boolean> => {\n  if (fetchers.length == 0) {\n    return Task.newResult(true);\n  }\n  if (fetchers.length == 1) {\n    return fetchers[0].get().thenReturn(true);\n  }\n  const frame = Task.newFrame<boolean>(\"waitForFetches\");\n  let i = 0;\n  frame\n    .loop(() => {\n      while (i < fetchers.length) {\n        const fetcher = fetchers[i++];\n        if (!fetcher.hasArrived()) {\n          return fetcher.get().thenReturn(true);\n        }\n      }\n      return Task.newResult(false);\n    })\n    .then(() => {\n      frame.finish(true);\n    });\n  return frame.result();\n};\n", "/**\n * Copyright 2015 Daishinsha Inc.\n * Copyright 2019 Vivliostyle Foundation\n *\n * Vivliostyle.js is free software: you can redistribute it and/or modify\n * it under the terms of the GNU Affero General Public License as published by\n * the Free Software Foundation, either version 3 of the License, or\n * (at your option) any later version.\n *\n * Vivliostyle.js is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n * GNU Affero General Public License for more details.\n *\n * You should have received a copy of the GNU Affero General Public License\n * along with Vivliostyle.js.  If not, see <http://www.gnu.org/licenses/>.\n *\n * @fileoverview Assets - Bundle resources\n */\n\n/** vivliostyle-viewport-screen.css */\nexport const VivliostyleViewportScreenCss = `\n@media screen {\n  [data-vivliostyle-viewer-viewport] {\n    background: #aaaaaa;\n  }\n\n  [data-vivliostyle-page-container] {\n    background: white;\n    z-index: 0;\n  }\n\n  [data-vivliostyle-viewer-viewport] {\n    box-sizing: border-box;\n    display: flex;\n    overflow: auto;\n    position: relative;\n  }\n\n  [data-vivliostyle-outer-zoom-box] {\n    margin: auto;\n    overflow: hidden;\n    flex: none;\n  }\n\n  [data-vivliostyle-viewer-viewport] [data-vivliostyle-spread-container] {\n    display: flex;\n    flex: none;\n    justify-content: center;\n    transform-origin: left top;\n  }\n\n  [data-vivliostyle-viewer-viewport][data-vivliostyle-page-progression=\"ltr\"]\n    [data-vivliostyle-spread-container] {\n    flex-direction: row;\n  }\n\n  [data-vivliostyle-viewer-viewport][data-vivliostyle-page-progression=\"rtl\"]\n    [data-vivliostyle-spread-container] {\n    flex-direction: row-reverse;\n  }\n\n  [data-vivliostyle-viewer-viewport] [data-vivliostyle-page-container] {\n    margin: 0 auto;\n    flex: none;\n    transform-origin: center top;\n  }\n\n  [data-vivliostyle-viewer-viewport][data-vivliostyle-spread-view=\"true\"]\n    [data-vivliostyle-spread-container]\n    [data-vivliostyle-page-container][data-vivliostyle-page-side=\"left\"] {\n    margin-right: 1px;\n    transform-origin: right top;\n  }\n\n  [data-vivliostyle-viewer-viewport][data-vivliostyle-spread-view=\"true\"]\n    [data-vivliostyle-spread-container]\n    [data-vivliostyle-page-container][data-vivliostyle-page-side=\"right\"] {\n    margin-left: 1px;\n    transform-origin: left top;\n  }\n\n  [data-vivliostyle-viewer-viewport][data-vivliostyle-spread-view=\"true\"]\n    [data-vivliostyle-spread-container]\n    [data-vivliostyle-page-container][data-vivliostyle-unpaired-page=\"true\"] {\n    margin-left: auto;\n    margin-right: auto;\n    transform-origin: center top;\n  }\n}\n`;\n\n/** vivliostyle-viewport.css */\nexport const VivliostyleViewportCss = `\n[data-vivliostyle-layout-box] {\n  position: absolute;\n  left: 0;\n  top: 0;\n  right: 0;\n  bottom: 0;\n  overflow: hidden;\n  z-index: -1;\n  transform-origin: left top;\n}\n\n[data-vivliostyle-debug] [data-vivliostyle-layout-box] {\n  right: auto;\n  bottom: auto;\n  overflow: visible;\n  z-index: auto;\n}\n\n[data-vivliostyle-spread-container] {\n  transform: scale(var(--viv-outputScale,1));\n  transform-origin: left top;\n}\n\n/* Emulate high pixel ratio using zoom & transform:scale() */\n@supports (zoom: 8) {\n  [data-vivliostyle-layout-box] {\n    zoom: calc(var(--viv-outputPixelRatio,1) / var(--viv-devicePixelRatio,1));\n    transform: scale(calc(var(--viv-devicePixelRatio,1) / var(--viv-outputPixelRatio,1)));\n  }\n  [data-vivliostyle-spread-container] {\n    zoom: calc(var(--viv-outputPixelRatio,1) / var(--viv-devicePixelRatio,1));\n    transform: scale(calc(var(--viv-outputScale,1) * var(--viv-devicePixelRatio,1) / var(--viv-outputPixelRatio,1)));\n  }\n  /* Workaround for Chromium's default border etc. widths not zoomed but scaled down */\n  [data-vivliostyle-spread-container] :where([style*=border],[style*=outline],[style*=rule]) {\n    border-width: medium;\n    outline-width: medium;\n    column-rule-width: medium;\n  }\n  [data-vivliostyle-spread-container] ::-webkit-scrollbar {\n    width: 8px;\n    height: 8px;\n  }\n  [data-vivliostyle-spread-container] ::-webkit-scrollbar-track {\n    background-color: #f4f4f4;\n  }\n  [data-vivliostyle-spread-container] ::-webkit-scrollbar-thumb {\n    border-radius: 4px;\n    background: #c7c7c7;\n  }\n  [data-vivliostyle-spread-container] ::-webkit-scrollbar-thumb:hover {\n    background: #7d7d7d;\n  }\n}\n\n[data-vivliostyle-page-container] {\n  position: relative;\n}\n\n[data-vivliostyle-bleed-box] {\n  position: absolute;\n  overflow: hidden;\n  background-origin: content-box !important;\n}\n\n[data-vivliostyle-page-box] ~ [data-vivliostyle-page-box] {\n  display: none;\n}\n\n[data-vivliostyle-toc-box] {\n  position: absolute;\n  left: 3px;\n  top: 3px;\n  overflow: scroll;\n  overflow-x: hidden;\n  background: rgba(248, 248, 248, 0.9);\n  border-radius: 2px;\n  box-shadow: 1px 1px 2px rgba(0, 0, 0, 0.4);\n}\n\n@media print {\n  [data-vivliostyle-toc-box] {\n    display: none;\n  }\n\n  [data-vivliostyle-outer-zoom-box],\n  [data-vivliostyle-spread-container] {\n    width: 100% !important;\n    height: 100% !important;\n  }\n\n  [data-vivliostyle-spread-container] {\n    --viv-outputScale: 1 !important;\n    --viv-devicePixelRatio: 1 !important;\n    zoom: normal !important;\n    transform: none !important;\n    print-color-adjust: exact;\n  }\n\n  @supports (zoom: 8) {\n    [data-vivliostyle-spread-container] [data-vivliostyle-page-container] {\n      zoom: var(--viv-outputPixelRatio,1);\n      /* transform: scale(calc(1 / var(--viv-outputPixelRatio,1))); */\n      /* Use matrix instead of scale (Workaround for issue #1555) */\n      transform: matrix(calc(1 / var(--viv-outputPixelRatio,1)), 0, 5e-324, calc(1 / var(--viv-outputPixelRatio,1)), 0, 0);\n      transform-origin: left top;\n    }\n  }\n\n  [data-vivliostyle-spread-container] [data-vivliostyle-page-container] {\n    display: block !important;\n    max-height: 100vh;\n  }\n\n  [data-vivliostyle-spread-container] [data-vivliostyle-page-container]:not(:last-child) {\n    break-after: page;\n  }\n\n  /* Gecko-only hack, see https://bugzilla.mozilla.org/show_bug.cgi?id=267029#c17 */\n  @-moz-document url-prefix()  {\n    [data-vivliostyle-spread-container] [data-vivliostyle-page-container]:nth-last-child(n + 2) {\n      top: -1px;\n      margin-top: 1px;\n      margin-bottom: -1px;\n    }\n    /* Workaround Gecko problem on page break */\n    [data-vivliostyle-spread-container] [data-vivliostyle-page-container] {\n      break-after: auto !important;\n      height: 100% !important;\n    }\n  }\n}\n`;\n\n/** validation.txt */\nexport const ValidationTxt = `\n/*\n * Copyright 2013 Google, Inc.\n * Copyright 2015 Daishinsha Inc.\n * Copyright 2019 Vivliostyle Foundation\n *\n * CSS property validation.\n */\nNUM = POS_NUM | ZERO | NEGATIVE;\nNNEG_NUM = POS_NUM | ZERO;\nINT = POS_INT | ZERO | NEGATIVE;\nNNEG_INT = POS_INT | ZERO;\nPERCENTAGE = POS_PERCENTAGE | ZERO | NEGATIVE;\nSTRICT_PERCENTAGE = POS_PERCENTAGE | ZERO_PERCENTAGE | NEGATIVE;\nNNEG_PERCENTAGE = POS_PERCENTAGE | ZERO;\nLENGTH = POS_LENGTH | ZERO | NEGATIVE;\nNNEG_LENGTH = POS_LENGTH | ZERO;\nPLENGTH = LENGTH | PERCENTAGE;\nPPLENGTH = POS_LENGTH | ZERO | POS_PERCENTAGE;\nALENGTH = LENGTH | auto;\nAPLENGTH = PLENGTH | auto;\nPAPLENGTH = PPLENGTH | auto;\nANGLE = POS_ANGLE | ZERO | NEGATIVE;\nLENGTH_OR_NUM = LENGTH | NUM;\nANGLE_OR_NUM = ANGLE | NUM;\nMIN_MAX_FIT_CONTENT = min-content | max-content | fit-content;\nBG_POSITION_TERM = PLENGTH | left | center | right | top | bottom;\nURI_OR_NONE = URI | none;\nIMAGE = URI | IMAGE_FUNCTION | none;\nbackground-attachment = COMMA( [scroll | fixed | local]+ );\nbackground-color = COLOR;\nbackground-image = COMMA( IMAGE+ );\nbackground-position = COMMA( SPACE(BG_POSITION_TERM{1,4})+ ); /* relaxed */\nbackground-repeat = COMMA( [repeat | repeat-x | repeat-y | no-repeat]+ );\nborder-collapse = collapse | separate;\nBORDER_SIDE_COLOR = COLOR;\nBORDER_SIDE_STYLE = none | hidden | dotted | dashed | solid | double | groove | ridge | inset | outset;\nBORDER_SIDE_WIDTH = thin: 1px | medium: 3px | thick: 5px | NNEG_LENGTH;\nborder-spacing = LENGTH LENGTH?;\nborder-top-color = BORDER_SIDE_COLOR;\nborder-right-color = BORDER_SIDE_COLOR;\nborder-bottom-color = BORDER_SIDE_COLOR;\nborder-left-color = BORDER_SIDE_COLOR;\nborder-top-style = BORDER_SIDE_STYLE;\nborder-right-style = BORDER_SIDE_STYLE;\nborder-bottom-style = BORDER_SIDE_STYLE;\nborder-left-style = BORDER_SIDE_STYLE;\nborder-top-width = BORDER_SIDE_WIDTH;\nborder-right-width = BORDER_SIDE_WIDTH;\nborder-bottom-width = BORDER_SIDE_WIDTH;\nborder-left-width = BORDER_SIDE_WIDTH;\nBORDER_RADIUS = PLENGTH{1,2};\nborder-top-left-radius = BORDER_RADIUS;\nborder-top-right-radius = BORDER_RADIUS;\nborder-bottom-right-radius = BORDER_RADIUS;\nborder-bottom-left-radius = BORDER_RADIUS;\nborder-image-source = IMAGE;\nborder-image-slice = [NUM | PERCENTAGE]{1,4} || fill; /* relaxed */\nborder-image-width = [NUM | PLENGTH | auto]{1,4};\nborder-image-outset = [NUM | LENGTH]{1,4};\nborder-image-repeat = [ stretch | repeat | round | space ]{1,2};\nbottom = APLENGTH;\ncaption-side = top | bottom;\nclip = rect(ALENGTH{4}) | rect(SPACE(ALENGTH{4})) | auto;\ncolor = COLOR;\nLIST_STYLE_TYPE = IDENT;\nTYPE_OR_UNIT_IN_ATTR = string | color | url | integer | number | length | angle | time | frequency;\nATTR = attr(SPACE(IDENT TYPE_OR_UNIT_IN_ATTR?) [ STRING | IDENT | COLOR | INT | NUM | PLENGTH | ANGLE | POS_TIME | FREQUENCY]?);\nCONTENT_LIST = [ STRING | URI | counter(IDENT LIST_STYLE_TYPE?) |\n    counters(IDENT STRING LIST_STYLE_TYPE?) | ATTR |\n    target-counter([ STRING | URI ] IDENT LIST_STYLE_TYPE?) |\n    target-counter(ATTR IDENT LIST_STYLE_TYPE?) |\n    target-counters([ STRING | URI ] IDENT STRING LIST_STYLE_TYPE?) |\n    target-counters(ATTR IDENT STRING LIST_STYLE_TYPE?) |\n    target-text([ STRING | URI ] [content | before | after | first-letter | marker]?) |\n    target-text(ATTR [content | before | after | first-letter | marker]?) |\n    leader([ dotted | solid | space ] | STRING ) |\n    open-quote | close-quote | no-open-quote | no-close-quote |\n    content([ text | before | after | first-letter | marker ]?) |\n    string(IDENT [first | start | last | first-except]?) |\n    element(IDENT [first | start | last | first-except]?) ]+;\nCONTENT = normal | none | CONTENT_LIST;\ncontent = CONTENT;\nCOUNTER = [ IDENT INT? ]+ | none;\ncounter-increment = COUNTER;\ncounter-reset = COUNTER;\ncounter-set = COUNTER;\ncursor = COMMA(URI* [ auto | crosshair | default | pointer | move | e-resize | ne-resize | nw-resize |\n    n-resize | se-resize | sw-resize | s-resize | w-resize | text | wait | help | progress ]);\ndirection = ltr | rtl;\ndisplay = inline | block | list-item | inline-block | table | inline-table | table-row-group |\n    table-header-group | table-footer-group | table-row | table-column-group | table-column |\n    table-cell | table-caption | none | oeb-page-head | oeb-page-foot | flex | inline-flex |\n    ruby | ruby-base | ruby-text | ruby-base-container | ruby-text-container | run-in | compact | marker |\n    flow-root | grid | inline-grid | contents;\nempty-cells = show | hide;\nFAMILY = SPACE(IDENT+) | STRING;\nFAMILY_LIST = COMMA( FAMILY+ );\nfont-family = FAMILY_LIST;\nfont-size = xx-small | x-small | small | medium | large | x-large | xx-large | larger | smaller | PPLENGTH;\nfont-style = normal | italic | oblique;\nfont-weight = normal | bold | bolder | lighter | POS_NUM;\nheight = PAPLENGTH | MIN_MAX_FIT_CONTENT;\nleft = APLENGTH;\nletter-spacing = normal | LENGTH_OR_NUM;\nline-height = normal | POS_NUM | PPLENGTH;\nlist-style-image = IMAGE;\nlist-style-position = inside | outside;\nlist-style-type = LIST_STYLE_TYPE | STRING | none;\nmargin-right = APLENGTH;\nmargin-left = APLENGTH;\nmargin-top = APLENGTH;\nmargin-bottom = APLENGTH;\nNPLENGTH = none | PLENGTH;\nmax-height = NPLENGTH | MIN_MAX_FIT_CONTENT;\nmax-width = NPLENGTH | MIN_MAX_FIT_CONTENT;\nmin-height = APLENGTH | MIN_MAX_FIT_CONTENT;\nmin-width = APLENGTH | MIN_MAX_FIT_CONTENT;\norphans = POS_INT;\noutline-offset = LENGTH;\noutline-color = COLOR | invert;\noutline-style = BORDER_SIDE_STYLE;\noutline-width = BORDER_SIDE_WIDTH;\noverflow = visible | hidden | scroll | auto | clip;\npadding-right = PPLENGTH;\npadding-left = PPLENGTH;\npadding-top = PPLENGTH;\npadding-bottom = PPLENGTH;\nPAGE_BREAK = auto | always | avoid | left | right | recto | verso;\npage-break-after = PAGE_BREAK;\npage-break-before = PAGE_BREAK;\npage-break-inside = avoid | auto;\nposition = static | relative | absolute | fixed | running(IDENT);\nquotes = [STRING STRING]+ | none | auto;\nright = APLENGTH;\ntable-layout = auto | fixed;\ntext-align = left | right | center | justify | start | end | match-parent | inside | outside;\ntext-indent = PLENGTH;\ntext-transform = capitalize | uppercase | lowercase | none;\ntop = APLENGTH;\nvertical-align = baseline | sub | super | top | text-top | middle | bottom | text-bottom | PLENGTH;\nvisibility = visible | hidden | collapse;\nwhite-space = normal | pre | nowrap | pre-wrap | pre-line | break-spaces;\nwidows = POS_INT;\nwidth = PAPLENGTH | MIN_MAX_FIT_CONTENT;\nword-spacing = normal | LENGTH_OR_NUM;\nz-index = auto | INT;\n\n[epub,moz,webkit]hyphens = auto | manual | none;\n[webkit]hyphenate-character = auto | STRING;\n\n/* css-logical */\nmargin-block-start = APLENGTH;\nmargin-block-end = APLENGTH;\nmargin-inline-start = APLENGTH;\nmargin-inline-end = APLENGTH;\npadding-block-start = APLENGTH;\npadding-block-end = APLENGTH;\npadding-inline-start = APLENGTH;\npadding-inline-end = APLENGTH;\nborder-block-start-color = BORDER_SIDE_COLOR;\nborder-block-end-color = BORDER_SIDE_COLOR;\nborder-inline-start-color = BORDER_SIDE_COLOR;\nborder-inline-end-color = BORDER_SIDE_COLOR;\nborder-block-start-style = BORDER_SIDE_STYLE;\nborder-block-end-style = BORDER_SIDE_STYLE;\nborder-inline-start-style = BORDER_SIDE_STYLE;\nborder-inline-end-style = BORDER_SIDE_STYLE;\nborder-block-start-width = BORDER_SIDE_WIDTH;\nborder-block-end-width = BORDER_SIDE_WIDTH;\nborder-inline-start-width = BORDER_SIDE_WIDTH;\nborder-inline-end-width = BORDER_SIDE_WIDTH;\nblock-start = APLENGTH;\nblock-end = APLENGTH;\ninline-start = APLENGTH;\ninline-end = APLENGTH;\nblock-size = PAPLENGTH | MIN_MAX_FIT_CONTENT;\ninline-size = PAPLENGTH | MIN_MAX_FIT_CONTENT;\nmax-block-size = NPLENGTH | MIN_MAX_FIT_CONTENT;\nmax-inline-size = NPLENGTH | MIN_MAX_FIT_CONTENT;\nmin-block-size = APLENGTH | MIN_MAX_FIT_CONTENT;\nmin-inline-size = APLENGTH | MIN_MAX_FIT_CONTENT;\n\nmargin-inside = auto | APLENGTH;\nmargin-outside = auto | APLENGTH;\npadding-inside = PPLENGTH;\npadding-outside = PPLENGTH;\nborder-inside-color = BORDER_SIDE_COLOR;\nborder-outside-color = BORDER_SIDE_COLOR;\nborder-inside-style = BORDER_SIDE_STYLE;\nborder-outside-style = BORDER_SIDE_STYLE;\nborder-inside-width = BORDER_SIDE_WIDTH;\nborder-outside-width = BORDER_SIDE_WIDTH;\ninside = APLENGTH;\noutside = APLENGTH;\n\nSHAPE = auto | rectangle( PLENGTH{4} ) |  ellipse( PLENGTH{4} ) |  circle( PLENGTH{3} ) |\n    polygon( SPACE(PLENGTH+)+ );\n[epubx]shape-inside = SHAPE;\n[epubx,webkit]shape-outside = SHAPE;\n[epubx]wrap-flow = auto | both | start | end | maximum | clear | around /* epub al */;\n\nTRANSFORM_FUNCTION = matrix(NUM{6}) | translate(PLENGTH{1,2}) | translateX(PLENGTH) | translateY(PLENGTH) |\n scale(NUM{1,2}) | scaleX(NUM) | scaleY(NUM) | rotate(ANGLE) | skewX(ANGLE) | skewY(ANGLE);\n[epub]transform = none | TRANSFORM_FUNCTION+;\n[epub]transform-origin = [[[ top | bottom | left | right] PLENGTH?] | center | PLENGTH]{1,2}; /* relaxed */\n\nBOX = border-box | padding-box | content-box;\nSHADOW = SPACE(inset || LENGTH{2,4} || COLOR); /* relaxed */\n[webkit]background-size = COMMA( SPACE( [PLENGTH | auto ]{1,2} | cover | contain)+ );\n[webkit]background-origin = COMMA( BOX+ );\n[webkit]background-clip = COMMA( BOX+ );\n[webkit]box-shadow = none | COMMA( SHADOW+ );\ntext-shadow = none |  COMMA( SHADOW+ );\n[webkit]box-decoration-break = slice | clone;\nFILTER_FUNCTION = blur(LENGTH) | brightness(NUM | PERCENTAGE) | contrast(NUM | PERCENTAGE) | drop-shadow(SPACE(LENGTH{2,3} COLOR?))\n                | grayscale(NUM | PERCENTAGE) | hue-rotate(ANGLE) | invert(NUM | PERCENTAGE) | opacity(NUM | PERCENTAGE)\n                | saturate(NUM | PERCENTAGE) | sepia(NUM | PERCENTAGE);\nFILTER_FUNCTION_LIST = FILTER_FUNCTION+;\n[webkit]filter = none | FILTER_FUNCTION_LIST;\n\nopacity = NUM;\n\n[moz,webkit]column-width = LENGTH | auto;\n[moz,webkit]column-count = INT | auto;\n[moz,webkit]column-gap = LENGTH | normal;\n[moz,webkit]column-rule-color = COLOR;\n[moz,webkit]column-rule-style = BORDER_SIDE_STYLE;\n[moz,webkit]column-rule-width = BORDER_SIDE_WIDTH;\nBREAK = auto | avoid | avoid-page | page | left | right | recto | verso | avoid-column | column | avoid-region | region;\nbreak-before = BREAK;\nbreak-after = BREAK;\nbreak-inside = auto | avoid | avoid-page | avoid-column | avoid-region;\n[webkit]column-span = none | auto | all;\n[moz]column-fill = auto | balance | balance-all;\nmargin-break = auto | keep | discard;\n\nsrc = COMMA([SPACE(URI format(STRING+)?) | local(FAMILY)]+); /* for font-face */\n\n[epubx,webkit]flow-from = IDENT;\n[epubx,webkit]flow-into = IDENT;\n[epubx]flow-linger = INT | none;\n[epubx]flow-priority = INT;\n[epubx]flow-options = none | [ exclusive || last || static ];\n[epubx]page = INT | auto | IDENT; /* page: IDENT is for CSS Paged Media */\n[epubx]min-page-width = LENGTH;\n[epubx]min-page-height = LENGTH;\n[epubx]required = true | false;\n[epubx]enabled = true | false;\n[epubx]conflicting-partitions = COMMA(IDENT+);\n[epubx]required-partitions = COMMA(IDENT+);\n[epubx]snap-height = LENGTH | none;\n[epubx]snap-width = LENGTH | none;\n[epubx]flow-consume = all | some;\n[epubx]utilization = NUM;\n[epubx]text-zoom = font-size | scale;\n\n[adapt]template = URI_OR_NONE | footnote;\n[adapt]behavior = IDENT;\n\n/* CSS Fonts */\nCOMMON_LIG_VALUES        = [ common-ligatures | no-common-ligatures ];\nDISCRETIONARY_LIG_VALUES = [ discretionary-ligatures | no-discretionary-ligatures ];\nHISTORICAL_LIG_VALUES    = [ historical-ligatures | no-historical-ligatures ];\nCONTEXTUAL_ALT_VALUES    = [ contextual | no-contextual ];\nfont-variant-ligatures = normal | none | [ COMMON_LIG_VALUES || DISCRETIONARY_LIG_VALUES || HISTORICAL_LIG_VALUES || CONTEXTUAL_ALT_VALUES ];\nfont-variant-caps = normal | small-caps | all-small-caps | petite-caps | all-petite-caps | unicase | titling-caps;\nNUMERIC_FIGURE_VALUES   = [ lining-nums | oldstyle-nums ];\nNUMERIC_SPACING_VALUES  = [ proportional-nums | tabular-nums ];\nNUMERIC_FRACTION_VALUES = [ diagonal-fractions | stacked-fractions ];\nfont-variant-numeric = normal | [ NUMERIC_FIGURE_VALUES || NUMERIC_SPACING_VALUES || NUMERIC_FRACTION_VALUES || ordinal || slashed-zero ];\nEAST_ASIAN_VARIANT_VALUES = [ jis78 | jis83 | jis90 | jis04 | simplified | traditional ];\nEAST_ASIAN_WIDTH_VALUES   = [ full-width | proportional-width ];\nfont-variant-east-asian = normal | [ EAST_ASIAN_VARIANT_VALUES || EAST_ASIAN_WIDTH_VALUES || ruby ];\nfont-variant_css2 = normal | small-caps; /* for font shorthand */\nfont-size-adjust = none | NNEG_NUM;\n[webkit]font-kerning = auto | normal | none;\nfont-feature-settings = COMMA( normal | SPACE( STRING [ on | off | INT ]? )+ );\nFONT_STRETCH_CSS3_VALUES = normal | wider | narrower | ultra-condensed | extra-condensed | condensed | semi-condensed | semi-expanded | expanded | extra-expanded | ultra-expanded;\nfont-stretch = FONT_STRETCH_CSS3_VALUES | PERCENTAGE;\nfont-stretch_css3 = FONT_STRETCH_CSS3_VALUES; /* for font shorthand */\nfont-display = [ auto | block | swap | fallback | optional ];\nunicode-range = COMMA( URANGE+ );\n\n/* CSS Images */\nimage-resolution = RESOLUTION;\nobject-fit = fill | contain | cover | none | scale-down;\nobject-position = COMMA( SPACE(BG_POSITION_TERM{1,4})+ ); /* relaxed */\n\n/* CSS Paged Media */\nPAGE_SIZE = a10 | a9 | a8 | a7 | a6 | a5 | a4 | a3 | a2 | a1 | a0\n          | b10 | b9 | b8 | b7 | b6 | b5 | b4 | b3 | b2 | b1 | b0\n          | c10 | c9 | c8 | c7 | c6 | c5 | c4 | c3 | c2 | c1 | c0\n          | jis-b10 | jis-b9 | jis-b8 | jis-b7 | jis-b6 | jis-b5 | jis-b4 | jis-b3 | jis-b2 | jis-b1 | jis-b0\n          | letter | legal | ledger;\nbleed = auto | LENGTH;\nmarks = none | [ crop || cross ];\nsize = POS_LENGTH{1,2} | auto | [ PAGE_SIZE || [ portrait | landscape ] ];\ncrop-offset = auto | LENGTH;\ncrop-marks-line-color = auto | COLOR;\n\n/* CSS Page Floats */\nclear = none | left | right | top | bottom | inline-start | inline-end | block-start | block-end | inside | outside | both | all | same | column | region | page;\nfloat-reference = inline | column | region | page;\nfloat = none | footnote | [ block-start || block-end || inline-start || inline-end || snap-block || snap-inline || left || right || top || bottom || inside || outside ];\nfloat-min-wrap-block = PPLENGTH;\n\n/* CSS Ruby */\nruby-align = start | center | space-between | space-around;\nruby-position = over | under | inter-character;\n\n/* CSS Size Adjust */\n[moz,webkit]text-size-adjust = auto | none | POS_PERCENTAGE;\n\n/* CSS Text */\n[webkit]line-break = auto | loose | normal | strict | anywhere;\noverflow-wrap = normal | break-word | anywhere;\n[moz]tab-size = NNEG_INT | NNEG_LENGTH;\n[moz]text-align-last = auto | start | end | left | right | center | justify | inside | outside;\ntext-justify = auto | none | inter-word | inter-character;\nword-break = normal | keep-all | break-all | break-word;\ntext-spacing-trim = auto | normal | space-all | trim-both | trim-auto |\n    [[ trim-start | space-start | space-first ] ||\n     [ trim-end | space-end | allow-end ] ||\n     [ trim-adjacent | space-adjacent ]];\ntext-autospace = normal | auto | no-autospace |\n    [[ ideograph-alpha || ideograph-numeric || punctuation ] || [ insert | replace ]];\nhanging-punctuation = none | [ first || [ force-end | allow-end ] || last ];\n\n/* CSS Text Decoration */\n[webkit]text-decoration-color = COLOR;\n[webkit]text-decoration-line = none | [ underline || overline || line-through || blink ];\n[webkit]text-decoration-skip = none | [ objects || spaces || ink || edges || box-decoration ];\n[webkit]text-decoration-style = solid | double | dotted | dashed | wavy;\n[webkit]text-decoration-thickness = from-font | APLENGTH;\n[epub,webkit]text-emphasis-color = COLOR;\n[webkit]text-emphasis-position = [ over | under ] [ right | left ];\n[epub,webkit]text-emphasis-style = none | [[ filled | open ] || [ dot | circle | double-circle | triangle | sesame ]] | STRING;\n[webkit]text-underline-position = auto | [ under || [ left | right ]];\n\n/* CSS Transforms */\n[webkit]backface-visibility = visible | hidden;\n\n/* CSS UI */\n[moz,webkit]box-sizing = content-box | padding-box | border-box;\ntext-overflow = [clip | ellipsis | STRING]{1,2};\n\n/* CSS Writing Modes */\n[epub,webkit]text-combine = none | horizontal;\ntext-combine-upright = none | all; /* relaxed */\n[epub,webkit]text-orientation = mixed | upright | sideways-right | sideways-left | sideways | use-glyph-orientation /* the following values are kept for backward-compatibility */ | vertical-right | rotate-right | rotate-left | rotate-normal | auto;\nunicode-bidi = normal | embed | isolate | bidi-override | isolate-override | plaintext;\n[epub,webkit]writing-mode = horizontal-tb | vertical-rl | lr-tb | rl-tb | tb-rl | lr | rl | tb;\n\n/* CSS Flex box */\nFLEX_BASIS = content | PAPLENGTH;\nflex-direction = row | row-reverse | column | column-reverse;\nflex-wrap = nowrap | wrap | wrap-reverse;\norder = INT;\nflex-grow = NNEG_NUM;\nflex-shrink = NNEG_NUM;\nflex-basis = FLEX_BASIS;\nflex = none | [ [ NNEG_NUM NNEG_NUM? ] || FLEX_BASIS ];\njustify-content = flex-start | flex-end | center | space-between | space-around;\nalign-items = flex-start | flex-end | center | baseline | stretch;\nalign-self = auto | flex-start | flex-end | center | baseline | stretch;\nalign-content = flex-start | flex-end | center | space-between | space-around | stretch;\n\n/* Pointer Events */\ntouch-action = auto | none | [ pan-x || pan-y ] | manipulation;\n\n/* SVG 2 */\nOPACITY_VALUE = NUM | PERCENTAGE;\nDASH_ARRAY = COMMA( SPACE( [ LENGTH | PERCENTAGE | NUM ]+ )+ );\nPAINT = none | child | child(INT) | COLOR | SPACE( URI [none | COLOR]? ) | context-fill | context-stroke;\ncolor-interpolation = auto | sRGB | linearRGB;\ncolor-rendering = auto | optimizeSpeed | optimizeQuality;\nfill = PAINT;\nfill-opacity = OPACITY_VALUE;\nfill-rule = nonzero | evenodd;\nglyph-orientation-vertical = auto | NUM | ANGLE;\nimage-rendering = auto | optimizeSpeed | optimizeQuality | crisp-edges | pixelated;\nmarker-start = none | URI;\nmarker-mid = none | URI;\nmarker-end = none | URI;\npointer-events = bounding-box | visiblePainted | visibleFill | visibleStroke | visible | painted | fill | stroke | all | none;\npaint-order = normal | [ fill || stroke || markers ];\nshape-rendering = auto | optimizeSpeed | crispEdges | geometricPrecision;\nstop-color = COLOR;\nstop-opacity = OPACITY_VALUE;\nstroke = PAINT;\nstroke-dasharray = none | DASH_ARRAY;\nstroke-dashoffset = PERCENTAGE | LENGTH_OR_NUM;\nstroke-linecap = butt | round | square;\nstroke-linejoin = miter | round | bevel;\nstroke-miterlimit = NUM;\nstroke-opacity = OPACITY_VALUE;\nstroke-width = PERCENTAGE | LENGTH_OR_NUM;\ntext-anchor = start | middle | end;\ntext-rendering = auto | optimizeSpeed | optimizeLegibility | geometricPrecision;\nvector-effect = none | SPACE( [ non-scaling-stroke | non-scaling-size | non-rotation | fixed-position ]+ [ viewport | screen ]? );\n\n/* SVG 1.1 */\nalignment-baseline = auto | baseline | before-edge | text-before-edge | middle | central | after-edge | text-after-edge | ideographic | alphabetic | hanging | mathematical;\nbaseline-shift = baseline | sub | super | PERCENTAGE | LENGTH_OR_NUM;\ndominant-baseline = auto | use-script | no-change | reset-size | ideographic | alphabetic | hanging | mathematical | central | middle | text-after-edge | text-before-edge;\nmask = none | URI;\n\n/* css-masking-1 */\nSHAPE_RADIUS = PLENGTH | closest-side | farthest-side;\nFILL_RULE = nonzero | evenodd;\nSHAPE_BOX = BOX | margin-box;\nGEOMETRY_BOX = SHAPE_BOX | fill-box | stroke-box | view-box;\nBASIC_SHAPE =\n    inset( SPACE( PLENGTH{1,4} [ round PLENGTH{1,4} [ SLASH PLENGTH{1,4} ]? ]? ) )\n  | circle(  SPACE( [SHAPE_RADIUS]?    [at BG_POSITION_TERM{1,4}]? ) )\n  | ellipse( SPACE( SHAPE_RADIUS{2}? [at BG_POSITION_TERM{1,4}]? ) )\n  | polygon( FILL_RULE? COMMA( SPACE( PLENGTH{2} )+ )+ );\n[webkit]clip-path = none | URI | [ BASIC_SHAPE || GEOMETRY_BOX ];\nclip-rule = nonzero | evenodd;\n\n/* filters */\nflood-color = COLOR;\nflood-opacity = OPACITY_VALUE;\nlighting-color = COLOR;\n\n/* compositing-1 */\nBLEND_MODE = normal | multiply | screen | overlay | darken | lighten | color-dodge | color-burn | hard-light | soft-light | difference | exclusion | hue | saturation | color | luminosity;\nmix-blend-mode = BLEND_MODE;\nisolation = auto | isolate;\nbackground-blend-mode = COMMA( BLEND_MODE+ );\n\n/* CSS GCPM */\nstring-set = COMMA( SPACE( IDENT CONTENT_LIST )+ | none );\nfootnote-policy = auto | line;\n\n/* CSS Repeated Headers and Footers */\n[viv]repeat-on-break = auto | none | header | footer;\n\n/* Compatibility */\n[webkit]text-fill-color = COLOR;\n[webkit]text-stroke-color = COLOR;\n[webkit]text-stroke-width = BORDER_SIDE_WIDTH;\n\nDEFAULTS\n\nbackground-attachment: scroll;\nbackground-color: transparent;\nbackground-image: none;\nbackground-repeat: repeat;\nbackground-position: 0% 0%;\nbackground-clip: border-box;\nbackground-origin: padding-box;\nbackground-size: auto;\nborder-top-color: currentColor;\nborder-right-color: currentColor;\nborder-bottom-color: currentColor;\nborder-left-color: currentColor;\nborder-top-style: none;\nborder-right-style: none;\nborder-bottom-style: none;\nborder-left-style: none;\nborder-top-width: 3px;\nborder-right-width: 3px;\nborder-bottom-width: 3px;\nborder-left-width: 3px;\nborder-top-left-radius: 0;\nborder-top-right-radius: 0;\nborder-bottom-right-radius: 0;\nborder-bottom-left-radius: 0;\nborder-image-source: none;\nborder-image-slice: 100%;\nborder-image-width: 1;\nborder-image-outset: 0;\nborder-image-repeat: stretch;\ncolumn-count: auto;\ncolumn-gap: normal;\ncolumn-width: auto;\ncolumn-rule-color: currentColor;\ncolumn-rule-style: none;\ncolumn-rule-width: 3px;\ncolumn-fill: balance;\noutline-color: currentColor;\noutline-style: none;\noutline-width: 3px;\nflex-direction: row;\nflex-wrap: nowrap;\nfont-family: serif;\nfont-style: normal;\nfont-size: medium;\nfont-size-adjust: none;\nfont-kerning: auto;\nfont-feature-settings: normal;\nfont-variant-ligatures: normal;\nfont-variant-caps: normal;\nfont-variant-numeric: normal;\nfont-variant-east-asian: normal;\nfont-weight: normal;\nfont-stretch: normal;\nline-height: normal;\nlist-style-image: none;\nlist-style-position: outside;\nlist-style-type: disc;\nmargin-bottom: auto;\nmargin-left: auto;\nmargin-right: auto;\nmargin-top: auto;\npadding-bottom: auto;\npadding-left: auto;\npadding-right: auto;\npadding-top: auto;\ntext-autospace: normal;\ntext-emphasis-color: currentColor;\ntext-emphasis-style: none;\ntext-spacing-trim: normal;\ntext-stroke-color: currentColor;\ntext-stroke-width: 0;\nmarker-start: none;\nmarker-mid: none;\nmarker-end: none;\n\n/* css-logical */\nborder-block-start-color: currentColor;\nborder-block-end-color: currentColor;\nborder-inline-start-color: currentColor;\nborder-inline-end-color: currentColor;\nborder-inside-color: currentColor;\nborder-outside-color: currentColor;\nborder-block-start-style: none;\nborder-block-end-style: none;\nborder-inline-start-style: none;\nborder-inline-end-style: none;\nborder-inside-style: none;\nborder-outside-style: none;\nborder-block-start-width: 3px;\nborder-block-end-width: 3px;\nborder-inline-start-width: 3px;\nborder-inline-end-width: 3px;\nborder-inside-width: 3px;\nborder-outside-width: 3px;\n\nSHORTHANDS\n\nall = ALL;\nbackground = COMMA background-image [background-position [ / background-size ]] background-repeat\n     background-attachment [background-origin background-clip] background-color; /* background-color is a special case, see the code */\nborder-top = border-top-width border-top-style border-top-color;\nborder-right = border-right-width border-right-style border-right-color;\nborder-bottom = border-bottom-width border-bottom-style border-bottom-color;\nborder-left = border-left-width border-left-style border-left-color;\nborder-inside = border-inside-width border-inside-style border-inside-color;\nborder-outside = border-outside-width border-outside-style border-outside-color;\nborder-width = INSETS border-top-width border-right-width border-bottom-width border-left-width;\nborder-style = INSETS border-top-style border-right-style border-bottom-style border-left-style;\nborder-color = INSETS border-top-color border-right-color border-bottom-color border-left-color;\nborder = border-width border-style border-color;\nborder-image = border-image-source border-image-slice [ / border-image-width [ / border-image-outset ] ]\n     border-image-repeat;\nborder-radius = INSETS_SLASH border-top-left-radius border-top-right-radius\n     border-bottom-right-radius border-bottom-left-radius;\n[moz,webkit]columns = column-width column-count;\n[moz,webkit]column-rule = column-rule-width column-rule-style column-rule-color;\nflex-flow = flex-direction flex-wrap;\noeb-column-number = column-count;\noutline = outline-width outline-style outline-color;\nlist-style = list-style-position list-style-type list-style-image;\nmargin = INSETS margin-top margin-right margin-bottom margin-left;\npadding = INSETS padding-top padding-right padding-bottom padding-left;\nfont = FONT font-style font-variant_css2 font-weight font-stretch_css3 /* font-size line-height font-family are special-cased */;\nfont-variant = font-variant-ligatures font-variant-caps font-variant-numeric font-variant-east-asian;\n[epub,webkit]text-emphasis = text-emphasis-style text-emphasis-color;\nmarker = INSETS marker-start marker-mid marker-end;\n[webkit]text-stroke = text-stroke-width text-stroke-color;\ntext-decoration = text-decoration-line text-decoration-color text-decoration-style text-decoration-thickness;\ntext-spacing = TEXT_SPACING text-autospace text-spacing-trim;\n\n/* css-logical */\nmargin-block = INSETS margin-block-start margin-block-end;\nmargin-inline = INSETS margin-inline-start margin-inline-end;\npadding-block = INSETS padding-block-start padding-block-end;\npadding-inline = INSETS padding-inline-start padding-inline-end;\nborder-block-width = INSETS border-block-start-width border-block-end-width;\nborder-block-style = INSETS border-block-start-style border-block-end-style;\nborder-block-color = INSETS border-block-start-color border-block-end-color;\nborder-inline-width = INSETS border-inline-start-width border-inline-end-width;\nborder-inline-style = INSETS border-inline-start-style border-inline-end-style;\nborder-inline-color = INSETS border-inline-start-color border-inline-end-color;\nborder-block = border-block-width border-block-style border-block-color;\nborder-inline = border-inline-width border-inline-style border-inline-color;\nborder-block-start = border-block-start-width border-block-start-style border-block-start-color;\nborder-block-end = border-block-end-width border-block-end-style border-block-end-color;\nborder-inline-start = border-inline-start-width border-inline-start-style border-inline-start-color;\nborder-inline-end = border-inline-end-width border-inline-end-style border-inline-end-color;\ninset-block-start = block-start;\ninset-block-end = block-end;\ninset-inline-start = inline-start;\ninset-inline-end = inline-end;\ninset-inside = inside;\ninset-outside = outside;\ninset-block = INSETS block-start block-end;\ninset-inline = INSETS inline-start inline-end;\ninset = INSETS top right bottom left;\n\n/* old names  */\nword-wrap = overflow-wrap;\n[adapt,webkit]margin-before = margin-block-start;\n[adapt,webkit]margin-after = margin-block-end;\n[adapt,webkit]margin-start = margin-inline-start;\n[adapt,webkit]margin-end = margin-inline-end;\n[adapt,webkit]padding-before = padding-block-start;\n[adapt,webkit]padding-after = padding-block-end;\n[adapt,webkit]padding-start = padding-inline-start;\n[adapt,webkit]padding-end = padding-inline-end;\n[adapt,webkit]border-before-color = border-block-start-color;\n[adapt,webkit]border-after-color = border-block-end-color;\n[adapt,webkit]border-start-color = border-inline-start-color;\n[adapt,webkit]border-end-color = border-inline-end-color;\n[adapt,webkit]border-before-style = border-block-start-style;\n[adapt,webkit]border-after-style = border-block-end-style;\n[adapt,webkit]border-start-style = border-inline-start-style;\n[adapt,webkit]border-end-style = border-inline-end-style;\n[adapt,webkit]border-before-width = border-block-start-width;\n[adapt,webkit]border-after-width = border-block-end-width;\n[adapt,webkit]border-start-width = border-inline-start-width;\n[adapt,webkit]border-end-width = border-inline-end-width;\n[adapt,webkit]before = block-start;\n[adapt,webkit]after = block-end;\n[adapt,webkit]start = inline-start;\n[adapt,webkit]end = inline-end;\n\n`;\n\n/** user-agent.xml */\nexport const UserAgentXml = `\n<!DOCTYPE html>\n<html xmlns=\"http://www.w3.org/1999/xhtml\" xmlns:s=\"http://www.pyroxy.com/ns/shadow\">\n<head>\n<style><![CDATA[\n\n.-vivliostyle-footnote-content {\n  float: footnote;\n}\n\n.-vivliostyle-table-cell-container {\n  display: block;\n}\n\n]]></style>\n</head>\n<body>\n\n<s:template id=\"footnote\"><s:content/><s:include class=\"-vivliostyle-footnote-content\"/></s:template>\n\n<s:template id=\"table-cell\"><div data-vivliostyle-flow-root=\"true\" class=\"-vivliostyle-table-cell-container\"><s:content/></div></s:template>\n\n</body>\n</html>`;\n\n/** user-agent-page.css */\nexport const UserAgentPageCss = `\n@namespace \"http://www.w3.org/1999/xhtml\";\n\n:root {\n  hyphens: -epubx-expr(pref-hyphenate? \"auto\": \"manual\");\n}\n:root[data-vivliostyle-epub-spine-properties~=\"page-spread-left\"] {\n  break-before: left;\n}\n:root[data-vivliostyle-epub-spine-properties~=\"page-spread-right\"] {\n  break-before: right;\n}\n\n@-adapt-footnote-area {\n  display: block;\n  margin-block-start: 0.5em;\n  margin-block-end: 0.5em;\n}\n\n@-adapt-footnote-area ::before {\n  display: block;\n  border-block-start-width: 1px;\n  border-block-start-style: solid;\n  border-block-start-color: black;\n  margin-block-end: 0.4em;\n  margin-inline-start: 0;\n  margin-inline-end: 60%;\n}\n\n/* default page master */\n@-epubx-page-master :background-host {\n  @-epubx-partition :layout-host {\n    -epubx-flow-from: body;\n    top: -epubx-expr(header.margin-bottom-edge);\n    bottom: -epubx-expr(page-height - footer.margin-top-edge);\n    left: 0px;\n    right: 0px;\n    column-width: 25em;\n  }\n  @-epubx-partition footer :oeb-page-foot {\n    writing-mode: horizontal-tb;\n    -epubx-flow-from: oeb-page-foot;\n    bottom: 0px;\n    left: 0px;\n    right: 0px;\n  }\n  @-epubx-partition header :oeb-page-head {\n    writing-mode: horizontal-tb;\n    -epubx-flow-from: oeb-page-head;\n    top: 0px;\n    left: 0px;\n    right: 0px;\n  }\n}\n\n@page {\n  @top-left-corner {\n    text-align: right;\n    vertical-align: middle;\n  }\n  @top-left {\n    text-align: left;\n    vertical-align: middle;\n  }\n  @top-center {\n    text-align: center;\n    vertical-align: middle;\n  }\n  @top-right {\n    text-align: right;\n    vertical-align: middle;\n  }\n  @top-right-corner {\n    text-align: left;\n    vertical-align: middle;\n  }\n  @left-top {\n    text-align: center;\n    vertical-align: top;\n  }\n  @left-middle {\n    text-align: center;\n    vertical-align: middle;\n  }\n  @left-bottom {\n    text-align: center;\n    vertical-align: bottom;\n  }\n  @right-top {\n    text-align: center;\n    vertical-align: top;\n  }\n  @right-middle {\n    text-align: center;\n    vertical-align: middle;\n  }\n  @right-bottom {\n    text-align: center;\n    vertical-align: bottom;\n  }\n  @bottom-left-corner {\n    text-align: right;\n    vertical-align: middle;\n  }\n  @bottom-left {\n    text-align: left;\n    vertical-align: middle;\n  }\n  @bottom-center {\n    text-align: center;\n    vertical-align: middle;\n  }\n  @bottom-right {\n    text-align: right;\n    vertical-align: middle;\n  }\n  @bottom-right-corner {\n    text-align: left;\n    vertical-align: middle;\n  }\n}\n\n@media print {\n  @page {\n    margin: 10%;\n  }\n}\n`;\n\n/** user-agent-base.css */\nexport const UserAgentBaseCss = `\n@namespace \"http://www.w3.org/1999/xhtml\";\n@namespace m \"http://www.w3.org/1998/Math/MathML\";\n@namespace epub \"http://www.idpf.org/2007/ops\";\n\nhtml,\naddress,\nblockquote,\nbody,\ndd,\ndiv,\ndl,\ndt,\nfieldset,\nform,\nframe,\nframeset,\nh1,\nh2,\nh3,\nh4,\nh5,\nh6,\nnoframes,\nol,\np,\nul,\ncenter,\ndir,\nhr,\nmenu,\npre,\ndetails,\ndialog,\nlegend,\nlisting,\noptgroup,\noption,\nplaintext,\nsearch,\nxmp,\narticle,\nsection,\nnav,\naside,\nhgroup,\nfooter,\nheader,\nfigure,\nfigcaption,\nmain {\n  display: block;\n}\nli {\n  display: list-item;\n}\nhead {\n  display: none !important;\n}\ntable {\n  display: table;\n}\ntr {\n  display: table-row;\n}\nthead {\n  display: table-header-group;\n  break-after: avoid;\n}\ntbody {\n  display: table-row-group;\n}\ntfoot {\n  display: table-footer-group;\n  break-before: avoid;\n}\ncol {\n  display: table-column;\n}\ncolgroup {\n  display: table-column-group;\n}\ntd,\nth {\n  display: table-cell;\n}\ncaption {\n  display: table-caption;\n  text-align: center;\n}\nth {\n  font-weight: bolder;\n  text-align: center;\n}\n*[hidden],\nlink,\nstyle,\nscript {\n  display: none;\n}\nh1 {\n  font-size: 2em;\n  margin-block: 0.67em;\n}\nh2 {\n  font-size: 1.5em;\n  margin-block: 0.83em;\n}\nh3 {\n  font-size: 1.17em;\n  margin-block: 1em;\n}\nh4 {\n  font-size: 1em;\n  margin-block: 1.33em;\n}\nh5 {\n  font-size: 0.83em;\n  margin-block: 1.67em;\n}\nh6 {\n  font-size: 0.67em;\n  margin-block: 2.33em;\n}\nh1,\nh2,\nh3,\nh4,\nh5,\nh6 {\n  font-weight: bold;\n  break-after: avoid;\n}\np,\nblockquote,\nfigure,\nul,\nol,\ndl,\ndir,\nmenu {\n  margin-block: 1em;\n}\nb,\nstrong {\n  font-weight: bolder;\n}\nblockquote,\nfigure {\n  margin-inline: 40px;\n}\ni,\ncite,\ndfn,\nem,\nvar,\naddress {\n  font-style: italic;\n}\npre,\ntt,\ncode,\nkbd,\nsamp {\n  font-family: monospace;\n  text-spacing: none;\n  hanging-punctuation: none;\n}\nlisting,\nplaintext,\nxmp,\npre {\n  white-space: pre;\n}\npre[wrap] {\n  white-space: pre-wrap;\n}\nbutton,\ntextarea,\ninput,\nselect {\n  display: inline-block;\n}\nbig {\n  font-size: 1.17em;\n}\nsmall,\nsub,\nsup {\n  font-size: 0.83em;\n}\nsub {\n  vertical-align: sub;\n}\nsup {\n  vertical-align: super;\n}\ntable {\n  box-sizing: border-box;\n  border-spacing: 2px;\n  border-collapse: separate;\n  text-indent: initial;\n}\nthead,\ntbody,\ntfoot,\ntable > tr {\n  vertical-align: middle;\n}\ntr,\ntd,\nth {\n  vertical-align: inherit;\n}\ns,\nstrike,\ndel {\n  text-decoration: line-through;\n}\nhr {\n  border-style: inset;\n  border-width: 1px;\n  margin-block: 0.5em;\n}\nhr[color],\nhr[noshade] {\n  border-style: solid;\n}\nol,\nul,\ndir,\nmenu {\n  padding-inline-start: 40px;\n}\ndd {\n  margin-inline-start: 40px;\n}\nol ul,\nul ol,\nul ul,\nol ol {\n  margin-block: 0;\n}\nul {\n  list-style-type: disc;\n}\nol ul,\nul ul {\n  list-style-type: circle;\n}\nol ol ul,\nol ul ul,\nul ol ul,\nul ul ul {\n  list-style-type: square;\n}\nol { list-style-type: decimal; }\nol[type=\"1\"], li[type=\"1\"] { list-style-type: decimal; }\nol[type=a], li[type=a] { list-style-type: lower-alpha; }\nol[type=A], li[type=A] { list-style-type: upper-alpha; }\nol[type=i], li[type=i] { list-style-type: lower-roman; }\nol[type=I], li[type=I] { list-style-type: upper-roman; }\nul[type=none], li[type=none] { list-style-type: none; }\nul[type=disc], li[type=disc] { list-style-type: disc; }\nul[type=circle], li[type=circle] { list-style-type: circle; }\nul[type=square], li[type=square] { list-style-type: square; }\nu,\nins {\n  text-decoration: underline;\n}\ncenter {\n  text-align: center;\n}\nq::before {\n  content: open-quote;\n}\nq::after {\n  content: close-quote;\n}\n\nruby {\n  display: ruby;\n}\nrp {\n  display: none;\n}\nrbc {\n  display: ruby-base-container;\n}\nrtc {\n  display: ruby-text-container;\n}\nrb {\n  display: ruby-base;\n  white-space: nowrap;\n}\nrt {\n  display: ruby-text;\n}\nrtc,\nrt {\n  text-emphasis: none;\n  white-space: nowrap;\n  line-height: 1;\n}\nrtc,\nrt {\n  font-size: 50%;\n}\nrtc:lang(zh-TW),\nrt:lang(zh-TW) {\n  font-size: 30%;\n}\nrtc > rt,\nrtc > rt:lang(zh-TW) {\n  font-size: 100%;\n}\n\n/* Bidi settings */\nbdo[dir=\"ltr\"] {\n  direction: ltr;\n  unicode-bidi: bidi-override;\n}\nbdo[dir=\"rtl\"] {\n  direction: rtl;\n  unicode-bidi: bidi-override;\n}\n*[dir=\"ltr\"] {\n  direction: ltr;\n  unicode-bidi: isolate;\n}\n*[dir=\"rtl\"] {\n  direction: rtl;\n  unicode-bidi: isolate;\n}\n\n/* MathML */\nm|math[display=\"block\"] {\n  display: block;\n  display: block math;\n}\n\n/*------------------ epub-specific ---------------------*/\n\na[epub|type=\"noteref\"],\na[epub\\\\:type=\"noteref\"] {\n  font-size: 0.75em;\n  vertical-align: super;\n  line-height: 0.01;\n}\n\na[epub|type=\"noteref\"]:href-epub-type(footnote, aside),\na[epub\\\\:type=\"noteref\"]:href-epub-type(footnote, aside) {\n  -adapt-template: footnote;\n  text-decoration: none;\n}\n\naside[epub|type=\"footnote\"],\naside[epub\\\\:type=\"footnote\"] {\n  display: none;\n}\n\naside[epub|type=\"footnote\"]:footnote-content,\naside[epub\\\\:type=\"footnote\"]:footnote-content {\n  display: block;\n  margin: 0.25em;\n  font-size: 1.2em;\n  line-height: 1.2;\n}\n\nepub|trigger {\n  display: none;\n}\n\nepub|switch {\n  display: inline;\n}\n\nepub|default {\n  display: inline;\n}\n\nepub|case {\n  display: none;\n}\n\nepub|case[required-namespace::supported] {\n  display: inline;\n}\n\nepub|case[required-namespace::supported] ~ epub|case {\n  display: none;\n}\n\nepub|case[required-namespace::supported] ~ epub|default {\n  display: none;\n}\n`;\n\n/** user-agent-toc.css */\nexport const UserAgentTocCss = `\n@namespace \"http://www.w3.org/1999/xhtml\";\n\n*:not([data-vivliostyle-role=doc-toc],\n  [data-vivliostyle-role=doc-toc] *,\n  :has([data-vivliostyle-role=doc-toc]),\n  :is(h1,h2,h3,h4,h5,h6):has(+:not(nav)[data-vivliostyle-role=doc-toc])) {\n  display: none;\n}\n\n[hidden] {\n  display: revert;\n}\n\n[data-vivliostyle-role=doc-toc] li a {\n  -adapt-behavior: toc-node-anchor;\n}\n\n[data-vivliostyle-role=doc-toc] li {\n  -adapt-behavior: toc-node;\n}\n\n[data-vivliostyle-role=doc-toc] li > :not(ul,ol):first-child {\n  -adapt-behavior: toc-node-first-child;\n}\n\n[data-vivliostyle-role=doc-toc] :is(ol,ul),\n[data-vivliostyle-role=doc-toc]:is(ol,ul) {\n  -adapt-behavior: toc-container;\n}\n`;\n\n/** vivliostyle-polyfill.css */\nexport const VivliostylePolyfillCss = `\n[data-viv-margin-discard~=\"block-start\"] {\n  margin-block-start: 0 !important;\n}\n[data-viv-margin-discard~=\"block-end\"] {\n  margin-block-end: 0 !important;\n}\n[data-viv-margin-discard~=\"inline-start\"] {\n  margin-inline-start: 0 !important;\n}\n[data-viv-margin-discard~=\"inline-end\"] {\n  margin-inline-end: 0 !important;\n}\n\n[data-viv-box-break~=\"inline-start\"]:not([data-viv-box-break~=\"clone\"]) {\n  margin-inline-start: 0 !important;\n  padding-inline-start: 0 !important;\n  border-inline-start-width: 0 !important;\n  border-start-start-radius: 0 !important;\n  border-end-start-radius: 0 !important;\n}\n[data-viv-box-break~=\"inline-end\"]:not([data-viv-box-break~=\"clone\"]) {\n  margin-inline-end: 0 !important;\n  padding-inline-end: 0 !important;\n  border-inline-end-width: 0 !important;\n  border-start-end-radius: 0 !important;\n  border-end-end-radius: 0 !important;\n}\n[data-viv-box-break~=\"block-start\"]:not([data-viv-box-break~=\"clone\"]):not(table[style*=\"border-collapse: collapse\"]:has(>thead)) {\n  margin-block-start: 0 !important;\n  padding-block-start: 0 !important;\n  border-block-start-width: 0 !important;\n  border-start-start-radius: 0 !important;\n  border-start-end-radius: 0 !important;\n}\n[data-viv-box-break~=\"block-end\"]:not([data-viv-box-break~=\"clone\"]):not(table[style*=\"border-collapse: collapse\"]:has(>tfoot)) {\n  margin-block-end: 0 !important;\n  padding-block-end: 0 !important;\n  border-block-end-width: 0 !important;\n  border-end-start-radius: 0 !important;\n  border-end-end-radius: 0 !important;\n}\n[data-viv-box-break~=\"block-start\"][data-viv-box-break~=\"text-start\"] {\n  text-indent: 0 !important;\n}\n[data-viv-box-break~=\"block-end\"][data-viv-box-break~=\"text-end\"][data-viv-box-break~=\"justify\"] {\n  text-align-last: justify !important;\n}\n[data-viv-box-break~=\"block-end\"][data-viv-box-break~=\"text-end\"][data-viv-box-break~=\"justify\"] > * {\n  text-align-last: auto;\n}\n[data-viv-box-break~=\"block-end\"][data-viv-box-break~=\"text-end\"]:not([data-viv-box-break~=\"justify\"]) {\n  text-align-last: auto !important;\n}\n\nspan.viv-anonymous-block {\n  display: block;\n}\n\n[data-vivliostyle-page-container] {\n  text-spacing-trim: space-all;\n  text-autospace: no-autospace;\n}\nviv-ts-open.viv-ts-auto > viv-ts-inner,\nviv-ts-open.viv-ts-trim > viv-ts-inner {\n  margin-inline-start: -0.5em;\n}\nviv-ts-close.viv-ts-auto > viv-ts-inner,\nviv-ts-close.viv-ts-trim > viv-ts-inner {\n  letter-spacing: -0.5em;\n}\nviv-ts-close.viv-hang-end > viv-ts-inner,\nviv-ts-close.viv-hang-last > viv-ts-inner {\n  letter-spacing: -1em;\n}\nviv-ts-open.viv-ts-auto::before,\nviv-ts-close.viv-ts-auto::after,\nviv-ts-close.viv-hang-end::after {\n  content: \" \";\n  font-family: Courier, monospace;\n  word-spacing: normal;\n  letter-spacing: -0.11em;\n  line-height: 0;\n  text-orientation: mixed;\n  visibility: hidden;\n}\nviv-ts-close.viv-hang-end:not(.viv-hang-hw)::after {\n  letter-spacing: 0.4em;\n}\nviv-ts-close.viv-hang-hw > viv-ts-inner {\n  letter-spacing: -0.5em;\n}\nviv-ts-open.viv-hang-first > viv-ts-inner {\n  display: inline-block;\n  line-height: 1;\n  inline-size: 1em;\n  text-indent: 0;\n  text-align: end;\n  text-align-last: end;\n  margin-inline-start: -1em;\n}\nviv-ts-thin-sp::after {\n  content: \" \";\n  font-family: Times, serif;\n  word-spacing: normal;\n  letter-spacing: -0.125em;\n  line-height: 0;\n  text-orientation: mixed;\n  visibility: hidden;\n}\n[style*=text-decoration] :is(viv-ts-thin-sp, viv-ts-close.viv-ts-auto)::after {\n  visibility: visible;\n}\n\nspan[data-viv-leader] {\n  text-combine-upright: none;\n  text-orientation: mixed;\n  white-space: pre;\n}\n\n/* ::marker */\n/* Mozilla Bullet font (https://github.com/mozilla/gecko-dev/blob/master/layout/style/res/Mozilla_Bullet.woff2) */\n@font-face {\n  font-family: \"-viv-moz-bullet\";\n  src: url(\"data:font/woff2;base64,d09GMgABAAAAAAScAAsAAAAACfAAAARNAAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAABmAAhBIRCAqGMIRJATYCJAMsCxgABCAFhF4HaBsuCMgehXEsLOlXaXd7sgbPQ172fjLwdhYFM92mABaiTuRVdO5/mx9I5UJiJom3phLRQw/TSF2M/vo25+pNyWkNws81NrUDAAf0QOdfcf7nmPEyBPZtCbbZEDuosskKZG922ZhBenh05qcSXktf6s3Oy9dAkWsyDzMoM5QTKcwKNjFayUPSREGFhUMrdE8MJsH052qGcYNO3pbEaYIBoDTItIKGAqhDdKHRD0kkKg6QGSCWEfueTNr3P6OvYaIbDH/8ULEAbjQtUt+hT/qmX/SH/twwMLDqN4jxzXjy4PHtltSA6lINqkpRd7N7onVBP20y7YBWyDIHFEBjqKBFMmECfQcTZtD3MmEB/SATVtCPM2ED/TQTdtCfS0/pEsN4ySin3r8q8xHE+0D0XMg8gJi4YrNpNv3qetXuDyeo6OBNZrq5gi7ouC1zcmB2Fd+FewIhcUIfszpF1hzXhrmMCwxaznRyZjig6Y2W7+bBn2DL8fJu/2oHbWc6X80+LUTXcVzv8O3IOy4qKVyFw/DHaMtfzNQEi5gbFT/EDpiofbpkYq2dQui6WcpfxrVBEJ/KxbLA4ZroZoVx+iE+QeTIiI7oKuoUIk/a1ekEOoNFjozm0suYYUelq13/88K1c3PTH9O9Q0d5LZbu7+J2aT7XP23KyQs+34WTU7r8d/k0l6dLl98Dn+/BSUZc7U0mm7FqhSMO9EHV/j5FB4qYX4aXNaKwz/4RRfAWsW8xGW+hvr8PTAf6IP9mRpkDwwv7QFz9HRuOeGWfd8rkyYsWTVy4vpG/pgVNWzBx0aTeIgeq58XFVfZXVduwuOq51a77aT0XLVw4v1PBFjRsQzO+tVeVp3KIwqfKbd6sdjzGvFSuPMquGpMT29lkrhwbE5uz6cGHhIETB06oUk+6tHLJgfnu/3nVnJzYxiXNjQNjYqsu+vCgYKDla5uUOzTNDZg46eCBd3d3gSk9Kz/bFiv8hvOzCT5eqyjBGerT+EiG/JGqwbC+UQ6Bv9bmKGWMj8Yn+fPVRJxKBGqTFXQyM9DhHSlvEHmLVxyYjY/Fdd3hACfLyP3VVZLvVR7B0pxSsGIBqHhwT5sSMOMkRG0BJhpsWMkEO24KwE0pqp3tIYTWCIjJjuBiGNTKTj8JoBLKAn4TmPFnj9oywZwFGx4egp1g3oObeLHdwUO2pFcYTITZCa2c1GQbNg6RCsu9bpikThhAWnLaBi3LM8+5VbMU6rUn30owOC83ULcfBlClb5BBre46BinaWRal85SUvlCbUx1Nbyj2HWCxBTkEgWScQKzsTioJW0IanAYRZqET4mZLSKU2JABII9np01lQ7lOt3srtM1KAeqgQPhYJSMCZJRuAukRZB1CF35gB1MJBr4ilIPZchNyIlDkpRt+3s96cz9K8XKQvCdZfcqWxgtLoXZ2AoKAyVSRRxSRmsYjVOriP089q3z6gdMjE5KI7kzumWzpnAwAAAA==\") format(\"woff2\");\n}\n[data-adapt-pseudo=\"marker\"] {\n  unicode-bidi: isolate;\n  font-variant-numeric: tabular-nums;\n  white-space: pre;\n  text-transform: none;\n}\n[data-adapt-pseudo=\"marker\"]._viv-marker-bullet {\n  font-family: \"-viv-moz-bullet\";\n  font-style: normal;\n  font-weight: normal;\n}\n[data-adapt-pseudo=\"marker\"]._viv-marker-outside {\n  position: absolute;\n  text-indent: 0;\n}\n[data-adapt-pseudo=\"marker\"] > ._viv-marker-outside-content {\n  position: absolute;\n  inset-inline-end: 0;\n}\n`;\n\nexport const UserAgentCounterStylesCss =\n  // CSS Counter Styles Module Level 3\n  // https://drafts.csswg.org/css-counter-styles/\n  String.raw`\n@counter-style decimal-leading-zero {\n  system: extends decimal;\n  pad: 2 '0';\n}\n@counter-style arabic-indic {\n  system: numeric;\n  symbols: \u0660 \u0661 \u0662 \u0663 \u0664 \u0665 \u0666 \u0667 \u0668 \u0669;\n}\n@counter-style armenian {\n  system: additive;\n  range: 1 9999;\n  additive-symbols: 9000 \u0554, 8000 \u0553, 7000 \u0552, 6000 \u0551, 5000 \u0550, 4000 \u054F, 3000 \u054E, 2000 \u054D, 1000 \u054C, 900 \u054B, 800 \u054A, 700 \u0549, 600 \u0548, 500 \u0547, 400 \u0546, 300 \u0545, 200 \u0544, 100 \u0543, 90 \u0542, 80 \u0541, 70 \u0540, 60 \u053F, 50 \u053E, 40 \u053D, 30 \u053C, 20 \u053B, 10 \u053A, 9 \u0539, 8 \u0538, 7 \u0537, 6 \u0536, 5 \u0535, 4 \u0534, 3 \u0533, 2 \u0532, 1 \u0531;\n}\n@counter-style upper-armenian {\n  system: extends armenian;\n}\n@counter-style lower-armenian {\n  system: additive;\n  range: 1 9999;\n  additive-symbols: 9000 \u0584, 8000 \u0583, 7000 \u0582, 6000 \u0581, 5000 \u0580, 4000 \u057F, 3000 \u057E, 2000 \u057D, 1000 \u057C, 900 \u057B, 800 \u057A, 700 \u0579, 600 \u0578, 500 \u0577, 400 \u0576, 300 \u0575, 200 \u0574, 100 \u0573, 90 \u0572, 80 \u0571, 70 \u0570, 60 \u056F, 50 \u056E, 40 \u056D, 30 \u056C, 20 \u056B, 10 \u056A, 9 \u0569, 8 \u0568, 7 \u0567, 6 \u0566, 5 \u0565, 4 \u0564, 3 \u0563, 2 \u0562, 1 \u0561;\n}\n@counter-style bengali {\n  system: numeric;\n  symbols: \u09E6 \u09E7 \u09E8 \u09E9 \u09EA \u09EB \u09EC \u09ED \u09EE \u09EF;\n}\n@counter-style cambodian {\n  system: numeric;\n  symbols: \u17E0 \u17E1 \u17E2 \u17E3 \u17E4 \u17E5 \u17E6 \u17E7 \u17E8 \u17E9;\n}\n@counter-style khmer {\n  system: extends cambodian;\n}\n@counter-style cjk-decimal {\n  system: numeric;\n  range: 0 infinite;\n  symbols: \u3007 \u4E00 \u4E8C \u4E09 \u56DB \u4E94 \u516D \u4E03 \u516B \u4E5D;\n  suffix: \"\u3001\";\n}\n@counter-style devanagari {\n  system: numeric;\n  symbols: \u0966 \u0967 \u0968 \u0969 \u096A \u096B \u096C \u096D \u096E \u096F;\n}\n@counter-style georgian {\n  system: additive;\n  range: 1 19999;\n  additive-symbols: 10000 \u10F5, 9000 \u10F0, 8000 \u10EF, 7000 \u10F4, 6000 \u10EE, 5000 \u10ED, 4000 \u10EC, 3000 \u10EB, 2000 \u10EA, 1000 \u10E9, 900 \u10E8, 800 \u10E7, 700 \u10E6, 600 \u10E5, 500 \u10E4, 400 \u10F3, 300 \u10E2, 200 \u10E1, 100 \u10E0, 90 \u10DF, 80 \u10DE, 70 \u10DD, 60 \u10F2, 50 \u10DC, 40 \u10DB, 30 \u10DA, 20 \u10D9, 10 \u10D8, 9 \u10D7, 8 \u10F1, 7 \u10D6, 6 \u10D5, 5 \u10D4, 4 \u10D3, 3 \u10D2, 2 \u10D1, 1 \u10D0;\n}\n@counter-style gujarati {\n  system: numeric;\n  symbols: \u0AE6 \u0AE7 \u0AE8 \u0AE9 \u0AEA \u0AEB \u0AEC \u0AED \u0AEE \u0AEF;\n}\n@counter-style gurmukhi {\n  system: numeric;\n  symbols: \u0A66 \u0A67 \u0A68 \u0A69 \u0A6A \u0A6B \u0A6C \u0A6D \u0A6E \u0A6F;\n}\n@counter-style hebrew {\n  system: additive;\n  range: 1 10999;\n  additive-symbols: 10000 \\5D9\\5F3, 9000 \\5D8\\5F3, 8000 \\5D7\\5F3, 7000 \\5D6\\5F3, 6000 \\5D5\\5F3, 5000 \\5D4\\5F3, 4000 \\5D3\\5F3, 3000 \\5D2\\5F3, 2000 \\5D1\\5F3, 1000 \\5D0\\5F3, 400 \\5EA, 300 \\5E9, 200 \\5E8, 100 \\5E7, 90 \\5E6, 80 \\5E4, 70 \\5E2, 60 \\5E1, 50 \\5E0, 40 \\5DE, 30 \\5DC, 20 \\5DB, 19 \\5D9\\5D8, 18 \\5D9\\5D7, 17 \\5D9\\5D6, 16 \\5D8\\5D6, 15 \\5D8\\5D5, 10 \\5D9, 9 \\5D8, 8 \\5D7, 7 \\5D6, 6 \\5D5, 5 \\5D4, 4 \\5D3, 3 \\5D2, 2 \\5D1, 1 \\5D0;\n}\n@counter-style kannada {\n  system: numeric;\n  symbols: \u0CE6 \u0CE7 \u0CE8 \u0CE9 \u0CEA \u0CEB \u0CEC \u0CED \u0CEE \u0CEF;\n}\n@counter-style lao {\n  system: numeric;\n  symbols: \u0ED0 \u0ED1 \u0ED2 \u0ED3 \u0ED4 \u0ED5 \u0ED6 \u0ED7 \u0ED8 \u0ED9;\n}\n@counter-style malayalam {\n  system: numeric;\n  symbols: \u0D66 \u0D67 \u0D68 \u0D69 \u0D6A \u0D6B \u0D6C \u0D6D \u0D6E \u0D6F;\n}\n@counter-style mongolian {\n  system: numeric;\n  symbols: \u1810 \u1811 \u1812 \u1813 \u1814 \u1815 \u1816 \u1817 \u1818 \u1819;\n}\n@counter-style myanmar {\n  system: numeric;\n  symbols: \u1040 \u1041 \u1042 \u1043 \u1044 \u1045 \u1046 \u1047 \u1048 \u1049;\n}\n@counter-style oriya {\n  system: numeric;\n  symbols: \u0B66 \u0B67 \u0B68 \u0B69 \u0B6A \u0B6B \u0B6C \u0B6D \u0B6E \u0B6F;\n}\n@counter-style persian {\n  system: numeric;\n  symbols: \u06F0 \u06F1 \u06F2 \u06F3 \u06F4 \u06F5 \u06F6 \u06F7 \u06F8 \u06F9;\n}\n@counter-style lower-roman {\n  system: additive;\n  range: 1 3999;\n  additive-symbols: 1000 m, 900 cm, 500 d, 400 cd, 100 c, 90 xc, 50 l, 40 xl, 10 x, 9 ix, 5 v, 4 iv, 1 i;\n}\n@counter-style upper-roman {\n  system: additive;\n  range: 1 3999;\n  additive-symbols: 1000 M, 900 CM, 500 D, 400 CD, 100 C, 90 XC, 50 L, 40 XL, 10 X, 9 IX, 5 V, 4 IV, 1 I;\n}\n@counter-style tamil {\n  system: numeric;\n  symbols: \u0BE6 \u0BE7 \u0BE8 \u0BE9 \u0BEA \u0BEB \u0BEC \u0BED \u0BEE \u0BEF;\n}\n@counter-style telugu {\n  system: numeric;\n  symbols: \u0C66 \u0C67 \u0C68 \u0C69 \u0C6A \u0C6B \u0C6C \u0C6D \u0C6E \u0C6F;\n}\n@counter-style thai {\n  system: numeric;\n  symbols: \u0E50 \u0E51 \u0E52 \u0E53 \u0E54 \u0E55 \u0E56 \u0E57 \u0E58 \u0E59;\n}\n@counter-style tibetan {\n  system: numeric;\n  symbols: \u0F20 \u0F21 \u0F22 \u0F23 \u0F24 \u0F25 \u0F26 \u0F27 \u0F28 \u0F29;\n}\n@counter-style lower-alpha {\n  system: alphabetic;\n  symbols: a b c d e f g h i j k l m n o p q r s t u v w x y z;\n}\n@counter-style lower-latin {\n  system: extends lower-alpha;\n}\n@counter-style upper-alpha {\n  system: alphabetic;\n  symbols: A B C D E F G H I J K L M N O P Q R S T U V W X Y Z;\n}\n@counter-style upper-latin {\n  system: extends upper-alpha;\n}\n@counter-style lower-greek {\n  system: alphabetic;\n  symbols: \u03B1 \u03B2 \u03B3 \u03B4 \u03B5 \u03B6 \u03B7 \u03B8 \u03B9 \u03BA \u03BB \u03BC \u03BD \u03BE \u03BF \u03C0 \u03C1 \u03C3 \u03C4 \u03C5 \u03C6 \u03C7 \u03C8 \u03C9;\n}\n@counter-style hiragana {\n  system: alphabetic;\n  symbols: \u3042 \u3044 \u3046 \u3048 \u304A \u304B \u304D \u304F \u3051 \u3053 \u3055 \u3057 \u3059 \u305B \u305D \u305F \u3061 \u3064 \u3066 \u3068 \u306A \u306B \u306C \u306D \u306E \u306F \u3072 \u3075 \u3078 \u307B \u307E \u307F \u3080 \u3081 \u3082 \u3084 \u3086 \u3088 \u3089 \u308A \u308B \u308C \u308D \u308F \u3090 \u3091 \u3092 \u3093;\n  suffix: \"\u3001\";\n}\n@counter-style hiragana-iroha {\n  system: alphabetic;\n  symbols: \u3044 \u308D \u306F \u306B \u307B \u3078 \u3068 \u3061 \u308A \u306C \u308B \u3092 \u308F \u304B \u3088 \u305F \u308C \u305D \u3064 \u306D \u306A \u3089 \u3080 \u3046 \u3090 \u306E \u304A \u304F \u3084 \u307E \u3051 \u3075 \u3053 \u3048 \u3066 \u3042 \u3055 \u304D \u3086 \u3081 \u307F \u3057 \u3091 \u3072 \u3082 \u305B \u3059;\n  suffix: \"\u3001\";\n}\n@counter-style katakana {\n  system: alphabetic;\n  symbols: \u30A2 \u30A4 \u30A6 \u30A8 \u30AA \u30AB \u30AD \u30AF \u30B1 \u30B3 \u30B5 \u30B7 \u30B9 \u30BB \u30BD \u30BF \u30C1 \u30C4 \u30C6 \u30C8 \u30CA \u30CB \u30CC \u30CD \u30CE \u30CF \u30D2 \u30D5 \u30D8 \u30DB \u30DE \u30DF \u30E0 \u30E1 \u30E2 \u30E4 \u30E6 \u30E8 \u30E9 \u30EA \u30EB \u30EC \u30ED \u30EF \u30F0 \u30F1 \u30F2 \u30F3;\n  suffix: \"\u3001\";\n}\n@counter-style katakana-iroha {\n  system: alphabetic;\n  symbols: \u30A4 \u30ED \u30CF \u30CB \u30DB \u30D8 \u30C8 \u30C1 \u30EA \u30CC \u30EB \u30F2 \u30EF \u30AB \u30E8 \u30BF \u30EC \u30BD \u30C4 \u30CD \u30CA \u30E9 \u30E0 \u30A6 \u30F0 \u30CE \u30AA \u30AF \u30E4 \u30DE \u30B1 \u30D5 \u30B3 \u30A8 \u30C6 \u30A2 \u30B5 \u30AD \u30E6 \u30E1 \u30DF \u30B7 \u30F1 \u30D2 \u30E2 \u30BB \u30B9;\n  suffix: \"\u3001\";\n}\n@counter-style cjk-earthly-branch {\n  system: fixed;\n  symbols: \u5B50 \u4E11 \u5BC5 \u536F \u8FB0 \u5DF3 \u5348 \u672A \u7533 \u9149 \u620C \u4EA5;\n  suffix: \"\u3001\";\n  fallback: cjk-decimal;\n}\n@counter-style cjk-heavenly-stem {\n  system: fixed;\n  symbols: \u7532 \u4E59 \u4E19 \u4E01 \u620A \u5DF1 \u5E9A \u8F9B \u58EC \u7678;\n  suffix: \"\u3001\";\n  fallback: cjk-decimal;\n}\n@counter-style japanese-informal {\n  system: additive;\n  range: -9999 9999;\n  additive-symbols: 9000 \u4E5D\u5343, 8000 \u516B\u5343, 7000 \u4E03\u5343, 6000 \u516D\u5343, 5000 \u4E94\u5343, 4000 \u56DB\u5343, 3000 \u4E09\u5343, 2000 \u4E8C\u5343, 1000 \u5343, 900 \u4E5D\u767E, 800 \u516B\u767E, 700 \u4E03\u767E, 600 \u516D\u767E, 500 \u4E94\u767E, 400 \u56DB\u767E, 300 \u4E09\u767E, 200 \u4E8C\u767E, 100 \u767E, 90 \u4E5D\u5341, 80 \u516B\u5341, 70 \u4E03\u5341, 60 \u516D\u5341, 50 \u4E94\u5341, 40 \u56DB\u5341, 30 \u4E09\u5341, 20 \u4E8C\u5341, 10 \u5341, 9 \u4E5D, 8 \u516B, 7 \u4E03, 6 \u516D, 5 \u4E94, 4 \u56DB, 3 \u4E09, 2 \u4E8C, 1 \u4E00, 0 \u3007;\n  suffix: \"\u3001\";\n  negative: \u30DE\u30A4\u30CA\u30B9;\n  fallback: cjk-decimal;\n}\n@counter-style japanese-formal {\n  system: additive;\n  range: -9999 9999;\n  additive-symbols: 9000 \u4E5D\u9621, 8000 \u516B\u9621, 7000 \u4E03\u9621, 6000 \u516D\u9621, 5000 \u4F0D\u9621, 4000 \u56DB\u9621, 3000 \u53C2\u9621, 2000 \u5F10\u9621, 1000 \u58F1\u9621, 900 \u4E5D\u767E, 800 \u516B\u767E, 700 \u4E03\u767E, 600 \u516D\u767E, 500 \u4F0D\u767E, 400 \u56DB\u767E, 300 \u53C2\u767E, 200 \u5F10\u767E, 100 \u58F1\u767E, 90 \u4E5D\u62FE, 80 \u516B\u62FE, 70 \u4E03\u62FE, 60 \u516D\u62FE, 50 \u4F0D\u62FE, 40 \u56DB\u62FE, 30 \u53C2\u62FE, 20 \u5F10\u62FE, 10 \u58F1\u62FE, 9 \u4E5D, 8 \u516B, 7 \u4E03, 6 \u516D, 5 \u4F0D, 4 \u56DB, 3 \u53C2, 2 \u5F10, 1 \u58F1, 0 \u96F6;\n  suffix: \"\u3001\";\n  negative: \u30DE\u30A4\u30CA\u30B9;\n  fallback: cjk-decimal;\n}\n@counter-style korean-hangul-formal {\n  system: additive;\n  range: -9999 9999;\n  additive-symbols: 9000 \uAD6C\uCC9C, 8000 \uD314\uCC9C, 7000 \uCE60\uCC9C, 6000 \uC721\uCC9C, 5000 \uC624\uCC9C, 4000 \uC0AC\uCC9C, 3000 \uC0BC\uCC9C, 2000 \uC774\uCC9C, 1000 \uC77C\uCC9C, 900 \uAD6C\uBC31, 800 \uD314\uBC31, 700 \uCE60\uBC31, 600 \uC721\uBC31, 500 \uC624\uBC31, 400 \uC0AC\uBC31, 300 \uC0BC\uBC31, 200 \uC774\uBC31, 100 \uC77C\uBC31, 90 \uAD6C\uC2ED, 80 \uD314\uC2ED, 70 \uCE60\uC2ED, 60 \uC721\uC2ED, 50 \uC624\uC2ED, 40 \uC0AC\uC2ED, 30 \uC0BC\uC2ED, 20 \uC774\uC2ED, 10 \uC77C\uC2ED, 9 \uAD6C, 8 \uD314, 7 \uCE60, 6 \uC721, 5 \uC624, 4 \uC0AC, 3 \uC0BC, 2 \uC774, 1 \uC77C, 0 \uC601;\n  suffix: ', ';\n  negative: \"\uB9C8\uC774\uB108\uC2A4 \";\n  fallback: cjk-decimal;\n}\n@counter-style korean-hanja-informal {\n  system: additive;\n  range: -9999 9999;\n  additive-symbols: 9000 \u4E5D\u5343, 8000 \u516B\u5343, 7000 \u4E03\u5343, 6000 \u516D\u5343, 5000 \u4E94\u5343, 4000 \u56DB\u5343, 3000 \u4E09\u5343, 2000 \u4E8C\u5343, 1000 \u5343, 900 \u4E5D\u767E, 800 \u516B\u767E, 700 \u4E03\u767E, 600 \u516D\u767E, 500 \u4E94\u767E, 400 \u56DB\u767E, 300 \u4E09\u767E, 200 \u4E8C\u767E, 100 \u767E, 90 \u4E5D\u5341, 80 \u516B\u5341, 70 \u4E03\u5341, 60 \u516D\u5341, 50 \u4E94\u5341, 40 \u56DB\u5341, 30 \u4E09\u5341, 20 \u4E8C\u5341, 10 \u5341, 9 \u4E5D, 8 \u516B, 7 \u4E03, 6 \u516D, 5 \u4E94, 4 \u56DB, 3 \u4E09, 2 \u4E8C, 1 \u4E00, 0 \u96F6;\n  suffix: ', ';\n  negative: \"\uB9C8\uC774\uB108\uC2A4 \";\n  fallback: cjk-decimal;\n}\n@counter-style korean-hanja-formal {\n  system: additive;\n  range: -9999 9999;\n  additive-symbols: 9000 \u4E5D\u4EDF, 8000 \u516B\u4EDF, 7000 \u4E03\u4EDF, 6000 \u516D\u4EDF, 5000 \u4E94\u4EDF, 4000 \u56DB\u4EDF, 3000 \u53C3\u4EDF, 2000 \u8CB3\u4EDF, 1000 \u58F9\u4EDF, 900 \u4E5D\u767E, 800 \u516B\u767E, 700 \u4E03\u767E, 600 \u516D\u767E, 500 \u4E94\u767E, 400 \u56DB\u767E, 300 \u53C3\u767E, 200 \u8CB3\u767E, 100 \u58F9\u767E, 90 \u4E5D\u62FE, 80 \u516B\u62FE, 70 \u4E03\u62FE, 60 \u516D\u62FE, 50 \u4E94\u62FE, 40 \u56DB\u62FE, 30 \u53C3\u62FE, 20 \u8CB3\u62FE, 10 \u58F9\u62FE, 9 \u4E5D, 8 \u516B, 7 \u4E03, 6 \u516D, 5 \u4E94, 4 \u56DB, 3 \u53C3, 2 \u8CB3, 1 \u58F9, 0 \u96F6;\n  suffix: ', ';\n  negative: \"\uB9C8\uC774\uB108\uC2A4 \";\n  fallback: cjk-decimal;\n}\n` +\n  // Ready-made Counter Styles\n  // https://www.w3.org/TR/predefined-counter-styles/\n  // Includes only definitions supported in older versions.\n  `\n@counter-style lower-armenian {\n  system: additive;\n  range: 1 9999;\n  additive-symbols: 9000 \u0584, 8000 \u0583, 7000 \u0582, 6000 \u0581, 5000 \u0580, 4000 \u057F, 3000 \u057E, 2000 \u057D, 1000 \u057C, 900 \u057B, 800 \u057A, 700 \u0579, 600 \u0578, 500 \u0577, 400 \u0576, 300 \u0575, 200 \u0574, 100 \u0573, 90 \u0572, 80 \u0571, 70 \u0570, 60 \u056F, 50 \u056E, 40 \u056D, 30 \u056C, 20 \u056B, 10 \u056A, 9 \u0569, 8 \u0568, 7 \u0567, 6 \u0566, 5 \u0565, 4 \u0564, 3 \u0563, 2 \u0562, 1 \u0561;\n}\n@counter-style upper-armenian {\n  system: additive;\n  range: 1 9999;\n  additive-symbols: 9000 \u0554, 8000 \u0553, 7000 \u0552, 6000 \u0551, 5000 \u0550, 4000 \u054F, 3000 \u054E, 2000 \u054D, 1000 \u054C, 900 \u054B, 800 \u054A, 700 \u0549, 600 \u0548, 500 \u0547, 400 \u0546, 300 \u0545, 200 \u0544, 100 \u0543, 90 \u0542, 80 \u0541, 70 \u0540, 60 \u053F, 50 \u053E, 40 \u053D, 30 \u053C, 20 \u053B, 10 \u053A, 9 \u0539, 8 \u0538, 7 \u0537, 6 \u0536, 5 \u0535, 4 \u0534, 3 \u0533, 2 \u0532, 1 \u0531;\n}\n@counter-style lower-russian {\n  system: alphabetic;\n  symbols: \u0430 \u0431 \u0432 \u0433 \u0434 \u0435 \u0436 \u0437 \u0438 \u043A \u043B \u043C \u043D \u043E \u043F \u0440 \u0441 \u0442 \u0443 \u0444 \u0445 \u0446 \u0447 \u0448 \u0449 \u044D \u044E \u044F;\n  suffix: ') ';\n}\n@counter-style upper-russian {\n  system: alphabetic;\n  symbols: \u0410 \u0411 \u0412 \u0413 \u0414 \u0415 \u0416 \u0417 \u0418 \u041A \u041B \u041C \u041D \u041E \u041F \u0420 \u0421 \u0422 \u0423 \u0424 \u0425 \u0426 \u0427 \u0428 \u0429 \u042D \u042E \u042F;\n}`;\n", "/**\n * Copyright 2013 Google, Inc.\n * Copyright 2015 Daishinsha Inc.\n * Copyright 2019 Vivliostyle Foundation\n *\n * Vivliostyle.js is free software: you can redistribute it and/or modify\n * it under the terms of the GNU Affero General Public License as published by\n * the Free Software Foundation, either version 3 of the License, or\n * (at your option) any later version.\n *\n * Vivliostyle.js is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n * GNU Affero General Public License for more details.\n *\n * You should have received a copy of the GNU Affero General Public License\n * along with Vivliostyle.js.  If not, see <http://www.gnu.org/licenses/>.\n *\n * @fileoverview Net - Fetch resource from a URL.\n */\nimport * as Base from \"./base\";\nimport * as Logging from \"./logging\";\nimport * as Task from \"./task\";\nimport * as TaskUtil from \"./task-util\";\nimport { Net, XmlDoc } from \"./types\";\nimport { UserAgentXml } from \"./assets\";\n\n/**\n * @enum {string}\n */\nexport enum FetchResponseType {\n  DEFAULT = \"\",\n  ARRAYBUFFER = \"arraybuffer\",\n  BLOB = \"blob\",\n  DOCUMENT = \"document\",\n  JSON = \"json\",\n  TEXT = \"text\",\n}\n\nexport type FetchResponse = Net.FetchResponse;\n\nexport function fetchFromURL(\n  url: string,\n  opt_type?: FetchResponseType,\n  opt_method?: string,\n): Task.Result<FetchResponse> {\n  const frame: Task.Frame<FetchResponse> = Task.newFrame(\"fetchFromURL\");\n  const requestInit: RequestInit = {\n    method: opt_method || \"GET\",\n    mode: \"cors\",\n  };\n\n  const continuation = frame.suspend();\n  const response: FetchResponse = {\n    status: 0,\n    statusText: \"\",\n    url,\n    contentType: null,\n    responseText: null,\n    responseXML: null,\n    responseBlob: null,\n  };\n\n  fetch(url, requestInit)\n    .then((res) => {\n      response.status = res.status;\n      response.url = res.url;\n      response.statusText = res.statusText;\n      response.contentType = res.headers\n        .get(\"Content-Type\")\n        ?.replace(/;.*$/, \"\")\n        .toLowerCase();\n\n      if (!res.ok) {\n        // TODO: Handle error response\n        return res.text();\n      }\n      if (opt_type === FetchResponseType.BLOB) {\n        return res.blob();\n      }\n      if (opt_type === FetchResponseType.ARRAYBUFFER) {\n        return res.arrayBuffer();\n      }\n      if (opt_type === FetchResponseType.JSON) {\n        return res.json();\n      }\n\n      // Aozorabunko's (X)HTML support\n      if (\n        /\\/aozorabunko\\/[^/]+\\/cards\\/[^/]+\\/files\\/[^/.]+\\.html$/.test(url)\n      ) {\n        response.contentType = \"text/html\";\n        return res.arrayBuffer().then((buffer) => {\n          const decoder = new TextDecoder(\"Shift_JIS\");\n          const text = decoder.decode(buffer);\n          return text;\n        });\n      }\n      // Treat `data:,<h1>Hello</h1>` as text/html\n      if (/^data:,(<|%3c)/i.test(url)) {\n        response.contentType = \"text/html\";\n      }\n\n      return res.text();\n    })\n    .then((fetchedContent) => {\n      if (\n        opt_type === FetchResponseType.BLOB &&\n        fetchedContent instanceof Blob\n      ) {\n        response.responseBlob = fetchedContent;\n      } else if (\n        opt_type === FetchResponseType.ARRAYBUFFER &&\n        fetchedContent instanceof ArrayBuffer\n      ) {\n        response.responseBlob = makeBlob([fetchedContent]);\n      } else if (opt_type === FetchResponseType.JSON) {\n        response.responseText = JSON.stringify(fetchedContent);\n      } else if (typeof fetchedContent === \"string\") {\n        response.responseText = fetchedContent;\n      }\n      continuation.schedule(response);\n    })\n    .catch((e) => {\n      Logging.logger.warn(e, `Error fetching ${url}`);\n      continuation.schedule(response);\n    });\n  return frame.result();\n}\n\nexport function makeBlob(parts: BlobPart[], opt_type?: string): Blob {\n  const type = opt_type || \"application/octet-stream\";\n  return new Blob(parts, { type });\n}\n\nexport function readBlob(blob: Blob): Task.Result<ArrayBuffer> {\n  const frame: Task.Frame<ArrayBuffer> = Task.newFrame(\"readBlob\");\n  const fileReader = new FileReader();\n  const continuation = frame.suspend(fileReader);\n  fileReader.addEventListener(\n    \"load\",\n    () => {\n      continuation.schedule(fileReader.result as ArrayBuffer);\n    },\n    false,\n  );\n  fileReader.readAsArrayBuffer(blob);\n  return frame.result();\n}\n\nexport function revokeObjectURL(url: string): void {\n  URL.revokeObjectURL(url);\n}\n\n/**\n * @return url\n */\nexport function createObjectURL(blob: Blob): string {\n  return URL.createObjectURL(blob);\n}\n\n/**\n * @template Resource\n */\nexport class ResourceStore<Resource> implements Net.ResourceStore<Resource> {\n  resources: { [key: string]: Resource } = {};\n  fetchers: { [key: string]: TaskUtil.Fetcher<Resource> } = {};\n\n  constructor(\n    public readonly parser: (\n      p1: FetchResponse,\n      p2: ResourceStore<Resource>,\n    ) => Task.Result<Resource>,\n    public readonly type: FetchResponseType,\n  ) {}\n\n  /**\n   * @return resource for the given URL\n   */\n  load(\n    url: string,\n    opt_required?: boolean,\n    opt_message?: string,\n  ): Task.Result<Resource> {\n    url = Base.stripFragment(url);\n    const resource = this.resources[url];\n    if (typeof resource != \"undefined\") {\n      return Task.newResult(resource);\n    }\n    return this.fetch(url, opt_required, opt_message).get();\n  }\n\n  private fetchInner(\n    url: string,\n    opt_required?: boolean,\n    opt_message?: string,\n  ): Task.Result<Resource> {\n    const frame: Task.Frame<Resource> = Task.newFrame(\"fetch\");\n\n    // Hack for TOCView.showTOC()\n    const isTocBox = url.endsWith(\"?viv-toc-box\");\n    if (isTocBox) {\n      url = url.replace(\"?viv-toc-box\", \"\");\n    }\n    const userAgentXmlUrl = Base.resolveURL(\n      \"user-agent.xml\",\n      Base.resourceBaseURL,\n    );\n    const isUserAgentXml = !isTocBox && url === userAgentXmlUrl;\n    if (isUserAgentXml) {\n      // Change \"user-agent.xml\" URL to data URL\n      url = `data:application/xml,${encodeURIComponent(UserAgentXml)}`;\n    }\n\n    fetchFromURL(url, this.type).then((response) => {\n      if (response.status >= 400) {\n        if (opt_required) {\n          throw new Error(\n            (opt_message || `Failed to fetch required resource: ${url}`) +\n              ` (${response.status}${\n                response.statusText ? \" \" + response.statusText : \"\"\n              })`,\n          );\n        }\n      }\n      if (isTocBox) {\n        // Hack for TOCView.showTOC()\n        url += \"?viv-toc-box\";\n        response.url += \"?viv-toc-box\";\n      } else if (isUserAgentXml) {\n        // Restore \"user-agent.xml\" URL\n        response.url = url = userAgentXmlUrl;\n      }\n      this.parser(response, this).then((resource) => {\n        delete this.fetchers[url];\n        this.resources[url] = resource;\n        frame.finish(resource);\n      });\n    });\n    return frame.result();\n  }\n\n  /**\n   * @return fetcher for the resource for the given URL\n   */\n  fetch(\n    url: string,\n    opt_required?: boolean,\n    opt_message?: string,\n  ): TaskUtil.Fetcher<Resource> {\n    url = Base.stripFragment(url);\n    const resource = this.resources[url];\n    if (resource) {\n      return null;\n    }\n    let fetcher = this.fetchers[url];\n    if (!fetcher) {\n      fetcher = new TaskUtil.Fetcher(\n        () => this.fetchInner(url, opt_required, opt_message),\n        `Fetch ${url}`,\n      );\n      this.fetchers[url] = fetcher;\n      fetcher.start();\n    }\n    return fetcher;\n  }\n\n  get(url: string): XmlDoc.XMLDocHolder {\n    const resource: unknown = this.resources[Base.stripFragment(url)];\n    return resource as XmlDoc.XMLDocHolder;\n  }\n\n  delete(url: string) {\n    delete this.resources[Base.stripFragment(url)];\n  }\n}\n\nexport type JSONStore = ResourceStore<Base.JSON>;\n\nexport function parseJSONResource(\n  response: FetchResponse,\n  store: JSONStore,\n): Task.Result<Base.JSON> {\n  const text = response.responseText;\n  return Task.newResult(text ? Base.stringToJSON(text) : null);\n}\n\nexport function newJSONStore(): JSONStore {\n  return new ResourceStore(parseJSONResource, FetchResponseType.TEXT);\n}\n\n/**\n * @return holding event type (load/error/abort)\n */\nexport function loadElement(\n  elem: Element,\n  src?: string,\n  alt?: string,\n): TaskUtil.Fetcher<string> {\n  const fetcher = new TaskUtil.Fetcher(\n    () => {\n      const frame: Task.Frame<string> = Task.newFrame(\"loadElement\");\n      const continuation = frame.suspend(elem);\n      let done = false;\n      let timeoutId: number | null = null;\n      const handler = (evt: Event) => {\n        if (done) {\n          return;\n        } else {\n          done = true;\n        }\n        // Clear timeout to prevent unnecessary callback execution\n        if (timeoutId !== null) {\n          clearTimeout(timeoutId);\n          timeoutId = null;\n        }\n        continuation.schedule(evt ? evt.type : \"timeout\");\n      };\n      elem.addEventListener(\"load\", handler, false);\n      elem.addEventListener(\"error\", handler, false);\n      elem.addEventListener(\"abort\", handler, false);\n      if (elem.namespaceURI == Base.NS.SVG) {\n        if (src) {\n          elem.setAttributeNS(Base.NS.XLINK, \"xlink:href\", src);\n        }\n        // SVG handlers are not reliable\n        timeoutId = setTimeout(handler, 300);\n      } else if (elem.localName === \"script\") {\n        timeoutId = setTimeout(handler, 3000);\n      } else if (src) {\n        if (elem.localName === \"img\") {\n          const imgElem = elem as HTMLImageElement;\n          // Remove loading=\"lazy\" attribute to ensure images load immediately\n          // for proper pagination (Vivliostyle needs image dimensions for layout)\n          if (imgElem.loading === \"lazy\") {\n            imgElem.loading = \"eager\";\n          }\n          imgElem.src = src;\n          if (alt) {\n            imgElem.alt = alt;\n          }\n          // Handle already cached images\n          if (imgElem.complete) {\n            // Image already loaded (from cache)\n            setTimeout(() => handler(new Event(\"load\")), 0);\n          } else {\n            // Set a longer timeout to handle slow networks and large images\n            timeoutId = setTimeout(handler, 30000);\n          }\n        } else {\n          (elem as any).src = src;\n          if (alt) {\n            (elem as any).alt = alt;\n          }\n        }\n      }\n      return frame.result();\n    },\n    `loadElement ${src || elem.localName}`,\n  );\n  fetcher.start();\n  return fetcher;\n}\n", "/**\n * Copyright 2013 Google, Inc.\n * Copyright 2015 Daishinsha Inc.\n * Copyright 2019 Vivliostyle Foundation\n *\n * Vivliostyle.js is free software: you can redistribute it and/or modify\n * it under the terms of the GNU Affero General Public License as published by\n * the Free Software Foundation, either version 3 of the License, or\n * (at your option) any later version.\n *\n * Vivliostyle.js is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n * GNU Affero General Public License for more details.\n *\n * You should have received a copy of the GNU Affero General Public License\n * along with Vivliostyle.js.  If not, see <http://www.gnu.org/licenses/>.\n *\n * @fileoverview CssParser - CSS Parser.\n */\nimport * as Base from \"./base\";\nimport * as Css from \"./css\";\nimport * as CssTokenizer from \"./css-tokenizer\";\nimport * as Exprs from \"./exprs\";\nimport * as Logging from \"./logging\";\nimport * as Net from \"./net\";\nimport * as Task from \"./task\";\nimport { TokenType } from \"./css-tokenizer\";\n\n/**\n * User agent stylesheet base specificity.\n */\nexport const SPECIFICITY_USER_AGENT: number = 0;\n\n/**\n * User stylesheet base specificity.\n */\nexport const SPECIFICITY_USER: number = 0x1000000;\n\n/**\n * Author stylesheet (\"normal\" stylesheet) base specificity.\n */\nexport const SPECIFICITY_AUTHOR: number = 0x2000000;\n\n/**\n * Style attribute base specificity.\n */\nexport const SPECIFICITY_STYLE: number = 0x3000000;\n\n/**\n * Style attribute base specificity when !important is used.\n */\nexport const SPECIFICITY_STYLE_IMPORTANT: number = 0x4000000;\n\n/**\n * Author stylesheet base specificity when !important is used.\n */\nexport const SPECIFICITY_AUTHOR_IMPORTANT: number = 0x5000000;\n\n/**\n * User stylesheet base specificity when !important is used.\n */\nexport const SPECIFICITY_USER_IMPORTANT: number = 0x6000000;\n\n/**\n * @enum {string}\n */\nexport enum StylesheetFlavor {\n  USER_AGENT = \"UA\",\n  USER = \"User\",\n  AUTHOR = \"Author\",\n}\n\nexport class ParserHandler implements CssTokenizer.TokenizerHandler {\n  flavor: StylesheetFlavor;\n\n  constructor(public scope: Exprs.LexicalScope) {\n    this.flavor = StylesheetFlavor.AUTHOR;\n  }\n\n  getCurrentToken(): CssTokenizer.Token {\n    return null;\n  }\n\n  getScope(): Exprs.LexicalScope {\n    return this.scope;\n  }\n\n  error(mnemonics: string, token: CssTokenizer.Token): void {}\n\n  startStylesheet(flavor: StylesheetFlavor): void {\n    this.flavor = flavor;\n  }\n\n  tagSelector(ns: string | null, name: string | null): void {}\n\n  classSelector(name: string): void {}\n\n  pseudoclassSelector(name: string, params: (number | string)[]): void {}\n\n  pseudoelementSelector(name: string, params: (number | string)[]): void {}\n\n  idSelector(id: string): void {}\n\n  attributeSelector(\n    ns: string,\n    name: string,\n    op: TokenType,\n    value: string | null,\n  ): void {}\n\n  descendantSelector(): void {}\n\n  childSelector(): void {}\n\n  adjacentSiblingSelector(): void {}\n\n  followingSiblingSelector(): void {}\n\n  nextSelector(): void {}\n\n  startSelectorRule(): void {}\n\n  startFontFaceRule(): void {}\n\n  startCounterStyleRule(name: string): void {}\n\n  startFootnoteRule(pseudoelem: string | null): void {}\n\n  startViewportRule(): void {}\n\n  startDefineRule(): void {}\n\n  startRegionRule(): void {}\n\n  startPageRule(): void {}\n\n  startPageMarginBoxRule(name: string): void {}\n\n  startWhenRule(expr: Css.Expr): void {}\n\n  startMediaRule(expr: Css.Expr): void {\n    this.startWhenRule(expr);\n  }\n\n  startFlowRule(flowName: string): void {}\n\n  startPageTemplateRule(): void {}\n\n  startPageMasterRule(\n    name: string | null,\n    pseudoName: string | null,\n    classes: string[],\n  ): void {}\n\n  startPartitionRule(\n    name: string | null,\n    pseudoName: string | null,\n    classes: string[],\n  ): void {}\n\n  startPartitionGroupRule(\n    name: string | null,\n    pseudoName: string | null,\n    classes: string[],\n  ): void {}\n\n  startRuleBody(): void {}\n\n  property(name: string, value: Css.Val, important: boolean): void {}\n\n  endRule(): void {}\n\n  /**\n   * @param funcName The name of the function taking a selector list as argument\n   */\n  startFuncWithSelector(funcName: string): void {}\n\n  endFuncWithSelector(): void {}\n\n  /**\n   * For relational pseudo-class `:has()` support\n   */\n  pushSelectorText(selectorText: string) {}\n\n  getImportantSpecificity(): number {\n    switch (this.flavor) {\n      case StylesheetFlavor.USER_AGENT:\n        return SPECIFICITY_USER_AGENT;\n      case StylesheetFlavor.USER:\n        return SPECIFICITY_USER_IMPORTANT;\n      default:\n        return SPECIFICITY_AUTHOR_IMPORTANT;\n    }\n  }\n\n  getBaseSpecificity(): number {\n    switch (this.flavor) {\n      case StylesheetFlavor.USER_AGENT:\n        return SPECIFICITY_USER_AGENT;\n      case StylesheetFlavor.USER:\n        return SPECIFICITY_USER;\n      default:\n        return SPECIFICITY_AUTHOR;\n    }\n  }\n}\n\nexport class DispatchParserHandler extends ParserHandler {\n  stack: ParserHandler[] = [];\n  tokenizer: CssTokenizer.Tokenizer = null;\n  slave: ParserHandler = null;\n\n  constructor() {\n    super(null);\n  }\n\n  pushHandler(slave: ParserHandler): void {\n    this.stack.push(this.slave);\n    this.slave = slave;\n  }\n\n  popHandler(): void {\n    this.slave = this.stack.pop();\n  }\n\n  override getCurrentToken(): CssTokenizer.Token {\n    if (this.tokenizer) {\n      return this.tokenizer.token();\n    }\n    return null;\n  }\n\n  override getScope(): Exprs.LexicalScope {\n    return this.slave.getScope();\n  }\n\n  /**\n   * Forwards call to slave.\n   * @override\n   */\n  error(mnemonics: string, token: CssTokenizer.Token): void {\n    this.slave.error(mnemonics, token);\n  }\n\n  /**\n   * Called by a slave.\n   */\n  errorMsg(mnemonics: string, token: CssTokenizer.Token): void {\n    Logging.logger.warn(mnemonics, token?.toString() ?? \"\");\n  }\n\n  override startStylesheet(flavor: StylesheetFlavor): void {\n    super.startStylesheet(flavor);\n    if (this.stack.length > 0) {\n      // This can occur as a result of an error\n      this.slave = this.stack[0];\n      this.stack = [];\n    }\n    this.slave.startStylesheet(flavor);\n  }\n\n  override tagSelector(ns: string | null, name: string | null): void {\n    this.slave.tagSelector(ns, name);\n  }\n\n  override classSelector(name: string): void {\n    this.slave.classSelector(name);\n  }\n\n  override pseudoclassSelector(\n    name: string,\n    params: (number | string)[],\n  ): void {\n    this.slave.pseudoclassSelector(name, params);\n  }\n\n  override pseudoelementSelector(\n    name: string,\n    params: (number | string)[],\n  ): void {\n    this.slave.pseudoelementSelector(name, params);\n  }\n\n  override idSelector(id: string): void {\n    this.slave.idSelector(id);\n  }\n\n  override attributeSelector(\n    ns: string,\n    name: string,\n    op: TokenType,\n    value: string | null,\n  ): void {\n    this.slave.attributeSelector(ns, name, op, value);\n  }\n\n  override descendantSelector(): void {\n    this.slave.descendantSelector();\n  }\n\n  override childSelector(): void {\n    this.slave.childSelector();\n  }\n\n  override adjacentSiblingSelector(): void {\n    this.slave.adjacentSiblingSelector();\n  }\n\n  override followingSiblingSelector(): void {\n    this.slave.followingSiblingSelector();\n  }\n\n  override nextSelector(): void {\n    this.slave.nextSelector();\n  }\n\n  override startSelectorRule(): void {\n    this.slave.startSelectorRule();\n  }\n\n  override startFontFaceRule(): void {\n    this.slave.startFontFaceRule();\n  }\n\n  override startCounterStyleRule(name: string): void {\n    this.slave.startCounterStyleRule(name);\n  }\n\n  override startFootnoteRule(pseudoelem: string | null): void {\n    this.slave.startFootnoteRule(pseudoelem);\n  }\n\n  override startViewportRule(): void {\n    this.slave.startViewportRule();\n  }\n\n  override startDefineRule(): void {\n    this.slave.startDefineRule();\n  }\n\n  override startRegionRule(): void {\n    this.slave.startRegionRule();\n  }\n\n  override startPageRule(): void {\n    this.slave.startPageRule();\n  }\n\n  override startPageMarginBoxRule(name: string): void {\n    this.slave.startPageMarginBoxRule(name);\n  }\n\n  override startWhenRule(expr: Css.Expr): void {\n    this.slave.startWhenRule(expr);\n  }\n\n  override startFlowRule(flowName: string): void {\n    this.slave.startFlowRule(flowName);\n  }\n\n  override startPageTemplateRule(): void {\n    this.slave.startPageTemplateRule();\n  }\n\n  override startPageMasterRule(\n    name: string | null,\n    pseudoName: string | null,\n    classes: string[],\n  ): void {\n    this.slave.startPageMasterRule(name, pseudoName, classes);\n  }\n\n  override startPartitionRule(\n    name: string | null,\n    pseudoName: string | null,\n    classes: string[],\n  ): void {\n    this.slave.startPartitionRule(name, pseudoName, classes);\n  }\n\n  override startPartitionGroupRule(\n    name: string | null,\n    pseudoName: string | null,\n    classes: string[],\n  ): void {\n    this.slave.startPartitionGroupRule(name, pseudoName, classes);\n  }\n\n  override startRuleBody(): void {\n    this.slave.startRuleBody();\n  }\n\n  override property(name: string, value: Css.Val, important: boolean): void {\n    this.slave.property(name, value, important);\n  }\n\n  override endRule(): void {\n    this.slave.endRule();\n  }\n\n  override startFuncWithSelector(funcName: string): void {\n    this.slave.startFuncWithSelector(funcName);\n  }\n\n  override endFuncWithSelector(): void {\n    this.slave.endFuncWithSelector();\n  }\n\n  override pushSelectorText(selectorText: string): void {\n    this.slave.pushSelectorText(selectorText);\n  }\n}\n\nexport class SkippingParserHandler extends ParserHandler {\n  depth: number = 0;\n\n  constructor(\n    scope: Exprs.LexicalScope,\n    public owner: DispatchParserHandler,\n    public readonly topLevel,\n  ) {\n    super(scope);\n    if (owner) {\n      this.flavor = owner.flavor;\n    }\n  }\n\n  override getCurrentToken(): CssTokenizer.Token {\n    return this.owner?.getCurrentToken();\n  }\n\n  override error(mnemonics: string, token: CssTokenizer.Token): void {\n    this.owner?.errorMsg(mnemonics, token);\n  }\n\n  override startRuleBody(): void {\n    this.depth++;\n  }\n\n  override endRule(): void {\n    if (--this.depth == 0 && !this.topLevel) {\n      this.owner.popHandler();\n    }\n  }\n}\n\nexport class SlaveParserHandler extends SkippingParserHandler {\n  constructor(\n    scope: Exprs.LexicalScope,\n    owner: DispatchParserHandler,\n    topLevel: boolean,\n  ) {\n    super(scope, owner, topLevel);\n  }\n\n  report(message: string): void {\n    this.error(message, this.getCurrentToken());\n  }\n\n  reportAndSkip(message: string): void {\n    this.report(message);\n    this.owner.pushHandler(\n      new SkippingParserHandler(this.scope, this.owner, false),\n    );\n  }\n\n  override startSelectorRule(): void {\n    this.reportAndSkip(\"E_CSS_UNEXPECTED_SELECTOR\");\n  }\n\n  override startFontFaceRule(): void {\n    this.reportAndSkip(\"E_CSS_UNEXPECTED_FONT_FACE\");\n  }\n\n  override startCounterStyleRule(name: string): void {\n    this.reportAndSkip(\"E_CSS_UNEXPECTED_COUNTER_STYLE\");\n  }\n\n  override startFootnoteRule(pseudoelem: string | null): void {\n    this.reportAndSkip(\"E_CSS_UNEXPECTED_FOOTNOTE\");\n  }\n\n  override startViewportRule(): void {\n    this.reportAndSkip(\"E_CSS_UNEXPECTED_VIEWPORT\");\n  }\n\n  override startDefineRule(): void {\n    this.reportAndSkip(\"E_CSS_UNEXPECTED_DEFINE\");\n  }\n\n  override startRegionRule(): void {\n    this.reportAndSkip(\"E_CSS_UNEXPECTED_REGION\");\n  }\n\n  override startPageRule(): void {\n    this.reportAndSkip(\"E_CSS_UNEXPECTED_PAGE\");\n  }\n\n  override startWhenRule(expr: Css.Expr): void {\n    this.reportAndSkip(\"E_CSS_UNEXPECTED_WHEN\");\n  }\n\n  override startFlowRule(flowName: string): void {\n    this.reportAndSkip(\"E_CSS_UNEXPECTED_FLOW\");\n  }\n\n  override startPageTemplateRule(): void {\n    this.reportAndSkip(\"E_CSS_UNEXPECTED_PAGE_TEMPLATE\");\n  }\n\n  override startPageMasterRule(\n    name: string | null,\n    pseudoName: string | null,\n    classes: string[],\n  ): void {\n    this.reportAndSkip(\"E_CSS_UNEXPECTED_PAGE_MASTER\");\n  }\n\n  override startPartitionRule(\n    name: string | null,\n    pseudoName: string | null,\n    classes: string[],\n  ): void {\n    this.reportAndSkip(\"E_CSS_UNEXPECTED_PARTITION\");\n  }\n\n  override startPartitionGroupRule(\n    name: string | null,\n    pseudoName: string | null,\n    classes: string[],\n  ): void {\n    this.reportAndSkip(\"E_CSS_UNEXPECTED_PARTITION_GROUP\");\n  }\n\n  override startFuncWithSelector(funcName: string): void {\n    this.reportAndSkip(\"E_CSS_UNEXPECTED_SELECTOR_FUNC\");\n  }\n\n  override endFuncWithSelector(): void {\n    this.reportAndSkip(\"E_CSS_UNEXPECTED_END_SELECTOR_FUNC\");\n  }\n\n  override property(name: string, value: Css.Val, important: boolean): void {\n    this.error(\"E_CSS_UNEXPECTED_PROPERTY\", this.getCurrentToken());\n  }\n}\n\nexport const actionsBase: Action[] = [];\n\nexport const actionsStyleAttribute: Action[] = [];\n\nexport const actionsSelector: Action[] = [];\n\nexport const actionsSelectorInFunc: Action[] = [];\n\nexport const actionsSelectorCont: Action[] = [];\n\nexport const actionsSelectorStart: Action[] = [];\n\nexport const actionsPropVal: Action[] = [];\n\nexport const actionsExprVal: Action[] = [];\n\nexport const actionsExprOp: Action[] = [];\n\nexport const actionsError: Action[] = [];\n\nexport const actionsErrorDecl: Action[] = [];\n\nexport const actionsErrorSelector: Action[] = [];\n\nexport const priority: number[] = [];\n\n/**\n * @enum {number}\n */\nexport enum Action {\n  SELECTOR_NAME_1 = 1,\n  SELECTOR_NAME,\n  SELECTOR_ANY_1,\n  SELECTOR_ANY,\n  SELECTOR_ID_1,\n  SELECTOR_ID,\n  SELECTOR_CLASS_1,\n  SELECTOR_CLASS,\n  SELECTOR_ATTR_1,\n  SELECTOR_ATTR,\n  SELECTOR_CHILD,\n  SELECTOR_SIBLING,\n  SELECTOR_BODY,\n  SELECTOR_PSEUDOCLASS,\n  VAL_IDENT,\n  VAL_HASH,\n  VAL_NUM,\n  VAL_INT,\n  VAL_NUMERIC,\n  VAL_STR,\n  VAL_URL,\n  VAL_COMMA,\n  VAL_SLASH,\n  VAL_FUNC,\n  VAL_C_PAR,\n  VAL_END,\n  RULE_END,\n  IDENT,\n  SELECTOR_START,\n  AT,\n  EXPR_IDENT,\n  EXPR_NUM,\n  EXPR_NUMERIC,\n  EXPR_STR,\n  EXPR_PARAM,\n  EXPR_PREFIX,\n  EXPR_INFIX,\n  EXPR_FUNC,\n  EXPR_C_PAR,\n  EXPR_O_PAR,\n  SELECTOR_NEXT,\n  SELECTOR_PSEUDOELEM,\n  EXPR_O_BRC,\n  VAL_FINISH,\n  EXPR_INFIX_NAME,\n  PROP,\n  VAL_BANG,\n  VAL_BRC,\n  EXPR_SEMICOL,\n  ERROR_PUSH,\n  ERROR_POP,\n  ERROR_POP_DECL,\n  ERROR_SEMICOL,\n  VAL_PLUS,\n  SELECTOR_PSEUDOCLASS_1,\n  SELECTOR_FOLLOWING_SIBLING,\n  VAL_URANGE,\n  SELECTOR_PSEUDOELEM_1,\n  DONE = 200,\n}\n\nexport const OP_MEDIA_AND: number = TokenType.LAST + 1;\nexport const OP_MEDIA_OR: number = TokenType.LAST + 2;\nexport const OP_MEDIA_NOT: number = TokenType.LAST + 3;\n\n(() => {\n  actionsBase[TokenType.IDENT] = Action.IDENT;\n  actionsBase[TokenType.STAR] = Action.SELECTOR_START;\n  actionsBase[TokenType.HASH] = Action.SELECTOR_START;\n  actionsBase[TokenType.CLASS] = Action.SELECTOR_START;\n  actionsBase[TokenType.O_BRK] = Action.SELECTOR_START;\n  actionsBase[TokenType.COLON] = Action.SELECTOR_START;\n  actionsBase[TokenType.COL_COL] = Action.SELECTOR_START;\n  actionsBase[TokenType.AT] = Action.AT;\n  actionsBase[TokenType.C_BRC] = Action.RULE_END;\n  actionsBase[TokenType.EOF] = Action.DONE;\n  actionsStyleAttribute[TokenType.IDENT] = Action.PROP;\n  actionsStyleAttribute[TokenType.EOF] = Action.DONE;\n  actionsSelectorStart[TokenType.IDENT] = Action.SELECTOR_NAME;\n  actionsSelectorStart[TokenType.STAR] = Action.SELECTOR_ANY;\n  actionsSelectorStart[TokenType.HASH] = Action.SELECTOR_ID;\n  actionsSelectorStart[TokenType.CLASS] = Action.SELECTOR_CLASS;\n  actionsSelectorStart[TokenType.O_BRK] = Action.SELECTOR_ATTR;\n  actionsSelectorStart[TokenType.COLON] = Action.SELECTOR_PSEUDOCLASS;\n  actionsSelectorStart[TokenType.COL_COL] = Action.SELECTOR_PSEUDOELEM;\n\n  actionsSelector[TokenType.GT] = Action.SELECTOR_CHILD;\n  actionsSelector[TokenType.PLUS] = Action.SELECTOR_SIBLING;\n  actionsSelector[TokenType.TILDE] = Action.SELECTOR_FOLLOWING_SIBLING;\n  actionsSelector[TokenType.IDENT] = Action.SELECTOR_NAME_1;\n  actionsSelector[TokenType.STAR] = Action.SELECTOR_ANY_1;\n  actionsSelector[TokenType.HASH] = Action.SELECTOR_ID_1;\n  actionsSelector[TokenType.CLASS] = Action.SELECTOR_CLASS_1;\n  actionsSelector[TokenType.O_BRK] = Action.SELECTOR_ATTR_1;\n  actionsSelector[TokenType.O_BRC] = Action.SELECTOR_BODY;\n  actionsSelector[TokenType.COLON] = Action.SELECTOR_PSEUDOCLASS_1;\n  actionsSelector[TokenType.COL_COL] = Action.SELECTOR_PSEUDOELEM_1;\n  actionsSelector[TokenType.COMMA] = Action.SELECTOR_NEXT;\n  actionsSelectorInFunc[TokenType.GT] = Action.SELECTOR_CHILD;\n  actionsSelectorInFunc[TokenType.PLUS] = Action.SELECTOR_SIBLING;\n  actionsSelectorInFunc[TokenType.TILDE] = Action.SELECTOR_FOLLOWING_SIBLING;\n  actionsSelectorInFunc[TokenType.IDENT] = Action.SELECTOR_NAME_1;\n  actionsSelectorInFunc[TokenType.STAR] = Action.SELECTOR_ANY_1;\n  actionsSelectorInFunc[TokenType.HASH] = Action.SELECTOR_ID_1;\n  actionsSelectorInFunc[TokenType.CLASS] = Action.SELECTOR_CLASS_1;\n  actionsSelectorInFunc[TokenType.O_BRK] = Action.SELECTOR_ATTR_1;\n  actionsSelectorInFunc[TokenType.COLON] = Action.SELECTOR_PSEUDOCLASS_1;\n  actionsSelectorCont[TokenType.IDENT] = Action.SELECTOR_NAME;\n  actionsSelectorCont[TokenType.STAR] = Action.SELECTOR_ANY;\n  actionsSelectorCont[TokenType.HASH] = Action.SELECTOR_ID;\n  actionsSelectorCont[TokenType.CLASS] = Action.SELECTOR_CLASS;\n  actionsSelectorCont[TokenType.COLON] = Action.SELECTOR_PSEUDOCLASS;\n  actionsSelectorCont[TokenType.COL_COL] = Action.SELECTOR_PSEUDOELEM;\n  actionsSelectorCont[TokenType.O_BRK] = Action.SELECTOR_ATTR;\n  actionsSelectorCont[TokenType.O_BRC] = Action.SELECTOR_BODY;\n  actionsPropVal[TokenType.IDENT] = Action.VAL_IDENT;\n  actionsPropVal[TokenType.HASH] = Action.VAL_HASH;\n  actionsPropVal[TokenType.NUM] = Action.VAL_NUM;\n  actionsPropVal[TokenType.INT] = Action.VAL_INT;\n  actionsPropVal[TokenType.NUMERIC] = Action.VAL_NUMERIC;\n  actionsPropVal[TokenType.STR] = Action.VAL_STR;\n  actionsPropVal[TokenType.URL] = Action.VAL_URL;\n  actionsPropVal[TokenType.URANGE] = Action.VAL_URANGE;\n  actionsPropVal[TokenType.COMMA] = Action.VAL_COMMA;\n  actionsPropVal[TokenType.SLASH] = Action.VAL_SLASH;\n  actionsPropVal[TokenType.FUNC] = Action.VAL_FUNC;\n  actionsPropVal[TokenType.C_PAR] = Action.VAL_C_PAR;\n  actionsPropVal[TokenType.SEMICOL] = Action.VAL_END;\n  actionsPropVal[TokenType.C_BRC] = Action.VAL_BRC;\n  actionsPropVal[TokenType.BANG] = Action.VAL_BANG;\n  actionsPropVal[TokenType.PLUS] = Action.VAL_PLUS;\n  actionsPropVal[TokenType.EOF] = Action.VAL_FINISH;\n  actionsExprVal[TokenType.IDENT] = Action.EXPR_IDENT;\n  actionsExprVal[TokenType.NUM] = Action.EXPR_NUM;\n  actionsExprVal[TokenType.INT] = Action.EXPR_NUM;\n  actionsExprVal[TokenType.NUMERIC] = Action.EXPR_NUMERIC;\n  actionsExprVal[TokenType.STR] = Action.EXPR_STR;\n  actionsExprVal[TokenType.O_PAR] = Action.EXPR_O_PAR;\n  actionsExprVal[TokenType.FUNC] = Action.EXPR_FUNC;\n  actionsExprVal[TokenType.BANG] = Action.EXPR_PREFIX;\n  actionsExprVal[TokenType.MINUS] = Action.EXPR_PREFIX;\n  actionsExprVal[TokenType.DOLLAR] = Action.EXPR_PARAM;\n  actionsExprOp[TokenType.IDENT] = Action.EXPR_INFIX_NAME;\n  actionsExprOp[TokenType.COMMA] = Action.EXPR_INFIX;\n  actionsExprOp[TokenType.GT] = Action.EXPR_INFIX;\n  actionsExprOp[TokenType.LT] = Action.EXPR_INFIX;\n  actionsExprOp[TokenType.GT_EQ] = Action.EXPR_INFIX;\n  actionsExprOp[TokenType.LT_EQ] = Action.EXPR_INFIX;\n  actionsExprOp[TokenType.EQ] = Action.EXPR_INFIX;\n  actionsExprOp[TokenType.EQ_EQ] = Action.EXPR_INFIX;\n  actionsExprOp[TokenType.BANG_EQ] = Action.EXPR_INFIX;\n  actionsExprOp[TokenType.AMP_AMP] = Action.EXPR_INFIX;\n  actionsExprOp[TokenType.BAR_BAR] = Action.EXPR_INFIX;\n  actionsExprOp[TokenType.PLUS] = Action.EXPR_INFIX;\n  actionsExprOp[TokenType.MINUS] = Action.EXPR_INFIX;\n  actionsExprOp[TokenType.SLASH] = Action.EXPR_INFIX;\n  actionsExprOp[TokenType.PERCENT] = Action.EXPR_INFIX;\n  actionsExprOp[TokenType.STAR] = Action.EXPR_INFIX;\n  actionsExprOp[TokenType.COLON] = Action.EXPR_INFIX;\n  actionsExprOp[TokenType.QMARK] = Action.EXPR_INFIX;\n  actionsExprOp[TokenType.C_PAR] = Action.EXPR_C_PAR;\n  actionsExprOp[TokenType.O_BRC] = Action.EXPR_O_BRC;\n  actionsExprOp[TokenType.SEMICOL] = Action.EXPR_SEMICOL;\n  actionsError[TokenType.EOF] = Action.DONE;\n  actionsError[TokenType.O_BRC] = Action.ERROR_PUSH;\n  actionsError[TokenType.C_BRC] = Action.ERROR_POP;\n  actionsError[TokenType.O_BRK] = Action.ERROR_PUSH;\n  actionsError[TokenType.C_BRK] = Action.ERROR_POP;\n  actionsError[TokenType.O_PAR] = Action.ERROR_PUSH;\n  actionsError[TokenType.C_PAR] = Action.ERROR_POP;\n  actionsError[TokenType.SEMICOL] = Action.ERROR_SEMICOL;\n  actionsErrorDecl[TokenType.EOF] = Action.DONE;\n  actionsErrorDecl[TokenType.O_BRC] = Action.ERROR_PUSH;\n  actionsErrorDecl[TokenType.C_BRC] = Action.ERROR_POP_DECL;\n  actionsErrorDecl[TokenType.O_BRK] = Action.ERROR_PUSH;\n  actionsErrorDecl[TokenType.C_BRK] = Action.ERROR_POP;\n  actionsErrorDecl[TokenType.O_PAR] = Action.ERROR_PUSH;\n  actionsErrorDecl[TokenType.C_PAR] = Action.ERROR_POP;\n  actionsErrorDecl[TokenType.SEMICOL] = Action.ERROR_SEMICOL;\n  actionsErrorSelector[TokenType.EOF] = Action.DONE;\n  actionsErrorSelector[TokenType.O_BRC] = Action.ERROR_PUSH;\n  actionsErrorSelector[TokenType.C_BRC] = Action.ERROR_POP;\n  actionsErrorSelector[TokenType.O_BRK] = Action.ERROR_PUSH;\n  actionsErrorSelector[TokenType.C_BRK] = Action.ERROR_POP;\n  actionsErrorSelector[TokenType.O_PAR] = Action.ERROR_PUSH;\n  actionsErrorSelector[TokenType.C_PAR] = Action.ERROR_POP;\n  priority[TokenType.C_PAR] = 0;\n  priority[TokenType.COMMA] = 0;\n  priority[TokenType.QMARK] = 1;\n  priority[TokenType.COLON] = 1;\n  priority[TokenType.AMP_AMP] = 2;\n  priority[TokenType.BAR_BAR] = 2;\n  priority[TokenType.LT] = 3;\n  priority[TokenType.GT] = 3;\n  priority[TokenType.LT_EQ] = 3;\n  priority[TokenType.GT_EQ] = 3;\n  priority[TokenType.EQ] = 3;\n  priority[TokenType.EQ_EQ] = 3;\n  priority[TokenType.BANG_EQ] = 3;\n  priority[TokenType.PLUS] = 4;\n  priority[TokenType.MINUS] = 4;\n  priority[TokenType.STAR] = 5;\n  priority[TokenType.SLASH] = 5;\n  priority[TokenType.PERCENT] = 5;\n  priority[TokenType.EOF] = 6;\n  priority[OP_MEDIA_AND] = 2;\n  priority[OP_MEDIA_OR] = 2;\n})();\n\n/**\n * @enum {number}\n */\nexport enum ExprContext {\n  PROP,\n  WHEN,\n  MEDIA,\n  IMPORT,\n  SUPPORTS,\n}\n\nexport class Parser {\n  valStack: any[] = [];\n  namespacePrefixToURI: { [key: string]: string } = {};\n  defaultNamespaceURI: string | null = null;\n  propName: string | null = null;\n  propImportant: boolean = false;\n  exprContext: ExprContext;\n  result: Css.Val = null;\n  importReady: boolean = false;\n  importURL: string | null = null;\n  importCondition: Css.Expr = null;\n  errorBrackets: number[] = [];\n  ruleStack: string[] = [];\n  regionRule: boolean = false;\n  pageRule: boolean = false;\n  inStyleDeclaration: boolean = false;\n\n  constructor(\n    public actions: Action[],\n    public tokenizer: CssTokenizer.Tokenizer,\n    public readonly handler: ParserHandler,\n    public baseURL: string,\n  ) {\n    this.exprContext = ExprContext.MEDIA;\n  }\n\n  extractVals(sep: string, index: number): Css.Val[] {\n    const arr: Css.Val[] = [];\n    const valStack = this.valStack;\n    while (index < valStack.length) {\n      arr.push(valStack[index++] as Css.Val);\n      if (index === valStack.length) {\n        break;\n      }\n      if (valStack[index++] !== sep) {\n        throw new Error(\"Unexpected state\");\n      }\n      if (index === valStack.length) {\n        // keep last comma in `var(--b , )`\n        arr.push(Css.empty);\n      }\n    }\n    return arr;\n  }\n\n  valStackReduce(sep: string, token: CssTokenizer.Token): Css.Val {\n    const valStack = this.valStack;\n    let index = valStack.length;\n    let parLevel = 0;\n    let v;\n    do {\n      v = valStack[--index];\n      if (sep === \")\" && v instanceof Css.AnyToken) {\n        // For nested parens in calc() (Issue #1014)\n        if (v.text === \")\") {\n          parLevel++;\n        } else if (v.text === \"(\") {\n          if (parLevel === 0) {\n            return null;\n          }\n          parLevel--;\n        }\n      }\n    } while (typeof v != \"undefined\" && typeof v != \"string\");\n    let count = valStack.length - (index + 1);\n    if (count > 1) {\n      valStack.splice(\n        index + 1,\n        count,\n        new Css.SpaceList(valStack.slice(index + 1, valStack.length)),\n      );\n    }\n    if (sep == \",\") {\n      return null;\n    }\n    index++;\n    do {\n      v = valStack[--index];\n    } while (typeof v != \"undefined\" && (typeof v != \"string\" || v == \",\"));\n    count = valStack.length - (index + 1);\n    if (v == \"(\") {\n      if (sep != \")\") {\n        if (token.type !== TokenType.EOF) {\n          this.handler.error(\"E_CSS_MISMATCHED_C_PAR\", token);\n          this.actions = actionsErrorDecl;\n        }\n      }\n      const func = new Css.Func(\n        valStack[index - 1] as string,\n        this.extractVals(\",\", index + 1),\n      );\n      valStack.splice(index - 1, count + 2, func);\n\n      // Check invalid var()\n      if (func.name === \"var\") {\n        const name = func.values[0] instanceof Css.Ident && func.values[0].name;\n        if (!Css.isCustomPropName(name) || name === this.propName) {\n          this.handler.error(`E_CSS_INVALID_VAR ${func.toString()}`, token);\n          this.actions = actionsErrorDecl;\n        }\n      }\n      return func;\n    }\n    if (sep != \";\" || index >= 0) {\n      this.handler.error(\"E_CSS_UNEXPECTED_VAL_END\", token);\n      this.actions = actionsErrorDecl;\n      return null;\n    }\n    if (count > 1) {\n      return new Css.CommaList(this.extractVals(\",\", index + 1));\n    }\n    const val = valStack[0];\n    if (val instanceof Css.Val) {\n      return val;\n    } else if (!val) {\n      return Css.empty;\n    } else {\n      // custom property value can be arbitrary token e.g. \",\"\n      return new Css.AnyToken(val.toString());\n    }\n  }\n\n  exprError(mnemonics: string, token: CssTokenizer.Token) {\n    this.actions = this.propName ? actionsErrorDecl : actionsError;\n    // this.handler.error(mnemonics, token);\n    // (should not throw error by expression syntax errors)\n    Logging.logger.warn(mnemonics, token.toString());\n  }\n\n  exprStackReduce(op: number, token: CssTokenizer.Token): boolean {\n    const valStack = this.valStack;\n    const handler = this.handler;\n    let val = valStack.pop() as Exprs.Val;\n    let val2: Exprs.Val;\n    while (true) {\n      let tok = valStack.pop();\n      if (op == TokenType.C_PAR) {\n        const args: Exprs.Val[] = [val];\n        while (tok == TokenType.COMMA) {\n          args.unshift(valStack.pop());\n          tok = valStack.pop();\n        }\n        if (typeof tok == \"string\") {\n          if (tok == \"{\") {\n            // reached CSS portion of the stack\n            while (args.length >= 2) {\n              const e1 = args.shift();\n              const e2 = args.shift();\n              const er = new Exprs.Comma(handler.getScope(), e1, e2);\n              args.unshift(er);\n            }\n            valStack.push(new Css.Expr(args[0]));\n            return true;\n          } else if (tok == \"(\") {\n            // call\n            const name2 = valStack.pop() as string;\n            const name1 = valStack.pop() as string | null;\n            val = new Exprs.Call(\n              handler.getScope(),\n              Exprs.makeQualifiedName(name1, name2),\n              args,\n            );\n            op = TokenType.EOF;\n            continue;\n          }\n        }\n        if (tok == TokenType.O_PAR) {\n          if (val.isMediaName()) {\n            val = new Exprs.MediaTest(\n              handler.getScope(),\n              val as Exprs.MediaName,\n              null,\n            );\n          }\n          op = TokenType.EOF;\n          continue;\n        }\n      } else {\n        if (typeof tok == \"string\") {\n          // reached CSS portion of the stack or a call\n          valStack.push(tok);\n          break;\n        }\n      }\n      if ((tok as number) < 0) {\n        // prefix\n        if (tok == -TokenType.BANG) {\n          val = new Exprs.Not(handler.getScope(), val);\n        } else if (tok == -TokenType.MINUS) {\n          val = new Exprs.Negate(handler.getScope(), val);\n        } else if (tok == -OP_MEDIA_NOT) {\n          // `not` operator in `@media` or `@supports`\n          val = new Exprs.NotMedia(handler.getScope(), val);\n        } else {\n          this.exprError(\"F_UNEXPECTED_STATE\", token);\n          return false;\n        }\n      } else {\n        // infix\n        if (priority[op] > priority[tok as number]) {\n          valStack.push(tok);\n          break;\n        }\n        val2 = valStack.pop() as Exprs.Val;\n        switch (tok) {\n          case TokenType.AMP_AMP:\n            val = new Exprs.And(handler.getScope(), val2, val);\n            break;\n          case OP_MEDIA_AND:\n            // `and` operator in `@media` or `@supports`\n            val = new Exprs.AndMedia(handler.getScope(), val2, val);\n            break;\n          case OP_MEDIA_OR:\n            // `or` operator in `@media` or `@supports`\n            val = new Exprs.OrMedia(handler.getScope(), val2, val);\n            break;\n          case TokenType.BAR_BAR:\n            val = new Exprs.Or(handler.getScope(), val2, val);\n            break;\n          case TokenType.LT:\n            val = new Exprs.Lt(handler.getScope(), val2, val);\n            break;\n          case TokenType.GT:\n            val = new Exprs.Gt(handler.getScope(), val2, val);\n            break;\n          case TokenType.LT_EQ:\n            val = new Exprs.Le(handler.getScope(), val2, val);\n            break;\n          case TokenType.GT_EQ:\n            val = new Exprs.Ge(handler.getScope(), val2, val);\n            break;\n          case TokenType.EQ:\n          case TokenType.EQ_EQ:\n            val = new Exprs.Eq(handler.getScope(), val2, val);\n            break;\n          case TokenType.BANG_EQ:\n            val = new Exprs.Ne(handler.getScope(), val2, val);\n            break;\n          case TokenType.PLUS:\n            val = new Exprs.Add(handler.getScope(), val2, val);\n            break;\n          case TokenType.MINUS:\n            val = new Exprs.Subtract(handler.getScope(), val2, val);\n            break;\n          case TokenType.STAR:\n            val = new Exprs.Multiply(handler.getScope(), val2, val);\n            break;\n          case TokenType.SLASH:\n            val = new Exprs.Divide(handler.getScope(), val2, val);\n            break;\n          case TokenType.PERCENT:\n            val = new Exprs.Modulo(handler.getScope(), val2, val);\n            break;\n          case TokenType.COLON:\n            if (valStack.length > 1) {\n              switch (valStack[valStack.length - 1]) {\n                case TokenType.QMARK:\n                  valStack.pop();\n                  val = new Exprs.Cond(\n                    handler.getScope(),\n                    valStack.pop() as Exprs.Val,\n                    val2,\n                    val,\n                  );\n                  break;\n                case TokenType.O_PAR:\n                  if (val2.isMediaName()) {\n                    val = new Exprs.MediaTest(\n                      handler.getScope(),\n                      val2 as Exprs.MediaName,\n                      val,\n                    );\n                  } else {\n                    this.exprError(\"E_CSS_MEDIA_TEST\", token);\n                    return false;\n                  }\n                  break;\n              }\n            } else {\n              this.exprError(\"E_CSS_EXPR_COND\", token);\n              return false;\n            }\n            break;\n          case TokenType.QMARK:\n            if (op != TokenType.COLON) {\n              this.exprError(\"E_CSS_EXPR_COND\", token);\n              return false;\n            }\n\n          // fall through\n          case TokenType.O_PAR:\n            // don't reduce\n            valStack.push(val2);\n            valStack.push(tok);\n            valStack.push(val);\n            return false;\n          default:\n            this.exprError(\"F_UNEXPECTED_STATE\", token);\n            return false;\n        }\n      }\n    }\n    valStack.push(val);\n    return false;\n  }\n\n  readSupportsTest(token: CssTokenizer.Token): Exprs.SupportsTest {\n    // `@supports (prop-name:...)`\n    // `@supports func-name(...)`\n    const isFunc = token.type === TokenType.FUNC;\n    const tokenizer = this.tokenizer;\n    let startPosition: number;\n    let name: string;\n    if (isFunc) {\n      name = token.text;\n      startPosition = token.position + name.length + 1;\n    } else if (token.type === TokenType.O_PAR) {\n      const token1 = tokenizer.nthToken(1);\n      const token2 = tokenizer.nthToken(2);\n      if (token1.type === TokenType.IDENT && token2.type === TokenType.COLON) {\n        tokenizer.consume();\n        tokenizer.consume();\n        name = token1.text;\n        startPosition = token2.position + 1;\n      } else if (\n        token1.type === TokenType.O_PAR ||\n        token1.type === TokenType.FUNC ||\n        (token1.type === TokenType.IDENT &&\n          token1.text.toLowerCase() === \"not\" &&\n          (token2.type === TokenType.O_PAR || token2.type === TokenType.FUNC))\n      ) {\n        return null;\n      } else {\n        // Unknown `(...)` syntax, read until `)` and evaluate to false\n        startPosition = token.position + 1;\n      }\n    } else {\n      return null;\n    }\n    let parLevel = 0;\n    let tokenN: CssTokenizer.Token;\n    let commaCount = 0;\n    while (parLevel >= 0) {\n      tokenizer.consume();\n      tokenN = tokenizer.token();\n      switch (tokenN.type) {\n        case TokenType.C_PAR:\n          parLevel--;\n          break;\n        case TokenType.O_PAR:\n        case TokenType.FUNC:\n          parLevel++;\n          break;\n        case TokenType.COMMA:\n          if (parLevel === 0) {\n            commaCount++;\n          }\n          break;\n        case TokenType.EOF:\n          this.exprError(\"E_CSS_UNEXPECTED_EOF\", tokenN);\n          return null;\n      }\n    }\n    tokenizer.consume();\n    const endPosition = tokenN.position;\n    const value =\n      isFunc && name === \"selector\" && commaCount > 0\n        ? \"\" // selector() with multiple selectors doesn't work\n        : tokenizer.input.substring(startPosition, endPosition).trim();\n    const supportsTest = new Exprs.SupportsTest(\n      this.handler.getScope(),\n      name,\n      value,\n      isFunc,\n    );\n    return supportsTest;\n  }\n\n  readPseudoParams(): (number | string)[] {\n    const arr = [];\n    while (true) {\n      const token = this.tokenizer.token();\n      switch (token.type) {\n        case TokenType.IDENT:\n          arr.push(token.text);\n          break;\n        case TokenType.PLUS:\n          arr.push(\"+\");\n          break;\n        case TokenType.NUM:\n        case TokenType.INT:\n          arr.push(token.num);\n          break;\n        default:\n          return arr;\n      }\n      this.tokenizer.consume();\n    }\n  }\n\n  /**\n   * Read `an+b` argument of pseudoclasses. Roughly based on the algorithm at\n   * https://drafts.csswg.org/css-syntax/#the-anb-type\n   */\n  private readNthPseudoParams(): number[] | null {\n    let hasLeadingPlus = false;\n    let token = this.tokenizer.token();\n    if (token.type === TokenType.PLUS) {\n      // '+'\n      hasLeadingPlus = true;\n      this.tokenizer.consume();\n      token = this.tokenizer.token();\n    } else if (\n      token.type === TokenType.IDENT &&\n      (token.text === \"even\" || token.text === \"odd\")\n    ) {\n      // 'even' or 'odd'\n      this.tokenizer.consume();\n      return [2, token.text === \"odd\" ? 1 : 0];\n    }\n    switch (token.type) {\n      case TokenType.NUMERIC:\n        if (hasLeadingPlus && token.num < 0) {\n          // reject '+-an'\n          return null;\n        }\n\n      // FALLTHROUGH\n      case TokenType.IDENT:\n        if (hasLeadingPlus && token.text.charAt(0) === \"-\") {\n          // reject '+-n'\n          return null;\n        }\n        if (token.text === \"n\" || token.text === \"-n\") {\n          // 'an', 'an +b', 'an -b', 'n', 'n +b', 'n -b', '-n', '-n +b' '-n -b'\n          if (hasLeadingPlus && token.precededBySpace) {\n            // reject '+ an'\n            return null;\n          }\n          let a = token.text === \"-n\" ? -1 : 1;\n          if (token.type === TokenType.NUMERIC) {\n            a = token.num;\n          }\n          let b = 0;\n          this.tokenizer.consume();\n          token = this.tokenizer.token();\n          const hasMinusSign = token.type === TokenType.MINUS;\n          const hasSign = token.type === TokenType.PLUS || hasMinusSign;\n          if (hasSign) {\n            // 'an +b', 'an - b'\n            this.tokenizer.consume();\n            token = this.tokenizer.token();\n          }\n          if (token.type === TokenType.INT) {\n            b = token.num;\n\n            if (1 / b === 1 / -0) {\n              // negative zero: 'an -0'\n              b = 0;\n              if (hasSign) {\n                return null; // reject 'an + -0', 'an - -0'\n              }\n            } else if (b < 0) {\n              // negative: 'an -b'\n              if (hasSign) {\n                return null; // reject 'an + -b', 'an - -b'\n              }\n            } else if (b >= 0) {\n              // positive or positive zero: 'an +b'\n              if (!hasSign) {\n                return null;\n              }\n            }\n            this.tokenizer.consume();\n          } else if (hasSign) {\n            // reject 'an + (non-integer)'\n            return null;\n          }\n          return [a, hasMinusSign && b > 0 ? -b : b];\n        } else if (token.text === \"n-\" || token.text === \"-n-\") {\n          // 'an- b', '-n- b'\n          if (hasLeadingPlus && token.precededBySpace) {\n            // reject '+ an- b'\n            return null;\n          }\n          let a = token.text === \"-n-\" ? -1 : 1;\n          if (token.type === TokenType.NUMERIC) {\n            a = token.num;\n          }\n          this.tokenizer.consume();\n          token = this.tokenizer.token();\n          if (token.type === TokenType.INT) {\n            if (token.num < 0 || 1 / token.num === 1 / -0) {\n              // reject 'an- -b', 'an- -0'\n              return null;\n            } else {\n              this.tokenizer.consume();\n              return [a, token.num];\n            }\n          }\n        } else {\n          let r = token.text.match(/^n(-[0-9]+)$/);\n          if (r) {\n            // 'n-b', 'an-b'\n            if (hasLeadingPlus && token.precededBySpace) {\n              // reject '+ an-b'\n              return null;\n            }\n            this.tokenizer.consume();\n            return [\n              token.type === TokenType.NUMERIC ? token.num : 1,\n              parseInt(r[1], 10),\n            ];\n          }\n          r = token.text.match(/^-n(-[0-9]+)$/);\n\n          // '-n-b'\n          if (r) {\n            this.tokenizer.consume();\n            return [-1, parseInt(r[1], 10)];\n          }\n        }\n        return null;\n      case TokenType.INT:\n        if (hasLeadingPlus && (token.precededBySpace || token.num < 0)) {\n          return null;\n        }\n        this.tokenizer.consume();\n        return [0, token.num];\n    }\n    return null;\n  }\n\n  makeCondition(classes: string | null, condition: Exprs.Val): Css.Expr {\n    const scope = this.handler.getScope();\n    if (!scope) {\n      return null;\n    }\n    condition = condition || scope._true;\n    if (classes) {\n      const classList = classes.split(/\\s+/);\n      for (const className of classList) {\n        switch (className) {\n          case \"vertical\":\n            condition = Exprs.and(\n              scope,\n              condition,\n              new Exprs.Not(scope, new Exprs.Named(scope, \"pref-horizontal\")),\n            );\n            break;\n          case \"horizontal\":\n            condition = Exprs.and(\n              scope,\n              condition,\n              new Exprs.Named(scope, \"pref-horizontal\"),\n            );\n            break;\n          case \"day\":\n            condition = Exprs.and(\n              scope,\n              condition,\n              new Exprs.Not(scope, new Exprs.Named(scope, \"pref-night-mode\")),\n            );\n            break;\n          case \"night\":\n            condition = Exprs.and(\n              scope,\n              condition,\n              new Exprs.Named(scope, \"pref-night-mode\"),\n            );\n            break;\n          default:\n            condition = scope._false;\n        }\n      }\n    }\n    if (condition === scope._true) {\n      return null;\n    }\n    return new Css.Expr(condition);\n  }\n\n  isInsidePropertyOnlyRule(): boolean {\n    switch (this.ruleStack[this.ruleStack.length - 1]) {\n      case \"[selector]\":\n      case \"font-face\":\n      case \"counter-style\":\n      case \"-epubx-flow\":\n      case \"-epubx-viewport\":\n      case \"-epubx-define\":\n      case \"-adapt-footnote-area\":\n        return true;\n    }\n    return false;\n  }\n\n  runParser(\n    count: number,\n    parsingValue: boolean,\n    parsingStyleAttr: boolean,\n    parsingMediaQuery: boolean,\n    parsingFunctionParam: boolean,\n    parsingRelationalSelector?: boolean,\n  ): boolean {\n    const handler = this.handler;\n    const tokenizer = this.tokenizer;\n    const valStack = this.valStack;\n    let token: CssTokenizer.Token;\n    let token1: CssTokenizer.Token;\n    let ns: string | null;\n    let text: string | null;\n    let num: number;\n    let val: Css.Val;\n    let params: (number | string)[];\n    let selectorStartPosition: number | null = null;\n\n    if (parsingStyleAttr) {\n      this.inStyleDeclaration = true;\n    }\n    if (parsingMediaQuery) {\n      this.exprContext = ExprContext.MEDIA;\n      this.valStack.push(\"{\");\n    }\n\n    for (; count > 0; --count) {\n      token = tokenizer.token();\n\n      // For relational pseudo-class `:has()` support\n      if (parsingFunctionParam && selectorStartPosition === null) {\n        // token.position may be token's start position + 1\n        selectorStartPosition = token.position - 1;\n        if (tokenizer.input[selectorStartPosition] === \"(\") {\n          selectorStartPosition++;\n        }\n      }\n\n      // Do not stop parsing on invalid property syntax as long as brackets are balanced.\n      if (\n        this.actions === actionsPropVal &&\n        this.errorBrackets.length > 0 &&\n        (token.type === this.errorBrackets[this.errorBrackets.length - 1] ||\n          token.type === TokenType.SEMICOL ||\n          token.type === TokenType.BANG)\n      ) {\n        if (token.type === this.errorBrackets[this.errorBrackets.length - 1]) {\n          this.errorBrackets.pop();\n          if (token.type === TokenType.C_PAR) {\n            // For nested func in parens (Issue #1014)\n            if (this.valStackReduce(\")\", token)) {\n              tokenizer.consume();\n              continue;\n            }\n          }\n        }\n        valStack.push(new Css.AnyToken(token.toString()));\n        tokenizer.consume();\n        continue;\n      }\n\n      switch (this.actions[token.type]) {\n        case Action.IDENT:\n          // figure out if this is a property assignment or selector\n          if (\n            !this.inStyleDeclaration ||\n            tokenizer.nthToken(1).type != TokenType.COLON\n          ) {\n            // cannot be property assignment\n            if (this.isInsidePropertyOnlyRule()) {\n              handler.error(\"E_CSS_COLON_EXPECTED\", tokenizer.nthToken(1));\n              this.actions = actionsErrorDecl;\n            } else {\n              this.actions = actionsSelectorStart;\n              handler.startSelectorRule();\n            }\n            continue;\n          }\n          // property assignment\n          this.propName = token.text;\n          this.propImportant = false;\n          tokenizer.consume();\n          tokenizer.consume();\n          this.actions = actionsPropVal;\n          valStack.splice(0, valStack.length);\n          continue;\n        case Action.PROP:\n          // figure out if this is a property assignment or selector\n          if (tokenizer.nthToken(1).type != TokenType.COLON) {\n            // cannot be property assignment\n            this.actions = actionsErrorDecl;\n            handler.error(\"E_CSS_COLON_EXPECTED\", tokenizer.nthToken(1));\n            continue;\n          }\n          this.propName = token.text;\n          this.propImportant = false;\n          tokenizer.consume();\n          tokenizer.consume();\n          this.actions = actionsPropVal;\n          valStack.splice(0, valStack.length);\n          continue;\n        case Action.SELECTOR_START:\n          // don't consume, process again\n          this.actions = actionsSelectorStart;\n          handler.startSelectorRule();\n          continue;\n        case Action.SELECTOR_NAME_1:\n          if (!token.precededBySpace) {\n            this.actions = actionsErrorSelector;\n            handler.error(\"E_CSS_SPACE_EXPECTED\", token);\n            continue;\n          }\n          handler.descendantSelector();\n\n        // fall through\n        case Action.SELECTOR_NAME:\n          if (tokenizer.nthToken(1).type == TokenType.BAR) {\n            tokenizer.consume();\n            tokenizer.consume();\n            ns = this.namespacePrefixToURI[token.text];\n            if (ns != null) {\n              token = tokenizer.token();\n              switch (token.type) {\n                case TokenType.IDENT:\n                  handler.tagSelector(ns, token.text);\n                  if (parsingFunctionParam) {\n                    this.actions = actionsSelectorInFunc;\n                  } else {\n                    this.actions = actionsSelector;\n                  }\n                  tokenizer.consume();\n                  break;\n                case TokenType.STAR:\n                  handler.tagSelector(ns, null);\n                  if (parsingFunctionParam) {\n                    this.actions = actionsSelectorInFunc;\n                  } else {\n                    this.actions = actionsSelector;\n                  }\n                  tokenizer.consume();\n                  break;\n                default:\n                  this.actions = actionsError;\n                  handler.error(\"E_CSS_NAMESPACE\", token);\n              }\n            } else {\n              this.actions = actionsError;\n              handler.error(\"E_CSS_UNDECLARED_PREFIX\", token);\n            }\n          } else {\n            handler.tagSelector(this.defaultNamespaceURI, token.text);\n            if (parsingFunctionParam) {\n              this.actions = actionsSelectorInFunc;\n            } else {\n              this.actions = actionsSelector;\n            }\n            tokenizer.consume();\n          }\n          continue;\n        case Action.SELECTOR_ANY_1:\n          if (!token.precededBySpace) {\n            this.actions = actionsErrorSelector;\n            handler.error(\"E_CSS_SPACE_EXPECTED\", token);\n            continue;\n          }\n          handler.descendantSelector();\n\n        // fall through\n        case Action.SELECTOR_ANY:\n          if (tokenizer.nthToken(1).type == TokenType.BAR) {\n            tokenizer.consume();\n            tokenizer.consume();\n            token = tokenizer.token();\n            switch (token.type) {\n              case TokenType.IDENT:\n                handler.tagSelector(null, token.text);\n                if (parsingFunctionParam) {\n                  this.actions = actionsSelectorInFunc;\n                } else {\n                  this.actions = actionsSelector;\n                }\n                tokenizer.consume();\n                break;\n              case TokenType.STAR:\n                handler.tagSelector(null, null);\n                if (parsingFunctionParam) {\n                  this.actions = actionsSelectorInFunc;\n                } else {\n                  this.actions = actionsSelector;\n                }\n                tokenizer.consume();\n                break;\n              default:\n                this.actions = actionsError;\n                handler.error(\"E_CSS_NAMESPACE\", token);\n            }\n          } else {\n            handler.tagSelector(this.defaultNamespaceURI, null);\n            if (parsingFunctionParam) {\n              this.actions = actionsSelectorInFunc;\n            } else {\n              this.actions = actionsSelector;\n            }\n            tokenizer.consume();\n          }\n          continue;\n        case Action.SELECTOR_ID_1:\n          if (token.precededBySpace) {\n            handler.descendantSelector();\n          }\n\n        // fall through\n        case Action.SELECTOR_ID:\n          if (!token.text) {\n            handler.error(\"E_CSS_SYNTAX\", token);\n            tokenizer.consume();\n            continue;\n          }\n          handler.idSelector(token.text);\n          if (parsingFunctionParam) {\n            this.actions = actionsSelectorInFunc;\n          } else {\n            this.actions = actionsSelector;\n          }\n          tokenizer.consume();\n          continue;\n        case Action.SELECTOR_CLASS_1:\n          if (token.precededBySpace) {\n            handler.descendantSelector();\n          }\n\n        // fall through\n        case Action.SELECTOR_CLASS:\n          handler.classSelector(token.text);\n          if (parsingFunctionParam) {\n            this.actions = actionsSelectorInFunc;\n          } else {\n            this.actions = actionsSelector;\n          }\n          tokenizer.consume();\n          continue;\n        case Action.SELECTOR_PSEUDOCLASS_1:\n          if (token.precededBySpace) {\n            handler.descendantSelector();\n          }\n\n        // fall through\n        case Action.SELECTOR_PSEUDOCLASS:\n          tokenizer.consume();\n          token = tokenizer.token();\n          pseudoclassType: switch (token.type) {\n            case TokenType.IDENT:\n              handler.pseudoclassSelector(token.text, null);\n              tokenizer.consume();\n              if (parsingFunctionParam) {\n                this.actions = actionsSelectorInFunc;\n              } else {\n                this.actions = actionsSelector;\n              }\n              continue;\n            case TokenType.FUNC:\n              text = token.text;\n              tokenizer.consume();\n              switch (text) {\n                case \"is\":\n                case \"not\":\n                case \"where\":\n                case \"has\":\n                  this.actions = actionsSelectorStart;\n                  handler.startFuncWithSelector(text);\n                  if (\n                    this.runParser(\n                      Number.POSITIVE_INFINITY,\n                      false,\n                      false,\n                      false,\n                      true,\n                      text === \"has\",\n                    )\n                  ) {\n                    this.actions = actionsSelector;\n                  } else {\n                    this.actions = actionsErrorSelector;\n                  }\n                  continue;\n                case \"lang\":\n                case \"href-epub-type\":\n                  token = tokenizer.token();\n                  if (token.type === TokenType.IDENT) {\n                    params = [token.text];\n                    tokenizer.consume();\n                    if (\n                      text === \"href-epub-type\" &&\n                      tokenizer.token().type === TokenType.COMMA\n                    ) {\n                      tokenizer.consume();\n                      token = tokenizer.token();\n                      if (token.type === TokenType.IDENT) {\n                        params.push(token.text);\n                        tokenizer.consume();\n                      }\n                    }\n                    break;\n                  } else {\n                    break pseudoclassType;\n                  }\n                case \"nth-child\":\n                case \"nth-of-type\":\n                case \"nth-last-child\":\n                case \"nth-last-of-type\":\n                case \"nth\":\n                  params = this.readNthPseudoParams();\n                  if (!params) {\n                    break pseudoclassType;\n                  } else {\n                    break;\n                  }\n                default:\n                  // TODO\n                  params = this.readPseudoParams();\n              }\n              token = tokenizer.token();\n              if (token.type == TokenType.C_PAR) {\n                handler.pseudoclassSelector(text as string, params);\n                tokenizer.consume();\n                if (parsingFunctionParam) {\n                  this.actions = actionsSelectorInFunc;\n                } else {\n                  this.actions = actionsSelector;\n                }\n                continue;\n              }\n              break;\n          }\n          handler.error(\"E_CSS_PSEUDOCLASS_SYNTAX\", token);\n          this.actions = actionsError;\n          continue;\n        case Action.SELECTOR_PSEUDOELEM_1:\n          if (token.precededBySpace) {\n            handler.descendantSelector();\n          }\n\n        // fall through\n        case Action.SELECTOR_PSEUDOELEM:\n          tokenizer.consume();\n          token = tokenizer.token();\n          switch (token.type) {\n            case TokenType.IDENT:\n              handler.pseudoelementSelector(token.text, null);\n              if (parsingFunctionParam) {\n                this.actions = actionsSelectorInFunc;\n              } else {\n                this.actions = actionsSelector;\n              }\n              tokenizer.consume();\n              continue;\n            case TokenType.FUNC:\n              text = token.text;\n              tokenizer.consume();\n              if (text == \"nth-fragment\") {\n                params = this.readNthPseudoParams();\n                if (params === null) {\n                  break;\n                }\n              } else {\n                params = this.readPseudoParams();\n              }\n              token = tokenizer.token();\n              if (token.type == TokenType.C_PAR) {\n                handler.pseudoelementSelector(text as string, params);\n                if (parsingFunctionParam) {\n                  this.actions = actionsSelectorInFunc;\n                } else {\n                  this.actions = actionsSelector;\n                }\n                tokenizer.consume();\n                continue;\n              }\n              break;\n          }\n          handler.error(\"E_CSS_PSEUDOELEM_SYNTAX\", token);\n          this.actions = actionsError;\n          continue;\n        case Action.SELECTOR_ATTR_1:\n          if (token.precededBySpace) {\n            handler.descendantSelector();\n          }\n\n        // fall through\n        case Action.SELECTOR_ATTR:\n          tokenizer.consume();\n          token = tokenizer.token();\n          if (token.type == TokenType.IDENT) {\n            text = token.text;\n            tokenizer.consume();\n          } else if (token.type == TokenType.STAR) {\n            text = null;\n            tokenizer.consume();\n          } else if (token.type == TokenType.BAR) {\n            text = \"\";\n          } else {\n            this.actions = actionsErrorSelector;\n            handler.error(\"E_CSS_ATTR\", token);\n            tokenizer.consume();\n            continue;\n          }\n          token = tokenizer.token();\n          if (token.type == TokenType.BAR) {\n            ns = text && this.namespacePrefixToURI[text];\n            // if ns === null, it's wildcard namespace\n            if (ns === undefined) {\n              this.actions = actionsErrorSelector;\n              handler.error(\"E_CSS_UNDECLARED_PREFIX\", token);\n              tokenizer.consume();\n              continue;\n            }\n            tokenizer.consume();\n            token = tokenizer.token();\n            if (token.type != TokenType.IDENT) {\n              this.actions = actionsErrorSelector;\n              handler.error(\"E_CSS_ATTR_NAME_EXPECTED\", token);\n              continue;\n            }\n            text = token.text;\n            tokenizer.consume();\n            token = tokenizer.token();\n          } else {\n            ns = \"\";\n          }\n          switch (token.type) {\n            case TokenType.EQ:\n            case TokenType.TILDE_EQ:\n            case TokenType.BAR_EQ:\n            case TokenType.HAT_EQ:\n            case TokenType.DOLLAR_EQ:\n            case TokenType.STAR_EQ:\n            case TokenType.COL_COL:\n              num = token.type;\n              tokenizer.consume();\n              token = tokenizer.token();\n              break;\n            case TokenType.C_BRK:\n              handler.attributeSelector(\n                ns as string,\n                text as string,\n                TokenType.EOF,\n                null,\n              );\n              if (parsingFunctionParam) {\n                this.actions = actionsSelectorInFunc;\n              } else {\n                this.actions = actionsSelector;\n              }\n              tokenizer.consume();\n              continue;\n            default:\n              this.actions = actionsErrorSelector;\n              handler.error(\"E_CSS_ATTR_OP_EXPECTED\", token);\n              continue;\n          }\n          switch (token.type) {\n            case TokenType.IDENT:\n            case TokenType.STR:\n              handler.attributeSelector(\n                ns as string,\n                text as string,\n                num,\n                token.text,\n              );\n              tokenizer.consume();\n              token = tokenizer.token();\n              break;\n            default:\n              this.actions = actionsErrorSelector;\n              handler.error(\"E_CSS_ATTR_VAL_EXPECTED\", token);\n              continue;\n          }\n          if (token.type != TokenType.C_BRK) {\n            this.actions = actionsErrorSelector;\n            handler.error(\"E_CSS_ATTR\", token);\n            continue;\n          }\n          if (parsingFunctionParam) {\n            this.actions = actionsSelectorInFunc;\n          } else {\n            this.actions = actionsSelector;\n          }\n          tokenizer.consume();\n          continue;\n        case Action.SELECTOR_CHILD:\n          handler.childSelector();\n          this.actions = actionsSelectorCont;\n          tokenizer.consume();\n          continue;\n        case Action.SELECTOR_SIBLING:\n          handler.adjacentSiblingSelector();\n          this.actions = actionsSelectorCont;\n          tokenizer.consume();\n          continue;\n        case Action.SELECTOR_FOLLOWING_SIBLING:\n          handler.followingSiblingSelector();\n          this.actions = actionsSelectorCont;\n          tokenizer.consume();\n          continue;\n        case Action.SELECTOR_BODY:\n          if (this.regionRule) {\n            this.ruleStack.push(\"-epubx-region\");\n            this.regionRule = false;\n          } else if (this.pageRule) {\n            this.ruleStack.push(\"page\");\n            this.pageRule = false;\n            this.inStyleDeclaration = true;\n          } else {\n            this.ruleStack.push(\"[selector]\");\n            this.inStyleDeclaration = true;\n          }\n          handler.startRuleBody();\n          this.actions = actionsBase;\n          tokenizer.consume();\n          continue;\n        case Action.SELECTOR_NEXT:\n          handler.nextSelector();\n          this.actions = actionsSelectorStart;\n          tokenizer.consume();\n          continue;\n        case Action.VAL_IDENT:\n          valStack.push(Css.getName(token.text));\n          tokenizer.consume();\n          continue;\n        case Action.VAL_HASH:\n          num = parseInt(token.text, 16);\n          valStack.push(new Css.HexColor(token.text));\n          tokenizer.consume();\n          continue;\n        case Action.VAL_NUM:\n          valStack.push(new Css.Num(token.num));\n          tokenizer.consume();\n          continue;\n        case Action.VAL_INT:\n          valStack.push(new Css.Int(token.num));\n          tokenizer.consume();\n          continue;\n        case Action.VAL_NUMERIC:\n          valStack.push(new Css.Numeric(token.num, token.text));\n          tokenizer.consume();\n          continue;\n        case Action.VAL_STR:\n          valStack.push(new Css.Str(token.text));\n          tokenizer.consume();\n          continue;\n        case Action.VAL_URL:\n          valStack.push(new Css.URL(Base.resolveURL(token.text, this.baseURL)));\n          tokenizer.consume();\n          continue;\n        case Action.VAL_URANGE:\n          valStack.push(new Css.URange(token.text));\n          tokenizer.consume();\n          continue;\n        case Action.VAL_COMMA:\n          this.valStackReduce(\",\", token);\n          valStack.push(\",\");\n          tokenizer.consume();\n          continue;\n        case Action.VAL_SLASH:\n          valStack.push(Css.slash);\n          tokenizer.consume();\n          continue;\n        case Action.VAL_FUNC:\n          text = token.text.toLowerCase();\n          if (text == \"-epubx-expr\" || text == \"env\") {\n            // special case\n            this.actions = actionsExprVal;\n            this.exprContext = ExprContext.PROP;\n            valStack.push(\"{\");\n          } else {\n            valStack.push(text);\n            valStack.push(\"(\");\n            if (this.errorBrackets.length > 0) {\n              // For nested func in parens (Issue #1014)\n              this.errorBrackets.push(TokenType.C_PAR);\n            }\n          }\n          tokenizer.consume();\n          continue;\n        case Action.VAL_C_PAR:\n          this.valStackReduce(\")\", token);\n          tokenizer.consume();\n          continue;\n        case Action.VAL_BANG:\n          tokenizer.consume();\n          token = tokenizer.token();\n          token1 = tokenizer.nthToken(1);\n          if (\n            token.type == TokenType.IDENT &&\n            token.text.toLowerCase() == \"important\" &&\n            (token1.type == TokenType.SEMICOL ||\n              token1.type == TokenType.EOF ||\n              token1.type == TokenType.C_BRC)\n          ) {\n            tokenizer.consume();\n            this.propImportant = true;\n            continue;\n          }\n          this.exprError(\"E_CSS_SYNTAX\", token);\n          continue;\n        case Action.VAL_PLUS:\n          token1 = tokenizer.nthToken(1);\n          switch (token1.type) {\n            case TokenType.NUM:\n            case TokenType.NUMERIC:\n            case TokenType.INT:\n              if (!token1.precededBySpace) {\n                // Plus before number, ignore\n                tokenizer.consume();\n                continue;\n              }\n          }\n          // this.exprError(\"E_CSS_UNEXPECTED_PLUS\", token);\n          valStack.push(new Css.AnyToken(\"+\"));\n          tokenizer.consume();\n          continue;\n        case Action.VAL_END:\n          tokenizer.consume();\n\n        // fall through\n        case Action.VAL_BRC:\n          val = this.valStackReduce(\";\", token);\n          if (val && this.propName) {\n            handler.property(this.propName as string, val, this.propImportant);\n          }\n          this.actions = parsingStyleAttr ? actionsStyleAttribute : actionsBase;\n          continue;\n        case Action.VAL_FINISH:\n          tokenizer.consume();\n\n          // for implicit closing parens, e.g. style=\"color: var(--a, var(--b\"\n          while (valStack.length > 0) {\n            const len = valStack.length;\n            val = this.valStackReduce(\";\", token);\n            if (!val || valStack.length === len) {\n              break;\n            }\n          }\n          if (parsingValue) {\n            this.result = val;\n            return true;\n          }\n          if (this.propName && val) {\n            handler.property(this.propName as string, val, this.propImportant);\n          }\n          return true;\n        case Action.EXPR_IDENT:\n          token1 = tokenizer.nthToken(1);\n          if (token1.type == TokenType.CLASS) {\n            if (\n              tokenizer.nthToken(2).type == TokenType.O_PAR &&\n              !tokenizer.nthToken(2).precededBySpace\n            ) {\n              valStack.push(token.text, token1.text, \"(\");\n              tokenizer.consume();\n            } else {\n              valStack.push(\n                new Exprs.Named(\n                  handler.getScope(),\n                  Exprs.makeQualifiedName(token.text, token1.text),\n                ),\n              );\n              this.actions = actionsExprOp;\n            }\n            tokenizer.consume();\n          } else {\n            if (\n              this.exprContext == ExprContext.MEDIA ||\n              this.exprContext == ExprContext.IMPORT\n            ) {\n              if (token.text.toLowerCase() == \"not\") {\n                tokenizer.consume();\n                valStack.push(\n                  new Exprs.MediaName(handler.getScope(), true, token1.text),\n                );\n              } else {\n                if (token.text.toLowerCase() == \"only\") {\n                  tokenizer.consume();\n                  token = token1;\n                }\n                valStack.push(\n                  new Exprs.MediaName(handler.getScope(), false, token.text),\n                );\n              }\n            } else if (\n              this.exprContext === ExprContext.SUPPORTS &&\n              token.text.toLowerCase() === \"not\" &&\n              valStack[valStack.length - 1] !== OP_MEDIA_AND &&\n              valStack[valStack.length - 1] !== OP_MEDIA_OR &&\n              (token1.type === TokenType.O_PAR ||\n                token1.type === TokenType.FUNC)\n            ) {\n              // for `@supports not (...)`\n              valStack.push(-OP_MEDIA_NOT);\n              tokenizer.consume();\n              continue;\n            } else {\n              valStack.push(new Exprs.Named(handler.getScope(), token.text));\n            }\n            this.actions = actionsExprOp;\n          }\n          tokenizer.consume();\n          continue;\n        case Action.EXPR_FUNC:\n          if (this.exprContext === ExprContext.SUPPORTS) {\n            // `@supports selector(...)`\n            valStack.push(this.readSupportsTest(token));\n            this.actions = actionsExprOp;\n            continue;\n          }\n          valStack.push(null, token.text, \"(\");\n          tokenizer.consume();\n          continue;\n        case Action.EXPR_NUM:\n          valStack.push(new Exprs.Const(handler.getScope(), token.num));\n          tokenizer.consume();\n          this.actions = actionsExprOp;\n          continue;\n        case Action.EXPR_NUMERIC:\n          text = token.text;\n          if (text == \"%\") {\n            if (this.propName && this.propName.match(/height|^(top|bottom)$/)) {\n              text = \"vh\";\n            } else {\n              text = \"vw\";\n            }\n          }\n          valStack.push(new Exprs.Numeric(handler.getScope(), token.num, text));\n          tokenizer.consume();\n          this.actions = actionsExprOp;\n          continue;\n        case Action.EXPR_STR:\n          valStack.push(new Exprs.Const(handler.getScope(), token.text));\n          tokenizer.consume();\n          this.actions = actionsExprOp;\n          continue;\n        case Action.EXPR_PARAM:\n          tokenizer.consume();\n          token = tokenizer.token();\n          if (token.type != TokenType.INT || token.precededBySpace) {\n            this.exprError(\"E_CSS_SYNTAX\", token);\n          } else {\n            valStack.push(new Exprs.Param(handler.getScope(), token.num));\n            tokenizer.consume();\n            this.actions = actionsExprOp;\n          }\n          continue;\n        case Action.EXPR_PREFIX:\n          valStack.push(-token.type);\n          tokenizer.consume();\n          continue;\n        case Action.EXPR_INFIX:\n          this.actions = actionsExprVal;\n          this.exprStackReduce(token.type, token);\n          valStack.push(token.type);\n          tokenizer.consume();\n          continue;\n        case Action.EXPR_INFIX_NAME:\n          // `and` or `or` operator in `@media` or `@supports`\n          if (\n            token.text.toLowerCase() === \"and\" &&\n            valStack[valStack.length - 2] !== OP_MEDIA_OR &&\n            valStack[valStack.length - 2] !== -OP_MEDIA_NOT\n          ) {\n            this.actions = actionsExprVal;\n            this.exprStackReduce(OP_MEDIA_AND, token);\n            valStack.push(OP_MEDIA_AND);\n            tokenizer.consume();\n          } else if (\n            token.text.toLowerCase() === \"or\" &&\n            valStack[valStack.length - 2] !== OP_MEDIA_AND &&\n            valStack[valStack.length - 2] !== -OP_MEDIA_NOT\n          ) {\n            this.actions = actionsExprVal;\n            this.exprStackReduce(OP_MEDIA_OR, token);\n            valStack.push(OP_MEDIA_OR);\n            tokenizer.consume();\n          } else {\n            this.exprError(\"E_CSS_SYNTAX\", token);\n          }\n          continue;\n        case Action.EXPR_C_PAR:\n          if (this.exprStackReduce(token.type, token)) {\n            this.actions = actionsPropVal;\n          }\n          tokenizer.consume();\n          continue;\n        case Action.EXPR_O_BRC:\n          if (this.exprStackReduce(TokenType.C_PAR, token)) {\n            if (this.propName || this.exprContext == ExprContext.IMPORT) {\n              this.exprError(\"E_CSS_UNEXPECTED_BRC\", token);\n            } else {\n              if (this.exprContext == ExprContext.WHEN) {\n                handler.startWhenRule(valStack.pop() as Css.Expr);\n              } else {\n                handler.startMediaRule(valStack.pop() as Css.Expr);\n              }\n              this.ruleStack.push(\"media\");\n              handler.startRuleBody();\n              this.actions = actionsBase;\n            }\n          }\n          tokenizer.consume();\n          continue;\n        case Action.EXPR_SEMICOL:\n          if (this.exprStackReduce(TokenType.C_PAR, token)) {\n            if (this.propName || this.exprContext != ExprContext.IMPORT) {\n              this.exprError(\"E_CSS_UNEXPECTED_SEMICOL\", token);\n              // `@media ...;` and `@supports ...;` should be ok\n              this.actions = actionsBase;\n              tokenizer.consume();\n              return false;\n            } else {\n              this.importCondition = valStack.pop() as Css.Expr;\n              this.importReady = true;\n              this.actions = actionsBase;\n              tokenizer.consume();\n              return false;\n            }\n          }\n          tokenizer.consume();\n          continue;\n        case Action.EXPR_O_PAR:\n          if (this.exprContext === ExprContext.SUPPORTS) {\n            // `@supports (...)`\n            const supportsTest = this.readSupportsTest(token);\n            if (supportsTest) {\n              valStack.push(supportsTest);\n              this.actions = actionsExprOp;\n              continue;\n            }\n          }\n          valStack.push(token.type);\n          tokenizer.consume();\n          continue;\n        case Action.RULE_END:\n          this.actions = actionsBase;\n          tokenizer.consume();\n          handler.endRule();\n          this.inStyleDeclaration = false;\n          if (this.ruleStack.length) {\n            this.ruleStack.pop();\n            switch (this.ruleStack[this.ruleStack.length - 1]) {\n              case \"page\":\n              case \"-epubx-page-master\":\n              case \"-epubx-partition-group\":\n                this.inStyleDeclaration = true;\n            }\n          }\n          continue;\n        case Action.AT:\n          text = token.text.toLowerCase();\n          switch (text) {\n            case \"import\":\n              tokenizer.consume();\n              token = tokenizer.token();\n              if (token.type == TokenType.STR || token.type == TokenType.URL) {\n                this.importURL = token.text;\n                tokenizer.consume();\n                token = tokenizer.token();\n                if (\n                  token.type == TokenType.SEMICOL ||\n                  token.type == TokenType.EOF\n                ) {\n                  this.importReady = true;\n                  tokenizer.consume();\n                  return false;\n                } else {\n                  this.propName = null; // signals @ rule\n                  this.exprContext = ExprContext.IMPORT;\n                  this.actions = actionsExprVal;\n                  valStack.push(\"{\");\n                  continue;\n                }\n              }\n              handler.error(\"E_CSS_IMPORT_SYNTAX\", token);\n              this.actions = actionsError;\n              continue;\n            case \"namespace\":\n              tokenizer.consume();\n              token = tokenizer.token();\n              switch (token.type) {\n                case TokenType.IDENT:\n                  text = token.text; // Prefix\n                  tokenizer.consume();\n                  token = tokenizer.token();\n                  if (\n                    (token.type == TokenType.STR ||\n                      token.type == TokenType.URL) &&\n                    tokenizer.nthToken(1).type == TokenType.SEMICOL\n                  ) {\n                    this.namespacePrefixToURI[text] = token.text;\n                    tokenizer.consume();\n                    tokenizer.consume();\n                    continue;\n                  }\n                  break;\n                case TokenType.STR:\n                case TokenType.URL:\n                  if (tokenizer.nthToken(1).type == TokenType.SEMICOL) {\n                    this.defaultNamespaceURI = token.text;\n                    tokenizer.consume();\n                    tokenizer.consume();\n                    continue;\n                  }\n                  break;\n              }\n              handler.error(\"E_CSS_NAMESPACE_SYNTAX\", token);\n              this.actions = actionsError;\n              continue;\n            case \"charset\":\n              // Useless in EPUB (only UTF-8 or UTF-16 is allowed anyway and\n              // we are at the mercy of the browser charset handling anyway).\n              tokenizer.consume();\n              token = tokenizer.token();\n              if (\n                token.type == TokenType.STR &&\n                tokenizer.nthToken(1).type == TokenType.SEMICOL\n              ) {\n                text = token.text.toLowerCase();\n                if (text != \"utf-8\" && text != \"utf-16\") {\n                  handler.error(`E_CSS_UNEXPECTED_CHARSET ${text}`, token);\n                }\n                tokenizer.consume();\n                tokenizer.consume();\n                continue;\n              }\n              handler.error(\"E_CSS_CHARSET_SYNTAX\", token);\n              this.actions = actionsError;\n              continue;\n            case \"font-face\":\n            case \"-epubx-page-template\":\n            case \"-epubx-define\":\n            case \"-epubx-viewport\":\n              if (tokenizer.nthToken(1).type == TokenType.O_BRC) {\n                tokenizer.consume();\n                tokenizer.consume();\n                switch (text) {\n                  case \"font-face\":\n                    handler.startFontFaceRule();\n                    this.inStyleDeclaration = true;\n                    break;\n                  case \"-epubx-page-template\":\n                    handler.startPageTemplateRule();\n                    break;\n                  case \"-epubx-define\":\n                    handler.startDefineRule();\n                    this.inStyleDeclaration = true;\n                    break;\n                  case \"-epubx-viewport\":\n                    handler.startViewportRule();\n                    this.inStyleDeclaration = true;\n                    break;\n                }\n                this.ruleStack.push(text);\n                handler.startRuleBody();\n                continue;\n              }\n              break;\n            case \"-adapt-footnote-area\":\n              tokenizer.consume();\n              token = tokenizer.token();\n              switch (token.type) {\n                case TokenType.O_BRC:\n                  tokenizer.consume();\n                  handler.startFootnoteRule(null);\n                  this.ruleStack.push(text);\n                  handler.startRuleBody();\n                  this.inStyleDeclaration = true;\n                  continue;\n                case TokenType.COL_COL:\n                  tokenizer.consume();\n                  token = tokenizer.token();\n                  if (\n                    token.type == TokenType.IDENT &&\n                    tokenizer.nthToken(1).type == TokenType.O_BRC\n                  ) {\n                    text = token.text;\n                    tokenizer.consume();\n                    tokenizer.consume();\n                    handler.startFootnoteRule(text);\n                    this.ruleStack.push(\"-adapt-footnote-area\");\n                    handler.startRuleBody();\n                    this.inStyleDeclaration = true;\n                    continue;\n                  }\n                  break;\n              }\n              break;\n            case \"-epubx-region\":\n              tokenizer.consume();\n              handler.startRegionRule();\n              this.regionRule = true;\n              this.actions = actionsSelectorStart;\n              continue;\n            case \"page\":\n              tokenizer.consume();\n              handler.startPageRule();\n              this.pageRule = true;\n              this.actions = actionsSelectorCont;\n              continue;\n            case \"top-left-corner\":\n            case \"top-left\":\n            case \"top-center\":\n            case \"top-right\":\n            case \"top-right-corner\":\n            case \"right-top\":\n            case \"right-middle\":\n            case \"right-bottom\":\n            case \"bottom-right-corner\":\n            case \"bottom-right\":\n            case \"bottom-center\":\n            case \"bottom-left\":\n            case \"bottom-left-corner\":\n            case \"left-bottom\":\n            case \"left-middle\":\n            case \"left-top\":\n              tokenizer.consume();\n              token = tokenizer.token();\n              if (token.type == TokenType.O_BRC) {\n                tokenizer.consume();\n                handler.startPageMarginBoxRule(text);\n                this.ruleStack.push(text);\n                handler.startRuleBody();\n                this.inStyleDeclaration = true;\n                continue;\n              }\n              break;\n            case \"-epubx-when\":\n              tokenizer.consume();\n              this.propName = null; // signals @ rule\n              this.exprContext = ExprContext.WHEN;\n              this.actions = actionsExprVal;\n              valStack.push(\"{\");\n              continue;\n            case \"media\":\n              tokenizer.consume();\n              this.propName = null; // signals @ rule\n              this.exprContext = ExprContext.MEDIA;\n              this.actions = actionsExprVal;\n              valStack.push(\"{\");\n              continue;\n            case \"supports\":\n              tokenizer.consume();\n              this.propName = null; // signals @ rule\n              this.exprContext = ExprContext.SUPPORTS;\n              this.actions = actionsExprVal;\n              valStack.push(\"{\");\n              continue;\n            case \"-epubx-flow\":\n              if (\n                tokenizer.nthToken(1).type == TokenType.IDENT &&\n                tokenizer.nthToken(2).type == TokenType.O_BRC\n              ) {\n                handler.startFlowRule(tokenizer.nthToken(1).text);\n                tokenizer.consume();\n                tokenizer.consume();\n                tokenizer.consume();\n                this.ruleStack.push(text);\n                handler.startRuleBody();\n                this.inStyleDeclaration = true;\n                continue;\n              }\n              break;\n            case \"counter-style\":\n              if (\n                tokenizer.nthToken(1).type == TokenType.IDENT &&\n                tokenizer.nthToken(2).type == TokenType.O_BRC\n              ) {\n                handler.startCounterStyleRule(tokenizer.nthToken(1).text);\n                tokenizer.consume();\n                tokenizer.consume();\n                tokenizer.consume();\n                this.ruleStack.push(text);\n                handler.startRuleBody();\n                this.inStyleDeclaration = true;\n                continue;\n              }\n              break;\n            case \"-epubx-page-master\":\n            case \"-epubx-partition\":\n            case \"-epubx-partition-group\": {\n              tokenizer.consume();\n              token = tokenizer.token();\n              let ruleName: string | null = null;\n              let rulePseudoName: string | null = null;\n              const classes: string[] = [];\n              if (token.type == TokenType.IDENT) {\n                ruleName = token.text;\n                tokenizer.consume();\n                token = tokenizer.token();\n              }\n              if (\n                token.type == TokenType.COLON &&\n                tokenizer.nthToken(1).type == TokenType.IDENT\n              ) {\n                rulePseudoName = tokenizer.nthToken(1).text;\n                tokenizer.consume();\n                tokenizer.consume();\n                token = tokenizer.token();\n              }\n              while (\n                token.type == TokenType.FUNC &&\n                token.text.toLowerCase() == \"class\" &&\n                tokenizer.nthToken(1).type == TokenType.IDENT &&\n                tokenizer.nthToken(2).type == TokenType.C_PAR\n              ) {\n                classes.push(tokenizer.nthToken(1).text);\n                tokenizer.consume();\n                tokenizer.consume();\n                tokenizer.consume();\n                token = tokenizer.token();\n              }\n              if (token.type == TokenType.O_BRC) {\n                tokenizer.consume();\n                switch (text) {\n                  case \"-epubx-page-master\":\n                    handler.startPageMasterRule(\n                      ruleName,\n                      rulePseudoName,\n                      classes,\n                    );\n                    break;\n                  case \"-epubx-partition\":\n                    handler.startPartitionRule(\n                      ruleName,\n                      rulePseudoName,\n                      classes,\n                    );\n                    break;\n                  case \"-epubx-partition-group\":\n                    handler.startPartitionGroupRule(\n                      ruleName,\n                      rulePseudoName,\n                      classes,\n                    );\n                    break;\n                }\n                this.ruleStack.push(text);\n                handler.startRuleBody();\n                this.inStyleDeclaration = true;\n                continue;\n              }\n              break;\n            }\n            case \"\":\n              // No text after @\n              handler.error(`E_CSS_UNEXPECTED_AT${text}`, token);\n\n              // Error recovery using selector rules.\n              this.actions = actionsErrorSelector;\n              continue;\n            default:\n              handler.error(`E_CSS_AT_UNKNOWN ${text}`, token);\n              this.actions = actionsError;\n              continue;\n          }\n          handler.error(`E_CSS_AT_SYNTAX ${text}`, token);\n          this.actions = actionsError;\n          continue;\n        case Action.ERROR_PUSH:\n          // Open bracket while skipping error syntax\n          this.errorBrackets.push(token.type + 1);\n\n          // Expected closing bracket\n          tokenizer.consume();\n          continue;\n        case Action.ERROR_POP_DECL:\n          // Close bracket while skipping error syntax in declaration\n          if (this.errorBrackets.length == 0) {\n            this.actions = actionsBase;\n\n            // Don't consume closing brace\n            continue;\n          }\n\n        // fall through\n        case Action.ERROR_POP:\n          if (\n            parsingFunctionParam &&\n            this.errorBrackets.length == 0 &&\n            token.type == TokenType.C_PAR\n          ) {\n            tokenizer.consume();\n            handler.endFuncWithSelector();\n            return true;\n          }\n          // Close bracket while skipping error syntax\n          if (\n            this.errorBrackets.length > 0 &&\n            this.errorBrackets[this.errorBrackets.length - 1] == token.type\n          ) {\n            this.errorBrackets.pop();\n          }\n          if (this.errorBrackets.length == 0 && token.type == TokenType.C_BRC) {\n            this.actions = actionsBase;\n          }\n          tokenizer.consume();\n          continue;\n        case Action.ERROR_SEMICOL:\n          if (this.errorBrackets.length == 0) {\n            this.actions = actionsBase;\n          }\n          tokenizer.consume();\n          continue;\n        case Action.DONE:\n          return true;\n        default:\n          if (parsingMediaQuery) {\n            if (this.exprStackReduce(TokenType.C_PAR, token)) {\n              this.result = valStack.pop() as Css.Val;\n              return true;\n            }\n            return false;\n          }\n          if (parsingFunctionParam) {\n            switch (token.type) {\n              case TokenType.COMMA:\n              case TokenType.C_PAR:\n                if (this.actions === actionsSelectorStart) {\n                  handler.error(\"E_CSS_SYNTAX\", token);\n                } else {\n                  const selectorText = tokenizer.input.substring(\n                    selectorStartPosition,\n                    token.position,\n                  );\n                  handler.pushSelectorText(selectorText);\n                  selectorStartPosition = token.position + 1;\n                }\n                if (token.type === TokenType.COMMA) {\n                  handler.nextSelector();\n                  this.actions = actionsSelectorStart;\n                  tokenizer.consume();\n                  continue;\n                } else {\n                  handler.endFuncWithSelector();\n                  tokenizer.consume();\n                  return true;\n                }\n              case TokenType.GT:\n              case TokenType.PLUS:\n              case TokenType.TILDE:\n                if (parsingRelationalSelector) {\n                  // :has() takes relational selectors e.g. `:has(> F)`\n                  this.actions = actionsSelector;\n                  continue;\n                }\n                break;\n              case TokenType.O_BRC:\n              case TokenType.O_BRK:\n              case TokenType.O_PAR:\n                this.errorBrackets.push(token.type + 1);\n                break;\n            }\n            handler.error(\"E_CSS_SYNTAX\", token);\n            tokenizer.consume();\n            this.actions = actionsErrorSelector;\n            continue;\n          }\n          if (\n            this.actions !== actionsError &&\n            this.actions !== actionsErrorSelector &&\n            this.actions !== actionsErrorDecl\n          ) {\n            if (token.type == TokenType.INVALID) {\n              handler.error(\"E_CSS_SYNTAX\", token);\n            } else if (this.actions === actionsPropVal) {\n              // Do not stop parsing on invalid property syntax as long as brackets are balanced.\n              switch (token.type) {\n                case TokenType.O_PAR:\n                case TokenType.O_BRC:\n                case TokenType.O_BRK:\n                  this.errorBrackets.push(token.type + 1);\n                  break;\n              }\n              valStack.push(new Css.AnyToken(token.toString()));\n              tokenizer.consume();\n              continue;\n            } else if (\n              token.type === TokenType.O_BRC &&\n              this.actions == actionsExprVal &&\n              valStack.length > 0\n            ) {\n              // `@media {...}` and `@supports {...}` should be ok\n              handler.startMediaRule(valStack.pop() as Css.Expr);\n              this.ruleStack.push(\"media\");\n              handler.startRuleBody();\n              this.actions = actionsBase;\n              tokenizer.consume();\n              continue;\n            } else if (\n              token.type === TokenType.SEMICOL &&\n              this.actions == actionsExprVal\n            ) {\n              // `@media;` and `@supports;` should be ok\n              this.actions = actionsBase;\n              tokenizer.consume();\n              return false;\n            } else {\n              handler.error(\"E_CSS_SYNTAX\", token);\n            }\n            if (this.isInsidePropertyOnlyRule()) {\n              this.actions = actionsErrorDecl;\n            } else {\n              this.actions = actionsErrorSelector;\n            }\n            continue; // Let error-recovery to re-process the offending token\n          }\n          tokenizer.consume();\n          continue;\n      }\n    }\n    return false; // Not done yet.\n  }\n}\n\nexport class ErrorHandler extends ParserHandler {\n  constructor(public readonly scope: Exprs.LexicalScope) {\n    super(null);\n  }\n\n  override error(mnemonics: string, token: CssTokenizer.Token): void {\n    // throw new Error(mnemonics + \" \" + token);\n    Logging.logger.warn(mnemonics, token.toString());\n  }\n\n  override getScope(): Exprs.LexicalScope {\n    return this.scope;\n  }\n}\n\nexport function parseStylesheet(\n  tokenizer: CssTokenizer.Tokenizer,\n  handler: ParserHandler,\n  baseURL: string,\n  classes: string | null,\n  media: string | null,\n): Task.Result<boolean> {\n  const frame: Task.Frame<boolean> = Task.newFrame(\"parseStylesheet\");\n  const parser = new Parser(actionsBase, tokenizer, handler, baseURL);\n  let condition: Css.Expr = null;\n  if (media) {\n    condition = parseMediaQuery(\n      new CssTokenizer.Tokenizer(media, handler),\n      handler,\n      baseURL,\n    );\n  }\n  condition = parser.makeCondition(classes, condition && condition.toExpr());\n  if (condition) {\n    handler.startMediaRule(condition);\n    handler.startRuleBody();\n  }\n  frame\n    .loop(() => {\n      while (!parser.runParser(100, false, false, false, false)) {\n        if (parser.importReady) {\n          const resolvedURL = Base.resolveURL(\n            parser.importURL as string,\n            baseURL,\n          );\n          if (parser.importCondition) {\n            handler.startMediaRule(parser.importCondition);\n            handler.startRuleBody();\n          }\n          const innerFrame: Task.Frame<boolean> = Task.newFrame(\n            \"parseStylesheet.import\",\n          );\n          parseStylesheetFromURL(resolvedURL, handler, null, null).then(() => {\n            if (parser.importCondition) {\n              handler.endRule();\n            }\n            parser.importReady = false;\n            parser.importURL = null;\n            parser.importCondition = null;\n            innerFrame.finish(true);\n          });\n          return innerFrame.result();\n        }\n        const r = frame.timeSlice();\n        if (r.isPending) {\n          return r;\n        }\n      }\n      return Task.newResult(false);\n    })\n    .then(() => {\n      if (condition) {\n        handler.endRule();\n      }\n      frame.finish(true);\n    });\n  return frame.result();\n}\n\nexport function parseStylesheetFromText(\n  text: string,\n  handler: ParserHandler,\n  baseURL: string,\n  classes: string | null,\n  media: string | null,\n): Task.Result<boolean> {\n  return Task.handle(\n    \"parseStylesheetFromText\",\n    (frame) => {\n      const tok = new CssTokenizer.Tokenizer(text, handler);\n      parseStylesheet(tok, handler, baseURL, classes, media).thenFinish(frame);\n    },\n    (frame, err) => {\n      Logging.logger.warn(err, `Failed to parse stylesheet text: ${text}`);\n      frame.finish(false);\n    },\n  );\n}\n\nexport function parseStylesheetFromURL(\n  url: string,\n  handler: ParserHandler,\n  classes: string | null,\n  media: string | null,\n): Task.Result<boolean> {\n  return Task.handle(\n    \"parseStylesheetFromURL\",\n    (frame) => {\n      Net.fetchFromURL(url).then((response) => {\n        if (!response.responseText) {\n          frame.finish(true);\n        } else {\n          parseStylesheetFromText(\n            response.responseText,\n            handler,\n            url,\n            classes,\n            media,\n          ).then((result) => {\n            if (!result) {\n              Logging.logger.warn(`Failed to parse stylesheet from ${url}`);\n            }\n            frame.finish(true);\n          });\n        }\n      });\n    },\n    (frame, err) => {\n      Logging.logger.warn(err, \"Exception while fetching and parsing:\", url);\n      frame.finish(true);\n    },\n  );\n}\n\nexport function parseValue(\n  scope: Exprs.LexicalScope,\n  tokenizer: CssTokenizer.Tokenizer,\n  baseURL: string,\n): Css.Val {\n  const parser = new Parser(\n    actionsPropVal,\n    tokenizer,\n    new ErrorHandler(scope),\n    baseURL,\n  );\n  parser.runParser(Number.POSITIVE_INFINITY, true, false, false, false);\n  return parser.result;\n}\n\nexport function parseStyleAttribute(\n  tokenizer: CssTokenizer.Tokenizer,\n  handler: ParserHandler,\n  baseURL: string,\n): void {\n  const parser = new Parser(actionsStyleAttribute, tokenizer, handler, baseURL);\n  parser.runParser(Number.POSITIVE_INFINITY, false, true, false, false);\n}\n\nexport function parseMediaQuery(\n  tokenizer: CssTokenizer.Tokenizer,\n  handler: ParserHandler,\n  baseURL: string,\n): Css.Expr {\n  const parser = new Parser(actionsExprVal, tokenizer, handler, baseURL);\n  parser.runParser(Number.POSITIVE_INFINITY, false, false, true, false);\n  return parser.result as Css.Expr;\n}\n\nexport const numProp: { [key: string]: boolean } = {\n  \"z-index\": true,\n  \"column-count\": true,\n  \"flow-linger\": true,\n  opacity: true,\n  page: true,\n  \"flow-priority\": true,\n  utilization: true,\n};\n\nexport function takesOnlyNum(propName: string): boolean {\n  return !!numProp[propName];\n}\n\n/**\n * @return val\n */\nexport function evaluateExprToCSS(\n  context: Exprs.Context,\n  val: Exprs.Val,\n  propName: string,\n): Css.Val {\n  // Preserve viv-leader expressions as Css.Expr (Issue #1563)\n  // leader() must be processed by ContentPropertyHandler, not evaluated here\n  if (val instanceof Exprs.Native && val.str === \"viv-leader\") {\n    return new Css.Expr(val);\n  }\n  const result = val.evaluate(context);\n  switch (typeof result) {\n    case \"number\":\n      if (!takesOnlyNum(propName)) {\n        return new Css.Numeric(result as number, \"px\");\n      } else if (result == Math.round(result as number)) {\n        return new Css.Int(result as number);\n      } else {\n        return new Css.Num(result as number);\n      }\n    case \"string\":\n      if (!result) {\n        return Css.empty;\n      }\n\n      // TODO: where baseURL should come from???\n      return parseValue(\n        val.scope,\n        new CssTokenizer.Tokenizer(result as string, null),\n        \"\",\n      );\n    case \"boolean\":\n      return result ? Css.ident._true : Css.ident._false;\n    case \"undefined\":\n      return Css.empty;\n  }\n  throw new Error(\"E_UNEXPECTED\");\n}\n", "/**\n * Copyright 2015 Daishinsha Inc.\n * Copyright 2019 Vivliostyle Foundation\n *\n * Vivliostyle.js is free software: you can redistribute it and/or modify\n * it under the terms of the GNU Affero General Public License as published by\n * the Free Software Foundation, either version 3 of the License, or\n * (at your option) any later version.\n *\n * Vivliostyle.js is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n * GNU Affero General Public License for more details.\n *\n * You should have received a copy of the GNU Affero General Public License\n * along with Vivliostyle.js.  If not, see <http://www.gnu.org/licenses/>.\n *\n * @fileoverview CssLogicalUtil - Utilities related to CSS Logical Properties and Values https://drafts.csswg.org/css-logical/\n */\ntype ConversionMap = {\n  regexp: RegExp;\n  to: string;\n};\n\nfunction createRegExpMap(\n  valueMaps: {\n    [key: string]: { [key: string]: { logical: string; physical: string }[] };\n  },\n  toPhysical: boolean,\n): { [key: string]: { [key: string]: ConversionMap[] } } {\n  const map = {};\n  Object.keys(valueMaps as object).forEach((writingMode) => {\n    const dest = (map[writingMode] = {});\n    const src = valueMaps[writingMode];\n    Object.keys(src as object).forEach((direction) => {\n      dest[direction] = src[direction].map((p) => {\n        const from = toPhysical ? p.logical : p.physical;\n        const to = toPhysical ? p.physical : p.logical;\n        return { regexp: new RegExp(`(-?)${from}(-?)`), to: `\\$1${to}\\$2` };\n      });\n    });\n  });\n  return map;\n}\n\nfunction convert(\n  value: string,\n  writingMode: string,\n  direction: string | null,\n  maps: { [key: string]: { [key: string]: ConversionMap[] } },\n): string {\n  const maps2 = maps[writingMode];\n  if (!maps2) {\n    throw new Error(`unknown writing-mode: ${writingMode}`);\n  }\n  const map = maps2[direction || \"ltr\"];\n  if (!map) {\n    throw new Error(`unknown direction: ${direction}`);\n  }\n  for (const p of map) {\n    const replaced = value.replace(p.regexp, p.to);\n    if (replaced !== value) {\n      return replaced;\n    }\n  }\n  return value;\n}\nconst values: {\n  [key: string]: { [key: string]: { logical: string; physical: string }[] };\n} = {\n  \"horizontal-tb\": {\n    ltr: [\n      { logical: \"inline-start\", physical: \"left\" },\n      { logical: \"inline-end\", physical: \"right\" },\n      { logical: \"block-start\", physical: \"top\" },\n      { logical: \"block-end\", physical: \"bottom\" },\n      { logical: \"inline-size\", physical: \"width\" },\n      { logical: \"block-size\", physical: \"height\" },\n    ],\n    rtl: [\n      { logical: \"inline-start\", physical: \"right\" },\n      { logical: \"inline-end\", physical: \"left\" },\n      { logical: \"block-start\", physical: \"top\" },\n      { logical: \"block-end\", physical: \"bottom\" },\n      { logical: \"inline-size\", physical: \"width\" },\n      { logical: \"block-size\", physical: \"height\" },\n    ],\n  },\n  \"vertical-rl\": {\n    ltr: [\n      { logical: \"inline-start\", physical: \"top\" },\n      { logical: \"inline-end\", physical: \"bottom\" },\n      { logical: \"block-start\", physical: \"right\" },\n      { logical: \"block-end\", physical: \"left\" },\n      { logical: \"inline-size\", physical: \"height\" },\n      { logical: \"block-size\", physical: \"width\" },\n    ],\n    rtl: [\n      { logical: \"inline-start\", physical: \"bottom\" },\n      { logical: \"inline-end\", physical: \"top\" },\n      { logical: \"block-start\", physical: \"right\" },\n      { logical: \"block-end\", physical: \"left\" },\n      { logical: \"inline-size\", physical: \"height\" },\n      { logical: \"block-size\", physical: \"width\" },\n    ],\n  },\n  \"vertical-lr\": {\n    ltr: [\n      { logical: \"inline-start\", physical: \"top\" },\n      { logical: \"inline-end\", physical: \"bottom\" },\n      { logical: \"block-start\", physical: \"left\" },\n      { logical: \"block-end\", physical: \"right\" },\n      { logical: \"inline-size\", physical: \"height\" },\n      { logical: \"block-size\", physical: \"width\" },\n    ],\n    rtl: [\n      { logical: \"inline-start\", physical: \"bottom\" },\n      { logical: \"inline-end\", physical: \"top\" },\n      { logical: \"block-start\", physical: \"left\" },\n      { logical: \"block-end\", physical: \"right\" },\n      { logical: \"inline-size\", physical: \"height\" },\n      { logical: \"block-size\", physical: \"width\" },\n    ],\n  },\n};\nconst toPhysicalMaps = createRegExpMap(values, true);\n\nexport function toPhysical(\n  value: string,\n  writingMode: string,\n  direction?: string | null,\n): string {\n  return convert(value, writingMode, direction || null, toPhysicalMaps);\n}\nconst toLogicalMaps = createRegExpMap(values, false);\n\nexport function toLogical(\n  value: string,\n  writingMode: string,\n  direction?: string | null,\n): string {\n  return convert(value, writingMode, direction || null, toLogicalMaps);\n}\nconst lineRelativeValues: {\n  [key: string]: { logical: string; physical: string }[];\n} = {\n  \"horizontal-tb\": [\n    { logical: \"line-left\", physical: \"left\" },\n    { logical: \"line-right\", physical: \"right\" },\n    { logical: \"over\", physical: \"top\" },\n    { logical: \"under\", physical: \"bottom\" },\n  ],\n  \"vertical-rl\": [\n    { logical: \"line-left\", physical: \"top\" },\n    { logical: \"line-right\", physical: \"bottom\" },\n    { logical: \"over\", physical: \"right\" },\n    { logical: \"under\", physical: \"left\" },\n  ],\n  \"vertical-lr\": [\n    { logical: \"line-left\", physical: \"top\" },\n    { logical: \"line-right\", physical: \"bottom\" },\n    { logical: \"over\", physical: \"right\" },\n    { logical: \"under\", physical: \"left\" },\n  ],\n};\n\nexport function toLineRelative(value: string, writingMode: string): string {\n  const maps = lineRelativeValues[writingMode];\n  if (!maps) {\n    throw new Error(`unknown writing-mode: ${writingMode}`);\n  }\n  for (let i = 0; i < maps.length; i++) {\n    if (maps[i].physical === value) {\n      return maps[i].logical;\n    }\n  }\n  return value;\n}\n", "/**\n * Copyright 2015 Daishinsha Inc.\n * Copyright 2019 Vivliostyle Foundation\n *\n * Vivliostyle.js is free software: you can redistribute it and/or modify\n * it under the terms of the GNU Affero General Public License as published by\n * the Free Software Foundation, either version 3 of the License, or\n * (at your option) any later version.\n *\n * Vivliostyle.js is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n * GNU Affero General Public License for more details.\n *\n * You should have received a copy of the GNU Affero General Public License\n * along with Vivliostyle.js.  If not, see <http://www.gnu.org/licenses/>.\n *\n * @fileoverview Sizing - CSS Intrinsic & Extrinsic Sizing\n */\nimport * as Base from \"./base\";\nimport * as Vtree from \"./vtree\";\n\n/**\n * Box sizes defined in css-sizing.\n * @enum {string}\n */\nexport enum Size {\n  MAX_CONTENT_INLINE_SIZE = \"max-content inline size\",\n  MAX_CONTENT_BLOCK_SIZE = \"max-content block size\",\n  MAX_CONTENT_WIDTH = \"max-content width\",\n  MAX_CONTENT_HEIGHT = \"max-content height\",\n  MIN_CONTENT_INLINE_SIZE = \"min-content inline size\",\n  MIN_CONTENT_BLOCK_SIZE = \"min-content block size\",\n  MIN_CONTENT_WIDTH = \"min-content width\",\n  MIN_CONTENT_HEIGHT = \"min-content height\",\n  FIT_CONTENT_INLINE_SIZE = \"fit-content inline size\",\n  FIT_CONTENT_BLOCK_SIZE = \"fit-content block size\",\n  FIT_CONTENT_WIDTH = \"fit-content width\",\n  FIT_CONTENT_HEIGHT = \"fit-content height\",\n}\n\n/**\n * Get specified sizes for the element.\n */\nexport function getSize(\n  clientLayout: Vtree.ClientLayout,\n  element: Element,\n  sizes: Size[],\n): { [key in Size]: number } {\n  const element1 = element as HTMLElement;\n  const original = {\n    width: element1.style.width,\n    height: element1.style.height,\n  };\n\n  function getComputedValue(name: string): string {\n    return clientLayout.getElementComputedStyle(element).getPropertyValue(name);\n  }\n\n  const writingModeValue = getComputedValue(\"writing-mode\");\n  const isVertical = writingModeValue !== \"horizontal-tb\";\n  const inlineSizeName = isVertical ? \"height\" : \"width\";\n  const blockSizeName = isVertical ? \"width\" : \"height\";\n\n  function getSizeValue(\n    sizeName: \"width\" | \"height\",\n    minMaxFitContent: \"min-content\" | \"max-content\" | \"fit-content\",\n  ): string {\n    element1.style[sizeName] = minMaxFitContent;\n    const r = getComputedValue(sizeName);\n    element1.style[sizeName] = original[sizeName];\n    return r;\n  }\n\n  const result = {} as { [key in Size]: number };\n  for (const size of sizes) {\n    let r: string;\n    switch (size) {\n      case Size.MAX_CONTENT_INLINE_SIZE:\n        r = getSizeValue(inlineSizeName, \"max-content\");\n        break;\n      case Size.MIN_CONTENT_INLINE_SIZE:\n        r = getSizeValue(inlineSizeName, \"min-content\");\n        break;\n      case Size.FIT_CONTENT_INLINE_SIZE:\n        r = getSizeValue(inlineSizeName, \"fit-content\");\n        break;\n      case Size.MAX_CONTENT_BLOCK_SIZE:\n        r = getSizeValue(blockSizeName, \"max-content\");\n        break;\n      case Size.MIN_CONTENT_BLOCK_SIZE:\n        r = getSizeValue(blockSizeName, \"min-content\");\n        break;\n      case Size.FIT_CONTENT_BLOCK_SIZE:\n        r = getSizeValue(blockSizeName, \"fit-content\");\n        break;\n      case Size.MAX_CONTENT_WIDTH:\n        r = getSizeValue(\"width\", \"max-content\");\n        break;\n      case Size.MAX_CONTENT_HEIGHT:\n        r = getSizeValue(\"height\", \"max-content\");\n        break;\n      case Size.MIN_CONTENT_WIDTH:\n        r = getSizeValue(\"width\", \"min-content\");\n        break;\n      case Size.MIN_CONTENT_HEIGHT:\n        r = getSizeValue(\"height\", \"min-content\");\n        break;\n      case Size.FIT_CONTENT_WIDTH:\n        r = getSizeValue(\"width\", \"fit-content\");\n        break;\n      case Size.FIT_CONTENT_HEIGHT:\n        r = getSizeValue(\"height\", \"fit-content\");\n        break;\n    }\n    // Workaround for the case that the element has an image that is\n    // not loaded yet. Use 1px instead of 0px to avoid wrong layout.\n    if (\n      r === \"0px\" &&\n      element.childNodes.length === 1 &&\n      element.firstElementChild?.localName === \"img\" &&\n      !(element.firstElementChild as HTMLImageElement).complete\n    ) {\n      r = \"1px\";\n    }\n    result[size] = parseFloat(r);\n  }\n\n  return result;\n}\n", "/**\n * Copyright 2016 Daishinsha Inc.\n * Copyright 2019 Vivliostyle Foundation\n *\n * Vivliostyle.js is free software: you can redistribute it and/or modify\n * it under the terms of the GNU Affero General Public License as published by\n * the Free Software Foundation, either version 3 of the License, or\n * (at your option) any later version.\n *\n * Vivliostyle.js is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n * GNU Affero General Public License for more details.\n *\n * You should have received a copy of the GNU Affero General Public License\n * along with Vivliostyle.js.  If not, see <http://www.gnu.org/licenses/>.\n *\n * @fileoverview Break - Control fragmentation.\n */\nimport * as Css from \"./css\";\nimport * as Plugin from \"./plugin\";\n\n/**\n * Check if style=\"box-decoration-break: clone\" is set\n */\nexport function isCloneBoxDecorationBreak(element: Element): boolean {\n  return (\n    (element as HTMLElement)?.style?.[\"box-decoration-break\"] === \"clone\" ||\n    (element as HTMLElement)?.style?.[\"-webkit-box-decoration-break\"] ===\n      \"clone\"\n  );\n}\n\n/**\n * data-viv-box-break attribute\n *\n * Value: [ [inline-start || inline-end] |\n *          [block-start text-start? || block-end text-end?] justify? ]\n *        clone?\n *\n * inline-start, inline-end, block-start, block-end: the side at which a box break occurs\n * text-start: the fragment starts with text or inline box\n * text-end: the fragment ends with text or inline box\n * justify: the computed value of `text-align` property is `justify`\n * clone: the computed value of `box-decoration-break` property is `clone`\n */\ntype BoxBreakFlag =\n  | \"inline-start\"\n  | \"inline-end\"\n  | \"block-start\"\n  | \"block-end\"\n  | \"text-start\"\n  | \"text-end\"\n  | \"justify\"\n  | \"clone\";\n\nexport function getBoxBreakFlags(element: Element): BoxBreakFlag[] {\n  const val = element.getAttribute(\"data-viv-box-break\");\n  return (val ? val.split(\" \") : []) as BoxBreakFlag[];\n}\n\nexport function setBoxBreakFlags(\n  element: Element,\n  boxBreakFlags: BoxBreakFlag[],\n): void {\n  element.setAttribute(\"data-viv-box-break\", boxBreakFlags.join(\" \"));\n}\n\nexport function setBoxBreakFlag(\n  element: Element,\n  boxBreakFlag: BoxBreakFlag,\n): void {\n  const boxBreakFlags = getBoxBreakFlags(element);\n  if (!boxBreakFlags.includes(boxBreakFlag)) {\n    boxBreakFlags.push(boxBreakFlag);\n    setBoxBreakFlags(element, boxBreakFlags);\n  }\n}\n\n/**\n * data-viv-margin-discard attribute\n *\n * Value: block-start || block-end || inline-start || inline-end\n *\n * block-start: the block-start margin is discarded\n * block-end: the block-end margin is discarded\n * inline-start: the inline-start margin is discarded\n * inline-end: the inline-end margin is discarded\n */\ntype MarginDiscardFlag =\n  | \"block-start\"\n  | \"block-end\"\n  | \"inline-start\"\n  | \"inline-end\";\n\nexport function getMarginDiscardFlags(element: Element): MarginDiscardFlag[] {\n  const val = element.getAttribute(\"data-viv-margin-discard\");\n  return (val ? val.split(\" \") : []) as MarginDiscardFlag[];\n}\n\nexport function setMarginDiscardFlags(\n  element: Element,\n  marginDiscardFlags: MarginDiscardFlag[],\n): void {\n  element.setAttribute(\"data-viv-margin-discard\", marginDiscardFlags.join(\" \"));\n}\n\nexport function setMarginDiscardFlag(\n  element: Element,\n  marginDiscardFlag: MarginDiscardFlag,\n): void {\n  const MarginDiscardFlags = getMarginDiscardFlags(element);\n  if (!MarginDiscardFlags.includes(marginDiscardFlag)) {\n    MarginDiscardFlags.push(marginDiscardFlag);\n    setMarginDiscardFlags(element, MarginDiscardFlags);\n  }\n}\n\n/**\n * Convert old page-break-* properties to break-* properties with appropriate\n * values as specified by CSS Fragmentation module:\n * https://drafts.csswg.org/css-break/#page-break-properties\n */\nexport function convertPageBreakAliases(original: {\n  name: string;\n  value: Css.Val;\n  important: boolean;\n}): { name: string; value: Css.Val; important: boolean } {\n  const name = original[\"name\"];\n  const value = original[\"value\"];\n  switch (name) {\n    case \"page-break-before\":\n    case \"page-break-after\":\n    case \"page-break-inside\":\n      return {\n        name: name.replace(/^page-/, \"\"),\n        value: value === Css.ident.always ? Css.ident.page : value,\n        important: original[\"important\"],\n      };\n    default:\n      return original;\n  }\n}\n\nexport const forcedBreakValues: { [key: string]: boolean | null } = {\n  page: true,\n  left: true,\n  right: true,\n  recto: true,\n  verso: true,\n  column: true,\n  region: true,\n};\n\n/**\n * Returns if the value is one of the forced break values.\n * @param value The break value to be judged. Treats null as 'auto'.\n */\nexport function isForcedBreakValue(value: string | null): boolean {\n  return !!forcedBreakValues[value];\n}\n\nexport const spreadBreakValues: { [key: string]: boolean | null } = {\n  left: true,\n  right: true,\n  recto: true,\n  verso: true,\n};\n\n/**\n * Returns if the value is one of left/right/recto/verso values.\n * @param value The break value to be judged. Treats null as 'auto'.\n */\nexport function isSpreadBreakValue(value: string | null): boolean {\n  return !!spreadBreakValues[value];\n}\n\nexport const avoidBreakValues: { [key: string]: boolean | null } = {\n  avoid: true,\n  \"avoid-page\": true,\n  \"avoid-column\": true,\n  \"avoid-region\": true,\n};\n\n/**\n * Returns if the value is one of the avoid break values.\n * @param value The break value to be judged. Treats null as 'auto'.\n */\nexport function isAvoidBreakValue(value: string | null): boolean {\n  return !!avoidBreakValues[value];\n}\n\n/**\n * Resolves the effective break value given two break values at a single break\n * point. The order of the arguments are relevant, since a value specified on\n * the latter element takes precedence over one on the former. A forced break\n * value is chosen if present. Otherwise, an avoid break value is chosen if\n * present. See CSS Fragmentation Module for the rule:\n *  https://drafts.csswg.org/css-break/#forced-breaks\n *  https://drafts.csswg.org/css-break/#unforced-breaks\n * Note that though the spec requires to honor multiple break values at a single\n * break point, the current implementation choose one of them and discard the\n * others.\n * @param first The break value specified on the former element. null means\n *     'auto' (not specified)\n * @param second The break value specified on the latter element. null means\n *     'auto' (not specified)\n */\nexport function resolveEffectiveBreakValue(\n  first: string | null,\n  second: string | null,\n): string | null {\n  if (!first) {\n    return second;\n  } else if (!second) {\n    return first;\n  } else if (isSpreadBreakValue(second)) {\n    return second;\n  } else if (isSpreadBreakValue(first)) {\n    return first;\n  } else {\n    const firstIsForcedBreakValue = isForcedBreakValue(first);\n    const secondIsForcedBreakValue = isForcedBreakValue(second);\n    if (firstIsForcedBreakValue && secondIsForcedBreakValue) {\n      switch (second) {\n        case \"column\":\n          // \"column\" is the weakest value\n          return first;\n        case \"region\":\n          // \"region\" is stronger than \"column\" but weaker than page\n          // values\n          return first === \"column\" ? second : first;\n        default:\n          // page values are strongest\n          return second;\n      }\n    } else if (secondIsForcedBreakValue) {\n      return second;\n    } else if (firstIsForcedBreakValue) {\n      return first;\n    } else if (isAvoidBreakValue(second)) {\n      return second;\n    } else if (isAvoidBreakValue(first)) {\n      return first;\n    } else {\n      return second;\n    }\n  }\n}\n\nexport function breakValueToStartBreakType(breakValue: string | null): string {\n  return isForcedBreakValue(breakValue) ? breakValue : \"auto\";\n}\n\nPlugin.registerHook(\"SIMPLE_PROPERTY\", convertPageBreakAliases);\n", "/**\n * Copyright 2016 Daishinsha Inc.\n * Copyright 2019 Vivliostyle Foundation\n *\n * Vivliostyle.js is free software: you can redistribute it and/or modify\n * it under the terms of the GNU Affero General Public License as published by\n * the Free Software Foundation, either version 3 of the License, or\n * (at your option) any later version.\n *\n * Vivliostyle.js is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n * GNU Affero General Public License for more details.\n *\n * You should have received a copy of the GNU Affero General Public License\n * along with Vivliostyle.js.  If not, see <http://www.gnu.org/licenses/>.\n *\n * @fileoverview Diff utility\n */\n\nimport fastdiff from \"fast-diff\";\n\nexport type Change = (number | string)[];\n\nexport function diffChars(originalText: string, newText: string): Change[] {\n  return fastdiff(originalText, newText, 0);\n}\n\nexport function restoreOriginalText(changes: Change[]): string {\n  return changes.reduce((result, item) => {\n    if (item[0] === fastdiff.INSERT) {\n      return result;\n    }\n    return result + item[1];\n  }, \"\");\n}\n\nexport function restoreNewText(changes: Change[]): string {\n  return changes.reduce((result, item) => {\n    if (item[0] === fastdiff.DELETE) {\n      return result;\n    }\n    return result + item[1];\n  }, \"\");\n}\n\nexport function resolveNewIndex(changes: Change[], oldIndex: number): number {\n  return resolveIndex(changes, oldIndex, 1);\n}\n\nexport function resolveOriginalIndex(\n  changes: Change[],\n  newIndex: number,\n): number {\n  return resolveIndex(changes, newIndex, -1);\n}\n\nexport function resolveIndex(\n  changes: Change[],\n  index: number,\n  coef: number,\n): number {\n  let diff = 0;\n  let current = 0;\n  changes.some((change) => {\n    for (let i = 0; i < (change[1] as string).length; i++) {\n      switch ((change[0] as number) * coef) {\n        case fastdiff.INSERT:\n          diff++;\n          break;\n        case fastdiff.DELETE:\n          diff--;\n          current++;\n          break;\n        case fastdiff.EQUAL:\n          current++;\n          break;\n      }\n      if (current > index) {\n        return true;\n      }\n    }\n    return false;\n  });\n  return Math.max(Math.min(index, current - 1) + diff, 0);\n}\n", "/**\n * Copyright 2019 Vivliostyle Foundation\n *\n * Vivliostyle.js is free software: you can redistribute it and/or modify\n * it under the terms of the GNU Affero General Public License as published by\n * the Free Software Foundation, either version 3 of the License, or\n * (at your option) any later version.\n *\n * Vivliostyle.js is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n * GNU Affero General Public License for more details.\n *\n * You should have received a copy of the GNU Affero General Public License\n * along with Vivliostyle.js.  If not, see <http://www.gnu.org/licenses/>.\n *\n * @fileoverview Types - Type definiions.\n */\nimport * as Base from \"./base\";\nimport * as Css from \"./css\";\nimport * as Diff from \"./diff\";\nimport * as Exprs from \"./exprs\";\nimport * as GeometryUtil from \"./geometry-util\";\nimport * as Task from \"./task\";\nimport * as TaskUtil from \"./task-util\";\n\nexport type FormattingContextType =\n  | \"Block\"\n  | \"RepetitiveElementsOwner\"\n  | \"Table\";\n\nexport type FragmentLayoutConstraintType =\n  | \"AfterIfContinue\"\n  | \"EntireTable\"\n  | \"RepetitiveElementsOwner\"\n  | \"TableRow\";\n\nexport namespace CssCascade {\n  export type ElementStyle = { [key: string]: any };\n}\n\nexport namespace CssStyler {\n  export interface AbstractStyler {\n    getStyle(element: Element, deep: boolean): CssCascade.ElementStyle;\n    processContent(\n      element: Element,\n      styles: { [key: string]: Css.Val },\n      nodeContext: Vtree.NodeContext,\n    );\n  }\n}\n\nexport namespace Layout {\n  /**\n   * Represents a constraint on layout\n   */\n  export interface LayoutConstraint {\n    /**\n     * Returns if this constraint allows the node context to be laid out at the\n     * current position.\n     */\n    allowLayout(nodeContext: Vtree.NodeContext): boolean;\n  }\n  /**\n   * Represents constraints on laying out fragments\n   */\n  export interface FragmentLayoutConstraint {\n    flagmentLayoutConstraintType: FragmentLayoutConstraintType;\n    allowLayout(\n      nodeContext: Vtree.NodeContext,\n      overflownNodeContext: Vtree.NodeContext,\n      column: Column,\n    ): boolean;\n    nextCandidate(nodeContext: Vtree.NodeContext): boolean;\n    postLayout(\n      allowed: boolean,\n      positionAfter: Vtree.NodeContext,\n      initialPosition: Vtree.NodeContext,\n      column: Column,\n    );\n    finishBreak(\n      nodeContext: Vtree.NodeContext,\n      column: Column,\n    ): Task.Result<boolean>;\n    equalsTo(constraint: FragmentLayoutConstraint): boolean;\n    getPriorityOfFinishBreak(): number;\n  }\n\n  /**\n   * Potential breaking position.\n   */\n  export interface BreakPosition {\n    /**\n     * @return break position, if found\n     */\n    findAcceptableBreak(column: Column, penalty: number): Vtree.NodeContext;\n    /**\n     * @return penalty for this break position\n     */\n    getMinBreakPenalty(): number;\n    calculateOffset(column: Column): { current: number; minimum: number };\n    breakPositionChosen(column: Column): void;\n  }\n\n  export interface AbstractBreakPosition extends BreakPosition {\n    getNodeContext(): Vtree.NodeContext;\n  }\n\n  export type BreakPositionAndNodeContext = {\n    breakPosition: BreakPosition;\n    nodeContext: Vtree.NodeContext;\n  };\n\n  /**\n   * Potential breaking position inside CSS box (between lines).\n   * @param checkPoints array of breaking points for\n   *    breakable block\n   */\n  export interface BoxBreakPosition extends AbstractBreakPosition {\n    breakNodeContext: Vtree.NodeContext;\n    readonly checkPoints: Vtree.NodeContext[];\n    readonly penalty: number;\n  }\n\n  /**\n   * Potential edge breaking position.\n   */\n  export interface EdgeBreakPosition extends AbstractBreakPosition {\n    overflowIfRepetitiveElementsDropped: boolean;\n    readonly position: Vtree.NodeContext;\n    readonly breakOnEdge: string | null;\n    overflows: boolean;\n    readonly computedBlockSize: number;\n  }\n\n  export interface Column extends Vtree.Container {\n    last: Node;\n    viewDocument: Document;\n    flowRootFormattingContext: Vtree.FormattingContext;\n    isFloat: boolean;\n    isFootnote: boolean;\n    startEdge: number;\n    endEdge: number;\n    beforeEdge: number;\n    afterEdge: number;\n    footnoteEdge: number;\n    box: GeometryUtil.Rect;\n    chunkPositions: Vtree.ChunkPosition[];\n    bands: GeometryUtil.Band[];\n    overflown: boolean;\n    breakPositions: BreakPosition[];\n    pageBreakType: string | null;\n    forceNonfitting: boolean;\n    leftFloatEdge: number;\n    /**\n     * bottom of the bottommost left float\n     */\n    rightFloatEdge: number;\n    /**\n     * bottom of the bottommost right float\n     */\n    bottommostFloatTop: number;\n    /**\n     * Top of the bottommost float\n     */\n    stopAtOverflow: boolean;\n    lastAfterPosition: Vtree.NodePosition | null;\n    fragmentLayoutConstraints: FragmentLayoutConstraint[];\n    pseudoParent: Column;\n    nodeContextOverflowingDueToRepetitiveElements: Vtree.NodeContext | null;\n    blockDistanceToBlockEndFloats: number;\n    computedBlockSize: number;\n\n    layoutContext: Vtree.LayoutContext;\n    clientLayout: Vtree.ClientLayout;\n    readonly layoutConstraint: LayoutConstraint;\n    readonly pageFloatLayoutContext: PageFloats.PageFloatLayoutContext;\n\n    getTopEdge(): number;\n    getBottomEdge(): number;\n    getLeftEdge(): number;\n    getRightEdge(): number;\n    isFloatNodeContext(nodeContext: Vtree.NodeContext): boolean;\n    stopByOverflow(nodeContext: Vtree.NodeContext): boolean;\n    isOverflown(edge: number): boolean;\n    getExclusions(): GeometryUtil.Shape[];\n    openAllViews(position: Vtree.NodePosition): Task.Result<Vtree.NodeContext>;\n    calculateOffsetInNodeForNodeContext(position: Vtree.NodePosition): number;\n    /**\n     * @param count first-XXX nesting identifier\n     */\n    maybePeelOff(\n      position: Vtree.NodeContext,\n      count: number,\n    ): Task.Result<Vtree.NodeContext>;\n    /**\n     * Builds the view until a CSS box edge is reached.\n     * @param position start source position.\n     * @param checkPoints array to append possible breaking points.\n     * @return holding box edge position reached or null if the source is exhausted.\n     */\n    buildViewToNextBlockEdge(\n      position: Vtree.NodeContext,\n      checkPoints: Vtree.NodeContext[],\n    ): Task.Result<Vtree.NodeContext>;\n    nextInTree(\n      position: Vtree.NodeContext,\n      atUnforcedBreak?: boolean,\n    ): Task.Result<Vtree.NodeContext>;\n    /**\n     * Builds the view for a single unbreakable element.\n     * @param position start source position.\n     * @return holding box edge position reached or null if the source is exhausted.\n     */\n    buildDeepElementView(\n      position: Vtree.NodeContext,\n    ): Task.Result<Vtree.NodeContext>;\n\n    /**\n     * Create a single floating element (for exclusion areas).\n     * @param ref container's child to insert float before (can be null).\n     * @param side float side (\"left\" or \"right\").\n     * @param width float inline dimension.\n     * @param height float box progression dimension.\n     * @return newly created float element.\n     */\n    createFloat(\n      ref: Node,\n      side: string,\n      width: number,\n      height: number,\n    ): Element;\n    /**\n     * Remove all the exclusion floats.\n     */\n    killFloats(): void;\n    /**\n     * Create exclusion floats for a column.\n     */\n    createFloats(): void;\n    /**\n     * @param nodeContext position after the block\n     * @param checkPoints array of possible breaking points.\n     * @param index index of the breaking point\n     * @param boxOffset box offset\n     * @return edge position\n     */\n    calculateEdge(\n      nodeContext: Vtree.NodeContext,\n      checkPoints: Vtree.NodeContext[],\n      index: number,\n      boxOffset: number,\n    ): number;\n    /**\n     * Parse CSS computed length (in pixels)\n     * @param val CSS length in \"px\"\n     * @return parsed and adjusted length value in pixels or 0 if not parsable\n     */\n    parseComputedLength(val: string): number;\n    /**\n     * Reads element's computed CSS margin.\n     */\n    getComputedMargin(element: Element): GeometryUtil.Insets;\n    /**\n     * Reads element's computed padding + borders.\n     */\n    getComputedPaddingBorder(element: Element): GeometryUtil.Insets;\n    /**\n     * Reads element's computed CSS insets(margins + border + padding or margins :\n     * depends on box-sizing)\n     */\n    getComputedInsets(element: Element): GeometryUtil.Insets;\n    /**\n     * Set element's computed CSS insets to Column Container\n     */\n    setComputedInsets(element: Element, container: Column): void;\n    /**\n     * Set element's computed width and height to Column Container\n     */\n    setComputedWidthAndHeight(element: Element, container: Column): void;\n    /**\n     * Layout a single unbreakable element.\n     */\n    layoutUnbreakable(\n      nodeContextIn: Vtree.NodeContext,\n    ): Task.Result<Vtree.NodeContext>;\n    /**\n     * Layout a single float element.\n     */\n    layoutFloat(nodeContext: Vtree.NodeContext): Task.Result<Vtree.NodeContext>;\n\n    setupFloatArea(\n      area: PageFloatArea,\n      floatReference: PageFloats.FloatReference,\n      floatSide: string,\n      anchorEdge: number | null,\n      strategy: PageFloats.PageFloatLayoutStrategy,\n      condition: PageFloats.PageFloatPlacementCondition,\n    ): boolean;\n    createPageFloatArea(\n      float: PageFloats.PageFloat | null,\n      floatSide: string,\n      anchorEdge: number | null,\n      strategy: PageFloats.PageFloatLayoutStrategy,\n      condition: PageFloats.PageFloatPlacementCondition,\n    ): PageFloatArea | null;\n    layoutSinglePageFloatFragment(\n      continuations: PageFloats.PageFloatContinuation[],\n      floatSide: string,\n      clearSide: string | null,\n      allowFragmented: boolean,\n      strategy: PageFloats.PageFloatLayoutStrategy,\n      anchorEdge: number | null,\n      pageFloatFragment?: PageFloats.PageFloatFragment | null,\n    ): Task.Result<SinglePageFloatLayoutResult>;\n    layoutPageFloatInner(\n      continuation: PageFloats.PageFloatContinuation,\n      strategy: PageFloats.PageFloatLayoutStrategy,\n      anchorEdge: number | null,\n      pageFloatFragment?: PageFloats.PageFloatFragment,\n    ): Task.Result<boolean>;\n    setFloatAnchorViewNode(nodeContext: Vtree.NodeContext): Vtree.NodeContext;\n    resolveFloatReferenceFromColumnSpan(\n      floatReference: PageFloats.FloatReference,\n      columnSpan: Css.Val,\n      nodeContext: Vtree.NodeContext,\n    ): Task.Result<PageFloats.FloatReference>;\n    layoutPageFloat(\n      nodeContext: Vtree.NodeContext,\n    ): Task.Result<Vtree.NodeContext>;\n    processLineStyling(\n      nodeContext: Vtree.NodeContext,\n      resNodeContext: Vtree.NodeContext,\n      checkPoints: Vtree.NodeContext[],\n    ): Task.Result<Vtree.NodeContext>;\n    isLoneImage(checkPoints: Vtree.NodeContext[]): boolean;\n    getTrailingMarginEdgeAdjustment(\n      trailingEdgeContexts: Vtree.NodeContext[],\n    ): number;\n    /**\n     * Layout a single CSS box.\n     */\n    layoutBreakableBlock(\n      nodeContext: Vtree.NodeContext,\n    ): Task.Result<Vtree.NodeContext>;\n    postLayoutBlock(\n      nodeContext: Vtree.NodeContext,\n      checkPoints: Vtree.NodeContext[],\n    ): void;\n    findEndOfLine(\n      linePosition: number,\n      checkPoints: Vtree.NodeContext[],\n      isUpdateMaxReachedAfterEdge: boolean,\n    ): {\n      nodeContext: Vtree.NodeContext;\n      index: number;\n      checkPointIndex: number;\n    };\n    findAcceptableBreakInside(\n      checkPoints: Vtree.NodeContext[],\n      edgePosition: number,\n      force: boolean,\n    ): Vtree.NodeContext;\n    resolveTextNodeBreaker(nodeContext: Vtree.NodeContext): TextNodeBreaker;\n    /**\n     * Read ranges skipping special elments\n     */\n    getRangeBoxes(start: Node, end: Node): Vtree.ClientRect[];\n    /**\n     * Give block's initial and final nodes, find positions of the line bottoms.\n     * This is, of course, somewhat hacky implementation.\n     * @return position of line breaks\n     */\n    findLinePositions(checkPoints: Vtree.NodeContext[]): number[];\n    calculateClonedPaddingBorder(nodeContext: Vtree.NodeContext): number;\n    findBoxBreakPosition(\n      bp: BoxBreakPosition,\n      force: boolean,\n    ): Vtree.NodeContext;\n    getAfterEdgeOfBlockContainer(nodeContext: Vtree.NodeContext): number;\n    findFirstOverflowingEdgeAndCheckPoint(checkPoints: Vtree.NodeContext[]): {\n      edge: number;\n      checkPoint: Vtree.NodeContext | null;\n    };\n    findEdgeBreakPosition(bp: EdgeBreakPosition): Vtree.NodeContext;\n    /**\n     * Finalize a line break.\n     * @return holing true\n     */\n    finishBreak(\n      nodeContext: Vtree.NodeContext,\n      forceRemoveSelf: boolean,\n      endOfColumn: boolean,\n    ): Task.Result<boolean>;\n    findAcceptableBreakPosition(): BreakPositionAndNodeContext;\n    doFinishBreak(\n      nodeContext: Vtree.NodeContext,\n      overflownNodeContext: Vtree.NodeContext,\n      initialNodeContext: Vtree.NodeContext,\n      initialComputedBlockSize: number,\n    ): Task.Result<Vtree.NodeContext>;\n    /**\n     * Determines if a page break is acceptable at this position\n     */\n    isBreakable(flowPosition: Vtree.NodeContext): boolean;\n    /**\n     * Determines if an indent value is zero\n     */\n    zeroIndent(val: string | number): boolean;\n    /**\n     * @return true if overflows\n     */\n    checkOverflowAndSaveEdge(\n      nodeContext: Vtree.NodeContext,\n      trailingEdgeContexts: Vtree.NodeContext[],\n    ): boolean;\n    /**\n     * Save a possible page break position on a CSS block edge. Check if it\n     * overflows.\n     * @return true if overflows\n     */\n    checkOverflowAndSaveEdgeAndBreakPosition(\n      nodeContext: Vtree.NodeContext,\n      trailingEdgeContexts: Vtree.NodeContext[],\n      saveEvenOverflown: boolean,\n      breakAtTheEdge: string | null,\n    ): boolean;\n    applyClearance(nodeContext: Vtree.NodeContext): boolean;\n    isBFC(formattingContext: Vtree.FormattingContext): boolean;\n    /**\n     * Skips positions until either the start of unbreakable block or inline\n     * content. Also sets breakBefore on the result combining break-before and\n     * break-after properties from all elements that meet at the edge.\n     */\n    skipEdges(\n      nodeContext: Vtree.NodeContext,\n      leadingEdge: boolean,\n      forcedBreakValue: string | null,\n    ): Task.Result<Vtree.NodeContext>;\n    /**\n     * Skips non-renderable positions until it hits the end of the flow or some\n     * renderable content. Returns the nodeContext that was passed in if some\n     * content remains and null if all content could be skipped.\n     */\n    skipTailEdges(\n      nodeContext: Vtree.NodeContext,\n    ): Task.Result<Vtree.NodeContext>;\n    layoutFloatOrFootnote(\n      nodeContext: Vtree.NodeContext,\n    ): Task.Result<Vtree.NodeContext>;\n    /**\n     * Layout next portion of the source.\n     */\n    layoutNext(\n      nodeContext: Vtree.NodeContext,\n      leadingEdge: boolean,\n      forcedBreakValue?: string | null,\n    ): Task.Result<Vtree.NodeContext>;\n    clearOverflownViewNodes(\n      nodeContext: Vtree.NodeContext,\n      removeSelf: boolean,\n    ): void;\n    initGeom(): void;\n    init(): void;\n    /**\n     * Save the potential breaking position at the edge. Should, in general, save\n     * \"after\" position but only after skipping all of the \"before\" ones and\n     * getting to the non-empty content (to get breakAtEdge right).\n     */\n    saveEdgeBreakPosition(\n      position: Vtree.NodeContext,\n      breakAtEdge: string | null,\n      overflows: boolean,\n    ): void;\n    /**\n     * @param checkPoints array of breaking points for breakable block\n     */\n    saveBoxBreakPosition(checkPoints: Vtree.NodeContext[]): void;\n    updateMaxReachedAfterEdge(afterEdge: number): void;\n    /**\n     * @param chunkPosition starting position.\n     * @return holding end position.\n     */\n    layout(\n      chunkPosition: Vtree.ChunkPosition,\n      leadingEdge: boolean,\n      breakAfter?: string | null,\n    ): Task.Result<Vtree.ChunkPosition>;\n    isFullWithPageFloats(): boolean;\n    getMaxBlockSizeOfPageFloats(): number;\n    doFinishBreakOfFragmentLayoutConstraints(nodeContext): void;\n    /**\n     * @param nodeContext starting position.\n     * @return holding end position.\n     */\n    doLayout(\n      nodeContext: Vtree.NodeContext,\n      leadingEdge: boolean,\n      breakAfter?: string | null,\n    ): Task.Result<{\n      nodeContext: Vtree.NodeContext;\n      overflownNodeContext: Vtree.NodeContext;\n    }>;\n    /**\n     * Re-layout already laid-out chunks. Return the position of the last flow if\n     * there is an overflow.\n     * TODO: deal with chunks that did not fit at all.\n     * @return holding end position.\n     */\n    redoLayout(): Task.Result<Vtree.ChunkPosition>;\n    saveDistanceToBlockEndFloats(): void;\n    collectElementsOffset(): RepetitiveElement.ElementsOffset[];\n  }\n\n  export type SinglePageFloatLayoutResult = {\n    floatArea: PageFloatArea | null;\n    pageFloatFragment: PageFloats.PageFloatFragment | null;\n    newPosition: Vtree.ChunkPosition | null;\n  };\n\n  /**\n   * breaking point resolver for Text Node.\n   */\n  export interface TextNodeBreaker {\n    breakTextNode(\n      textNode: Text,\n      nodeContext: Vtree.NodeContext,\n      low: number,\n      checkPoints: Vtree.NodeContext[],\n      checkpointIndex: number,\n      force: boolean,\n    ): Vtree.NodeContext;\n    breakAfterSoftHyphen(\n      textNode: Text,\n      text: string,\n      viewIndex: number,\n      nodeContext: Vtree.NodeContext,\n    ): number;\n    breakAfterOtherCharacter(\n      textNode: Text,\n      text: string,\n      viewIndex: number,\n      nodeContext: Vtree.NodeContext,\n    ): number;\n    updateNodeContext(\n      nodeContext: Vtree.NodeContext,\n      viewIndex: number,\n      textNode: Text,\n    ): Vtree.NodeContext;\n  }\n\n  export interface LayoutMode {\n    doLayout(\n      nodeContext: Vtree.NodeContext,\n      column: Layout.Column,\n    ): Task.Result<Vtree.NodeContext>;\n    accept(nodeContext: Vtree.NodeContext, column: Layout.Column): boolean;\n    postLayout(\n      positionAfter: Vtree.NodeContext,\n      initialPosition: Vtree.NodeContext,\n      column: Layout.Column,\n      accepted: boolean,\n    ): boolean;\n  }\n\n  export interface PageFloatArea extends Column {\n    adjustContentRelativeSize: boolean;\n    readonly floatSide: string;\n    readonly parentContainer: Vtree.Container;\n\n    convertPercentageSizesToPx(target: Element): void;\n    fixFloatSizeAndPosition(nodeContext: Vtree.NodeContext): void;\n    getContentInlineSize(): number;\n  }\n}\n\nexport namespace LayoutProcessor {\n  export interface BlockFormattingContext extends Vtree.FormattingContext {}\n\n  export function isInstanceOfBlockFormattingContext(\n    object: Vtree.FormattingContext,\n  ): object is BlockFormattingContext {\n    return object && object.formattingContextType === \"Block\";\n  }\n}\n\nexport namespace Net {\n  export type FetchResponse = {\n    status: number;\n    statusText: string | null;\n    url: string;\n    contentType: string | null;\n    responseText: string | null;\n    responseXML: Document;\n    responseBlob: Blob;\n  };\n\n  export interface ResourceStore<Resource> {\n    resources: { [key: string]: Resource };\n    fetchers: { [key: string]: TaskUtil.Fetcher<Resource> };\n    readonly parser: (\n      p1: FetchResponse,\n      p2: ResourceStore<Resource>,\n    ) => Task.Result<Resource>;\n    readonly type: XMLHttpRequestResponseType;\n\n    /**\n     * @return resource for the given URL\n     */\n    load(\n      url: string,\n      opt_required?: boolean,\n      opt_message?: string,\n    ): Task.Result<Resource>;\n    /**\n     * @return fetcher for the resource for the given URL\n     */\n    fetch(\n      url: string,\n      opt_required?: boolean,\n      opt_message?: string,\n    ): TaskUtil.Fetcher<Resource>;\n    get(url: string): XmlDoc.XMLDocHolder;\n    delete(url: string): void;\n  }\n}\n\nexport namespace PageFloats {\n  /**\n   * @enum {string}\n   */\n  export enum FloatReference {\n    INLINE = \"inline\",\n    COLUMN = \"column\",\n    REGION = \"region\",\n    PAGE = \"page\",\n  }\n\n  export type PageFloatID = string;\n\n  export interface PageFloat {\n    order: number | null;\n    id: PageFloatID | null;\n    readonly nodePosition: Vtree.NodePosition;\n    readonly floatReference: FloatReference;\n    readonly floatSide: string;\n    readonly clearSide: string | null;\n    readonly flowName: string;\n    readonly floatMinWrapBlock: Css.Numeric | null;\n\n    getOrder(): number;\n    getId(): PageFloatID;\n    isAllowedOnContext(pageFloatLayoutContext: PageFloatLayoutContext): boolean;\n    isAllowedToPrecede(other: PageFloat): boolean;\n  }\n\n  export interface PageFloatFragment {\n    readonly floatReference: FloatReference;\n    readonly floatSide: string;\n    readonly clearSide: string | null;\n    readonly continuations: PageFloatContinuation[];\n    readonly area: Vtree.Container;\n    readonly continues: boolean;\n\n    hasFloat(float: PageFloat): boolean;\n    findNotAllowedFloat(context: PageFloatLayoutContext): PageFloat | null;\n    getOuterShape(): GeometryUtil.Shape;\n    getOuterRect(): GeometryUtil.Rect;\n    getOrder(): number;\n    shouldBeStashedBefore(float: PageFloat): boolean;\n    addContinuations(continuations: PageFloatContinuation[]): void;\n    getFlowName(): string;\n  }\n\n  export interface PageFloatContinuation {\n    readonly float: PageFloat;\n    readonly nodePosition: Vtree.NodePosition;\n\n    equals(other: PageFloatContinuation | null): boolean;\n  }\n\n  export type PageFloatPlacementCondition = {\n    [key: string]: boolean;\n  };\n\n  export interface PageFloatLayoutContext {\n    writingMode: Css.Val;\n    direction: Css.Val;\n    floatFragments: PageFloatFragment[];\n    readonly parent: PageFloatLayoutContext;\n    readonly flowName: string | null;\n    readonly generatingNodePosition: Vtree.NodePosition | null;\n\n    getContainer(floatReference?: FloatReference): Vtree.Container;\n    setContainer(container: Vtree.Container);\n    addPageFloat(float: PageFloat): void;\n    getPageFloatLayoutContext(\n      floatReference: FloatReference,\n    ): PageFloatLayoutContext;\n    findPageFloatByNodePosition(\n      nodePosition: Vtree.NodePosition,\n    ): PageFloat | null;\n    isForbidden(float: PageFloat): boolean;\n    addPageFloatFragment(\n      floatFragment: PageFloatFragment,\n      dontInvalidate?: boolean,\n    ): void;\n    removePageFloatFragment(\n      floatFragment: PageFloatFragment,\n      dontInvalidate?: boolean,\n    ): void;\n    findPageFloatFragment(float: PageFloat): PageFloatFragment | null;\n    hasFloatFragments(condition?: (p1: PageFloatFragment) => boolean): boolean;\n    hasContinuingFloatFragmentsInFlow(flowName: string): boolean;\n    registerPageFloatAnchor(float: PageFloat, anchorViewNode: Node): void;\n    collectPageFloatAnchors(): any;\n    isAnchorAlreadyAppeared(floatId: PageFloatID): boolean;\n    deferPageFloat(continuation: PageFloatContinuation): void;\n    hasPrecedingFloatsDeferredToNext(\n      float: PageFloat,\n      ignoreReference?: boolean,\n    ): boolean;\n    getLastFollowingFloatInFragments(float: PageFloat): PageFloat | null;\n    getDeferredPageFloatContinuations(\n      flowName?: string | null,\n    ): PageFloatContinuation[];\n    getPageFloatContinuationsDeferredToNext(\n      flowName?: string | null,\n    ): PageFloatContinuation[];\n    getFloatsDeferredToNextInChildContexts(): PageFloat[];\n    checkAndForbidNotAllowedFloat(): boolean;\n    checkAndForbidFloatFollowingDeferredFloat(): boolean;\n    finish(): void;\n    hasSameContainerAs(other: PageFloatLayoutContext): boolean;\n    invalidate(): void;\n    detachChildren(): PageFloatLayoutContext[];\n    attachChildren(children: PageFloatLayoutContext[]): void;\n    isInvalidated(): boolean;\n    validate(): void;\n    removeEndFloatFragments(floatSide: string): void;\n    stashEndFloatFragments(float: PageFloat): void;\n    restoreStashedFragments(floatReference: FloatReference): void;\n    discardStashedFragments(floatReference: FloatReference): void;\n    getStashedFloatFragments(\n      floatReference: FloatReference,\n    ): PageFloatFragment[];\n    /**\n     * @param anchorEdge Null indicates that the anchor is not in the current\n     *     container.\n     * @return Logical float side (snap-block is resolved when init=false). Null\n     *     indicates that the float area does not fit inside the container\n     */\n    setFloatAreaDimensions(\n      area: Layout.PageFloatArea,\n      floatReference: FloatReference,\n      floatSide: string,\n      anchorEdge: number | null,\n      init: boolean,\n      force: boolean,\n      condition: PageFloatPlacementCondition,\n    ): string | null;\n    getFloatFragmentExclusions(): GeometryUtil.Shape[];\n    getMaxReachedAfterEdge(): number;\n    getBlockStartEdgeOfBlockEndFloats(): number;\n    getPageFloatClearEdge(clear: string, column: Layout.Column): number;\n    getPageFloatPlacementCondition(\n      float: PageFloat,\n      floatSide: string,\n      clearSide: string | null,\n    ): PageFloatPlacementCondition;\n    getLayoutConstraints(): Layout.LayoutConstraint[];\n    addLayoutConstraint(\n      layoutConstraint: Layout.LayoutConstraint,\n      floatReference: FloatReference,\n    ): void;\n    getMaxBlockSizeOfPageFloats(): number;\n    lock(): void;\n    unlock(): void;\n    isLocked(): boolean;\n  }\n\n  export interface PageFloatLayoutStrategy {\n    appliesToNodeContext(nodeContext: Vtree.NodeContext): boolean;\n    appliesToFloat(float: PageFloat): boolean;\n    createPageFloat(\n      nodeContext: Vtree.NodeContext,\n      pageFloatLayoutContext: PageFloatLayoutContext,\n      column: Layout.Column,\n    ): Task.Result<PageFloat>;\n    createPageFloatFragment(\n      continuations: PageFloatContinuation[],\n      floatSide: string,\n      clearSide: string | null,\n      floatArea: Layout.PageFloatArea,\n      continues: boolean,\n    ): PageFloatFragment;\n    findPageFloatFragment(\n      float: PageFloat,\n      pageFloatLayoutContext: PageFloatLayoutContext,\n    ): PageFloatFragment | null;\n    adjustPageFloatArea(\n      floatArea: Layout.PageFloatArea,\n      floatContainer: Vtree.Container,\n      column: Layout.Column,\n    );\n    forbid(float: PageFloat, pageFloatLayoutContext: PageFloatLayoutContext);\n  }\n}\n\nexport namespace Selectors {\n  export interface AfterIfContinues {\n    readonly sourceNode: Element;\n    readonly styler: PseudoElement.PseudoelementStyler;\n\n    createElement(\n      column: Layout.Column,\n      parentNodeContext: Vtree.NodeContext,\n    ): Task.Result<Element>;\n  }\n\n  export interface AfterIfContinuesLayoutConstraint\n    extends Layout.FragmentLayoutConstraint {\n    nodeContext: Vtree.NodeContext;\n    afterIfContinues: AfterIfContinues;\n    pseudoElementHeight: number;\n\n    getRepetitiveElements(): AfterIfContinuesElementsOffset;\n  }\n\n  export function isInstanceOfAfterIfContinuesLayoutConstraint(\n    object: Layout.FragmentLayoutConstraint,\n  ): object is AfterIfContinuesLayoutConstraint {\n    return object && object.flagmentLayoutConstraintType == \"AfterIfContinue\";\n  }\n\n  export interface AfterIfContinuesElementsOffset\n    extends RepetitiveElement.ElementsOffset {\n    nodeContext: Vtree.NodeContext;\n    pseudoElementHeight: number;\n\n    affectTo(nodeContext: Vtree.NodeContext): boolean;\n  }\n}\n\nexport namespace PseudoElement {\n  export interface PseudoelementStyler extends CssStyler.AbstractStyler {\n    contentProcessed: { [key: string]: boolean };\n    readonly element: Element;\n    style: CssCascade.ElementStyle;\n    styler: CssStyler.AbstractStyler;\n    readonly context: Exprs.Context;\n    readonly exprContentListener: Vtree.ExprContentListener;\n  }\n}\n\nexport namespace RepetitiveElement {\n  export interface RepetitiveElementsOwnerFormattingContext\n    extends Vtree.FormattingContext {\n    isRoot: boolean;\n    repetitiveElements: RepetitiveElements;\n    readonly parent: Vtree.FormattingContext;\n    readonly rootSourceNode: Element;\n    getRepetitiveElements(): RepetitiveElements;\n    getRootViewNode(position: Vtree.NodeContext): Element | null;\n    getRootNodeContext(\n      nodeContext: Vtree.NodeContext,\n    ): Vtree.NodeContext | null;\n    initializeRepetitiveElements(vertical: boolean): void;\n  }\n\n  export function isInstanceOfRepetitiveElementsOwnerFormattingContext(\n    object: Vtree.FormattingContext,\n  ): object is RepetitiveElementsOwnerFormattingContext {\n    if (!object) {\n      return false;\n    }\n    const type = object.formattingContextType;\n    return (\n      type === \"RepetitiveElementsOwner\" ||\n      Table.isInstanceOfTableFormattingContext(object)\n    ); // subset\n  }\n\n  export interface ElementsOffset {\n    calculateOffset(nodeContext: Vtree.NodeContext): number;\n    calculateMinimumOffset(nodeContext: Vtree.NodeContext): number;\n  }\n\n  export interface RepetitiveElements extends ElementsOffset {\n    isSkipHeader: boolean;\n    isSkipFooter: boolean;\n    enableSkippingFooter: boolean;\n    enableSkippingHeader: boolean;\n    doneInitialLayout: boolean;\n    firstContentSourceNode: Element | null;\n    lastContentSourceNode: Element | null;\n    allowInsert: boolean;\n    allowInsertRepeatitiveElements: boolean;\n    ownerSourceNode: Element;\n\n    setHeaderNodeContext(nodeContext: Vtree.NodeContext): void;\n    setFooterNodeContext(nodeContext: Vtree.NodeContext): void;\n    updateHeight(column: Layout.Column): void;\n    prepareLayoutFragment(): void;\n    appendHeaderToFragment(\n      rootNodeContext: Vtree.NodeContext,\n      firstChild: Node | null,\n      column: Layout.Column,\n    ): Task.Result<boolean>;\n    appendFooterToFragment(\n      rootNodeContext: Vtree.NodeContext,\n      firstChild: Node | null,\n      column: Layout.Column,\n    ): Task.Result<boolean>;\n    appendElementToFragment(\n      nodePosition: Vtree.NodePosition,\n      rootNodeContext: Vtree.NodeContext,\n      firstChild: Node | null,\n      column: Layout.Column,\n    ): Task.Result<boolean>;\n    moveChildren(from: Element, to: Element, firstChild: Node | null): void;\n    isAfterLastContent(nodeContext: Vtree.NodeContext): boolean;\n    isFirstContentNode(nodeContext: Vtree.NodeContext): boolean;\n    isEnableToUpdateState(): boolean;\n    updateState(): void;\n    preventSkippingHeader(): void;\n    preventSkippingFooter(): void;\n    isHeaderRegistered(): boolean;\n    isFooterRegistered(): boolean;\n    isHeaderSourceNode(node: Node): boolean;\n    isFooterSourceNode(node: Node): boolean;\n  }\n\n  export interface RepetitiveElementsOwnerLayoutConstraint\n    extends Layout.FragmentLayoutConstraint {\n    getRepetitiveElements(): RepetitiveElements;\n  }\n\n  export function isInstanceOfRepetitiveElementsOwnerLayoutConstraint(\n    object: Layout.FragmentLayoutConstraint,\n  ): object is RepetitiveElementsOwnerLayoutConstraint {\n    if (!object) {\n      return false;\n    }\n    const type = object.flagmentLayoutConstraintType;\n    return (\n      type === \"RepetitiveElementsOwner\" ||\n      Table.isInstanceOfTableRowLayoutConstraint(object)\n    ); // subset\n  }\n}\n\nexport namespace Table {\n  export interface TableFormattingContext\n    extends RepetitiveElement.RepetitiveElementsOwnerFormattingContext {\n    // FIXME\n  }\n\n  export function isInstanceOfTableFormattingContext(\n    object: Vtree.FormattingContext,\n  ): object is TableFormattingContext {\n    return object && object.formattingContextType === \"Table\";\n  }\n\n  export interface TableRowLayoutConstraint\n    extends RepetitiveElement.RepetitiveElementsOwnerLayoutConstraint {\n    cellFragmentLayoutConstraints: {\n      constraints: Layout.FragmentLayoutConstraint[];\n      breakPosition: Vtree.NodeContext;\n    }[];\n\n    removeDummyRowNodes(nodeContext: Vtree.NodeContext): void;\n    getElementsOffsetsForTableCell(\n      column: Layout.Column,\n    ): RepetitiveElement.ElementsOffset[];\n  }\n\n  export function isInstanceOfTableRowLayoutConstraint(\n    object: Layout.FragmentLayoutConstraint,\n  ): object is TableRowLayoutConstraint {\n    return object && object.flagmentLayoutConstraintType === \"TableRow\";\n  }\n}\n\nexport namespace Vtree {\n  export type ClientRect = {\n    left: number;\n    top: number;\n    right: number;\n    bottom: number;\n    width: number;\n    height: number;\n  };\n\n  /**\n   * Interface to read the position assigned to the elements and ranges by the\n   * browser.\n   */\n  export interface ClientLayout {\n    layoutBox: Element;\n    window: Window;\n    pixelRatio: number;\n    scaleRatio: number;\n    layoutUnitPerPixel: number;\n    getRangeClientRects(range: Range): ClientRect[];\n    getElementClientRect(element: Element): ClientRect;\n    /**\n     * @return element's computed style\n     */\n    getElementComputedStyle(element: Element): CSSStyleDeclaration;\n    /**\n     * Adjust length value with rendering precision.\n     * @param value Length value to adjust\n     * @return Adjusted length value\n     */\n    adjustLengthValue(value: number): number;\n  }\n\n  /**\n   * Styling, creating a single node's view, etc.\n   */\n  export interface LayoutContext {\n    /**\n     * Creates a functionally equivalent, but uninitialized layout context,\n     * suitable for building a separate column.\n     */\n    clone(): LayoutContext;\n    /**\n     * Set the current source node and create a view. Parameter firstTime\n     * is true (and possibly offsetInNode > 0) if node was broken on\n     * the previous page.\n     * @return true if children should be processed as well\n     */\n    setCurrent(\n      nodeContext: NodeContext,\n      firstTime: boolean,\n      atUnforcedBreak?: boolean,\n    ): Task.Result<boolean>;\n    /**\n     * Set the container element that holds view elements produced from the\n     * source.\n     */\n    setViewRoot(viewRoot: Element, isFootnote: boolean);\n    /**\n     * Moves to the next view node, creating it and appending it to the view tree\n     * if needed.\n     * @return that corresponds to the next view node\n     */\n    nextInTree(\n      nodeContext: NodeContext,\n      atUnforcedBreak?: boolean,\n    ): Task.Result<NodeContext>;\n    /**\n     * Apply pseudo-element styles (if any).\n     * @param target element to apply styles to\n     */\n    applyPseudoelementStyle(\n      nodeContext: NodeContext,\n      pseudoName: string,\n      target: Element,\n    ): void;\n    /**\n     * Apply styles to footnote container.\n     * @param target element to apply styles to\n     * @return vertical\n     */\n    applyFootnoteStyle(\n      vertical: boolean,\n      rtl: boolean,\n      target: Element,\n    ): boolean;\n    /**\n     * Peel off innermost first-XXX pseudoelement, create and create view nodes\n     * after the end of that pseudoelement.\n     */\n    peelOff(\n      nodeContext: NodeContext,\n      nodeOffset: number,\n    ): Task.Result<NodeContext>;\n    /**\n     * Process a block-end edge of a fragmented block.\n     */\n    processFragmentedBlockEdge(nodeContext: NodeContext);\n    convertLengthToPx(\n      numeric: Css.Numeric,\n      viewNode: Node,\n      clientLayout: ClientLayout,\n    ): number | Css.Numeric;\n    /**\n     * Returns if two NodePositions represents the same position in the document.\n     */\n    isSameNodePosition(\n      nodePosition1: NodePosition,\n      nodePosition2: NodePosition,\n    ): boolean;\n    addEventListener(\n      type: string,\n      listener: Base.EventListener,\n      capture?: boolean,\n    ): void;\n    removeEventListener(\n      type: string,\n      listener: Base.EventListener,\n      capture?: boolean,\n    ): void;\n    dispatchEvent(evt: Base.Event): void;\n  }\n\n  /**\n   * Formatting context.\n   */\n  export interface FormattingContext {\n    formattingContextType: FormattingContextType;\n    getName(): string;\n    isFirstTime(nodeContext: NodeContext, firstTime: boolean): boolean;\n    getParent(): FormattingContext;\n    saveState(): any;\n    restoreState(state: any);\n  }\n\n  export type NodePositionStep = {\n    node: Node;\n    shadowType: ShadowType;\n    shadowContext: ShadowContext | null;\n    nodeShadow: ShadowContext | null;\n    shadowSibling: NodePositionStep | null;\n    formattingContext: FormattingContext | null;\n    fragmentIndex: number;\n  };\n\n  export type NodePosition = {\n    steps: NodePositionStep[];\n    offsetInNode: number;\n    after: boolean;\n    preprocessedTextContent: Diff.Change[] | null;\n  };\n\n  /**\n   * Handling of purely whitespace sequences between blocks\n   * @enum {number}\n   */\n  export enum Whitespace {\n    /**\n     * Whitespace sequence between blocks is ignored\n     */\n    IGNORE,\n    /**\n     * Whitespace sequence between blocks is ignored unless it containes newline\n     */\n    NEWLINE,\n    /**\n     * Whitespace sequence between blocks is preserved\n     */\n    PRESERVE,\n  }\n\n  export interface Container {\n    left: number;\n    top: number;\n    marginLeft: number;\n    marginRight: number;\n    marginTop: number;\n    marginBottom: number;\n    borderLeft: number;\n    borderRight: number;\n    borderTop: number;\n    borderBottom: number;\n    paddingLeft: number;\n    paddingRight: number;\n    paddingTop: number;\n    paddingBottom: number;\n    width: number;\n    height: number;\n    originX: number;\n    originY: number;\n    exclusions: GeometryUtil.Shape[];\n    innerShape: GeometryUtil.Shape;\n    computedBlockSize: number;\n    snapWidth: number;\n    snapHeight: number;\n    snapOffsetX: number;\n    snapOffsetY: number;\n    vertical: boolean; // vertical writing\n    rtl: boolean;\n    element: HTMLElement;\n    borderBoxSizing: boolean;\n\n    getInsetTop(): number;\n    getInsetBottom(): number;\n    getInsetLeft(): number;\n    getInsetRight(): number;\n    getInsetBefore(): number;\n    getInsetAfter(): number;\n    getInsetStart(): number;\n    getInsetEnd(): number;\n    getBeforeEdge(box: ClientRect): number;\n    getAfterEdge(box: ClientRect): number;\n    getStartEdge(box: ClientRect): number;\n    getEndEdge(box: ClientRect): number;\n    getInlineSize(box: ClientRect): number;\n    getBoxSize(box: ClientRect): number;\n    getBoxDir(): number;\n    getInlineDir(): number;\n    copyFrom(other: Container): void;\n    setVerticalPosition(top: number, height: number): void;\n    setHorizontalPosition(left: number, width: number): void;\n    setBlockPosition(start: number, extent: number): void;\n    setInlinePosition(start: number, extent: number): void;\n    clear(): void;\n    getInnerShape(): GeometryUtil.Shape;\n    getInnerRect(): GeometryUtil.Rect;\n    getPaddingRect(): GeometryUtil.Rect;\n    getOuterShape(\n      outerShapeProp: Css.Val,\n      context: Exprs.Context,\n    ): GeometryUtil.Shape;\n    getOuterRect(): GeometryUtil.Rect;\n  }\n\n  /**\n   * @enum {number}\n   */\n  export enum ShadowType {\n    NONE,\n    CONTENT,\n    ROOTLESS,\n    ROOTED,\n  }\n\n  /**\n   * Data about shadow tree instance.\n   */\n  export interface ShadowContext {\n    readonly owner: Element;\n    readonly root: Element;\n    readonly xmldoc: XmlDoc.XMLDocHolder;\n    readonly parentShadow: ShadowContext;\n    subShadow: ShadowContext;\n    readonly type: Vtree.ShadowType;\n    readonly styler: CssStyler.AbstractStyler;\n\n    equals(other: ShadowContext): boolean;\n  }\n\n  /**\n   * Information about :first-letter or :first-line pseudoelements\n   * @param count 0 - first-letter, 1 or more - first line(s)\n   */\n  export interface FirstPseudo {\n    readonly outer: FirstPseudo;\n    readonly count: number;\n  }\n\n  /**\n   * NodeContext represents a position in the document + layout-related\n   * information attached to it. When after=false and offsetInNode=0, the\n   * position is inside the element (node), but just before its first child.\n   * When offsetInNode>0 it represents offset in the textual content of the\n   * node. When after=true it represents position right after the last child\n   * of the node. boxOffset is incremented by 1 for any valid node position.\n   */\n  export interface NodeContext {\n    // position itself\n    offsetInNode: number;\n    after: boolean;\n    shadowType: ShadowType; // parent's shadow type\n    shadowContext: Vtree.ShadowContext;\n    nodeShadow: Vtree.ShadowContext;\n    shadowSibling: NodeContext; // next \"sibling\" in the shadow tree\n    // other stuff\n    shared: boolean;\n    inline: boolean;\n    overflow: boolean;\n    breakPenalty: number;\n    display: string | null;\n    floatReference: PageFloats.FloatReference;\n    floatSide: string | null;\n    clearSide: string | null;\n    floatMinWrapBlock: Css.Numeric | null;\n    columnSpan: Css.Val | null;\n    verticalAlign: string;\n    captionSide: string;\n    inlineBorderSpacing: number;\n    blockBorderSpacing: number;\n    flexContainer: boolean;\n    whitespace: Whitespace;\n    hyphenateCharacter: string | null;\n    breakWord: boolean;\n    establishesBFC: boolean;\n    containingBlockForAbsolute: boolean;\n    breakBefore: string | null;\n    breakAfter: string | null;\n    viewNode: Node;\n    clearSpacer: Node;\n    inheritedProps: { [key: string]: number | string | Css.Val };\n    vertical: boolean;\n    direction: string;\n    firstPseudo: FirstPseudo;\n    lang: string | null;\n    preprocessedTextContent: Diff.Change[] | null;\n    formattingContext: FormattingContext;\n    repeatOnBreak: string | null;\n    pluginProps: {\n      [key: string]: string | number | undefined | null | (number | null)[];\n    };\n    fragmentIndex: number;\n    afterIfContinues: Selectors.AfterIfContinues;\n    footnotePolicy: Css.Ident | null;\n    pageType: string | null;\n\n    sourceNode: Node;\n    parent: NodeContext;\n    boxOffset: number;\n\n    resetView(): void;\n    modify(): NodeContext;\n    copy(): NodeContext;\n    clone(): NodeContext;\n    toNodePositionStep(): NodePositionStep;\n    toNodePosition(): NodePosition;\n    isInsideBFC(): boolean;\n    getContainingBlockForAbsolute(): NodeContext;\n    belongsTo(formattingContext: FormattingContext): boolean;\n  }\n\n  export interface ChunkPosition {\n    floats: NodePosition[];\n    primary: NodePosition;\n\n    clone(): ChunkPosition;\n    isSamePosition(other: ChunkPosition): boolean;\n  }\n\n  export type ExprContentListener = (\n    p1: Exprs.Val,\n    p2: string,\n    p3: Document,\n  ) => Node | null;\n}\n\nexport namespace XmlDoc {\n  export interface XMLDocHolder {\n    lang: string | null;\n    totalOffset: number;\n    root: Element;\n    body: Element;\n    head: Element;\n    last: Element;\n    lastOffset: number;\n    idMap: { [key: string]: Element };\n    readonly store: XMLDocStore;\n    readonly url: string;\n    readonly document: Document;\n\n    doc(): NodeList;\n    getElementOffset(element: Element): number;\n    getNodeOffset(srcNode: Node, offsetInNode: number, after: boolean): number;\n    getTotalOffset(): number;\n    /**\n     * @return last node such that its offset is less or equal to the given\n     */\n    getNodeByOffset(offset: number): Node;\n    /**\n     * Get element by URL in the source document(s). URL must be in either '#id'\n     * or 'url#id' form.\n     */\n    getElement(url: string): Element | null;\n  }\n\n  export interface Predicate {\n    readonly fn: (p1: Node) => boolean;\n\n    check(node: Node): boolean;\n    withAttribute(name: string, value: string): Predicate;\n    withChild(name: string, opt_childPredicate?: Predicate): Predicate;\n  }\n\n  export interface NodeList {\n    readonly nodes: Node[];\n\n    asArray(): Node[];\n    size(): number;\n    /**\n     * Filter with predicate\n     */\n    predicate(pr: Predicate): NodeList;\n    forEachNode(fn: (p1: Node, p2: (p1: Node) => void) => void): NodeList;\n    forEach<T>(fn: (p1: Node) => T): T[];\n    forEachNonNull<T>(fn: (p1: Node) => T): T[];\n    child(tag: string): NodeList;\n    childElements(): NodeList;\n    attribute(name: string): (string | null)[];\n    textContent(): (string | null)[];\n  }\n\n  export type XMLDocStore = Net.ResourceStore<XMLDocHolder>;\n}\n", "/**\n * Copyright 2013 Google, Inc.\n * Copyright 2015 Daishinsha Inc.\n * Copyright 2019 Vivliostyle Foundation\n *\n * Vivliostyle.js is free software: you can redistribute it and/or modify\n * it under the terms of the GNU Affero General Public License as published by\n * the Free Software Foundation, either version 3 of the License, or\n * (at your option) any later version.\n *\n * Vivliostyle.js is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n * GNU Affero General Public License for more details.\n *\n * You should have received a copy of the GNU Affero General Public License\n * along with Vivliostyle.js.  If not, see <http://www.gnu.org/licenses/>.\n *\n * @fileoverview Vtree - Basic view tree data structures and support utilities.\n */\nimport * as Base from \"./base\";\nimport * as Break from \"./break\";\nimport * as Constants from \"./constants\";\nimport * as Css from \"./css\";\nimport * as CssParser from \"./css-parser\";\nimport * as CssProp from \"./css-prop\";\nimport * as CssTokenizer from \"./css-tokenizer\";\nimport * as Diff from \"./diff\";\nimport * as Exprs from \"./exprs\";\nimport * as GeometryUtil from \"./geometry-util\";\nimport * as TaskUtil from \"./task-util\";\nimport { assert } from \"./asserts\";\nimport {\n  CssStyler,\n  PageFloats,\n  PseudoElement,\n  Selectors,\n  Vtree,\n  XmlDoc,\n} from \"./types\";\n\nexport const delayedProps = {\n  transform: true,\n  \"transform-origin\": true,\n};\n\nexport const delayedPropsIfRelativePositioned = {\n  top: true,\n  bottom: true,\n  left: true,\n  right: true,\n};\n\nexport class DelayedItem {\n  constructor(\n    public target: Element,\n    public name: string,\n    public value: Css.Val,\n  ) {}\n}\n\nexport type PageHyperlinkEvent = {\n  type: string;\n  target;\n  currentTarget;\n  anchorElement: Element;\n  href: string;\n};\n\nexport type Trigger = {\n  observer: string;\n  event: string;\n  action: string;\n  ref: string;\n};\n\nexport const actions = {\n  show: function (obj) {\n    obj.style.visibility = \"visible\";\n  },\n  hide: function (obj) {\n    obj.style.visibility = \"hidden\";\n  },\n  play: function (obj) {\n    obj.currentTime = 0;\n    obj.play();\n  },\n  pause: function (obj) {\n    obj.pause();\n  },\n  resume: function (obj) {\n    obj.play();\n  },\n  mute: function (obj) {\n    obj.muted = true;\n  },\n  unmute: function (obj) {\n    obj.muted = false;\n  },\n};\n\nexport function makeListener(\n  refs: Element[],\n  action: string,\n): EventListener | null {\n  const actionFn = actions[action];\n  if (actionFn) {\n    return () => {\n      for (let k = 0; k < refs.length; k++) {\n        try {\n          actionFn(refs[k]);\n        } catch (err) {}\n      }\n    };\n  }\n  return null;\n}\n\nexport class Page extends Base.SimpleEventTarget {\n  private static AUTO_PAGE_WIDTH_ATTRIBUTE: string =\n    \"data-vivliostyle-auto-page-width\";\n  private static AUTO_PAGE_HEIGHT_ATTRIBUTE: string =\n    \"data-vivliostyle-auto-page-height\";\n  pageAreaElement: HTMLElement | null = null;\n  delayedItems: DelayedItem[] = [];\n  hrefHandler: (e: Event) => void;\n  elementsById: { [key: string]: Element[] } = {};\n  dimensions: { width: number; height: number } = { width: 0, height: 0 };\n  isFirstPage: boolean = false;\n  isLastPage: boolean = false;\n  isBlankPage: boolean = false;\n  isAutoPageWidth: boolean = true;\n  isAutoPageHeight: boolean = true;\n  spineIndex: number = 0;\n  position: LayoutPosition = null;\n  offset: number = -1;\n  side: Constants.PageSide | null = null;\n  fetchers: TaskUtil.Fetcher<{}>[] = [];\n  marginBoxes: {\n    top: { [key: string]: Container };\n    bottom: { [key: string]: Container };\n    left: { [key: string]: Container };\n    right: { [key: string]: Container };\n  } = { top: {}, bottom: {}, left: {}, right: {} };\n  pageType: string | null = null;\n\n  constructor(\n    public readonly container: HTMLElement,\n    public readonly bleedBox: HTMLElement,\n  ) {\n    super();\n    this.hrefHandler = (e: Event) => {\n      const anchorElement = e.currentTarget as Element;\n      const href =\n        anchorElement.getAttribute(\"href\") ||\n        anchorElement.getAttributeNS(Base.NS.XLINK, \"href\");\n      if (href) {\n        const evt = {\n          type: \"hyperlink\",\n          target: null,\n          currentTarget: null,\n          anchorElement,\n          href,\n          preventDefault() {\n            e.preventDefault();\n          },\n        };\n        this.dispatchEvent(evt);\n      }\n    };\n  }\n\n  setAutoPageWidth(isAuto: boolean) {\n    this.isAutoPageWidth = isAuto;\n    if (isAuto) {\n      this.container.setAttribute(Page.AUTO_PAGE_WIDTH_ATTRIBUTE, \"true\");\n    } else {\n      this.container.removeAttribute(Page.AUTO_PAGE_WIDTH_ATTRIBUTE);\n    }\n  }\n\n  setAutoPageHeight(isAuto: boolean) {\n    this.isAutoPageHeight = isAuto;\n    if (isAuto) {\n      this.container.setAttribute(Page.AUTO_PAGE_HEIGHT_ATTRIBUTE, \"true\");\n    } else {\n      this.container.removeAttribute(Page.AUTO_PAGE_HEIGHT_ATTRIBUTE);\n    }\n  }\n\n  registerElementWithId(element: Element, id: string) {\n    const arr = this.elementsById[id];\n    if (!arr) {\n      this.elementsById[id] = [element];\n    } else {\n      arr.push(element);\n    }\n  }\n\n  finish(triggers: Trigger[], clientLayout: ClientLayout): void {\n    // Remove ID of elements which eventually did not fit in the page\n    // (Some nodes may have been removed after registration if they did not fit\n    // in the page)\n    Object.keys(this.elementsById).forEach((id) => {\n      const elems = this.elementsById[id];\n      for (let i = 0; i < elems.length; ) {\n        if (this.container.contains(elems[i])) {\n          i++;\n        } else {\n          elems.splice(i, 1);\n        }\n      }\n      if (elems.length === 0) {\n        delete this.elementsById[id];\n      }\n    });\n    const list = this.delayedItems;\n    for (let i = 0; i < list.length; i++) {\n      const item = list[i];\n      if (\n        item.target === this.container &&\n        item.name === \"transform\" &&\n        !this.isAutoPageWidth &&\n        !this.isAutoPageHeight\n      ) {\n        // When fixed page size is specified, cancel the transform property\n        // set at OPFView.makePage() for the specified viewport size\n        // (e.g. `<meta name=\"viewport\" content=\"width=1307, height=1920\"/>`)\n        // to avoid wrong page resizing.\n        continue;\n      }\n      Base.setCSSProperty(item.target, item.name, item.value.toString());\n    }\n\n    // use size of the container of the PageMasterInstance\n    const rect = clientLayout.getElementClientRect(this.container);\n    this.dimensions.width = rect.width;\n    this.dimensions.height = rect.height;\n    for (let i = 0; i < triggers.length; i++) {\n      const trigger = triggers[i];\n      const refs = this.elementsById[trigger.ref];\n      const observers = this.elementsById[trigger.observer];\n      if (refs && observers) {\n        const listener = makeListener(refs, trigger.action);\n        if (listener) {\n          for (let k = 0; k < observers.length; k++) {\n            observers[k].addEventListener(trigger.event, listener, false);\n          }\n        }\n      }\n    }\n  }\n}\n\nexport type Spread = {\n  left: Page;\n  right: Page;\n};\n\nexport const Whitespace = Vtree.Whitespace;\nexport type Whitespace = Vtree.Whitespace; // eslint-disable-line no-redeclare\n\n/**\n * Resolves Whitespace value from a value of 'white-space' property\n * @param whitespace The value of 'white-space' property\n */\nexport function whitespaceFromPropertyValue(\n  whitespace: string,\n): Whitespace | null {\n  switch (whitespace) {\n    case \"normal\":\n    case \"nowrap\":\n      return Whitespace.IGNORE;\n    case \"pre-line\":\n      return Whitespace.NEWLINE;\n    case \"pre\":\n    case \"pre-wrap\":\n    case \"break-spaces\":\n      return Whitespace.PRESERVE;\n    default:\n      return null;\n  }\n}\n\nexport function canIgnore(node: Node, whitespace?: Whitespace): boolean {\n  if (!node) {\n    return true;\n  }\n  if (node.nodeType == 1) {\n    return false;\n  }\n  const text = node.textContent;\n  switch (whitespace) {\n    case Whitespace.PRESERVE:\n      return text.length == 0;\n    case Whitespace.NEWLINE:\n      return !!text.match(/^[ \\t]*$/);\n    case Whitespace.IGNORE:\n    default:\n      return !!text.match(/^[ \\t\\r\\n\\f]*$/);\n  }\n}\n\nexport class Flow {\n  forcedBreakOffsets = [] as number[];\n  formattingContext: FormattingContext | null = null;\n\n  constructor(\n    public readonly flowName: string,\n    public readonly parentFlowName: string | null,\n  ) {}\n}\n\nexport class FlowChunk {\n  startPage: number = -1;\n\n  constructor(\n    public flowName: string,\n    public element: Element,\n    public startOffset: number,\n    public priority: number,\n    public linger: number,\n    public exclusive: boolean,\n    public repeated: boolean,\n    public last: boolean,\n    public breakBefore: string | null,\n  ) {}\n\n  isBetter(other: FlowChunk): boolean {\n    if (!this.exclusive) {\n      return false;\n    }\n    if (!other.exclusive) {\n      return true;\n    }\n    if (this.priority > other.priority) {\n      return true;\n    }\n    return this.last;\n  }\n}\n\nexport type ClientRect = Vtree.ClientRect;\n\nexport function clientrectIncreasingTop(\n  r1: ClientRect,\n  r2: ClientRect,\n): number {\n  return r1.top - r2.top;\n}\n\nexport function clientrectDecreasingRight(\n  r1: ClientRect,\n  r2: ClientRect,\n): number {\n  return r2.right - r1.right;\n}\n\n/**\n * Interface to read the position assigned to the elements and ranges by the\n * browser.\n */\nexport type ClientLayout = Vtree.ClientLayout;\n\n/**\n * Styling, creating a single node's view, etc.\n */\nexport type LayoutContext = Vtree.LayoutContext;\n\n/**\n * Formatting context.\n */\nexport type FormattingContext = Vtree.FormattingContext;\n\nexport function eachAncestorFormattingContext(\n  nodeContext: NodeContext,\n  callback: (p1: FormattingContext) => any,\n): void {\n  if (!nodeContext) {\n    return;\n  }\n  for (let fc = nodeContext.formattingContext; fc; fc = fc.getParent()) {\n    callback(fc);\n  }\n}\n\nexport type NodePositionStep = Vtree.NodePositionStep;\n\nexport function isSameNodePositionStep(\n  nps1: NodePositionStep,\n  nps2: NodePositionStep,\n): boolean {\n  if (nps1 === nps2) {\n    return true;\n  }\n  if (!nps1 || !nps2) {\n    return false;\n  }\n  return (\n    (nps1.node === nps2.node ||\n      // Fix for issue #869\n      (!!nps1.shadowContext &&\n        !!nps2.shadowContext &&\n        nps1.shadowType === Vtree.ShadowType.ROOTLESS &&\n        nps2.shadowType === Vtree.ShadowType.ROOTLESS &&\n        (nps1.node as Element)?.outerHTML ===\n          (nps2.node as Element)?.outerHTML)) &&\n    nps1.shadowType === nps2.shadowType &&\n    isSameShadowContext(nps1.shadowContext, nps2.shadowContext) &&\n    isSameShadowContext(nps1.nodeShadow, nps2.nodeShadow) &&\n    isSameNodePositionStep(nps1.shadowSibling, nps2.shadowSibling)\n  );\n}\n\nexport type NodePosition = Vtree.NodePosition;\n\nexport function isSameNodePosition(\n  np1: NodePosition | null,\n  np2: NodePosition | null,\n): boolean {\n  if (np1 === np2) {\n    return true;\n  }\n  if (!np1 || !np2) {\n    return false;\n  }\n  if (\n    np1.offsetInNode !== np2.offsetInNode ||\n    np1.after !== np2.after ||\n    np1.steps.length !== np2.steps.length\n  ) {\n    return false;\n  }\n  for (let i = 0; i < np1.steps.length; i++) {\n    if (!isSameNodePositionStep(np1.steps[i], np2.steps[i])) {\n      return false;\n    }\n  }\n  return true;\n}\n\nexport function newNodePositionFromNode(node: Node): NodePosition {\n  const step: NodePositionStep = {\n    node,\n    shadowType: ShadowType.NONE,\n    shadowContext: null,\n    nodeShadow: null,\n    shadowSibling: null,\n    formattingContext: null,\n    fragmentIndex: 0,\n  };\n  return {\n    steps: [step],\n    offsetInNode: 0,\n    after: false,\n    preprocessedTextContent: null,\n  };\n}\n\nexport function newNodePositionFromNodeContext(\n  nodeContext: Vtree.NodeContext,\n  initialFragmentIndex: number | null,\n): NodePosition {\n  const step: NodePositionStep = {\n    node: nodeContext.sourceNode,\n    shadowType: ShadowType.NONE,\n    shadowContext: nodeContext.shadowContext,\n    nodeShadow: null,\n    shadowSibling: null,\n    formattingContext: null,\n    fragmentIndex:\n      initialFragmentIndex != null\n        ? initialFragmentIndex\n        : nodeContext.fragmentIndex,\n  };\n  return {\n    steps: [step],\n    offsetInNode: 0,\n    after: false,\n    preprocessedTextContent: nodeContext.preprocessedTextContent,\n  };\n}\n\nexport function makeNodeContextFromNodePositionStep(\n  step: NodePositionStep,\n  parent: Vtree.NodeContext,\n): NodeContext {\n  const nodeContext = new NodeContext(step.node, parent as NodeContext, 0);\n  nodeContext.shadowType = step.shadowType;\n  nodeContext.shadowContext = step.shadowContext;\n  nodeContext.nodeShadow = step.nodeShadow;\n  nodeContext.shadowSibling = step.shadowSibling\n    ? makeNodeContextFromNodePositionStep(step.shadowSibling, parent.copy())\n    : null;\n  nodeContext.formattingContext = step.formattingContext;\n  nodeContext.fragmentIndex = step.fragmentIndex + 1;\n  return nodeContext;\n}\n\nexport const ShadowType = Vtree.ShadowType;\nexport type ShadowType = Vtree.ShadowType; // eslint-disable-line no-redeclare\n\n/**\n * Data about shadow tree instance.\n */\nexport class ShadowContext implements Vtree.ShadowContext {\n  subShadow: ShadowContext = null;\n\n  constructor(\n    public readonly owner: Element,\n    public readonly root: Element,\n    public readonly xmldoc: XmlDoc.XMLDocHolder,\n    public readonly parentShadow: ShadowContext,\n    superShadow: ShadowContext,\n    public readonly type: ShadowType,\n    public readonly styler: CssStyler.AbstractStyler,\n  ) {\n    if (superShadow) {\n      superShadow.subShadow = this;\n    }\n  }\n\n  equals(other: ShadowContext): boolean {\n    if (!other) {\n      return false;\n    }\n    return (\n      this.owner === other.owner &&\n      this.xmldoc === other.xmldoc &&\n      this.type === other.type &&\n      isSameShadowContext(this.parentShadow, other.parentShadow)\n    );\n  }\n}\n\nexport function isSameShadowContext(\n  sc1: Vtree.ShadowContext,\n  sc2: Vtree.ShadowContext,\n): boolean {\n  return sc1 === sc2 || (!!sc1 && !!sc2 && sc1.equals(sc2));\n}\n\n/**\n * Information about :first-letter or :first-line pseudoelements\n * @param count 0 - first-letter, 1 or more - first line(s)\n */\nexport class FirstPseudo implements Vtree.FirstPseudo {\n  constructor(\n    public readonly outer: FirstPseudo,\n    public readonly count: number,\n  ) {}\n}\n\n/**\n * NodeContext represents a position in the document + layout-related\n * information attached to it. When after=false and offsetInNode=0, the\n * position is inside the element (node), but just before its first child.\n * When offsetInNode>0 it represents offset in the textual content of the\n * node. When after=true it represents position right after the last child\n * of the node. boxOffset is incremented by 1 for any valid node position.\n */\nexport class NodeContext implements Vtree.NodeContext {\n  // position itself\n  offsetInNode: number = 0;\n  after: boolean = false;\n  shadowType: ShadowType;\n\n  // parent's shadow type\n  shadowContext: Vtree.ShadowContext;\n  nodeShadow: Vtree.ShadowContext = null;\n  shadowSibling: NodeContext = null;\n\n  // next \"sibling\" in the shadow tree\n  // other stuff\n  shared: boolean = false;\n  inline: boolean = true;\n  overflow: boolean = false;\n  breakPenalty: number;\n  display: string | null = null;\n  floatReference: PageFloats.FloatReference;\n  floatSide: string | null = null;\n  clearSide: string | null = null;\n  floatMinWrapBlock: Css.Numeric | null = null;\n  columnSpan: Css.Val | null = null;\n  verticalAlign: string = \"baseline\";\n  captionSide: string = \"top\";\n  inlineBorderSpacing: number = 0;\n  blockBorderSpacing: number = 0;\n  flexContainer: boolean = false;\n  whitespace: Whitespace;\n  hyphenateCharacter: string | null;\n  breakWord: boolean;\n  establishesBFC: boolean = false;\n  containingBlockForAbsolute: boolean = false;\n  breakBefore: string | null = null;\n  breakAfter: string | null = null;\n  viewNode: Node = null;\n  clearSpacer: Node = null;\n  inheritedProps: { [key: string]: number | string | Css.Val };\n  vertical: boolean;\n  direction: string;\n  firstPseudo: FirstPseudo;\n  lang: string | null = null;\n  preprocessedTextContent: Diff.Change[] | null = null;\n  formattingContext: FormattingContext;\n  repeatOnBreak: string | null = null;\n  pluginProps: {\n    [key: string]: string | number | undefined | null | (number | null)[];\n  } = {};\n  fragmentIndex: number = 1;\n  afterIfContinues: Selectors.AfterIfContinues = null;\n  footnotePolicy: Css.Ident | null = null;\n  pageType: string | null;\n\n  constructor(\n    public sourceNode: Node,\n    public parent: NodeContext,\n    public boxOffset: number,\n  ) {\n    this.shadowType = ShadowType.NONE;\n    this.shadowContext = parent ? parent.shadowContext : null;\n    this.breakPenalty = parent ? parent.breakPenalty : 0;\n    this.floatReference = PageFloats.FloatReference.INLINE;\n    this.whitespace = parent ? parent.whitespace : Whitespace.IGNORE;\n    this.hyphenateCharacter = parent ? parent.hyphenateCharacter : null;\n    this.breakWord = parent ? parent.breakWord : false;\n    this.inheritedProps = parent ? parent.inheritedProps : {};\n    this.vertical = parent ? parent.vertical : false;\n    this.direction = parent ? parent.direction : \"ltr\";\n    this.firstPseudo = parent ? parent.firstPseudo : null;\n    this.formattingContext = parent ? parent.formattingContext : null;\n    this.pageType = parent ? parent.pageType : null;\n  }\n\n  resetView(): void {\n    this.inline = true;\n    this.breakPenalty = this.parent ? this.parent.breakPenalty : 0;\n    this.viewNode = null;\n    this.clearSpacer = null;\n    this.offsetInNode = 0;\n    this.after = false;\n    this.display = null;\n    this.floatReference = PageFloats.FloatReference.INLINE;\n    this.floatSide = null;\n    this.clearSide = null;\n    this.floatMinWrapBlock = null;\n    this.columnSpan = null;\n    this.verticalAlign = \"baseline\";\n    this.flexContainer = false;\n    this.whitespace = this.parent ? this.parent.whitespace : Whitespace.IGNORE;\n    this.hyphenateCharacter = this.parent\n      ? this.parent.hyphenateCharacter\n      : null;\n    this.breakWord = this.parent ? this.parent.breakWord : false;\n    this.breakBefore = null;\n    this.breakAfter = null;\n    this.nodeShadow = null;\n    this.establishesBFC = false;\n    this.containingBlockForAbsolute = false;\n    this.vertical = this.parent ? this.parent.vertical : false;\n    this.nodeShadow = null;\n    this.preprocessedTextContent = null;\n    this.formattingContext = this.parent ? this.parent.formattingContext : null;\n    this.repeatOnBreak = null;\n    this.pluginProps = {};\n    this.fragmentIndex = 1;\n    this.afterIfContinues = null;\n    this.footnotePolicy = null;\n  }\n\n  private cloneItem(): NodeContext {\n    const np = new NodeContext(this.sourceNode, this.parent, this.boxOffset);\n    np.offsetInNode = this.offsetInNode;\n    np.after = this.after;\n    np.nodeShadow = this.nodeShadow;\n    np.shadowType = this.shadowType;\n    np.shadowContext = this.shadowContext;\n    np.shadowSibling = this.shadowSibling;\n    np.inline = this.inline;\n    np.breakPenalty = this.breakPenalty;\n    np.display = this.display;\n    np.floatReference = this.floatReference;\n    np.floatSide = this.floatSide;\n    np.clearSide = this.clearSide;\n    np.floatMinWrapBlock = this.floatMinWrapBlock;\n    np.columnSpan = this.columnSpan;\n    np.verticalAlign = this.verticalAlign;\n    np.captionSide = this.captionSide;\n    np.inlineBorderSpacing = this.inlineBorderSpacing;\n    np.blockBorderSpacing = this.blockBorderSpacing;\n    np.establishesBFC = this.establishesBFC;\n    np.containingBlockForAbsolute = this.containingBlockForAbsolute;\n    np.flexContainer = this.flexContainer;\n    np.whitespace = this.whitespace;\n    np.hyphenateCharacter = this.hyphenateCharacter;\n    np.breakWord = this.breakWord;\n    np.breakBefore = this.breakBefore;\n    np.breakAfter = this.breakAfter;\n    np.viewNode = this.viewNode;\n    np.clearSpacer = this.clearSpacer;\n    np.firstPseudo = this.firstPseudo;\n    np.vertical = this.vertical;\n    np.overflow = this.overflow;\n    np.preprocessedTextContent = this.preprocessedTextContent;\n    np.formattingContext = this.formattingContext;\n    np.repeatOnBreak = this.repeatOnBreak;\n    np.pluginProps = Object.create(this.pluginProps);\n    np.fragmentIndex = this.fragmentIndex;\n    np.afterIfContinues = this.afterIfContinues;\n    np.footnotePolicy = this.footnotePolicy;\n    return np;\n  }\n\n  modify(): NodeContext {\n    if (!this.shared) {\n      return this;\n    }\n    return this.cloneItem();\n  }\n\n  copy(): NodeContext {\n    let np: NodeContext = this;\n    do {\n      if (np.shared) {\n        break;\n      }\n      np.shared = true;\n      np = np.parent;\n    } while (np);\n    return this;\n  }\n\n  clone(): NodeContext {\n    const np = this.cloneItem();\n    let npc = np;\n    let npp: NodeContext;\n    while ((npp = npc.parent) != null) {\n      npp = npp.cloneItem();\n      npc.parent = npp;\n      npc = npp;\n    }\n    return np;\n  }\n\n  toNodePositionStep(): NodePositionStep {\n    return {\n      node: this.sourceNode,\n      shadowType: this.shadowType,\n      shadowContext: this.shadowContext,\n      nodeShadow: this.nodeShadow,\n      shadowSibling: this.shadowSibling\n        ? this.shadowSibling.toNodePositionStep()\n        : null,\n      formattingContext: this.formattingContext,\n\n      // fragmentIndex needs to be reset to 0 if this viewNode has been removed\n      // from the view tree by forced break processing. (Issue #1557)\n      fragmentIndex:\n        this.viewNode?.parentNode === null ? 0 : this.fragmentIndex,\n    };\n  }\n\n  toNodePosition(): NodePosition {\n    let nc: NodeContext = this;\n    const steps = [];\n\n    // Fix for issue #703\n    if (\n      nc.shadowType === Vtree.ShadowType.ROOTLESS &&\n      (nc.floatReference !== PageFloats.FloatReference.INLINE ||\n        nc.floatSide === \"footnote\") &&\n      (nc.shadowContext?.styler as PseudoElement.PseudoelementStyler)?.style?.[\n        \"_pseudos\"\n      ]\n    ) {\n      nc = nc.parent;\n    }\n\n    do {\n      // We need fully \"peeled\" path, so don't record first-XXX pseudoelement\n      // containers\n      if (\n        !nc.firstPseudo ||\n        !nc.parent ||\n        nc.parent.firstPseudo === nc.firstPseudo\n      ) {\n        steps.push(nc.toNodePositionStep());\n      }\n      nc = nc.parent;\n    } while (nc);\n    const actualOffsetInNode = this.preprocessedTextContent\n      ? Diff.resolveOriginalIndex(\n          this.preprocessedTextContent,\n          this.offsetInNode,\n        )\n      : this.offsetInNode;\n    return {\n      steps,\n      offsetInNode: actualOffsetInNode,\n      after: this.after,\n      preprocessedTextContent: this.preprocessedTextContent,\n    };\n  }\n\n  isInsideBFC(): boolean {\n    let parent = this.parent;\n    while (parent) {\n      if (parent.establishesBFC) {\n        return true;\n      }\n      parent = parent.parent;\n    }\n    return false;\n  }\n\n  getContainingBlockForAbsolute(): NodeContext {\n    let parent = this.parent;\n    while (parent) {\n      if (parent.containingBlockForAbsolute) {\n        return parent;\n      }\n      parent = parent.parent;\n    }\n    return null;\n  }\n\n  belongsTo(formattingContext: FormattingContext): boolean {\n    return (\n      this.formattingContext === formattingContext &&\n      !!this.parent &&\n      this.parent.formattingContext === formattingContext\n    );\n  }\n}\n\nexport class ChunkPosition implements Vtree.ChunkPosition {\n  floats: NodePosition[] = null;\n\n  constructor(public primary: NodePosition) {}\n\n  clone(): ChunkPosition {\n    const result = new ChunkPosition(this.primary);\n    if (this.floats) {\n      result.floats = [];\n      for (let i = 0; i < this.floats.length; ++i) {\n        result.floats[i] = this.floats[i];\n      }\n    }\n    return result;\n  }\n\n  isSamePosition(other: ChunkPosition): boolean {\n    if (!other) {\n      return false;\n    }\n    if (this === other) {\n      return true;\n    }\n    if (!isSameNodePosition(this.primary, other.primary)) {\n      return false;\n    }\n    if (this.floats) {\n      if (!other.floats || this.floats.length !== other.floats.length) {\n        return false;\n      }\n      for (let i = 0; i < this.floats.length; i++) {\n        if (!isSameNodePosition(this.floats[i], other.floats[i])) {\n          return false;\n        }\n      }\n    } else if (other.floats) {\n      return false;\n    }\n    return true;\n  }\n}\n\nexport class FlowChunkPosition {\n  constructor(\n    public chunkPosition: ChunkPosition,\n    public readonly flowChunk: FlowChunk,\n  ) {}\n\n  clone(): FlowChunkPosition {\n    return new FlowChunkPosition(this.chunkPosition.clone(), this.flowChunk);\n  }\n\n  isSamePosition(other: FlowChunkPosition): boolean {\n    return (\n      !!other &&\n      (this === other || this.chunkPosition.isSamePosition(other.chunkPosition))\n    );\n  }\n}\n\nexport class FlowPosition {\n  positions: FlowChunkPosition[] = [];\n  startBreakType: string | null = null;\n  breakAfter: string | null = null;\n\n  clone(): FlowPosition {\n    const newfp = new FlowPosition();\n    const arr = this.positions;\n    const newarr = newfp.positions;\n    for (let i = 0; i < arr.length; i++) {\n      newarr[i] = arr[i].clone();\n    }\n    newfp.startBreakType = this.startBreakType;\n    newfp.breakAfter = this.breakAfter;\n    return newfp;\n  }\n\n  isSamePosition(other: FlowPosition): boolean {\n    if (this === other) {\n      return true;\n    }\n    if (!other || this.positions.length !== other.positions.length) {\n      return false;\n    }\n    for (let i = 0; i < this.positions.length; i++) {\n      if (!this.positions[i].isSamePosition(other.positions[i])) {\n        return false;\n      }\n    }\n    return true;\n  }\n\n  hasContent(offset: number): boolean {\n    return (\n      this.positions.length > 0 &&\n      this.positions[0].flowChunk.startOffset <= offset\n    );\n  }\n}\n\nexport class LayoutPosition {\n  /**\n   * One-based, incremented before layout.\n   */\n  page: number = 0;\n  flows: { [key: string]: Flow } = {};\n  flowPositions: { [key: string]: FlowPosition } = {};\n  isBlankPage: boolean = false;\n\n  /**\n   * flowPositions is built up to this offset.\n   */\n  highestSeenOffset: number = 0;\n\n  // FIXME: This properties seem to be not used\n  highestSeenNode: Node;\n  lookupPositionOffset: number;\n\n  clone(): LayoutPosition {\n    const newcp = new LayoutPosition();\n    newcp.page = this.page;\n    newcp.isBlankPage = this.isBlankPage;\n    newcp.highestSeenNode = this.highestSeenNode;\n    newcp.highestSeenOffset = this.highestSeenOffset;\n    newcp.lookupPositionOffset = this.lookupPositionOffset;\n    newcp.flows = this.flows;\n    for (const name in this.flowPositions) {\n      newcp.flowPositions[name] = this.flowPositions[name].clone();\n    }\n    return newcp;\n  }\n\n  isSamePosition(other: LayoutPosition): boolean {\n    if (this === other) {\n      return true;\n    }\n    if (\n      !other ||\n      this.page !== other.page\n      // Removed:\n      //   || this.highestSeenOffset !== other.highestSeenOffset\n      // to prevent unnecessary re-layout (Issue #681-case2)\n    ) {\n      return false;\n    }\n    const thisFlowNames = Object.keys(this.flowPositions);\n    const otherFlowNames = Object.keys(other.flowPositions);\n    if (thisFlowNames.length !== otherFlowNames.length) {\n      return false;\n    }\n    for (const flowName of thisFlowNames) {\n      if (\n        !this.flowPositions[flowName].isSamePosition(\n          other.flowPositions[flowName],\n        )\n      ) {\n        return false;\n      }\n    }\n    return true;\n  }\n\n  /**\n   * @param name flow name.\n   */\n  hasContent(name: string, offset: number): boolean {\n    const flowPos = this.flowPositions[name];\n    if (!flowPos) {\n      return false;\n    }\n    return flowPos.hasContent(offset);\n  }\n\n  startSideOfFlow(name: string): string {\n    const startBreakType = this.flowPositions[name]?.startBreakType;\n    return startBreakType && Break.isSpreadBreakValue(startBreakType)\n      ? startBreakType\n      : \"any\";\n  }\n\n  firstFlowChunkOfFlow(name: string): FlowChunk | null {\n    const flowPos = this.flowPositions[name];\n    if (!flowPos) {\n      return null;\n    }\n    const flowChunkPosition = flowPos.positions[0];\n    if (!flowChunkPosition) {\n      return null;\n    }\n    return flowChunkPosition.flowChunk;\n  }\n}\n\nexport class Container implements Vtree.Container {\n  left: number = 0;\n  top: number = 0;\n  marginLeft: number = 0;\n  marginRight: number = 0;\n  marginTop: number = 0;\n  marginBottom: number = 0;\n  borderLeft: number = 0;\n  borderRight: number = 0;\n  borderTop: number = 0;\n  borderBottom: number = 0;\n  paddingLeft: number = 0;\n  paddingRight: number = 0;\n  paddingTop: number = 0;\n  paddingBottom: number = 0;\n  width: number = 0;\n  height: number = 0;\n  originX: number = 0;\n  originY: number = 0;\n  exclusions: GeometryUtil.Shape[] = null;\n  innerShape: GeometryUtil.Shape = null;\n  computedBlockSize: number = 0;\n  snapWidth: number = 0;\n  snapHeight: number = 0;\n  snapOffsetX: number = 0;\n  snapOffsetY: number = 0;\n  vertical: boolean = false; // vertical writing\n  rtl: boolean = false;\n  borderBoxSizing: boolean = false;\n\n  constructor(public element: HTMLElement) {}\n\n  getInsetTop() {\n    return (\n      this.marginTop +\n      (this.borderBoxSizing ? 0 : this.borderTop + this.paddingTop)\n    );\n  }\n\n  getInsetBottom() {\n    return (\n      this.marginBottom +\n      (this.borderBoxSizing ? 0 : this.borderBottom + this.paddingBottom)\n    );\n  }\n\n  getInsetLeft() {\n    return (\n      this.marginLeft +\n      (this.borderBoxSizing ? 0 : this.borderLeft + this.paddingLeft)\n    );\n  }\n\n  getInsetRight() {\n    return (\n      this.marginRight +\n      (this.borderBoxSizing ? 0 : this.borderRight + this.paddingRight)\n    );\n  }\n\n  getInsetBefore() {\n    if (this.vertical) {\n      return this.getInsetRight();\n    } else {\n      return this.getInsetTop();\n    }\n  }\n\n  getInsetAfter() {\n    if (this.vertical) {\n      return this.getInsetLeft();\n    } else {\n      return this.getInsetBottom();\n    }\n  }\n\n  getInsetStart() {\n    if (this.vertical) {\n      return this.getInsetTop();\n    } else {\n      return this.getInsetLeft();\n    }\n  }\n\n  getInsetEnd() {\n    if (this.vertical) {\n      return this.getInsetBottom();\n    } else {\n      return this.getInsetRight();\n    }\n  }\n\n  getBeforeEdge(box: ClientRect): number {\n    return this.vertical ? box.right : box.top;\n  }\n\n  getAfterEdge(box: ClientRect): number {\n    return this.vertical ? box.left : box.bottom;\n  }\n\n  getStartEdge(box: ClientRect): number {\n    return this.vertical\n      ? this.rtl\n        ? box.bottom\n        : box.top\n      : this.rtl\n        ? box.right\n        : box.left;\n  }\n\n  getEndEdge(box: ClientRect): number {\n    return this.vertical\n      ? this.rtl\n        ? box.top\n        : box.bottom\n      : this.rtl\n        ? box.left\n        : box.right;\n  }\n\n  getInlineSize(box: ClientRect): number {\n    return this.vertical ? box.bottom - box.top : box.right - box.left;\n  }\n\n  getBoxSize(box: ClientRect): number {\n    return this.vertical ? box.right - box.left : box.bottom - box.top;\n  }\n\n  getBoxDir(): number {\n    return this.vertical ? -1 : 1;\n  }\n\n  getInlineDir(): number {\n    return this.rtl ? -1 : 1;\n  }\n\n  copyFrom(other: Container): void {\n    this.element = other.element;\n    this.left = other.left;\n    this.top = other.top;\n    this.marginLeft = other.marginLeft;\n    this.marginRight = other.marginRight;\n    this.marginTop = other.marginTop;\n    this.marginBottom = other.marginBottom;\n    this.borderLeft = other.borderLeft;\n    this.borderRight = other.borderRight;\n    this.borderTop = other.borderTop;\n    this.borderBottom = other.borderBottom;\n    this.paddingLeft = other.paddingLeft;\n    this.paddingRight = other.paddingRight;\n    this.paddingTop = other.paddingTop;\n    this.paddingBottom = other.paddingBottom;\n    this.width = other.width;\n    this.height = other.height;\n    this.originX = other.originX;\n    this.originY = other.originY;\n    this.innerShape = other.innerShape;\n    this.exclusions = other.exclusions;\n    this.computedBlockSize = other.computedBlockSize;\n    this.snapWidth = other.snapWidth;\n    this.snapHeight = other.snapHeight;\n    this.vertical = other.vertical;\n    this.rtl = other.rtl;\n    this.borderBoxSizing = other.borderBoxSizing;\n  }\n\n  setVerticalPosition(top: number, height: number): void {\n    this.top = top;\n    this.height = height;\n    Base.setCSSProperty(this.element, \"top\", `${top}px`);\n    Base.setCSSProperty(this.element, \"height\", `${height}px`);\n  }\n\n  setHorizontalPosition(left: number, width: number): void {\n    this.left = left;\n    this.width = width;\n    Base.setCSSProperty(this.element, \"left\", `${left}px`);\n    Base.setCSSProperty(this.element, \"width\", `${width}px`);\n  }\n\n  setBlockPosition(start: number, extent: number): void {\n    if (this.vertical) {\n      const outerExtent =\n        extent +\n        this.marginLeft +\n        this.marginRight +\n        (this.borderBoxSizing\n          ? 0\n          : this.paddingLeft +\n            this.paddingRight +\n            this.borderLeft +\n            this.borderRight);\n      this.setHorizontalPosition(\n        start + outerExtent * this.getBoxDir(),\n        extent,\n      );\n    } else {\n      this.setVerticalPosition(start, extent);\n    }\n  }\n\n  setInlinePosition(start: number, extent: number): void {\n    if (this.vertical) {\n      if (this.rtl) {\n        const outerExtent =\n          extent +\n          this.marginTop +\n          this.marginBottom +\n          (this.borderBoxSizing\n            ? 0\n            : this.paddingTop +\n              this.paddingBottom +\n              this.borderTop +\n              this.borderBottom);\n        this.setVerticalPosition(\n          start + outerExtent * this.getInlineDir(),\n          extent,\n        );\n      } else {\n        this.setVerticalPosition(start, extent);\n      }\n    } else if (this.rtl) {\n      const outerExtent =\n        extent +\n        this.marginLeft +\n        this.marginRight +\n        (this.borderBoxSizing\n          ? 0\n          : this.paddingLeft +\n            this.paddingRight +\n            this.borderLeft +\n            this.borderRight);\n      this.setHorizontalPosition(\n        start + outerExtent * this.getInlineDir(),\n        extent,\n      );\n    } else {\n      this.setHorizontalPosition(start, extent);\n    }\n  }\n\n  clear() {\n    const parent = this.element;\n    let c: Node;\n    while ((c = parent.lastChild)) {\n      parent.removeChild(c);\n    }\n  }\n\n  getInnerShape(): GeometryUtil.Shape {\n    const rect = this.getInnerRect();\n    if (this.innerShape) {\n      return this.innerShape.withOffset(rect.x1, rect.y1);\n    }\n    return GeometryUtil.shapeForRect(rect.x1, rect.y1, rect.x2, rect.y2);\n  }\n\n  getInnerRect(): GeometryUtil.Rect {\n    const offsetX = this.originX + this.left + this.getInsetLeft();\n    const offsetY = this.originY + this.top + this.getInsetTop();\n    return new GeometryUtil.Rect(\n      offsetX,\n      offsetY,\n      offsetX + this.width,\n      offsetY + this.height,\n    );\n  }\n\n  getPaddingRect(): GeometryUtil.Rect {\n    const paddingX =\n      this.originX + this.left + this.marginLeft + this.borderLeft;\n    const paddingY = this.originY + this.top + this.marginTop + this.borderTop;\n    const paddingWidth = this.paddingLeft + this.width + this.paddingRight;\n    const paddingHeight = this.paddingTop + this.height + this.paddingBottom;\n    return new GeometryUtil.Rect(\n      paddingX,\n      paddingY,\n      paddingX + paddingWidth,\n      paddingY + paddingHeight,\n    );\n  }\n\n  getOuterShape(\n    outerShapeProp: Css.Val,\n    context: Exprs.Context,\n  ): GeometryUtil.Shape {\n    const rect = this.getOuterRect();\n    return CssProp.toShape(\n      outerShapeProp,\n      rect.x1,\n      rect.y1,\n      rect.x2 - rect.x1,\n      rect.y2 - rect.y1,\n      context,\n    );\n  }\n\n  getOuterRect(): GeometryUtil.Rect {\n    const outerX = this.originX + this.left;\n    const outerY = this.originY + this.top;\n    const outerWidth = this.getInsetLeft() + this.width + this.getInsetRight();\n    const outerHeight =\n      this.getInsetTop() + this.height + this.getInsetBottom();\n    return new GeometryUtil.Rect(\n      outerX,\n      outerY,\n      outerX + outerWidth,\n      outerY + outerHeight,\n    );\n  }\n}\n\nexport type ExprContentListener = Vtree.ExprContentListener;\n\nexport class ContentPropertyHandler extends Css.Visitor {\n  constructor(\n    public readonly elem: Element,\n    public readonly context: Exprs.Context,\n    public readonly rootContentValue: Css.Val,\n    public readonly exprContentListener: ExprContentListener,\n  ) {\n    super();\n  }\n\n  private visitStrInner(str: string, node?: Node | null) {\n    if (!node) {\n      if (this.elem.lastChild?.nodeType === 3) {\n        this.elem.lastChild.textContent += str;\n        return;\n      }\n      node = this.elem.ownerDocument.createTextNode(str);\n    }\n    this.elem.appendChild(node);\n  }\n\n  override visitStr(str: Css.Str): Css.Val {\n    this.visitStrInner(str.str);\n    return null;\n  }\n\n  override visitURL(url: Css.URL): Css.Val {\n    if (this.rootContentValue instanceof Css.URL) {\n      this.elem.setAttribute(\"src\", url.url);\n    } else {\n      const img = this.elem.ownerDocument.createElementNS(Base.NS.XHTML, \"img\");\n      img.setAttribute(\"src\", url.url);\n      this.elem.appendChild(img);\n    }\n    return null;\n  }\n\n  override visitSpaceList(list: Css.SpaceList): Css.Val {\n    this.visitValues(list.values);\n    return null;\n  }\n\n  override visitExpr(expr: Css.Expr): Css.Val {\n    const ex = expr.toExpr();\n    let val = ex.evaluate(this.context);\n    if (typeof val === \"string\") {\n      if (ex instanceof Exprs.Named) {\n        // For env(pub-title) and env(doc-title)\n        // Need to unquote the result. To be consistent with cssparse.evaluateExprToCSS()\n        val = CssParser.parseValue(\n          ex.scope,\n          new CssTokenizer.Tokenizer(val, null),\n          \"\",\n        ).stringValue();\n      }\n      assert(this.elem.ownerDocument);\n      const node = this.exprContentListener(ex, val, this.elem.ownerDocument);\n      if (\n        !node &&\n        val &&\n        ex instanceof Exprs.Native &&\n        ex.str.startsWith(\"running-element-\")\n      ) {\n        // Prevent wrong running element output when the element is not found (Issue #1196)\n        val = \"\";\n      }\n      this.visitStrInner(val, node);\n    }\n    return null;\n  }\n}\n\nexport function nonTrivialContent(val: Css.Val | null | undefined): boolean {\n  return (\n    val != null &&\n    val !== Css.empty &&\n    val !== Css.ident.normal &&\n    val !== Css.ident.none &&\n    !Css.isDefaultingValue(val)\n  );\n}\n", "/**\n * Copyright 2015 Daishinsha Inc.\n * Copyright 2019 Vivliostyle Foundation\n *\n * Vivliostyle.js is free software: you can redistribute it and/or modify\n * it under the terms of the GNU Affero General Public License as published by\n * the Free Software Foundation, either version 3 of the License, or\n * (at your option) any later version.\n *\n * Vivliostyle.js is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n * GNU Affero General Public License for more details.\n *\n * You should have received a copy of the GNU Affero General Public License\n * along with Vivliostyle.js.  If not, see <http://www.gnu.org/licenses/>.\n *\n * @fileoverview PageFloats - CSS Page Floats\n */\nimport * as Asserts from \"./asserts\";\nimport * as Css from \"./css\";\nimport * as Constants from \"./constants\";\nimport * as GeometryUtil from \"./geometry-util\";\nimport * as Logging from \"./logging\";\nimport * as CssLogicalUtil from \"./css-logical-util\";\nimport * as Sizing from \"./sizing\";\nimport * as Task from \"./task\";\nimport * as VtreeImpl from \"./vtree\";\nimport { Layout as LayoutType, PageFloats, Vtree } from \"./types\";\n\nexport const FloatReference = PageFloats.FloatReference;\nexport type FloatReference = PageFloats.FloatReference; // eslint-disable-line no-redeclare\n\ntype PageFloatID = PageFloats.PageFloatID;\n\nexport function floatReferenceOf(str: string): FloatReference {\n  switch (str) {\n    case \"inline\":\n      return FloatReference.INLINE;\n    case \"column\":\n      return FloatReference.COLUMN;\n    case \"region\":\n      return FloatReference.REGION;\n    case \"page\":\n      return FloatReference.PAGE;\n    default:\n      throw new Error(`Unknown float-reference: ${str}`);\n  }\n}\n\nexport function isPageFloat(floatReference: FloatReference): boolean {\n  switch (floatReference) {\n    case FloatReference.INLINE:\n      return false;\n    case FloatReference.COLUMN:\n    case FloatReference.REGION:\n    case FloatReference.PAGE:\n      return true;\n    default:\n      throw new Error(`Unknown float-reference: ${floatReference}`);\n  }\n}\n\n/**\n * Interpret a float value with the writing-mode and direction assuming the\n * float-reference is inline and returns \"left\" or \"right\".\n */\nexport function resolveInlineFloatDirection(\n  floatSide: string,\n  vertical: boolean,\n  direction: string,\n  pageSide: Constants.PageSide,\n): string {\n  const writingMode = vertical ? \"vertical-rl\" : \"horizontal-tb\";\n  if (floatSide === \"top\" || floatSide === \"bottom\") {\n    floatSide = CssLogicalUtil.toLogical(floatSide, writingMode, direction);\n  }\n  if (floatSide === \"block-start\") {\n    floatSide = \"inline-start\";\n  }\n  if (floatSide === \"block-end\") {\n    floatSide = \"inline-end\";\n  }\n  if (floatSide === \"inline-start\" || floatSide === \"inline-end\") {\n    const physicalValue = CssLogicalUtil.toPhysical(\n      floatSide,\n      writingMode,\n      direction,\n    );\n    const lineRelativeValue = CssLogicalUtil.toLineRelative(\n      physicalValue,\n      writingMode,\n    );\n    if (lineRelativeValue === \"line-left\") {\n      floatSide = \"left\";\n    } else if (lineRelativeValue === \"line-right\") {\n      floatSide = \"right\";\n    }\n  } else if (floatSide === \"inside\") {\n    floatSide = pageSide === \"left\" ? \"right\" : \"left\";\n  } else if (floatSide === \"outside\") {\n    floatSide = pageSide === \"left\" ? \"left\" : \"right\";\n  }\n  if (floatSide !== \"left\" && floatSide !== \"right\") {\n    Logging.logger.warn(`Invalid float value: ${floatSide}. Fallback to left.`);\n    floatSide = \"left\";\n  }\n  return floatSide;\n}\n\nexport class PageFloat implements PageFloats.PageFloat {\n  order: number | null = null;\n  id: PageFloatID | null = null;\n\n  constructor(\n    public readonly nodePosition: Vtree.NodePosition,\n    public readonly floatReference: FloatReference,\n    public readonly floatSide: string,\n    public readonly clearSide: string | null,\n    public readonly flowName: string,\n    public readonly floatMinWrapBlock: Css.Numeric | null,\n  ) {}\n\n  getOrder(): number {\n    if (this.order === null) {\n      throw new Error(\"The page float is not yet added\");\n    }\n    return this.order;\n  }\n\n  getId(): PageFloatID {\n    if (!this.id) {\n      throw new Error(\"The page float is not yet added\");\n    }\n    return this.id;\n  }\n\n  isAllowedOnContext(pageFloatLayoutContext: PageFloatLayoutContext): boolean {\n    return pageFloatLayoutContext.isAnchorAlreadyAppeared(this.getId());\n  }\n\n  isAllowedToPrecede(other: PageFloat): boolean {\n    return false;\n  }\n}\n\nexport class PageFloatStore {\n  private floats: PageFloat[] = [];\n  private nextPageFloatIndex: number = 0;\n\n  private nextOrder(): number {\n    return this.nextPageFloatIndex++;\n  }\n\n  private createPageFloatId(order: number): PageFloatID {\n    return `pf${order}`;\n  }\n\n  addPageFloat(float: PageFloat) {\n    const index = this.floats.findIndex((f) =>\n      VtreeImpl.isSameNodePosition(f.nodePosition, float.nodePosition),\n    );\n    if (index >= 0) {\n      throw new Error(\n        \"A page float with the same source node is already registered\",\n      );\n    } else {\n      const order = (float.order = this.nextOrder());\n      float.id = this.createPageFloatId(order);\n      this.floats.push(float);\n    }\n  }\n\n  findPageFloatByNodePosition(\n    nodePosition: Vtree.NodePosition,\n  ): PageFloat | null {\n    const index = this.floats.findIndex((f) =>\n      VtreeImpl.isSameNodePosition(f.nodePosition, nodePosition),\n    );\n    return index >= 0 ? this.floats[index] : null;\n  }\n\n  findPageFloatById(id: PageFloatID) {\n    const index = this.floats.findIndex((f) => f.id === id);\n    return index >= 0 ? this.floats[index] : null;\n  }\n}\n\n/**\n * @param continues Represents whether the float is fragmented and continues\n *     after this fragment\n */\nexport class PageFloatFragment implements PageFloats.PageFloatFragment {\n  constructor(\n    public readonly floatReference: FloatReference,\n    public readonly floatSide: string,\n    public readonly clearSide: string | null,\n    public readonly continuations: PageFloatContinuation[],\n    public readonly area: Vtree.Container,\n    public readonly continues: boolean,\n  ) {}\n\n  hasFloat(float: PageFloat): boolean {\n    return this.continuations.some((c) => c.float === float);\n  }\n\n  findNotAllowedFloat(context: PageFloatLayoutContext): PageFloat | null {\n    for (let i = this.continuations.length - 1; i >= 0; i--) {\n      const f = this.continuations[i].float;\n      if (!f.isAllowedOnContext(context)) {\n        return f;\n      }\n    }\n    return null;\n  }\n\n  getOuterShape(): GeometryUtil.Shape {\n    return this.area.getOuterShape(null, null);\n  }\n\n  getOuterRect(): GeometryUtil.Rect {\n    return this.area.getOuterRect();\n  }\n\n  getOrder(): number {\n    const floats = this.continuations.map((c) => c.float);\n    return Math.min.apply(\n      null,\n      floats.map((f) => f.getOrder()),\n    );\n  }\n\n  shouldBeStashedBefore(float: PageFloat): boolean {\n    return this.getOrder() < float.getOrder();\n  }\n\n  addContinuations(continuations: PageFloatContinuation[]) {\n    continuations.forEach((c) => {\n      this.continuations.push(c);\n    });\n  }\n\n  getFlowName(): string {\n    const flowName = this.continuations[0].float.flowName;\n    Asserts.assert(\n      this.continuations.every((c) => c.float.flowName === flowName),\n    );\n    return flowName;\n  }\n}\n\nexport class PageFloatContinuation implements PageFloats.PageFloatContinuation {\n  constructor(\n    public readonly float: PageFloat,\n    public readonly nodePosition: Vtree.NodePosition,\n  ) {}\n\n  equals(other: PageFloatContinuation | null): boolean {\n    if (!other) {\n      return false;\n    }\n    if (this === other) {\n      return true;\n    }\n    return (\n      this.float === other.float &&\n      VtreeImpl.isSameNodePosition(this.nodePosition, other.nodePosition)\n    );\n  }\n}\n\nexport type PageFloatPlacementCondition =\n  PageFloats.PageFloatPlacementCondition;\n\n/**\n * @param generatingNodePosition Source NodePosition generating the context.\n *     Specify when a column context is generated by a non-root element (for\n *     example page floats)\n */\nexport class PageFloatLayoutContext\n  implements PageFloats.PageFloatLayoutContext\n{\n  private children: PageFloatLayoutContext[] = [];\n  writingMode: Css.Val;\n  direction: Css.Val;\n  private invalidated: boolean = false;\n  private floatStore: PageFloatStore;\n  private forbiddenFloats: PageFloatID[] = [];\n  floatFragments: PageFloatFragment[] = [];\n  private stashedFloatFragments: PageFloatFragment[] = [];\n  private floatAnchors: { [key in PageFloatID]: Node } = {};\n  private floatsDeferredToNext: PageFloatContinuation[] = [];\n  private floatsDeferredFromPrevious: PageFloatContinuation[];\n  private layoutConstraints: LayoutType.LayoutConstraint[] = [];\n  private locked: boolean = false;\n\n  constructor(\n    public readonly parent: PageFloatLayoutContext,\n    private readonly floatReference: FloatReference | null,\n    private container: Vtree.Container,\n    public readonly flowName: string | null,\n    public readonly generatingNodePosition: Vtree.NodePosition | null,\n    writingMode: Css.Val | null,\n    direction: Css.Val | null,\n  ) {\n    if (parent) {\n      parent.children.push(this);\n    }\n    this.writingMode =\n      writingMode || (parent && parent.writingMode) || Css.ident.horizontal_tb;\n    this.direction = direction || (parent && parent.direction) || Css.ident.ltr;\n    this.floatStore = parent ? parent.floatStore : new PageFloatStore();\n    const previousSibling = this.getPreviousSibling();\n    this.floatsDeferredFromPrevious = previousSibling\n      ? [].concat(previousSibling.floatsDeferredToNext)\n      : [];\n  }\n\n  private getParent(floatReference: FloatReference): PageFloatLayoutContext {\n    if (!this.parent) {\n      throw new Error(`No PageFloatLayoutContext for ${floatReference}`);\n    }\n    return this.parent;\n  }\n\n  private getPreviousSiblingOf(\n    child: PageFloatLayoutContext | null,\n    floatReference: FloatReference | null,\n    flowName: string | null,\n    generatingNodePosition: Vtree.NodePosition | null,\n  ): PageFloatLayoutContext | null {\n    let index = this.children.indexOf(child as PageFloatLayoutContext);\n    if (index < 0) {\n      index = this.children.length;\n    }\n    for (let i = index - 1; i >= 0; i--) {\n      let result = this.children[i];\n      if (\n        result.floatReference === floatReference &&\n        result.flowName === flowName &&\n        VtreeImpl.isSameNodePosition(\n          result.generatingNodePosition,\n          generatingNodePosition,\n        )\n      ) {\n        return result;\n      } else {\n        result = result.getPreviousSiblingOf(\n          null,\n          floatReference,\n          flowName,\n          generatingNodePosition,\n        );\n        if (result) {\n          return result;\n        }\n      }\n    }\n    return null;\n  }\n\n  private getPreviousSibling(): PageFloatLayoutContext | null {\n    let child: PageFloatLayoutContext = this;\n    let parent = this.parent;\n    let result: PageFloatLayoutContext;\n    while (parent) {\n      result = parent.getPreviousSiblingOf(\n        child,\n        this.floatReference,\n        this.flowName,\n        this.generatingNodePosition,\n      );\n      if (result) {\n        return result;\n      }\n      child = parent;\n      parent = parent.parent;\n    }\n    return null;\n  }\n\n  getContainer(floatReference?: FloatReference): Vtree.Container {\n    if (!floatReference || floatReference === this.floatReference) {\n      return this.container;\n    }\n    return this.getParent(floatReference).getContainer(floatReference);\n  }\n\n  setContainer(container: Vtree.Container) {\n    this.container = container;\n    this.reattachFloatFragments();\n  }\n\n  addPageFloat(float: PageFloat) {\n    this.floatStore.addPageFloat(float);\n  }\n\n  getPageFloatLayoutContext(\n    floatReference: FloatReference,\n  ): PageFloatLayoutContext {\n    if (floatReference === this.floatReference) {\n      return this;\n    }\n    return this.getParent(floatReference).getPageFloatLayoutContext(\n      floatReference,\n    );\n  }\n\n  findPageFloatByNodePosition(\n    nodePosition: Vtree.NodePosition,\n  ): PageFloat | null {\n    return this.floatStore.findPageFloatByNodePosition(nodePosition);\n  }\n\n  private forbid(float: PageFloat) {\n    const id = float.getId();\n    const floatReference = float.floatReference;\n    if (floatReference === this.floatReference) {\n      if (!this.forbiddenFloats.includes(id)) {\n        this.forbiddenFloats.push(id);\n        const strategy = new PageFloatLayoutStrategyResolver().findByFloat(\n          float,\n        );\n        strategy.forbid(float, this);\n      }\n    } else {\n      const parent = this.getParent(floatReference);\n      parent.forbid(float);\n    }\n  }\n\n  isForbidden(float: PageFloat): boolean {\n    const id = float.getId();\n    const floatReference = float.floatReference;\n    if (floatReference === this.floatReference) {\n      return this.forbiddenFloats.includes(id);\n    } else {\n      const parent = this.getParent(floatReference);\n      return parent.isForbidden(float);\n    }\n  }\n\n  addPageFloatFragment(\n    floatFragment: PageFloatFragment,\n    dontInvalidate?: boolean,\n  ) {\n    const floatReference = floatFragment.floatReference;\n    if (floatReference !== this.floatReference) {\n      const parent = this.getParent(floatReference);\n      parent.addPageFloatFragment(floatFragment, dontInvalidate);\n    } else if (!this.floatFragments.includes(floatFragment)) {\n      this.floatFragments.push(floatFragment);\n      this.floatFragments.sort((fr1, fr2) => fr1.getOrder() - fr2.getOrder());\n    }\n    if (!dontInvalidate) {\n      this.invalidate();\n    }\n  }\n\n  removePageFloatFragment(\n    floatFragment: PageFloatFragment,\n    dontInvalidate?: boolean,\n  ) {\n    const floatReference = floatFragment.floatReference;\n    if (floatReference !== this.floatReference) {\n      const parent = this.getParent(floatReference);\n      parent.removePageFloatFragment(floatFragment, dontInvalidate);\n    } else {\n      const index = this.floatFragments.indexOf(floatFragment);\n      if (index >= 0) {\n        const fragment = this.floatFragments.splice(index, 1)[0];\n        const element = fragment.area && fragment.area.element;\n        if (element && element.parentNode) {\n          element.parentNode.removeChild(element);\n        }\n        if (!dontInvalidate) {\n          this.invalidate();\n        }\n      }\n    }\n  }\n\n  findPageFloatFragment(float: PageFloat): PageFloatFragment | null {\n    if (float.floatReference !== this.floatReference) {\n      const parent = this.getParent(float.floatReference);\n      return parent.findPageFloatFragment(float);\n    }\n    const index = this.floatFragments.findIndex((f) => f.hasFloat(float));\n    if (index >= 0) {\n      return this.floatFragments[index];\n    } else {\n      return null;\n    }\n  }\n\n  hasFloatFragments(condition?: (p1: PageFloatFragment) => boolean): boolean {\n    if (this.floatFragments.length > 0) {\n      if (!condition || this.floatFragments.some(condition)) {\n        return true;\n      }\n    }\n    if (this.parent) {\n      return this.parent.hasFloatFragments(condition);\n    } else {\n      return false;\n    }\n  }\n\n  hasContinuingFloatFragmentsInFlow(flowName: string): boolean {\n    return this.hasFloatFragments(\n      (fragment) => fragment.continues && fragment.getFlowName() === flowName,\n    );\n  }\n\n  registerPageFloatAnchor(float: PageFloat, anchorViewNode: Node) {\n    this.floatAnchors[float.getId()] = anchorViewNode;\n  }\n\n  collectPageFloatAnchors() {\n    const anchors = Object.assign({}, this.floatAnchors);\n    return this.children.reduce(\n      (prev, child) => Object.assign(prev, child.collectPageFloatAnchors()),\n      anchors,\n    );\n  }\n\n  isAnchorAlreadyAppeared(floatId: PageFloatID) {\n    const deferredFloats = this.getDeferredPageFloatContinuations();\n    if (deferredFloats.some((cont) => cont.float.getId() === floatId)) {\n      return true;\n    }\n    const floatAnchors = this.collectPageFloatAnchors();\n    const anchorViewNode = floatAnchors[floatId];\n    if (!anchorViewNode) {\n      return false;\n    }\n    if (this.container && this.container.element) {\n      return this.container.element.contains(anchorViewNode);\n    }\n    return false;\n  }\n\n  deferPageFloat(continuation: PageFloatContinuation) {\n    const float = continuation.float;\n    if (float.floatReference === this.floatReference) {\n      const index = this.floatsDeferredToNext.findIndex(\n        (c) => c.float === float,\n      );\n      if (index >= 0) {\n        this.floatsDeferredToNext.splice(index, 1, continuation);\n      } else {\n        this.floatsDeferredToNext.push(continuation);\n      }\n    } else {\n      const parent = this.getParent(float.floatReference);\n      parent.deferPageFloat(continuation);\n    }\n  }\n\n  hasPrecedingFloatsDeferredToNext(\n    float: PageFloat,\n    ignoreReference?: boolean,\n  ): boolean {\n    if (!ignoreReference && float.floatReference !== this.floatReference) {\n      return this.getParent(\n        float.floatReference,\n      ).hasPrecedingFloatsDeferredToNext(float, false);\n    }\n    const order = float.getOrder();\n    const hasPrecedingFloatsDeferredToNext = this.floatsDeferredToNext.some(\n      (c) => c.float.getOrder() < order && !float.isAllowedToPrecede(c.float),\n    );\n    if (hasPrecedingFloatsDeferredToNext) {\n      return true;\n    } else if (this.parent) {\n      return this.parent.hasPrecedingFloatsDeferredToNext(float, true);\n    } else {\n      return false;\n    }\n  }\n\n  getLastFollowingFloatInFragments(float: PageFloat): PageFloat | null {\n    const order = float.getOrder();\n    let lastFollowing: PageFloat = null;\n    this.floatFragments.forEach((fragment) => {\n      fragment.continuations.forEach((c) => {\n        const f = c.float;\n        const o = f.getOrder();\n        if (o > order && (!lastFollowing || o > lastFollowing.getOrder())) {\n          lastFollowing = f;\n        }\n      });\n    });\n    if (this.parent) {\n      const lastFollowingOfParent =\n        this.parent.getLastFollowingFloatInFragments(float);\n      if (\n        lastFollowingOfParent &&\n        (!lastFollowing ||\n          lastFollowingOfParent.getOrder() > lastFollowing.getOrder())\n      ) {\n        lastFollowing = lastFollowingOfParent;\n      }\n    }\n    return lastFollowing;\n  }\n\n  getDeferredPageFloatContinuations(\n    flowName?: string | null,\n  ): PageFloatContinuation[] {\n    flowName = flowName || this.flowName;\n    let result = this.floatsDeferredFromPrevious.filter(\n      (cont) => !flowName || cont.float.flowName === flowName,\n    );\n    if (this.parent) {\n      result = this.parent\n        .getDeferredPageFloatContinuations(flowName)\n        .concat(result);\n    }\n    return result.sort((c1, c2) => c1.float.getOrder() - c2.float.getOrder());\n  }\n\n  getPageFloatContinuationsDeferredToNext(\n    flowName?: string | null,\n  ): PageFloatContinuation[] {\n    flowName = flowName || this.flowName;\n    const result = this.floatsDeferredToNext.filter(\n      (cont) => !flowName || cont.float.flowName === flowName,\n    );\n    if (this.parent) {\n      return this.parent\n        .getPageFloatContinuationsDeferredToNext(flowName)\n        .concat(result);\n    } else {\n      return result;\n    }\n  }\n\n  getFloatsDeferredToNextInChildContexts(): PageFloat[] {\n    let result = [];\n    const done = [];\n    for (let i = this.children.length - 1; i >= 0; i--) {\n      const child = this.children[i];\n      if (done.includes(child.flowName)) {\n        continue;\n      }\n      done.push(child.flowName);\n      result = result.concat(child.floatsDeferredToNext.map((c) => c.float));\n      result = result.concat(child.getFloatsDeferredToNextInChildContexts());\n    }\n    return result;\n  }\n\n  checkAndForbidNotAllowedFloat(): boolean {\n    if (this.checkAndForbidFloatFollowingDeferredFloat()) {\n      return true;\n    }\n    for (let i = this.floatFragments.length - 1; i >= 0; i--) {\n      const fragment = this.floatFragments[i];\n      const notAllowedFloat = fragment.findNotAllowedFloat(this);\n      if (notAllowedFloat) {\n        if (this.locked) {\n          this.invalidate();\n        } else {\n          this.removePageFloatFragment(fragment);\n          this.forbid(notAllowedFloat);\n\n          // If the removed float is a block-end/inline-end float,\n          // we should re-layout preceding floats with the same float direction.\n          this.removeEndFloatFragments(fragment.floatSide);\n        }\n        return true;\n      }\n    }\n    if (this.floatReference === FloatReference.REGION && this.parent.locked) {\n      return this.parent.checkAndForbidNotAllowedFloat();\n    }\n    return false;\n  }\n\n  checkAndForbidFloatFollowingDeferredFloat(): boolean {\n    const deferredFloats = this.getFloatsDeferredToNextInChildContexts();\n    const floatsInFragments = this.floatFragments.reduce(\n      (r, fr) => r.concat(fr.continuations.map((c) => c.float)),\n      [],\n    );\n    floatsInFragments.sort((f1, f2) => f2.getOrder() - f1.getOrder());\n    for (const float of floatsInFragments) {\n      const order = float.getOrder();\n      if (\n        deferredFloats.some(\n          (d) => !float.isAllowedToPrecede(d) && order > d.getOrder(),\n        )\n      ) {\n        if (this.locked) {\n          this.invalidate();\n        } else {\n          this.forbid(float);\n          const fragment = this.findPageFloatFragment(float);\n          Asserts.assert(fragment);\n          this.removePageFloatFragment(fragment);\n        }\n        return true;\n      }\n    }\n    return false;\n  }\n\n  finish() {\n    if (this.checkAndForbidNotAllowedFloat()) {\n      return;\n    }\n    for (let i = this.floatsDeferredToNext.length - 1; i >= 0; i--) {\n      const continuation = this.floatsDeferredToNext[i];\n      if (!continuation.float.isAllowedOnContext(this)) {\n        if (this.locked) {\n          this.invalidate();\n          return;\n        }\n        this.floatsDeferredToNext.splice(i, 1);\n      }\n    }\n    this.floatsDeferredFromPrevious.forEach((continuation) => {\n      if (\n        this.floatsDeferredToNext.findIndex((c) => continuation.equals(c)) >= 0\n      ) {\n        return;\n      }\n      if (this.floatFragments.some((f) => f.hasFloat(continuation.float))) {\n        return;\n      }\n      this.floatsDeferredToNext.push(continuation);\n    });\n  }\n\n  hasSameContainerAs(other: PageFloatLayoutContext): boolean {\n    return (\n      !!this.container &&\n      !!other.container &&\n      this.container.element === other.container.element\n    );\n  }\n\n  invalidate() {\n    this.invalidated = true;\n    if (this.locked) {\n      return;\n    }\n    if (this.container) {\n      this.children.forEach((child) => {\n        // Since the same container element is shared by a region page float\n        // layout context and a column page float layout context in a single\n        // column region, view elements of float fragments of the child (column)\n        // context need to be removed here.\n        if (this.hasSameContainerAs(child)) {\n          child.floatFragments.forEach((fragment) => {\n            const elem = fragment.area.element;\n            if (elem && elem.parentNode) {\n              elem.parentNode.removeChild(elem);\n            }\n          });\n        }\n      });\n      this.container.clear();\n    }\n    this.children.forEach((child) => {\n      child.layoutConstraints.splice(0);\n    });\n    this.children.splice(0);\n    Object.keys(this.floatAnchors).forEach((k) => {\n      delete this.floatAnchors[k];\n    });\n  }\n\n  detachChildren(): PageFloatLayoutContext[] {\n    const children = this.children.splice(0);\n    children.forEach((child) => {\n      child.floatFragments.forEach((fragment) => {\n        const elem = fragment.area.element;\n        if (elem && elem.parentNode) {\n          elem.parentNode.removeChild(elem);\n        }\n      });\n    });\n    return children;\n  }\n\n  attachChildren(children: PageFloatLayoutContext[]) {\n    children.forEach((child) => {\n      this.children.push(child);\n      child.reattachFloatFragments();\n    });\n  }\n\n  isInvalidated() {\n    return this.invalidated || (!!this.parent && this.parent.isInvalidated());\n  }\n\n  validate() {\n    this.invalidated = false;\n  }\n\n  private toLogical(side: string): string {\n    const writingMode = this.writingMode.toString();\n    const direction = this.direction.toString();\n\n    if (side === \"inside\" || side === \"outside\") {\n      const isLeftPage = !!this.container.element.closest(\n        \"[data-vivliostyle-page-side='left']\",\n      );\n      side =\n        side === \"inside\"\n          ? isLeftPage\n            ? \"right\"\n            : \"left\"\n          : isLeftPage\n            ? \"left\"\n            : \"right\";\n    }\n    return CssLogicalUtil.toLogical(side, writingMode, direction);\n  }\n\n  private toPhysical(side: string): string {\n    const writingMode = this.writingMode.toString();\n    const direction = this.direction.toString();\n    return CssLogicalUtil.toPhysical(side, writingMode, direction);\n  }\n\n  private toLogicalFloatSides(floatSide: string): string[] {\n    const sides = floatSide.split(\" \");\n\n    // Convert to logical sides and remove duplicates\n    const logicalSides: string[] = [];\n    for (const side of sides) {\n      const logicalSide = this.toLogical(side);\n      if (!logicalSides.includes(logicalSide)) {\n        logicalSides.push(logicalSide);\n      }\n    }\n\n    // Convert \"block-start block-end\" to \"snap-block\" and\n    // \"inline-start inline-end\" to \"snap-inline\".\n    // More precisely, when multiple \"*block*\" values are found\n    // convert the first one to \"snap-block\" and remove the rest,\n    // and when multiple \"*inline*\" values are found convert the\n    // first one to \"snap-inline\" and remove the rest.\n    const logicalFloatSides: string[] = [];\n    let foundSnapBlock = false;\n    let foundSnapInline = false;\n    for (let i = 0; i < logicalSides.length; i++) {\n      const side = logicalSides[i];\n      if (side.includes(\"block\")) {\n        if (!foundSnapBlock) {\n          // Convert to \"snap-block\" if another block side is found\n          if (logicalSides.slice(i + 1).some((s) => s.includes(\"block\"))) {\n            logicalFloatSides.push(\"snap-block\");\n            foundSnapBlock = true;\n          } else {\n            logicalFloatSides.push(side);\n          }\n        }\n      } else if (side.includes(\"inline\")) {\n        if (!foundSnapInline) {\n          // Convert to \"snap-inline\" if another inline side is found\n          if (logicalSides.slice(i + 1).some((s) => s.includes(\"inline\"))) {\n            logicalFloatSides.push(\"snap-inline\");\n            foundSnapInline = true;\n          } else {\n            logicalFloatSides.push(side);\n          }\n        }\n      }\n    }\n\n    return logicalFloatSides;\n  }\n\n  removeEndFloatFragments(floatSide: string) {\n    const logicalFloatSide = this.toLogicalFloatSides(floatSide)[0];\n    if (logicalFloatSide === \"block-end\" || logicalFloatSide === \"inline-end\") {\n      let i = 0;\n      while (i < this.floatFragments.length) {\n        const fragment = this.floatFragments[i];\n        const fragmentFloatSide = this.toLogicalFloatSides(\n          fragment.floatSide,\n        )[0];\n        if (fragmentFloatSide === logicalFloatSide) {\n          this.removePageFloatFragment(fragment);\n        } else {\n          i++;\n        }\n      }\n    }\n  }\n\n  stashEndFloatFragments(float: PageFloat) {\n    const floatReference = float.floatReference;\n    if (floatReference !== this.floatReference) {\n      this.getParent(floatReference).stashEndFloatFragments(float);\n      return;\n    }\n    const logicalFloatSide = this.toLogicalFloatSides(float.floatSide)[0];\n    if (\n      logicalFloatSide === \"block-end\" ||\n      logicalFloatSide === \"snap-block\" ||\n      logicalFloatSide === \"inline-end\" ||\n      logicalFloatSide === \"snap-inline\"\n    ) {\n      let i = 0;\n      while (i < this.floatFragments.length) {\n        const fragment = this.floatFragments[i];\n        const fragmentFloatSide = this.toLogicalFloatSides(\n          fragment.floatSide,\n        )[0];\n        if (\n          (fragmentFloatSide === logicalFloatSide ||\n            (logicalFloatSide === \"snap-block\" &&\n              fragmentFloatSide === \"block-end\") ||\n            (logicalFloatSide === \"snap-inline\" &&\n              fragmentFloatSide === \"inline-end\")) &&\n          fragment.shouldBeStashedBefore(float)\n        ) {\n          this.stashedFloatFragments.push(fragment);\n          this.floatFragments.splice(i, 1);\n        } else {\n          i++;\n        }\n      }\n    }\n  }\n\n  restoreStashedFragments(floatReference: FloatReference) {\n    if (floatReference !== this.floatReference) {\n      this.getParent(floatReference).restoreStashedFragments(floatReference);\n      return;\n    }\n    this.stashedFloatFragments.forEach((stashed) => {\n      this.addPageFloatFragment(stashed, true);\n    });\n    this.stashedFloatFragments.splice(0);\n  }\n\n  discardStashedFragments(floatReference: FloatReference) {\n    if (floatReference !== this.floatReference) {\n      this.getParent(floatReference).discardStashedFragments(floatReference);\n      return;\n    }\n    this.stashedFloatFragments.splice(0);\n  }\n\n  getStashedFloatFragments(\n    floatReference: FloatReference,\n  ): PageFloatFragment[] {\n    if (floatReference === this.floatReference) {\n      return this.stashedFloatFragments\n        .concat()\n        .sort((fr1, fr2) => fr2.getOrder() - fr1.getOrder()); // return in reverse order\n    } else {\n      return this.getParent(floatReference).getStashedFloatFragments(\n        floatReference,\n      );\n    }\n  }\n\n  private getLimitValue(\n    side: string,\n    side2: string | null,\n    layoutContext: Vtree.LayoutContext,\n    clientLayout: Vtree.ClientLayout,\n    condition?: (p1: PageFloatFragment, p2: PageFloatLayoutContext) => boolean,\n  ): number {\n    Asserts.assert(this.container);\n    const logicalSide = this.toLogical(side);\n    const physicalSide = this.toPhysical(side);\n    const logicalSide2 = side2 && this.toLogical(side2);\n    const physicalSide2 = side2 && this.toPhysical(side2);\n    const limit = this.getLimitValueInner(\n      logicalSide,\n      logicalSide2,\n      layoutContext,\n      clientLayout,\n      condition,\n    );\n    if (this.parent && this.parent.container) {\n      const parentLimit = this.parent.getLimitValue(\n        physicalSide,\n        physicalSide2,\n        layoutContext,\n        clientLayout,\n        condition,\n      );\n      switch (physicalSide) {\n        case \"top\":\n          return Math.max(limit, parentLimit);\n        case \"left\":\n          return Math.max(limit, parentLimit);\n        case \"bottom\":\n          return Math.min(limit, parentLimit);\n        case \"right\":\n          return Math.min(limit, parentLimit);\n        default:\n          Asserts.fail(\"Should be unreachable\");\n      }\n    }\n    return limit;\n  }\n\n  private getLimitValueInner(\n    logicalSide: string,\n    logicalSide2: string | null,\n    layoutContext: Vtree.LayoutContext,\n    clientLayout: Vtree.ClientLayout,\n    condition?: (p1: PageFloatFragment, p2: PageFloatLayoutContext) => boolean,\n  ): number {\n    Asserts.assert(this.container);\n    const limits = this.getLimitValuesInner(\n      layoutContext,\n      clientLayout,\n      condition,\n      logicalSide,\n      logicalSide2,\n    );\n    switch (logicalSide) {\n      case \"block-start\":\n        return this.container.vertical ? limits.right : limits.top;\n      case \"block-end\":\n        return this.container.vertical ? limits.left : limits.bottom;\n      case \"inline-start\":\n        return this.container.vertical\n          ? this.container.rtl\n            ? limits.bottom\n            : limits.top\n          : this.container.rtl\n            ? limits.right\n            : limits.left;\n      case \"inline-end\":\n        return this.container.vertical\n          ? this.container.rtl\n            ? limits.top\n            : limits.bottom\n          : this.container.rtl\n            ? limits.left\n            : limits.right;\n      default:\n        throw new Error(`Unknown logical side: ${logicalSide}`);\n    }\n  }\n\n  private getLimitValuesInner(\n    layoutContext: Vtree.LayoutContext,\n    clientLayout: Vtree.ClientLayout,\n    condition?: (p1: PageFloatFragment, p2: PageFloatLayoutContext) => boolean,\n    logicalSide?: string,\n    logicalSide2?: string,\n  ): {\n    top: number;\n    left: number;\n    bottom: number;\n    right: number;\n    floatMinWrapBlockStart: number;\n    floatMinWrapBlockEnd: number;\n  } {\n    Asserts.assert(this.container);\n    const offsetX = this.container.originX;\n    const offsetY = this.container.originY;\n    const paddingRect = this.container.getPaddingRect();\n    let limits = {\n      top: paddingRect.y1 - offsetY,\n      left: paddingRect.x1 - offsetX,\n      bottom: paddingRect.y2 - offsetY,\n      right: paddingRect.x2 - offsetX,\n      floatMinWrapBlockStart: 0,\n      floatMinWrapBlockEnd: 0,\n    };\n\n    function resolveLengthPercentage(numeric, viewNode, containerLength) {\n      if (numeric.unit === \"%\") {\n        return (containerLength * numeric.num) / 100;\n      } else {\n        return layoutContext.convertLengthToPx(numeric, viewNode, clientLayout);\n      }\n    }\n    const fragments = this.floatFragments;\n    if (fragments.length > 0) {\n      limits = fragments.reduce((l, f) => {\n        if (condition && !condition(f, this)) {\n          return l;\n        }\n        const [logicalFloatSide, logicalFloatSide2] = this.toLogicalFloatSides(\n          f.floatSide,\n        );\n        if (\n          logicalFloatSide2 &&\n          ((logicalSide &&\n            logicalFloatSide2.includes(\"block\") ===\n              logicalSide.includes(\"block\") &&\n            logicalFloatSide2 !== logicalSide) ||\n            (logicalSide2 &&\n              logicalFloatSide2.includes(\"block\") ===\n                logicalSide2.includes(\"block\") &&\n              logicalFloatSide2 !== logicalSide2))\n        ) {\n          // Preceding page floats on the opposite side should not affect\n          // the positioning limit. (Issue #1549)\n          return l;\n        }\n        const area = f.area;\n        const floatMinWrapBlock = f.continuations[0].float.floatMinWrapBlock;\n        let top = l.top;\n        let left = l.left;\n        let bottom = l.bottom;\n        let right = l.right;\n        let floatMinWrapBlockStart = l.floatMinWrapBlockStart;\n        let floatMinWrapBlockEnd = l.floatMinWrapBlockEnd;\n        switch (logicalFloatSide) {\n          case \"inline-start\":\n            if (area.vertical) {\n              top = Math.max(top, area.top + area.height);\n            } else {\n              left = Math.max(left, area.left + area.width);\n            }\n            break;\n          case \"block-start\":\n            if (area.vertical) {\n              if (floatMinWrapBlock && area.left < right) {\n                floatMinWrapBlockStart = resolveLengthPercentage(\n                  floatMinWrapBlock,\n                  (area as any).rootViewNodes[0],\n                  paddingRect.x2 - paddingRect.x1,\n                ) as number;\n              }\n              right = Math.min(right, area.left);\n            } else {\n              if (floatMinWrapBlock && area.top + area.height > top) {\n                floatMinWrapBlockStart = resolveLengthPercentage(\n                  floatMinWrapBlock,\n                  (area as any).rootViewNodes[0],\n                  paddingRect.y2 - paddingRect.y1,\n                ) as number;\n              }\n              top = Math.max(top, area.top + area.height);\n            }\n            break;\n          case \"inline-end\":\n            if (area.vertical) {\n              bottom = Math.min(bottom, area.top);\n            } else {\n              right = Math.min(right, area.left);\n            }\n            break;\n          case \"block-end\":\n            if (area.vertical) {\n              if (floatMinWrapBlock && area.left + area.width > left) {\n                floatMinWrapBlockEnd = resolveLengthPercentage(\n                  floatMinWrapBlock,\n                  (area as any).rootViewNodes[0],\n                  paddingRect.x2 - paddingRect.x1,\n                ) as number;\n              }\n              left = Math.max(left, area.left + area.width);\n            } else {\n              if (floatMinWrapBlock && area.top < bottom) {\n                floatMinWrapBlockEnd = resolveLengthPercentage(\n                  floatMinWrapBlock,\n                  (area as any).rootViewNodes[0],\n                  paddingRect.y2 - paddingRect.y1,\n                ) as number;\n              }\n              bottom = Math.min(bottom, area.top);\n            }\n            break;\n          default:\n            throw new Error(`Unknown logical float side: ${logicalFloatSide}`);\n        }\n        return {\n          top,\n          left,\n          bottom,\n          right,\n          floatMinWrapBlockStart,\n          floatMinWrapBlockEnd,\n        };\n      }, limits);\n    }\n    limits.left += offsetX;\n    limits.right += offsetX;\n    limits.top += offsetY;\n    limits.bottom += offsetY;\n    return limits;\n  }\n\n  /**\n   * @param anchorEdge Null indicates that the anchor is not in the current\n   *     container.\n   * @return Logical float side (snap-block is resolved when init=false). Null\n   *     indicates that the float area does not fit inside the container\n   */\n  setFloatAreaDimensions(\n    area: LayoutType.PageFloatArea,\n    floatReference: FloatReference,\n    floatSide: string,\n    anchorEdge: number | null,\n    init: boolean,\n    force: boolean,\n    condition: PageFloatPlacementCondition,\n  ): string | null {\n    if (floatReference !== this.floatReference) {\n      const parent = this.getParent(floatReference);\n      return parent.setFloatAreaDimensions(\n        area,\n        floatReference,\n        floatSide,\n        anchorEdge,\n        init,\n        force,\n        condition,\n      );\n    }\n    const logicalFloatSides = this.toLogicalFloatSides(floatSide);\n    if (logicalFloatSides[0] === \"snap-block\") {\n      if (!condition[\"block-start\"] && !condition[\"block-end\"]) {\n        return null;\n      }\n    } else if (logicalFloatSides[0].includes(\"block\")) {\n      if (!condition[logicalFloatSides[0]]) {\n        return null;\n      }\n    }\n    Asserts.assert(area.clientLayout);\n\n    // Preceding page floats on the opposite side should not affect\n    // the positioning limit unless clear:inline-start/end is specified.\n    // (Issue #1549, #1550)\n    const inlineSideForBlockLimit = logicalFloatSides.find(\n      (s) =>\n        s.includes(\"inline\") &&\n        condition[s === \"inline-start\" ? \"inline-end\" : \"inline-start\"],\n    );\n    const blockSideForInlineLimit = logicalFloatSides.find((s) =>\n      s.includes(\"block\"),\n    );\n\n    let blockStart = this.getLimitValue(\n      \"block-start\",\n      inlineSideForBlockLimit,\n      area.layoutContext,\n      area.clientLayout,\n    );\n    let blockEnd = this.getLimitValue(\n      \"block-end\",\n      inlineSideForBlockLimit,\n      area.layoutContext,\n      area.clientLayout,\n    );\n    let inlineStart = this.getLimitValue(\n      \"inline-start\",\n      blockSideForInlineLimit,\n      area.layoutContext,\n      area.clientLayout,\n    );\n    let inlineEnd = this.getLimitValue(\n      \"inline-end\",\n      blockSideForInlineLimit,\n      area.layoutContext,\n      area.clientLayout,\n    );\n    const blockOffset = area.vertical ? area.originX : area.originY;\n    const inlineOffset = area.vertical ? area.originY : area.originX;\n    blockStart = area.vertical\n      ? Math.min(\n          blockStart,\n          area.left +\n            area.getInsetLeft() +\n            area.width +\n            area.getInsetRight() +\n            blockOffset,\n        )\n      : Math.max(blockStart, area.top + blockOffset);\n    blockEnd = area.vertical\n      ? Math.max(blockEnd, area.left + blockOffset)\n      : Math.min(\n          blockEnd,\n          area.top +\n            area.getInsetTop() +\n            area.height +\n            area.getInsetBottom() +\n            blockOffset,\n        );\n\n    function limitBlockStartEndValueWithOpenRect(getRect, rect) {\n      let openRect = getRect(area.bands, rect);\n      if (openRect) {\n        if (area.vertical) {\n          openRect = GeometryUtil.unrotateBox(openRect);\n        }\n        blockStart = area.vertical\n          ? Math.min(blockStart, openRect.x2)\n          : Math.max(blockStart, openRect.y1);\n        blockEnd = area.vertical\n          ? Math.max(blockEnd, openRect.x1)\n          : Math.min(blockEnd, openRect.y2);\n        return true;\n      } else {\n        return force;\n      }\n    }\n    let blockSize: number;\n    let inlineSize: number;\n    let outerBlockSize: number;\n    let outerInlineSize: number;\n    if (init) {\n      const rect = area.vertical\n        ? GeometryUtil.rotateBox(\n            new GeometryUtil.Rect(blockEnd, inlineStart, blockStart, inlineEnd),\n          )\n        : new GeometryUtil.Rect(inlineStart, blockStart, inlineEnd, blockEnd);\n      if (\n        logicalFloatSides[0] === \"block-start\" ||\n        logicalFloatSides[0] === \"snap-block\" ||\n        logicalFloatSides[0] === \"inline-start\" ||\n        logicalFloatSides[0] === \"snap-inline\"\n      ) {\n        if (\n          !limitBlockStartEndValueWithOpenRect(\n            GeometryUtil.findUppermostFullyOpenRect,\n            rect,\n          )\n        ) {\n          return null;\n        }\n      }\n      if (\n        logicalFloatSides[0] === \"block-end\" ||\n        logicalFloatSides[0] === \"snap-block\" ||\n        logicalFloatSides[0] === \"inline-end\" ||\n        logicalFloatSides[0] === \"snap-inline\"\n      ) {\n        if (\n          !limitBlockStartEndValueWithOpenRect(\n            GeometryUtil.findBottommostFullyOpenRect,\n            rect,\n          )\n        ) {\n          return null;\n        }\n      }\n      outerBlockSize = (blockEnd - blockStart) * area.getBoxDir();\n      blockSize = outerBlockSize - area.getInsetBefore() - area.getInsetAfter();\n      outerInlineSize = (inlineEnd - inlineStart) * area.getInlineDir();\n      inlineSize = outerInlineSize - area.getInsetStart() - area.getInsetEnd();\n      if (!force && (blockSize <= 0 || inlineSize <= 0)) {\n        return null;\n      }\n    } else {\n      blockSize = area.computedBlockSize;\n      outerBlockSize = blockSize + area.getInsetBefore() + area.getInsetAfter();\n      const availableBlockSize = (blockEnd - blockStart) * area.getBoxDir();\n      if (logicalFloatSides[0] === \"snap-block\") {\n        if (anchorEdge === null) {\n          // Deferred from previous container\n          logicalFloatSides[0] = \"block-start\";\n        } else {\n          const containerRect = this.container.getPaddingRect();\n          const fromStart =\n            this.container.getBoxDir() *\n            (anchorEdge -\n              (this.container.vertical ? containerRect.x2 : containerRect.y1));\n          const fromEnd =\n            this.container.getBoxDir() *\n            ((this.container.vertical ? containerRect.x1 : containerRect.y2) -\n              anchorEdge -\n              outerBlockSize);\n          if (fromStart <= fromEnd) {\n            logicalFloatSides[0] = \"block-start\";\n          } else {\n            logicalFloatSides[0] = \"block-end\";\n          }\n        }\n        if (!condition[logicalFloatSides[0]]) {\n          if (condition[\"block-end\"]) {\n            logicalFloatSides[0] = \"block-end\";\n          } else {\n            return null;\n          }\n        }\n      } else if (logicalFloatSides[0] === \"snap-inline\") {\n        if (anchorEdge === null) {\n          // Deferred from previous container\n          logicalFloatSides[0] = \"inline-start\";\n        } else {\n          // FIXME: snap-inline should be resolved based on the anchor's inline position\n          if (condition[\"inline-start\"]) {\n            logicalFloatSides[0] = \"inline-start\";\n          } else if (condition[\"inline-end\"]) {\n            logicalFloatSides[0] = \"inline-end\";\n          } else {\n            return null;\n          }\n        }\n      }\n      if (!force && availableBlockSize < outerBlockSize) {\n        return null;\n      }\n      if (\n        logicalFloatSides[0] === \"inline-start\" ||\n        logicalFloatSides[0] === \"inline-end\" ||\n        logicalFloatSides[1]\n      ) {\n        // If the page float is \"inline-start\" or \"inline-end\" or has two sides\n        // (e.g. \"block-start inline-end\"), the inline size is determined by the content size.\n        inlineSize = Sizing.getSize(area.clientLayout, area.element, [\n          Sizing.Size.FIT_CONTENT_INLINE_SIZE,\n        ])[Sizing.Size.FIT_CONTENT_INLINE_SIZE];\n      } else if (area.adjustContentRelativeSize) {\n        inlineSize = area.getContentInlineSize();\n      } else {\n        inlineSize = area.vertical ? area.height : area.width;\n      }\n      outerInlineSize = inlineSize + area.getInsetStart() + area.getInsetEnd();\n      const availableInlineSize =\n        (inlineEnd - inlineStart) * area.getInlineDir();\n      if (!force && availableInlineSize < outerInlineSize) {\n        return null;\n      }\n    }\n    blockStart -= blockOffset;\n    blockEnd -= blockOffset;\n    inlineStart -= inlineOffset;\n    inlineEnd -= inlineOffset;\n\n    if (\n      logicalFloatSides.some(\n        (s) => s === \"inline-start\" || s === \"snap-inline\",\n      ) ||\n      (logicalFloatSides.length === 1 &&\n        (logicalFloatSides[0] === \"block-start\" ||\n          logicalFloatSides[0] === \"snap-block\"))\n    ) {\n      area.setInlinePosition(inlineStart, inlineSize);\n    } else if (\n      logicalFloatSides.some((s) => s === \"inline-end\") ||\n      (logicalFloatSides.length === 1 && logicalFloatSides[0] === \"block-end\")\n    ) {\n      area.setInlinePosition(\n        inlineEnd - outerInlineSize * area.getInlineDir(),\n        inlineSize,\n      );\n    }\n    if (\n      logicalFloatSides.some(\n        (s) => s === \"block-start\" || s === \"snap-block\",\n      ) ||\n      (logicalFloatSides.length === 1 &&\n        (logicalFloatSides[0] === \"inline-start\" ||\n          logicalFloatSides[0] === \"snap-inline\"))\n    ) {\n      area.setBlockPosition(blockStart, blockSize);\n    } else if (\n      logicalFloatSides.some((s) => s === \"block-end\") ||\n      (logicalFloatSides.length === 1 && logicalFloatSides[0] === \"inline-end\")\n    ) {\n      area.setBlockPosition(\n        blockEnd - outerBlockSize * area.getBoxDir(),\n        blockSize,\n      );\n    }\n\n    return logicalFloatSides.join(\" \");\n  }\n\n  getFloatFragmentExclusions(): GeometryUtil.Shape[] {\n    const result = this.floatFragments.map((fragment) =>\n      fragment.getOuterShape(),\n    );\n    if (this.parent) {\n      return this.parent.getFloatFragmentExclusions().concat(result);\n    } else {\n      return result;\n    }\n  }\n\n  private reattachFloatFragments() {\n    const parent = this.container.element && this.container.element.parentNode;\n    if (parent) {\n      this.floatFragments.forEach((fragment) => {\n        parent.appendChild(fragment.area.element);\n      });\n    }\n  }\n\n  getMaxReachedAfterEdge(): number {\n    const isVertical = this.getContainer().vertical;\n    return this.floatFragments.reduce(\n      (edge, fragment) => {\n        const rect = fragment.getOuterRect();\n        if (isVertical) {\n          return Math.min(edge, rect.x1);\n        } else {\n          return Math.max(edge, rect.y2);\n        }\n      },\n      isVertical ? Infinity : 0,\n    );\n  }\n\n  getBlockStartEdgeOfBlockEndFloats(): number {\n    const isVertical = this.getContainer().vertical;\n    return this.floatFragments\n      .filter((fragment) => fragment.floatSide === \"block-end\")\n      .reduce(\n        (edge, fragment) => {\n          const rect = fragment.getOuterRect();\n          if (isVertical) {\n            return Math.max(edge, rect.x2);\n          } else {\n            return Math.min(edge, rect.y1);\n          }\n        },\n        isVertical ? 0 : Infinity,\n      );\n  }\n\n  getPageFloatClearEdge(clear: string, column: LayoutType.Column): number {\n    function isContinuationOfAlreadyAppearedFloat(\n      context: PageFloatLayoutContext,\n    ) {\n      return (continuation: PageFloatContinuation) =>\n        context.isAnchorAlreadyAppeared(continuation.float.getId());\n    }\n\n    function isFragmentWithAlreadyAppearedFloat(\n      fragment: PageFloatFragment,\n      context: PageFloatLayoutContext,\n    ) {\n      if (\n        (clear === \"inline-start\" &&\n          (fragment.floatSide.includes(\"inline-end\") ||\n            fragment.floatSide === \"block-end\")) ||\n        (clear === \"inline-end\" &&\n          (fragment.floatSide.includes(\"inline-start\") ||\n            fragment.floatSide === \"block-start\"))\n      ) {\n        // Clear page-floats by clear:inline-start/end on non-page-float elements.\n        // (Issue #1550)\n        return false;\n      }\n      return fragment.continuations.some(\n        isContinuationOfAlreadyAppearedFloat(context),\n      );\n    }\n    const columnRect = column.getPaddingRect();\n    const columnBlockEnd = column.vertical ? columnRect.x1 : columnRect.y2;\n    let context: PageFloatLayoutContext = this;\n    while (context) {\n      if (\n        context.floatsDeferredToNext.some(\n          isContinuationOfAlreadyAppearedFloat(context),\n        )\n      ) {\n        return columnBlockEnd;\n      }\n      context = context.parent;\n    }\n\n    function hasFragmentWithAlreadyAppearedFloat(\n      context: PageFloatLayoutContext,\n    ) {\n      return (\n        context.floatFragments.some((fragment) =>\n          isFragmentWithAlreadyAppearedFloat(fragment, context),\n        ) ||\n        context.children.some((child) =>\n          hasFragmentWithAlreadyAppearedFloat(child),\n        )\n      );\n    }\n\n    // Support clear:column/region/page for page floats. (Issue #1551)\n    if (clear === \"column\" || clear === \"region\" || clear === \"page\") {\n      for (context = this; context; context = context.parent) {\n        if (context.floatReference === clear) {\n          if (hasFragmentWithAlreadyAppearedFloat(context)) {\n            return columnBlockEnd;\n          }\n          break;\n        }\n      }\n    }\n\n    Asserts.assert(column.clientLayout);\n    const blockStartLimit = this.getLimitValue(\n      \"block-start\",\n      null,\n      column.layoutContext,\n      column.clientLayout,\n      isFragmentWithAlreadyAppearedFloat,\n    );\n    const blockEndLimit = this.getLimitValue(\n      \"block-end\",\n      null,\n      column.layoutContext,\n      column.clientLayout,\n      isFragmentWithAlreadyAppearedFloat,\n    );\n    if (\n      blockEndLimit * column.getBoxDir() <\n      columnBlockEnd * column.getBoxDir()\n    ) {\n      return columnBlockEnd;\n    } else {\n      return blockStartLimit;\n    }\n  }\n\n  getPageFloatPlacementCondition(\n    float: PageFloat,\n    floatSide: string,\n    clearSide: string | null,\n  ): PageFloatPlacementCondition {\n    if (float.floatReference !== this.floatReference) {\n      const parent = this.getParent(float.floatReference);\n      return parent.getPageFloatPlacementCondition(float, floatSide, clearSide);\n    }\n    const result: PageFloatPlacementCondition = {\n      \"block-start\": true,\n      \"block-end\": true,\n      \"inline-start\": true,\n      \"inline-end\": true,\n    };\n    if (!clearSide) {\n      return result;\n    }\n    const logicalFloatSide = this.toLogicalFloatSides(floatSide)[0];\n    const logicalClearSide = this.toLogical(clearSide);\n    let logicalSides: string[];\n    if (logicalClearSide === \"all\") {\n      logicalSides = [\"block-start\", \"block-end\", \"inline-start\", \"inline-end\"];\n    } else if (logicalClearSide === \"both\") {\n      logicalSides = [\"inline-start\", \"inline-end\"];\n    } else if (logicalClearSide === \"same\") {\n      if (logicalFloatSide === \"snap-block\") {\n        logicalSides = [\"block-start\", \"block-end\"];\n      } else {\n        logicalSides = [logicalFloatSide];\n      }\n    } else {\n      logicalSides = [logicalClearSide];\n    }\n    const floatOrder = float.getOrder();\n\n    function isPrecedingFragment(\n      side: string | null,\n    ): (p1: PageFloatFragment) => boolean {\n      return (fragment) =>\n        (!side || fragment.floatSide.includes(side)) &&\n        fragment.getOrder() < floatOrder;\n    }\n\n    function hasPrecedingFragmentInChildren(\n      context: PageFloatLayoutContext,\n      side: string | null,\n    ): boolean {\n      return context.children.some(\n        (child) =>\n          child.floatFragments.some(isPrecedingFragment(side)) ||\n          hasPrecedingFragmentInChildren(child, side),\n      );\n    }\n\n    function hasPrecedingFragmentInParents(\n      context: PageFloatLayoutContext,\n      side: string | null,\n    ): boolean {\n      const parent = context.parent;\n      return (\n        !!parent &&\n        (parent.floatFragments.some(isPrecedingFragment(side)) ||\n          hasPrecedingFragmentInParents(parent, side))\n      );\n    }\n\n    // Support clear:column/region/page for page floats. (Issue #1551)\n    if (\n      clearSide === \"column\" ||\n      clearSide === \"region\" ||\n      clearSide === \"page\"\n    ) {\n      for (\n        let context: PageFloatLayoutContext = this;\n        context;\n        context = context.parent\n      ) {\n        if (context.floatReference === clearSide) {\n          if (\n            context.floatFragments.some(isPrecedingFragment(null)) ||\n            hasPrecedingFragmentInChildren(context, null)\n          ) {\n            result[\"block-start\"] = false;\n            result[\"block-end\"] = false;\n            result[\"inline-start\"] = false;\n            result[\"inline-end\"] = false;\n          }\n          break;\n        }\n      }\n      return result;\n    }\n\n    logicalSides.forEach((side) => {\n      switch (side) {\n        case \"block-start\":\n          result[side] = !hasPrecedingFragmentInChildren(this, side);\n          break;\n        case \"block-end\":\n          result[side] = !hasPrecedingFragmentInParents(this, side);\n          break;\n        case \"inline-start\":\n        case \"inline-end\":\n          // Support clear:inline-start/end for page floats. (Issue #1550)\n          result[side] = !this.floatFragments.some(isPrecedingFragment(side));\n          break;\n        default:\n          throw new Error(`Unexpected side: ${side}`);\n      }\n    });\n    return result;\n  }\n\n  getLayoutConstraints(): LayoutType.LayoutConstraint[] {\n    const constraints = this.parent ? this.parent.getLayoutConstraints() : [];\n    return constraints.concat(this.layoutConstraints);\n  }\n\n  addLayoutConstraint(\n    layoutConstraint: LayoutType.LayoutConstraint,\n    floatReference: FloatReference,\n  ) {\n    if (floatReference === this.floatReference) {\n      this.layoutConstraints.push(layoutConstraint);\n    } else {\n      this.getParent(floatReference).addLayoutConstraint(\n        layoutConstraint,\n        floatReference,\n      );\n    }\n  }\n\n  isColumnFullWithPageFloats(column: LayoutType.Column): boolean {\n    const layoutContext = column.layoutContext;\n    const clientLayout = column.clientLayout;\n    Asserts.assert(clientLayout);\n    let context: PageFloatLayoutContext = this;\n    let limits: {\n      top: number;\n      left: number;\n      bottom: number;\n      right: number;\n      floatMinWrapBlockStart: number;\n      floatMinWrapBlockEnd: number;\n    } = null;\n    while (context && context.container) {\n      const l = context.getLimitValuesInner(layoutContext, clientLayout);\n      if (limits) {\n        if (column.vertical) {\n          if (l.right < limits.right) {\n            limits.right = l.right;\n            limits.floatMinWrapBlockStart = l.floatMinWrapBlockStart;\n          }\n          if (l.left > limits.left) {\n            limits.left = l.left;\n            limits.floatMinWrapBlockEnd = l.floatMinWrapBlockEnd;\n          }\n        } else {\n          if (l.top > limits.top) {\n            limits.top = l.top;\n            limits.floatMinWrapBlockStart = l.floatMinWrapBlockStart;\n          }\n          if (l.bottom < limits.bottom) {\n            limits.bottom = l.bottom;\n            limits.floatMinWrapBlockEnd = l.floatMinWrapBlockEnd;\n          }\n        }\n      } else {\n        limits = l;\n      }\n      context = context.parent;\n    }\n    const floatMinWrapBlock = Math.max(\n      limits.floatMinWrapBlockStart,\n      limits.floatMinWrapBlockEnd,\n    );\n    const blockSpace = column.vertical\n      ? limits.right - limits.left\n      : limits.bottom - limits.top;\n    return blockSpace <= floatMinWrapBlock;\n  }\n\n  getMaxBlockSizeOfPageFloats(): number {\n    const isVertical = this.getContainer().vertical;\n    if (!this.floatFragments.length) {\n      return 0;\n    }\n    return Math.max.apply(\n      null,\n      this.floatFragments.map((fragment) => {\n        const area = fragment.area;\n        if (isVertical) {\n          return area.width;\n        } else {\n          return area.height;\n        }\n      }),\n    );\n  }\n\n  lock() {\n    this.locked = true;\n  }\n\n  unlock() {\n    this.locked = false;\n  }\n\n  isLocked(): boolean {\n    return this.locked;\n  }\n}\n\nexport interface PageFloatLayoutStrategy\n  extends PageFloats.PageFloatLayoutStrategy {}\n\nconst pageFloatLayoutStrategies: PageFloatLayoutStrategy[] = [];\n\nexport class PageFloatLayoutStrategyResolver {\n  static register(strategy: PageFloatLayoutStrategy) {\n    pageFloatLayoutStrategies.push(strategy);\n  }\n\n  findByNodeContext(nodeContext: Vtree.NodeContext): PageFloatLayoutStrategy {\n    for (let i = pageFloatLayoutStrategies.length - 1; i >= 0; i--) {\n      const strategy = pageFloatLayoutStrategies[i];\n      if (strategy.appliesToNodeContext(nodeContext)) {\n        return strategy;\n      }\n    }\n    throw new Error(`No PageFloatLayoutStrategy found for ${nodeContext}`);\n  }\n\n  findByFloat(float: PageFloat): PageFloatLayoutStrategy {\n    for (let i = pageFloatLayoutStrategies.length - 1; i >= 0; i--) {\n      const strategy = pageFloatLayoutStrategies[i];\n      if (strategy.appliesToFloat(float)) {\n        return strategy;\n      }\n    }\n    throw new Error(`No PageFloatLayoutStrategy found for ${float}`);\n  }\n}\n\nexport class NormalPageFloatLayoutStrategy implements PageFloatLayoutStrategy {\n  /** @override */\n  appliesToNodeContext(nodeContext: Vtree.NodeContext): boolean {\n    return isPageFloat(nodeContext.floatReference);\n  }\n\n  /** @override */\n  appliesToFloat(float: PageFloat): boolean {\n    return true;\n  }\n\n  /** @override */\n  createPageFloat(\n    nodeContext: Vtree.NodeContext,\n    pageFloatLayoutContext: PageFloatLayoutContext,\n    column: LayoutType.Column,\n  ): Task.Result<PageFloat> {\n    let floatReference = nodeContext.floatReference;\n    Asserts.assert(nodeContext.floatSide);\n    const floatSide: string = nodeContext.floatSide;\n    const nodePosition = nodeContext.toNodePosition();\n    return column\n      .resolveFloatReferenceFromColumnSpan(\n        floatReference,\n        nodeContext.columnSpan,\n        nodeContext,\n      )\n      .thenAsync((ref) => {\n        floatReference = ref;\n        Asserts.assert(pageFloatLayoutContext.flowName);\n        const float = new PageFloat(\n          nodePosition,\n          floatReference,\n          floatSide,\n          nodeContext.clearSide,\n          pageFloatLayoutContext.flowName,\n          nodeContext.floatMinWrapBlock,\n        );\n        pageFloatLayoutContext.addPageFloat(float);\n        return Task.newResult(float);\n      });\n  }\n\n  /** @override */\n  createPageFloatFragment(\n    continuations: PageFloatContinuation[],\n    floatSide: string,\n    clearSide: string | null,\n    floatArea: LayoutType.PageFloatArea,\n    continues: boolean,\n  ): PageFloatFragment {\n    const f = continuations[0].float;\n    return new PageFloatFragment(\n      f.floatReference,\n      floatSide,\n      clearSide,\n      continuations,\n      floatArea,\n      continues,\n    );\n  }\n\n  /** @override */\n  findPageFloatFragment(\n    float: PageFloat,\n    pageFloatLayoutContext: PageFloatLayoutContext,\n  ): PageFloatFragment | null {\n    return pageFloatLayoutContext.findPageFloatFragment(float);\n  }\n\n  /** @override */\n  adjustPageFloatArea(\n    floatArea: LayoutType.PageFloatArea,\n    floatContainer: Vtree.Container,\n    column: LayoutType.Column,\n  ) {}\n\n  /** @override */\n  forbid(float: PageFloat, pageFloatLayoutContext: PageFloatLayoutContext) {}\n}\n\nPageFloatLayoutStrategyResolver.register(new NormalPageFloatLayoutStrategy());\n", "/**\n * Copyright 2017 Daishinsha Inc.\n * Copyright 2019 Vivliostyle Foundation\n *\n * Vivliostyle.js is free software: you can redistribute it and/or modify\n * it under the terms of the GNU Affero General Public License as published by\n * the Free Software Foundation, either version 3 of the License, or\n * (at your option) any later version.\n *\n * Vivliostyle.js is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n * GNU Affero General Public License for more details.\n *\n * You should have received a copy of the GNU Affero General Public License\n * along with Vivliostyle.js.  If not, see <http://www.gnu.org/licenses/>.\n *\n * @fileoverview Footnotes\n */\nimport * as Asserts from \"./asserts\";\nimport * as Css from \"./css\";\nimport * as PageFloats from \"./page-floats\";\nimport * as Task from \"./task\";\nimport * as Vtree from \"./vtree\";\nimport { Layout } from \"./types\";\n\nconst PageFloatFragment = PageFloats.PageFloatFragment;\n\nexport class Footnote extends PageFloats.PageFloat {\n  constructor(\n    nodePosition: Vtree.NodePosition,\n    floatReference: PageFloats.FloatReference,\n    flowName: string,\n    public readonly footnotePolicy: Css.Ident | null,\n    floatMinWrapBlock: Css.Numeric | null,\n  ) {\n    super(\n      nodePosition,\n      floatReference,\n      \"block-end\",\n      null,\n      flowName,\n      floatMinWrapBlock,\n    );\n  }\n\n  override isAllowedToPrecede(other: PageFloats.PageFloat): boolean {\n    return !(other instanceof Footnote);\n  }\n}\n\n/**\n * @extends PageFloatFragment\n */\nexport class FootnoteFragment extends PageFloatFragment {\n  constructor(\n    floatReference: PageFloats.FloatReference,\n    continuations: PageFloats.PageFloatContinuation[],\n    area: Vtree.Container,\n    continues: boolean,\n  ) {\n    super(floatReference, \"block-end\", null, continuations, area, continues);\n  }\n\n  override getOrder(): number {\n    return Infinity;\n  }\n\n  override shouldBeStashedBefore(float: PageFloats.PageFloat): boolean {\n    if (float instanceof Footnote) {\n      return true;\n    } else {\n      return this.getOrder() < float.getOrder();\n    }\n  }\n}\n\nexport class LineFootnotePolicyLayoutConstraint\n  implements Layout.LayoutConstraint\n{\n  constructor(public readonly footnote: Footnote) {}\n\n  allowLayout(nodeContext: Vtree.NodeContext): boolean {\n    const nodePosition = nodeContext.toNodePosition();\n    return !Vtree.isSameNodePosition(nodePosition, this.footnote.nodePosition);\n  }\n}\n\nexport class FootnoteLayoutStrategy\n  implements PageFloats.PageFloatLayoutStrategy\n{\n  /** @override */\n  appliesToNodeContext(nodeContext: Vtree.NodeContext): boolean {\n    return nodeContext.floatSide === \"footnote\";\n  }\n\n  /** @override */\n  appliesToFloat(float: PageFloats.PageFloat): boolean {\n    return float instanceof Footnote;\n  }\n\n  /** @override */\n  createPageFloat(\n    nodeContext: Vtree.NodeContext,\n    pageFloatLayoutContext: PageFloats.PageFloatLayoutContext,\n    column: Layout.Column,\n  ): Task.Result<PageFloats.PageFloat> {\n    let floatReference = PageFloats.FloatReference.REGION;\n\n    // If the region context has the same container as the page context,\n    // use the page context as the context for the footnote.\n    const regionContext =\n      pageFloatLayoutContext.getPageFloatLayoutContext(floatReference);\n    const pageContext = pageFloatLayoutContext.getPageFloatLayoutContext(\n      PageFloats.FloatReference.PAGE,\n    );\n    if (pageContext.hasSameContainerAs(regionContext)) {\n      floatReference = PageFloats.FloatReference.PAGE;\n    }\n    const nodePosition = nodeContext.toNodePosition();\n    Asserts.assert(pageFloatLayoutContext.flowName);\n    const float: PageFloats.PageFloat = new Footnote(\n      nodePosition,\n      floatReference,\n      pageFloatLayoutContext.flowName,\n      nodeContext.footnotePolicy,\n      nodeContext.floatMinWrapBlock,\n    );\n    pageFloatLayoutContext.addPageFloat(float);\n    return Task.newResult(float);\n  }\n\n  /** @override */\n  createPageFloatFragment(\n    continuations: PageFloats.PageFloatContinuation[],\n    floatSide: string,\n    clearSide: string | null,\n    floatArea: Layout.PageFloatArea,\n    continues: boolean,\n  ): PageFloats.PageFloatFragment {\n    const f = continuations[0].float;\n    return new FootnoteFragment(\n      f.floatReference,\n      continuations,\n      floatArea,\n      continues,\n    );\n  }\n\n  /** @override */\n  findPageFloatFragment(\n    float: PageFloats.PageFloat,\n    pageFloatLayoutContext: PageFloats.PageFloatLayoutContext,\n  ): PageFloats.PageFloatFragment | null {\n    const context = pageFloatLayoutContext.getPageFloatLayoutContext(\n      float.floatReference,\n    );\n    const fragments = context.floatFragments.filter(\n      (fr) => fr instanceof FootnoteFragment,\n    );\n    Asserts.assert(fragments.length <= 1);\n    return fragments[0] || null;\n  }\n\n  /** @override */\n  adjustPageFloatArea(\n    floatArea: Layout.PageFloatArea,\n    floatContainer: Vtree.Container,\n    column: Layout.Column,\n  ) {\n    floatArea.isFootnote = true;\n    floatArea.adjustContentRelativeSize = false;\n    const element = floatArea.element;\n    Asserts.assert(element);\n    floatArea.vertical = column.layoutContext.applyFootnoteStyle(\n      floatContainer.vertical,\n      (column.layoutContext as any).nodeContext &&\n        (column.layoutContext as any).nodeContext.direction === \"rtl\",\n      element,\n    );\n    floatArea.convertPercentageSizesToPx(element);\n    column.setComputedInsets(element, floatArea);\n    column.setComputedWidthAndHeight(element, floatArea);\n  }\n\n  /** @override */\n  forbid(\n    float: PageFloats.PageFloat,\n    pageFloatLayoutContext: PageFloats.PageFloatLayoutContext,\n  ) {\n    const footnote = float as Footnote;\n    switch (footnote.footnotePolicy) {\n      case Css.ident.line: {\n        const constraint = new LineFootnotePolicyLayoutConstraint(footnote);\n        pageFloatLayoutContext.addLayoutConstraint(\n          constraint,\n          footnote.floatReference,\n        );\n        break;\n      }\n    }\n  }\n}\n\nPageFloats.PageFloatLayoutStrategyResolver.register(\n  new FootnoteLayoutStrategy(),\n);\n", "/**\n * Copyright 2016 Daishinsha Inc.\n * Copyright 2019 Vivliostyle Foundation\n *\n * Vivliostyle.js is free software: you can redistribute it and/or modify\n * it under the terms of the GNU Affero General Public License as published by\n * the Free Software Foundation, either version 3 of the License, or\n * (at your option) any later version.\n *\n * Vivliostyle.js is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n * GNU Affero General Public License for more details.\n *\n * You should have received a copy of the GNU Affero General Public License\n * along with Vivliostyle.js.  If not, see <http://www.gnu.org/licenses/>.\n *\n * @fileoverview Display - CSS Display Module\n */\nimport * as Css from \"./css\";\n\nexport const FLOW_ROOT_ATTR = \"data-vivliostyle-flow-root\";\n\nexport function isFlowRoot(element: Element): boolean {\n  return element.getAttribute(FLOW_ROOT_ATTR) === \"true\";\n}\n\n/**\n * 'Blockify' a display value.\n * cf. https://drafts.csswg.org/css-display/#transformations\n *     https://drafts.csswg.org/css2/visuren.html#dis-pos-flo\n */\nexport function blockify(display: Css.Ident): Css.Ident {\n  const displayStr = display?.toString() || \"block\";\n  let blockifiedStr: string;\n  switch (displayStr) {\n    case \"inline-flex\":\n      blockifiedStr = \"flex\";\n      break;\n    case \"inline-grid\":\n      blockifiedStr = \"grid\";\n      break;\n    case \"inline-table\":\n      blockifiedStr = \"table\";\n      break;\n    case \"inline\":\n    case \"table-row-group\":\n    case \"table-column\":\n    case \"table-column-group\":\n    case \"table-header-group\":\n    case \"table-footer-group\":\n    case \"table-row\":\n    case \"table-cell\":\n    case \"table-caption\":\n    case \"inline-block\":\n      blockifiedStr = \"block\";\n      break;\n    default:\n      blockifiedStr = displayStr;\n  }\n  return Css.getName(blockifiedStr);\n}\n\n/**\n * Judge if the generated box is absolutely positioned.\n */\nexport function isAbsolutelyPositioned(position: Css.Val): boolean {\n  return position === Css.ident.absolute || position === Css.ident.fixed;\n}\n\n/**\n * Check if the position value is 'running()'.\n * https://drafts.csswg.org/css-gcpm/#running-elements\n */\nexport function isRunning(position: Css.Val): boolean {\n  return position instanceof Css.Func && position.name === \"running\";\n}\n\n/**\n * Get computed values of display, position and float.\n * cf. https://drafts.csswg.org/css-display/#transformations\n *     https://drafts.csswg.org/css2/visuren.html#dis-pos-flo\n */\nexport function getComputedDisplayValue(\n  display: Css.Ident,\n  position: Css.Ident,\n  float: Css.Val,\n  isRoot: boolean,\n): { display: Css.Ident; position: Css.Ident; float: Css.Val } {\n  if (display === Css.ident.none) {\n    // no need to convert values when 'display' is 'none'\n  } else if (isAbsolutelyPositioned(position)) {\n    float = Css.ident.none;\n    display = blockify(display);\n  } else if (\n    (float && float !== Css.ident.none && !Css.isDefaultingValue(float)) ||\n    isRoot\n  ) {\n    display = blockify(display);\n  }\n  return { display, position, float };\n}\n\n/**\n * Judges if the generated box is block.\n */\nexport function isBlock(\n  display: Css.Ident,\n  position: Css.Ident,\n  float: Css.Val,\n  isRoot: boolean,\n): boolean {\n  return (\n    getComputedDisplayValue(display, position, float, isRoot).display ===\n    Css.ident.block\n  );\n}\n\nfunction isDisplayType(\n  display: Css.Val | string | undefined,\n): display is Css.Ident | Css.SpaceList | string {\n  return (\n    display instanceof Css.Ident ||\n    display instanceof Css.SpaceList ||\n    typeof display === \"string\"\n  );\n}\n\nexport function isInlineLevel(display: Css.Val | string | undefined): boolean {\n  if (!isDisplayType(display)) {\n    return false;\n  }\n  const displayStr = display.toString();\n  switch (displayStr) {\n    case \"inline\":\n    case \"inline-block\":\n    case \"inline-flex\":\n    case \"inline-grid\":\n    case \"ruby\":\n    case \"inline-table\":\n      return true;\n    default:\n      // For display values like \"inline list-item\"\n      return displayStr.includes(\"inline\");\n  }\n}\n\n/**\n * Check if the display value includes \"list-item\", like \"inline list-item\".\n */\nexport function isListItem(display: Css.Val | string | undefined): boolean {\n  if (!isDisplayType(display)) {\n    return false;\n  }\n  const displayStr = display.toString();\n  return displayStr.includes(\"list-item\");\n}\n\nexport function isBlockLevel(display: Css.Val | string | undefined): boolean {\n  if (!isDisplayType(display)) {\n    return false;\n  }\n  switch (display.toString()) {\n    case \"block\":\n    case \"flex\":\n    case \"grid\":\n    case \"table\":\n    case \"list-item\":\n    case \"flow-root\":\n      return true;\n    default:\n      return false;\n  }\n}\n\nexport function isRubyInternalDisplay(\n  display: Css.Val | string | undefined,\n): boolean {\n  if (!isDisplayType(display)) {\n    return false;\n  }\n  switch (display.toString()) {\n    case \"ruby-base\":\n    case \"ruby-text\":\n    case \"ruby-base-container\":\n    case \"ruby-text-container\":\n      return true;\n    default:\n      return false;\n  }\n}\n\n/**\n * Judges if the generated box establishes a new block formatting context.\n */\nexport function establishesBFC(\n  display: Css.Val,\n  position: Css.Ident,\n  float: Css.Val,\n  overflow: Css.Ident,\n  writingMode?: Css.Ident,\n  parentWritingMode?: Css.Ident,\n  isFlowRoot?: boolean,\n): boolean {\n  writingMode = writingMode || parentWritingMode || Css.ident.horizontal_tb;\n  return (\n    !!isFlowRoot ||\n    (!!float && float !== Css.ident.none && !Css.isDefaultingValue(float)) ||\n    isAbsolutelyPositioned(position) ||\n    display === Css.ident.inline_block ||\n    display === Css.ident.table_cell ||\n    display === Css.ident.table_caption ||\n    display == Css.ident.flex ||\n    display == Css.ident.grid ||\n    display == Css.ident.flow_root ||\n    ((display === Css.ident.block || display === Css.ident.list_item) &&\n      !!overflow &&\n      overflow !== Css.ident.visible &&\n      overflow !== Css.ident.clip &&\n      !Css.isDefaultingValue(overflow)) ||\n    (!!parentWritingMode && writingMode !== parentWritingMode)\n  );\n}\n\n/**\n * Judges if the generated box establishes a containing block for descendant\n * boxes with 'position: absolute'.\n */\nexport function establishesCBForAbsolute(position: Css.Ident): boolean {\n  return (\n    position === Css.ident.relative ||\n    position === Css.ident.absolute ||\n    position === Css.ident.fixed\n  );\n}\n", "/**\n * Copyright 2019 Vivliostyle Foundation\n *\n * Vivliostyle.js is free software: you can redistribute it and/or modify\n * it under the terms of the GNU Affero General Public License as published by\n * the Free Software Foundation, either version 3 of the License, or\n * (at your option) any later version.\n *\n * Vivliostyle.js is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n * GNU Affero General Public License for more details.\n *\n * You should have received a copy of the GNU Affero General Public License\n * along with Vivliostyle.js.  If not, see <http://www.gnu.org/licenses/>.\n *\n * @fileoverview LayoutHelper - Helper functions of Layout.\n */\nimport * as Base from \"./base\";\nimport * as Display from \"./display\";\nimport { Layout, Vtree } from \"./types\";\n\n/**\n * A large gap value used to separate columns when using the browser's\n * multi-column feature for page/column breaking.\n * This value should be significantly larger than any objects in the layout\n * to prevent overlapping content between columns, but not too large to cause\n * problems with browser rendering limits.\n */\nconst BIG_GAP = 100000;\n\n/**\n * Enable page/column breaking using the browser's multi-column feature.\n * This function sets CSS properties on the column element to create a\n * single-column (column-count: 1) that splits into multiple columns\n * when content overflows the column's size. The large column gap\n * (column-gap) ensures that the browser creates new columns\n * apart from the original column position, and it helps determine\n * page/column breaking positions in our layout processing.\n */\nexport function setBrowserColumnBreaking(column: Vtree.Container): void {\n  const style = column.element.style;\n  style.columnGap = `${BIG_GAP - (column.vertical ? column.height : column.width)}px`;\n  style.columnFill = \"auto\";\n  style.columnCount = \"1\";\n  // Workaround for Safari/WebKit(< 26.2) bug (column-count: 1 should create a multi-column container)\n  // https://bugs.webkit.org/show_bug.cgi?id=299836\n  style.columnWidth = \"0\";\n}\n\n/**\n * Disable the browser's multi-column feature for page/column breaking.\n * This function resets the CSS properties set by `setBrowserColumnBreaking`.\n */\nexport function unsetBrowserColumnBreaking(column: Vtree.Container): void {\n  const style = column.element.style;\n  style.columnWidth = \"\";\n  style.columnCount = \"\";\n  style.columnGap = \"\";\n  style.columnFill = \"\";\n}\n\n/**\n * Check if the browser's multi-column feature is being used for page/column breaking.\n */\nexport function isUsingBrowserColumnBreaking(column: Vtree.Container): boolean {\n  return column.element.style.columnCount === \"1\";\n}\n\n/**\n * Mark the column as a root column for Vivliostyle layout processing.\n */\nexport function setAsRootColumn(column: Vtree.Container): void {\n  column.element.setAttribute(\"data-vivliostyle-column\", \"true\");\n}\n\n/**\n * Check if the column is marked as a root column for Vivliostyle layout processing.\n */\nexport function isRootColumn(column: Vtree.Container): boolean {\n  return column.element.hasAttribute(\"data-vivliostyle-column\");\n}\n\n/**\n * Check if the client rectangle of an element or range is located\n * in a column beyond the current one due to the browser's column breaking.\n *\n * @param rect - The client rectangle to check.\n * @param vertical - Whether the layout is vertical.\n * @return the number of columns the end edge of the rectangle is after the current column.\n */\nexport function checkIfBeyondColumnBreaks(\n  rect: Vtree.ClientRect,\n  vertical: boolean,\n): number {\n  const distance = vertical\n    ? rect.bottom\n    : Math.max(Math.abs(rect.left), Math.abs(rect.right));\n  return Math.round(distance / BIG_GAP);\n}\n\n/**\n * Adjust the client rectangle of an element or range to account for\n * the browser's column breaking.\n * This function modifies the rectangle's coordinates to ensure that\n * if the rectangle is located in a column beyond the current one,\n * its position in the block-progression direction is moved accordingly\n * so that overflow checks can be performed based solely on the\n * block-progression position.\n *\n * @param rect - The client rectangle to check.\n * @param vertical - Whether the layout is vertical.\n * @return the number of columns the start edge of the rectangle is after the current column.\n */\nexport function adjustRectForColumnBreaking(\n  rect: Vtree.ClientRect,\n  vertical: boolean,\n): number {\n  const columnOverEnd = checkIfBeyondColumnBreaks(rect, vertical);\n  if (columnOverEnd === 0) {\n    return 0;\n  }\n  const distanceStart = vertical\n    ? rect.top\n    : Math.min(Math.abs(rect.left), Math.abs(rect.right));\n  const columnOverStart = Math.round(distanceStart / BIG_GAP);\n  const shiftStart = columnOverStart * BIG_GAP;\n  let shiftEnd = columnOverEnd * BIG_GAP;\n  if (vertical) {\n    // vertical writing mode, columns are top to bottom\n    rect.top -= shiftStart;\n    rect.bottom -= shiftEnd;\n    if (rect.bottom < rect.top) {\n      rect.bottom += BIG_GAP;\n      shiftEnd -= BIG_GAP;\n    }\n    rect.right -= shiftStart;\n    rect.left -= shiftEnd;\n  } else if (rect.left < -BIG_GAP / 2) {\n    // columns are right to left\n    rect.right += shiftStart;\n    rect.left += shiftEnd;\n    if (rect.left > rect.right) {\n      rect.left -= BIG_GAP;\n      shiftEnd += BIG_GAP;\n    }\n    rect.top += shiftStart;\n    rect.bottom += shiftEnd;\n  } else {\n    // columns are left to right\n    rect.left -= shiftStart;\n    rect.right -= shiftEnd;\n    if (rect.right < rect.left) {\n      rect.right += BIG_GAP;\n      shiftEnd -= BIG_GAP;\n    }\n    rect.top += shiftStart;\n    rect.bottom += shiftEnd;\n  }\n  rect.width = rect.right - rect.left;\n  rect.height = rect.bottom - rect.top;\n\n  return columnOverStart;\n}\n\n/**\n * Adjust multiple client rectangles for column breaking.\n */\nexport function adjustRectsForColumnBreaking(\n  rects: Vtree.ClientRect[],\n  vertical: boolean,\n): void {\n  for (let i = 0; i < rects.length; i++) {\n    adjustRectForColumnBreaking(rects[i], vertical);\n  }\n}\n\n/**\n * Get the client rectangle of an element, adjusted for column breaking.\n */\nexport function getElementClientRectAdjusted(\n  clientLayout: Vtree.ClientLayout,\n  element: Element,\n  vertical: boolean,\n): Vtree.ClientRect {\n  const rect = clientLayout.getElementClientRect(element);\n  const columnOver = adjustRectForColumnBreaking(rect, vertical);\n\n  // Workaround for Chromium bug on table fragmentation:\n  //   https://issues.chromium.org/issues/458852795\n  // To prevent the table cell from moving to the next column without breaking inside the cell due to the bug,\n  // we try to reduce the column height so that a column break inside the cell can occur.\n  if (columnOver === 1) {\n    let style = clientLayout.getElementComputedStyle(element);\n    if (\n      style.display === \"table-cell\" ||\n      (element.className === \"-vivliostyle-table-cell-container\" &&\n        element.parentElement?.parentElement &&\n        (style = clientLayout.getElementComputedStyle(\n          element.parentElement.parentElement,\n        )).display === \"table-cell\")\n    ) {\n      const columnElem = element.closest(\n        \"[data-vivliostyle-column]\",\n      ) as HTMLElement;\n      const columnStyle = columnElem?.style;\n      const blockSizeP = vertical ? \"width\" : \"height\";\n      const columnHeight = columnStyle && parseFloat(columnStyle[blockSizeP]);\n      if (columnHeight) {\n        let columnHeight2 = columnHeight;\n        let columnOver2 = columnOver;\n        const paddingBlockEnd = parseFloat(style.paddingBlockEnd);\n        const borderBlockEndWidth = parseFloat(style.borderBlockEndWidth);\n        let count = Math.ceil(paddingBlockEnd + borderBlockEndWidth);\n        while (\n          count-- > 0 &&\n          columnOver2 === columnOver &&\n          --columnHeight2 > 0\n        ) {\n          columnStyle[blockSizeP] = `${columnHeight2}px`;\n          const rect2 = clientLayout.getElementClientRect(element);\n          columnOver2 = adjustRectForColumnBreaking(rect2, vertical);\n          if (\n            columnOver2 < columnOver ||\n            (columnOver2 === columnOver &&\n              (vertical ? rect2.right > rect.right : rect2.top < rect.top))\n          ) {\n            columnElem.setAttribute(\n              \"data-vivliostyle-column-height-adjusted\",\n              \"true\",\n            );\n            return rect2;\n          }\n        }\n        columnStyle[blockSizeP] = `${columnHeight}px`;\n      }\n    }\n  }\n  return rect;\n}\n\n/**\n * Clear forced column breaks between two nodes.\n * This is used to prevent unnecessary blank pages.\n */\nexport function clearForcedColumnBreaks(prevNode: Node, currNode: Node): void {\n  if (prevNode.nodeType === 1) {\n    const elem = prevNode as HTMLElement;\n    if (elem.style?.breakAfter === \"column\") {\n      elem.style.breakAfter = \"\";\n    }\n  }\n  if (currNode.nodeType === 1) {\n    const elem = currNode as HTMLElement;\n    if (elem.style?.breakBefore === \"column\") {\n      elem.style.breakBefore = \"\";\n    }\n  }\n}\n\n/**\n * Find the nearest ancestor element that establishes a multi-column\n * layout but is not the root column element.\n */\nexport function findAncestorNonRootMultiColumn(node: Node): Element | null {\n  for (\n    let elem = node.nodeType === 1 ? (node as Element) : node.parentElement;\n    elem;\n    elem = elem.parentElement\n  ) {\n    const style = (elem as HTMLElement).style;\n    if (!style) {\n      break;\n    }\n    if (elem.hasAttribute(\"data-vivliostyle-column\")) {\n      // This is the root column element.\n      break;\n    }\n    if (\n      !isNaN(parseFloat(style.columnCount)) ||\n      !isNaN(parseFloat(style.columnWidth))\n    ) {\n      return elem;\n    }\n    if (style.position === \"absolute\") {\n      break;\n    }\n  }\n  return null;\n}\n\n/**\n * Fix overflow caused by forced column breaks in non-root multi-column elements.\n */\nexport function fixOverflowAtForcedColumnBreak(node: Node): void {\n  if (node.nodeType !== 1) {\n    return;\n  }\n  const element = node as HTMLElement;\n  const elementStyle = element.style;\n  const breakBeforeColumn = elementStyle?.breakBefore === \"column\";\n  const prevElem = element.previousElementSibling as HTMLElement;\n  const breakAfterColumn = prevElem && prevElem.style?.breakAfter === \"column\";\n  if (!breakBeforeColumn && !breakAfterColumn) {\n    return;\n  }\n  const nonRootMultiColumn = findAncestorNonRootMultiColumn(element);\n  if (!nonRootMultiColumn) {\n    return;\n  }\n  const multiColumnStyle =\n    nonRootMultiColumn.ownerDocument.defaultView.getComputedStyle(\n      nonRootMultiColumn,\n    );\n  const { writingMode, direction, columnGap, fontSize } = multiColumnStyle;\n  const vertical =\n    writingMode === \"vertical-rl\" || writingMode === \"vertical-lr\";\n  const isRtl = direction === \"rtl\";\n  const halfGap = (parseFloat(columnGap) || parseFloat(fontSize) || 16) / 2;\n\n  // Check if the element is overflowing the multi-column box\n  const multiColumnRect = nonRootMultiColumn.getBoundingClientRect();\n  const elementRect = element.getBoundingClientRect();\n  const columnOverflow = vertical\n    ? elementRect.top > multiColumnRect.bottom + halfGap\n    : isRtl\n      ? elementRect.right < multiColumnRect.left - halfGap\n      : elementRect.left > multiColumnRect.right + halfGap;\n  if (columnOverflow) {\n    // Fix overflow by removing the forced breaks and adding a large margin.\n    // This large margin will cause a page break in our layout processing.\n    if (breakBeforeColumn) {\n      elementStyle.breakBefore = \"\";\n    }\n    if (breakAfterColumn && prevElem) {\n      prevElem.style.breakAfter = \"\";\n    }\n    elementStyle.marginBlockStart = `${BIG_GAP}px`;\n  }\n}\n\n/**\n * Calculate the position of the \"after\" edge in the block-progression.\n * Returns the edge position in pixels if it was determined successfully,\n * and returns NaN if the position could not be determined and the node\n * should be considered zero-height.\n */\nexport function calculateEdge(\n  nodeContext: Vtree.NodeContext,\n  clientLayout: Vtree.ClientLayout,\n  extraOffset: number,\n  vertical: boolean,\n): number {\n  const node = nodeContext.viewNode;\n  if (!node) {\n    return NaN;\n  }\n\n  // NOTE: Do not replace `node.nodeType === 1` with `node instanceof Element`,\n  // which does not work when the node is inside iframe. (Issue #1000)\n\n  const element = node.nodeType === 1 ? (node as Element) : node.parentElement;\n  if (element && element.namespaceURI === Base.NS.XHTML) {\n    const style = (element as HTMLElement).style;\n    if (\n      element.localName === \"br\" ||\n      element.localName === \"wbr\" ||\n      (style &&\n        Display.isInlineLevel(style.display) &&\n        /^([\\d\\.]|super|(text-)?top)/.test(style.verticalAlign))\n    ) {\n      // Avoid incorrect edge calculation at BR or WBR element,\n      // or inline element with positive vertical-align (issue #811).\n      return NaN;\n    }\n  }\n  if (node === element) {\n    if (nodeContext.after || !nodeContext.inline) {\n      if (\n        nodeContext.after &&\n        !nodeContext.inline &&\n        element.querySelector(\"ruby\")\n      ) {\n        // Workaround for issue #987 (unnecessary break caused by ruby)\n        const parentNode = element.parentNode;\n        const nextSibling = element.nextSibling;\n        parentNode.removeChild(element);\n        parentNode.insertBefore(element, nextSibling);\n      }\n      const cbox = getElementClientRectAdjusted(\n        clientLayout,\n        element,\n        vertical,\n      );\n      if (\n        cbox.left === 0 &&\n        cbox.top === 0 &&\n        cbox.right === 0 &&\n        cbox.bottom === 0\n      ) {\n        // getBoundingClientRect() returns 0,0,0,0 for WBR element (Chrome)\n        // (Fix for issue #802)\n        return NaN;\n      }\n      if (cbox.right >= cbox.left && cbox.bottom >= cbox.top) {\n        if (nodeContext.after) {\n          return vertical ? cbox.left : cbox.bottom;\n        } else {\n          return vertical ? cbox.right : cbox.top;\n        }\n      }\n    }\n    return NaN;\n  } else {\n    let edge = NaN;\n    const range = node.ownerDocument.createRange();\n    const length = node.textContent.length;\n    if (!length) {\n      return NaN;\n    }\n    if (nodeContext.after) {\n      extraOffset += length;\n    }\n    if (extraOffset >= length) {\n      extraOffset = length - 1;\n    }\n    range.setStart(node, extraOffset);\n    range.setEnd(node, extraOffset + 1);\n    let boxes = clientLayout.getRangeClientRects(range);\n\n    // Adjust boxes' positions for column breaking\n    adjustRectsForColumnBreaking(boxes, vertical);\n\n    boxes = boxes.filter((box) => box.right > box.left && box.bottom > box.top);\n    if (!boxes.length) {\n      return NaN;\n    }\n    if (vertical) {\n      edge = Math.min.apply(\n        null,\n        boxes.map((box) => box.left),\n      );\n    } else {\n      edge = Math.max.apply(\n        null,\n        boxes.map((box) => box.bottom),\n      );\n    }\n    return edge;\n  }\n}\n\nexport function getElementHeight(\n  element: Element,\n  column: Layout.Column,\n  vertical: boolean,\n): number {\n  const usingBrowserColumnBreaking = isUsingBrowserColumnBreaking(column);\n  if (usingBrowserColumnBreaking) {\n    unsetBrowserColumnBreaking(column);\n  }\n  const rect = column.clientLayout.getElementClientRect(element);\n  if (usingBrowserColumnBreaking) {\n    setBrowserColumnBreaking(column);\n  }\n  const margin = column.getComputedMargin(element);\n  return vertical\n    ? rect[\"width\"] + margin[\"left\"] + margin[\"right\"]\n    : rect[\"height\"] + margin[\"top\"] + margin[\"bottom\"];\n}\n\nexport function isOrphan(node: Node): boolean {\n  while (node) {\n    if (node.parentNode === node.ownerDocument) {\n      return false;\n    }\n    node = node.parentNode;\n  }\n  return true;\n}\n\nexport function removeFollowingSiblings(\n  parentNode: Node,\n  viewNode: Node,\n): void {\n  if (!parentNode) {\n    return;\n  }\n  for (\n    let lastChild = parentNode.lastChild, prevSibling = lastChild;\n    lastChild !== viewNode;\n    lastChild = prevSibling\n  ) {\n    prevSibling = lastChild.previousSibling;\n    if (\n      lastChild.nodeType === 1 &&\n      (lastChild as Element).hasAttribute(\"data-vivliostyle-float-box-moved\") &&\n      (viewNode as HTMLElement).style?.display === \"inline\"\n    ) {\n      // Do not remove float box moved after parent inline (Issue #1383, #1422)\n      continue;\n    }\n    parentNode.removeChild(lastChild);\n  }\n}\n\n/**\n * Marks an element as \"special\". It should not be used in bbox calculations.\n */\nexport const SPECIAL_ATTR = \"data-adapt-spec\";\n\nexport function isSpecial(e: Element): boolean {\n  return !!e.getAttribute(SPECIAL_ATTR);\n}\n\nexport function isOutOfFlow(node: Node): boolean {\n  if (!(node?.nodeType === 1)) return false;\n  const e = node as HTMLElement;\n  if (isSpecial(e)) return true;\n  const position = e.style?.position;\n  return position === \"absolute\" || position === \"fixed\";\n}\n\nexport function isSpecialNodeContext(nodeContext: Vtree.NodeContext): boolean {\n  const viewNode = nodeContext?.viewNode;\n  return viewNode?.nodeType === 1 && isSpecial(viewNode as Element);\n}\n\nexport function isSpecialInlineDisplay(display: string): boolean {\n  return (\n    display !== \"inline\" &&\n    (Display.isInlineLevel(display) || Display.isRubyInternalDisplay(display))\n  );\n}\n\nexport function findAncestorSpecialInlineNodeContext(\n  nodeContext: Vtree.NodeContext,\n): Vtree.NodeContext | null {\n  for (let p = nodeContext.parent; p; p = p.parent) {\n    if (\n      (p.display !== \"inline\" || p.vertical !== p.parent?.vertical) &&\n      Display.isInlineLevel(p.display)\n    ) {\n      return p;\n    }\n  }\n  return null;\n}\n", "/**\n * Copyright 2019 Vivliostyle Foundation\n *\n * Vivliostyle.js is free software: you can redistribute it and/or modify\n * it under the terms of the GNU Affero General Public License as published by\n * the Free Software Foundation, either version 3 of the License, or\n * (at your option) any later version.\n *\n * Vivliostyle.js is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n * GNU Affero General Public License for more details.\n *\n * You should have received a copy of the GNU Affero General Public License\n * along with Vivliostyle.js.  If not, see <http://www.gnu.org/licenses/>.\n *\n * @fileoverview BreakPosition - Definitions of BreakPosition.\n */\nimport * as Break from \"./break\";\nimport * as LayoutHelper from \"./layout-helper\";\nimport { Layout, RepetitiveElement, Vtree } from \"./types\";\n\n/**\n * Potential breaking position.\n */\nexport type BreakPosition = Layout.BreakPosition;\n\nexport abstract class AbstractBreakPosition\n  implements Layout.AbstractBreakPosition\n{\n  abstract findAcceptableBreak(\n    column: Layout.Column,\n    penalty: number,\n  ): Vtree.NodeContext;\n\n  abstract getMinBreakPenalty(): number;\n\n  calculateOffset(column): { current: number; minimum: number } {\n    return calculateOffset(\n      this.getNodeContext(),\n      column.collectElementsOffset(),\n    );\n  }\n\n  /** @override */\n  breakPositionChosen(column: Layout.Column): void {}\n\n  getNodeContext(): Vtree.NodeContext {\n    return null;\n  }\n}\n\nexport function calculateOffset(\n  nodeContext: Vtree.NodeContext,\n  elementsOffsets: RepetitiveElement.ElementsOffset[],\n): { current: number; minimum: number } {\n  return {\n    current: elementsOffsets.reduce(\n      (val, repetitiveElement) =>\n        val + repetitiveElement.calculateOffset(nodeContext),\n      0,\n    ),\n    minimum: elementsOffsets.reduce(\n      (val, repetitiveElement) =>\n        val + repetitiveElement.calculateMinimumOffset(nodeContext),\n      0,\n    ),\n  };\n}\n\n/**\n * Potential edge breaking position.\n */\nexport class EdgeBreakPosition\n  extends AbstractBreakPosition\n  implements Layout.EdgeBreakPosition\n{\n  overflowIfRepetitiveElementsDropped: boolean;\n  protected isEdgeUpdated: boolean = false;\n  private edge: number = 0;\n\n  constructor(\n    public readonly position: Vtree.NodeContext,\n    public readonly breakOnEdge: string | null,\n    public overflows: boolean,\n    public readonly computedBlockSize: number,\n  ) {\n    super();\n    this.overflowIfRepetitiveElementsDropped = overflows;\n  }\n\n  override findAcceptableBreak(\n    column: Layout.Column,\n    penalty: number,\n  ): Vtree.NodeContext {\n    this.updateOverflows(column);\n    if (penalty < this.getMinBreakPenalty()) {\n      return null;\n    }\n    return column.findEdgeBreakPosition(this);\n  }\n\n  override getMinBreakPenalty(): number {\n    if (!this.isEdgeUpdated) {\n      throw new Error(\"EdgeBreakPosition.prototype.updateEdge not called\");\n    }\n    const preferDropping =\n      this.isFirstContentOfRepetitiveElementsOwner() &&\n      !this.overflowIfRepetitiveElementsDropped;\n    return (\n      (Break.isAvoidBreakValue(this.breakOnEdge) ? 1 : 0) +\n      (this.overflows && !preferDropping ? 3 : 0) +\n      (this.position.parent ? this.position.parent.breakPenalty : 0)\n    );\n  }\n\n  private updateEdge(column: Layout.Column) {\n    const clonedPaddingBorder = column.calculateClonedPaddingBorder(\n      this.position,\n    );\n    this.edge =\n      LayoutHelper.calculateEdge(\n        this.position,\n        column.clientLayout,\n        0,\n        column.vertical,\n      ) + clonedPaddingBorder;\n\n    if (!this.position.after && !this.position.inline) {\n      // Subtract marginBlockStart from the edge (Issue #611)\n      const marginBlockStart = column.parseComputedLength(\n        column.clientLayout.getElementComputedStyle(\n          this.position.viewNode as Element,\n        ).marginBlockStart,\n      );\n      this.edge -= (column.vertical ? -1 : 1) * marginBlockStart;\n    } else if (\n      this.position.after &&\n      this.position.shadowContext?.root.id === \"table-cell\"\n    ) {\n      // Add table's borderBlockEnd etc. to the edge\n      const cell = column.element.parentElement;\n      const table = cell?.closest(\n        \"table, [style*='display: table;']\",\n      ) as HTMLElement;\n      if (table) {\n        const collapse = table.style.borderCollapse === \"collapse\";\n        let padding = 0;\n        let border = 0;\n        for (let elem = cell; elem; elem = elem.parentElement) {\n          const style = column.clientLayout.getElementComputedStyle(elem);\n          if (elem === cell || (elem === table && !collapse)) {\n            padding += column.parseComputedLength(style.paddingBlockEnd);\n          }\n          if (elem === table && !collapse) {\n            padding += column.parseComputedLength(\n              style.borderSpacing.replace(/^\\S+ (\\S+)$/, \"$1\"),\n            );\n          }\n          if (collapse) {\n            border = Math.max(\n              border,\n              column.parseComputedLength(style.borderBlockEndWidth),\n            );\n          } else if (elem === cell || elem === table) {\n            border += column.parseComputedLength(style.borderBlockEndWidth);\n          }\n          if (elem === table) break;\n        }\n        this.edge += (column.vertical ? -1 : 1) * (padding + border);\n      }\n    }\n\n    this.isEdgeUpdated = true;\n  }\n\n  private updateOverflows(column: Layout.Column) {\n    if (!this.isEdgeUpdated) {\n      this.updateEdge(column);\n    }\n    const edge = this.edge;\n    const offsets = this.calculateOffset(column);\n    this.overflowIfRepetitiveElementsDropped = column.isOverflown(\n      edge + (column.vertical ? -1 : 1) * offsets.minimum,\n    );\n    this.overflows = this.position.overflow = column.isOverflown(\n      edge + (column.vertical ? -1 : 1) * offsets.current,\n    );\n  }\n\n  override getNodeContext(): Vtree.NodeContext {\n    return this.position;\n  }\n\n  private isFirstContentOfRepetitiveElementsOwner(): boolean {\n    const nodeContext = this.getNodeContext();\n    if (!nodeContext || !nodeContext.parent) {\n      return false;\n    }\n    const { formattingContext } = nodeContext.parent;\n    if (\n      !RepetitiveElement.isInstanceOfRepetitiveElementsOwnerFormattingContext(\n        formattingContext,\n      )\n    ) {\n      return false;\n    }\n\n    const repetitiveElements = formattingContext.getRepetitiveElements();\n    if (!repetitiveElements) {\n      return false;\n    }\n    return repetitiveElements.isFirstContentNode(nodeContext);\n  }\n}\n", "/**\n * Copyright 2019 Vivliostyle Foundation\n *\n * Vivliostyle.js is free software: you can redistribute it and/or modify\n * it under the terms of the GNU Affero General Public License as published by\n * the Free Software Foundation, either version 3 of the License, or\n * (at your option) any later version.\n *\n * Vivliostyle.js is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n * GNU Affero General Public License for more details.\n *\n * You should have received a copy of the GNU Affero General Public License\n * along with Vivliostyle.js.  If not, see <http://www.gnu.org/licenses/>.\n *\n * @fileoverview LayoutProcessor - Definitions of LayoutProcessor.\n */\nimport * as BreakPosition from \"./break-position\";\nimport * as Display from \"./display\";\nimport * as LayoutHelper from \"./layout-helper\";\nimport * as Plugin from \"./plugin\";\nimport * as Task from \"./task\";\nimport { FormattingContextType, Layout, LayoutProcessor, Vtree } from \"./types\";\n\n/**\n * Processor doing some special layout (e.g. table layout)\n */\n// eslint-disable-next-line no-redeclare\nexport interface LayoutProcessor {\n  /**\n   * Do actual layout in the column starting from given NodeContext.\n   */\n  layout(\n    nodeContext: Vtree.NodeContext,\n    column: Layout.Column,\n    leadingEdge: boolean,\n  ): Task.Result<Vtree.NodeContext>;\n\n  /**\n   * Potential edge breaking position.\n   */\n  createEdgeBreakPosition(\n    position: Vtree.NodeContext,\n    breakOnEdge: string | null,\n    overflows: boolean,\n    columnBlockSize: number,\n  ): Layout.BreakPosition;\n\n  /**\n   * process nodecontext at the start of a non inline element.\n   * @return return true if you skip the subsequent nodes\n   */\n  startNonInlineElementNode(nodeContext: Vtree.NodeContext): boolean;\n\n  /**\n   * process nodecontext after a non inline element.\n   * @return return true if you skip the subsequent nodes\n   */\n  afterNonInlineElementNode(\n    nodeContext: Vtree.NodeContext,\n    stopAtOverflow: boolean,\n  ): boolean;\n\n  /**\n   * @return holing true\n   */\n  finishBreak(\n    column: Layout.Column,\n    nodeContext: Vtree.NodeContext,\n    forceRemoveSelf: boolean,\n    endOfColumn: boolean,\n  ): Task.Result<boolean>;\n\n  clearOverflownViewNodes(\n    column: Layout.Column,\n    parentNodeContext: Vtree.NodeContext,\n    nodeContext: Vtree.NodeContext,\n    removeSelf: boolean,\n  );\n}\n\n/**\n * Resolver finding an appropriate LayoutProcessor given a formatting context\n */\nexport class LayoutProcessorResolver {\n  /**\n   * Find LayoutProcessor corresponding to given formatting context.\n   */\n  find(formattingContext: Vtree.FormattingContext): LayoutProcessor {\n    const hooks: Plugin.ResolveLayoutProcessorHook[] = Plugin.getHooksForName(\n      Plugin.HOOKS.RESOLVE_LAYOUT_PROCESSOR,\n    );\n    for (let i = 0; i < hooks.length; i++) {\n      const processor = hooks[i](formattingContext);\n      if (processor) {\n        return processor;\n      }\n    }\n    throw new Error(\n      `No processor found for a formatting context: ${formattingContext.getName()}`,\n    );\n  }\n}\n\nexport class BlockLayoutProcessor implements LayoutProcessor {\n  /** @override */\n  layout(\n    nodeContext: Vtree.NodeContext,\n    column: Layout.Column,\n    leadingEdge: boolean,\n  ): Task.Result<Vtree.NodeContext> {\n    if (column.isFloatNodeContext(nodeContext)) {\n      return column.layoutFloatOrFootnote(nodeContext);\n    } else if (column.isBreakable(nodeContext)) {\n      return column.layoutBreakableBlock(nodeContext);\n    } else {\n      return column.layoutUnbreakable(nodeContext);\n    }\n  }\n\n  /** @override */\n  createEdgeBreakPosition(\n    position: Vtree.NodeContext,\n    breakOnEdge: string | null,\n    overflows: boolean,\n    columnBlockSize: number,\n  ): Layout.BreakPosition {\n    return new BreakPosition.EdgeBreakPosition(\n      position.copy(),\n      breakOnEdge,\n      overflows,\n      columnBlockSize,\n    );\n  }\n\n  /** @override */\n  startNonInlineElementNode(nodeContext: Vtree.NodeContext): boolean {\n    return false;\n  }\n\n  /** @override */\n  afterNonInlineElementNode(\n    nodeContext: Vtree.NodeContext,\n    stopAtOverflow: boolean,\n  ): boolean {\n    return false;\n  }\n\n  /** @override */\n  clearOverflownViewNodes(\n    column: Layout.Column,\n    parentNodeContext: Vtree.NodeContext,\n    nodeContext: Vtree.NodeContext,\n    removeSelf: boolean,\n  ) {\n    if (!nodeContext.viewNode) {\n      return;\n    }\n    if (!nodeContext.viewNode.parentNode) {\n      return;\n    }\n    // Fix for issue #740\n    if (\n      nodeContext.shadowType === Vtree.ShadowType.ROOTLESS &&\n      LayoutHelper.isSpecialNodeContext(nodeContext)\n    ) {\n      return;\n    }\n    let node = nodeContext.viewNode;\n    if (node.parentElement?.localName === \"viv-ts-inner\") {\n      // special element for text-spacing\n      node = node.parentElement.parentElement;\n    }\n    const parentNode = node.parentNode;\n    LayoutHelper.removeFollowingSiblings(parentNode, node);\n    if (removeSelf) {\n      parentNode.removeChild(node);\n    }\n  }\n\n  /**\n   * @return holing true\n   * @override\n   */\n  finishBreak(\n    column: Layout.Column,\n    nodeContext: Vtree.NodeContext,\n    forceRemoveSelf: boolean,\n    endOfColumn: boolean,\n  ): Task.Result<boolean> {\n    const removeSelf =\n      forceRemoveSelf ||\n      (nodeContext.viewNode != null &&\n        nodeContext.viewNode.nodeType == 1 &&\n        !nodeContext.after);\n    column.clearOverflownViewNodes(nodeContext, removeSelf);\n    if (endOfColumn) {\n      column.layoutContext.processFragmentedBlockEdge(nodeContext);\n    }\n    return Task.newResult(true);\n  }\n}\n\nexport class BlockFormattingContext\n  implements LayoutProcessor.BlockFormattingContext\n{\n  formattingContextType: FormattingContextType = \"Block\";\n\n  constructor(private readonly parent: Vtree.FormattingContext) {}\n\n  /** @override */\n  getName(): string {\n    return \"Block formatting context (BlockFormattingContext)\";\n  }\n\n  /** @override */\n  isFirstTime(nodeContext: Vtree.NodeContext, firstTime: boolean): boolean {\n    return firstTime;\n  }\n\n  /** @override */\n  getParent(): Vtree.FormattingContext {\n    return this.parent;\n  }\n\n  /** @override */\n  saveState(): any {}\n\n  /** @override */\n  restoreState(state: any) {}\n}\n\nexport const blockLayoutProcessor = new BlockLayoutProcessor();\n\nexport const isInstanceOfBlockFormattingContext =\n  LayoutProcessor.isInstanceOfBlockFormattingContext;\n\nPlugin.registerHook(\n  Plugin.HOOKS.RESOLVE_FORMATTING_CONTEXT,\n  (nodeContext, firstTime, display, position, floatSide, isRoot) => {\n    const parent = nodeContext.parent;\n    if (!parent && nodeContext.formattingContext) {\n      return null;\n    } else if (\n      parent &&\n      nodeContext.formattingContext !== parent.formattingContext\n    ) {\n      return null;\n    } else if (\n      nodeContext.establishesBFC ||\n      (!nodeContext.formattingContext &&\n        Display.isBlock(display, position, floatSide, isRoot))\n    ) {\n      return new BlockFormattingContext(\n        parent ? parent.formattingContext : null,\n      );\n    } else {\n      return null;\n    }\n  },\n);\n\nPlugin.registerHook(\n  Plugin.HOOKS.RESOLVE_LAYOUT_PROCESSOR,\n  (formattingContext) => {\n    if (formattingContext instanceof BlockFormattingContext) {\n      return blockLayoutProcessor;\n    }\n    return null;\n  },\n);\n", "/**\n * Copyright 2019 Vivliostyle Foundation\n *\n * Vivliostyle.js is free software: you can redistribute it and/or modify\n * it under the terms of the GNU Affero General Public License as published by\n * the Free Software Foundation, either version 3 of the License, or\n * (at your option) any later version.\n *\n * Vivliostyle.js is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n * GNU Affero General Public License for more details.\n *\n * You should have received a copy of the GNU Affero General Public License\n * along with Vivliostyle.js.  If not, see <http://www.gnu.org/licenses/>.\n *\n * @fileoverview LayoutRetryers - Definitions of LayoutRetryer.\n */\nimport * as Asserts from \"./asserts\";\nimport * as Task from \"./task\";\nimport { Layout, Vtree } from \"./types\";\n\n/**\n * @abstract\n */\nexport abstract class AbstractLayoutRetryer {\n  initialBreakPositions: Layout.BreakPosition[] = null;\n  initialStateOfFormattingContext: Vtree.NodeContext = null;\n  initialPosition: Vtree.NodeContext;\n  initialFragmentLayoutConstraints: Layout.FragmentLayoutConstraint[];\n\n  layout(\n    nodeContext: Vtree.NodeContext,\n    column: Layout.Column,\n  ): Task.Result<Vtree.NodeContext> {\n    this.prepareLayout(nodeContext, column);\n    return this.tryLayout(nodeContext, column);\n  }\n\n  private tryLayout(\n    nodeContext: Vtree.NodeContext,\n    column: Layout.Column,\n  ): Task.Result<Vtree.NodeContext> {\n    const frame = Task.newFrame<Vtree.NodeContext>(\n      \"AbstractLayoutRetryer.tryLayout\",\n    );\n    this.saveState(nodeContext, column);\n    const mode = this.resolveLayoutMode(nodeContext);\n    mode.doLayout(nodeContext, column).then((positionAfter) => {\n      let accepted = mode.accept(positionAfter, column);\n      accepted = mode.postLayout(\n        positionAfter,\n        this.initialPosition,\n        column,\n        accepted,\n      );\n      if (accepted) {\n        frame.finish(positionAfter);\n      } else {\n        Asserts.assert(this.initialPosition);\n        this.clearNodes(this.initialPosition);\n        this.restoreState(nodeContext, column);\n        this.tryLayout(this.initialPosition, column).thenFinish(frame);\n      }\n    });\n    return frame.result();\n  }\n\n  /**\n   * @abstract\n   */\n  abstract resolveLayoutMode(nodeContext: Vtree.NodeContext): Layout.LayoutMode;\n\n  prepareLayout(nodeContext: Vtree.NodeContext, column: Layout.Column) {}\n\n  clearNodes(initialPosition: Vtree.NodeContext) {\n    const viewNode =\n      initialPosition.viewNode || initialPosition.parent.viewNode;\n    let child: Node;\n    while ((child = viewNode.lastChild)) {\n      viewNode.removeChild(child);\n    }\n    let sibling: Node;\n    while ((sibling = viewNode.nextSibling)) {\n      sibling.parentNode.removeChild(sibling);\n    }\n  }\n\n  saveState(nodeContext: Vtree.NodeContext, column: Layout.Column) {\n    this.initialPosition = nodeContext.copy();\n    this.initialBreakPositions = [].concat(column.breakPositions);\n    this.initialFragmentLayoutConstraints = [].concat(\n      column.fragmentLayoutConstraints,\n    );\n    if (nodeContext.formattingContext) {\n      this.initialStateOfFormattingContext =\n        nodeContext.formattingContext.saveState();\n    }\n  }\n\n  restoreState(nodeContext: Vtree.NodeContext, column: Layout.Column) {\n    column.breakPositions = this.initialBreakPositions;\n    column.fragmentLayoutConstraints = this.initialFragmentLayoutConstraints;\n    if (nodeContext.formattingContext) {\n      nodeContext.formattingContext.restoreState(\n        this.initialStateOfFormattingContext,\n      );\n    }\n  }\n}\n", "/**\n * Copyright 2016 Daishinsha Inc.\n * Copyright 2019 Vivliostyle Foundation\n *\n * Vivliostyle.js is free software: you can redistribute it and/or modify\n * it under the terms of the GNU Affero General Public License as published by\n * the Free Software Foundation, either version 3 of the License, or\n * (at your option) any later version.\n *\n * Vivliostyle.js is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n * GNU Affero General Public License for more details.\n *\n * You should have received a copy of the GNU Affero General Public License\n * along with Vivliostyle.js.  If not, see <http://www.gnu.org/licenses/>.\n *\n * @fileoverview LayoutUtil - Utilities related to layout.\n */\nimport * as Break from \"./break\";\nimport * as Task from \"./task\";\nimport * as VtreeImpl from \"./vtree\";\nimport { Layout, Vtree } from \"./types\";\n\nexport type LayoutIteratorState = {\n  nodeContext: Vtree.NodeContext;\n  atUnforcedBreak: boolean;\n  break: boolean;\n  leadingEdge?: boolean;\n  breakAtTheEdge?: string | null;\n  onStartEdges?: boolean;\n  leadingEdgeContexts?: Vtree.NodeContext[];\n  lastAfterNodeContext?: Vtree.NodeContext | null;\n};\n\nexport class LayoutIteratorStrategy {\n  initialState(initialNodeContext: Vtree.NodeContext): LayoutIteratorState {\n    return {\n      nodeContext: initialNodeContext,\n      atUnforcedBreak: false,\n      break: false,\n    };\n  }\n\n  startNonDisplayableNode(\n    state: LayoutIteratorState,\n  ): void | Task.Result<boolean> {}\n\n  afterNonDisplayableNode(\n    state: LayoutIteratorState,\n  ): void | Task.Result<boolean> {}\n\n  startIgnoredTextNode(\n    state: LayoutIteratorState,\n  ): void | Task.Result<boolean> {}\n\n  afterIgnoredTextNode(\n    state: LayoutIteratorState,\n  ): void | Task.Result<boolean> {}\n\n  startNonElementNode(\n    state: LayoutIteratorState,\n  ): void | Task.Result<boolean> {}\n\n  afterNonElementNode(\n    state: LayoutIteratorState,\n  ): void | Task.Result<boolean> {}\n\n  startInlineElementNode(\n    state: LayoutIteratorState,\n  ): void | Task.Result<boolean> {}\n\n  afterInlineElementNode(\n    state: LayoutIteratorState,\n  ): void | Task.Result<boolean> {}\n\n  startNonInlineElementNode(\n    state: LayoutIteratorState,\n  ): void | Task.Result<boolean> {}\n\n  afterNonInlineElementNode(\n    state: LayoutIteratorState,\n  ): void | Task.Result<boolean> {}\n\n  finish(state: LayoutIteratorState): void | Task.Result<boolean> {}\n}\n\nexport class LayoutIterator {\n  constructor(\n    private readonly strategy: LayoutIteratorStrategy,\n    private readonly layoutContext: Vtree.LayoutContext,\n  ) {}\n\n  iterate(\n    initialNodeContext: Vtree.NodeContext,\n  ): Task.Result<Vtree.NodeContext> {\n    const strategy = this.strategy;\n    const state = strategy.initialState(initialNodeContext);\n    const frame: Task.Frame<Vtree.NodeContext> =\n      Task.newFrame(\"LayoutIterator\");\n    frame\n      .loopWithFrame((loopFrame) => {\n        let r: void | Task.Result<boolean>;\n        while (state.nodeContext) {\n          if (!state.nodeContext.viewNode) {\n            if (state.nodeContext.after) {\n              r = strategy.afterNonDisplayableNode(state);\n            } else {\n              r = strategy.startNonDisplayableNode(state);\n            }\n          } else if (state.nodeContext.viewNode.nodeType !== 1) {\n            if (\n              VtreeImpl.canIgnore(\n                state.nodeContext.viewNode,\n                state.nodeContext.whitespace,\n              )\n            ) {\n              if (state.nodeContext.after) {\n                r = strategy.afterIgnoredTextNode(state);\n              } else {\n                r = strategy.startIgnoredTextNode(state);\n              }\n            } else {\n              if (state.nodeContext.after) {\n                r = strategy.afterNonElementNode(state);\n              } else {\n                r = strategy.startNonElementNode(state);\n              }\n            }\n          } else {\n            if (state.nodeContext.inline) {\n              if (state.nodeContext.after) {\n                r = strategy.afterInlineElementNode(state);\n              } else {\n                r = strategy.startInlineElementNode(state);\n              }\n            } else {\n              if (state.nodeContext.after) {\n                r = strategy.afterNonInlineElementNode(state);\n              } else {\n                r = strategy.startNonInlineElementNode(state);\n              }\n            }\n          }\n          const cont = r && r.isPending() ? r : Task.newResult(true);\n          const nextResult = cont.thenAsync(() => {\n            if (state.break) {\n              return Task.newResult(null);\n            }\n            return this.layoutContext.nextInTree(\n              state.nodeContext,\n              state.atUnforcedBreak,\n            );\n          });\n          if (nextResult.isPending()) {\n            nextResult.then((nextNodeContext) => {\n              if (state.break) {\n                loopFrame.breakLoop();\n              } else {\n                state.nodeContext = nextNodeContext;\n                loopFrame.continueLoop();\n              }\n            });\n            return;\n          } else if (state.break) {\n            loopFrame.breakLoop();\n            return;\n          } else {\n            state.nodeContext = nextResult.get();\n          }\n        }\n        strategy.finish(state);\n        loopFrame.breakLoop();\n      })\n      .then(() => {\n        frame.finish(state.nodeContext);\n      });\n    return frame.result();\n  }\n}\n\nexport class EdgeSkipper extends LayoutIteratorStrategy {\n  constructor(protected readonly leadingEdge?: boolean) {\n    super();\n  }\n\n  startNonInlineBox(state: LayoutIteratorState): void | Task.Result<boolean> {}\n\n  endEmptyNonInlineBox(\n    state: LayoutIteratorState,\n  ): void | Task.Result<boolean> {}\n\n  endNonInlineBox(state: LayoutIteratorState): void | Task.Result<boolean> {}\n\n  initialState(initialNodeContext: Vtree.NodeContext): LayoutIteratorState {\n    return {\n      nodeContext: initialNodeContext,\n      atUnforcedBreak: !!this.leadingEdge && initialNodeContext.after,\n      break: false,\n      leadingEdge: this.leadingEdge,\n      breakAtTheEdge: null,\n      onStartEdges: false,\n      leadingEdgeContexts: [],\n      lastAfterNodeContext: null,\n    };\n  }\n\n  /**\n   * @return Returns true if a forced break occurs.\n   */\n  processForcedBreak(\n    state: LayoutIteratorState,\n    column: Layout.Column,\n  ): boolean {\n    const needForcedBreak =\n      !state.leadingEdge && Break.isForcedBreakValue(state.breakAtTheEdge);\n    if (needForcedBreak) {\n      const nodeContext = (state.nodeContext =\n        state.leadingEdgeContexts[0] || state.nodeContext);\n      nodeContext.viewNode.parentNode.removeChild(nodeContext.viewNode);\n      column.pageBreakType = state.breakAtTheEdge;\n    }\n    return needForcedBreak;\n  }\n\n  /**\n   * @return Returns true if the node overflows the column.\n   */\n  saveEdgeAndProcessOverflow(\n    state: LayoutIteratorState,\n    column: Layout.Column,\n  ): boolean {\n    const overflow = column.checkOverflowAndSaveEdgeAndBreakPosition(\n      state.lastAfterNodeContext,\n      null,\n      true,\n      state.breakAtTheEdge,\n    );\n    if (overflow) {\n      state.nodeContext = (\n        state.lastAfterNodeContext || state.nodeContext\n      ).modify();\n      state.nodeContext.overflow = true;\n    }\n    return overflow;\n  }\n\n  /**\n   * @returns Returns true if the layout constraint is violated.\n   */\n  processLayoutConstraint(\n    state: LayoutIteratorState,\n    layoutConstraint: Layout.LayoutConstraint,\n    column: Layout.Column,\n  ): boolean {\n    let nodeContext = state.nodeContext;\n    const violateConstraint = !layoutConstraint.allowLayout(nodeContext);\n    if (violateConstraint) {\n      column.checkOverflowAndSaveEdgeAndBreakPosition(\n        state.lastAfterNodeContext,\n        null,\n        false,\n        state.breakAtTheEdge,\n      );\n      nodeContext = state.nodeContext = nodeContext.modify();\n      nodeContext.overflow = true;\n    }\n    return violateConstraint;\n  }\n\n  override startNonElementNode(\n    state: LayoutIteratorState,\n  ): void | Task.Result<boolean> {\n    state.onStartEdges = false;\n  }\n\n  override startNonInlineElementNode(\n    state: LayoutIteratorState,\n  ): void | Task.Result<boolean> {\n    state.leadingEdgeContexts.push(state.nodeContext.copy());\n    state.breakAtTheEdge = Break.resolveEffectiveBreakValue(\n      state.breakAtTheEdge,\n      state.nodeContext.breakBefore,\n    );\n    state.onStartEdges = true;\n    return this.startNonInlineBox(state);\n  }\n\n  override afterNonInlineElementNode(\n    state: LayoutIteratorState,\n  ): void | Task.Result<boolean> {\n    let r: void | Task.Result<boolean>;\n    let cont: Task.Result<boolean>;\n    if (state.onStartEdges) {\n      r = this.endEmptyNonInlineBox(state);\n      cont = r && r.isPending() ? r : Task.newResult(true);\n      cont = cont.thenAsync(() => {\n        if (!state.break) {\n          state.leadingEdgeContexts = [];\n          state.leadingEdge = false;\n          state.atUnforcedBreak = false;\n          state.breakAtTheEdge = null;\n        }\n        return Task.newResult(true);\n      });\n    } else {\n      r = this.endNonInlineBox(state);\n      cont = r && r.isPending() ? r : Task.newResult(true);\n    }\n    return cont.thenAsync(() => {\n      if (!state.break) {\n        state.onStartEdges = false;\n        state.lastAfterNodeContext = state.nodeContext.copy();\n        state.breakAtTheEdge = Break.resolveEffectiveBreakValue(\n          state.breakAtTheEdge,\n          state.nodeContext.breakAfter,\n        );\n      }\n      return Task.newResult(true);\n    });\n  }\n}\n", "/**\n * Copyright 2019 Vivliostyle Foundation\n *\n * Vivliostyle.js is free software: you can redistribute it and/or modify\n * it under the terms of the GNU Affero General Public License as published by\n * the Free Software Foundation, either version 3 of the License, or\n * (at your option) any later version.\n *\n * Vivliostyle.js is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n * GNU Affero General Public License for more details.\n *\n * You should have received a copy of the GNU Affero General Public License\n * along with Vivliostyle.js.  If not, see <http://www.gnu.org/licenses/>.\n *\n * @fileoverview Shared - Global variables of Vivliostyle.js\n */\nimport { RepetitiveElement } from \"./types\";\n\nexport let repetitiveElementsCache: {\n  root: Element;\n  elements: RepetitiveElement.RepetitiveElements;\n}[] = [];\n\nexport function clearRepetitiveElementsCache(): void {\n  repetitiveElementsCache = [];\n}\n", "/**\n * Copyright 2019 Vivliostyle Foundation\n *\n * Vivliostyle.js is free software: you can redistribute it and/or modify\n * it under the terms of the GNU Affero General Public License as published by\n * the Free Software Foundation, either version 3 of the License, or\n * (at your option) any later version.\n *\n * Vivliostyle.js is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n * GNU Affero General Public License for more details.\n *\n * You should have received a copy of the GNU Affero General Public License\n * along with Vivliostyle.js.  If not, see <http://www.gnu.org/licenses/>.\n *\n * @fileoverview Matchers - Definitions of Matcher.\n */\nimport * as Asserts from \"./asserts\";\n\n/**\n * Checkes whether given order can be represented as an+b with a non-negative\n * interger n\n */\nexport function matchANPlusB(order: number, a: number, b: number): boolean {\n  order -= b;\n  if (a === 0) {\n    return order === 0;\n  } else {\n    return order % a === 0 && order / a >= 0;\n  }\n}\n\nexport interface Matcher {\n  matches(): boolean;\n}\n\nexport class AnyMatcher implements Matcher {\n  constructor(public readonly matchers: Matcher[]) {}\n\n  /** @override */\n  matches(): boolean {\n    return this.matchers.some((matcher) => matcher.matches());\n  }\n}\n\nexport class AllMatcher implements Matcher {\n  constructor(public readonly matchers: Matcher[]) {}\n\n  /** @override */\n  matches(): boolean {\n    return this.matchers.every((matcher) => matcher.matches());\n  }\n}\n\nexport class NthFragmentMatcher implements Matcher {\n  static fragmentIndices = {};\n\n  static registerFragmentIndex(\n    elementOffset: number,\n    fragmentIndex: number,\n    priority: number,\n  ) {\n    const indices = NthFragmentMatcher.fragmentIndices;\n    if (\n      !indices[elementOffset] ||\n      indices[elementOffset].priority <= priority\n    ) {\n      indices[elementOffset] = { fragmentIndex, priority };\n    }\n  }\n\n  static clearFragmentIndices() {\n    NthFragmentMatcher.fragmentIndices = {};\n  }\n\n  constructor(\n    public readonly elementOffset: number,\n    public readonly a: number,\n    public readonly b: number,\n  ) {}\n\n  /** @override */\n  matches(): boolean {\n    const entry = NthFragmentMatcher.fragmentIndices[this.elementOffset];\n    return (\n      entry != null &&\n      entry.fragmentIndex != null &&\n      matchANPlusB(entry.fragmentIndex, this.a, this.b)\n    );\n  }\n}\n\nexport class MatcherBuilder {\n  static buildViewConditionMatcher(\n    elementOffset: number,\n    viewCondition: string,\n  ): Matcher {\n    const strs = viewCondition.split(\"_\");\n    if (strs[0] == \"NFS\") {\n      return new NthFragmentMatcher(\n        elementOffset,\n        parseInt(strs[1], 10),\n        parseInt(strs[2], 10),\n      );\n    } else {\n      Asserts.fail(`unknown view condition. condition=${viewCondition}`);\n      return null;\n    }\n  }\n\n  static buildAllMatcher(matchers: Matcher[]): Matcher {\n    return new AllMatcher(matchers);\n  }\n\n  static buildAnyMatcher(matchers: Matcher[]): Matcher {\n    return new AnyMatcher(matchers);\n  }\n}\n", "/**\n * Copyright 2013 Google, Inc.\n * Copyright 2015 Daishinsha Inc.\n * Copyright 2019 Vivliostyle Foundation\n *\n * Vivliostyle.js is free software: you can redistribute it and/or modify\n * it under the terms of the GNU Affero General Public License as published by\n * the Free Software Foundation, either version 3 of the License, or\n * (at your option) any later version.\n *\n * Vivliostyle.js is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n * GNU Affero General Public License for more details.\n *\n * You should have received a copy of the GNU Affero General Public License\n * along with Vivliostyle.js.  If not, see <http://www.gnu.org/licenses/>.\n *\n * @fileoverview CssCascade - CSS Cascade.\n */\nimport * as Asserts from \"./asserts\";\nimport * as Base from \"./base\";\nimport * as CounterStyle from \"./counter-style\";\nimport * as Css from \"./css\";\nimport * as CssParser from \"./css-parser\";\nimport * as CssProp from \"./css-prop\";\nimport * as CssTokenizer from \"./css-tokenizer\";\nimport * as CssValidator from \"./css-validator\";\nimport * as Display from \"./display\";\nimport * as Exprs from \"./exprs\";\nimport * as LayoutHelper from \"./layout-helper\";\nimport * as Logging from \"./logging\";\nimport * as Matchers from \"./matchers\";\nimport * as Plugin from \"./plugin\";\nimport * as Vtree from \"./vtree\";\nimport { CssStyler, Layout } from \"./types\";\nimport { TokenType } from \"./css-tokenizer\";\nimport { AbstractStyler } from \"./css-styler\";\n\nexport type ElementStyle = {\n  [key: string]:\n    | CascadeValue\n    | CascadeValue[]\n    | ElementStyleMap\n    | { matcher: Matchers.Matcher; styles: ElementStyle }[];\n};\n\nexport const inheritedProps = {\n  \"border-collapse\": true,\n  \"border-spacing\": true,\n  \"caption-side\": true,\n  \"clip-rule\": true,\n  color: true,\n  \"color-interpolation\": true,\n  \"color-rendering\": true,\n  cursor: true,\n  direction: true,\n  \"empty-cells\": true,\n  fill: true,\n  \"fill-opacity\": true,\n  \"fill-rule\": true,\n  \"font-kerning\": true,\n  \"font-size\": true,\n  \"font-size-adjust\": true,\n  \"font-family\": true,\n  \"font-feature-settings\": true,\n  \"font-style\": true,\n  \"font-stretch\": true,\n  \"font-variant-ligatures\": true,\n  \"font-variant-caps\": true,\n  \"font-variant-numeric\": true,\n  \"font-variant-east-asian\": true,\n  \"font-weight\": true,\n  \"glyph-orientation-vertical\": true,\n  \"hanging-punctuation\": true,\n  hyphens: true,\n  \"hyphenate-character\": true,\n  \"hyphenate-limit-chars\": true,\n  \"hyphenate-limit-last\": true,\n  \"image-rendering\": true,\n  \"image-resolution\": true,\n  \"letter-spacing\": true,\n  \"line-break\": true,\n  \"line-height\": true,\n  \"list-style-image\": true,\n  \"list-style-position\": true,\n  \"list-style-type\": true,\n  marker: true,\n  \"marker-end\": true,\n  \"marker-mid\": true,\n  \"marker-start\": true,\n  orphans: true,\n  \"overflow-wrap\": true,\n  \"paint-order\": true,\n  \"pointer-events\": true,\n  quotes: true,\n  \"ruby-align\": true,\n  \"ruby-position\": true,\n  \"shape-rendering\": true,\n  stroke: true,\n  \"stroke-dasharray\": true,\n  \"stroke-dashoffset\": true,\n  \"stroke-linecap\": true,\n  \"stroke-linejoin\": true,\n  \"stroke-miterlimit\": true,\n  \"stroke-opacity\": true,\n  \"stroke-width\": true,\n  \"tab-size\": true,\n  \"text-align\": true,\n  \"text-align-last\": true,\n  \"text-anchor\": true,\n  \"text-autospace\": true,\n  \"text-decoration-skip\": true,\n  \"text-decoration-skip-ink\": true,\n  \"text-emphasis-color\": true,\n  \"text-emphasis-position\": true,\n  \"text-emphasis-style\": true,\n  \"text-fill-color\": true,\n  \"text-combine-upright\": true,\n  \"text-indent\": true,\n  \"text-justify\": true,\n  \"text-orientation\": true,\n  \"text-rendering\": true,\n  \"text-shadow\": true,\n  \"text-size-adjust\": true,\n  \"text-spacing-trim\": true,\n  \"text-stroke-color\": true,\n  \"text-stroke-width\": true,\n  \"text-transform\": true,\n  \"text-underline-offset\": true,\n  \"text-underline-position\": true,\n  \"text-wrap\": true,\n  \"text-wrap-mode\": true,\n  \"text-wrap-style\": true,\n  visibility: true,\n  \"white-space\": true,\n  widows: true,\n  \"word-break\": true,\n  \"word-spacing\": true,\n  \"writing-mode\": true,\n};\n\nexport const polyfilledInheritedProps = [\n  \"image-resolution\",\n  \"orphans\",\n  \"widows\",\n];\n\nexport function getPolyfilledInheritedProps(): string[] {\n  const hooks: Plugin.PolyfilledInheritedPropsHook[] = Plugin.getHooksForName(\n    Plugin.HOOKS.POLYFILLED_INHERITED_PROPS,\n  );\n  return hooks.reduce(\n    (props, f) => props.concat(f()),\n    [].concat(polyfilledInheritedProps),\n  );\n}\n\nexport const supportedNamespaces = {\n  \"http://www.idpf.org/2007/ops\": true,\n  \"http://www.w3.org/1999/xhtml\": true,\n  \"http://www.w3.org/2000/svg\": true,\n  \"http://www.w3.org/1998/Math/MathML\": true,\n};\n\nexport const coupledPatterns = [\n  \"margin-%\",\n  \"padding-%\",\n  \"border-%-width\",\n  \"border-%-style\",\n  \"border-%-color\",\n  \"%\",\n];\n\nexport const coupledExtentPatterns = [\"max-%\", \"min-%\", \"%\"];\n\nexport const geomNames: { [key: string]: boolean } = (() => {\n  const sides = [\"left\", \"right\", \"top\", \"bottom\"];\n  const names = {\n    width: true,\n    height: true,\n    \"max-width\": true,\n    \"max-height\": true,\n    \"min-width\": true,\n    \"min-height\": true,\n  };\n  for (let i = 0; i < coupledPatterns.length; i++) {\n    for (let k = 0; k < sides.length; k++) {\n      const name = coupledPatterns[i].replace(\"%\", sides[k]);\n      names[name] = true;\n    }\n  }\n  return names;\n})();\n\nexport function buildCouplingMap(\n  sideMap: { [key: string]: string },\n  extentMap: { [key: string]: string },\n): { [key: string]: string } {\n  const map: { [key: string]: string } = {};\n  for (const pattern of coupledPatterns) {\n    for (const side in sideMap) {\n      const name1 = pattern.replace(\"%\", side);\n      const name2 = pattern.replace(\"%\", sideMap[side]);\n      map[name1] = name2;\n      map[name2] = name1;\n    }\n  }\n  for (const extentPattern of coupledExtentPatterns) {\n    for (const extent in extentMap) {\n      const name1 = extentPattern.replace(\"%\", extent);\n      const name2 = extentPattern.replace(\"%\", extentMap[extent]);\n      map[name1] = name2;\n      map[name2] = name1;\n    }\n  }\n  return map;\n}\n\nexport const couplingMapVert = buildCouplingMap(\n  {\n    \"block-start\": \"right\",\n    \"block-end\": \"left\",\n    \"inline-start\": \"top\",\n    \"inline-end\": \"bottom\",\n  },\n  { \"block-size\": \"width\", \"inline-size\": \"height\" },\n);\n\nexport const couplingMapHor = buildCouplingMap(\n  {\n    \"block-start\": \"top\",\n    \"block-end\": \"bottom\",\n    \"inline-start\": \"left\",\n    \"inline-end\": \"right\",\n  },\n  { \"block-size\": \"height\", \"inline-size\": \"width\" },\n);\n\nexport const couplingMapVertRtl = buildCouplingMap(\n  {\n    \"block-start\": \"right\",\n    \"block-end\": \"left\",\n    \"inline-start\": \"bottom\",\n    \"inline-end\": \"top\",\n  },\n  { \"block-size\": \"width\", \"inline-size\": \"height\" },\n);\n\nexport const couplingMapHorRtl = buildCouplingMap(\n  {\n    \"block-start\": \"top\",\n    \"block-end\": \"bottom\",\n    \"inline-start\": \"right\",\n    \"inline-end\": \"left\",\n  },\n  { \"block-size\": \"height\", \"inline-size\": \"width\" },\n);\n\nconst couplingMapLeftPage = buildCouplingMap(\n  { inside: \"right\", outside: \"left\" },\n  {},\n);\n\nconst couplingMapRightPage = buildCouplingMap(\n  { inside: \"left\", outside: \"right\" },\n  {},\n);\n\nexport class CascadeValue {\n  constructor(\n    public readonly value: Css.Val,\n    public readonly priority: number,\n  ) {}\n\n  getBaseValue(): CascadeValue {\n    return this;\n  }\n\n  filterValue(visitor: Css.Visitor): CascadeValue {\n    const value = this.value.visit(visitor);\n    if (value === this.value) {\n      return this;\n    }\n    return new CascadeValue(value, this.priority);\n  }\n\n  increaseSpecificity(specificity: number): CascadeValue {\n    if (specificity == 0) {\n      return this;\n    }\n    return new CascadeValue(this.value, this.priority + specificity);\n  }\n\n  evaluate(\n    context: Exprs.Context,\n    propName?: string,\n    percentRef?: number,\n    vertical?: boolean,\n  ): Css.Val {\n    if (propName && Css.isCustomPropName(propName)) {\n      return this.value;\n    }\n    return evaluateCSSToCSS(\n      context,\n      this.value,\n      propName,\n      percentRef,\n      vertical,\n    );\n  }\n\n  isEnabled(context: Exprs.Context): boolean {\n    return true;\n  }\n}\n\n/**\n * Internal subclass of CascadeValue. Should never be seen outside of the\n * cascade engine.\n */\nexport class ConditionalCascadeValue extends CascadeValue {\n  constructor(\n    value: Css.Val,\n    priority: number,\n    public readonly condition: Exprs.Val,\n  ) {\n    super(value, priority);\n  }\n\n  override getBaseValue(): CascadeValue {\n    return new CascadeValue(this.value, this.priority);\n  }\n\n  override filterValue(visitor: Css.Visitor): CascadeValue {\n    const value = this.value.visit(visitor);\n    if (value === this.value) {\n      return this;\n    }\n    return new ConditionalCascadeValue(value, this.priority, this.condition);\n  }\n\n  override increaseSpecificity(specificity: number): CascadeValue {\n    if (specificity == 0) {\n      return this;\n    }\n    return new ConditionalCascadeValue(\n      this.value,\n      this.priority + specificity,\n      this.condition,\n    );\n  }\n\n  isEnabled(context: Exprs.Context): boolean {\n    try {\n      return !!this.condition.evaluate(context);\n    } catch (err) {\n      Logging.logger.warn(err);\n    }\n    return false;\n  }\n}\n\n/**\n * @param tv current value (cannot be conditional)\n * @param av cascaded value (can be conditional)\n */\nexport function cascadeValues(\n  context: Exprs.Context,\n  tv: CascadeValue,\n  av: CascadeValue,\n): CascadeValue {\n  if ((!tv || av.priority >= tv.priority) && av.isEnabled(context)) {\n    return av.getBaseValue();\n  }\n  return tv;\n}\n\n/**\n * setProp with priority checking.\n * If context is given it is same as\n * setProp(style, name, cascadeValues(context, getProp(style, name), value))\n */\nexport function setPropCascadeValue(\n  style: ElementStyle,\n  name: string,\n  value: CascadeValue,\n  context?: Exprs.Context,\n): void {\n  if (!style) {\n    return;\n  }\n  if (!value) {\n    delete style[name];\n  } else {\n    const tv = style[name] as CascadeValue;\n    if (!tv || value.priority >= tv.priority) {\n      if (context) {\n        if (value.isEnabled(context)) {\n          style[name] = value.getBaseValue();\n        }\n      } else {\n        style[name] = value;\n      }\n    }\n  }\n}\n\nexport type ElementStyleMap = {\n  [key: string]: ElementStyle;\n};\n\nexport const SPECIALS = {\n  \"region-id\": true,\n  \"fragment-selector-id\": true,\n};\n\nexport function isSpecialName(name: string): boolean {\n  return !!SPECIALS[name];\n}\n\nexport function isMapName(name: string): boolean {\n  return name.charAt(0) === \"_\" && name !== \"_viewConditionalStyles\";\n}\n\nexport function isPropName(name: string): boolean {\n  return name.charAt(0) !== \"_\" && !SPECIALS[name];\n}\n\nexport function isInherited(name: string): boolean {\n  return !!inheritedProps[name] || Css.isCustomPropName(name);\n}\n\nexport function getProp(style: ElementStyle, name: string): CascadeValue {\n  return style[name] as CascadeValue;\n}\n\nexport function setProp(\n  style: ElementStyle,\n  name: string,\n  value: CascadeValue,\n): void {\n  if (!value) {\n    delete style[name];\n  } else {\n    style[name] = value;\n  }\n}\n\nexport function getStyleMap(\n  style: ElementStyle,\n  name: string,\n): ElementStyleMap {\n  return style[name] as ElementStyleMap;\n}\n\nexport function getMutableStyleMap(\n  style: ElementStyle,\n  name: string,\n): ElementStyleMap {\n  let r = style[name] as ElementStyleMap;\n  if (!r) {\n    r = {};\n    style[name] = r;\n  }\n  return r;\n}\n\nexport const getViewConditionalStyleMap = (\n  style: ElementStyle,\n): { matcher: Matchers.Matcher; styles: ElementStyle }[] => {\n  let r = style[\"_viewConditionalStyles\"] as {\n    matcher: Matchers.Matcher;\n    styles: ElementStyle;\n  }[];\n  if (!r) {\n    r = [];\n    style[\"_viewConditionalStyles\"] = r;\n  }\n  return r;\n};\n\nexport function getSpecial(style: ElementStyle, name: string): CascadeValue[] {\n  return style[name] as CascadeValue[];\n}\n\nexport function getMutableSpecial(\n  style: ElementStyle,\n  name: string,\n): CascadeValue[] {\n  let r = style[name] as CascadeValue[];\n  if (!r) {\n    r = [];\n    style[name] = r;\n  }\n  return r;\n}\n\nexport function mergeIn(\n  context: Exprs.Context,\n  target: ElementStyle,\n  style: ElementStyle,\n  specificity: number,\n  pseudoelement: string | null,\n  regionId: string | null,\n  viewConditionMatcher: Matchers.Matcher | null,\n): void {\n  const hierarchy = [\n    { id: pseudoelement, styleKey: \"_pseudos\" },\n    { id: regionId, styleKey: \"_regions\" },\n  ];\n  hierarchy.forEach((item) => {\n    if (item.id) {\n      const styleMap = getMutableStyleMap(target, item.styleKey);\n      target = styleMap[item.id];\n      if (!target) {\n        target = {} as ElementStyle;\n        styleMap[item.id] = target;\n      }\n    }\n  });\n  if (viewConditionMatcher) {\n    const styleMap = getViewConditionalStyleMap(target);\n    target = {} as ElementStyle;\n    styleMap.push({\n      styles: target,\n      matcher: viewConditionMatcher,\n    });\n  }\n  for (const prop in style) {\n    if (isMapName(prop)) {\n      continue;\n    }\n    if (isSpecialName(prop)) {\n      // special properties: list of all assigned values\n      const as = getSpecial(style, prop);\n      const ts = getMutableSpecial(target, prop);\n      Array.prototype.push.apply(ts, as);\n    } else {\n      // regular properties: higher priority wins\n      const cascval = getProp(style, prop);\n      if (!cascval.isEnabled(context)) {\n        continue;\n      }\n      const av = cascval.increaseSpecificity(specificity);\n      setPropCascadeValue(target, prop, av, context);\n\n      // Expand shorthand property (its value contains variables).\n      const propListLH = (\n        context as Exprs.Context & {\n          style: { validatorSet: CssValidator.ValidatorSet };\n        }\n      ).style?.validatorSet.shorthands[prop]?.propList;\n      if (propListLH) {\n        for (const propLH of propListLH) {\n          const avLH = new CascadeValue(Css.empty, av.priority);\n          setPropCascadeValue(target, propLH, avLH, context);\n        }\n      }\n    }\n  }\n}\n\nexport function mergeAll(\n  context: Exprs.Context,\n  styles: ElementStyle[],\n): ElementStyle {\n  const target = {} as ElementStyle;\n  for (let k = 0; k < styles.length; k++) {\n    mergeIn(context, target, styles[k], 0, null, null, null);\n  }\n  return target;\n}\n\nexport function chainActions(\n  chain: ChainedAction[],\n  action: CascadeAction,\n): CascadeAction {\n  if (chain.length > 0) {\n    chain.sort((a, b) => b.getPriority() - a.getPriority());\n    let chained: ChainedAction | null = null;\n    for (let i = chain.length - 1; i >= 0; i--) {\n      chained = chain[i];\n      chained.chained = action;\n      action = chained;\n    }\n    return chained;\n  }\n  return action;\n}\n\nexport class InheritanceVisitor extends Css.FilterVisitor {\n  propName: string = \"\";\n\n  constructor(\n    public readonly props: ElementStyle,\n    public readonly context: Exprs.Context,\n  ) {\n    super();\n  }\n\n  setPropName(name: string): void {\n    this.propName = name;\n  }\n\n  private getFontSize() {\n    const cascval = getProp(this.props, \"font-size\");\n    if (!cascval.value.isNumeric()) {\n      // FIXME: cascval may be Ident value e.g. \"smaller\"\n      return Exprs.defaultUnitSizes[\"em\"];\n    }\n    const n = cascval.value as Css.Numeric;\n    if (!Exprs.isAbsoluteLengthUnit(n.unit)) {\n      throw new Error(\"Unexpected state\");\n    }\n    return n.num * Exprs.defaultUnitSizes[n.unit];\n  }\n\n  override visitNumeric(numeric: Css.Numeric): Css.Val {\n    Asserts.assert(this.context);\n    if (this.propName === \"font-size\") {\n      return convertFontSizeToPx(numeric, this.getFontSize(), this.context);\n    } else if (\n      numeric.unit === \"em\" ||\n      numeric.unit === \"rem\" ||\n      numeric.unit === \"lh\" ||\n      numeric.unit === \"rlh\"\n    ) {\n      return convertFontRelativeLengthToPx(\n        numeric,\n        this.getFontSize(),\n        this.context,\n      );\n    }\n    return numeric;\n  }\n\n  override visitExpr(expr: Css.Expr): Css.Val {\n    if (this.propName == \"font-size\") {\n      const val = evaluateCSSToCSS(this.context, expr, this.propName);\n      return val.visit(this);\n    }\n    return expr;\n  }\n}\n\nexport function convertFontRelativeLengthToPx(\n  numeric: Css.Numeric,\n  baseFontSize: number,\n  context: Exprs.Context,\n): Css.Numeric {\n  const unit = numeric.unit;\n  const num = numeric.num;\n  if (unit === \"em\") {\n    return new Css.Numeric(num * baseFontSize, \"px\");\n  } else if (unit === \"rem\") {\n    return new Css.Numeric(num * context.fontSize(), \"px\");\n  } else if (unit === \"rlh\") {\n    return new Css.Numeric(num * context.rootLineHeight, \"px\");\n  } else {\n    return numeric;\n  }\n}\n\nexport function convertFontSizeToPx(\n  numeric: Css.Numeric,\n  parentFontSize: number,\n  context: Exprs.Context,\n): Css.Numeric {\n  numeric = convertFontRelativeLengthToPx(numeric, parentFontSize, context);\n  const unit = numeric.unit;\n  const num = numeric.num;\n  if (unit === \"px\") {\n    return numeric;\n  } else if (unit === \"%\") {\n    return new Css.Numeric((num / 100) * parentFontSize, \"px\");\n  } else {\n    return new Css.Numeric(num * context.queryUnitSize(unit, false), \"px\");\n  }\n}\n\nexport type ActionTable = {\n  [key: string]: CascadeAction;\n};\n\nexport class CascadeAction {\n  apply(cascadeInstance: CascadeInstance): void {}\n\n  mergeWith(other: CascadeAction): CascadeAction {\n    return new CompoundAction([this, other]);\n  }\n\n  clone(): CascadeAction {\n    // Mutable actions will override\n    return this;\n  }\n}\n\nexport class ConditionItemAction extends CascadeAction {\n  constructor(public readonly conditionItem: ConditionItem) {\n    super();\n  }\n\n  override apply(cascadeInstance: CascadeInstance): void {\n    cascadeInstance.pushConditionItem(\n      this.conditionItem.fresh(cascadeInstance),\n    );\n  }\n}\n\nexport class CompoundAction extends CascadeAction {\n  constructor(public readonly list: CascadeAction[]) {\n    super();\n  }\n\n  override apply(cascadeInstance: CascadeInstance): void {\n    for (let i = 0; i < this.list.length; i++) {\n      this.list[i].apply(cascadeInstance);\n    }\n  }\n\n  override mergeWith(other: CascadeAction): CascadeAction {\n    this.list.push(other);\n    return this;\n  }\n\n  override clone(): CascadeAction {\n    return new CompoundAction([].concat(this.list));\n  }\n}\n\nexport class ApplyRuleAction extends CascadeAction {\n  constructor(\n    public readonly style: ElementStyle,\n    public readonly specificity: number,\n    public readonly pseudoelement: string | null,\n    public readonly regionId: string | null,\n    public readonly viewConditionId: string | null,\n  ) {\n    super();\n  }\n\n  override apply(cascadeInstance: CascadeInstance): void {\n    mergeIn(\n      cascadeInstance.context,\n      cascadeInstance.currentStyle,\n      this.style,\n      this.specificity,\n      this.pseudoelement,\n      this.regionId,\n      cascadeInstance.buildViewConditionMatcher(this.viewConditionId),\n    );\n  }\n}\n\nexport class ChainedAction extends CascadeAction {\n  chained: CascadeAction = null;\n\n  constructor() {\n    super();\n  }\n\n  override apply(cascadeInstance: CascadeInstance): void {\n    this.chained.apply(cascadeInstance);\n  }\n\n  getPriority(): number {\n    return 0;\n  }\n\n  makePrimary(cascade: Cascade): boolean {\n    // cannot be made primary\n    return false;\n  }\n}\n\nexport class CheckClassAction extends ChainedAction {\n  constructor(public readonly className: string) {\n    super();\n  }\n\n  override apply(cascadeInstance: CascadeInstance): void {\n    if (cascadeInstance.currentClassNames.includes(this.className)) {\n      this.chained.apply(cascadeInstance);\n    }\n  }\n\n  override getPriority(): number {\n    return 10;\n  }\n  // class should be checked after id\n\n  override makePrimary(cascade: Cascade): boolean {\n    if (this.chained) {\n      cascade.insertInTable(cascade.classes, this.className, this.chained);\n    }\n    return true;\n  }\n}\n\nexport class CheckIdAction extends ChainedAction {\n  constructor(public readonly id: string) {\n    super();\n  }\n\n  override apply(cascadeInstance: CascadeInstance): void {\n    if (\n      cascadeInstance.currentId == this.id ||\n      cascadeInstance.currentXmlId == this.id\n    ) {\n      this.chained.apply(cascadeInstance);\n    }\n  }\n\n  override getPriority(): number {\n    return 11;\n  }\n  // id should be checked after :root\n\n  override makePrimary(cascade: Cascade): boolean {\n    if (this.chained) {\n      cascade.insertInTable(cascade.ids, this.id, this.chained);\n    }\n    return true;\n  }\n}\n\nexport class CheckLocalNameAction extends ChainedAction {\n  constructor(public readonly localName: string) {\n    super();\n  }\n\n  override apply(cascadeInstance: CascadeInstance): void {\n    if (cascadeInstance.currentLocalName == this.localName) {\n      this.chained.apply(cascadeInstance);\n    }\n  }\n\n  override getPriority(): number {\n    return 8;\n  }\n  // tag is a pretty good thing to check, after epub:type\n\n  override makePrimary(cascade: Cascade): boolean {\n    if (this.chained) {\n      cascade.insertInTable(cascade.tags, this.localName, this.chained);\n    }\n    return true;\n  }\n}\n\nexport class CheckNSTagAction extends ChainedAction {\n  constructor(\n    public readonly ns: string,\n    public readonly localName: string,\n  ) {\n    super();\n  }\n\n  override apply(cascadeInstance: CascadeInstance): void {\n    if (\n      cascadeInstance.currentLocalName == this.localName &&\n      cascadeInstance.currentNamespace == this.ns\n    ) {\n      this.chained.apply(cascadeInstance);\n    }\n  }\n\n  override getPriority(): number {\n    return 8;\n  }\n  // tag is a pretty good thing to check, after epub:type\n\n  override makePrimary(cascade: Cascade): boolean {\n    if (this.chained) {\n      let prefix = cascade.nsPrefix[this.ns];\n      if (!prefix) {\n        prefix = `ns${cascade.nsCount++}:`;\n        cascade.nsPrefix[this.ns] = prefix;\n      }\n      const nsTag = prefix + this.localName;\n      cascade.insertInTable(cascade.nstags, nsTag, this.chained);\n    }\n    return true;\n  }\n}\n\nexport class CheckTargetEpubTypeAction extends ChainedAction {\n  constructor(\n    public readonly epubTypePatt: RegExp,\n    public readonly targetLocalName?: string,\n  ) {\n    super();\n  }\n\n  override apply(cascadeInstance: CascadeInstance): void {\n    const elem = cascadeInstance.currentElement;\n    if (elem instanceof HTMLAnchorElement) {\n      if (\n        elem.hash &&\n        elem.href == elem.baseURI.replace(/#.*$/, \"\") + elem.hash\n      ) {\n        const id = elem.hash.substring(1);\n        const target = elem.ownerDocument.getElementById(id);\n        if (\n          target &&\n          (!this.targetLocalName || target.localName == this.targetLocalName)\n        ) {\n          const epubType =\n            target.getAttributeNS(Base.NS.epub, \"type\") ||\n            target.getAttribute(\"epub:type\");\n          if (epubType && epubType.match(this.epubTypePatt)) {\n            this.chained.apply(cascadeInstance);\n          }\n        }\n      }\n    }\n  }\n}\n\nexport class CheckNamespaceAction extends ChainedAction {\n  constructor(public readonly ns: string) {\n    super();\n  }\n\n  override apply(cascadeInstance: CascadeInstance): void {\n    if (cascadeInstance.currentNamespace == this.ns) {\n      this.chained.apply(cascadeInstance);\n    }\n  }\n}\n\nfunction checkAttribute(\n  element: Element,\n  ns: string | null,\n  name: string,\n  pred: (element: Element, ns: string, name: string) => boolean,\n): boolean {\n  if (!element) {\n    return false;\n  }\n  if (ns !== null) {\n    return pred(element, ns, name);\n  }\n  // For wildcard namespace\n  for (const qname of element.getAttributeNames()) {\n    if (qname === name || qname.endsWith(`:${name}`)) {\n      if (\n        pred(\n          element,\n          qname === name ? \"\" : element.lookupNamespaceURI(qname.split(\":\")[0]),\n          name,\n        )\n      ) {\n        return true;\n      }\n    }\n  }\n  return false;\n}\n\nexport class CheckAttributePresentAction extends ChainedAction {\n  constructor(\n    public readonly ns: string,\n    public readonly name: string,\n  ) {\n    super();\n  }\n\n  override apply(cascadeInstance: CascadeInstance): void {\n    if (\n      checkAttribute(\n        cascadeInstance.currentElement,\n        this.ns,\n        this.name,\n        (element, ns, name) => element.hasAttributeNS(ns, name),\n      )\n    ) {\n      this.chained.apply(cascadeInstance);\n    }\n  }\n}\n\nexport class CheckAttributeEqAction extends ChainedAction {\n  constructor(\n    public readonly ns: string,\n    public readonly name: string,\n    public readonly value: string,\n  ) {\n    super();\n  }\n\n  override apply(cascadeInstance: CascadeInstance): void {\n    if (\n      checkAttribute(\n        cascadeInstance.currentElement,\n        this.ns,\n        this.name,\n        (element, ns, name) => element.getAttributeNS(ns, name) == this.value,\n      )\n    ) {\n      this.chained.apply(cascadeInstance);\n    }\n  }\n\n  override getPriority(): number {\n    if (this.name == \"type\" && this.ns == Base.NS.epub) {\n      return 9; // epub:type is a pretty good thing to check\n    }\n    return 0;\n  }\n\n  override makePrimary(cascade: Cascade): boolean {\n    if (this.name == \"type\" && this.ns == Base.NS.epub) {\n      if (this.chained) {\n        cascade.insertInTable(cascade.epubtypes, this.value, this.chained);\n      }\n      return true;\n    }\n    return false;\n  }\n}\n\nexport class CheckNamespaceSupportedAction extends ChainedAction {\n  constructor(\n    public readonly ns: string,\n    public readonly name: string,\n  ) {\n    super();\n  }\n\n  override apply(cascadeInstance: CascadeInstance): void {\n    if (\n      checkAttribute(\n        cascadeInstance.currentElement,\n        this.ns,\n        this.name,\n        (element, ns, name) =>\n          !!supportedNamespaces[element.getAttributeNS(ns, name)],\n      )\n    ) {\n      this.chained.apply(cascadeInstance);\n    }\n  }\n\n  override getPriority(): number {\n    return 0;\n  }\n\n  override makePrimary(cascade: Cascade): boolean {\n    return false;\n  }\n}\n\nexport class CheckAttributeRegExpAction extends ChainedAction {\n  constructor(\n    public readonly ns: string,\n    public readonly name: string,\n    public readonly regexp: RegExp,\n  ) {\n    super();\n  }\n\n  override apply(cascadeInstance: CascadeInstance): void {\n    if (\n      checkAttribute(\n        cascadeInstance.currentElement,\n        this.ns,\n        this.name,\n        (element, ns, name) =>\n          !!element.getAttributeNS(ns, name)?.match(this.regexp),\n      )\n    ) {\n      this.chained.apply(cascadeInstance);\n    }\n  }\n}\n\nexport class CheckLangAction extends ChainedAction {\n  constructor(public readonly langRegExp: RegExp) {\n    super();\n  }\n\n  override apply(cascadeInstance: CascadeInstance): void {\n    if (cascadeInstance.lang.match(this.langRegExp)) {\n      this.chained.apply(cascadeInstance);\n    }\n  }\n}\n\nexport class IsFirstAction extends ChainedAction {\n  constructor() {\n    super();\n  }\n\n  override apply(cascadeInstance: CascadeInstance): void {\n    if (cascadeInstance.isFirst) {\n      this.chained.apply(cascadeInstance);\n    }\n  }\n\n  override getPriority(): number {\n    return 6;\n  }\n}\n\nexport class IsRootAction extends ChainedAction {\n  constructor() {\n    super();\n  }\n\n  override apply(cascadeInstance: CascadeInstance): void {\n    if (cascadeInstance.isRoot) {\n      this.chained.apply(cascadeInstance);\n    }\n  }\n\n  override getPriority(): number {\n    return 12; // :root is the first thing to check\n  }\n}\n\nexport class IsNthAction extends ChainedAction {\n  constructor(\n    public readonly a: number,\n    public readonly b: number,\n  ) {\n    super();\n  }\n\n  /**\n   * Checkes whether given order can be represented as an+b with a non-negative\n   * interger n\n   */\n  protected matchANPlusB(order: number): boolean {\n    return Matchers.matchANPlusB(order, this.a, this.b);\n  }\n}\n\nexport class IsNthSiblingAction extends IsNthAction {\n  constructor(a: number, b: number) {\n    super(a, b);\n  }\n\n  override apply(cascadeInstance: CascadeInstance): void {\n    if (this.matchANPlusB(cascadeInstance.currentSiblingOrder)) {\n      this.chained.apply(cascadeInstance);\n    }\n  }\n\n  override getPriority(): number {\n    return 5;\n  }\n}\n\nexport class IsNthSiblingOfTypeAction extends IsNthAction {\n  constructor(a: number, b: number) {\n    super(a, b);\n  }\n\n  override apply(cascadeInstance: CascadeInstance): void {\n    const order =\n      cascadeInstance.currentSiblingTypeCounts[\n        cascadeInstance.currentNamespace\n      ][cascadeInstance.currentLocalName];\n    if (this.matchANPlusB(order)) {\n      this.chained.apply(cascadeInstance);\n    }\n  }\n\n  override getPriority(): number {\n    return 5;\n  }\n}\n\nexport class IsNthLastSiblingAction extends IsNthAction {\n  constructor(a: number, b: number) {\n    super(a, b);\n  }\n\n  override apply(cascadeInstance: CascadeInstance): void {\n    let order = cascadeInstance.currentFollowingSiblingOrder;\n    if (order === null) {\n      order = cascadeInstance.currentFollowingSiblingOrder =\n        cascadeInstance.currentElement.parentNode.childElementCount -\n        cascadeInstance.currentSiblingOrder +\n        1;\n    }\n    if (this.matchANPlusB(order)) {\n      this.chained.apply(cascadeInstance);\n    }\n  }\n\n  override getPriority(): number {\n    return 4;\n  }\n}\n\nexport class IsNthLastSiblingOfTypeAction extends IsNthAction {\n  constructor(a: number, b: number) {\n    super(a, b);\n  }\n\n  override apply(cascadeInstance: CascadeInstance): void {\n    const counts = cascadeInstance.currentFollowingSiblingTypeCounts;\n    if (!counts[cascadeInstance.currentNamespace]) {\n      let elem = cascadeInstance.currentElement;\n      do {\n        const ns = elem.namespaceURI;\n        const localName = elem.localName;\n        let nsCounts = counts[ns];\n        if (!nsCounts) {\n          nsCounts = counts[ns] = {};\n        }\n        nsCounts[localName] = (nsCounts[localName] || 0) + 1;\n      } while ((elem = elem.nextElementSibling));\n    }\n    if (\n      this.matchANPlusB(\n        counts[cascadeInstance.currentNamespace][\n          cascadeInstance.currentLocalName\n        ],\n      )\n    ) {\n      this.chained.apply(cascadeInstance);\n    }\n  }\n\n  override getPriority(): number {\n    return 4;\n  }\n}\n\nexport class IsEmptyAction extends ChainedAction {\n  constructor() {\n    super();\n  }\n\n  override apply(cascadeInstance: CascadeInstance): void {\n    let node: Node | null = cascadeInstance.currentElement.firstChild;\n    while (node) {\n      switch (node.nodeType) {\n        case Node.ELEMENT_NODE:\n          return;\n        case Node.TEXT_NODE:\n          if ((node as Text).length > 0) {\n            return;\n          }\n      }\n      node = node.nextSibling;\n    }\n    this.chained.apply(cascadeInstance);\n  }\n\n  override getPriority(): number {\n    return 4;\n  }\n}\n\nexport class IsEnabledAction extends ChainedAction {\n  constructor() {\n    super();\n  }\n\n  override apply(cascadeInstance: CascadeInstance): void {\n    const elem = cascadeInstance.currentElement;\n    if ((elem as any).disabled === false) {\n      this.chained.apply(cascadeInstance);\n    }\n  }\n\n  override getPriority(): number {\n    return 5;\n  }\n}\n\nexport class IsDisabledAction extends ChainedAction {\n  constructor() {\n    super();\n  }\n\n  override apply(cascadeInstance: CascadeInstance): void {\n    const elem = cascadeInstance.currentElement;\n    if ((elem as any).disabled === true) {\n      this.chained.apply(cascadeInstance);\n    }\n  }\n\n  override getPriority(): number {\n    return 5;\n  }\n}\n\nexport class IsCheckedAction extends ChainedAction {\n  constructor() {\n    super();\n  }\n\n  override apply(cascadeInstance: CascadeInstance): void {\n    const elem = cascadeInstance.currentElement;\n    if ((elem as any).selected === true || (elem as any).checked === true) {\n      this.chained.apply(cascadeInstance);\n    }\n  }\n\n  override getPriority(): number {\n    return 5;\n  }\n}\n\nexport class CheckConditionAction extends ChainedAction {\n  constructor(public readonly condition: string) {\n    super();\n  }\n\n  override apply(cascadeInstance: CascadeInstance): void {\n    if (cascadeInstance.conditions[this.condition]) {\n      try {\n        cascadeInstance.dependentConditions.push(this.condition);\n        this.chained.apply(cascadeInstance);\n      } finally {\n        cascadeInstance.dependentConditions.pop();\n      }\n    }\n  }\n\n  override getPriority(): number {\n    return 5;\n  }\n}\n\nexport class CheckAppliedAction extends CascadeAction {\n  applied = false;\n\n  constructor() {\n    super();\n  }\n\n  override apply(cascadeInstance: CascadeInstance): void {\n    this.applied = true;\n  }\n\n  override clone(): CascadeAction {\n    const cloned = new CheckAppliedAction();\n    cloned.applied = this.applied;\n    return cloned;\n  }\n}\n\n/**\n * Cascade Action for :is() and similar pseudo-classes\n */\nexport class MatchesAction extends ChainedAction {\n  checkAppliedAction: CheckAppliedAction;\n  firstActions: CascadeAction[] = [];\n\n  constructor(chains: ChainedAction[][]) {\n    super();\n    this.checkAppliedAction = new CheckAppliedAction();\n    for (const chain of chains) {\n      this.firstActions.push(chainActions(chain, this.checkAppliedAction));\n    }\n  }\n\n  override apply(cascadeInstance: CascadeInstance): void {\n    for (const firstAction of this.firstActions) {\n      firstAction.apply(cascadeInstance);\n      if (this.checkAppliedAction.applied) {\n        break;\n      }\n    }\n    if (this.checkAppliedAction.applied === this.positive()) {\n      this.chained.apply(cascadeInstance);\n    }\n    this.checkAppliedAction.applied = false;\n  }\n\n  override getPriority(): number {\n    return Math.max(\n      ...this.firstActions.map((firstAction) =>\n        firstAction instanceof ChainedAction ? firstAction.getPriority() : 0,\n      ),\n    );\n  }\n\n  positive(): boolean {\n    return true;\n  }\n\n  relational(): boolean {\n    return false;\n  }\n}\n\n/**\n * Cascade Action for :not() pseudo-class\n */\nexport class MatchesNoneAction extends MatchesAction {\n  override positive(): boolean {\n    return false;\n  }\n}\n\n/**\n * Cascade Action for :has() pseudo-class\n */\nexport class MatchesRelationalAction extends MatchesAction {\n  constructor(public selectorTexts: string[]) {\n    super([]);\n  }\n\n  override apply(cascadeInstance: CascadeInstance): void {\n    for (const selectorText of this.selectorTexts) {\n      let selectorWithScope: string;\n      let scopingRoot: ParentNode;\n      if (/^\\s*[+~]/.test(selectorText)) {\n        // :has(+ F) or :has(~ F)\n        scopingRoot = cascadeInstance.currentElement.parentNode;\n        const index = Array.from(scopingRoot.children).indexOf(\n          cascadeInstance.currentElement,\n        );\n        selectorWithScope = `:scope > :nth-child(${index + 1}) ${selectorText}`;\n      } else {\n        // :has(F) or :has(> F)\n        scopingRoot = cascadeInstance.currentElement;\n        selectorWithScope = `:scope ${selectorText}`;\n      }\n      try {\n        if (scopingRoot.querySelector(selectorWithScope)) {\n          this.checkAppliedAction.apply(cascadeInstance);\n          break;\n        }\n      } catch (e) {}\n    }\n    if (this.checkAppliedAction.applied) {\n      this.chained.apply(cascadeInstance);\n    }\n    this.checkAppliedAction.applied = false;\n  }\n\n  override relational(): boolean {\n    return true;\n  }\n}\n\n/**\n * An object that is notified as elements are pushed and popped and typically\n * controls a \"named condition\" (which is a count associated with a name).\n */\nexport interface ConditionItem {\n  /**\n   * Returns a \"fresh\" copy of this item. May be this if immutable.\n   */\n  fresh(cascadeInstance: CascadeInstance): ConditionItem;\n\n  /**\n   * Depth is 0 for element itself and its siblings, 1 for direct children and\n   * -1 for the parent.\n   */\n  push(cascadeInstance: CascadeInstance, depth: number): boolean;\n\n  /**\n   * @return return true if no more notifications are desired\n   */\n  pop(cascadeInstance: CascadeInstance, depth: number): boolean;\n}\n\nexport class AbstractConditionItem {\n  constructor(\n    public readonly condition: string,\n    public readonly viewConditionId: string | null,\n    public readonly viewCondition: Matchers.Matcher,\n  ) {}\n\n  increment(cascadeInstance: CascadeInstance) {\n    cascadeInstance.increment(this.condition, this.viewCondition);\n  }\n\n  decrement(cascadeInstance: CascadeInstance) {\n    cascadeInstance.decrement(this.condition, this.viewCondition);\n  }\n\n  buildViewConditionMatcher(\n    cascadeInstance: CascadeInstance,\n  ): Matchers.Matcher {\n    return cascadeInstance.buildViewConditionMatcher(this.viewConditionId);\n  }\n}\n\nexport class DescendantConditionItem\n  extends AbstractConditionItem\n  implements ConditionItem\n{\n  constructor(\n    condition: string,\n    viewConditionId: string | null,\n    viewCondition: Matchers.Matcher,\n  ) {\n    super(condition, viewConditionId, viewCondition);\n  }\n\n  /** @override */\n  fresh(cascadeInstance: CascadeInstance): ConditionItem {\n    return new DescendantConditionItem(\n      this.condition,\n      this.viewConditionId,\n      this.buildViewConditionMatcher(cascadeInstance),\n    );\n  }\n\n  /** @override */\n  push(cascadeInstance: CascadeInstance, depth: number): boolean {\n    if (depth == 0) {\n      this.increment(cascadeInstance);\n    }\n    return false;\n  }\n\n  /** @override */\n  pop(cascadeInstance: CascadeInstance, depth: number): boolean {\n    if (depth == 0) {\n      this.decrement(cascadeInstance);\n      return true;\n    }\n    return false;\n  }\n}\n\nexport class ChildConditionItem\n  extends AbstractConditionItem\n  implements ConditionItem\n{\n  constructor(\n    condition: string,\n    viewConditionId: string | null,\n    viewCondition: Matchers.Matcher,\n  ) {\n    super(condition, viewConditionId, viewCondition);\n  }\n\n  /** @override */\n  fresh(cascadeInstance: CascadeInstance): ConditionItem {\n    return new ChildConditionItem(\n      this.condition,\n      this.viewConditionId,\n      this.buildViewConditionMatcher(cascadeInstance),\n    );\n  }\n\n  /** @override */\n  push(cascadeInstance: CascadeInstance, depth: number): boolean {\n    if (depth == 0) {\n      this.increment(cascadeInstance);\n    } else if (depth == 1) {\n      this.decrement(cascadeInstance);\n    }\n    return false;\n  }\n\n  /** @override */\n  pop(cascadeInstance: CascadeInstance, depth: number): boolean {\n    if (depth == 0) {\n      this.decrement(cascadeInstance);\n      return true;\n    } else if (depth == 1) {\n      this.increment(cascadeInstance);\n    }\n    return false;\n  }\n}\n\nexport class AdjacentSiblingConditionItem\n  extends AbstractConditionItem\n  implements ConditionItem\n{\n  fired: boolean = false;\n\n  constructor(\n    condition: string,\n    viewConditionId: string | null,\n    viewCondition: Matchers.Matcher,\n  ) {\n    super(condition, viewConditionId, viewCondition);\n  }\n\n  /** @override */\n  fresh(cascadeInstance: CascadeInstance): ConditionItem {\n    return new AdjacentSiblingConditionItem(\n      this.condition,\n      this.viewConditionId,\n      this.buildViewConditionMatcher(cascadeInstance),\n    );\n  }\n\n  /** @override */\n  push(cascadeInstance: CascadeInstance, depth: number): boolean {\n    if (this.fired) {\n      this.decrement(cascadeInstance);\n      return true;\n    }\n    return false;\n  }\n\n  /** @override */\n  pop(cascadeInstance: CascadeInstance, depth: number): boolean {\n    if (this.fired) {\n      this.decrement(cascadeInstance);\n      return true;\n    }\n    if (depth == 0) {\n      // Leaving element that triggered this item.\n      this.fired = true;\n      this.increment(cascadeInstance);\n    }\n    return false;\n  }\n}\n\nexport class FollowingSiblingConditionItem\n  extends AbstractConditionItem\n  implements ConditionItem\n{\n  fired: boolean = false;\n\n  constructor(\n    condition: string,\n    viewConditionId: string | null,\n    viewCondition: Matchers.Matcher,\n  ) {\n    super(condition, viewConditionId, viewCondition);\n  }\n\n  /** @override */\n  fresh(cascadeInstance: CascadeInstance): ConditionItem {\n    return new FollowingSiblingConditionItem(\n      this.condition,\n      this.viewConditionId,\n      this.buildViewConditionMatcher(cascadeInstance),\n    );\n  }\n\n  /** @override */\n  push(cascadeInstance: CascadeInstance, depth: number): boolean {\n    if (this.fired) {\n      if (depth == -1) {\n        this.increment(cascadeInstance);\n      } else if (depth == 0) {\n        this.decrement(cascadeInstance);\n      }\n    }\n    return false;\n  }\n\n  /** @override */\n  pop(cascadeInstance: CascadeInstance, depth: number): boolean {\n    if (this.fired) {\n      if (depth == -1) {\n        this.decrement(cascadeInstance);\n        return true;\n      } else if (depth == 0) {\n        this.increment(cascadeInstance);\n      }\n    } else {\n      if (depth == 0) {\n        // Leaving element that triggered this item.\n        this.fired = true;\n        this.increment(cascadeInstance);\n      }\n    }\n    return false;\n  }\n}\n\n/**\n * Not a true condition item, this class manages proper handling of \"after\"\n * pseudoelement.\n */\nexport class AfterPseudoelementItem implements ConditionItem {\n  constructor(\n    public readonly afterprop: ElementStyle,\n    public readonly element: Element,\n  ) {}\n\n  /** @override */\n  fresh(cascadeInstance: CascadeInstance): ConditionItem {\n    return this;\n  }\n\n  /** @override */\n  push(cascadeInstance: CascadeInstance, depth: number): boolean {\n    return false;\n  }\n\n  /** @override */\n  pop(cascadeInstance: CascadeInstance, depth: number): boolean {\n    if (depth == 0) {\n      cascadeInstance.processPseudoelementProps(this.afterprop, this.element);\n      return true;\n    }\n    return false;\n  }\n}\n\n/**\n * Not a true condition item, this class restores current language.\n */\nexport class RestoreLangItem implements ConditionItem {\n  constructor(public readonly lang: string) {}\n\n  /** @override */\n  fresh(cascadeInstance: CascadeInstance): ConditionItem {\n    return this;\n  }\n\n  /** @override */\n  push(cascadeInstance: CascadeInstance, depth: number): boolean {\n    return false;\n  }\n\n  /** @override */\n  pop(cascadeInstance: CascadeInstance, depth: number): boolean {\n    if (depth == 0) {\n      cascadeInstance.lang = this.lang;\n      return true;\n    }\n    return false;\n  }\n}\n\n/**\n * Not a true condition item, this class manages inheritance of quotes property\n */\nexport class QuotesScopeItem implements ConditionItem {\n  constructor(public readonly oldQuotes: Css.Str[]) {}\n\n  /** @override */\n  fresh(cascadeInstance: CascadeInstance): ConditionItem {\n    return this;\n  }\n\n  /** @override */\n  push(cascadeInstance: CascadeInstance, depth: number): boolean {\n    return false;\n  }\n\n  /** @override */\n  pop(cascadeInstance: CascadeInstance, depth: number): boolean {\n    if (depth == 0) {\n      cascadeInstance.quotes = this.oldQuotes;\n      return true;\n    }\n    return false;\n  }\n}\nexport type CounterValues = {\n  [key: string]: number[];\n};\n\nexport interface CounterListener {\n  countersOfId(id: string, counters: CounterValues);\n\n  getExprContentListener(): Vtree.ExprContentListener;\n}\n\nexport interface CounterResolver {\n  setStyler(styler: CssStyler.AbstractStyler): void;\n\n  /**\n   * Returns an Exprs.Val, whose value is calculated at the layout time by\n   * retrieving the innermost page-based counter (null if it does not exist) by\n   * its name and formatting the value into a string.\n   * @param name Name of the page-based counter to be retrieved\n   * @param format A function that formats the counter value into a string\n   */\n  getPageCounterVal(\n    name: string,\n    format: (p1: number | null) => string,\n  ): Exprs.Val;\n\n  /**\n   * Returns an Exprs.Val, whose value is calculated at the layout time by\n   * retrieving the page-based counters by its name and formatting the values\n   * into a string.\n   * @param name Name of the page-based counters to be retrieved\n   * @param format A function that formats the counter values (passed as an\n   *     array ordered by the nesting depth with the outermost counter first and\n   *     the innermost last) into a string\n   */\n  getPageCountersVal(name: string, format: (p1: number[]) => string): Exprs.Val;\n\n  getTargetCounterVal(\n    url: string,\n    name: string,\n    format: (p1: number | null) => string,\n  ): Exprs.Val;\n\n  getTargetCountersVal(\n    url: string,\n    name: string,\n    format: (p1: number[]) => string,\n  ): Exprs.Val;\n\n  /**\n   * Get value of the CSS target-text() function\n   * https://drafts.csswg.org/css-content-3/#target-text\n   * @param url Target URL (with fragment identifier)\n   * @param pseudoElement Pseudo-element selector ('content', 'before', 'after', 'first-letter', 'marker')\n   */\n  getTargetTextVal(url: string, pseudoElement: string): Exprs.Val;\n\n  /**\n   * Get value of the CSS string() function\n   * https://drafts.csswg.org/css-gcpm-3/#using-named-strings\n   */\n  getNamedStringVal(name: string, retrievePosition: string): Exprs.Val;\n\n  /**\n   * Set named string for the CSS string-set property\n   * https://drafts.csswg.org/css-gcpm-3/#setting-named-strings-the-string-set-pro\n   */\n  setNamedString(\n    name: string,\n    stringValue: string,\n    elementOffset: number,\n  ): void;\n\n  /**\n   * Get value of the CSS element() function\n   * https://drafts.csswg.org/css-gcpm-3/#running-elements\n   */\n  getRunningElementVal(name: string, retrievePosition: string): Exprs.Val;\n\n  /**\n   * Set running element\n   * https://drafts.csswg.org/css-gcpm-3/#running-elements\n   */\n  setRunningElement(name: string, elementOffset: number): void;\n}\n\nexport class AttrValueFilterVisitor extends Css.FilterVisitor {\n  constructor(public element: Element) {\n    super();\n  }\n\n  private createValueFromString(str: string | null, type: string): Css.Val {\n    switch (type) {\n      case \"url\":\n        if (str) {\n          return new Css.URL(str); // TODO should convert to absolute path\n        }\n        return new Css.URL(\"about:invalid\");\n      case \"string\":\n      default:\n        if (str) {\n          return new Css.Str(str);\n        }\n        return new Css.Str(\"\");\n    }\n  }\n\n  override visitFunc(func: Css.Func): Css.Val {\n    if (func.name !== \"attr\") {\n      return super.visitFunc(func);\n    }\n    let type = \"string\";\n    let attributeName: string | null = null;\n    let defaultValue: Css.Val = null;\n    if (func.values[0] instanceof Css.SpaceList) {\n      const values = (func.values[0] as Css.SpaceList).values;\n      if (values.length >= 2) {\n        type = values[1].stringValue();\n      }\n      attributeName = values[0].stringValue();\n    } else {\n      attributeName = func.values[0].stringValue();\n    }\n    if (func.values.length > 1) {\n      defaultValue = this.createValueFromString(\n        func.values[1].stringValue(),\n        type,\n      );\n    } else {\n      defaultValue = this.createValueFromString(null, type);\n    }\n    if (this.element && this.element.hasAttribute(attributeName)) {\n      return this.createValueFromString(\n        this.element.getAttribute(attributeName),\n        type,\n      );\n    }\n    return defaultValue;\n  }\n}\n\n/**\n * Get concatenated string value from CSS `string-set` and `content` property\n */\nfunction getStringValueFromCssContentVal(val: Css.Val): string {\n  // When this function is called, CSS `content()`, `attr()`, `counter()`\n  // values are already resolved to strings values. Remaining non-string values\n  // are ignored.\n  if (Vtree.nonTrivialContent(val)) {\n    if (val instanceof Css.Str) {\n      return val.stringValue();\n    }\n    if (val instanceof Css.SpaceList) {\n      return val.values.map((v) => getStringValueFromCssContentVal(v)).join(\"\");\n    }\n  }\n  return \"\";\n}\n\nexport class ContentPropVisitor extends Css.FilterVisitor {\n  constructor(\n    public cascade: CascadeInstance,\n    public element: Element,\n    public readonly counterResolver: CounterResolver,\n  ) {\n    super();\n  }\n\n  override visitIdent(ident: Css.Ident): Css.Val {\n    const cascade = this.cascade;\n    const quotes = cascade.quotes;\n    const maxDepth = Math.floor(quotes.length / 2) - 1;\n    switch (ident.name) {\n      case \"open-quote\": {\n        const result = quotes[2 * Math.min(maxDepth, cascade.quoteDepth)];\n        cascade.quoteDepth++;\n        return result;\n      }\n      case \"close-quote\":\n        if (cascade.quoteDepth > 0) {\n          cascade.quoteDepth--;\n        }\n        return quotes[2 * Math.min(maxDepth, cascade.quoteDepth) + 1];\n      case \"no-open-quote\":\n        cascade.quoteDepth++;\n        return new Css.Str(\"\");\n      case \"no-close-quote\":\n        if (cascade.quoteDepth > 0) {\n          cascade.quoteDepth--;\n        }\n        return new Css.Str(\"\");\n    }\n    return ident;\n  }\n\n  private format(num: number, type: string): string {\n    return this.cascade.counterStyleStore.format(type, num);\n  }\n\n  visitFuncCounter(values: Css.Val[]): Css.Val {\n    const counterName = values[0].toString();\n    const type = values.length > 1 ? values[1].stringValue() : \"decimal\";\n    const arr = this.cascade.counters[counterName];\n    if (arr && arr.length) {\n      const numval = (arr && arr.length && arr[arr.length - 1]) || 0;\n      return new Css.Str(this.format(numval, type));\n    } else {\n      const c = new Css.Expr(\n        this.counterResolver.getPageCounterVal(counterName, (numval) =>\n          this.format(numval || 0, type),\n        ),\n      );\n      return new Css.SpaceList([c]);\n    }\n  }\n\n  visitFuncCounters(values: Css.Val[]): Css.Val {\n    const counterName = values[0].toString();\n    const separator = values[1].stringValue();\n    const type = values.length > 2 ? values[2].stringValue() : \"decimal\";\n    const arr = this.cascade.counters[counterName];\n    const sb = new Base.StringBuffer();\n    if (arr && arr.length) {\n      for (let i = 0; i < arr.length; i++) {\n        if (i > 0) {\n          sb.append(separator);\n        }\n        sb.append(this.format(arr[i], type));\n      }\n    }\n    const c = new Css.Expr(\n      this.counterResolver.getPageCountersVal(counterName, (numvals) => {\n        const parts = [] as string[];\n        if (numvals.length) {\n          for (let i = 0; i < numvals.length; i++) {\n            parts.push(this.format(numvals[i], type));\n          }\n        }\n        const elementCounters = sb.toString();\n        if (elementCounters.length) {\n          parts.push(elementCounters);\n        }\n        if (parts.length) {\n          return parts.join(separator);\n        } else {\n          return this.format(0, type);\n        }\n      }),\n    );\n    return new Css.SpaceList([c]);\n  }\n\n  visitFuncTargetCounter(values: Css.Val[]): Css.Val {\n    const targetUrl = values[0];\n    let targetUrlStr: string;\n    if (targetUrl instanceof Css.URL) {\n      targetUrlStr = targetUrl.url;\n    } else {\n      targetUrlStr = targetUrl.stringValue();\n    }\n    const counterName = values[1].toString();\n    const type = values.length > 2 ? values[2].stringValue() : \"decimal\";\n    const c = new Css.Expr(\n      this.counterResolver.getTargetCounterVal(\n        targetUrlStr,\n        counterName,\n        (numval) => this.format(numval || 0, type),\n      ),\n    );\n    return new Css.SpaceList([c]);\n  }\n\n  visitFuncTargetCounters(values: Css.Val[]): Css.Val {\n    const targetUrl = values[0];\n    let targetUrlStr: string;\n    if (targetUrl instanceof Css.URL) {\n      targetUrlStr = targetUrl.url;\n    } else {\n      targetUrlStr = targetUrl.stringValue();\n    }\n    const counterName = values[1].toString();\n    const separator = values[2].stringValue();\n    const type = values.length > 3 ? values[3].stringValue() : \"decimal\";\n    const c = new Css.Expr(\n      this.counterResolver.getTargetCountersVal(\n        targetUrlStr,\n        counterName,\n        (numvals) => {\n          const parts = numvals.map((numval) => this.format(numval, type));\n          if (parts.length) {\n            return parts.join(separator);\n          } else {\n            return this.format(0, type);\n          }\n        },\n      ),\n    );\n    return new Css.SpaceList([c]);\n  }\n\n  /**\n   * CSS `target-text()` function\n   * https://drafts.csswg.org/css-content-3/#target-text\n   */\n  visitFuncTargetText(values: Css.Val[]): Css.Val {\n    const targetUrl = values[0];\n    let targetUrlStr: string;\n    if (targetUrl instanceof Css.URL) {\n      targetUrlStr = targetUrl.url;\n    } else {\n      targetUrlStr = targetUrl.stringValue();\n    }\n    const pseudoElement =\n      values.length > 1 ? values[1].stringValue() : \"content\";\n    const c = new Css.Expr(\n      this.counterResolver.getTargetTextVal(targetUrlStr, pseudoElement),\n    );\n    return new Css.SpaceList([c]);\n  }\n\n  /**\n   * CSS `string()` function\n   * https://drafts.csswg.org/css-gcpm-3/#using-named-strings\n   */\n  visitFuncString(values: Css.Val[]): Css.Val {\n    const name = values.length > 0 ? values[0].stringValue() : \"\";\n    const retrievePosition =\n      values.length > 1 ? values[1].stringValue() : \"first\";\n\n    return new Css.Expr(\n      this.counterResolver.getNamedStringVal(name, retrievePosition),\n    );\n  }\n\n  /**\n   * CSS `element()` function\n   * https://drafts.csswg.org/css-gcpm-3/#running-elements\n   */\n  visitFuncElement(values: Css.Val[]): Css.Val {\n    const name = values.length > 0 ? values[0].stringValue() : \"\";\n    const retrievePosition =\n      values.length > 1 ? values[1].stringValue() : \"first\";\n\n    return new Css.Expr(\n      this.counterResolver.getRunningElementVal(name, retrievePosition),\n    );\n  }\n\n  /**\n   * CSS `content()` function\n   * https://drafts.csswg.org/css-gcpm-3/#content-function-header\n   */\n  visitFuncContent(values: Css.Val[]): Css.Val {\n    const pseudoName = values.length > 0 ? values[0].stringValue() : \"text\";\n    let stringValue = \"\";\n    switch (pseudoName) {\n      case \"text\":\n        stringValue = this.element.textContent;\n        break;\n      case \"before\":\n      case \"after\":\n      case \"marker\":\n        {\n          const pseudos = getStyleMap(this.cascade.currentStyle, \"_pseudos\");\n          const val = (pseudos?.[pseudoName]?.[\"content\"] as CascadeValue)\n            ?.value;\n          stringValue = getStringValueFromCssContentVal(val);\n        }\n        break;\n      case \"first-letter\":\n        {\n          // Respect ::before/after pseudo-elements (Issue #1174)\n          const pseudos = getStyleMap(this.cascade.currentStyle, \"_pseudos\");\n          const r = (\n            getStringValueFromCssContentVal(\n              (pseudos?.[\"before\"]?.[\"content\"] as CascadeValue)?.value,\n            ) ||\n            this.element.textContent ||\n            getStringValueFromCssContentVal(\n              (pseudos?.[\"after\"]?.[\"content\"] as CascadeValue)?.value,\n            )\n          ).match(Base.firstLetterPattern);\n          stringValue = r ? r[0] : \"\";\n        }\n        break;\n    }\n    return new Css.Str(stringValue);\n  }\n\n  /**\n   * CSS `leader()` function\n   * https://www.w3.org/TR/css-content-3/#leaders\n   */\n  visitFuncLeader(values: Css.Val[]): Css.Val {\n    let leader: string = \"\";\n    if (values[0] instanceof Css.Ident) {\n      switch (values[0].stringValue()) {\n        case \"dotted\":\n          leader = \".\";\n          break;\n        case \"solid\":\n          leader = \"_\";\n          break;\n        case \"space\":\n          leader = \" \";\n          break;\n      }\n    } else if (values[0] instanceof Css.Str) {\n      leader = values[0].stringValue();\n    }\n    if (leader.length == 0) {\n      return new Css.Str(\"\");\n    }\n    return new Css.Expr(new Exprs.Native(null, () => leader, \"viv-leader\"));\n  }\n\n  override visitFunc(func: Css.Func): Css.Val {\n    switch (func.name) {\n      case \"counter\":\n        if (func.values.length <= 2) {\n          return this.visitFuncCounter(func.values);\n        }\n        break;\n      case \"counters\":\n        if (func.values.length <= 3) {\n          return this.visitFuncCounters(func.values);\n        }\n        break;\n      case \"target-counter\":\n        if (func.values.length <= 3) {\n          return this.visitFuncTargetCounter(func.values);\n        }\n        break;\n      case \"target-counters\":\n        if (func.values.length <= 4) {\n          return this.visitFuncTargetCounters(func.values);\n        }\n        break;\n      case \"target-text\":\n        if (func.values.length >= 1 && func.values.length <= 2) {\n          return this.visitFuncTargetText(func.values);\n        }\n        break;\n      case \"string\":\n        if (func.values.length <= 2) {\n          return this.visitFuncString(func.values);\n        }\n        break;\n      case \"element\":\n        if (func.values.length <= 2) {\n          return this.visitFuncElement(func.values);\n        }\n        break;\n      case \"content\":\n        if (func.values.length <= 1) {\n          return this.visitFuncContent(func.values);\n        }\n        break;\n      case \"leader\":\n        if (func.values.length <= 1) {\n          return this.visitFuncLeader(func.values);\n        }\n        break;\n    }\n    // Logging.logger.warn(\"E_CSS_CONTENT_PROP:\", func.toString());\n    return func;\n  }\n}\n\n/**\n * Get the total width of a node's content\n * @param node The node to measure (Element or Text)\n * @param clientLayout The client layout interface for accessing DOM\n * @param writingMode The writing mode (vertical-rl, vertical-lr, or horizontal)\n * @returns The total width (or height for vertical writing modes)\n */\nfunction getContentWidth(\n  node: Node,\n  clientLayout: Vtree.ClientLayout,\n  writingMode: string,\n): number {\n  let rects: { width: number; height: number }[];\n\n  if (node.nodeType === 1) {\n    rects = Array.from((node as Element).getClientRects());\n  } else {\n    const range = node.ownerDocument.createRange();\n    range.selectNodeContents(node);\n    rects = clientLayout.getRangeClientRects(range);\n  }\n\n  const totalWidth = rects.reduce(\n    (acc, rect) =>\n      acc +\n      (writingMode === \"vertical-rl\" || writingMode === \"vertical-lr\"\n        ? rect.height\n        : rect.width),\n    0,\n  );\n\n  return totalWidth;\n}\n\n/**\n * POST_LAYOUT_BLOCK hook function for CSS leader()\n * @param nodeContext\n * @param checkPoints\n * @param column\n */\nconst postLayoutBlockLeader: Plugin.PostLayoutBlockHook = (\n  nodeContext: Vtree.NodeContext,\n  checkPoints: Vtree.NodeContext[],\n  column: Layout.Column,\n) => {\n  const leaders: Vtree.NodeContext[] = checkPoints.filter(\n    (c) =>\n      c.after &&\n      c.viewNode.nodeType === 1 &&\n      (c.viewNode as Element).getAttribute(\"data-viv-leader\"),\n  );\n  for (const c of leaders) {\n    // we want to access the bottom block element, which contains single leader().\n    let container = c.parent;\n    while (container && container.inline) {\n      container = container.parent;\n    }\n    const leaderElem = c.viewNode as HTMLElement;\n    const pseudoElem = leaderElem.parentElement;\n    const pseudoName = pseudoElem.getAttribute(\"data-adapt-pseudo\");\n    const leader = leaderElem.getAttribute(\"data-viv-leader-value\");\n    const { writingMode, direction, marginInlineEnd } =\n      column.clientLayout.getElementComputedStyle(pseudoElem);\n\n    function setLeaderTextContent(leaderStr: string): void {\n      if (direction === \"rtl\") {\n        // in RTL direction, enclose the leader with U+200F (RIGHT-TO-LEFT MARK)\n        // to ensure RTL order around the leader.\n        const RLM = \"\\u200f\";\n        leaderElem.textContent =\n          (leaderStr.startsWith(RLM) ? \"\" : RLM) +\n          leaderStr +\n          (leaderStr.endsWith(RLM) ? \"\" : RLM);\n      } else {\n        leaderElem.textContent = leaderStr;\n      }\n    }\n\n    // prevent leader layout problem (Issue #1117)\n    leaderElem.style.marginInlineStart = \"1px\";\n\n    // reset the expanded leader\n    setLeaderTextContent(leader);\n    // setting inline-block removes the pseudo CONTENT from normal text flow\n    pseudoElem.style.display = \"inline-block\";\n    pseudoElem.style.textIndent = \"0\"; // cancel inherited text-indent\n\n    // Workaround for Issue #1598:\n    // In multi-column layout with column-fill: balance, changing leader length\n    // triggers column rebalancing, making the initially measured `box` unreliable.\n    // Temporarily switch column-fill to auto to prevent rebalancing during\n    // leader calculation.\n    // Note: findAncestorNonRootMultiColumn is correct here. Root-level multi-column\n    // is handled by Vivliostyle's own column balancing (ColumnBalancer), not the\n    // browser's column-fill: balance, so this issue only affects non-root multi-column.\n    const columnContainer = LayoutHelper.findAncestorNonRootMultiColumn(\n      container.viewNode,\n    ) as HTMLElement | null;\n    const originalColumnFill = columnContainer?.style.columnFill || null;\n    if (columnContainer) {\n      columnContainer.style.columnFill = \"auto\";\n    }\n\n    const box = column.clientLayout.getElementClientRect(\n      container.viewNode as Element,\n    );\n    const innerInit = column.clientLayout.getElementClientRect(pseudoElem);\n    const innerMarginInlineEnd = column.parseComputedLength(marginInlineEnd);\n\n    // Calculate width of following inline siblings (Issue #1563)\n    const inlineNodes: Node[] = [];\n\n    // Find the topmost inline ancestor (child of block ancestor) that contains pseudoElement\n    let topmostInlineAncestor: Element = pseudoElem.parentElement;\n    while (\n      topmostInlineAncestor.parentElement &&\n      topmostInlineAncestor.parentElement !== (container.viewNode as Element)\n    ) {\n      topmostInlineAncestor = topmostInlineAncestor.parentElement;\n    }\n\n    // Start collecting siblings from the next sibling of the topmost inline ancestor\n    let sibling = topmostInlineAncestor.nextSibling;\n\n    // Collect all following inline siblings\n    while (sibling) {\n      if (sibling.nodeType === 1) {\n        // Node.ELEMENT_NODE\n        const elem = sibling as Element;\n        const { display, float, position } =\n          column.clientLayout.getElementComputedStyle(elem);\n\n        // Skip out-of-flow elements\n        if (\n          float !== \"none\" ||\n          position === \"absolute\" ||\n          position === \"fixed\"\n        ) {\n          sibling = sibling.nextSibling;\n          continue;\n        }\n\n        // Collect inline-level elements\n        if (Display.isInlineLevel(display)) {\n          inlineNodes.push(elem);\n        } else if (Display.isBlockLevel(display)) {\n          break;\n        }\n      } else if (sibling.nodeType === 3) {\n        // Node.TEXT_NODE\n        const text = sibling as Text;\n        if (text.length > 0) {\n          inlineNodes.push(text);\n        }\n      }\n      sibling = sibling.nextSibling;\n    }\n\n    // Measure the width of following siblings by reducing each node's actual width\n    let followingInlineSiblingsWidth = inlineNodes.reduce(\n      (acc, node) =>\n        acc + getContentWidth(node, column.clientLayout, writingMode),\n      0,\n    );\n\n    // For ::before or content (non-::after), add parent element's remaining width\n    // (content + ::after for ::before, ::after for content)\n    if (pseudoName !== \"after\") {\n      const parentWidth = getContentWidth(\n        topmostInlineAncestor,\n        column.clientLayout,\n        writingMode,\n      );\n      const pseudoWidth = getContentWidth(\n        pseudoElem,\n        column.clientLayout,\n        writingMode,\n      );\n\n      followingInlineSiblingsWidth += parentWidth - pseudoWidth;\n    }\n\n    // capture the line boundary\n    // Some leader text (\"_\" e.g.) creates higher top than container.\n    if (writingMode === \"vertical-rl\" || writingMode === \"vertical-lr\") {\n      if (direction === \"rtl\") {\n        box.top += innerMarginInlineEnd;\n      } else {\n        box.bottom -= innerMarginInlineEnd;\n      }\n      box.top = Math.min(innerInit.top, box.top);\n      box.bottom = Math.max(innerInit.bottom, box.bottom);\n    } else {\n      if (direction === \"rtl\") {\n        box.left += innerMarginInlineEnd;\n      } else {\n        box.right -= innerMarginInlineEnd;\n      }\n      box.left = Math.min(innerInit.left, box.left);\n      box.right = Math.max(innerInit.right, box.right);\n    }\n\n    function overrun() {\n      const inner = column.clientLayout.getElementClientRect(pseudoElem);\n      if (writingMode === \"vertical-rl\" || writingMode === \"vertical-lr\") {\n        if (direction === \"rtl\") {\n          inner.top -= followingInlineSiblingsWidth;\n        } else {\n          inner.bottom += followingInlineSiblingsWidth;\n        }\n      } else {\n        if (direction === \"rtl\") {\n          inner.left -= followingInlineSiblingsWidth;\n        } else {\n          inner.right += followingInlineSiblingsWidth;\n        }\n      }\n      if (\n        box.left > inner.left ||\n        box.right < inner.right ||\n        box.top > inner.top ||\n        box.bottom < inner.bottom\n      ) {\n        return true;\n      }\n      return false;\n    }\n\n    function setLeader() {\n      // min-max search\n      let lower: number;\n      let upper: number;\n      let templeader = leader.repeat(10000);\n      setLeaderTextContent(templeader);\n      if (overrun()) {\n        lower = 1;\n        upper = 10000;\n      } else {\n        return;\n      }\n      // leader is set to overrun state here\n      for (let i = 0; i < 16; i++) {\n        let templeader = \"\";\n        const mid = Math.floor((lower + upper) / 2);\n        for (let j = 0; j < mid; j++) {\n          templeader += leader;\n        }\n        setLeaderTextContent(templeader);\n        if (overrun()) {\n          upper = mid;\n        } else {\n          if (lower == mid) {\n            return;\n          }\n          lower = mid;\n        }\n      }\n      setLeaderTextContent(leader);\n    }\n\n    // set the expanded leader\n    setLeader();\n\n    // Without inline-end, we use margin-inline-start to adjust the position.\n    // To get the margin size, set float, calculate then cancel float.\n    const innerInline = column.clientLayout.getElementClientRect(pseudoElem);\n    if (direction == \"rtl\") {\n      pseudoElem.style.float = \"left\";\n    } else {\n      pseudoElem.style.float = \"right\";\n    }\n    const innerAligned = column.clientLayout.getElementClientRect(pseudoElem);\n    // When float is applied, the content will be removed from the normal\n    // text flow, and box inset will be also removed.\n    // When content comes back to the normal text flow, then inset effects again.\n    function getInset(side: string): number {\n      let inset = 0;\n      let p = pseudoElem.parentElement;\n      while (p && p !== container.viewNode) {\n        inset += column.getComputedInsets(p)[side];\n        p = p.parentElement;\n      }\n      return inset;\n    }\n    let padding = 0;\n    if (direction == \"rtl\") {\n      if (writingMode == \"vertical-rl\" || writingMode == \"vertical-lr\") {\n        padding = innerInline.top - innerAligned.top - getInset(\"top\");\n      } else {\n        padding = innerInline.left - innerAligned.left - getInset(\"left\");\n      }\n    } else {\n      if (writingMode == \"vertical-rl\" || writingMode == \"vertical-lr\") {\n        padding = innerAligned.bottom - innerInline.bottom - getInset(\"bottom\");\n      } else {\n        padding = innerAligned.right - innerInline.right - getInset(\"right\");\n      }\n    }\n    padding -= followingInlineSiblingsWidth;\n    padding = Math.max(0, padding - 0.1); // prevent line wrapping (Issue #1112)\n    pseudoElem.style.float = \"\";\n    leaderElem.style.marginInlineStart = `${padding}px`;\n\n    // Restore column-fill\n    if (columnContainer) {\n      if (originalColumnFill) {\n        columnContainer.style.columnFill = originalColumnFill;\n      } else {\n        columnContainer.style.removeProperty(\"column-fill\");\n      }\n    }\n  }\n};\n\nPlugin.registerHook(Plugin.HOOKS.POST_LAYOUT_BLOCK, postLayoutBlockLeader);\n\nexport function roman(num: number): string {\n  if (num <= 0 || num != Math.round(num) || num > 3999) {\n    return \"\";\n  }\n  const digits = [\"I\", \"V\", \"X\", \"L\", \"C\", \"D\", \"M\"];\n  let offset = 0;\n  let acc = \"\";\n  while (num > 0) {\n    let digit = num % 10;\n    num = (num - digit) / 10;\n    let result = \"\";\n    if (digit == 9) {\n      result += digits[offset] + digits[offset + 2];\n    } else if (digit == 4) {\n      result += digits[offset] + digits[offset + 1];\n    } else {\n      if (digit >= 5) {\n        result += digits[offset + 1];\n        digit -= 5;\n      }\n      while (digit > 0) {\n        result += digits[offset];\n        digit--;\n      }\n    }\n    acc = result + acc;\n    offset += 2;\n  }\n  return acc;\n}\n\n/**\n * Fitting order and specificity in the same number. Order is recorded in the\n * fractional part. Select value so that\n *\n *   0x7FFFFFFF != 0x7FFFFFFF + ORDER_INCREMENT\n *\n */\nexport const ORDER_INCREMENT = 1 / 0x100000;\n\nexport function copyTable(src: ActionTable, dst: ActionTable): void {\n  for (const n in src) {\n    dst[n] = src[n].clone();\n  }\n}\n\nexport class Cascade {\n  nsCount: number = 0;\n  nsPrefix: { [key: string]: string } = {};\n  tags: ActionTable = {};\n  nstags: ActionTable = {};\n  epubtypes: ActionTable = {};\n  classes: ActionTable = {};\n  ids: ActionTable = {};\n  pagetypes: ActionTable = {};\n  order: number = 0;\n\n  clone(): Cascade {\n    const r = new Cascade();\n    r.nsCount = this.nsCount;\n    for (const p in this.nsPrefix) {\n      r.nsPrefix[p] = this.nsPrefix[p];\n    }\n    copyTable(this.tags, r.tags);\n    copyTable(this.nstags, r.nstags);\n    copyTable(this.epubtypes, r.epubtypes);\n    copyTable(this.classes, r.classes);\n    copyTable(this.ids, r.ids);\n    copyTable(this.pagetypes, r.pagetypes);\n    r.order = this.order;\n    return r;\n  }\n\n  insertInTable(table: ActionTable, key: string, action: CascadeAction): void {\n    const a = table[key];\n    if (a) {\n      action = a.mergeWith(action);\n    }\n    table[key] = action;\n  }\n\n  createInstance(\n    context: Exprs.Context,\n    counterListener: CounterListener,\n    counterResolver: CounterResolver,\n    lang,\n    counterStyleStore: CounterStyle.CounterStyleStore,\n  ): CascadeInstance {\n    return new CascadeInstance(\n      this,\n      context,\n      counterListener,\n      counterResolver,\n      lang,\n      counterStyleStore,\n    );\n  }\n\n  nextOrder(): number {\n    return (this.order += ORDER_INCREMENT);\n  }\n}\n\nexport class CascadeInstance {\n  code: Cascade;\n  stack = [[], []] as ConditionItem[][];\n  conditions = {} as { [key: string]: number };\n  currentElement: Element | null = null;\n  currentElementOffset: number | null = null;\n  currentStyle: ElementStyle | null = null;\n  currentClassNames: string[] | null = null;\n  currentLocalName: string = \"\";\n  currentNamespace: string = \"\";\n  currentId: string = \"\";\n  currentXmlId: string = \"\";\n  currentNSTag: string = \"\";\n  currentEpubTypes: string[] | null = null;\n  currentPageType: string | null = null;\n  previousPageType: string | null = null;\n  firstPageType: string | null = null;\n  isFirst: boolean = true;\n  isRoot: boolean = true;\n  counters: CounterValues = {};\n  counterScoping: { [key: string]: boolean }[] = [{}];\n  quotes: Css.Str[];\n  quoteDepth: number = 0;\n  lang: string = \"\";\n  siblingOrderStack: number[] = [0];\n  currentSiblingOrder: number = 0;\n  siblingTypeCountsStack: { [key: string]: { [key: string]: number } }[] = [{}];\n  currentSiblingTypeCounts: { [key: string]: { [key: string]: number } };\n  currentFollowingSiblingOrder: number | null = null;\n  followingSiblingOrderStack: (number | null)[];\n  followingSiblingTypeCountsStack: {\n    [key: string]: { [key: string]: number };\n  }[] = [{}];\n  currentFollowingSiblingTypeCounts: {\n    [key: string]: { [key: string]: number };\n  };\n  viewConditions: { [key: string]: Matchers.Matcher[] } = {};\n  dependentConditions: string[] = [];\n  elementStack: Element[];\n\n  constructor(\n    cascade: Cascade,\n    public readonly context: Exprs.Context,\n    public readonly counterListener: CounterListener,\n    public readonly counterResolver: CounterResolver,\n    lang: string,\n    public readonly counterStyleStore: CounterStyle.CounterStyleStore,\n  ) {\n    this.code = cascade;\n    this.quotes = [\n      new Css.Str(\"\\u201c\"),\n      new Css.Str(\"\\u201d\"),\n      new Css.Str(\"\\u2018\"),\n      new Css.Str(\"\\u2019\"),\n    ];\n    this.currentSiblingTypeCounts = this.siblingTypeCountsStack[0];\n    this.followingSiblingOrderStack = [this.currentFollowingSiblingOrder];\n    this.currentFollowingSiblingTypeCounts = this.siblingTypeCountsStack[0];\n    if (VIVLIOSTYLE_DEBUG) {\n      this.elementStack = [];\n    }\n  }\n\n  pushConditionItem(item: ConditionItem): void {\n    this.stack[this.stack.length - 1].push(item);\n  }\n\n  increment(condition: string, viewCondition: Matchers.Matcher): void {\n    this.conditions[condition] = (this.conditions[condition] || 0) + 1;\n    if (!viewCondition) {\n      return;\n    }\n    if (this.viewConditions[condition]) {\n      this.viewConditions[condition].push(viewCondition);\n    } else {\n      this.viewConditions[condition] = [viewCondition];\n    }\n  }\n\n  decrement(condition: string, viewCondition: Matchers.Matcher): void {\n    this.conditions[condition]--;\n    if (!this.viewConditions[condition]) {\n      return;\n    }\n    this.viewConditions[condition] = this.viewConditions[condition].filter(\n      (item) => item !== viewCondition,\n    );\n    if (this.viewConditions[condition].length === 0) {\n      delete this.viewConditions[condition];\n    }\n  }\n\n  buildViewConditionMatcher(viewConditionId: string | null): Matchers.Matcher {\n    let matcher: Matchers.Matcher = null;\n    if (viewConditionId) {\n      Asserts.assert(this.currentElementOffset);\n      matcher = Matchers.MatcherBuilder.buildViewConditionMatcher(\n        this.currentElementOffset,\n        viewConditionId,\n      );\n    }\n    const dependentConditionMatchers = this.dependentConditions\n      .map((conditionId) => {\n        const conditions = this.viewConditions[conditionId];\n        if (conditions && conditions.length > 0) {\n          return conditions.length === 1\n            ? conditions[0]\n            : Matchers.MatcherBuilder.buildAnyMatcher([].concat(conditions));\n        } else {\n          return null;\n        }\n      })\n      .filter((item) => item);\n    if (dependentConditionMatchers.length <= 0) {\n      return matcher;\n    }\n    if (matcher === null) {\n      return dependentConditionMatchers.length === 1\n        ? dependentConditionMatchers[0]\n        : Matchers.MatcherBuilder.buildAllMatcher(dependentConditionMatchers);\n    }\n    return Matchers.MatcherBuilder.buildAllMatcher(\n      [matcher].concat(dependentConditionMatchers),\n    );\n  }\n\n  applyAction(table: ActionTable, key: string): void {\n    const action = table[key];\n    if (action) {\n      action.apply(this);\n    }\n  }\n\n  pushRule(\n    classes: string[],\n    pageType: string | null,\n    baseStyle: ElementStyle,\n  ): void {\n    this.currentElement = null;\n    this.currentElementOffset = null;\n    this.currentStyle = baseStyle;\n    this.currentNamespace = \"\";\n    this.currentLocalName = \"\";\n    this.currentId = \"\";\n    this.currentXmlId = \"\";\n    this.currentClassNames = classes;\n    this.currentNSTag = \"\";\n    this.currentEpubTypes = EMPTY;\n    this.currentPageType = pageType;\n    this.applyActions();\n  }\n\n  defineCounter(counterName: string, value: number) {\n    let scoping = this.counterScoping[this.counterScoping.length - 1];\n    if (!scoping) {\n      scoping = {};\n      this.counterScoping[this.counterScoping.length - 1] = scoping;\n    }\n    if (this.counters[counterName]) {\n      if (scoping[counterName]) {\n        this.counters[counterName].pop();\n      }\n      this.counters[counterName].push(value);\n    } else {\n      this.counters[counterName] = [value];\n    }\n    scoping[counterName] = true;\n  }\n\n  pushCounters(props: ElementStyle): void {\n    let displayVal: Css.Val = Css.ident.inline;\n    const display = props[\"display\"] as CascadeValue;\n    if (display) {\n      displayVal = display.evaluate(this.context);\n    }\n    // Ignore counter-* on 'display: none' elements and their descendants\n    if (displayVal === Css.ident.none) {\n      this.currentElement.setAttribute(\"data-viv-display-none\", \"true\");\n      this.counterScoping.push(null);\n      return;\n    } else if (this.currentElement.closest(\"[data-viv-display-none]\")) {\n      this.counterScoping.push(null);\n      return;\n    }\n    let floatVal: Css.Val = Css.ident.inline;\n    const float = props[\"float\"] as CascadeValue;\n    if (float) {\n      floatVal = float.evaluate(this.context);\n    }\n    let resetMap: { [key: string]: number } = null;\n    let incrementMap: { [key: string]: number } = null;\n    let setMap: { [key: string]: number } = null;\n    const reset = props[\"counter-reset\"] as CascadeValue;\n    if (reset) {\n      const resetVal = reset.evaluate(this.context);\n      if (resetVal) {\n        resetMap = CssProp.toCounters(resetVal, true);\n      }\n    }\n    const set = props[\"counter-set\"] as CascadeValue;\n    if (set) {\n      const setVal = set.evaluate(this.context);\n      if (setVal) {\n        setMap = CssProp.toCounters(setVal, false);\n      }\n    }\n    const increment = props[\"counter-increment\"] as CascadeValue;\n    if (increment) {\n      const incrementVal = increment.evaluate(this.context);\n      if (incrementVal) {\n        incrementMap = CssProp.toCounters(incrementVal, false);\n      }\n    }\n    if (\n      (this.currentLocalName == \"ol\" || this.currentLocalName == \"ul\") &&\n      this.currentNamespace == Base.NS.XHTML\n    ) {\n      if (!resetMap) {\n        resetMap = {};\n      }\n      resetMap[\"list-item\"] = ((this.currentElement as any)?.start ?? 1) - 1;\n    }\n    if (Display.isListItem(displayVal)) {\n      if (!incrementMap) {\n        incrementMap = {};\n      }\n      incrementMap[\"list-item\"] = incrementMap[\"list-item\"] ?? 1;\n      if (\n        /^\\s*[-+]?\\d/.test(this.currentElement?.getAttribute(\"value\") ?? \"\")\n      ) {\n        if (!setMap) {\n          setMap = {};\n        }\n        setMap[\"list-item\"] = (this.currentElement as any).value;\n      }\n    }\n    if (this.currentElement?.parentNode.nodeType === Node.DOCUMENT_NODE) {\n      if (!resetMap) {\n        resetMap = {};\n      }\n      // `counter-reset: footnote 0` is implicitly applied on the root element\n      if (resetMap[\"footnote\"] === undefined) {\n        resetMap[\"footnote\"] = 0;\n      }\n    }\n    if (floatVal === Css.ident.footnote) {\n      if (!incrementMap) {\n        incrementMap = {};\n      }\n      // `counter-increment: footnote 1` is implicitly applied on the\n      // element (or pseudo element) with `float: footnote`,\n      // unless `counter-increment: footnote` is explicitly specified\n      // on the element (parent element of the pseudo element).\n      if (incrementMap[\"footnote\"] === undefined) {\n        const incrPropValue = (\n          this.currentStyle[\"counter-increment\"] as CascadeValue\n        )?.value;\n        if (\n          !incrPropValue ||\n          !(\n            incrPropValue === Css.ident.footnote ||\n            (incrPropValue instanceof Css.SpaceList &&\n              incrPropValue.values.includes(Css.ident.footnote))\n          )\n        ) {\n          incrementMap[\"footnote\"] = 1;\n        }\n      }\n    }\n    if (resetMap) {\n      for (const resetCounterName in resetMap) {\n        this.defineCounter(resetCounterName, resetMap[resetCounterName]);\n      }\n    }\n    if (incrementMap) {\n      for (const incrementCounterName in incrementMap) {\n        if (!this.counters[incrementCounterName]) {\n          this.defineCounter(incrementCounterName, 0);\n        }\n        const counterValues = this.counters[incrementCounterName];\n        counterValues[counterValues.length - 1] +=\n          incrementMap[incrementCounterName];\n      }\n    }\n    if (setMap) {\n      for (const setCounterName in setMap) {\n        if (!this.counters[setCounterName]) {\n          this.defineCounter(setCounterName, setMap[setCounterName]);\n        } else {\n          const counterValues = this.counters[setCounterName];\n          counterValues[counterValues.length - 1] = setMap[setCounterName];\n        }\n      }\n    }\n    if (Display.isListItem(displayVal)) {\n      const listItemCounts = this.counters[\"list-item\"];\n      const listItemCount = listItemCounts[listItemCounts.length - 1];\n      props[\"ua-list-item-count\"] = new CascadeValue(\n        new Css.Num(listItemCount),\n        0,\n      );\n      // Ensure that ::marker pseudo-element exists for the list item\n      const pseudos = getMutableStyleMap(props, \"_pseudos\");\n      if (!pseudos[\"marker\"]) {\n        pseudos[\"marker\"] = {};\n      }\n    }\n    this.counterScoping.push(null);\n  }\n\n  popCounters(): void {\n    const scoping = this.counterScoping.pop();\n    if (scoping) {\n      for (const counterName in scoping) {\n        const arr = this.counters[counterName];\n        if (arr) {\n          if (arr.length == 1) {\n            delete this.counters[counterName];\n          } else {\n            arr.pop();\n          }\n        }\n      }\n    }\n  }\n\n  /**\n   * Process CSS string-set property\n   * https://drafts.csswg.org/css-gcpm-3/#setting-named-strings-the-string-set-pro\n   */\n  setNamedStrings(props: ElementStyle): void {\n    let stringSet = props[\"string-set\"] as CascadeValue;\n    if (!stringSet) {\n      return;\n    }\n    stringSet = stringSet.filterValue(\n      new ContentPropVisitor(this, this.currentElement, this.counterResolver),\n    );\n    const sets =\n      stringSet.value instanceof Css.CommaList\n        ? stringSet.value.values\n        : [stringSet.value];\n\n    for (const set of sets) {\n      if (set instanceof Css.SpaceList) {\n        const name = set.values[0].stringValue();\n        const stringValue = set.values\n          .slice(1)\n          .map((v) => getStringValueFromCssContentVal(v))\n          .join(\"\");\n        this.counterResolver.setNamedString(\n          name,\n          stringValue,\n          this.currentElementOffset,\n        );\n      }\n    }\n    delete props[\"string-set\"];\n  }\n\n  /**\n   * Process CSS running elements\n   * https://drafts.csswg.org/css-gcpm-3/#running-elements\n   */\n  setRunningElement(props: ElementStyle): void {\n    const position = props[\"position\"] as CascadeValue;\n    if (\n      position?.value instanceof Css.Func &&\n      position.value.name === \"running\"\n    ) {\n      const name = position.value.values[0].stringValue();\n      this.counterResolver.setRunningElement(name, this.currentElementOffset);\n    }\n  }\n\n  processPseudoelementProps(pseudoprops: ElementStyle, element: Element): void {\n    this.pushCounters(pseudoprops);\n    const content = pseudoprops[\"content\"] as CascadeValue;\n    if (content) {\n      pseudoprops[\"content\"] = content.filterValue(\n        new ContentPropVisitor(this, element, this.counterResolver),\n      );\n    }\n    this.popCounters();\n  }\n\n  pushElement(\n    styler: CssStyler.AbstractStyler,\n    element: Element,\n    baseStyle: ElementStyle,\n    elementOffset: number,\n  ): void {\n    if (VIVLIOSTYLE_DEBUG) {\n      this.elementStack.push(element);\n    }\n\n    // do not apply page rules\n    this.currentPageType = null;\n    this.currentElement = element;\n    this.currentElementOffset = elementOffset;\n    this.currentStyle = baseStyle;\n    this.currentNamespace = element.namespaceURI;\n    this.currentLocalName = element.localName;\n    const prefix = this.code.nsPrefix[this.currentNamespace];\n    if (prefix) {\n      this.currentNSTag = prefix + this.currentLocalName;\n    } else {\n      this.currentNSTag = \"\";\n    }\n    this.currentId = element.getAttribute(\"id\");\n    this.currentXmlId = element.getAttributeNS(Base.NS.XML, \"id\");\n    const classes = element.getAttribute(\"class\");\n    if (classes) {\n      this.currentClassNames = classes.split(/\\s+/);\n    } else {\n      this.currentClassNames = EMPTY;\n    }\n    const types = element.getAttributeNS(Base.NS.epub, \"type\");\n    if (types) {\n      this.currentEpubTypes = types.split(/\\s+/);\n    } else {\n      this.currentEpubTypes = EMPTY;\n    }\n    const lang = Base.getLangAttribute(element);\n    if (lang) {\n      this.stack[this.stack.length - 1].push(new RestoreLangItem(this.lang));\n      this.lang = lang.toLowerCase();\n    }\n    const isRoot = this.isRoot;\n    const siblingOrderStack = this.siblingOrderStack;\n    this.currentSiblingOrder = ++siblingOrderStack[\n      siblingOrderStack.length - 1\n    ];\n    siblingOrderStack.push(0);\n    const siblingTypeCountsStack = this.siblingTypeCountsStack;\n    const currentSiblingTypeCounts = (this.currentSiblingTypeCounts =\n      siblingTypeCountsStack[siblingTypeCountsStack.length - 1]);\n    let currentNamespaceTypeCounts =\n      currentSiblingTypeCounts[this.currentNamespace];\n    if (!currentNamespaceTypeCounts) {\n      currentNamespaceTypeCounts = currentSiblingTypeCounts[\n        this.currentNamespace\n      ] = {};\n    }\n    currentNamespaceTypeCounts[this.currentLocalName] =\n      (currentNamespaceTypeCounts[this.currentLocalName] || 0) + 1;\n    siblingTypeCountsStack.push({});\n    const followingSiblingOrderStack = this.followingSiblingOrderStack;\n    if (\n      followingSiblingOrderStack[followingSiblingOrderStack.length - 1] !== null\n    ) {\n      this.currentFollowingSiblingOrder = --followingSiblingOrderStack[\n        followingSiblingOrderStack.length - 1\n      ];\n    } else {\n      this.currentFollowingSiblingOrder = null;\n    }\n    followingSiblingOrderStack.push(null);\n    const followingSiblingTypeCountsStack =\n      this.followingSiblingTypeCountsStack;\n    const currentFollowingSiblingTypeCounts =\n      (this.currentFollowingSiblingTypeCounts =\n        followingSiblingTypeCountsStack[\n          followingSiblingTypeCountsStack.length - 1\n        ]);\n    if (\n      currentFollowingSiblingTypeCounts &&\n      currentFollowingSiblingTypeCounts[this.currentNamespace]\n    ) {\n      currentFollowingSiblingTypeCounts[this.currentNamespace][\n        this.currentLocalName\n      ]--;\n    }\n    followingSiblingTypeCountsStack.push({});\n    this.applyActions();\n\n    // Substitute var()\n    this.applyVarFilter([this.currentStyle], styler, element);\n\n    // Calculate calc()\n    this.applyCalcFilter(this.currentStyle, this.context);\n\n    this.applyAttrFilter(element);\n    const quotesCasc = baseStyle[\"quotes\"] as CascadeValue;\n    let itemToPushLast: QuotesScopeItem | null = null;\n    if (quotesCasc) {\n      const quotesVal = quotesCasc.evaluate(this.context);\n      if (quotesVal) {\n        itemToPushLast = new QuotesScopeItem(this.quotes);\n        if (quotesVal === Css.ident.none) {\n          this.quotes = [new Css.Str(\"\"), new Css.Str(\"\")];\n        } else if (\n          quotesVal === Css.ident.auto ||\n          quotesVal === Css.ident.initial\n        ) {\n          this.quotes = [\n            new Css.Str(\"\\u201c\"),\n            new Css.Str(\"\\u201d\"),\n            new Css.Str(\"\\u2018\"),\n            new Css.Str(\"\\u2019\"),\n          ];\n          // FIXME: quotes:auto should be based on the content language\n        } else if (quotesVal instanceof Css.SpaceList) {\n          this.quotes = (quotesVal as Css.SpaceList).values as Css.Str[];\n        }\n      }\n    }\n    this.pushCounters(this.currentStyle);\n    const id =\n      this.currentId || this.currentXmlId || element.getAttribute(\"name\") || \"\";\n    if (isRoot || id) {\n      const counters: CounterValues = {};\n      Object.keys(this.counters).forEach((name) => {\n        counters[name] = Array.from(this.counters[name]);\n      });\n      this.counterListener.countersOfId(id, counters);\n    }\n    const pseudos = getStyleMap(this.currentStyle, \"_pseudos\");\n    if (pseudos) {\n      let before = true;\n      for (const pseudoName of pseudoNames) {\n        if (!pseudoName) {\n          // content\n          before = false;\n        }\n        const pseudoProps = pseudos[pseudoName];\n        if (pseudoProps) {\n          if (\n            ((pseudoName === \"before\" || pseudoName === \"after\") &&\n              !Vtree.nonTrivialContent(\n                (pseudoProps[\"content\"] as CascadeValue)?.value,\n              )) ||\n            (pseudoName === \"marker\" &&\n              !Display.isListItem(\n                getProp(this.currentStyle, \"display\")?.value,\n              )) ||\n            ((pseudoName === \"footnote-call\" ||\n              pseudoName === \"footnote-marker\") &&\n              getProp(this.currentStyle, \"float\")?.value !== Css.ident.footnote)\n          ) {\n            delete pseudos[pseudoName];\n          } else if (before) {\n            this.processPseudoelementProps(pseudoProps, element);\n\n            if (pseudoName === \"marker\") {\n              // Make marker content from list-style-* properties\n              this.processMarkerPseudoelementProps(\n                pseudoProps,\n                element,\n                styler,\n              );\n            }\n          } else {\n            this.stack[this.stack.length - 2].push(\n              new AfterPseudoelementItem(pseudoProps, element),\n            );\n          }\n        }\n      }\n    }\n\n    // process CSS string-set property\n    this.setNamedStrings(this.currentStyle);\n\n    // process CSS running elements\n    this.setRunningElement(this.currentStyle);\n\n    if (itemToPushLast) {\n      this.stack[this.stack.length - 2].push(itemToPushLast);\n    }\n  }\n\n  processMarkerPseudoelementProps(\n    pseudoProps: ElementStyle,\n    element: Element,\n    styler: CssStyler.AbstractStyler,\n  ): void {\n    if (\n      !Vtree.nonTrivialContent(\n        (pseudoProps[\"content\"] as CascadeValue)?.value,\n      ) &&\n      Display.isListItem((this.currentStyle[\"display\"] as CascadeValue)?.value)\n    ) {\n      // If no ::marker content is specified and the element is a list-item,\n      // make content from list-style-type or list-style-image.\n      const listStyleType = this.getInheritedPropertyValue(\n        \"list-style-type\",\n        styler,\n        element,\n      );\n      const listStyleImage = this.getInheritedPropertyValue(\n        \"list-style-image\",\n        styler,\n        element,\n      );\n      if (listStyleImage instanceof Css.URL) {\n        // list-style-image: <URL>\n        // -> content: <URL> \" \"\n        pseudoProps[\"content\"] = new CascadeValue(\n          new Css.SpaceList([listStyleImage, new Css.Str(\" \")]),\n          0,\n        );\n      } else if (listStyleType instanceof Css.Str) {\n        // list-style-type: <string>\n        pseudoProps[\"content\"] = new CascadeValue(listStyleType, 0);\n      } else if (\n        listStyleType instanceof Css.Ident &&\n        listStyleType !== Css.ident.none\n      ) {\n        // list-style-type: <counter-style>\n        const listItemCount = (\n          (this.currentStyle[\"ua-list-item-count\"] as CascadeValue)\n            ?.value as Css.Num\n        )?.num;\n        if (listItemCount != null) {\n          pseudoProps[\"content\"] = new CascadeValue(\n            new Css.Str(\n              this.counterStyleStore.formatMarker(\n                listStyleType.name,\n                listItemCount,\n              ),\n            ),\n            0,\n          );\n        }\n        // This is used in the marker layout processing in\n        // `PseudoelementStyler.processMarker()` in pseudo-element.ts.\n        pseudoProps[\"list-style-type\"] = new CascadeValue(listStyleType, 0);\n      }\n    }\n\n    // list-style-position\n    if (!Display.isInlineLevel(getProp(this.currentStyle, \"display\")?.value)) {\n      const listStylePosition = this.getInheritedPropertyValue(\n        \"list-style-position\",\n        styler,\n        element,\n      );\n      if (listStylePosition) {\n        // This is used in the marker layout processing in\n        // `PseudoelementStyler.processMarker()` in pseudo-element.ts.\n        pseudoProps[\"list-style-position\"] = new CascadeValue(\n          listStylePosition,\n          0,\n        );\n      }\n    }\n  }\n\n  /**\n   * Get inherited property value\n   * @param propName\n   * @param styler\n   * @param element\n   * @returns the inherited property value, or the initial value (or null) if not found\n   */\n  getInheritedPropertyValue(\n    propName: string,\n    styler: CssStyler.AbstractStyler,\n    element: Element,\n  ): Css.Val | null {\n    for (let e = element; e; e = e.parentElement) {\n      const style =\n        e === this.currentElement\n          ? this.currentStyle\n          : styler.getStyle(e, false);\n      const prop = style[propName] as CascadeValue;\n      if (prop) {\n        const val = prop.evaluate(this.context, propName);\n        if (\n          val === Css.ident.inherit ||\n          val === Css.ident.unset ||\n          val === Css.ident.revert\n        ) {\n          continue;\n        } else if (val === Css.ident.initial) {\n          break;\n        }\n        return val;\n      }\n    }\n    const validatorSet = (\n      styler as AbstractStyler & { validatorSet: CssValidator.ValidatorSet }\n    ).validatorSet;\n    return validatorSet?.defaultValues[propName] ?? null;\n  }\n\n  private applyAttrFilterInner(\n    visitor: Css.Visitor,\n    elementStyle: ElementStyle,\n  ): void {\n    for (const propName in elementStyle) {\n      if (isPropName(propName) && !Css.isCustomPropName(propName)) {\n        elementStyle[propName] = (\n          elementStyle[propName] as CascadeValue\n        ).filterValue(visitor);\n      }\n    }\n  }\n\n  private applyAttrFilter(element: Element): void {\n    const visitor = new AttrValueFilterVisitor(element);\n    const currentStyle = this.currentStyle;\n    const pseudoMap = getStyleMap(currentStyle, \"_pseudos\");\n    for (const pseudoName in pseudoMap) {\n      this.applyAttrFilterInner(visitor, pseudoMap[pseudoName]);\n    }\n    this.applyAttrFilterInner(visitor, currentStyle);\n  }\n\n  /**\n   * Substitute all variables in property values in elementStyle\n   */\n  applyVarFilter(\n    elementStyles: ElementStyle[],\n    styler: CssStyler.AbstractStyler,\n    element: Element | null,\n  ): void {\n    const elementStyle = elementStyles[0];\n    const visitor = new VarFilterVisitor(elementStyles, styler, element);\n    const LIMIT_LOOP = 32; // prevent cyclic or too deep dependency\n    const propsLH: ElementStyle = {}; // for shorthand -> longhand cascade\n\n    for (const name in elementStyle) {\n      if (isMapName(name)) {\n        const pseudoMap = getStyleMap(elementStyle, name);\n        for (const pseudoName in pseudoMap) {\n          this.applyVarFilter(\n            [pseudoMap[pseudoName], ...elementStyles],\n            styler,\n            element,\n          );\n        }\n      } else if (isPropName(name)) {\n        const cascVal = getProp(elementStyle, name);\n        let value = cascVal.value;\n\n        for (let i = 0; ; i++) {\n          if (i >= LIMIT_LOOP) {\n            value = Css.empty;\n            break;\n          }\n          const after = value.visit(visitor);\n          if (visitor.error) {\n            // invalid or unresolved variable found\n            value = Css.empty;\n            visitor.error = false;\n            break;\n          }\n          if (after === value) {\n            // no variable, or all variables substituted\n            break;\n          }\n          // variables substituted, but the substituted value may contain variables\n          value = after;\n        }\n        if (value !== cascVal.value) {\n          // all variables substituted\n          const validatorSet = (styler as any)\n            .validatorSet as CssValidator.ValidatorSet;\n          const shorthand = validatorSet?.shorthands[name]?.clone();\n          if (shorthand) {\n            if (Css.isDefaultingValue(value)) {\n              for (const nameLH of shorthand.propList) {\n                const avLH = new CascadeValue(value, cascVal.priority);\n                const tvLH = getProp(elementStyle, nameLH);\n                setProp(\n                  propsLH,\n                  nameLH,\n                  cascadeValues(this.context, tvLH, avLH),\n                );\n              }\n              delete elementStyle[name];\n            } else {\n              // The var()-substituted value may have complex structure\n              // (e.g. SpaceList in SpaceList) that ShorthandValidator\n              // cannot handle, so use toString and parseValue.\n              const valueSH = CssParser.parseValue(\n                (styler as any).scope,\n                new CssTokenizer.Tokenizer(value.toString(), null),\n                \"\",\n              );\n              if (valueSH) {\n                valueSH.visit(shorthand);\n                if (!shorthand.error) {\n                  for (const nameLH of shorthand.propList) {\n                    const avLH = new CascadeValue(\n                      shorthand.values[nameLH] ??\n                        validatorSet.defaultValues[nameLH] ??\n                        Css.ident.initial,\n                      cascVal.priority,\n                    );\n                    const tvLH = getProp(elementStyle, nameLH);\n                    setProp(\n                      propsLH,\n                      nameLH,\n                      cascadeValues(this.context, tvLH, avLH),\n                    );\n                  }\n                  delete elementStyle[name];\n                }\n              }\n            }\n          } else {\n            elementStyle[name] = new CascadeValue(value, cascVal.priority);\n          }\n        }\n        if (propsLH[name]) {\n          const av = getProp(elementStyle, name);\n          if (av && av.value !== Css.empty) {\n            setPropCascadeValue(propsLH, name, av, this.context);\n          }\n        }\n      }\n    }\n    // Update elementStyle with shorthand -> longhand cascade result\n    for (const name in propsLH) {\n      elementStyle[name] = propsLH[name];\n    }\n  }\n\n  /**\n   * Calculate all calc() in property values in elementStyle\n   */\n  applyCalcFilter(elementStyle: ElementStyle, context: Exprs.Context): void {\n    const visitor = new CalcFilterVisitor(context);\n    for (const name in elementStyle) {\n      if (isMapName(name)) {\n        const pseudoMap = getStyleMap(elementStyle, name);\n        for (const pseudoName in pseudoMap) {\n          this.applyCalcFilter(pseudoMap[pseudoName], context);\n        }\n      } else if (isPropName(name) && !Css.isCustomPropName(name)) {\n        const cascVal = getProp(elementStyle, name);\n        const value = cascVal.value.visit(visitor);\n        if (value !== cascVal.value) {\n          elementStyle[name] = new CascadeValue(value, cascVal.priority);\n        }\n      }\n    }\n  }\n\n  private applyActions(): void {\n    let i: number;\n    for (i = 0; i < this.currentClassNames.length; i++) {\n      this.applyAction(this.code.classes, this.currentClassNames[i]);\n    }\n    for (i = 0; i < this.currentEpubTypes.length; i++) {\n      this.applyAction(this.code.epubtypes, this.currentEpubTypes[i]);\n    }\n    this.applyAction(this.code.ids, this.currentId);\n    this.applyAction(this.code.tags, this.currentLocalName);\n    if (this.currentLocalName != \"\") {\n      // Universal selector does not apply to page-master-related rules.\n      this.applyAction(this.code.tags, \"*\");\n    }\n    this.applyAction(this.code.nstags, this.currentNSTag);\n\n    // Apply page rules only when currentPageType is not null\n    if (this.currentPageType !== null) {\n      this.applyAction(this.code.pagetypes, this.currentPageType);\n\n      // We represent page rules without selectors by *, though it is illegal in\n      // CSS\n      this.applyAction(this.code.pagetypes, \"*\");\n    }\n\n    this.stack.push([]);\n    for (let depth = 1; depth >= -1; --depth) {\n      const list = this.stack[this.stack.length - depth - 2];\n      i = 0;\n      while (i < list.length) {\n        if (list[i].push(this, depth)) {\n          // done\n          list.splice(i, 1);\n        } else {\n          i++;\n        }\n      }\n    }\n    this.isFirst = true;\n    this.isRoot = false;\n  }\n\n  private pop(): void {\n    for (let depth = 1; depth >= -1; --depth) {\n      const list = this.stack[this.stack.length - depth - 2];\n      let i = 0;\n      while (i < list.length) {\n        if (list[i].pop(this, depth)) {\n          // done\n          list.splice(i, 1);\n        } else {\n          i++;\n        }\n      }\n    }\n    this.stack.pop();\n    this.isFirst = false;\n  }\n\n  popRule(): void {\n    this.pop();\n  }\n\n  popElement(element: Element): void {\n    if (VIVLIOSTYLE_DEBUG) {\n      const e = this.elementStack.pop();\n      if (e !== element) {\n        throw new Error(\"Invalid call to popElement\");\n      }\n    }\n    this.siblingOrderStack.pop();\n    this.siblingTypeCountsStack.pop();\n    this.followingSiblingOrderStack.pop();\n    this.followingSiblingTypeCountsStack.pop();\n    this.pop();\n    this.popCounters();\n  }\n}\n\nexport const EMPTY: string[] = [];\n\n/**\n * Pseudoelement names in the order they should be processed, empty string is\n * the place where the element's DOM children are processed.\n */\nexport const pseudoNames = [\n  \"before\",\n  \"transclusion-before\",\n  \"footnote-call\",\n  \"footnote-marker\",\n  \"marker\",\n  \"inner\",\n  \"first-letter\",\n  \"first-line\",\n  \"\", // content\n  \"transclusion-after\",\n  \"after\",\n];\n\n/**\n * @enum {number}\n */\nexport enum ParseState {\n  TOP,\n  SELECTOR,\n  RULE,\n}\n\n/**\n * Cascade for base User Agent stylesheet.\n */\nexport let uaBaseCascade: Cascade = null;\nexport function setUABaseCascade(value: Cascade): void {\n  uaBaseCascade = value;\n}\n\n//------------- parsing ------------\nexport class CascadeParserHandler\n  extends CssParser.SlaveParserHandler\n  implements CssValidator.PropertyReceiver\n{\n  chain: ChainedAction[] = null;\n  specificity: number = 0;\n  elementStyle: ElementStyle = null;\n  conditionCount: number = 0;\n  pseudoelement: string | null = null;\n  footnoteContent: boolean = false;\n  cascade: Cascade;\n  state: ParseState;\n  viewConditionId: string | null = null;\n  insideSelectorRule: ParseState;\n  invalid: boolean = false; // for `@supports selector()` check\n\n  constructor(\n    scope: Exprs.LexicalScope,\n    owner: CssParser.DispatchParserHandler,\n    public readonly condition: Exprs.Val,\n    parent: CascadeParserHandler,\n    public readonly regionId: string | null,\n    public readonly validatorSet: CssValidator.ValidatorSet,\n    topLevel: boolean,\n  ) {\n    super(scope, owner, topLevel);\n    this.cascade = parent\n      ? parent.cascade\n      : uaBaseCascade\n        ? uaBaseCascade.clone()\n        : new Cascade();\n    this.state = ParseState.TOP;\n  }\n\n  protected insertNonPrimary(action: CascadeAction): void {\n    this.cascade.insertInTable(this.cascade.tags, \"*\", action);\n  }\n\n  processChain(action: CascadeAction): void {\n    const chained = chainActions(this.chain, action);\n    if (\n      chained !== action &&\n      (chained as ChainedAction).makePrimary(this.cascade)\n    ) {\n      return;\n    }\n    this.insertNonPrimary(chained);\n  }\n\n  isInsideSelectorRule(mnemonics: string): boolean {\n    if (this.state != ParseState.TOP) {\n      this.reportAndSkip(mnemonics);\n      return true;\n    }\n    return false;\n  }\n\n  override tagSelector(ns: string | null, name: string | null): void {\n    if (!name && !ns) {\n      return;\n    }\n    if (name) {\n      this.specificity += 1;\n    }\n    if (name && ns) {\n      this.chain.push(new CheckNSTagAction(ns, name.toLowerCase()));\n    } else if (name) {\n      this.chain.push(new CheckLocalNameAction(name.toLowerCase()));\n    } else {\n      this.chain.push(new CheckNamespaceAction(ns as string));\n    }\n  }\n\n  invalidSelector(message: string): void {\n    Logging.logger.warn(message);\n    this.chain.push(new CheckConditionAction(\"\")); // always fails\n    this.setInvalid();\n  }\n\n  setInvalid(): void {\n    this.invalid = true;\n    for (\n      let handler: CascadeParserHandler = this;\n      handler instanceof MatchesParameterParserHandler;\n      handler = handler.parent\n    ) {\n      handler.parent.invalid = true;\n    }\n  }\n\n  override classSelector(name: string): void {\n    if (this.pseudoelement) {\n      this.invalidSelector(`::${this.pseudoelement} followed by .${name}`);\n      return;\n    }\n    this.specificity += 256;\n    this.chain.push(new CheckClassAction(name));\n  }\n\n  override pseudoclassSelector(\n    name: string,\n    params: (number | string)[],\n  ): void {\n    if (this.pseudoelement) {\n      this.invalidSelector(`::${this.pseudoelement} followed by :${name}`);\n      return;\n    }\n    switch (name.toLowerCase()) {\n      case \"enabled\":\n        this.chain.push(new IsEnabledAction());\n        break;\n      case \"disabled\":\n        this.chain.push(new IsDisabledAction());\n        break;\n      case \"checked\":\n        this.chain.push(new IsCheckedAction());\n        break;\n      case \"root\":\n      case \"scope\":\n        this.chain.push(new IsRootAction());\n        break;\n      case \"link\":\n        this.chain.push(new CheckLocalNameAction(\"a\"));\n        this.chain.push(new CheckAttributePresentAction(\"\", \"href\"));\n        break;\n      case \"-adapt-href-epub-type\":\n      case \"href-epub-type\":\n        if (params && params.length >= 1 && typeof params[0] == \"string\") {\n          const value = params[0] as string;\n          const patt = new RegExp(`(^|\\\\s)${Base.escapeRegExp(value)}(\\$|\\\\s)`);\n          const targetLocalName = params[1] as string;\n          this.chain.push(new CheckTargetEpubTypeAction(patt, targetLocalName));\n        } else {\n          this.chain.push(new CheckConditionAction(\"\")); // always fails\n        }\n        break;\n      case \"-adapt-footnote-content\":\n      case \"footnote-content\":\n        // content inside the footnote\n        this.footnoteContent = true;\n        break;\n      case \"visited\":\n      case \"active\":\n      case \"hover\":\n      case \"focus\":\n        this.chain.push(new CheckConditionAction(\"\")); // always fails\n        break;\n      case \"lang\":\n        if (params && params.length == 1 && typeof params[0] == \"string\") {\n          const langValue = params[0] as string;\n          this.chain.push(\n            new CheckLangAction(\n              new RegExp(\n                `^${Base.escapeRegExp(langValue.toLowerCase())}(\\$|-)`,\n              ),\n            ),\n          );\n        } else {\n          this.chain.push(new CheckConditionAction(\"\")); // always fails\n        }\n        break;\n      case \"nth-child\":\n      case \"nth-last-child\":\n      case \"nth-of-type\":\n      case \"nth-last-of-type\": {\n        const ActionClass = nthSelectorActionClasses[name.toLowerCase()];\n        if (params && params.length == 2) {\n          this.chain.push(\n            new ActionClass(params[0] as number, params[1] as number),\n          );\n        } else {\n          this.chain.push(new CheckConditionAction(\"\")); // always fails\n        }\n        break;\n      }\n      case \"first-child\":\n        this.chain.push(new IsFirstAction());\n        break;\n      case \"last-child\":\n        this.chain.push(new IsNthLastSiblingAction(0, 1));\n        break;\n      case \"first-of-type\":\n        this.chain.push(new IsNthSiblingOfTypeAction(0, 1));\n        break;\n      case \"last-of-type\":\n        this.chain.push(new IsNthLastSiblingOfTypeAction(0, 1));\n        break;\n      case \"only-child\":\n        this.chain.push(new IsFirstAction());\n        this.chain.push(new IsNthLastSiblingAction(0, 1));\n        break;\n      case \"only-of-type\":\n        this.chain.push(new IsNthSiblingOfTypeAction(0, 1));\n        this.chain.push(new IsNthLastSiblingOfTypeAction(0, 1));\n        break;\n      case \"empty\":\n        this.chain.push(new IsEmptyAction());\n        break;\n      case \"before\":\n      case \"after\":\n      case \"first-line\":\n      case \"first-letter\":\n        this.pseudoelementSelector(name, params);\n        return;\n      default: // always fails\n        this.invalidSelector(`Unknown pseudo-class :${name}`);\n        return;\n    }\n    this.specificity += 256;\n  }\n\n  override pseudoelementSelector(\n    name: string,\n    params: (number | string)[],\n  ): void {\n    switch (name) {\n      case \"before\":\n      case \"after\":\n      case \"first-line\":\n      case \"first-letter\":\n      case \"footnote-call\":\n      case \"footnote-marker\":\n      case \"marker\":\n      case \"inner\":\n      case \"after-if-continues\":\n        if (!this.pseudoelement) {\n          this.pseudoelement = name;\n        } else {\n          this.invalidSelector(\n            `Double pseudo-element ::${this.pseudoelement}::${name}`,\n          );\n          return;\n        }\n        break;\n      case \"first-n-lines\":\n        if (params && params.length == 1 && typeof params[0] == \"number\") {\n          const n = Math.round(params[0] as number);\n          if (n > 0 && n == params[0]) {\n            if (!this.pseudoelement) {\n              this.pseudoelement = `first-${n}-lines`;\n            } else {\n              this.invalidSelector(\n                `Double pseudo-element ::${this.pseudoelement}::${name}`,\n              );\n              return;\n            }\n            break;\n          }\n        }\n        this.chain.push(new CheckConditionAction(\"\")); // always fails\n        break;\n      case \"nth-fragment\":\n        if (params && params.length == 2) {\n          this.viewConditionId = `NFS_${params[0]}_${params[1]}`;\n        } else {\n          this.chain.push(new CheckConditionAction(\"\")); // always fails\n        }\n        break;\n      default: // always fails\n        this.invalidSelector(`Unknown pseudo-element ::${name}`);\n        return;\n    }\n    this.specificity += 1;\n  }\n\n  override idSelector(id: string): void {\n    this.specificity += 65536;\n    this.chain.push(new CheckIdAction(id));\n  }\n\n  override attributeSelector(\n    ns: string,\n    name: string,\n    op: TokenType,\n    value: string | null,\n  ): void {\n    this.specificity += 256;\n    name = name.toLowerCase();\n    value = value || \"\";\n    let action;\n    switch (op) {\n      case TokenType.EOF:\n        action = new CheckAttributePresentAction(ns, name);\n        break;\n      case TokenType.EQ:\n        action = new CheckAttributeEqAction(ns, name, value);\n        break;\n      case TokenType.TILDE_EQ:\n        if (!value || value.match(/\\s/)) {\n          action = new CheckConditionAction(\"\"); // always fails\n        } else {\n          action = new CheckAttributeRegExpAction(\n            ns,\n            name,\n            new RegExp(`(^|\\\\s)${Base.escapeRegExp(value)}(\\$|\\\\s)`),\n          );\n        }\n        break;\n      case TokenType.BAR_EQ:\n        action = new CheckAttributeRegExpAction(\n          ns,\n          name,\n          new RegExp(`^${Base.escapeRegExp(value)}(\\$|-)`),\n        );\n        break;\n      case TokenType.HAT_EQ:\n        if (!value) {\n          action = new CheckConditionAction(\"\"); // always fails\n        } else {\n          action = new CheckAttributeRegExpAction(\n            ns,\n            name,\n            new RegExp(`^${Base.escapeRegExp(value)}`),\n          );\n        }\n        break;\n      case TokenType.DOLLAR_EQ:\n        if (!value) {\n          action = new CheckConditionAction(\"\"); // always fails\n        } else {\n          action = new CheckAttributeRegExpAction(\n            ns,\n            name,\n            new RegExp(`${Base.escapeRegExp(value)}\\$`),\n          );\n        }\n        break;\n      case TokenType.STAR_EQ:\n        if (!value) {\n          action = new CheckConditionAction(\"\"); // always fails\n        } else {\n          action = new CheckAttributeRegExpAction(\n            ns,\n            name,\n            new RegExp(Base.escapeRegExp(value)),\n          );\n        }\n        break;\n      case TokenType.COL_COL:\n        if (value == \"supported\") {\n          action = new CheckNamespaceSupportedAction(ns, name);\n        } else {\n          this.invalidSelector(`Unsupported :: attr selector op: ${value}`);\n          return;\n        }\n        break;\n      default:\n        this.invalidSelector(`Unsupported attr selector: ${op}`);\n        return;\n    }\n    this.chain.push(action);\n  }\n\n  override descendantSelector(): void {\n    const condition = `d${conditionCount++}`;\n    this.processChain(\n      new ConditionItemAction(\n        new DescendantConditionItem(condition, this.viewConditionId, null),\n      ),\n    );\n    this.chain = [new CheckConditionAction(condition)];\n    this.viewConditionId = null;\n  }\n\n  override childSelector(): void {\n    const condition = `c${conditionCount++}`;\n    this.processChain(\n      new ConditionItemAction(\n        new ChildConditionItem(condition, this.viewConditionId, null),\n      ),\n    );\n    this.chain = [new CheckConditionAction(condition)];\n    this.viewConditionId = null;\n  }\n\n  override adjacentSiblingSelector(): void {\n    const condition = `a${conditionCount++}`;\n    this.processChain(\n      new ConditionItemAction(\n        new AdjacentSiblingConditionItem(condition, this.viewConditionId, null),\n      ),\n    );\n    this.chain = [new CheckConditionAction(condition)];\n    this.viewConditionId = null;\n  }\n\n  override followingSiblingSelector(): void {\n    const condition = `f${conditionCount++}`;\n    this.processChain(\n      new ConditionItemAction(\n        new FollowingSiblingConditionItem(\n          condition,\n          this.viewConditionId,\n          null,\n        ),\n      ),\n    );\n    this.chain = [new CheckConditionAction(condition)];\n    this.viewConditionId = null;\n  }\n\n  override nextSelector(): void {\n    this.finishChain();\n    this.pseudoelement = null;\n    this.footnoteContent = false;\n    this.specificity = 0;\n    this.chain = [];\n  }\n\n  override startSelectorRule(): void {\n    if (this.isInsideSelectorRule(\"E_CSS_UNEXPECTED_SELECTOR\")) {\n      return;\n    }\n    this.state = ParseState.SELECTOR;\n    this.elementStyle = {} as ElementStyle;\n    this.pseudoelement = null;\n    this.specificity = 0;\n    this.footnoteContent = false;\n    this.chain = [];\n    this.invalid = false;\n  }\n\n  override error(mnemonics: string, token: CssTokenizer.Token): void {\n    super.error(mnemonics, token);\n    if (this.state == ParseState.SELECTOR) {\n      this.state = ParseState.TOP;\n    }\n    this.setInvalid();\n  }\n\n  override startStylesheet(flavor: CssParser.StylesheetFlavor): void {\n    super.startStylesheet(flavor);\n    this.state = ParseState.TOP;\n  }\n\n  override startRuleBody(): void {\n    this.finishChain();\n    super.startRuleBody();\n    if (this.state == ParseState.SELECTOR) {\n      this.state = ParseState.TOP;\n    }\n  }\n\n  override endRule(): void {\n    super.endRule();\n    this.insideSelectorRule = ParseState.TOP;\n  }\n\n  finishChain(): void {\n    if (this.chain) {\n      this.processChain(this.makeApplyRuleAction(this.specificity));\n      this.chain = null;\n      this.pseudoelement = null;\n      this.viewConditionId = null;\n      this.footnoteContent = false;\n      this.specificity = 0;\n    }\n  }\n\n  protected makeApplyRuleAction(specificity: number): ApplyRuleAction {\n    let regionId = this.regionId;\n    if (this.footnoteContent) {\n      if (regionId) {\n        regionId = \"xxx-bogus-xxx\";\n      } else {\n        regionId = \"footnote\";\n      }\n    }\n    return new ApplyRuleAction(\n      this.elementStyle,\n      specificity,\n      this.pseudoelement,\n      regionId,\n      this.viewConditionId,\n    );\n  }\n\n  special(name: string, value: Css.Val) {\n    let val: CascadeValue;\n    if (!this.condition) {\n      val = new CascadeValue(value, 0);\n    } else {\n      val = new ConditionalCascadeValue(value, 0, this.condition);\n    }\n    const arr = getMutableSpecial(this.elementStyle, name);\n    arr.push(val);\n  }\n\n  override property(name: string, value: Css.Val, important: boolean): void {\n    this.validatorSet.validatePropertyAndHandleShorthand(\n      name,\n      value,\n      important,\n      this,\n    );\n  }\n\n  /** @override */\n  invalidPropertyValue(name: string, value: Css.Val): void {\n    this.report(`E_INVALID_PROPERTY_VALUE ${name}: ${value.toString()}`);\n  }\n\n  /** @override */\n  unknownProperty(name: string, value: Css.Val): void {\n    this.report(`E_INVALID_PROPERTY ${name}: ${value.toString()}`);\n  }\n\n  /** @override */\n  simpleProperty(name: string, value: Css.Val, important): void {\n    if (\n      name == \"display\" &&\n      (value === Css.ident.oeb_page_head || value === Css.ident.oeb_page_foot)\n    ) {\n      this.simpleProperty(\n        \"flow-options\",\n        new Css.SpaceList([Css.ident.exclusive, Css.ident._static]),\n        important,\n      );\n      this.simpleProperty(\"flow-into\", value, important);\n      value = Css.ident.block;\n    }\n    const hooks = Plugin.getHooksForName(\"SIMPLE_PROPERTY\");\n    hooks.forEach((hook) => {\n      const original = { name: name, value: value, important: important };\n      const converted = hook(original);\n      name = converted[\"name\"];\n      value = converted[\"value\"];\n      important = converted[\"important\"];\n    });\n    const specificity = important\n      ? this.getImportantSpecificity()\n      : this.getBaseSpecificity();\n    const priority = specificity + this.cascade.nextOrder();\n    const cascval = this.condition\n      ? new ConditionalCascadeValue(value, priority, this.condition)\n      : new CascadeValue(value, priority);\n    setPropCascadeValue(this.elementStyle, name, cascval);\n  }\n\n  finish(): Cascade {\n    return this.cascade;\n  }\n\n  override startFuncWithSelector(funcName: string): void {\n    let parameterParserHandler: MatchesParameterParserHandler;\n    switch (funcName) {\n      case \"is\":\n        parameterParserHandler = new MatchesParameterParserHandler(this);\n        break;\n      case \"not\":\n        parameterParserHandler = new NotParameterParserHandler(this);\n        break;\n      case \"where\":\n        parameterParserHandler = new WhereParameterParserHandler(this);\n        break;\n      case \"has\":\n        parameterParserHandler = new HasParameterParserHandler(this);\n        break;\n    }\n    if (parameterParserHandler) {\n      parameterParserHandler.startSelectorRule();\n      this.owner.pushHandler(parameterParserHandler);\n    }\n  }\n}\n\nexport const nthSelectorActionClasses: { [key: string]: typeof IsNthAction } = {\n  \"nth-child\": IsNthSiblingAction,\n  \"nth-of-type\": IsNthSiblingOfTypeAction,\n  \"nth-last-child\": IsNthLastSiblingAction,\n  \"nth-last-of-type\": IsNthLastSiblingOfTypeAction,\n};\n\nexport let conditionCount: number = 0;\n\n/**\n * Cascade Parser Handler for :is() and similar pseudo-classes parameter\n */\nexport class MatchesParameterParserHandler extends CascadeParserHandler {\n  parentChain: ChainedAction[];\n  chains: ChainedAction[][] = [];\n  maxSpecificity: number = 0;\n  selectorTexts: string[] = [];\n\n  constructor(public readonly parent: CascadeParserHandler) {\n    super(\n      parent.scope,\n      parent.owner,\n      parent.condition,\n      parent,\n      parent.regionId,\n      parent.validatorSet,\n      false,\n    );\n    this.parentChain = parent.chain;\n  }\n\n  override nextSelector(): void {\n    if (this.chain) {\n      this.chains.push(this.chain);\n    }\n    this.maxSpecificity = Math.max(this.maxSpecificity, this.specificity);\n    this.chain = [];\n    this.pseudoelement = null;\n    this.viewConditionId = null;\n    this.footnoteContent = false;\n    this.specificity = 0;\n  }\n\n  override endFuncWithSelector(): void {\n    if (this.chain) {\n      this.chains.push(this.chain);\n    }\n    if (this.chains.length > 0) {\n      this.maxSpecificity = Math.max(this.maxSpecificity, this.specificity);\n      this.parentChain.push(\n        this.relational()\n          ? new MatchesRelationalAction(this.selectorTexts)\n          : this.positive()\n            ? new MatchesAction(this.chains)\n            : new MatchesNoneAction(this.chains),\n      );\n      if (this.increasingSpecificity()) {\n        this.parent.specificity += this.maxSpecificity;\n      }\n    } else {\n      // func argument is empty or all invalid\n      this.parentChain.push(new CheckConditionAction(\"\")); // always fails\n    }\n\n    this.owner.popHandler();\n  }\n\n  override startRuleBody(): void {\n    this.reportAndSkip(\"E_CSS_UNEXPECTED_RULE_BODY\");\n  }\n\n  override error(mnemonics: string, token: CssTokenizer.Token): void {\n    super.error(mnemonics, token);\n    this.chain = null;\n    this.pseudoelement = null;\n    this.viewConditionId = null;\n    this.footnoteContent = false;\n    this.specificity = 0;\n\n    let forgiving = false;\n    for (\n      let handler: CascadeParserHandler = this;\n      handler instanceof MatchesParameterParserHandler;\n      handler = handler.parent\n    ) {\n      if (handler.forgiving()) {\n        forgiving = true;\n        break;\n      }\n    }\n    if (!forgiving) {\n      this.owner.popHandler();\n    }\n  }\n\n  override pushSelectorText(selectorText: string): void {\n    // selectorText is used only for relational pseudo-class `:has()`\n    if (this.chain && this.relational()) {\n      this.selectorTexts.push(selectorText);\n    }\n  }\n\n  /**\n   * @returns true unless this is `:not()`\n   */\n  positive(): boolean {\n    return true;\n  }\n\n  /**\n   * @returns true unless this is `:where()`\n   */\n  increasingSpecificity(): boolean {\n    return true;\n  }\n\n  /**\n   * @returns true if this takes a forgiving selector list (:is/where/has)\n   */\n  forgiving(): boolean {\n    return true;\n  }\n\n  /**\n   * @returns true if this is `:has()`\n   */\n  relational(): boolean {\n    return false;\n  }\n}\n\n/**\n * Cascade Parser Handler for :not() pseudo-class parameter\n */\nexport class NotParameterParserHandler extends MatchesParameterParserHandler {\n  override positive(): boolean {\n    return false;\n  }\n\n  forgiving(): boolean {\n    return false;\n  }\n}\n\n/**\n * Cascade Parser Handler for :where() pseudo-class parameter\n */\nexport class WhereParameterParserHandler extends MatchesParameterParserHandler {\n  override increasingSpecificity(): boolean {\n    return false;\n  }\n}\n\n/**\n * Cascade Parser Handler for :has() pseudo-class parameter\n */\nexport class HasParameterParserHandler extends MatchesParameterParserHandler {\n  override relational(): boolean {\n    return true;\n  }\n}\n\nexport class DefineParserHandler extends CssParser.SlaveParserHandler {\n  constructor(\n    scope: Exprs.LexicalScope,\n    owner: CssParser.DispatchParserHandler,\n  ) {\n    super(scope, owner, false);\n  }\n\n  override property(name: string, value: Css.Val, important: boolean): void {\n    if (this.scope.values[name]) {\n      this.error(`E_CSS_NAME_REDEFINED ${name}`, this.getCurrentToken());\n    } else {\n      const unit = name.match(/height|^(top|bottom)$/) ? \"vh\" : \"vw\";\n      const dim = new Exprs.Numeric(this.scope, 100, unit);\n      this.scope.defineName(name, value.toExpr(this.scope, dim));\n    }\n  }\n}\n\nexport class PropSetParserHandler\n  extends CssParser.SlaveParserHandler\n  implements CssValidator.PropertyReceiver\n{\n  order: number;\n\n  constructor(\n    scope: Exprs.LexicalScope,\n    owner: CssParser.DispatchParserHandler,\n    public readonly condition: Exprs.Val,\n    public readonly elementStyle: ElementStyle,\n    public readonly validatorSet: CssValidator.ValidatorSet,\n    public readonly ruleType?: string,\n  ) {\n    super(scope, owner, false);\n    this.order = 0;\n  }\n\n  override property(name: string, value: Css.Val, important: boolean): void {\n    if (important) {\n      Logging.logger.warn(\"E_IMPORTANT_NOT_ALLOWED\");\n    } else {\n      this.validatorSet.validatePropertyAndHandleShorthand(\n        name,\n        value,\n        important,\n        this,\n      );\n    }\n  }\n\n  /** @override */\n  invalidPropertyValue(name: string, value: Css.Val): void {\n    Logging.logger.warn(\n      \"E_INVALID_PROPERTY_VALUE\",\n      `${name}:`,\n      value.toString(),\n    );\n  }\n\n  /** @override */\n  unknownProperty(name: string, value: Css.Val): void {\n    Logging.logger.warn(\"E_INVALID_PROPERTY\", `${name}:`, value.toString());\n  }\n\n  /** @override */\n  simpleProperty(name: string, value: Css.Val, important): void {\n    let specificity = important\n      ? this.getImportantSpecificity()\n      : this.getBaseSpecificity();\n    specificity += this.order;\n    this.order += ORDER_INCREMENT;\n    const cascval = this.condition\n      ? new ConditionalCascadeValue(value, specificity, this.condition)\n      : new CascadeValue(value, specificity);\n    setPropCascadeValue(this.elementStyle, name, cascval);\n  }\n}\n\nexport class PropertyParserHandler\n  extends CssParser.ErrorHandler\n  implements CssValidator.PropertyReceiver\n{\n  elementStyle = {} as ElementStyle;\n  order: number = 0;\n\n  constructor(\n    scope: Exprs.LexicalScope,\n    public readonly validatorSet: CssValidator.ValidatorSet,\n  ) {\n    super(scope);\n  }\n\n  override property(name: string, value: Css.Val, important: boolean): void {\n    this.validatorSet.validatePropertyAndHandleShorthand(\n      name,\n      value,\n      important,\n      this,\n    );\n  }\n\n  /** @override */\n  invalidPropertyValue(name: string, value: Css.Val): void {\n    Logging.logger.warn(\n      \"E_INVALID_PROPERTY_VALUE\",\n      `${name}:`,\n      value.toString(),\n    );\n  }\n\n  /** @override */\n  unknownProperty(name: string, value: Css.Val): void {\n    Logging.logger.warn(\"E_INVALID_PROPERTY\", `${name}:`, value.toString());\n  }\n\n  /** @override */\n  simpleProperty(name: string, value: Css.Val, important): void {\n    let specificity = important\n      ? CssParser.SPECIFICITY_STYLE_IMPORTANT\n      : CssParser.SPECIFICITY_STYLE;\n    specificity += this.order;\n    this.order += ORDER_INCREMENT;\n    const cascval = new CascadeValue(value, specificity);\n    setPropCascadeValue(this.elementStyle, name, cascval);\n  }\n}\n\nexport function forEachViewConditionalStyles(\n  style: ElementStyle,\n  callback: (p1: ElementStyle) => any,\n): void {\n  const viewConditionalStyles = getViewConditionalStyleMap(style);\n  if (!viewConditionalStyles) {\n    return;\n  }\n  viewConditionalStyles.forEach((entry) => {\n    if (!entry.matcher.matches()) {\n      return;\n    }\n    callback(entry.styles);\n  });\n}\n\nexport function mergeViewConditionalStyles(\n  cascMap: { [key: string]: CascadeValue },\n  context: Exprs.Context,\n  style: ElementStyle,\n): void {\n  forEachViewConditionalStyles(style, (viewConditionalStyles) => {\n    mergeStyle(cascMap, viewConditionalStyles, context);\n  });\n}\n\nexport function parseStyleAttribute(\n  scope: Exprs.LexicalScope,\n  validatorSet: CssValidator.ValidatorSet,\n  baseURL: string,\n  styleAttrValue: string,\n): ElementStyle {\n  const handler = new PropertyParserHandler(scope, validatorSet);\n  const tokenizer = new CssTokenizer.Tokenizer(styleAttrValue, handler);\n  try {\n    CssParser.parseStyleAttribute(tokenizer, handler, baseURL);\n  } catch (err) {\n    Logging.logger.warn(err, \"Style attribute parse error:\");\n  }\n  return handler.elementStyle;\n}\n\nexport function isVertical(\n  cascaded: { [key: string]: CascadeValue },\n  context: Exprs.Context,\n  vertical: boolean,\n): boolean {\n  const writingModeCasc = cascaded[\"writing-mode\"];\n  if (writingModeCasc) {\n    const writingMode = writingModeCasc.evaluate(context, \"writing-mode\");\n    if (\n      writingMode &&\n      writingMode !== Css.ident.inherit &&\n      writingMode !== Css.ident.revert &&\n      writingMode !== Css.ident.unset\n    ) {\n      return writingMode === Css.ident.vertical_rl;\n    }\n  }\n  return vertical;\n}\n\nexport function isRtl(\n  cascaded: { [key: string]: CascadeValue },\n  context: Exprs.Context,\n  rtl: boolean,\n): boolean {\n  const directionCasc = cascaded[\"direction\"];\n  if (directionCasc) {\n    const direction = directionCasc.evaluate(context, \"direction\");\n    if (\n      direction &&\n      direction !== Css.ident.inherit &&\n      direction !== Css.ident.revert &&\n      direction !== Css.ident.unset\n    ) {\n      return direction === Css.ident.rtl;\n    }\n  }\n  return rtl;\n}\n\nexport function flattenCascadedStyle(\n  style: ElementStyle,\n  context: Exprs.Context,\n  regionIds: string[],\n  isFootnote: boolean,\n  nodeContext: Vtree.NodeContext,\n): { [key: string]: CascadeValue } {\n  const cascMap = {} as { [key: string]: CascadeValue };\n  for (const n in style) {\n    if (isPropName(n)) {\n      cascMap[n] = getProp(style, n);\n    }\n  }\n  mergeViewConditionalStyles(cascMap, context, style);\n  forEachStylesInRegion(\n    style,\n    regionIds,\n    isFootnote,\n    (regionId, regionStyle) => {\n      mergeStyle(cascMap, regionStyle, context);\n      mergeViewConditionalStyles(cascMap, context, regionStyle);\n    },\n  );\n  return cascMap;\n}\n\nexport function forEachStylesInRegion(\n  style: ElementStyle,\n  regionIds: string[],\n  isFootnote: boolean,\n  callback: (p1: string, p2: ElementStyle) => any,\n): void {\n  const regions = getStyleMap(style, \"_regions\");\n  if ((regionIds || isFootnote) && regions) {\n    if (isFootnote) {\n      const footnoteRegion = [\"footnote\"];\n      if (!regionIds) {\n        regionIds = footnoteRegion;\n      } else {\n        regionIds = regionIds.concat(footnoteRegion);\n      }\n    }\n    for (const regionId of regionIds) {\n      const regionStyle = regions[regionId];\n      if (regionStyle) {\n        callback(regionId, regionStyle);\n      }\n    }\n  }\n}\n\nexport function mergeStyle(\n  to: { [key: string]: CascadeValue },\n  from: ElementStyle,\n  context: Exprs.Context,\n): void {\n  for (const property in from) {\n    if (isPropName(property)) {\n      const newVal = getProp(from, property);\n      const oldVal = to[property];\n      to[property] = cascadeValues(context, oldVal, newVal as CascadeValue);\n    }\n  }\n}\n\n/**\n * Convert logical properties to physical ones, taking specificity into account.\n * @param src Source properties map\n * @param dest Destination map\n * @param transform If supplied, property values are transformed by this\n *     function before inserted into the destination map. The first parameter is\n *     the property name and the second one is the property value.\n * @template T\n */\nexport const convertToPhysical = <T>(\n  src: { [key: string]: CascadeValue },\n  dest: { [key: string]: T },\n  vertical: boolean,\n  rtl: boolean,\n  leftPageSide: boolean,\n  transform: (p1: string, p2: CascadeValue) => T,\n) => {\n  // for logical properties\n  const couplingMap1 = vertical\n    ? rtl\n      ? couplingMapVertRtl\n      : couplingMapVert\n    : rtl\n      ? couplingMapHorRtl\n      : couplingMapHor;\n\n  // for margin-inside/outside properties\n  const couplingMap2 = leftPageSide\n    ? couplingMapLeftPage\n    : couplingMapRightPage;\n\n  for (const propName in src) {\n    let cascVal = src[propName];\n    if (!cascVal) {\n      continue;\n    }\n    const coupledName1 =\n      couplingMap1[propName] ?? couplingMap1[couplingMap2[propName]];\n    const coupledName2 =\n      couplingMap2[propName] ?? couplingMap2[couplingMap1[propName]];\n    let coupledName = coupledName1 ?? coupledName2;\n    let targetName: string;\n    if (coupledName) {\n      let coupledCascVal = src[coupledName];\n      if (coupledCascVal && coupledCascVal.priority > cascVal.priority) {\n        continue;\n      }\n      if (coupledName1 && coupledName2 && coupledName1 !== coupledName2) {\n        coupledName = coupledName2;\n        coupledCascVal = src[coupledName];\n        if (coupledCascVal && coupledCascVal.priority > cascVal.priority) {\n          continue;\n        }\n      }\n      targetName = geomNames[coupledName1]\n        ? coupledName1\n        : geomNames[coupledName2]\n          ? coupledName2\n          : propName;\n    } else {\n      targetName = propName;\n      if (\n        propName.startsWith(\"text-align\") &&\n        (cascVal.value === Css.ident.inside ||\n          cascVal.value === Css.ident.outside)\n      ) {\n        cascVal = new CascadeValue(\n          leftPageSide === (cascVal.value === Css.ident.inside)\n            ? Css.ident.right\n            : Css.ident.left,\n          cascVal.priority,\n        );\n      }\n    }\n    dest[targetName] = transform(propName, cascVal);\n  }\n};\n\n/**\n * Convert var() to its value\n */\nexport class VarFilterVisitor extends Css.FilterVisitor {\n  constructor(\n    public elementStyles: ElementStyle[],\n    public styler: CssStyler.AbstractStyler,\n    public element: Element | null,\n  ) {\n    super();\n  }\n\n  private getVarValue(name: string): Css.Val {\n    let elem = this.element ?? ((this.styler as any).root as Element);\n    if (this.elementStyles?.length) {\n      for (const style of this.elementStyles) {\n        const val = (style[name] as CascadeValue)?.value;\n        if (val) {\n          return val;\n        }\n      }\n      if (this.element) {\n        elem = this.element.parentElement;\n      }\n    }\n    for (; elem; elem = elem.parentElement) {\n      const val = (this.styler.getStyle(elem, false)?.[name] as CascadeValue)\n        ?.value;\n      if (val) {\n        return val;\n      }\n    }\n    return null;\n  }\n\n  override visitFunc(func: Css.Func): Css.Val {\n    if (func.name !== \"var\") {\n      return super.visitFunc(func);\n    }\n    const name = func.values[0] instanceof Css.Ident && func.values[0].name;\n    if (!name || !Css.isCustomPropName(name)) {\n      this.error = true;\n      return Css.empty;\n    }\n    const varVal = this.getVarValue(name);\n    if (varVal) {\n      return varVal;\n    }\n    // fallback value\n    if (func.values.length < 2) {\n      this.error = true;\n      return Css.empty;\n    }\n    if (func.values.length === 2) {\n      return func.values[1];\n    } else {\n      return new Css.CommaList(func.values.slice(1));\n    }\n  }\n}\n\n/**\n * Convert calc() to its value\n */\nexport class CalcFilterVisitor extends Css.FilterVisitor {\n  constructor(\n    public context: Exprs.Context,\n    public resolveViewportUnit?: boolean,\n    public percentRef?: number,\n    public vertical?: boolean,\n  ) {\n    super();\n  }\n\n  override visitFunc(func: Css.Func): Css.Val {\n    // convert func args\n    let value = super.visitFunc(func);\n    if (func.name !== \"calc\") {\n      return value;\n    }\n    const exprText = value.toString().replace(/^calc\\b/, \"-epubx-expr\");\n    if (\n      /\\d(%|em|ex|cap|ch|ic|lh|p?v[whbi]|p?vmin|p?vmax)\\W|\\Wvar\\(\\s*--/i.test(\n        exprText,\n      )\n    ) {\n      return value;\n    }\n    const exprVal = CssParser.parseValue(\n      this.context.rootScope,\n      new CssTokenizer.Tokenizer(exprText, null),\n      \"\",\n    );\n    if (exprVal instanceof Css.Expr) {\n      try {\n        const exprResult = exprVal.expr.evaluate(this.context);\n        if (typeof exprResult === \"number\" && !isNaN(exprResult)) {\n          if (/\\d(px|in|pt|pc|cm|mm|q|rem|rlh)\\W/i.test(exprText)) {\n            // length value\n            value = new Css.Numeric(exprResult, \"px\");\n          } else if (!/\\d[a-z]/i.test(exprText)) {\n            // unitless number\n            value = new Css.Num(exprResult);\n          }\n          // otherwise, keep the original calc() expression\n        }\n      } catch (err) {\n        Logging.logger.warn(err);\n      }\n    }\n    return value;\n  }\n\n  override visitNumeric(numeric: Css.Numeric): Css.Val {\n    if (\n      this.resolveViewportUnit &&\n      (Exprs.isViewportRelativeLengthUnit(numeric.unit) ||\n        Exprs.isRootFontRelativeLengthUnit(numeric.unit))\n    ) {\n      return new Css.Numeric(\n        numeric.num *\n          this.context.queryUnitSize(numeric.unit, false, this.vertical),\n        \"px\",\n      );\n    }\n    if (typeof this.percentRef === \"number\" && numeric.unit === \"%\") {\n      return new Css.Numeric((numeric.num * this.percentRef) / 100, \"px\");\n    }\n    return numeric;\n  }\n}\n\nexport function evaluateCSSToCSS(\n  context: Exprs.Context,\n  val: Css.Val,\n  propName?: string,\n  percentRef?: number,\n  vertical?: boolean,\n): Css.Val {\n  try {\n    if (val instanceof Css.Expr) {\n      if (\n        val.expr instanceof Exprs.Native &&\n        (val.expr.str.startsWith(\"named-string-\") ||\n          val.expr.str.startsWith(\"running-element-\"))\n      ) {\n        return val;\n      }\n      return CssParser.evaluateExprToCSS(context, val.expr, propName);\n    }\n    if (\n      val instanceof Css.Numeric ||\n      val instanceof Css.Func ||\n      val instanceof Css.SpaceList ||\n      val instanceof Css.CommaList\n    ) {\n      return val.visit(\n        new CalcFilterVisitor(context, true, percentRef, vertical),\n      );\n    }\n  } catch (err) {\n    Logging.logger.warn(err);\n    return Css.empty;\n  }\n  return val;\n}\n", "/**\n * Copyright 2021 Vivliostyle Foundation\n *\n * Vivliostyle.js is free software: you can redistribute it and/or modify\n * it under the terms of the GNU Affero General Public License as published by\n * the Free Software Foundation, either version 3 of the License, or\n * (at your option) any later version.\n *\n * Vivliostyle.js is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n * GNU Affero General Public License for more details.\n *\n * You should have received a copy of the GNU Affero General Public License\n * along with Vivliostyle.js.  If not, see <http://www.gnu.org/licenses/>.\n *\n * @fileoverview TextPolyfill - CSS text-spacing and hanging-punctuation support.\n */\nimport * as Base from \"./base\";\nimport * as Css from \"./css\";\nimport * as LayoutHelper from \"./layout-helper\";\nimport * as Plugin from \"./plugin\";\nimport * as Vtree from \"./vtree\";\n\ntype PropertyValue = string | number | Css.Val;\n\ntype HangingPunctuation = {\n  first: boolean;\n  forceEnd: boolean; // force-end\n  allowEnd: boolean; // allow-end\n  last: boolean;\n};\n\nconst HANGING_PUNCTUATION_NONE: HangingPunctuation = {\n  first: false,\n  forceEnd: false,\n  allowEnd: false,\n  last: false,\n};\n\nfunction hangingPunctuationFromPropertyValue(\n  value: PropertyValue,\n): HangingPunctuation {\n  const cssval =\n    value instanceof Css.Val\n      ? value\n      : typeof value === \"string\"\n        ? Css.getName(value)\n        : Css.ident.none;\n\n  if (cssval === Css.ident.none) {\n    return HANGING_PUNCTUATION_NONE;\n  }\n  const values = cssval instanceof Css.SpaceList ? cssval.values : [cssval];\n  const hangingPunctuation: HangingPunctuation = Object.create(\n    HANGING_PUNCTUATION_NONE,\n  );\n\n  for (const val of values) {\n    if (val instanceof Css.Ident) {\n      switch (val.name) {\n        case \"first\":\n          hangingPunctuation.first = true;\n          break;\n        case \"force-end\":\n          hangingPunctuation.forceEnd = true;\n          hangingPunctuation.allowEnd = false;\n          break;\n        case \"allow-end\":\n          hangingPunctuation.forceEnd = false;\n          hangingPunctuation.allowEnd = true;\n          break;\n        case \"last\":\n          hangingPunctuation.last = true;\n          break;\n      }\n    }\n  }\n  return hangingPunctuation;\n}\n\nfunction isHangingPunctuationNone(\n  hangingPunctuation: HangingPunctuation,\n): boolean {\n  return (\n    !hangingPunctuation.first &&\n    !hangingPunctuation.last &&\n    !hangingPunctuation.forceEnd &&\n    !hangingPunctuation.allowEnd\n  );\n}\n\ntype SpacingTrim = {\n  trimStart: boolean; // trim-start\n  spaceFirst: boolean; // space-first\n  trimEnd: boolean; // trim-end\n  allowEnd: boolean; // allow-end\n  trimAdjacent: boolean; // trim-adjacent\n  // TODO: add support for:\n  //   trimAll: boolean; // trim-all\n};\n\n/**\n * text-spacing-trim: space-all\n * space-all = space-start space-end space-adjacent\n */\nconst SPACING_TRIM_NONE: SpacingTrim = {\n  trimStart: false,\n  spaceFirst: false,\n  trimEnd: false,\n  allowEnd: false,\n  trimAdjacent: false,\n};\n\n/**\n * text-spacing-trim: normal\n * normal = space-start allow-end trim-adjacent\n */\nconst SPACING_TRIM_NORMAL: SpacingTrim = {\n  trimStart: false,\n  spaceFirst: false,\n  trimEnd: false,\n  allowEnd: true,\n  trimAdjacent: true,\n};\n\n/**\n * text-spacing-trim: trim-both\n * trim-both = trim-start trim-end trim-adjacent\n *\n * NOTE: Values `trim-auto` (deprecated) and `auto` are treated as `trim-both`.\n */\nconst SPACING_TRIM_BOTH: SpacingTrim = {\n  trimStart: true,\n  spaceFirst: false,\n  trimEnd: true,\n  allowEnd: false,\n  trimAdjacent: true,\n};\n\nfunction spacingTrimFromPropertyValue(value: PropertyValue): SpacingTrim {\n  const cssval =\n    value instanceof Css.Val\n      ? value\n      : typeof value === \"string\"\n        ? Css.getName(value)\n        : Css.ident.normal;\n\n  if (cssval === Css.ident.normal) {\n    return SPACING_TRIM_NORMAL;\n  }\n  if (cssval === Css.ident.auto) {\n    return SPACING_TRIM_BOTH;\n  }\n  const values = cssval instanceof Css.SpaceList ? cssval.values : [cssval];\n  const textSpacing: SpacingTrim = Object.create(SPACING_TRIM_NORMAL);\n\n  for (const val of values) {\n    if (val instanceof Css.Ident) {\n      switch (val.name) {\n        case \"trim-both\":\n        case \"trim-auto\":\n          return SPACING_TRIM_BOTH;\n        case \"space-all\":\n          return SPACING_TRIM_NONE;\n        case \"trim-start\":\n          textSpacing.trimStart = true;\n          textSpacing.spaceFirst = false;\n          break;\n        case \"space-start\":\n          textSpacing.trimStart = false;\n          textSpacing.spaceFirst = false;\n          break;\n        case \"space-first\":\n          textSpacing.trimStart = false;\n          textSpacing.spaceFirst = true;\n          break;\n        case \"trim-end\":\n          textSpacing.trimEnd = true;\n          textSpacing.allowEnd = false;\n          break;\n        case \"space-end\":\n          textSpacing.trimEnd = false;\n          textSpacing.allowEnd = false;\n          break;\n        case \"allow-end\":\n          textSpacing.trimEnd = false;\n          textSpacing.allowEnd = true;\n          break;\n        case \"trim-adjacent\":\n          textSpacing.trimAdjacent = true;\n          break;\n        case \"space-adjacent\":\n          textSpacing.trimAdjacent = false;\n          break;\n      }\n    }\n  }\n\n  return textSpacing;\n}\n\ntype Autospace = {\n  ideographAlpha: boolean;\n  ideographNumeric: boolean;\n  // TODO: add support for:\n  //   punctuation: boolean;\n  //   replace: boolean;\n};\n\n/**\n * text-autospace: no-autospace (none)\n */\nconst AUTOSPACE_NONE: Autospace = {\n  ideographAlpha: false,\n  ideographNumeric: false,\n};\n\n/**\n * text-autospace: normal\n */\nconst AUTOSPACE_NORMAL: Autospace = {\n  ideographAlpha: true,\n  ideographNumeric: true,\n};\n\nfunction autospaceFromPropertyValue(value: PropertyValue): Autospace {\n  const cssval =\n    value instanceof Css.Val\n      ? value\n      : typeof value === \"string\"\n        ? Css.getName(value)\n        : Css.ident.normal;\n\n  if (cssval === Css.ident.normal || cssval === Css.ident.auto) {\n    return AUTOSPACE_NORMAL;\n  }\n  if (cssval === Css.ident.none) {\n    return AUTOSPACE_NONE;\n  }\n\n  const values = cssval instanceof Css.SpaceList ? cssval.values : [cssval];\n  const autospace: Autospace = Object.create(AUTOSPACE_NONE);\n\n  for (const val of values) {\n    if (val instanceof Css.Ident) {\n      switch (val.name) {\n        case \"no-autospace\":\n          return AUTOSPACE_NONE;\n        case \"ideograph-alpha\":\n          autospace.ideographAlpha = true;\n          break;\n        case \"ideograph-numeric\":\n          autospace.ideographNumeric = true;\n          break;\n      }\n    }\n  }\n\n  return autospace;\n}\n\nfunction isTextSpacingNone(\n  autospace: Autospace,\n  spacingTrim: SpacingTrim,\n): boolean {\n  return (\n    !autospace.ideographAlpha &&\n    !autospace.ideographNumeric &&\n    !spacingTrim.trimStart &&\n    !spacingTrim.spaceFirst &&\n    !spacingTrim.trimEnd &&\n    !spacingTrim.allowEnd &&\n    !spacingTrim.trimAdjacent\n  );\n}\n\nfunction normalizeLang(lang: string): string | null {\n  if (lang) {\n    // Normalize CJK lang\n    lang = lang.toLowerCase();\n    if (/^zh\\b.*-(hant|tw|hk)\\b/.test(lang)) {\n      return \"zh-hant\";\n    }\n    if (/^zh\\b/.test(lang)) {\n      return \"zh-hans\";\n    }\n    if (/^ja\\b/.test(lang)) {\n      return \"ja\";\n    }\n    if (/^ko\\b/.test(lang)) {\n      return \"ko\";\n    }\n    return lang;\n  }\n  return null;\n}\n\nclass TextSpacingPolyfill {\n  getPolyfilledInheritedProps() {\n    return [\"hanging-punctuation\", \"text-autospace\", \"text-spacing-trim\"];\n  }\n\n  preprocessSingleDocument(document: Document): void {\n    if (!document.body) {\n      return;\n    }\n    this.preprocessForTextSpacing(document.body);\n  }\n\n  preprocessForTextSpacing(element: Element): void {\n    // Split text nodes by punctuations and ideograph/non-ideograph boundary\n    const nodeIter = element.ownerDocument.createNodeIterator(\n      element,\n      NodeFilter.SHOW_TEXT,\n    );\n    for (let node = nodeIter.nextNode(); node; node = nodeIter.nextNode()) {\n      if (\n        node.parentElement.namespaceURI !== Base.NS.XHTML ||\n        node.parentElement.dataset?.[\"mathTypeset\"] === \"true\"\n      ) {\n        continue;\n      }\n      const textArr = node.textContent\n        .replace(\n          /(?![()\\[\\]{}])[\\p{Ps}\\p{Pe}\\p{Pf}\\p{Pi}\u3001\u3002\uFF0C\uFF0E\uFF1A\uFF1B\uFF64\uFF61\\u3000]\\p{M}*(?=\\P{M})|.(?=(?![()\\[\\]{}])[\\p{Ps}\\p{Pe}\\p{Pf}\\p{Pi}\u3001\u3002\uFF0C\uFF0E\uFF1A\uFF1B\uFF64\uFF61\\u3000])|(?!\\p{P})[\\p{sc=Han}\\u3041-\\u30FF\\u31C0-\\u31FF]\\p{M}*(?=(?![\\p{sc=Han}\\u3041-\\u30FF\\u31C0-\\u31FF\\uFF01-\\uFF60])[\\p{L}\\p{Nd}])|(?![\\p{sc=Han}\\u3041-\\u30FF\\u31C0-\\u31FF\\uFF01-\\uFF60])[\\p{L}\\p{Nd}]\\p{M}*(?=(?!\\p{P})[\\p{sc=Han}\\u3041-\\u30FF\\u31C0-\\u31FF])/gsu,\n          \"$&\\x00\",\n        )\n        .split(\"\\x00\");\n\n      if (textArr.length > 1) {\n        const lastIndex = textArr.length - 1;\n        for (let i = 0; i < lastIndex; i++) {\n          node.parentNode.insertBefore(\n            document.createTextNode(textArr[i]),\n            node,\n          );\n        }\n        node.textContent = textArr[lastIndex];\n      }\n    }\n  }\n\n  processGeneratedContent(\n    element: HTMLElement,\n    autospaceVal: Css.Val,\n    spacingTrimVal: Css.Val,\n    hangingPunctuationVal: Css.Val,\n    lang: string,\n    vertical: boolean,\n  ): void {\n    lang = normalizeLang(lang);\n    const autospace = autospaceFromPropertyValue(autospaceVal);\n    const spacingTrim = spacingTrimFromPropertyValue(spacingTrimVal);\n    const hangingPunctuation = hangingPunctuationFromPropertyValue(\n      hangingPunctuationVal,\n    );\n\n    if (\n      isHangingPunctuationNone(hangingPunctuation) &&\n      isTextSpacingNone(autospace, spacingTrim)\n    ) {\n      return;\n    }\n\n    this.preprocessForTextSpacing(element);\n\n    const whiteSpaceSave = element.style.whiteSpace;\n    if ((vertical ? element.offsetHeight : element.offsetWidth) === 0) {\n      // Prevent wrong line wrapping\n      element.style.whiteSpace = \"pre\";\n    }\n\n    const nodeIter = element.ownerDocument.createNodeIterator(\n      element,\n      NodeFilter.SHOW_TEXT,\n    );\n    let prevNode: Node = null;\n    let nextNode: Node = null;\n    for (let node = nodeIter.nextNode(); node; node = nextNode) {\n      nextNode = nodeIter.nextNode();\n      const isFirstInBlock = !prevNode;\n      const isFirstAfterForcedLineBreak =\n        !prevNode || /\\n$/.test(prevNode.textContent);\n      const isLastBeforeForcedLineBreak =\n        !nextNode || /^\\n/.test(nextNode.textContent);\n      const isLastInBlock = !nextNode;\n      this.processTextSpacing(\n        node,\n        isFirstInBlock || isFirstAfterForcedLineBreak,\n        isFirstInBlock,\n        isFirstAfterForcedLineBreak,\n        isLastBeforeForcedLineBreak,\n        isLastInBlock,\n        prevNode,\n        nextNode,\n        autospace,\n        spacingTrim,\n        hangingPunctuation,\n        lang,\n        vertical,\n      );\n      prevNode = node;\n    }\n\n    element.style.whiteSpace = whiteSpaceSave;\n  }\n\n  postLayoutBlock(\n    nodeContext: Vtree.NodeContext,\n    checkPoints: Vtree.NodeContext[],\n  ): void {\n    const isFirstFragment =\n      !nodeContext ||\n      (nodeContext.fragmentIndex === 1 && checkIfFirstInBlock());\n    const isAfterForcedLineBreak =\n      isFirstFragment || checkIfAfterForcedLineBreak();\n\n    function isOutOfLine(node: Node): boolean {\n      if (node?.nodeType !== 1) {\n        return false;\n      }\n      const elem = node as HTMLElement;\n      if (elem.hasAttribute(LayoutHelper.SPECIAL_ATTR)) {\n        return true;\n      }\n      const { position, float } = elem.style ?? {};\n      return (\n        position === \"absolute\" ||\n        position === \"fixed\" ||\n        (float && float !== \"none\")\n      );\n    }\n\n    function checkIfFirstInBlock(): boolean {\n      const p = checkPoints[0];\n      for (let pp = p; ; pp = pp.parent) {\n        if (!pp || !pp.inline) {\n          if (pp?.fragmentIndex !== 1) {\n            // This block is not the first fragment\n            return false;\n          }\n          break;\n        }\n      }\n      if (!p.inline) {\n        // This is at the start of the block\n        return true;\n      }\n      for (\n        let prev = p.viewNode.previousSibling;\n        prev;\n        prev = prev.previousSibling\n      ) {\n        if (Vtree.canIgnore(prev, p.whitespace)) {\n          continue;\n        }\n        if (!isOutOfLine(prev)) {\n          return false;\n        }\n      }\n      return true;\n    }\n\n    function checkIfAfterForcedLineBreak(): boolean {\n      let p = checkPoints[0];\n      let prevNode: Node;\n      while (p && p.inline) {\n        prevNode = p.viewNode?.previousSibling;\n        if (prevNode) {\n          if (\n            prevNode.nodeType === 3 &&\n            /^[ \\t\\r\\n\\f]*$/.test(prevNode.textContent) &&\n            p.whitespace !== Vtree.Whitespace.PRESERVE\n          ) {\n            prevNode = prevNode.previousSibling;\n          }\n          if (prevNode) {\n            break;\n          }\n        }\n        p = p.parent;\n      }\n\n      while (prevNode) {\n        if (prevNode.nodeType === 1) {\n          if ((prevNode as Element).localName === \"br\") {\n            return true;\n          }\n          const display = (prevNode as HTMLElement).style?.display;\n          if (display && display !== \"inline\") {\n            return !/^(inline|ruby)\\b/.test(display);\n          }\n        } else if (prevNode.nodeType === 3) {\n          if (p.whitespace === Vtree.Whitespace.PRESERVE) {\n            if (/\\n$/.test(prevNode.textContent)) {\n              return true;\n            }\n          } else if (p.whitespace === Vtree.Whitespace.NEWLINE) {\n            if (/\\n[ \\t\\r\\n\\f]*$/.test(prevNode.textContent)) {\n              return true;\n            }\n          }\n        }\n        prevNode = prevNode.lastChild;\n      }\n      return false;\n    }\n\n    let iFirst = -1;\n    for (let i = 0; i < checkPoints.length; i++) {\n      const p = checkPoints[i];\n      if (\n        !p.after &&\n        p.inline &&\n        !p.display &&\n        p.parent &&\n        p.viewNode.parentNode &&\n        p.viewNode.nodeType === Node.TEXT_NODE &&\n        !Vtree.canIgnore(p.viewNode, p.whitespace)\n      ) {\n        const lang = normalizeLang(\n          p.lang ??\n            p.parent.lang ??\n            nodeContext?.lang ??\n            nodeContext?.parent?.lang,\n        );\n        const autospace = autospaceFromPropertyValue(\n          p.inheritedProps[\"text-autospace\"],\n        );\n        const spacingTrim = spacingTrimFromPropertyValue(\n          p.inheritedProps[\"text-spacing-trim\"],\n        );\n        const hangingPunctuation = hangingPunctuationFromPropertyValue(\n          p.inheritedProps[\"hanging-punctuation\"],\n        );\n\n        if (\n          isHangingPunctuationNone(hangingPunctuation) &&\n          isTextSpacingNone(autospace, spacingTrim)\n        ) {\n          continue;\n        }\n        if (/\\b(flex|grid)\\b/.test(p.parent.display)) {\n          // Cannot process if parent is flex or grid. (Issue #926)\n          continue;\n        }\n\n        if (iFirst < 0) {\n          iFirst = i;\n        }\n        let prevNode: Node = null;\n        let nextNode: Node = null;\n        let isFirstAfterBreak = i === iFirst;\n        let isFirstInBlock = i === iFirst && isFirstFragment;\n        let isFirstAfterForcedLineBreak =\n          i === iFirst && isAfterForcedLineBreak;\n        let isLastBeforeForcedLineBreak = false;\n        let isLastInBlock = false;\n\n        function checkIfFirstAfterForcedLineBreak(\n          prevP: Vtree.NodeContext,\n        ): boolean {\n          if (prevP.viewNode?.nodeType === 1) {\n            return (prevP.viewNode as Element).localName === \"br\";\n          }\n          if (prevP.viewNode?.nodeType === 3) {\n            if (prevP.whitespace === Vtree.Whitespace.PRESERVE) {\n              if (/\\n$/.test(prevP.viewNode.textContent)) {\n                return true;\n              }\n            } else if (prevP.whitespace === Vtree.Whitespace.NEWLINE) {\n              if (/\\n[ \\t\\r\\n\\f]*$/.test(prevP.viewNode.textContent)) {\n                return true;\n              }\n            }\n            if (\n              (prevP.viewNode as Element).previousElementSibling?.localName ===\n              \"br\"\n            ) {\n              return Vtree.canIgnore(prevP.viewNode, prevP.whitespace);\n            }\n          }\n          return false;\n        }\n\n        function checkIfLastBeforeForcedLineBreak(\n          nextP: Vtree.NodeContext,\n        ): boolean {\n          if (nextP.viewNode?.nodeType === 1) {\n            return (nextP.viewNode as Element).localName === \"br\";\n          }\n          if (nextP.viewNode?.nodeType === 3) {\n            if (nextP.whitespace === Vtree.Whitespace.PRESERVE) {\n              if (/^\\n/.test(nextP.viewNode.textContent)) {\n                return true;\n              }\n            } else if (nextP.whitespace === Vtree.Whitespace.NEWLINE) {\n              if (/^[ \\t\\r\\n\\f]*\\n/.test(nextP.viewNode.textContent)) {\n                return true;\n              }\n            }\n            if (\n              (nextP.viewNode as Element).nextElementSibling?.localName === \"br\"\n            ) {\n              return Vtree.canIgnore(nextP.viewNode, nextP.whitespace);\n            }\n          }\n          return false;\n        }\n\n        for (let prev = i - 1; prev >= 0; prev--) {\n          const prevP = checkPoints[prev];\n          if (checkIfFirstAfterForcedLineBreak(prevP)) {\n            isFirstAfterForcedLineBreak = true;\n            break;\n          }\n          if (\n            !prevP.display &&\n            prevP.viewNode.nodeType === Node.TEXT_NODE &&\n            prevP.viewNode.textContent.length > 0\n          ) {\n            prevNode = prevP.viewNode;\n            break;\n          }\n          if (\n            (prevP.display && !/^(inline|ruby)\\b/.test(prevP.display)) ||\n            (prevP.viewNode?.nodeType === 1 &&\n              ((prevP.viewNode as Element).localName === \"br\" ||\n                Base.mediaTags[(prevP.viewNode as Element).localName]))\n          ) {\n            break;\n          }\n          if (prev === 0) {\n            isFirstAfterBreak = true;\n            if (isFirstFragment) {\n              isFirstInBlock = true;\n              isFirstAfterForcedLineBreak = true;\n            }\n          }\n        }\n        for (let next = i + 1; next < checkPoints.length; next++) {\n          const nextP = checkPoints[next];\n          if (checkIfLastBeforeForcedLineBreak(nextP)) {\n            isLastBeforeForcedLineBreak = true;\n            break;\n          }\n          if (\n            nextP.viewNode !== p.viewNode &&\n            !nextP.display &&\n            nextP.viewNode.nodeType === Node.TEXT_NODE &&\n            nextP.viewNode.textContent.length > 0\n          ) {\n            nextNode = nextP.viewNode;\n            break;\n          }\n          if (\n            (nextP.display && !/^(inline|ruby)\\b/.test(nextP.display)) ||\n            (nextP.viewNode?.nodeType === 1 &&\n              ((nextP.viewNode as Element).localName === \"br\" ||\n                Base.mediaTags[(nextP.viewNode as Element).localName]))\n          ) {\n            if (\n              next === checkPoints.length - 1 &&\n              isOutOfLine(nextP.viewNode)\n            ) {\n              isLastInBlock = true;\n            }\n            break;\n          }\n          if (next === checkPoints.length - 1) {\n            isLastBeforeForcedLineBreak = true;\n            isLastInBlock = true;\n            for (\n              let nextNext = nextP.viewNode.nextSibling;\n              nextNext;\n              nextNext = nextNext.nextSibling\n            ) {\n              if (!isOutOfLine(nextNext)) {\n                isLastInBlock = false;\n                break;\n              }\n            }\n          }\n        }\n        if (p.parent?.display === \"inline-block\") {\n          if (!isFirstInBlock) {\n            let firstInInlineBlock = p.parent.viewNode.firstChild;\n            while (Vtree.canIgnore(firstInInlineBlock, p.whitespace)) {\n              firstInInlineBlock = firstInInlineBlock.nextSibling;\n            }\n            if (p.viewNode === firstInInlineBlock) {\n              isFirstInBlock = true;\n            }\n          }\n          if (!isLastInBlock) {\n            let lastInInlineBlock = p.parent.viewNode.lastChild;\n            while (Vtree.canIgnore(lastInInlineBlock, p.whitespace)) {\n              lastInInlineBlock = lastInInlineBlock.previousSibling;\n            }\n            if (p.viewNode === lastInInlineBlock) {\n              isLastInBlock = true;\n            }\n          }\n        }\n        const columnOver = this.processTextSpacing(\n          p.viewNode,\n          isFirstAfterBreak,\n          isFirstInBlock,\n          isFirstAfterForcedLineBreak,\n          isLastBeforeForcedLineBreak,\n          isLastInBlock,\n          prevNode,\n          nextNode,\n          autospace,\n          spacingTrim,\n          hangingPunctuation,\n          lang,\n          p.vertical,\n        );\n        if (columnOver > 0) {\n          // Stop processing if the node is moved to next column\n          // because it will be processed again in the next column.\n          // (Issue #1256)\n          break;\n        }\n      }\n    }\n  }\n\n  private processTextSpacing(\n    textNode: Node,\n    isFirstAfterBreak: boolean,\n    isFirstInBlock: boolean,\n    isFirstAfterForcedLineBreak: boolean,\n    isLastBeforeForcedLineBreak: boolean,\n    isLastInBlock: boolean,\n    prevNode: Node,\n    nextNode: Node,\n    autospace: Autospace,\n    spacingTrim: SpacingTrim,\n    hangingPunctuation: HangingPunctuation,\n    lang: string,\n    vertical: boolean,\n  ): number {\n    const text = textNode.textContent;\n    const document = textNode.ownerDocument;\n    let columnOver = 0;\n    let currRange: Range;\n    let prevRange: Range;\n    let nextRange: Range;\n\n    function isAtStartOfLine(): boolean {\n      if (isFirstAfterBreak) {\n        return true;\n      }\n      if (!prevNode) {\n        return false;\n      }\n      if (!currRange) {\n        currRange = document.createRange();\n        currRange.selectNode(textNode);\n      }\n      const rect = currRange.getClientRects()[0];\n      if (!rect) {\n        return false;\n      }\n      if (!prevRange) {\n        prevRange = document.createRange();\n        prevRange.selectNode(prevNode);\n      }\n      const prevRects = prevRange.getClientRects();\n      const prevRect = prevRects[prevRects.length - 1];\n      if (!prevRect) {\n        return false;\n      }\n      columnOver ||= LayoutHelper.checkIfBeyondColumnBreaks(prevRect, vertical);\n      return vertical\n        ? rect.top < prevRect.top + prevRect.height - rect.width ||\n            rect.left + rect.width < prevRect.left + rect.width / 10 ||\n            rect.left > prevRect.left + prevRect.width - rect.width / 10\n        : rect.left < prevRect.left + prevRect.width - rect.height ||\n            rect.top > prevRect.top + prevRect.height - rect.height / 10 ||\n            rect.top + rect.height < prevRect.top + rect.height / 10;\n    }\n\n    function isAtEndOfLine(): boolean {\n      if (!nextNode) {\n        return false;\n      }\n      if (!currRange) {\n        currRange = document.createRange();\n        currRange.selectNode(textNode);\n      }\n      const rect = currRange.getClientRects()[0];\n      if (!rect) {\n        return false;\n      }\n      columnOver ||= LayoutHelper.checkIfBeyondColumnBreaks(rect, vertical);\n      if (!nextRange) {\n        nextRange = document.createRange();\n        nextRange.selectNode(nextNode);\n      }\n      const nextRect = nextRange.getClientRects()[0];\n      if (!nextRect) {\n        return false;\n      }\n      return vertical\n        ? rect.top + rect.height > nextRect.top + rect.width ||\n            rect.left > nextRect.left + nextRect.width - rect.width / 10 ||\n            rect.left + rect.width < nextRect.left + rect.width / 10\n        : rect.left + rect.width > nextRect.left + rect.height ||\n            rect.top + rect.height < nextRect.top + rect.height / 10 ||\n            rect.top > nextRect.top + nextRect.height - rect.height / 10;\n    }\n\n    let punctProcessing = false;\n    let hangingFirst = false;\n    let hangingLast = false;\n    let hangingEnd = false;\n    let tagName: \"viv-ts-open\" | \"viv-ts-close\";\n\n    if (\n      isFirstInBlock &&\n      hangingPunctuation.first &&\n      /^[\\p{Ps}\\p{Pf}\\p{Pi}'\"\\u3000]\\p{M}*$/u.test(text)\n    ) {\n      // hanging-punctuation: first\n      tagName = \"viv-ts-open\";\n      punctProcessing = true;\n      hangingFirst = true;\n    } else if (\n      isLastInBlock &&\n      hangingPunctuation.last &&\n      /^[\\p{Pe}\\p{Pf}\\p{Pi}'\"]\\p{M}*$/u.test(text)\n    ) {\n      // hanging-punctuation: last\n      tagName = \"viv-ts-close\";\n      punctProcessing = true;\n      hangingLast = true;\n    } else if (\n      (hangingPunctuation.forceEnd || hangingPunctuation.allowEnd) &&\n      /^[\u3001\u3002\uFF0C\uFF0E\uFF64\uFF61]\\p{M}*$/u.test(text)\n    ) {\n      // hanging-punctuation: force-end | allow-end\n      tagName = \"viv-ts-close\";\n      punctProcessing = true;\n      hangingEnd = true;\n    } else if (\n      (spacingTrim.trimStart ||\n        spacingTrim.spaceFirst ||\n        spacingTrim.trimAdjacent) &&\n      /^[\u2018\u201C\u301D\uFF08\uFF3B\uFF5B\uFF5F\u2329\u3008\u300A\u300C\u300E\u3010\u3014\u3016\u3018\u301A]\\p{M}*$/u.test(text)\n    ) {\n      // fullwidth opening punctuation\n      tagName = \"viv-ts-open\";\n      punctProcessing = true;\n    } else if (\n      (spacingTrim.trimEnd ||\n        spacingTrim.allowEnd ||\n        spacingTrim.trimAdjacent) &&\n      (/^[\u2019\u201D\u301E\u301F\uFF09\uFF3D\uFF5D\uFF60\u232A\u3009\u300B\u300D\u300F\u3011\u3015\u3017\u3019\u301B]\\p{M}*$/u.test(text) ||\n        (lang === \"zh-hans\" && /^[\uFF1A\uFF1B]\\p{M}*$/u.test(text)) ||\n        (lang !== \"zh-hant\" && /^[\u3001\u3002\uFF0C\uFF0E]\\p{M}*$/u.test(text)))\n    ) {\n      // fullwidth closing punctuation\n      tagName = \"viv-ts-close\";\n      punctProcessing = true;\n    }\n\n    if (punctProcessing) {\n      if (textNode.parentElement.localName === \"viv-ts-inner\") {\n        // Already processed\n        return 0;\n      }\n      // Wrap the textNode as `<{tagName}><viv-ts-inner>{text}<viv-ts-inner></{tagName}>`\n      const outerElem = document.createElement(tagName);\n      const innerElem = document.createElement(\"viv-ts-inner\");\n      outerElem.appendChild(innerElem);\n      textNode.parentNode.insertBefore(outerElem, textNode);\n      innerElem.appendChild(textNode);\n\n      // Check if the punctuation is almost full width\n      function checkFullWidth(elem: HTMLElement): boolean {\n        const fontSize = parseFloat(\n          document.defaultView.getComputedStyle(elem).fontSize,\n        );\n        const fullWidthThreshold = fontSize * 0.7;\n        return (\n          (vertical ? elem.offsetHeight : elem.offsetWidth) > fullWidthThreshold\n        );\n      }\n      const isFullWidth = checkFullWidth(innerElem);\n\n      function linePosition(): number {\n        return vertical ? outerElem.offsetLeft : outerElem.offsetTop;\n      }\n\n      if (isFullWidth || hangingFirst || hangingLast || hangingEnd) {\n        if (tagName === \"viv-ts-open\") {\n          if (hangingFirst) {\n            outerElem.className = \"viv-hang-first\";\n          } else if (isFirstInBlock || isFirstAfterForcedLineBreak) {\n            if (spacingTrim.trimStart) {\n              outerElem.className = \"viv-ts-trim\";\n            } else {\n              outerElem.className = \"viv-ts-space\";\n            }\n          } else if (\n            !(spacingTrim.trimStart || spacingTrim.spaceFirst) &&\n            isAtStartOfLine()\n          ) {\n            outerElem.className = \"viv-ts-space\";\n          } else if (\n            spacingTrim.trimAdjacent &&\n            prevNode &&\n            /[\\p{Ps}\\p{Pi}\\p{Pe}\\p{Pf}\\u00B7\\u2027\\u30FB\\u3000\uFF1A\uFF1B\u3001\u3002\uFF0C\uFF0E]\\p{M}*$/u.test(\n              prevNode.textContent,\n            ) &&\n            // exclude non-fullwidth closing punctuations (Issue #1003)\n            (!/[\\p{Pe}\\p{Pf}]\\p{M}*$/u.test(prevNode.textContent) ||\n              (prevNode.parentElement.localName === \"viv-ts-inner\" &&\n                checkFullWidth(prevNode.parentElement)))\n          ) {\n            outerElem.className = \"viv-ts-trim\";\n          } else if (\n            (spacingTrim.trimStart || spacingTrim.spaceFirst) &&\n            isAtStartOfLine()\n          ) {\n            const linePos = linePosition();\n            outerElem.className = \"viv-ts-auto\";\n            if (linePos === linePosition() && !isAtStartOfLine()) {\n              // workaround for issues #1005 and #1010\n              outerElem.className = \"viv-ts-trim\";\n            }\n          }\n        } else if (tagName === \"viv-ts-close\") {\n          if (hangingLast) {\n            outerElem.className = isFullWidth\n              ? \"viv-hang-last\"\n              : \"viv-hang-last viv-hang-hw\";\n          } else if (isLastInBlock || isLastBeforeForcedLineBreak) {\n            const linePos = linePosition();\n            if (hangingEnd) {\n              outerElem.className = isFullWidth\n                ? hangingPunctuation.allowEnd && spacingTrim.allowEnd\n                  ? \"viv-ts-auto\"\n                  : \"viv-hang-end\"\n                : \"viv-hang-end viv-hang-hw\";\n              if (hangingPunctuation.allowEnd && linePos === linePosition()) {\n                if (spacingTrim.trimEnd) {\n                  outerElem.className = \"viv-ts-trim\";\n                } else if (spacingTrim.allowEnd) {\n                  outerElem.className = \"viv-hang-end\";\n                  if (linePos === linePosition()) {\n                    outerElem.className = \"\";\n                  }\n                } else {\n                  outerElem.className = \"viv-ts-space\";\n                }\n              }\n            } else if (spacingTrim.trimEnd) {\n              outerElem.className = \"viv-ts-trim\";\n            } else if (spacingTrim.allowEnd) {\n              outerElem.className = \"viv-ts-auto\";\n              if (linePos === linePosition()) {\n                outerElem.className = \"\";\n              }\n            } else {\n              outerElem.className = \"viv-ts-space\";\n            }\n          } else if (\n            nextNode &&\n            /^[\\p{Pe}\\p{Pf}\\u00B7\\u2027\\u30FB\\u3000\uFF1A\uFF1B\u3001\u3002\uFF0C\uFF0E]/u.test(\n              nextNode.textContent,\n            )\n          ) {\n            if (isFullWidth && spacingTrim.trimAdjacent) {\n              outerElem.className = \"viv-ts-trim\";\n            }\n          } else if (hangingEnd) {\n            const atEnd = isAtEndOfLine();\n            const atEndNoHang = atEnd && hangingPunctuation.allowEnd;\n            if (!atEndNoHang) {\n              outerElem.className = isFullWidth\n                ? \"viv-hang-end\"\n                : \"viv-hang-end viv-hang-hw\";\n            }\n            if (!isFullWidth) {\n              if (!atEnd && !isAtEndOfLine()) {\n                outerElem.className = \"\";\n              }\n            } else if (atEndNoHang && spacingTrim.trimEnd) {\n              outerElem.className = \"viv-ts-auto\";\n            } else if (!atEndNoHang && !isAtEndOfLine()) {\n              outerElem.className = \"\";\n            } else if (!atEnd && hangingPunctuation.allowEnd) {\n              if (!spacingTrim.trimEnd) {\n                outerElem.className = \"viv-ts-space\";\n                if (!isAtEndOfLine()) {\n                  if (spacingTrim.allowEnd) {\n                    outerElem.className = \"viv-ts-auto\";\n                    if (!isAtEndOfLine()) {\n                      outerElem.className = \"viv-hang-end\";\n                    }\n                  } else {\n                    outerElem.className = \"viv-hang-end\";\n                  }\n                }\n              } else {\n                outerElem.className = \"viv-ts-auto\";\n                if (!isAtEndOfLine()) {\n                  outerElem.className = \"viv-hang-end\";\n                }\n              }\n            }\n          } else if (spacingTrim.trimEnd || spacingTrim.allowEnd) {\n            if (isAtEndOfLine()) {\n              if (spacingTrim.allowEnd) {\n                outerElem.className = \"viv-ts-space\";\n              } else {\n                outerElem.className = \"viv-ts-auto\";\n              }\n            } else {\n              const linePos = linePosition();\n              outerElem.className = \"viv-ts-auto\";\n              if (linePos === linePosition()) {\n                outerElem.className = \"\";\n              }\n            }\n          }\n        }\n      }\n    }\n\n    let spaceIdeoAlnumProcessing = false;\n\n    function checkUpright(elem: Element): boolean {\n      const style = elem?.ownerDocument.defaultView?.getComputedStyle(elem);\n      return (\n        !!style &&\n        (style.textOrientation === \"upright\" ||\n          style.textCombineUpright === \"all\" ||\n          style[\"-webkit-text-combine\"] === \"horizontal\")\n      );\n    }\n\n    function checkNonZeroMarginBorderPadding(\n      node1: Node,\n      node2: Node,\n    ): boolean {\n      if (node1.nodeType === 1) {\n        const style = document.defaultView.getComputedStyle(node1 as Element);\n        if (\n          parseFloat(style.marginInlineEnd) ||\n          parseFloat(style.borderInlineEndWidth) ||\n          parseFloat(style.paddingInlineEnd)\n        ) {\n          return true;\n        }\n      }\n      const parent1 = node1.parentElement;\n      if (parent1 && !parent1.contains(node2)) {\n        return checkNonZeroMarginBorderPadding(parent1, node2);\n      }\n      if (node2.nodeType === 1) {\n        const style = document.defaultView.getComputedStyle(node2 as Element);\n        if (\n          parseFloat(style.marginInlineStart) ||\n          parseFloat(style.borderInlineStartWidth) ||\n          parseFloat(style.paddingInlineStart)\n        ) {\n          return true;\n        }\n      }\n      const parent2 = node2.parentElement;\n      if (parent2 && !parent2.contains(node1)) {\n        return checkNonZeroMarginBorderPadding(node1, parent2);\n      }\n      return false;\n    }\n\n    if (autospace.ideographAlpha || autospace.ideographNumeric) {\n      if (\n        prevNode &&\n        /^(?!\\p{P})[\\p{sc=Han}\\u3041-\\u30FF\\u31C0-\\u31FF]/u.test(text) &&\n        ((autospace.ideographAlpha &&\n          /(?![\\p{sc=Han}\\u3041-\\u30FF\\u31C0-\\u31FF\\uFF01-\\uFF60])\\p{L}\\p{M}*$/u.test(\n            prevNode.textContent,\n          )) ||\n          (autospace.ideographNumeric &&\n            /(?![\\uFF01-\\uFF60])\\p{Nd}\\p{M}*$/u.test(prevNode.textContent))) &&\n        !(vertical && checkUpright(prevNode.parentElement)) &&\n        !checkNonZeroMarginBorderPadding(prevNode, textNode)\n      ) {\n        textNode.parentNode.insertBefore(\n          document.createElement(\"viv-ts-thin-sp\"),\n          textNode,\n        );\n        spaceIdeoAlnumProcessing = true;\n      }\n      if (\n        nextNode &&\n        /(?!\\p{P})[\\p{sc=Han}\\u3041-\\u30FF\\u31C0-\\u31FF]\\p{M}*$/u.test(text) &&\n        ((autospace.ideographAlpha &&\n          /^(?![\\p{sc=Han}\\u3041-\\u30FF\\u31C0-\\u31FF\\uFF01-\\uFF60])\\p{L}/u.test(\n            nextNode.textContent,\n          )) ||\n          (autospace.ideographNumeric &&\n            /^(?![\\uFF01-\\uFF60])\\p{Nd}/u.test(nextNode.textContent))) &&\n        !(vertical && checkUpright(nextNode.parentElement)) &&\n        !checkNonZeroMarginBorderPadding(textNode, nextNode)\n      ) {\n        textNode.parentNode.insertBefore(\n          document.createElement(\"viv-ts-thin-sp\"),\n          textNode.nextSibling,\n        );\n        spaceIdeoAlnumProcessing = true;\n      }\n    }\n    return columnOver;\n  }\n\n  registerHooks() {\n    Plugin.registerHook(\n      Plugin.HOOKS.POLYFILLED_INHERITED_PROPS,\n      this.getPolyfilledInheritedProps.bind(this),\n    );\n    Plugin.registerHook(\n      Plugin.HOOKS.PREPROCESS_SINGLE_DOCUMENT,\n      this.preprocessSingleDocument.bind(this),\n    );\n    Plugin.registerHook(\n      Plugin.HOOKS.POST_LAYOUT_BLOCK,\n      this.postLayoutBlock.bind(this),\n      true, // text-spacing must be processed before others (Issue #1105)\n    );\n  }\n}\n\nconst textPolyfill = new TextSpacingPolyfill();\ntextPolyfill.registerHooks();\n\nexport function preprocessForTextSpacing(element: Element): void {\n  textPolyfill.preprocessForTextSpacing(element);\n}\n\nexport function processGeneratedContent(\n  element: HTMLElement,\n  textAutospace: Css.Val,\n  textSpacingTrim: Css.Val,\n  hangingPunctuation: Css.Val,\n  lang: string,\n  vertical: boolean,\n): void {\n  textPolyfill.processGeneratedContent(\n    element,\n    textAutospace,\n    textSpacingTrim,\n    hangingPunctuation,\n    lang,\n    vertical,\n  );\n}\n", "/**\n * Copyright 2019 Vivliostyle Foundation\n *\n * Vivliostyle.js is free software: you can redistribute it and/or modify\n * it under the terms of the GNU Affero General Public License as published by\n * the Free Software Foundation, either version 3 of the License, or\n * (at your option) any later version.\n *\n * Vivliostyle.js is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n * GNU Affero General Public License for more details.\n *\n * You should have received a copy of the GNU Affero General Public License\n * along with Vivliostyle.js.  If not, see <http://www.gnu.org/licenses/>.\n *\n * @fileoverview PseudoElement - CSS pseudo elements.\n */\nimport * as Base from \"./base\";\nimport * as Css from \"./css\";\nimport * as CssCascade from \"./css-cascade\";\nimport * as CssStyler from \"./css-styler\";\nimport * as Exprs from \"./exprs\";\nimport * as TextPolyfill from \"./text-polyfill\";\nimport * as Vtree from \"./vtree\";\nimport { PseudoElement } from \"./types\";\n\nexport const document = new DOMParser().parseFromString(\n  `<root xmlns=\"${Base.NS.SHADOW}\"/>`,\n  \"text/xml\",\n);\n\n/**\n * Pseudoelement names in the order they should be inserted in the shadow DOM,\n * empty string is the place where the element's DOM children are processed.\n */\nexport const pseudoNames = [\n  \"footnote-marker\",\n  \"marker\",\n  \"first-5-lines\",\n  \"first-4-lines\",\n  \"first-3-lines\",\n  \"first-2-lines\",\n  \"first-line\",\n  \"first-letter\",\n  \"before\",\n  \"\",\n  /* content */\n  \"after\",\n];\n\nexport const PSEUDO_ATTR = \"data-adapt-pseudo\";\n\nexport function getPseudoName(element: Element): string {\n  return element.getAttribute(PSEUDO_ATTR) || \"\";\n}\n\nexport function setPseudoName(element: Element, name: string): void {\n  element.setAttribute(PSEUDO_ATTR, name);\n}\n\nexport class PseudoelementStyler implements PseudoElement.PseudoelementStyler {\n  contentProcessed: { [key: string]: boolean } = {};\n\n  // after content: update style\n\n  constructor(\n    public readonly element: Element,\n    public style: CssCascade.ElementStyle,\n    public styler: CssStyler.AbstractStyler,\n    public readonly context: Exprs.Context,\n    public readonly exprContentListener: Vtree.ExprContentListener,\n  ) {}\n\n  /** @override */\n  getStyle(element: Element, deep: boolean): CssCascade.ElementStyle {\n    const pseudoName = getPseudoName(element);\n    if (this.styler && pseudoName && pseudoName.match(/after$/)) {\n      this.style = this.styler.getStyle(this.element, true);\n      this.styler = null;\n    }\n    const pseudoMap = CssCascade.getStyleMap(this.style, \"_pseudos\");\n    const style = pseudoMap?.[pseudoName] || ({} as CssCascade.ElementStyle);\n    if (pseudoName.match(/^first-/) && !style[\"x-first-pseudo\"]) {\n      let nest = 1;\n      let r: RegExpMatchArray;\n      if (pseudoName == \"first-letter\") {\n        nest = 0;\n      } else if ((r = pseudoName.match(/^first-([0-9]+)-lines$/)) != null) {\n        nest = (r[1] as any) - 0;\n      }\n      style[\"x-first-pseudo\"] = new CssCascade.CascadeValue(\n        new Css.Int(nest),\n        0,\n      );\n    }\n    return style;\n  }\n\n  /** @override */\n  processContent(\n    element: Element,\n    styles: { [key: string]: Css.Val },\n    nodeContext: Vtree.NodeContext,\n  ) {\n    const pseudoName = getPseudoName(element);\n    if (!this.contentProcessed[pseudoName]) {\n      this.contentProcessed[pseudoName] = true;\n      if (pseudoName === \"marker\") {\n        this.processMarker(element, styles, nodeContext);\n      }\n      const contentVal = styles[\"content\"];\n      if (Vtree.nonTrivialContent(contentVal)) {\n        contentVal.visit(\n          new Vtree.ContentPropertyHandler(\n            (element.classList.contains(\"_viv-marker-outside\") &&\n              element.firstElementChild) ||\n              element,\n            this.context,\n            contentVal,\n            this.exprContentListener,\n          ),\n        );\n        // text-spacing & hanging-punctuation support\n        TextPolyfill.preprocessForTextSpacing(element);\n      }\n    }\n  }\n\n  /**\n   * ::marker support\n   */\n  private processMarker(\n    element: Element,\n    styles: { [key: string]: Css.Val },\n    nodeContext: Vtree.NodeContext,\n  ): void {\n    const content = styles[\"content\"];\n    const listStylePosition = styles[\"list-style-position\"];\n    const listStyleType = styles[\"list-style-type\"];\n\n    if (Vtree.nonTrivialContent(content)) {\n      if (content instanceof Css.URL) {\n        // content: <URL>\n        //\n        // Wrap URL in a SpaceList to ensure that img element is generated as\n        // a child of the marker pseudo-element.\n        styles[\"content\"] = new Css.SpaceList([content]);\n      } else if (content instanceof Css.Str) {\n        // content: <string>\n        //\n        // The content string may have been made from list-style-type in\n        // `CascadeInstance.processMarkerPseudoelementProps()` in css-cascade.ts.\n        if (listStyleType instanceof Css.Ident) {\n          const lowerName = listStyleType.name.toLowerCase();\n          if (\n            lowerName === \"disc\" ||\n            lowerName === \"circle\" ||\n            lowerName === \"square\" ||\n            lowerName === \"disclosure-open\" ||\n            lowerName === \"disclosure-closed\"\n          ) {\n            // Use special font for bullet symbols.\n            element.classList.add(\"_viv-marker-bullet\");\n            if (\n              lowerName === \"disclosure-open\" ||\n              lowerName === \"disclosure-closed\"\n            ) {\n              const rtl = nodeContext.direction === \"rtl\";\n              const vertical = nodeContext.vertical;\n              // Change disclosure triangles for rtl or vertical text.\n              styles[\"content\"] = new Css.Str(\n                lowerName === \"disclosure-open\"\n                  ? vertical\n                    ? \"\u25C2 \"\n                    : \"\u25BE \"\n                  : vertical\n                    ? rtl\n                      ? \"\u25B4 \"\n                      : \"\u25BE \"\n                    : rtl\n                      ? \"\u25C2 \"\n                      : \"\u25B8 \",\n              );\n            }\n          }\n        }\n      }\n    }\n\n    if (listStylePosition === Css.ident.outside) {\n      // Use special styling to simulate outside markers.\n      element.classList.add(\"_viv-marker-outside\");\n      // Create a span to hold the marker content.\n      const span = element.ownerDocument.createElementNS(Base.NS.XHTML, \"span\");\n      span.classList.add(\"_viv-marker-outside-content\");\n      element.appendChild(span);\n\n      // Prevent text-spacing-trim and hanging-punctuation from trimming or\n      // hanging the suffix \"\u3001\" of counter styles such as \"cjk-decimal\".\n      const textSpacingTrim = nodeContext.inheritedProps[\"text-spacing-trim\"];\n      if (textSpacingTrim && textSpacingTrim !== \"space-all\") {\n        styles[\"text-spacing-trim\"] = Css.ident.normal;\n      }\n      const hangingPunctuation =\n        nodeContext.inheritedProps[\"hanging-punctuation\"];\n      if (hangingPunctuation) {\n        styles[\"hanging-punctuation\"] = Css.ident.none;\n      }\n    }\n\n    // These are used only temporarily to generate content from list-style-*,\n    // so remove them after processing.\n    delete styles[\"list-style-position\"];\n    delete styles[\"list-style-type\"];\n  }\n}\n", "/**\n * Copyright 2013 Google, Inc.\n * Copyright 2015 Daishinsha Inc.\n * Copyright 2019 Vivliostyle Foundation\n *\n * Vivliostyle.js is free software: you can redistribute it and/or modify\n * it under the terms of the GNU Affero General Public License as published by\n * the Free Software Foundation, either version 3 of the License, or\n * (at your option) any later version.\n *\n * Vivliostyle.js is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n * GNU Affero General Public License for more details.\n *\n * You should have received a copy of the GNU Affero General Public License\n * along with Vivliostyle.js.  If not, see <http://www.gnu.org/licenses/>.\n *\n * @fileoverview Layout - Fills a column with styled content.\n * This file does not communicate with the styling system directly.\n * Instead it goes through the layout interface that gives it one view tree\n * node at a time.\n */\nimport * as LayoutRetryers from \"./layout-retryers\";\nimport * as Asserts from \"./asserts\";\nimport * as Shared from \"./shared\";\nimport * as Sizing from \"./sizing\";\nimport * as Break from \"./break\";\nimport * as Logging from \"./logging\";\nimport * as Diff from \"./diff\";\nimport * as Base from \"./base\";\nimport * as BreakPosition from \"./break-position\";\nimport * as Css from \"./css\";\nimport * as GeometryUtil from \"./geometry-util\";\nimport * as LayoutHelper from \"./layout-helper\";\nimport * as LayoutProcessor from \"./layout-processor\";\nimport * as PageFloats from \"./page-floats\";\nimport * as Plugin from \"./plugin\";\nimport * as Matchers from \"./matchers\";\nimport * as PseudoElement from \"./pseudo-element\";\nimport * as Task from \"./task\";\nimport * as Vgen from \"./vgen\";\nimport * as VtreeImpl from \"./vtree\";\nimport {\n  FragmentLayoutConstraintType,\n  Layout,\n  RepetitiveElement,\n  Selectors,\n  Table,\n  Vtree,\n} from \"./types\";\n\nexport const isInstanceOfAfterIfContinuesLayoutConstraint =\n  Selectors.isInstanceOfAfterIfContinuesLayoutConstraint;\nexport const registerFragmentIndex =\n  Matchers.NthFragmentMatcher.registerFragmentIndex;\nexport const clearFragmentIndices =\n  Matchers.NthFragmentMatcher.clearFragmentIndices;\n\nexport class AfterIfContinues implements Selectors.AfterIfContinues {\n  constructor(\n    public readonly sourceNode: Element,\n    public readonly styler: PseudoElement.PseudoelementStyler,\n  ) {}\n\n  createElement(\n    column: Layout.Column,\n    parentNodeContext: Vtree.NodeContext,\n  ): Task.Result<Element> {\n    const doc = parentNodeContext.viewNode.ownerDocument;\n    const viewRoot = doc.createElement(\"div\");\n    const pseudoColumn = new PseudoColumn(column, viewRoot, parentNodeContext);\n    const initialPageBreakType = pseudoColumn.getColumn().pageBreakType;\n    pseudoColumn.getColumn().pageBreakType = null;\n    return pseudoColumn\n      .layout(this.createNodePositionForPseudoElement(), true)\n      .thenAsync(() => {\n        this.styler.contentProcessed[\"after-if-continues\"] = false;\n        pseudoColumn.getColumn().pageBreakType = initialPageBreakType;\n        const pseudoElement = viewRoot.firstChild as Element;\n        Base.setCSSProperty(pseudoElement, \"display\", \"block\");\n        return Task.newResult(pseudoElement);\n      });\n  }\n\n  private createNodePositionForPseudoElement(): Vtree.ChunkPosition {\n    const sourceNode = PseudoElement.document.createElementNS(\n      Base.NS.XHTML,\n      \"div\",\n    );\n    PseudoElement.setPseudoName(sourceNode, \"after-if-continues\");\n    const shadowContext = this.createShadowContext(sourceNode);\n    const step = {\n      node: sourceNode,\n      shadowType: shadowContext.type,\n      shadowContext,\n      nodeShadow: null,\n      shadowSibling: null,\n    };\n    const nodePosition = {\n      steps: [step],\n      offsetInNode: 0,\n      after: false,\n      preprocessedTextContent: null,\n    };\n    return new VtreeImpl.ChunkPosition(nodePosition as any);\n  }\n\n  private createShadowContext(root: Element): Vtree.ShadowContext {\n    return new VtreeImpl.ShadowContext(\n      this.sourceNode,\n      root,\n      null,\n      null,\n      null,\n      Vtree.ShadowType.ROOTED,\n      this.styler,\n    );\n  }\n}\n\nexport class AfterIfContinuesLayoutConstraint\n  implements Selectors.AfterIfContinuesLayoutConstraint\n{\n  flagmentLayoutConstraintType: FragmentLayoutConstraintType =\n    \"AfterIfContinue\";\n\n  constructor(\n    public nodeContext: Vtree.NodeContext,\n    public afterIfContinues: Selectors.AfterIfContinues,\n    public pseudoElementHeight: number,\n  ) {}\n\n  /** @override */\n  allowLayout(\n    nodeContext: Vtree.NodeContext,\n    overflownNodeContext: Vtree.NodeContext,\n    column: Layout.Column,\n  ): boolean {\n    if (\n      (overflownNodeContext && !nodeContext) ||\n      (nodeContext && nodeContext.overflow)\n    ) {\n      return false;\n    } else {\n      return true;\n    }\n  }\n\n  /** @override */\n  nextCandidate(nodeContext: Vtree.NodeContext): boolean {\n    return false;\n  }\n\n  /** @override */\n  postLayout(\n    allowed: boolean,\n    positionAfter: Vtree.NodeContext,\n    initialPosition: Vtree.NodeContext,\n    column: Layout.Column,\n  ) {}\n\n  /** @override */\n  finishBreak(\n    nodeContext: Vtree.NodeContext,\n    column: Layout.Column,\n  ): Task.Result<boolean> {\n    if (!this.getRepetitiveElements().affectTo(nodeContext)) {\n      return Task.newResult(true);\n    }\n    return this.afterIfContinues\n      .createElement(column, this.nodeContext)\n      .thenAsync((element) => {\n        this.nodeContext.viewNode.appendChild(element);\n        return Task.newResult(true);\n      });\n  }\n\n  getRepetitiveElements() {\n    return new AfterIfContinuesElementsOffset(\n      this.nodeContext,\n      this.pseudoElementHeight,\n    );\n  }\n\n  /** @override */\n  equalsTo(constraint: Layout.FragmentLayoutConstraint): boolean {\n    if (!(constraint instanceof AfterIfContinuesLayoutConstraint)) {\n      return false;\n    }\n    return (\n      this.afterIfContinues ==\n      (constraint as AfterIfContinuesLayoutConstraint).afterIfContinues\n    );\n  }\n\n  /** @override */\n  getPriorityOfFinishBreak(): number {\n    return 9;\n  }\n}\n\nexport class AfterIfContinuesElementsOffset\n  implements Selectors.AfterIfContinuesElementsOffset\n{\n  constructor(\n    public nodeContext,\n    public pseudoElementHeight,\n  ) {}\n\n  /** @override */\n  calculateOffset(nodeContext: Vtree.NodeContext): number {\n    if (!this.affectTo(nodeContext)) {\n      return 0;\n    }\n    return this.pseudoElementHeight;\n  }\n\n  /** @override */\n  calculateMinimumOffset(nodeContext: Vtree.NodeContext): number {\n    return this.calculateOffset(nodeContext);\n  }\n\n  affectTo(nodeContext: Vtree.NodeContext): boolean {\n    if (!nodeContext) {\n      return false;\n    }\n    const sourceNode = nodeContext.shadowContext\n      ? nodeContext.shadowContext.owner\n      : nodeContext.sourceNode;\n    if (sourceNode === this.nodeContext.sourceNode) {\n      return !!nodeContext.after;\n    }\n    for (let n = sourceNode.parentNode; n; n = n.parentNode) {\n      if (n === this.nodeContext.sourceNode) {\n        return true;\n      }\n    }\n    return false;\n  }\n}\n\nfunction processAfterIfContinuesOfNodeContext(\n  nodeContext: Vtree.NodeContext,\n  column: Layout.Column,\n): Task.Result<Vtree.NodeContext> {\n  if (\n    !nodeContext ||\n    !nodeContext.afterIfContinues ||\n    nodeContext.after ||\n    column.isFloatNodeContext(nodeContext)\n  ) {\n    return Task.newResult(nodeContext);\n  }\n  const afterIfContinues = nodeContext.afterIfContinues;\n  return afterIfContinues\n    .createElement(column, nodeContext)\n    .thenAsync((pseudoElement) => {\n      Asserts.assert(nodeContext !== null);\n      const pseudoElementHeight = calculatePseudoElementHeight(\n        nodeContext,\n        column,\n        pseudoElement,\n      );\n      column.fragmentLayoutConstraints.push(\n        new AfterIfContinuesLayoutConstraint(\n          nodeContext as Vtree.NodeContext,\n          afterIfContinues,\n          pseudoElementHeight,\n        ),\n      );\n      return Task.newResult(nodeContext);\n    });\n}\n\nexport function processAfterIfContinues(\n  result: Task.Result<Vtree.NodeContext>,\n  column: Layout.Column,\n): Task.Result<Vtree.NodeContext> {\n  return result.thenAsync((nodeContext) =>\n    processAfterIfContinuesOfNodeContext(nodeContext, column),\n  );\n}\n\nexport function processAfterIfContinuesOfAncestors(\n  nodeContext: Vtree.NodeContext,\n  column: Layout.Column,\n): Task.Result<boolean> {\n  const frame: Task.Frame<boolean> = Task.newFrame(\n    \"processAfterIfContinuesOfAncestors\",\n  );\n  let current: Vtree.NodeContext = nodeContext;\n  frame\n    .loop(() => {\n      if (current !== null) {\n        const result = processAfterIfContinuesOfNodeContext(current, column);\n        current = current.parent;\n        return result.thenReturn(true);\n      } else {\n        return Task.newResult(false);\n      }\n    })\n    .then(() => {\n      frame.finish(true);\n    });\n  return frame.result();\n}\n\nexport function calculatePseudoElementHeight(\n  nodeContext: Vtree.NodeContext,\n  column: Layout.Column,\n  pseudoElement: Element,\n): number {\n  const parentNode = nodeContext.viewNode as Element;\n  parentNode.appendChild(pseudoElement);\n  const height = LayoutHelper.getElementHeight(\n    pseudoElement,\n    column,\n    nodeContext.vertical,\n  );\n  parentNode.removeChild(pseudoElement);\n  return height;\n}\n\n/**\n * Represents a constraint on layout\n */\nexport type LayoutConstraint = Layout.LayoutConstraint;\n\n/**\n * Represents a constraint that allows layout if all the constraints it contains\n * allow layout.\n */\nexport class AllLayoutConstraint implements LayoutConstraint {\n  constructor(public readonly constraints: LayoutConstraint[]) {}\n\n  /** @override */\n  allowLayout(nodeContext: Vtree.NodeContext): boolean {\n    return this.constraints.every((c) => c.allowLayout(nodeContext));\n  }\n}\n\n/**\n * Represents constraints on laying out fragments\n */\nexport type FragmentLayoutConstraint = Layout.FragmentLayoutConstraint;\n\nexport type BreakPositionAndNodeContext = Layout.BreakPositionAndNodeContext;\n\n/**\n * Potential breaking position inside CSS box (between lines).\n * @param checkPoints array of breaking points for breakable block\n */\nexport class BoxBreakPosition\n  extends BreakPosition.AbstractBreakPosition\n  implements Layout.BoxBreakPosition\n{\n  private alreadyEvaluated: boolean = false;\n  breakNodeContext: Vtree.NodeContext = null;\n\n  constructor(\n    public readonly checkPoints: Vtree.NodeContext[],\n    public readonly penalty: number,\n  ) {\n    super();\n  }\n\n  override findAcceptableBreak(\n    column: Column,\n    penalty: number,\n  ): Vtree.NodeContext {\n    if (penalty < this.getMinBreakPenalty()) {\n      return null;\n    }\n    if (!this.alreadyEvaluated) {\n      this.breakNodeContext = column.findBoxBreakPosition(this, penalty > 0);\n      this.alreadyEvaluated =\n        !!this.breakNodeContext || penalty > 0 || !!column.pseudoParent;\n    }\n    return this.breakNodeContext;\n  }\n\n  override getMinBreakPenalty(): number {\n    return this.penalty;\n  }\n\n  override getNodeContext(): Vtree.NodeContext {\n    return this.alreadyEvaluated\n      ? this.breakNodeContext\n      : this.checkPoints[this.checkPoints.length - 1];\n  }\n}\n\nexport function validateCheckPoints(checkPoints: Vtree.NodeContext[]): void {\n  for (let i = 1; i < checkPoints.length; i++) {\n    const cp0 = checkPoints[i - 1];\n    const cp1 = checkPoints[i];\n    if (cp0 === cp1) {\n      Logging.logger.warn(\"validateCheckPoints: duplicate entry\");\n    } else if (cp0.boxOffset >= cp1.boxOffset) {\n      Logging.logger.warn(\"validateCheckPoints: incorrect boxOffset\");\n    } else if (cp0.sourceNode == cp1.sourceNode) {\n      if (cp1.after) {\n        if (cp0.after) {\n          Logging.logger.warn(\"validateCheckPoints: duplicate after points\");\n        }\n      } else {\n        if (!cp0.after) {\n          if (\n            cp1.boxOffset - cp0.boxOffset !=\n            cp1.offsetInNode - cp0.offsetInNode\n          ) {\n            Logging.logger.warn(\n              \"validateCheckPoints: boxOffset inconsistent with offsetInNode\",\n            );\n          }\n        }\n      }\n    }\n  }\n}\n\nexport class Column extends VtreeImpl.Container implements Layout.Column {\n  last: Node;\n  viewDocument: Document;\n  flowRootFormattingContext: Vtree.FormattingContext = null;\n  isFloat: boolean = false;\n  isFootnote: boolean = false;\n  startEdge: number = 0;\n  endEdge: number = 0;\n  beforeEdge: number = 0;\n  afterEdge: number = 0;\n  footnoteEdge: number = 0;\n  box: GeometryUtil.Rect = null;\n  chunkPositions: Vtree.ChunkPosition[] = null;\n  bands: GeometryUtil.Band[] = null;\n  overflown: boolean = false;\n  breakPositions: BreakPosition.BreakPosition[] = null;\n  pageBreakType: string | null = null;\n  forceNonfitting: boolean = true;\n  leftFloatEdge: number = 0; // bottom of the bottommost left float\n  rightFloatEdge: number = 0; // bottom of the bottommost right float\n  bottommostFloatTop: number = 0; // Top of the bottommost float\n  stopAtOverflow: boolean = true;\n  lastAfterPosition: Vtree.NodePosition | null = null;\n  fragmentLayoutConstraints: FragmentLayoutConstraint[] = [];\n  pseudoParent: Column = null;\n  nodeContextOverflowingDueToRepetitiveElements: Vtree.NodeContext | null =\n    null;\n  blockDistanceToBlockEndFloats: number = NaN;\n  breakAtTheEdgeBeforeFloat: string | null = null;\n\n  constructor(\n    element: HTMLElement,\n    public layoutContext: Vtree.LayoutContext,\n    public clientLayout: Vtree.ClientLayout,\n    public readonly layoutConstraint: LayoutConstraint,\n    public readonly pageFloatLayoutContext: PageFloats.PageFloatLayoutContext,\n  ) {\n    super(element);\n    if (new.target === Column) {\n      // Mark the column as a root column only when instantiated directly\n      // (excluding PageFloatArea).\n      LayoutHelper.setAsRootColumn(this);\n    }\n    this.last = element.lastChild;\n    this.viewDocument = element.ownerDocument;\n    pageFloatLayoutContext.setContainer(this);\n  }\n\n  getTopEdge(): number {\n    return this.vertical\n      ? this.rtl\n        ? this.endEdge\n        : this.startEdge\n      : this.beforeEdge;\n  }\n\n  getBottomEdge(): number {\n    return this.vertical\n      ? this.rtl\n        ? this.startEdge\n        : this.endEdge\n      : this.afterEdge;\n  }\n\n  getLeftEdge(): number {\n    return this.vertical\n      ? this.afterEdge\n      : this.rtl\n        ? this.endEdge\n        : this.startEdge;\n  }\n\n  getRightEdge(): number {\n    return this.vertical\n      ? this.beforeEdge\n      : this.rtl\n        ? this.startEdge\n        : this.endEdge;\n  }\n\n  isFloatNodeContext(nodeContext: Vtree.NodeContext): boolean {\n    return !!nodeContext.floatSide && (!this.isFloat || !!nodeContext.parent);\n  }\n\n  stopByOverflow(nodeContext: Vtree.NodeContext): boolean {\n    return this.stopAtOverflow && !!nodeContext && nodeContext.overflow;\n  }\n\n  isOverflown(edge: number): boolean {\n    if (this.vertical) {\n      return edge < this.footnoteEdge;\n    } else {\n      return edge > this.footnoteEdge;\n    }\n  }\n\n  getExclusions(): GeometryUtil.Shape[] {\n    const pageFloatExclusions =\n      this.pageFloatLayoutContext.getFloatFragmentExclusions();\n    return this.exclusions.concat(pageFloatExclusions);\n  }\n\n  openAllViews(position: Vtree.NodePosition): Task.Result<Vtree.NodeContext> {\n    const frame: Task.Frame<Vtree.NodeContext> = Task.newFrame(\"openAllViews\");\n    const steps = position.steps;\n    this.layoutContext.setViewRoot(this.element, this.isFootnote);\n    let stepIndex = steps.length - 1;\n    let nodeContext: Vtree.NodeContext = null;\n    frame\n      .loop(() => {\n        while (stepIndex >= 0) {\n          const prevContext = nodeContext;\n          const step = steps[stepIndex];\n          nodeContext = VtreeImpl.makeNodeContextFromNodePositionStep(\n            step,\n            prevContext,\n          );\n          if (\n            stepIndex === steps.length - 1 &&\n            !nodeContext.formattingContext\n          ) {\n            nodeContext.formattingContext = this.flowRootFormattingContext;\n          }\n          if (stepIndex == 0) {\n            nodeContext.offsetInNode =\n              this.calculateOffsetInNodeForNodeContext(position);\n            nodeContext.after = position.after;\n            nodeContext.preprocessedTextContent =\n              position.preprocessedTextContent;\n            if (nodeContext.after) {\n              break;\n            }\n          }\n          const r = this.layoutContext.setCurrent(\n            nodeContext,\n            stepIndex == 0 && nodeContext.offsetInNode == 0,\n          );\n          stepIndex--;\n          if (r.isPending()) {\n            return r;\n          }\n        }\n        return Task.newResult(false);\n      })\n      .then(() => {\n        Asserts.assert(nodeContext);\n        frame.finish(nodeContext);\n      });\n    return frame.result();\n  }\n\n  calculateOffsetInNodeForNodeContext(position: Vtree.NodePosition): number {\n    return position.preprocessedTextContent\n      ? Diff.resolveNewIndex(\n          position.preprocessedTextContent,\n          position.offsetInNode,\n        )\n      : position.offsetInNode;\n  }\n\n  /**\n   * @param count first-XXX nesting identifier\n   */\n  maybePeelOff(\n    position: Vtree.NodeContext,\n    count: number,\n  ): Task.Result<Vtree.NodeContext> {\n    if (\n      position.firstPseudo &&\n      position.inline &&\n      !position.after &&\n      position.firstPseudo.count == 0\n    ) {\n      // first char\n      if (position.viewNode.nodeType != 1) {\n        const text = position.viewNode.textContent;\n        const r = text.match(Base.firstLetterPattern);\n        let firstLetterLength = r ? r[0].length : 0;\n        if (\n          !r &&\n          position.sourceNode?.nodeType === 3 &&\n          position.sourceNode.nextSibling?.nodeType === 3 &&\n          text === position.sourceNode.textContent\n        ) {\n          // The text '\u201CFoo' may be split to '\u201C' and 'Foo'\n          const text2 = text + position.sourceNode.nextSibling.textContent;\n          const r2 = text2.match(Base.firstLetterPattern);\n          if (r2) {\n            const firstLetterText = r2[0];\n            firstLetterLength = firstLetterText.length;\n            position.sourceNode.textContent = firstLetterText;\n            position.viewNode.textContent = firstLetterText;\n            position.sourceNode.nextSibling.textContent =\n              text2.substr(firstLetterLength);\n          }\n        }\n        return this.layoutContext.peelOff(position, firstLetterLength);\n      }\n    }\n    return Task.newResult(position) as Task.Result<Vtree.NodeContext>;\n  }\n\n  /**\n   * Builds the view until a CSS box edge is reached.\n   * @param position start source position.\n   * @param checkPoints array to append possible breaking points.\n   * @return holding box edge position reached or null if the source is exhausted.\n   */\n  buildViewToNextBlockEdge(\n    position: Vtree.NodeContext,\n    checkPoints: Vtree.NodeContext[],\n  ): Task.Result<Vtree.NodeContext> {\n    let violateConstraint = false;\n    const frame: Task.Frame<Vtree.NodeContext> = Task.newFrame(\n      \"buildViewToNextBlockEdge\",\n    );\n    frame\n      .loopWithFrame((bodyFrame) => {\n        if (\n          position.viewNode &&\n          !LayoutHelper.isSpecialNodeContext(position) &&\n          // Prevent breaking inside SVG etc. (Issue #1406)\n          position.viewNode.parentElement?.namespaceURI === Base.NS.XHTML\n        ) {\n          checkPoints.push(position.copy());\n\n          // Prevent performance degradation when the text block is very large.\n          // (Issue #1256)\n          const CHECKPOINTS_THRESHOLD = 1000;\n          if (checkPoints.length > CHECKPOINTS_THRESHOLD) {\n            const element =\n              position.viewNode.nodeType === 1\n                ? (position.viewNode as Element)\n                : position.viewNode.parentElement;\n            const rect = this.clientLayout.getElementClientRect(element);\n\n            // Check if the box position is beyond column breaks with\n            // the browser's column breaking.\n            const columnOver = LayoutHelper.checkIfBeyondColumnBreaks(\n              rect,\n              this.vertical,\n            );\n            if (columnOver >= 2) {\n              // When the box position is beyond two or more column breaks,\n              // it should not be necessary to continue processing further\n              // because it will be processed again in the next column.\n              // Exit the loop\n              bodyFrame.breakLoop();\n              return;\n            }\n          }\n        }\n        this.maybePeelOff(position, 0).then((position1Param) => {\n          const position1 = position1Param as Vtree.NodeContext;\n          if (position1 !== position) {\n            position = position1;\n            if (!LayoutHelper.isSpecialNodeContext(position)) {\n              checkPoints.push(position.copy());\n            }\n          }\n          this.nextInTree(position).then((positionParam) => {\n            position = positionParam as Vtree.NodeContext;\n            if (!position) {\n              // Exit the loop\n              bodyFrame.breakLoop();\n              return;\n            }\n            if (\n              violateConstraint ||\n              !this.layoutConstraint.allowLayout(position)\n            ) {\n              violateConstraint = true;\n              position = position.modify();\n              position.overflow = true;\n            }\n            if (\n              this.isFloatNodeContext(position) &&\n              // Exclude normal floats (fix for issue #611)\n              (PageFloats.isPageFloat(position.floatReference) ||\n                position.floatSide === \"footnote\")\n            ) {\n              this.layoutFloatOrFootnote(position).then((positionParam) => {\n                position = positionParam as Vtree.NodeContext;\n                if (this.pageFloatLayoutContext.isInvalidated()) {\n                  position = null;\n                }\n                if (!position) {\n                  bodyFrame.breakLoop();\n                  return;\n                }\n                bodyFrame.continueLoop();\n              });\n            } else if (!position.inline) {\n              // Exit the loop\n              bodyFrame.breakLoop();\n            } else {\n              // Continue the loop\n              bodyFrame.continueLoop();\n            }\n          });\n        });\n      })\n      .then(() => {\n        frame.finish(position);\n      });\n    return frame.result();\n  }\n\n  nextInTree(\n    position: Vtree.NodeContext,\n    atUnforcedBreak?: boolean,\n  ): Task.Result<Vtree.NodeContext> {\n    const cont = this.layoutContext.nextInTree(position, atUnforcedBreak);\n    return processAfterIfContinues(cont, this);\n  }\n\n  /**\n   * Builds the view for a single unbreakable element.\n   * @param position start source position.\n   * @return holding box edge position reached or null if the source is exhausted.\n   */\n  buildDeepElementView(\n    position: Vtree.NodeContext,\n  ): Task.Result<Vtree.NodeContext> {\n    if (!position.viewNode) {\n      return Task.newResult(position);\n    }\n    let checkPoints: Vtree.NodeContext[] = [];\n    const sourceNode = position.sourceNode;\n    const frame: Task.Frame<Vtree.NodeContext> = Task.newFrame(\n      \"buildDeepElementView\",\n    );\n\n    // TODO: end the loop based on depth, not sourceNode comparison\n    frame\n      .loopWithFrame((bodyFrame) => {\n        if (\n          position.viewNode &&\n          position.inline &&\n          !LayoutHelper.isSpecialNodeContext(position)\n        ) {\n          checkPoints.push(position.copy());\n        } else {\n          if (checkPoints.length > 0) {\n            this.postLayoutBlock(position, checkPoints);\n          }\n          checkPoints = [];\n        }\n        this.maybePeelOff(position, 0).then((position1Param) => {\n          const position1 = position1Param as Vtree.NodeContext;\n          if (position1 !== position) {\n            let p = position1;\n            while (p && p.sourceNode != sourceNode) {\n              p = p.parent;\n            }\n            if (p == null) {\n              // outside of the subtree\n              position = position1;\n              bodyFrame.breakLoop();\n              return;\n            }\n            if (!LayoutHelper.isSpecialNodeContext(position1)) {\n              checkPoints.push(position1.copy());\n            }\n          }\n          this.nextInTree(position1).then((positionParam) => {\n            position = positionParam as Vtree.NodeContext;\n            if (!position || position.sourceNode == sourceNode) {\n              bodyFrame.breakLoop();\n            } else if (!this.layoutConstraint.allowLayout(position)) {\n              position = position.modify();\n              position.overflow = true;\n              if (this.stopAtOverflow) {\n                bodyFrame.breakLoop();\n              } else {\n                bodyFrame.continueLoop();\n              }\n            } else {\n              bodyFrame.continueLoop();\n            }\n          });\n        });\n      })\n      .then(() => {\n        if (checkPoints.length > 0) {\n          this.postLayoutBlock(position, checkPoints);\n        }\n        frame.finish(position);\n      });\n    return frame.result();\n  }\n\n  /**\n   * Create a single floating element (for exclusion areas).\n   * @param ref container's child to insert float before (can be null).\n   * @param side float side (\"left\" or \"right\").\n   * @param width float inline dimension.\n   * @param height float box progression dimension.\n   * @return newly created float element.\n   */\n  createFloat(ref: Node, side: string, width: number, height: number): Element {\n    const div = this.viewDocument.createElement(\"div\");\n    if (this.vertical) {\n      if (height >= this.height) {\n        height -= 0.1;\n      }\n      if (height < 1) {\n        height = 0;\n      }\n      Base.setCSSProperty(div, \"height\", `${width}px`);\n      Base.setCSSProperty(div, \"width\", `${height}px`);\n    } else {\n      if (width >= this.width) {\n        width -= 0.1;\n      }\n      if (width < 1) {\n        width = 0;\n      }\n      Base.setCSSProperty(div, \"width\", `${width}px`);\n      Base.setCSSProperty(div, \"height\", `${height}px`);\n    }\n    Base.setCSSProperty(div, \"float\", side);\n    Base.setCSSProperty(div, \"clear\", side);\n\n    // enable to visualize\n    // Base.setCSSProperty(div, \"background-color\", \"#50F0FF\");\n    this.element.insertBefore(div, ref);\n    return div;\n  }\n\n  /**\n   * Remove all the exclusion floats.\n   */\n  killFloats(): void {\n    let c: Node = this.element.firstChild;\n    while (c) {\n      const nc = c.nextSibling;\n      if (c.nodeType == 1) {\n        const e = c as HTMLElement;\n        const f = e.style.cssFloat;\n        if (f == \"left\" || f == \"right\" || f === \"none\") {\n          this.element.removeChild(e);\n        } else {\n          break;\n        }\n      }\n      c = nc;\n    }\n  }\n\n  /**\n   * Create exclusion floats for a column.\n   */\n  createFloats(): void {\n    const ref = this.element.firstChild;\n    const bands = this.bands;\n    const x1 = this.vertical ? this.getTopEdge() : this.getLeftEdge();\n    const x2 = this.vertical ? this.getBottomEdge() : this.getRightEdge();\n    let foundNonZeroWidthBand: GeometryUtil.Band = null;\n\n    for (const band of bands) {\n      const height = band.y2 - band.y1;\n      band.left = this.createFloat(ref, \"left\", band.x1 - x1, height);\n      band.right = this.createFloat(ref, \"right\", x2 - band.x2, height);\n\n      // Hacky workaround for issue #1071\n      // (Top page float should not absorb margin/border/padding of the block below)\n      if (band.x1 < x2 && band.x2 > x1) {\n        foundNonZeroWidthBand = band;\n      } else if (!foundNonZeroWidthBand) {\n        Base.setCSSProperty(band.right, \"float\", \"none\");\n      }\n    }\n\n    if (foundNonZeroWidthBand) {\n      // Update footnoteEdge (Fix for issue #1298)\n      const lastBand = bands[bands.length - 1];\n      const y2 = this.vertical ? -this.getLeftEdge() : this.getBottomEdge();\n      if (foundNonZeroWidthBand !== lastBand && lastBand.y2 >= y2) {\n        this.footnoteEdge = this.vertical\n          ? -foundNonZeroWidthBand.y2\n          : foundNonZeroWidthBand.y2;\n      }\n    }\n  }\n\n  /**\n   * @param nodeContext position after the block\n   * @param checkPoints array of possible breaking points.\n   * @param index index of the breaking point\n   * @param boxOffset box offset\n   * @return edge position\n   */\n  calculateEdge(\n    nodeContext: Vtree.NodeContext,\n    checkPoints: Vtree.NodeContext[],\n    index: number,\n    boxOffset: number,\n  ): number {\n    let edge: number;\n    if (nodeContext && LayoutHelper.isOrphan(nodeContext.viewNode)) {\n      return NaN;\n    } else if (nodeContext && nodeContext.after && !nodeContext.inline) {\n      edge = LayoutHelper.calculateEdge(\n        nodeContext,\n        this.clientLayout,\n        0,\n        this.vertical,\n      );\n      if (!isNaN(edge)) {\n        return edge;\n      }\n    }\n    nodeContext = checkPoints[index];\n    let offset = boxOffset - nodeContext.boxOffset;\n    while (true) {\n      edge = LayoutHelper.calculateEdge(\n        nodeContext,\n        this.clientLayout,\n        offset,\n        this.vertical,\n      );\n      if (!isNaN(edge)) {\n        return edge;\n      }\n      if (offset > 0) {\n        offset--;\n        continue;\n      }\n      index--;\n      if (index < 0) {\n        return this.beforeEdge;\n      }\n      nodeContext = checkPoints[index];\n      if (nodeContext.viewNode.nodeType != 1) {\n        offset = nodeContext.viewNode.textContent.length;\n      }\n    }\n  }\n\n  /**\n   * Parse CSS computed length (in pixels)\n   * @param val CSS length in \"px\"\n   * @return parsed and adjusted length value in pixels or 0 if not parsable\n   */\n  parseComputedLength(val: string): number {\n    const r = val.match(/^(-?[0-9]*(\\.[0-9]*)?)px$/);\n    if (r) {\n      return this.clientLayout.adjustLengthValue(parseFloat(r[0]));\n    }\n    return 0;\n  }\n\n  /**\n   * Reads element's computed CSS margin.\n   */\n  getComputedMargin(element: Element): GeometryUtil.Insets {\n    const style = this.clientLayout.getElementComputedStyle(element);\n    const insets = new GeometryUtil.Insets(0, 0, 0, 0);\n    if (style) {\n      insets.left = this.parseComputedLength(style.marginLeft);\n      insets.top = this.parseComputedLength(style.marginTop);\n      insets.right = this.parseComputedLength(style.marginRight);\n      insets.bottom = this.parseComputedLength(style.marginBottom);\n    }\n    return insets;\n  }\n\n  /**\n   * Reads element's computed padding + borders.\n   */\n  getComputedPaddingBorder(element: Element): GeometryUtil.Insets {\n    const style = this.clientLayout.getElementComputedStyle(element);\n    const insets = new GeometryUtil.Insets(0, 0, 0, 0);\n    if (style) {\n      insets.left =\n        this.parseComputedLength(style.borderLeftWidth) +\n        this.parseComputedLength(style.paddingLeft);\n      insets.top =\n        this.parseComputedLength(style.borderTopWidth) +\n        this.parseComputedLength(style.paddingTop);\n      insets.right =\n        this.parseComputedLength(style.borderRightWidth) +\n        this.parseComputedLength(style.paddingRight);\n      insets.bottom =\n        this.parseComputedLength(style.borderBottomWidth) +\n        this.parseComputedLength(style.paddingBottom);\n    }\n    return insets;\n  }\n\n  /**\n   * Reads element's computed CSS insets(margins + border + padding or margins :\n   * depends on box-sizing)\n   */\n  getComputedInsets(element: Element): GeometryUtil.Insets {\n    const style = this.clientLayout.getElementComputedStyle(element);\n    const insets = new GeometryUtil.Insets(0, 0, 0, 0);\n    if (style) {\n      if (style.boxSizing == \"border-box\") {\n        return this.getComputedMargin(element);\n      }\n      insets.left =\n        this.parseComputedLength(style.marginLeft) +\n        this.parseComputedLength(style.borderLeftWidth) +\n        this.parseComputedLength(style.paddingLeft);\n      insets.top =\n        this.parseComputedLength(style.marginTop) +\n        this.parseComputedLength(style.borderTopWidth) +\n        this.parseComputedLength(style.paddingTop);\n      insets.right =\n        this.parseComputedLength(style.marginRight) +\n        this.parseComputedLength(style.borderRightWidth) +\n        this.parseComputedLength(style.paddingRight);\n      insets.bottom =\n        this.parseComputedLength(style.marginBottom) +\n        this.parseComputedLength(style.borderBottomWidth) +\n        this.parseComputedLength(style.paddingBottom);\n    }\n    return insets;\n  }\n\n  /**\n   * Set element's computed CSS insets to Column Container\n   */\n  setComputedInsets(element: Element, container: Column) {\n    const style = this.clientLayout.getElementComputedStyle(element);\n    if (style) {\n      container.marginLeft = this.parseComputedLength(style.marginLeft);\n      container.borderLeft = this.parseComputedLength(style.borderLeftWidth);\n      container.paddingLeft = this.parseComputedLength(style.paddingLeft);\n      container.marginTop = this.parseComputedLength(style.marginTop);\n      container.borderTop = this.parseComputedLength(style.borderTopWidth);\n      container.paddingTop = this.parseComputedLength(style.paddingTop);\n      container.marginRight = this.parseComputedLength(style.marginRight);\n      container.borderRight = this.parseComputedLength(style.borderRightWidth);\n      container.paddingRight = this.parseComputedLength(style.paddingRight);\n      container.marginBottom = this.parseComputedLength(style.marginBottom);\n      container.borderBottom = this.parseComputedLength(\n        style.borderBottomWidth,\n      );\n      container.paddingBottom = this.parseComputedLength(style.paddingBottom);\n    }\n  }\n\n  /**\n   * Set element's computed width and height to Column Container\n   */\n  setComputedWidthAndHeight(element: Element, container: Column) {\n    const style = this.clientLayout.getElementComputedStyle(element);\n    if (style) {\n      container.width = this.parseComputedLength(style.width);\n      container.height = this.parseComputedLength(style.height);\n    }\n  }\n\n  /**\n   * Layout a single unbreakable element.\n   */\n  layoutUnbreakable(\n    nodeContextIn: Vtree.NodeContext,\n  ): Task.Result<Vtree.NodeContext> {\n    return this.buildDeepElementView(nodeContextIn);\n  }\n\n  /**\n   * Layout a single float element.\n   */\n  layoutFloat(nodeContext: Vtree.NodeContext): Task.Result<Vtree.NodeContext> {\n    const frame: Task.Frame<Vtree.NodeContext> = Task.newFrame(\"layoutFloat\");\n    const element = nodeContext.viewNode as Element;\n    const floatSide = PageFloats.resolveInlineFloatDirection(\n      nodeContext.floatSide,\n      nodeContext.vertical,\n      nodeContext.direction,\n      (this.layoutContext as Vgen.ViewFactory).page.side,\n    );\n    Base.setCSSProperty(element, \"float\", \"none\");\n    Base.setCSSProperty(element, \"display\", \"inline-block\");\n    Base.setCSSProperty(element, \"vertical-align\", \"top\");\n    this.buildDeepElementView(nodeContext).then((nodeContextAfter) => {\n      const floatBBox = LayoutHelper.getElementClientRectAdjusted(\n        this.clientLayout,\n        element,\n        this.vertical,\n      );\n      const margin = this.getComputedMargin(element);\n      let floatBox = new GeometryUtil.Rect(\n        floatBBox.left - margin.left,\n        floatBBox.top - margin.top,\n        floatBBox.right + margin.right,\n        floatBBox.bottom + margin.bottom,\n      );\n      let x1 = this.rtl ? this.endEdge : this.startEdge;\n      let x2 = this.rtl ? this.startEdge : this.endEdge;\n      let parent = nodeContext.parent;\n      while (parent && parent.inline) {\n        parent = parent.parent;\n      }\n      if (parent) {\n        // Position it at the parent element's edge.\n        // We need to get the edge of the parent's content area, calling\n        // getElementClientRect will also give us borders. Avoid it by creating\n        // a temporary element and using it for measurment.\n        const probe = parent.viewNode.ownerDocument.createElement(\"div\");\n        probe.style.left = \"0px\";\n        probe.style.top = \"0px\";\n        if (this.vertical) {\n          probe.style.bottom = \"0px\";\n          probe.style.width = \"1px\";\n        } else {\n          probe.style.right = \"0px\";\n          probe.style.height = \"1px\";\n        }\n        parent.viewNode.appendChild(probe);\n        const parentBox = LayoutHelper.getElementClientRectAdjusted(\n          this.clientLayout,\n          probe,\n          this.vertical,\n        );\n        x1 = Math.max(\n          this.rtl ? this.getEndEdge(parentBox) : this.getStartEdge(parentBox),\n          x1,\n        );\n        x2 = Math.min(\n          this.rtl ? this.getStartEdge(parentBox) : this.getEndEdge(parentBox),\n          x2,\n        );\n        parent.viewNode.removeChild(probe);\n        const floatBoxMeasure = this.vertical\n          ? floatBox.y2 - floatBox.y1\n          : floatBox.x2 - floatBox.x1;\n        if (floatSide == \"left\") {\n          x2 = Math.max(x2, x1 + floatBoxMeasure);\n        } else {\n          x1 = Math.min(x1, x2 - floatBoxMeasure);\n        }\n\n        // Move the float below the block parent.\n        // Otherwise, if the float is attached to an inline box with 'position:\n        // relative', the absolute positioning of the float gets broken, since\n        // the inline parent can be pushed horizontally by exclusion floats\n        // after the layout of the float is done.\n        if (parent !== nodeContext.parent && !nodeContext.firstPseudo) {\n          // Unless float is specified on ::first-letter (Fix for issue #923)\n          parent.viewNode.appendChild(element);\n\n          // Mark the moved float box so that it is not removed wrongly\n          // when page breaking occurs inside the inline parent.\n          // (Issue #1383, #1422)\n          element.setAttribute(\"data-vivliostyle-float-box-moved\", \"true\");\n        }\n      }\n\n      // box is rotated for vertical orientation\n      let box = new GeometryUtil.Rect(\n        x1,\n        this.getBoxDir() * this.beforeEdge,\n        x2,\n        this.getBoxDir() * this.afterEdge,\n      );\n      let floatHorBox = floatBox;\n      if (this.vertical) {\n        floatHorBox = GeometryUtil.rotateBox(floatBox);\n      }\n      const dir = this.getBoxDir();\n      if (floatHorBox.y1 < this.bottommostFloatTop * dir) {\n        const boxExtent = floatHorBox.y2 - floatHorBox.y1;\n        floatHorBox.y1 = this.bottommostFloatTop * dir;\n        floatHorBox.y2 = floatHorBox.y1 + boxExtent;\n      }\n      GeometryUtil.positionFloat(box, this.bands, floatHorBox, floatSide);\n      if (this.vertical) {\n        floatBox = GeometryUtil.unrotateBox(floatHorBox);\n      }\n      const insets = this.getComputedInsets(element);\n      Base.setCSSProperty(\n        element,\n        \"width\",\n        `${floatBox.x2 - floatBox.x1 - insets.left - insets.right}px`,\n      );\n      Base.setCSSProperty(\n        element,\n        \"height\",\n        `${floatBox.y2 - floatBox.y1 - insets.top - insets.bottom}px`,\n      );\n      Base.setCSSProperty(element, \"position\", \"absolute\");\n      Asserts.assert(nodeContext.display);\n      Base.setCSSProperty(element, \"display\", nodeContext.display);\n      let offsets;\n      let containingBlockForAbsolute: Vtree.NodeContext = null;\n      if (parent) {\n        if (parent.containingBlockForAbsolute) {\n          containingBlockForAbsolute = parent;\n        } else {\n          containingBlockForAbsolute = parent.getContainingBlockForAbsolute();\n        }\n      }\n      if (containingBlockForAbsolute) {\n        const probe =\n          containingBlockForAbsolute.viewNode.ownerDocument.createElement(\n            \"div\",\n          );\n        probe.style.position = \"absolute\";\n        if (containingBlockForAbsolute.vertical) {\n          probe.style.right = \"0\";\n        } else {\n          probe.style.left = \"0\";\n        }\n        probe.style.top = \"0\";\n        containingBlockForAbsolute.viewNode.appendChild(probe);\n        offsets = LayoutHelper.getElementClientRectAdjusted(\n          this.clientLayout,\n          probe,\n          this.vertical,\n        );\n        containingBlockForAbsolute.viewNode.removeChild(probe);\n      } else {\n        offsets = {\n          left: this.getLeftEdge() - this.paddingLeft,\n          right: this.getRightEdge() + this.paddingRight,\n          top: this.getTopEdge() - this.paddingTop,\n        };\n      }\n      if (\n        containingBlockForAbsolute\n          ? containingBlockForAbsolute.vertical\n          : this.vertical\n      ) {\n        Base.setCSSProperty(\n          element,\n          \"right\",\n          `${offsets.right - floatBox.x2}px`,\n        );\n      } else {\n        Base.setCSSProperty(element, \"left\", `${floatBox.x1 - offsets.left}px`);\n      }\n      Base.setCSSProperty(element, \"top\", `${floatBox.y1 - offsets.top}px`);\n      if (nodeContext.clearSpacer) {\n        nodeContext.clearSpacer.parentNode.removeChild(nodeContext.clearSpacer);\n        nodeContext.clearSpacer = null;\n      }\n      const floatBoxEdge = this.vertical ? floatBox.x1 : floatBox.y2;\n      const floatBoxTop = this.vertical ? floatBox.x2 : floatBox.y1;\n\n      // TODO: subtract after margin when determining overflow.\n      if (!this.isOverflown(floatBoxEdge) || this.breakPositions.length == 0) {\n        // no overflow\n        this.killFloats();\n        box = new GeometryUtil.Rect(\n          this.getLeftEdge(),\n          this.getTopEdge(),\n          this.getRightEdge(),\n          this.getBottomEdge(),\n        );\n        if (this.vertical) {\n          box = GeometryUtil.rotateBox(box);\n        }\n        GeometryUtil.addFloatToBands(\n          box,\n          this.bands,\n          floatHorBox,\n          null,\n          floatSide,\n        );\n        this.createFloats();\n        if (floatSide == \"left\") {\n          this.leftFloatEdge = floatBoxEdge;\n        } else {\n          this.rightFloatEdge = floatBoxEdge;\n        }\n        this.bottommostFloatTop = floatBoxTop;\n        this.updateMaxReachedAfterEdge(floatBoxEdge);\n        frame.finish(nodeContextAfter);\n      } else {\n        nodeContext = nodeContext.modify();\n        nodeContext.overflow = true;\n        frame.finish(nodeContext);\n      }\n    });\n    return frame.result();\n  }\n\n  setupFloatArea(\n    area: PageFloatArea,\n    floatReference: PageFloats.FloatReference,\n    floatSide: string,\n    anchorEdge: number | null,\n    strategy: PageFloats.PageFloatLayoutStrategy,\n    condition: PageFloats.PageFloatPlacementCondition,\n  ): boolean {\n    const floatLayoutContext = this.pageFloatLayoutContext;\n    const floatContainer = floatLayoutContext.getContainer(floatReference);\n    const element = area.element;\n    floatContainer.element.parentNode.appendChild(element);\n    area.isFloat = true;\n    area.originX = floatContainer.originX;\n    area.originY = floatContainer.originY;\n    area.vertical = floatContainer.vertical;\n    area.rtl = floatContainer.rtl;\n    area.marginLeft = area.marginRight = area.marginTop = area.marginBottom = 0;\n    area.borderLeft = area.borderRight = area.borderTop = area.borderBottom = 0;\n    area.paddingLeft =\n      area.paddingRight =\n      area.paddingTop =\n      area.paddingBottom =\n        0;\n    area.exclusions = (floatContainer.exclusions || []).concat();\n    area.forceNonfitting = !floatLayoutContext.hasFloatFragments();\n    area.innerShape = null;\n    const containingBlockRect = floatContainer.getPaddingRect();\n    area.setHorizontalPosition(\n      containingBlockRect.x1 - floatContainer.originX,\n      containingBlockRect.x2 - containingBlockRect.x1,\n    );\n    area.setVerticalPosition(\n      containingBlockRect.y1 - floatContainer.originY,\n      containingBlockRect.y2 - containingBlockRect.y1,\n    );\n    strategy.adjustPageFloatArea(area, floatContainer, this);\n\n    // Calculate bands from the exclusions before setting float area dimensions\n    area.init();\n    const fitWithinContainer = !!floatLayoutContext.setFloatAreaDimensions(\n      area,\n      floatReference,\n      floatSide,\n      anchorEdge,\n      true,\n      !floatLayoutContext.hasFloatFragments(),\n      condition,\n    );\n    if (fitWithinContainer) {\n      // New dimensions have been set, remove exclusion floats and re-init\n      area.killFloats();\n      area.init();\n    } else {\n      floatContainer.element.parentNode.removeChild(element);\n    }\n    return fitWithinContainer;\n  }\n\n  createPageFloatArea(\n    float: PageFloats.PageFloat | null,\n    floatSide: string,\n    anchorEdge: number | null,\n    strategy: PageFloats.PageFloatLayoutStrategy,\n    condition: PageFloats.PageFloatPlacementCondition,\n  ): PageFloatArea | null {\n    const floatAreaElement = this.element.ownerDocument.createElement(\"div\");\n    Base.setCSSProperty(floatAreaElement, \"position\", \"absolute\");\n    const parentPageFloatLayoutContext =\n      this.pageFloatLayoutContext.getPageFloatLayoutContext(\n        float.floatReference,\n      );\n\n    // TODO: establish how to specify an appropriate generating element for the\n    // new page float layout context\n    const pageFloatLayoutContext = new PageFloats.PageFloatLayoutContext(\n      null,\n      PageFloats.FloatReference.COLUMN,\n      null,\n      this.pageFloatLayoutContext.flowName,\n      float.nodePosition,\n      null,\n      null,\n    );\n    const parentContainer = parentPageFloatLayoutContext.getContainer();\n    const floatArea = new PageFloatArea(\n      floatSide,\n      floatAreaElement,\n      this.layoutContext.clone(),\n      this.clientLayout,\n      this.layoutConstraint,\n      pageFloatLayoutContext,\n      parentContainer,\n    );\n    pageFloatLayoutContext.setContainer(floatArea);\n    if (\n      this.setupFloatArea(\n        floatArea,\n        float.floatReference,\n        floatSide,\n        anchorEdge,\n        strategy,\n        condition,\n      )\n    ) {\n      return floatArea;\n    } else {\n      return null;\n    }\n  }\n\n  layoutSinglePageFloatFragment(\n    continuations: PageFloats.PageFloatContinuation[],\n    floatSide: string,\n    clearSide: string | null,\n    allowFragmented: boolean,\n    strategy: PageFloats.PageFloatLayoutStrategy,\n    anchorEdge: number | null,\n    pageFloatFragment?: PageFloats.PageFloatFragment | null,\n  ): Task.Result<SinglePageFloatLayoutResult> {\n    const context = this.pageFloatLayoutContext;\n    const originalContinuations = pageFloatFragment\n      ? pageFloatFragment.continuations\n      : [];\n    continuations = originalContinuations.concat(continuations);\n    const firstFloat = continuations[0].float;\n    const condition = context.getPageFloatPlacementCondition(\n      firstFloat,\n      floatSide,\n      clearSide,\n    );\n    const floatArea = this.createPageFloatArea(\n      firstFloat,\n      floatSide,\n      anchorEdge,\n      strategy,\n      condition,\n    );\n    const result: SinglePageFloatLayoutResult = {\n      floatArea,\n      pageFloatFragment: null,\n      newPosition: null,\n    };\n    if (!floatArea) {\n      return Task.newResult(result);\n    }\n    const frame = Task.newFrame<SinglePageFloatLayoutResult>(\n      \"layoutSinglePageFloatFragment\",\n    );\n    let failed = false;\n    let i = 0;\n    frame\n      .loopWithFrame((loopFrame) => {\n        if (i >= continuations.length) {\n          loopFrame.breakLoop();\n          return;\n        }\n        const c = continuations[i];\n        const floatChunkPosition = new VtreeImpl.ChunkPosition(c.nodePosition);\n        floatArea.layout(floatChunkPosition, true).then((newPosition) => {\n          result.newPosition = newPosition;\n          if (!newPosition || allowFragmented) {\n            i++;\n            loopFrame.continueLoop();\n          } else {\n            failed = true;\n            loopFrame.breakLoop();\n          }\n        });\n      })\n      .then(() => {\n        if (!failed) {\n          Asserts.assert(floatArea);\n          const logicalFloatSide = context.setFloatAreaDimensions(\n            floatArea,\n            firstFloat.floatReference,\n            floatSide,\n            anchorEdge,\n            false,\n            allowFragmented,\n            condition,\n          );\n          if (!logicalFloatSide) {\n            failed = true;\n          } else {\n            const newFragment = strategy.createPageFloatFragment(\n              continuations,\n              logicalFloatSide,\n              clearSide,\n              floatArea,\n              !!result.newPosition,\n            );\n            context.addPageFloatFragment(newFragment, true);\n            result.pageFloatFragment = newFragment;\n          }\n        }\n        frame.finish(result);\n      });\n    return frame.result();\n  }\n\n  layoutPageFloatInner(\n    continuation: PageFloats.PageFloatContinuation,\n    strategy: PageFloats.PageFloatLayoutStrategy,\n    anchorEdge: number | null,\n    pageFloatFragment?: PageFloats.PageFloatFragment,\n  ): Task.Result<boolean> {\n    const context = this.pageFloatLayoutContext;\n    const float = continuation.float;\n    context.stashEndFloatFragments(float);\n\n    function cancelLayout(floatArea, pageFloatFragment) {\n      if (pageFloatFragment) {\n        context.removePageFloatFragment(pageFloatFragment, true);\n      } else if (floatArea) {\n        floatArea.element.parentNode.removeChild(floatArea.element);\n      }\n      context.restoreStashedFragments(float.floatReference);\n      context.deferPageFloat(continuation);\n    }\n    const frame: Task.Frame<boolean> = Task.newFrame(\"layoutPageFloatInner\");\n    this.layoutSinglePageFloatFragment(\n      [continuation],\n      float.floatSide,\n      float.clearSide,\n      !context.hasFloatFragments(),\n      strategy,\n      anchorEdge,\n      pageFloatFragment,\n    ).then((result) => {\n      const floatArea = result.floatArea;\n      const newFragment = result.pageFloatFragment;\n      const newPosition = result.newPosition;\n      if (newFragment) {\n        this.layoutStashedPageFloats(float.floatReference, [\n          pageFloatFragment,\n        ]).then((success) => {\n          if (success) {\n            // Add again to invalidate the context\n            Asserts.assert(newFragment);\n            context.addPageFloatFragment(newFragment);\n            context.discardStashedFragments(float.floatReference);\n            if (newPosition) {\n              const continuation = new PageFloats.PageFloatContinuation(\n                float,\n                newPosition.primary,\n              );\n              context.deferPageFloat(continuation);\n            }\n            frame.finish(true);\n          } else {\n            cancelLayout(floatArea, newFragment);\n            frame.finish(false);\n          }\n        });\n      } else {\n        cancelLayout(floatArea, newFragment);\n        frame.finish(false);\n      }\n    });\n    return frame.result();\n  }\n\n  /**\n   * @returns Represents if the layout was succeeded or not\n   */\n  private layoutStashedPageFloats(\n    floatReference: PageFloats.FloatReference,\n    excluded: PageFloats.PageFloatFragment[],\n  ): Task.Result<boolean> {\n    const context = this.pageFloatLayoutContext;\n    const stashedFloatFragments =\n      context.getStashedFloatFragments(floatReference);\n    const newFloatAreas = [];\n    const newFragments = [];\n    let failed = false;\n    const frame = Task.newFrame<boolean>(\"layoutStashedPageFloats\");\n    let i = 0;\n    frame\n      .loopWithFrame((loopFrame) => {\n        if (i >= stashedFloatFragments.length) {\n          loopFrame.breakLoop();\n          return;\n        }\n        const stashedFragment = stashedFloatFragments[i];\n        if (excluded.includes(stashedFragment)) {\n          i++;\n          loopFrame.continueLoop();\n          return;\n        }\n        const strategy =\n          new PageFloats.PageFloatLayoutStrategyResolver().findByFloat(\n            stashedFragment.continuations[0].float,\n          );\n\n        // Value of 'clear' is irrelevant when laying out stashed floats\n        // since whether the 'clear' value allows placing the float\n        // here is already resolved.\n\n        // NOTE: added clearSide for issue #1550\n        this.layoutSinglePageFloatFragment(\n          stashedFragment.continuations,\n          stashedFragment.floatSide,\n          stashedFragment.clearSide,\n          false,\n          strategy,\n          null,\n        ).then((result) => {\n          const floatArea = result.floatArea;\n          if (floatArea) {\n            newFloatAreas.push(floatArea);\n          }\n          const fragment = result.pageFloatFragment;\n          if (fragment) {\n            newFragments.push(fragment);\n            i++;\n            loopFrame.continueLoop();\n          } else {\n            failed = true;\n            loopFrame.breakLoop();\n          }\n        });\n      })\n      .then(() => {\n        if (failed) {\n          newFragments.forEach((fragment) => {\n            context.removePageFloatFragment(fragment, true);\n          });\n          newFloatAreas.forEach((area) => {\n            const elem = area.element;\n            if (elem && elem.parentNode) {\n              elem.parentNode.removeChild(elem);\n            }\n          });\n        } else {\n          stashedFloatFragments.forEach((fragment) => {\n            const elem = fragment.area.element;\n            if (elem && elem.parentNode) {\n              elem.parentNode.removeChild(elem);\n            }\n          });\n        }\n        frame.finish(!failed);\n      });\n    return frame.result();\n  }\n\n  setFloatAnchorViewNode(nodeContext: Vtree.NodeContext): Vtree.NodeContext {\n    const parent = nodeContext.viewNode.parentNode;\n    const anchor = parent.ownerDocument.createElement(\"span\");\n    anchor.setAttribute(LayoutHelper.SPECIAL_ATTR, \"1\");\n    if (nodeContext.floatSide === \"footnote\") {\n      // Defaults for footnote-call, can be overriden by the stylesheet.\n      this.layoutContext.applyPseudoelementStyle(\n        nodeContext,\n        \"footnote-call\",\n        anchor,\n      );\n    }\n    parent.appendChild(anchor);\n    parent.removeChild(nodeContext.viewNode);\n    const nodeContextAfter = nodeContext.modify();\n    nodeContextAfter.after = true;\n    nodeContextAfter.viewNode = anchor;\n    return nodeContextAfter;\n  }\n\n  resolveFloatReferenceFromColumnSpan(\n    floatReference: PageFloats.FloatReference,\n    columnSpan: Css.Val,\n    nodeContext: Vtree.NodeContext,\n  ): Task.Result<PageFloats.FloatReference> {\n    const frame = Task.newFrame(\n      \"resolveFloatReferenceFromColumnSpan\",\n    ) as Task.Frame<PageFloats.FloatReference>;\n    const columnContext = this.pageFloatLayoutContext;\n    const regionContext = columnContext.getPageFloatLayoutContext(\n      PageFloats.FloatReference.REGION,\n    );\n    const isRegionWider =\n      columnContext.getContainer().width < regionContext.getContainer().width;\n    if (isRegionWider && floatReference === PageFloats.FloatReference.COLUMN) {\n      if (columnSpan === Css.ident.auto) {\n        this.buildDeepElementView(nodeContext.copy()).then((position) => {\n          const element = position.viewNode as Element;\n          let inlineSize = Sizing.getSize(this.clientLayout, element, [\n            Sizing.Size.MIN_CONTENT_INLINE_SIZE,\n          ])[Sizing.Size.MIN_CONTENT_INLINE_SIZE];\n          const margin = this.getComputedMargin(element);\n          if (this.vertical) {\n            inlineSize += margin.top + margin.bottom;\n          } else {\n            inlineSize += margin.left + margin.right;\n          }\n          if (inlineSize > this.width) {\n            frame.finish(PageFloats.FloatReference.REGION);\n          } else {\n            frame.finish(floatReference);\n          }\n        });\n      } else if (columnSpan === Css.ident.all) {\n        frame.finish(PageFloats.FloatReference.REGION);\n      } else {\n        frame.finish(floatReference);\n      }\n    } else {\n      frame.finish(floatReference);\n    }\n    return frame.result();\n  }\n\n  layoutPageFloat(\n    nodeContext: Vtree.NodeContext,\n  ): Task.Result<Vtree.NodeContext> {\n    const context = this.pageFloatLayoutContext;\n    const strategy =\n      new PageFloats.PageFloatLayoutStrategyResolver().findByNodeContext(\n        nodeContext,\n      );\n    let cont: Task.Result<PageFloats.PageFloat>;\n    const float = context.findPageFloatByNodePosition(\n      nodeContext.toNodePosition(),\n    );\n    if (!float) {\n      cont = strategy.createPageFloat(nodeContext, context, this);\n    } else {\n      cont = Task.newResult(float);\n    }\n    return cont.thenAsync((float) => {\n      const nodePosition = VtreeImpl.newNodePositionFromNodeContext(\n        nodeContext,\n        0,\n      );\n      const nodeContextAfter = this.setFloatAnchorViewNode(nodeContext);\n      const pageFloatFragment = strategy.findPageFloatFragment(float, context);\n      const continuation = new PageFloats.PageFloatContinuation(\n        float,\n        nodePosition,\n      );\n      if (pageFloatFragment && pageFloatFragment.hasFloat(float)) {\n        context.registerPageFloatAnchor(float, nodeContextAfter.viewNode);\n        return Task.newResult(nodeContextAfter as Vtree.NodeContext);\n      } else if (\n        context.isForbidden(float) ||\n        context.hasPrecedingFloatsDeferredToNext(float)\n      ) {\n        context.deferPageFloat(continuation);\n        context.registerPageFloatAnchor(float, nodeContextAfter.viewNode);\n        return Task.newResult(nodeContextAfter as Vtree.NodeContext);\n      } else if (this.nodeContextOverflowingDueToRepetitiveElements) {\n        return Task.newResult(null);\n      } else {\n        const edge = LayoutHelper.calculateEdge(\n          nodeContextAfter,\n          this.clientLayout,\n          0,\n          this.vertical,\n        );\n        if (this.isOverflown(edge)) {\n          return Task.newResult(nodeContextAfter);\n        } else {\n          return this.layoutPageFloatInner(\n            continuation,\n            strategy,\n            edge,\n            pageFloatFragment,\n          ).thenAsync((success) => {\n            Asserts.assert(float);\n            if (!success) {\n              context.registerPageFloatAnchor(float, nodeContextAfter.viewNode);\n              return Task.newResult(nodeContextAfter);\n            } else {\n              return Task.newResult(null);\n            }\n          });\n        }\n      }\n    });\n  }\n\n  processLineStyling(\n    nodeContext: Vtree.NodeContext,\n    resNodeContext: Vtree.NodeContext,\n    checkPoints: Vtree.NodeContext[],\n  ): Task.Result<Vtree.NodeContext> {\n    const frame: Task.Frame<Vtree.NodeContext> =\n      Task.newFrame(\"processLineStyling\");\n    if (VIVLIOSTYLE_DEBUG) {\n      validateCheckPoints(checkPoints);\n    }\n    let lastCheckPoints = checkPoints.concat([]); // make a copy\n    checkPoints.splice(0, checkPoints.length); // make empty\n    let totalLineCount = 0;\n    let firstPseudo = nodeContext.firstPseudo; // :first-letter is not processed here\n    if (firstPseudo.count == 0) {\n      firstPseudo = firstPseudo.outer; // move to line pseudoelement (if any)\n    }\n    frame\n      .loopWithFrame((loopFrame) => {\n        if (!firstPseudo) {\n          loopFrame.breakLoop();\n          return;\n        }\n        const linePositions = this.findLinePositions(lastCheckPoints);\n        const count = firstPseudo.count - totalLineCount;\n        if (linePositions.length <= count) {\n          loopFrame.breakLoop();\n          return;\n        }\n        const lineBreak = this.findAcceptableBreakInside(\n          lastCheckPoints,\n          linePositions[count - 1],\n          true,\n        );\n        if (lineBreak == null) {\n          loopFrame.breakLoop();\n          return;\n        }\n        this.finishBreak(lineBreak, false, false).then(() => {\n          totalLineCount += count;\n          this.layoutContext\n            .peelOff(lineBreak, 0)\n            .then((resNodeContextParam) => {\n              nodeContext = resNodeContextParam;\n              firstPseudo = nodeContext.firstPseudo;\n              lastCheckPoints = []; // Wipe out line breaks inside pseudoelements\n              this.buildViewToNextBlockEdge(nodeContext, lastCheckPoints).then(\n                (resNodeContextParam) => {\n                  resNodeContext = resNodeContextParam;\n                  loopFrame.continueLoop();\n                },\n              );\n            });\n        });\n      })\n      .then(() => {\n        Array.prototype.push.apply(checkPoints, lastCheckPoints);\n        if (VIVLIOSTYLE_DEBUG) {\n          validateCheckPoints(checkPoints);\n        }\n        frame.finish(resNodeContext);\n      });\n    return frame.result();\n  }\n\n  isLoneImage(checkPoints: Vtree.NodeContext[]): boolean {\n    if (checkPoints.length != 2 && this.breakPositions.length > 0) {\n      return false;\n    }\n    return (\n      checkPoints[0].sourceNode == checkPoints[1].sourceNode &&\n      Base.mediaTags[(checkPoints[0].sourceNode as Element).localName]\n    );\n  }\n\n  getTrailingMarginEdgeAdjustment(\n    trailingEdgeContexts: Vtree.NodeContext[],\n  ): number {\n    // Margins push the computed height, but are not counted as overflow. We\n    // need to find the overall collapsed margin from all enclosed blocks.\n    let maxPos = 0;\n    let minNeg = 0;\n    for (let i = trailingEdgeContexts.length - 1; i >= 0; i--) {\n      const nodeContext = trailingEdgeContexts[i];\n      if (\n        !nodeContext.after ||\n        !nodeContext.viewNode ||\n        nodeContext.viewNode.nodeType != 1\n      ) {\n        break;\n      }\n      const margin = this.getComputedMargin(nodeContext.viewNode as Element);\n      const m = this.vertical ? -margin.left : margin.bottom;\n      if (m > 0) {\n        maxPos = Math.max(maxPos, m);\n      } else {\n        minNeg = Math.min(minNeg, m);\n      }\n    }\n    return maxPos + minNeg;\n  }\n\n  /**\n   * Layout a single CSS box.\n   */\n  layoutBreakableBlock(\n    nodeContext: Vtree.NodeContext,\n  ): Task.Result<Vtree.NodeContext> {\n    const frame: Task.Frame<Vtree.NodeContext> = Task.newFrame(\n      \"layoutBreakableBlock\",\n    );\n    const checkPoints: Vtree.NodeContext[] = [];\n    this.buildViewToNextBlockEdge(nodeContext, checkPoints).then(\n      (resNodeContext) => {\n        // at this point a single block was appended to the column\n        // flowPosition is either null or\n        //  - if !after: contains view for the next block element\n        //  - if after: contains view for the enclosing block element\n        const checkPointIndex = checkPoints.length - 1;\n        if (checkPointIndex < 0) {\n          frame.finish(resNodeContext);\n          return;\n        }\n\n        // Text-spacing etc. must be done before calculating edge. (Issue #898)\n        this.postLayoutBlock(resNodeContext, checkPoints);\n\n        // Record the height\n        // TODO: should this be done after first-line calculation?\n        let edge = this.calculateEdge(\n          resNodeContext,\n          checkPoints,\n          checkPointIndex,\n          checkPoints[checkPointIndex].boxOffset,\n        );\n        let overflown = false;\n        if (\n          !resNodeContext ||\n          !LayoutHelper.isOrphan(resNodeContext.viewNode)\n        ) {\n          const offsets = BreakPosition.calculateOffset(\n            resNodeContext,\n            this.collectElementsOffset(),\n          );\n          overflown = this.isOverflown(\n            edge + (this.vertical ? -1 : 1) * offsets.minimum,\n          );\n          if (\n            this.isOverflown(\n              edge + (this.vertical ? -1 : 1) * offsets.current,\n            ) &&\n            !this.nodeContextOverflowingDueToRepetitiveElements\n          ) {\n            this.nodeContextOverflowingDueToRepetitiveElements = resNodeContext;\n          }\n        }\n        if (resNodeContext == null) {\n          edge += this.getTrailingMarginEdgeAdjustment(checkPoints);\n        }\n        this.updateMaxReachedAfterEdge(edge);\n        let lineCont: Task.Result<Vtree.NodeContext>;\n        if (nodeContext.firstPseudo) {\n          // possibly need to deal with :first-line and friends\n          lineCont = this.processLineStyling(\n            nodeContext,\n            resNodeContext,\n            checkPoints,\n          );\n        } else {\n          lineCont = Task.newResult(resNodeContext);\n        }\n        lineCont.then((nodeContext) => {\n          // Text-spacing etc. must be done before calculating edge. (Issue #898)\n          // this.postLayoutBlock(nodeContext, checkPoints);\n\n          if (checkPoints.length > 0) {\n            this.saveBoxBreakPosition(checkPoints);\n\n            // TODO: how to signal overflow in the last pagargaph???\n            if (overflown && !this.isLoneImage(checkPoints) && nodeContext) {\n              nodeContext = nodeContext.modify();\n              nodeContext.overflow = true;\n            }\n          }\n          frame.finish(nodeContext);\n        });\n      },\n    );\n    return frame.result();\n  }\n\n  postLayoutBlock(\n    nodeContext: Vtree.NodeContext,\n    checkPoints: Vtree.NodeContext[],\n  ) {\n    const hooks: Plugin.PostLayoutBlockHook[] = Plugin.getHooksForName(\n      Plugin.HOOKS.POST_LAYOUT_BLOCK,\n    );\n    hooks.forEach((hook) => {\n      hook(nodeContext, checkPoints, this);\n    });\n  }\n\n  findEndOfLine(\n    linePosition: number,\n    checkPoints: Vtree.NodeContext[],\n    isUpdateMaxReachedAfterEdge: boolean,\n  ): {\n    nodeContext: Vtree.NodeContext;\n    index: number;\n    checkPointIndex: number;\n  } {\n    if (VIVLIOSTYLE_DEBUG) {\n      validateCheckPoints(checkPoints);\n    }\n\n    // Workaround for Blink not returning correct fractional values for\n    // Range.getClientRects.\n    // https://bugs.chromium.org/p/chromium/issues/detail?id=629828\n    const effectiveLinePosition = this.vertical\n      ? linePosition - 1\n      : linePosition + 1;\n\n    // find the first character which is out\n    let lowCP = 0;\n    let low = checkPoints[0].boxOffset;\n    let low1 = lowCP;\n    let highCP = checkPoints.length - 1;\n    let high = checkPoints[highCP].boxOffset;\n    let mid: number;\n    while (low < high) {\n      mid = low + Math.ceil((high - low) / 2);\n\n      // find the node which contains mid index\n      low1 = lowCP;\n      let high1 = highCP;\n      while (low1 < high1) {\n        const mid1 = low1 + Math.ceil((high1 - low1) / 2);\n        if (checkPoints[mid1].boxOffset > mid) {\n          high1 = mid1 - 1;\n        } else {\n          low1 = mid1;\n        }\n      }\n      const edge = this.calculateEdge(null, checkPoints, low1, mid);\n      if (\n        this.vertical\n          ? edge <= effectiveLinePosition\n          : edge >= effectiveLinePosition\n      ) {\n        high = mid - 1;\n        while (checkPoints[low1].boxOffset == mid) {\n          low1--;\n        }\n        highCP = low1;\n      } else {\n        if (isUpdateMaxReachedAfterEdge) {\n          this.updateMaxReachedAfterEdge(edge);\n        }\n        low = mid;\n        lowCP = low1;\n      }\n    }\n    return {\n      nodeContext: checkPoints[low1],\n      index: low,\n      checkPointIndex: low1,\n    };\n  }\n\n  findAcceptableBreakInside(\n    checkPoints: Vtree.NodeContext[],\n    edgePosition: number,\n    force: boolean,\n  ): Vtree.NodeContext {\n    const position = this.findEndOfLine(edgePosition, checkPoints, true);\n    let nodeContext = position.nodeContext;\n\n    if (\n      position.checkPointIndex === 0 &&\n      position.index === nodeContext.boxOffset\n    ) {\n      // Prevent wrong break at beginning of paragraph (Issue #1401, #1406)\n      return null;\n    }\n\n    const viewNode = nodeContext.viewNode;\n    if (\n      viewNode.nodeType != 1 &&\n      viewNode.parentElement?.localName !== \"viv-ts-inner\"\n    ) {\n      const textNode = viewNode as Text;\n      const textNodeBreaker = this.resolveTextNodeBreaker(nodeContext);\n      nodeContext = textNodeBreaker.breakTextNode(\n        textNode,\n        nodeContext,\n        position.index,\n        checkPoints,\n        position.checkPointIndex,\n        force,\n      );\n    } else {\n      // Fix for issue #821, #885, #1459\n      const p = LayoutHelper.findAncestorSpecialInlineNodeContext(nodeContext);\n      if (p) {\n        if (\n          this.breakPositions?.[0] instanceof BoxBreakPosition &&\n          p?.viewNode.contains(this.breakPositions[0].checkPoints[0].viewNode)\n        ) {\n          // Prevent breaks at beginning of the column\n          return null;\n        }\n        // Prevent breaks inside inline-blocks\n        nodeContext = p;\n\n        // Prevent breaks at beginning of paragraph content (Issue #1459)\n        while (!nodeContext.after && nodeContext.inline && nodeContext.parent) {\n          let node = nodeContext.viewNode?.previousSibling;\n          while (\n            node &&\n            (VtreeImpl.canIgnore(node, nodeContext.parent.whitespace) ||\n              LayoutHelper.isOutOfFlow(node))\n          ) {\n            node = node.previousSibling;\n          }\n          if (node) {\n            break;\n          }\n          nodeContext = nodeContext.parent;\n        }\n      }\n    }\n    this.clearOverflownViewNodes(nodeContext, false);\n    return nodeContext;\n  }\n\n  resolveTextNodeBreaker(nodeContext: Vtree.NodeContext): TextNodeBreaker {\n    const hooks: Plugin.ResolveTextNodeBreakerHook[] = Plugin.getHooksForName(\n      Plugin.HOOKS.RESOLVE_TEXT_NODE_BREAKER,\n    );\n    return hooks.reduce(\n      (prev, hook) => hook(nodeContext) || prev,\n      TextNodeBreaker.instance,\n    );\n  }\n\n  /**\n   * Read ranges skipping special elements\n   */\n  getRangeBoxes(start: Node, end: Node): Vtree.ClientRect[] {\n    const arr = [];\n    const range = start.ownerDocument.createRange();\n    let wentUp = false;\n    let node = start;\n    let lastGood: Node = null;\n    let haveStart = false;\n    let endNotReached = true;\n    while (endNotReached) {\n      let seekRange = true;\n      do {\n        let next: Node = null;\n        if (node == end) {\n          if (end.nodeType === 1) {\n            // If end is an element, continue traversing its children to find\n            // the last text node inside it. Finish when end has no child or\n            // when came back from its children (wentUp==true).\n            endNotReached = !(!end.firstChild || wentUp);\n          } else {\n            endNotReached = false;\n          }\n        }\n        const element = node.nodeType === 1 ? (node as Element) : null;\n        if (!element) {\n          if (!haveStart) {\n            if (node.parentNode == null) {\n              endNotReached = false;\n            } else {\n              range.setStartBefore(node);\n              haveStart = true;\n            }\n          }\n          lastGood = node;\n        } else if (wentUp) {\n          wentUp = false;\n        } else if (LayoutHelper.isSpecial(element)) {\n          // Skip special\n          seekRange = !haveStart;\n        } else if (\n          !element.firstChild ||\n          Base.mediaTags[element.localName] ||\n          /^r(uby|[bt]c?)$/.test(element.localName) ||\n          LayoutHelper.isSpecialInlineDisplay(\n            this.clientLayout.getElementComputedStyle(element).display,\n          )\n        ) {\n          // img, ruby, inline-block, etc.\n          seekRange = !haveStart;\n          if (seekRange) {\n            if (element.localName === \"ruby\" && node.firstChild) {\n              // Fix for issue #985\n              node = node.firstChild;\n            }\n            range.setStartBefore(node);\n            haveStart = true;\n            lastGood = node;\n          } else if (!/^r(uby|tc?)$/.test(element.localName)) {\n            // Fix for issue #1319 and #1401\n            lastGood = node;\n          }\n          if (node.contains(end)) {\n            endNotReached = false;\n          }\n        } else {\n          next = node.firstChild;\n        }\n        if (!next) {\n          next = node.nextSibling;\n          if (!next) {\n            wentUp = true;\n            next = node.parentNode;\n          }\n        }\n        node = next;\n      } while (seekRange && endNotReached);\n      if (haveStart) {\n        range.setEndAfter(lastGood);\n        const boxList = this.clientLayout.getRangeClientRects(range);\n\n        // Adjust boxes' positions for column breaking\n        LayoutHelper.adjustRectsForColumnBreaking(boxList, this.vertical);\n\n        for (let i = 0; i < boxList.length; i++) {\n          arr.push(boxList[i]);\n        }\n        haveStart = false;\n      }\n    }\n    return arr;\n  }\n\n  /**\n   * Give block's initial and final nodes, find positions of the line bottoms.\n   * This is, of course, somewhat hacky implementation.\n   * @return position of line breaks\n   */\n  findLinePositions(checkPoints: Vtree.NodeContext[]): number[] {\n    const LOW_OVERLAP = 0.2;\n    const MID_OVERLAP = 0.6;\n    const positions = [];\n    const boxes = this.getRangeBoxes(\n      checkPoints[0].viewNode,\n      checkPoints[checkPoints.length - 1].viewNode,\n    );\n    boxes.sort(\n      this.vertical\n        ? VtreeImpl.clientrectDecreasingRight\n        : VtreeImpl.clientrectIncreasingTop,\n    );\n    let lineBefore = 0;\n    let lineAfter = 0;\n    let lineEnd = 0;\n    let lineLength = 0;\n    let i = 0;\n    const dir = this.getBoxDir();\n    while (true) {\n      if (i < boxes.length) {\n        const box = boxes[i];\n        let overlap = 1;\n        if (lineLength > 0) {\n          const boxSize = Math.max(this.getBoxSize(box), 1);\n          if (dir * this.getBeforeEdge(box) < dir * lineBefore) {\n            overlap = (dir * (this.getAfterEdge(box) - lineBefore)) / boxSize;\n          } else if (dir * this.getAfterEdge(box) > dir * lineAfter) {\n            overlap = (dir * (lineAfter - this.getBeforeEdge(box))) / boxSize;\n          } else {\n            overlap = 1;\n          }\n        }\n        if (\n          lineLength == 0 ||\n          overlap >= MID_OVERLAP ||\n          (overlap >= LOW_OVERLAP && this.getStartEdge(box) >= lineEnd - 1)\n        ) {\n          lineEnd = this.getEndEdge(box);\n          if (this.vertical) {\n            lineBefore =\n              lineLength == 0 ? box.right : Math.max(lineBefore, box.right);\n            lineAfter =\n              lineLength == 0 ? box.left : Math.min(lineAfter, box.left);\n          } else {\n            lineBefore =\n              lineLength == 0 ? box.top : Math.min(lineBefore, box.top);\n            lineAfter =\n              lineLength == 0 ? box.bottom : Math.max(lineAfter, box.bottom);\n          }\n          lineLength++;\n          i++;\n          continue;\n        }\n      }\n\n      // Add line\n      if (lineLength > 0) {\n        positions.push(lineAfter);\n        lineLength = 0;\n      }\n      if (i >= boxes.length) {\n        break;\n      }\n    }\n    positions.sort(Base.numberCompare);\n    if (this.vertical) {\n      positions.reverse();\n    }\n    return positions;\n  }\n\n  calculateClonedPaddingBorder(nodeContext: Vtree.NodeContext): number {\n    let clonedPaddingBorder = 0;\n    for (let nc = nodeContext; nc; nc = nc.parent) {\n      if (\n        !nc.inline &&\n        Break.isCloneBoxDecorationBreak(nc.viewNode as Element)\n      ) {\n        const paddingBorders = this.getComputedPaddingBorder(\n          nc.viewNode as Element,\n        );\n        clonedPaddingBorder += nc.vertical\n          ? -paddingBorders.left\n          : paddingBorders.bottom;\n        if (nc.display === \"table\") {\n          clonedPaddingBorder += (nc.vertical ? -1 : 1) * nc.blockBorderSpacing;\n        }\n      }\n    }\n    return clonedPaddingBorder;\n  }\n\n  private getOffsetByRepetitiveElements(\n    bp?: BreakPosition.BreakPosition,\n  ): number {\n    let offset: { current: number; minimum: number };\n    if (bp) {\n      offset = bp.calculateOffset(this);\n    } else {\n      offset = BreakPosition.calculateOffset(\n        null,\n        this.collectElementsOffset(),\n      );\n    }\n    return offset.current;\n  }\n\n  findBoxBreakPosition(\n    bp: BoxBreakPosition,\n    force: boolean,\n  ): Vtree.NodeContext {\n    // Workaround for issue #816 (Text with ruby overflowed at column/page break)\n    const parentNode = this.element.parentNode;\n    const nextSibling = this.element.nextSibling;\n    parentNode.removeChild(this.element);\n    parentNode.insertBefore(this.element, nextSibling);\n\n    const checkPoints = bp.checkPoints;\n    let block = checkPoints[0];\n    while (block.parent && block.inline) {\n      block = block.parent;\n    }\n    let widows: number;\n    let orphans: number;\n    if (force) {\n      // Last resort, ignore widows/orphans\n      widows = 1;\n      orphans = 1;\n    } else {\n      // Get widows/orphans settings from the block element\n      widows = Math.max(\n        ((block.inheritedProps[\"widows\"] as number) || 2) - 0,\n        1,\n      );\n      orphans = Math.max(\n        ((block.inheritedProps[\"orphans\"] as number) || 2) - 0,\n        1,\n      );\n    }\n\n    // In case of box-decoration-break: clone, width (or height in vertical\n    // writing mode) of cloned paddings and borders should be taken into\n    // account.\n    const clonedPaddingBorder = this.calculateClonedPaddingBorder(block);\n\n    // Select the first overflowing line break position\n    const linePositions = this.findLinePositions(checkPoints);\n    let edge = this.footnoteEdge - clonedPaddingBorder;\n    const dir = this.getBoxDir();\n    const repetitiveElementsOffset = this.getOffsetByRepetitiveElements(bp);\n    edge -= dir * repetitiveElementsOffset;\n\n    // If an \"overflowing\" checkpoint (e.g. not allowed by LayoutConstraint)\n    // exists before the edge, a line containing the checkpoint should be\n    // deferred to the next column.\n    const firstOverflowing =\n      this.findFirstOverflowingEdgeAndCheckPoint(checkPoints);\n    if (isNaN(firstOverflowing.edge)) {\n      firstOverflowing.edge = dir * Infinity;\n    }\n    let lineIndex = Base.binarySearch(linePositions.length, (i) => {\n      const p = linePositions[i];\n      return this.vertical\n        ? p < edge || p <= firstOverflowing.edge\n        : p > edge || p >= firstOverflowing.edge;\n    });\n\n    // If no break point is found due to the \"overflowing\" checkpoint,\n    // give up deferring a line containing the checkpoint and try to cut the\n    // line just before it.\n    const forceCutBeforeOverflowing = lineIndex <= 0;\n    if (forceCutBeforeOverflowing) {\n      lineIndex = Base.binarySearch(linePositions.length, (i) =>\n        this.vertical ? linePositions[i] < edge : linePositions[i] > edge,\n      );\n    }\n\n    // Workaround for the case of block child after text in parent block\n    // (Issue #1036)\n    let lastNode = checkPoints[checkPoints.length - 1].viewNode;\n    if (lastNode?.parentElement.localName === \"viv-ts-inner\") {\n      lastNode = lastNode.parentElement.parentElement;\n    }\n    if (\n      (lineIndex === linePositions.length && lastNode.nextSibling) ||\n      (lineIndex >= linePositions.length - 1 &&\n        lastNode.parentElement.querySelector(\".MJXc-display\")) // for MathJax\n    ) {\n      // Prevent unnecessary page break before the last line\n      // when a block box (may be generated by MathJax) exists\n      // just after the text or inline box.\n      widows = 0;\n    }\n\n    // First edge after the one that both fits and satisfies widows constraint.\n    lineIndex = Math.min(linePositions.length - widows, lineIndex);\n    if (lineIndex < orphans) {\n      // Not enough lines to satisfy orphans constraint, cannot break here.\n      return null;\n    }\n    edge = linePositions[lineIndex - 1];\n    let nodeContext: Vtree.NodeContext;\n    if (forceCutBeforeOverflowing) {\n      nodeContext = firstOverflowing.checkPoint;\n    } else {\n      nodeContext = this.findAcceptableBreakInside(bp.checkPoints, edge, force);\n    }\n    if (nodeContext) {\n      // When line-height is small, the edge calculated above (using Range)\n      // can be larger than the edge of the block container containing the text.\n      // We update the edge by measuring the block edge.\n      const blockEdge = this.getAfterEdgeOfBlockContainer(nodeContext);\n      if (!isNaN(blockEdge) && dir * (edge - blockEdge) > 0) {\n        edge = blockEdge;\n      }\n      this.computedBlockSize =\n        dir * (edge - this.beforeEdge) + repetitiveElementsOffset;\n    }\n    return nodeContext;\n  }\n\n  getAfterEdgeOfBlockContainer(nodeContext: Vtree.NodeContext): number {\n    let blockParent = nodeContext;\n    do {\n      blockParent = blockParent.parent;\n    } while (blockParent && blockParent.inline);\n    if (blockParent) {\n      blockParent = blockParent.copy().modify();\n      blockParent.after = true;\n      return LayoutHelper.calculateEdge(\n        blockParent,\n        this.clientLayout,\n        0,\n        this.vertical,\n      );\n    } else {\n      return NaN;\n    }\n  }\n\n  findFirstOverflowingEdgeAndCheckPoint(checkPoints: Vtree.NodeContext[]): {\n    edge: number;\n    checkPoint: Vtree.NodeContext | null;\n  } {\n    const index = checkPoints.findIndex((cp) => cp.overflow);\n    if (index < 0) {\n      return { edge: NaN, checkPoint: null };\n    }\n    const cp = checkPoints[index];\n    return {\n      edge: this.calculateEdge(null, checkPoints, index, cp.boxOffset),\n      checkPoint: cp,\n    };\n  }\n\n  findEdgeBreakPosition(\n    bp: BreakPosition.EdgeBreakPosition,\n  ): Vtree.NodeContext {\n    this.computedBlockSize =\n      bp.computedBlockSize + this.getOffsetByRepetitiveElements(bp);\n    return bp.position;\n  }\n\n  /**\n   * Finalize a line break.\n   * @return holing true\n   */\n  finishBreak(\n    nodeContext: Vtree.NodeContext,\n    forceRemoveSelf: boolean,\n    endOfColumn: boolean,\n  ): Task.Result<boolean> {\n    Asserts.assert(nodeContext.formattingContext);\n    const layoutProcessor = new LayoutProcessor.LayoutProcessorResolver().find(\n      nodeContext.formattingContext,\n    );\n    let result = layoutProcessor.finishBreak(\n      this,\n      nodeContext,\n      forceRemoveSelf,\n      endOfColumn,\n    );\n    if (!result) {\n      result = LayoutProcessor.blockLayoutProcessor.finishBreak(\n        this,\n        nodeContext,\n        forceRemoveSelf,\n        endOfColumn,\n      );\n    }\n    return result;\n  }\n\n  findAcceptableBreakPosition(): BreakPositionAndNodeContext {\n    let bp: Layout.BreakPosition = null;\n    let nodeContext: Vtree.NodeContext = null;\n    let penalty = 0;\n    let nextPenalty = 0;\n    do {\n      penalty = nextPenalty;\n      nextPenalty = Number.MAX_VALUE;\n      for (\n        let i = this.breakPositions.length - 1;\n        i >= 0 && !nodeContext;\n        --i\n      ) {\n        bp = this.breakPositions[i];\n        nodeContext = bp.findAcceptableBreak(this, penalty);\n        const minPenalty = bp.getMinBreakPenalty();\n        if (minPenalty > penalty) {\n          nextPenalty = Math.min(nextPenalty, minPenalty);\n        }\n      }\n    } while (\n      // Don't need to find a non-optimal break position if\n      // forceNonfitting=false\n      nextPenalty > penalty &&\n      !nodeContext &&\n      this.forceNonfitting\n    );\n    return { breakPosition: nodeContext ? bp : null, nodeContext };\n  }\n\n  doFinishBreak(\n    nodeContext: Vtree.NodeContext,\n    overflownNodeContext: Vtree.NodeContext,\n    initialNodeContext: Vtree.NodeContext,\n    initialComputedBlockSize: number,\n  ): Task.Result<Vtree.NodeContext> {\n    if (\n      this.pageFloatLayoutContext.isInvalidated() ||\n      this.pageBreakType ||\n      !overflownNodeContext\n    ) {\n      return Task.newResult(nodeContext);\n    }\n    const frame: Task.Frame<Vtree.NodeContext> = Task.newFrame(\"doFinishBreak\");\n    let forceRemoveSelf = false;\n    if (!nodeContext) {\n      // Last resort\n      if (this.forceNonfitting) {\n        Logging.logger.warn(\"Could not find any page breaks?!!\");\n        this.skipTailEdges(overflownNodeContext).then((nodeContext) => {\n          if (nodeContext) {\n            nodeContext = nodeContext.modify();\n            nodeContext.overflow = false;\n            this.finishBreak(nodeContext, forceRemoveSelf, true).then(() => {\n              frame.finish(nodeContext);\n            });\n          } else {\n            frame.finish(nodeContext);\n          }\n        });\n        return frame.result();\n      } else {\n        nodeContext = initialNodeContext;\n        forceRemoveSelf = true;\n        this.computedBlockSize = initialComputedBlockSize;\n      }\n    }\n    this.finishBreak(nodeContext, forceRemoveSelf, true).then(() => {\n      frame.finish(nodeContext);\n    });\n    return frame.result();\n  }\n\n  /**\n   * Determines if a page break is acceptable at this position\n   */\n  isBreakable(flowPosition: Vtree.NodeContext): boolean {\n    for (let nc = flowPosition; nc; nc = nc.parent) {\n      if (LayoutHelper.isOutOfFlow(nc.viewNode)) {\n        return false;\n      }\n    }\n    if (flowPosition.after) {\n      return true; // may be an empty block\n    }\n    switch ((flowPosition.sourceNode as Element).namespaceURI) {\n      case Base.NS.SVG:\n        return false;\n    }\n    return !flowPosition.flexContainer;\n  }\n\n  /**\n   * Determines if an indent value is zero\n   */\n  zeroIndent(val: string | number): boolean {\n    const s = val.toString();\n    return s == \"\" || s == \"auto\" || !!s.match(/^0+(.0*)?[^0-9]/);\n  }\n\n  /**\n   * @return true if overflows\n   */\n  checkOverflowAndSaveEdge(\n    nodeContext: Vtree.NodeContext,\n    trailingEdgeContexts: Vtree.NodeContext[],\n  ): boolean {\n    if (!nodeContext) {\n      return false;\n    }\n    for (let nc = nodeContext; nc; nc = nc.parent) {\n      if (LayoutHelper.isOutOfFlow(nc.viewNode)) {\n        return false;\n      }\n    }\n    if (LayoutHelper.isOrphan(nodeContext.viewNode)) {\n      return false;\n    }\n    let edge = LayoutHelper.calculateEdge(\n      nodeContext,\n      this.clientLayout,\n      0,\n      this.vertical,\n    );\n    const offsets = BreakPosition.calculateOffset(\n      nodeContext,\n      this.collectElementsOffset(),\n    );\n    const overflown = this.isOverflown(\n      edge + (this.vertical ? -1 : 1) * offsets.minimum,\n    );\n    if (\n      this.isOverflown(edge + (this.vertical ? -1 : 1) * offsets.current) &&\n      !this.nodeContextOverflowingDueToRepetitiveElements\n    ) {\n      this.nodeContextOverflowingDueToRepetitiveElements = nodeContext;\n    } else if (trailingEdgeContexts) {\n      // If the edge does not overflow add the trailing margin, which is\n      // truncated to the remaining fragmentainer extent.\n      const marginEdge =\n        edge + this.getTrailingMarginEdgeAdjustment(trailingEdgeContexts);\n      const footnoteEdge =\n        this.footnoteEdge - this.getBoxDir() * offsets.current;\n      edge = this.vertical\n        ? Math.min(edge, Math.max(marginEdge, footnoteEdge))\n        : Math.max(edge, Math.min(marginEdge, footnoteEdge));\n    }\n    this.updateMaxReachedAfterEdge(edge);\n    return overflown;\n  }\n\n  /**\n   * Save a possible page break position on a CSS block edge. Check if it\n   * overflows.\n   * @return true if overflows\n   */\n  checkOverflowAndSaveEdgeAndBreakPosition(\n    nodeContext: Vtree.NodeContext,\n    trailingEdgeContexts: Vtree.NodeContext[],\n    saveEvenOverflown: boolean,\n    breakAtTheEdge: string | null,\n  ): boolean {\n    if (!nodeContext) {\n      return false;\n    }\n    if (LayoutHelper.isOrphan(nodeContext.viewNode)) {\n      return false;\n    }\n    const overflown = this.checkOverflowAndSaveEdge(\n      nodeContext,\n      trailingEdgeContexts,\n    );\n    if (saveEvenOverflown || !overflown) {\n      this.saveEdgeBreakPosition(nodeContext, breakAtTheEdge, overflown);\n    }\n    return overflown;\n  }\n\n  applyClearance(nodeContext: Vtree.NodeContext): boolean {\n    if (!nodeContext.viewNode.parentNode) {\n      // Cannot do clearance for nodes without parents\n      return false;\n    }\n    if (nodeContext.floatReference !== PageFloats.FloatReference.INLINE) {\n      // For page floats, clearance is handled differently\n      return false;\n    }\n\n    // measure where the edge of the element would be without clearance\n    const margin = this.getComputedMargin(nodeContext.viewNode as Element);\n    const spacer = nodeContext.viewNode.ownerDocument.createElement(\"div\");\n    if (this.vertical) {\n      spacer.style.bottom = \"0px\";\n      spacer.style.width = \"1px\";\n      spacer.style.marginRight = `${margin.right}px`;\n    } else {\n      spacer.style.right = \"0px\";\n      spacer.style.height = \"1px\";\n      spacer.style.marginTop = `${margin.top}px`;\n    }\n    nodeContext.viewNode.parentNode.insertBefore(spacer, nodeContext.viewNode);\n    let spacerBox = LayoutHelper.getElementClientRectAdjusted(\n      this.clientLayout,\n      spacer,\n      this.vertical,\n    );\n    const edge = this.getBeforeEdge(spacerBox);\n    const dir = this.getBoxDir();\n    const clear =\n      nodeContext.clearSide === \"same\"\n        ? nodeContext.floatSide\n        : nodeContext.clearSide;\n    const clearLR =\n      /^(top|bottom|inside|outside|(block|inline)-(start|end))$/.test(clear)\n        ? PageFloats.resolveInlineFloatDirection(\n            clear,\n            nodeContext.vertical,\n            nodeContext.direction,\n            (this.layoutContext as Vgen.ViewFactory).page.side,\n          )\n        : clear;\n\n    const clearLogical =\n      clearLR === \"left\" || clearLR === \"right\"\n        ? (nodeContext.direction === \"rtl\") === (clearLR === \"left\")\n          ? \"inline-end\"\n          : \"inline-start\"\n        : clearLR;\n\n    let clearEdge = this.pageFloatLayoutContext.getPageFloatClearEdge(\n      clearLogical,\n      this,\n    );\n\n    switch (clearLR) {\n      case \"left\":\n        clearEdge = dir * Math.max(clearEdge * dir, this.leftFloatEdge * dir);\n        break;\n      case \"right\":\n        clearEdge = dir * Math.max(clearEdge * dir, this.rightFloatEdge * dir);\n        break;\n      default:\n        clearEdge =\n          dir *\n          Math.max(\n            clearEdge * dir,\n            Math.max(this.rightFloatEdge * dir, this.leftFloatEdge * dir),\n          );\n    }\n\n    // edge holds the position where element border \"before\" edge will be\n    // without clearance. clearEdge is the \"after\" edge of the float to clear.\n\n    // tolerance to avoid unnecessary clearance due to the pixel rounding errors\n    // (Issue #1608)\n    const tolerance = 1 / (this.clientLayout.pixelRatio || 1);\n    if (edge * dir + tolerance > clearEdge * dir) {\n      // No need for clearance\n      nodeContext.viewNode.parentNode.removeChild(spacer);\n      return false;\n    } else {\n      // Need some clearance, determine how much. Add the clearance node,\n      // measure its after edge and adjust after margin (required due to\n      // possible margin collapse before clearance was introduced).\n      const height = Math.max(1, (clearEdge - edge) * dir);\n      if (this.vertical) {\n        spacer.style.width = `${height}px`;\n      } else {\n        spacer.style.height = `${height}px`;\n      }\n      spacerBox = LayoutHelper.getElementClientRectAdjusted(\n        this.clientLayout,\n        spacer,\n        this.vertical,\n      );\n      const afterEdge = this.getAfterEdge(spacerBox);\n      if (!nodeContext.floatSide) {\n        if (this.vertical) {\n          let wAdj = afterEdge - margin.right - clearEdge;\n          if (wAdj > 0 == margin.right >= 0) {\n            // In addition to collapsed portion\n            wAdj += margin.right;\n          }\n          spacer.style.marginLeft = `${wAdj}px`;\n        } else {\n          let hAdj = clearEdge - (afterEdge + margin.top);\n          if (hAdj > 0 == margin.top >= 0) {\n            // In addition to collapsed portion\n            hAdj += margin.top;\n          }\n          spacer.style.marginBottom = `${hAdj}px`;\n        }\n      }\n      nodeContext.clearSpacer = spacer;\n      return true;\n    }\n  }\n\n  isBFC(formattingContext: Vtree.FormattingContext): boolean {\n    if (LayoutProcessor.isInstanceOfBlockFormattingContext(formattingContext)) {\n      return true;\n    }\n    if (\n      RepetitiveElement.isInstanceOfRepetitiveElementsOwnerFormattingContext(\n        formattingContext,\n      )\n    ) {\n      return true;\n    }\n    return false;\n  }\n\n  /**\n   * Skips positions until either the start of unbreakable block or inline\n   * content. Also sets breakBefore on the result combining break-before and\n   * break-after properties from all elements that meet at the edge.\n   */\n  skipEdges(\n    nodeContext: Vtree.NodeContext,\n    leadingEdge: boolean,\n    forcedBreakValue: string | null,\n  ): Task.Result<Vtree.NodeContext> {\n    const fc = nodeContext.after\n      ? nodeContext.parent?.formattingContext\n      : nodeContext.formattingContext;\n    if (fc && !this.isBFC(fc)) {\n      return Task.newResult(nodeContext);\n    }\n    const frame: Task.Frame<Vtree.NodeContext> = Task.newFrame(\"skipEdges\");\n\n    // If a forced break occurred at the end of the previous column,\n    // nodeContext.after should be false.\n    let atUnforcedBreak =\n      !forcedBreakValue && leadingEdge && nodeContext && nodeContext.after;\n    let breakAtTheEdge = forcedBreakValue;\n    let lastAfterNodeContext: Vtree.NodeContext = null;\n    let leadingEdgeContexts: Vtree.NodeContext[] = [];\n    let trailingEdgeContexts: Vtree.NodeContext[] = [];\n    let onStartEdges = false;\n\n    function needForcedBreak(): boolean {\n      // leadingEdge=true means that we are at the beginning of the new column\n      // and hence must avoid a break (Otherwise leading to an infinite loop)\n      return (\n        !!forcedBreakValue ||\n        (!leadingEdge &&\n          Break.isForcedBreakValue(breakAtTheEdge) &&\n          // prevent unnecessary breaks at the beginning of the column/page\n          // after out-of-flow elements, e.g. position:absolute or running().\n          // (Issue #1176)\n          !atLeadingEdgeIgnoringOutOfFlow())\n      );\n    }\n\n    function atLeadingEdgeIgnoringOutOfFlow(): boolean {\n      if (!lastAfterNodeContext) {\n        return false;\n      }\n      // Exclude if itself is a float (Issue #1288)\n      if (nodeContext.floatSide) {\n        return false;\n      }\n      for (let nc = lastAfterNodeContext; nc?.parent; nc = nc.parent) {\n        let node = nc.after ? nc.viewNode : nc.viewNode?.previousSibling;\n        while (\n          node &&\n          (VtreeImpl.canIgnore(node, nc.parent.whitespace) ||\n            LayoutHelper.isOutOfFlow(node))\n        ) {\n          node = node.previousSibling;\n        }\n        if (node) {\n          return false;\n        }\n      }\n      return true;\n    }\n\n    const processForcedBreak = () => {\n      nodeContext = leadingEdgeContexts[0] || nodeContext;\n      nodeContext.viewNode.parentNode.removeChild(nodeContext.viewNode);\n      this.pageBreakType = breakAtTheEdge;\n    };\n\n    frame\n      .loopWithFrame((loopFrame) => {\n        while (nodeContext) {\n          Asserts.assert(nodeContext.formattingContext);\n          const layoutProcessor =\n            new LayoutProcessor.LayoutProcessorResolver().find(\n              nodeContext.formattingContext,\n            );\n\n          // A code block to be able to use break. Break moves to the next\n          // node position.\n          do {\n            if (!nodeContext.viewNode) {\n              // Non-displayable content, skip\n              break;\n            }\n            if (nodeContext.inline && nodeContext.viewNode.nodeType != 1) {\n              if (\n                VtreeImpl.canIgnore(\n                  nodeContext.viewNode,\n                  nodeContext.whitespace,\n                )\n              ) {\n                // Ignorable text content, skip\n                break;\n              }\n              if (!nodeContext.after) {\n                // Leading edge of non-empty block -> finished going through\n                // all starting edges of the box\n                if (needForcedBreak()) {\n                  processForcedBreak();\n                } else if (\n                  this.checkOverflowAndSaveEdgeAndBreakPosition(\n                    lastAfterNodeContext,\n                    null,\n                    true,\n                    breakAtTheEdge,\n                  )\n                ) {\n                  nodeContext = (\n                    this.stopAtOverflow\n                      ? lastAfterNodeContext || nodeContext\n                      : nodeContext\n                  ).modify();\n                  nodeContext.overflow = true;\n                } else {\n                  nodeContext = nodeContext.modify();\n                  nodeContext.breakBefore = breakAtTheEdge;\n                }\n                loopFrame.breakLoop();\n                return;\n              }\n            }\n            if (!nodeContext.after) {\n              if (nodeContext.floatSide) {\n                // Save break-after:avoid* value at before the float\n                // (Fix for issue #904)\n                this.breakAtTheEdgeBeforeFloat = Break.isAvoidBreakValue(\n                  breakAtTheEdge,\n                )\n                  ? breakAtTheEdge\n                  : null;\n              }\n              if (layoutProcessor) {\n                if (layoutProcessor.startNonInlineElementNode(nodeContext)) {\n                  break;\n                }\n              }\n              if (nodeContext.clearSide) {\n                // clear\n                if (\n                  this.applyClearance(nodeContext) &&\n                  leadingEdge &&\n                  this.breakPositions.length === 0\n                ) {\n                  this.saveEdgeBreakPosition(\n                    nodeContext.copy(),\n                    breakAtTheEdge,\n                    false,\n                  );\n                }\n              }\n              // Check break opportunity between anonymous block box and block-level box\n              // (Issue #611)\n              if (\n                !nodeContext.inline &&\n                !nodeContext.repeatOnBreak &&\n                (lastAfterNodeContext\n                  ? LayoutHelper.findAncestorSpecialInlineNodeContext(\n                      lastAfterNodeContext,\n                    )\n                  : this.breakPositions[\n                      this.breakPositions.length - 1\n                    ] instanceof BoxBreakPosition)\n              ) {\n                this.saveEdgeBreakPosition(\n                  nodeContext.copy(),\n                  breakAtTheEdge,\n                  false,\n                );\n              }\n              if (\n                !this.isBFC(nodeContext.formattingContext) ||\n                RepetitiveElement.isInstanceOfRepetitiveElementsOwnerFormattingContext(\n                  nodeContext.formattingContext,\n                ) ||\n                this.isFloatNodeContext(nodeContext) ||\n                nodeContext.flexContainer ||\n                // Check empty block box (Issue #749)\n                (!nodeContext.nodeShadow &&\n                  !(nodeContext.sourceNode as Element).firstElementChild &&\n                  VtreeImpl.canIgnore(\n                    nodeContext.sourceNode.firstChild,\n                    nodeContext.whitespace,\n                  ))\n              ) {\n                // new formatting context, or float or flex container,\n                // or empty block box (unbreakable)\n                leadingEdgeContexts.push(nodeContext.copy());\n                breakAtTheEdge = Break.resolveEffectiveBreakValue(\n                  breakAtTheEdge,\n                  nodeContext.breakBefore,\n                );\n\n                // check if a forced break must occur before the block.\n                if (needForcedBreak()) {\n                  processForcedBreak();\n                } else if (\n                  this.checkOverflowAndSaveEdgeAndBreakPosition(\n                    lastAfterNodeContext,\n                    null,\n                    true,\n                    breakAtTheEdge,\n                  ) ||\n                  !this.layoutConstraint.allowLayout(nodeContext)\n                ) {\n                  // overflow\n                  nodeContext = (\n                    this.stopAtOverflow\n                      ? lastAfterNodeContext || nodeContext\n                      : nodeContext\n                  ).modify();\n                  nodeContext.overflow = true;\n                }\n                loopFrame.breakLoop();\n                return;\n              }\n            }\n            if (nodeContext.viewNode.nodeType != 1) {\n              // not an element\n              break;\n            }\n            const viewElement = nodeContext.viewNode as HTMLElement;\n            const style = viewElement.style;\n            if (nodeContext.after) {\n              if (\n                style.columnFill === \"balance\" &&\n                viewElement.getAttribute(\"data-vivliostyle-column-fill\") ===\n                  \"auto\"\n              ) {\n                // Restore `column-fill: auto` after layout\n                style.columnFill = \"auto\";\n              }\n              if (nodeContext.floatSide) {\n                // Restore break-after:avoid* value at before the float\n                // (Fix for issue #904)\n                breakAtTheEdge =\n                  breakAtTheEdge ?? this.breakAtTheEdgeBeforeFloat;\n                this.breakAtTheEdgeBeforeFloat = null;\n              }\n              const element = nodeContext.sourceNode as Element;\n              // Make breakable after svg and math elements\n              // (Fix for issue #750)\n              if (\n                element.localName === \"svg\" ||\n                element.localName === \"math\" ||\n                element.getAttribute(\"data-math-typeset\") === \"true\"\n              ) {\n                onStartEdges = false;\n                lastAfterNodeContext = nodeContext.copy();\n                trailingEdgeContexts.push(lastAfterNodeContext);\n                breakAtTheEdge = Break.resolveEffectiveBreakValue(\n                  null,\n                  nodeContext.breakAfter,\n                );\n                this.checkOverflowAndSaveEdgeAndBreakPosition(\n                  lastAfterNodeContext,\n                  null,\n                  !this.stopAtOverflow,\n                  breakAtTheEdge,\n                );\n                break;\n              }\n              // Skip an empty inline box at the start of a block\n              // (An anonymous block consisting entirely of\n              // collapsible white space is removed from the rendering tree)\n              if (nodeContext.inline) {\n                break;\n              }\n              if (layoutProcessor) {\n                if (\n                  layoutProcessor.afterNonInlineElementNode(\n                    nodeContext,\n                    this.stopAtOverflow,\n                  )\n                ) {\n                  break;\n                }\n              }\n\n              // Trailing edge\n              if (onStartEdges) {\n                // finished going through all starting edges of the box.\n                // check if a forced break must occur before the block.\n                if (needForcedBreak()) {\n                  processForcedBreak();\n                  loopFrame.breakLoop();\n                  return;\n                }\n\n                // since a break did not occur, move to the next edge. this\n                // edge is no longer the leading edge.\n                leadingEdgeContexts = [];\n                leadingEdge = false;\n                atUnforcedBreak = false;\n                breakAtTheEdge = null;\n              }\n              onStartEdges = false; // we are now on end edges.\n              lastAfterNodeContext = nodeContext.copy();\n              trailingEdgeContexts.push(lastAfterNodeContext);\n              breakAtTheEdge = Break.resolveEffectiveBreakValue(\n                breakAtTheEdge,\n                nodeContext.breakAfter,\n              );\n              if (\n                style &&\n                !(\n                  this.zeroIndent(style.paddingBottom) &&\n                  this.zeroIndent(style.borderBottomWidth)\n                )\n              ) {\n                // Non-zero trailing inset.\n                // Margins don't collapse across non-zero borders and\n                // paddings.\n                trailingEdgeContexts = [lastAfterNodeContext];\n              }\n            } else {\n              // Leading edge\n              leadingEdgeContexts.push(nodeContext.copy());\n              breakAtTheEdge = Break.resolveEffectiveBreakValue(\n                breakAtTheEdge,\n                nodeContext.breakBefore,\n              );\n\n              // Prevent unnecessary blank pages by removing unnecessary forced column breaks\n              if (\n                lastAfterNodeContext &&\n                Break.isForcedBreakValue(breakAtTheEdge)\n              ) {\n                LayoutHelper.clearForcedColumnBreaks(\n                  lastAfterNodeContext.viewNode,\n                  nodeContext.viewNode,\n                );\n              }\n\n              if (\n                (nodeContext.pageType != nodeContext.parent?.pageType || // Fix for issue #771\n                  !Break.isForcedBreakValue(breakAtTheEdge)) && // Fix for issue #722\n                !this.layoutConstraint.allowLayout(nodeContext)\n              ) {\n                this.checkOverflowAndSaveEdgeAndBreakPosition(\n                  lastAfterNodeContext,\n                  null,\n                  !this.stopAtOverflow,\n                  breakAtTheEdge,\n                );\n                nodeContext = nodeContext.modify();\n                nodeContext.overflow = true;\n                if (this.stopAtOverflow) {\n                  loopFrame.breakLoop();\n                  return;\n                }\n              }\n              const viewTag = (nodeContext.viewNode as Element).localName;\n              if (Base.mediaTags[viewTag]) {\n                // elements that have inherent content\n                // check if a forced break must occur before the block.\n                if (needForcedBreak()) {\n                  processForcedBreak();\n                } else if (\n                  this.checkOverflowAndSaveEdgeAndBreakPosition(\n                    lastAfterNodeContext,\n                    null,\n                    true,\n                    breakAtTheEdge,\n                  )\n                ) {\n                  // overflow\n                  nodeContext = (\n                    this.stopAtOverflow\n                      ? lastAfterNodeContext || nodeContext\n                      : nodeContext\n                  ).modify();\n                  nodeContext.overflow = true;\n                }\n                loopFrame.breakLoop();\n                return;\n              }\n              if (\n                style &&\n                !(\n                  this.zeroIndent(style.paddingTop) &&\n                  this.zeroIndent(style.borderTopWidth)\n                )\n              ) {\n                // Non-zero leading inset\n                atUnforcedBreak = false;\n                trailingEdgeContexts = [];\n              }\n              onStartEdges = true; // we are now on starting edges.\n            }\n          } while (false); // End of block of code to use break\n\n          const nextResult = this.nextInTree(nodeContext, atUnforcedBreak);\n          if (nextResult.isPending()) {\n            nextResult.then((nodeContextParam) => {\n              nodeContext = nodeContextParam;\n              loopFrame.continueLoop();\n            });\n            return;\n          } else {\n            nodeContext = nextResult.get();\n          }\n        }\n\n        if (\n          this.checkOverflowAndSaveEdgeAndBreakPosition(\n            lastAfterNodeContext,\n            trailingEdgeContexts,\n            !this.stopAtOverflow,\n            breakAtTheEdge,\n          )\n        ) {\n          if (lastAfterNodeContext && this.stopAtOverflow) {\n            nodeContext = lastAfterNodeContext.modify();\n            nodeContext.overflow = true;\n          } else {\n            // TODO: what to return here??\n          }\n        } else if (Break.isForcedBreakValue(breakAtTheEdge)) {\n          this.pageBreakType = breakAtTheEdge;\n        }\n        loopFrame.breakLoop();\n      })\n      .then(() => {\n        if (lastAfterNodeContext) {\n          this.lastAfterPosition = lastAfterNodeContext.toNodePosition();\n        }\n        frame.finish(nodeContext);\n      });\n    return frame.result();\n  }\n\n  /**\n   * Skips non-renderable positions until it hits the end of the flow or some\n   * renderable content. Returns the nodeContext that was passed in if some\n   * content remains and null if all content could be skipped.\n   */\n  skipTailEdges(\n    nodeContext: Vtree.NodeContext,\n  ): Task.Result<Vtree.NodeContext> {\n    let resultNodeContext = nodeContext.copy();\n    const frame: Task.Frame<Vtree.NodeContext> = Task.newFrame(\"skipEdges\");\n    let breakAtTheEdge: string | null = null;\n    let onStartEdges = false;\n    frame\n      .loopWithFrame((loopFrame) => {\n        while (nodeContext) {\n          // A code block to be able to use break. Break moves to the next\n          // node position.\n          do {\n            if (!nodeContext.viewNode) {\n              // Non-displayable content, skip\n              break;\n            }\n            if (nodeContext.inline && nodeContext.viewNode.nodeType != 1) {\n              if (\n                VtreeImpl.canIgnore(\n                  nodeContext.viewNode,\n                  nodeContext.whitespace,\n                )\n              ) {\n                // Ignorable text content, skip\n                break;\n              }\n              if (!nodeContext.after) {\n                // Leading edge of non-empty block -> finished going through\n                // all starting edges of the box\n                if (Break.isForcedBreakValue(breakAtTheEdge)) {\n                  this.pageBreakType = breakAtTheEdge;\n                }\n                loopFrame.breakLoop();\n                return;\n              }\n            }\n            if (!nodeContext.after) {\n              if (\n                this.isFloatNodeContext(nodeContext) ||\n                nodeContext.flexContainer\n              ) {\n                // float or flex container (unbreakable)\n                breakAtTheEdge = Break.resolveEffectiveBreakValue(\n                  breakAtTheEdge,\n                  nodeContext.breakBefore,\n                );\n\n                // check if a forced break must occur before the block.\n                if (Break.isForcedBreakValue(breakAtTheEdge)) {\n                  this.pageBreakType = breakAtTheEdge;\n                }\n                loopFrame.breakLoop();\n                return;\n              }\n            }\n            if (nodeContext.viewNode.nodeType != 1) {\n              // not an element\n              break;\n            }\n            const style = (nodeContext.viewNode as HTMLElement).style;\n            if (nodeContext.after) {\n              // Trailing edge\n              if (onStartEdges) {\n                // finished going through all starting edges of the box.\n                // check if a forced break must occur before the block.\n                if (Break.isForcedBreakValue(breakAtTheEdge)) {\n                  this.pageBreakType = breakAtTheEdge;\n                  loopFrame.breakLoop();\n                  return;\n                }\n\n                // since a break did not occur, move to the next edge.\n                breakAtTheEdge = null;\n              }\n              onStartEdges = false; // we are now on end edges.\n              breakAtTheEdge = Break.resolveEffectiveBreakValue(\n                breakAtTheEdge,\n                nodeContext.breakAfter,\n              );\n            } else {\n              // Leading edge\n              breakAtTheEdge = Break.resolveEffectiveBreakValue(\n                breakAtTheEdge,\n                nodeContext.breakBefore,\n              );\n              const viewTag = (nodeContext.viewNode as Element).localName;\n              if (Base.mediaTags[viewTag]) {\n                // elements that have inherent content\n                // check if a forced break must occur before the block.\n                if (Break.isForcedBreakValue(breakAtTheEdge)) {\n                  this.pageBreakType = breakAtTheEdge;\n                }\n                loopFrame.breakLoop();\n                return;\n              }\n              if (\n                style &&\n                !(\n                  this.zeroIndent(style.paddingTop) &&\n                  this.zeroIndent(style.borderTopWidth)\n                )\n              ) {\n                // Non-zero leading inset\n                loopFrame.breakLoop();\n                return;\n              }\n            }\n            onStartEdges = true; // we are now on starting edges.\n          } while (false); // End of block of code to use break\n\n          const nextResult = this.layoutContext.nextInTree(nodeContext);\n          if (nextResult.isPending()) {\n            nextResult.then((nodeContextParam) => {\n              nodeContext = nodeContextParam;\n              loopFrame.continueLoop();\n            });\n            return;\n          } else {\n            nodeContext = nextResult.get();\n          }\n        }\n        resultNodeContext = null;\n        loopFrame.breakLoop();\n      })\n      .then(() => {\n        frame.finish(resultNodeContext);\n      });\n    return frame.result();\n  }\n\n  layoutFloatOrFootnote(\n    nodeContext: Vtree.NodeContext,\n  ): Task.Result<Vtree.NodeContext> {\n    if (\n      PageFloats.isPageFloat(nodeContext.floatReference) ||\n      nodeContext.floatSide === \"footnote\"\n    ) {\n      return this.layoutPageFloat(nodeContext);\n    } else {\n      return this.layoutFloat(nodeContext);\n    }\n  }\n\n  /**\n   * Layout next portion of the source.\n   */\n  layoutNext(\n    nodeContext: Vtree.NodeContext,\n    leadingEdge: boolean,\n    forcedBreakValue?: string | null,\n  ): Task.Result<Vtree.NodeContext> {\n    const frame: Task.Frame<Vtree.NodeContext> = Task.newFrame(\"layoutNext\");\n    this.skipEdges(nodeContext, leadingEdge, forcedBreakValue || null).then(\n      (nodeContextParam) => {\n        nodeContext = nodeContextParam as Vtree.NodeContext;\n        if (\n          !nodeContext ||\n          this.pageBreakType ||\n          this.stopByOverflow(nodeContext)\n        ) {\n          // finished all content, explicit page break or overflow (automatic\n          // page break)\n          frame.finish(nodeContext);\n        } else {\n          const formattingContext = nodeContext.formattingContext;\n          Asserts.assert(formattingContext);\n          const layoutProcessor =\n            new LayoutProcessor.LayoutProcessorResolver().find(\n              formattingContext,\n            );\n          layoutProcessor\n            .layout(nodeContext, this, leadingEdge)\n            .thenFinish(frame);\n        }\n      },\n    );\n    return frame.result();\n  }\n\n  clearOverflownViewNodes(\n    nodeContext: Vtree.NodeContext,\n    removeSelf: boolean,\n  ): void {\n    if (!nodeContext) {\n      return;\n    }\n    for (\n      let parent = nodeContext.parent;\n      nodeContext;\n      nodeContext = parent, parent = parent ? parent.parent : null\n    ) {\n      const formattingContext = (parent || nodeContext).formattingContext;\n      Asserts.assert(formattingContext);\n      const layoutProcessor =\n        new LayoutProcessor.LayoutProcessorResolver().find(formattingContext);\n      layoutProcessor.clearOverflownViewNodes(\n        this,\n        parent,\n        nodeContext,\n        removeSelf,\n      );\n      removeSelf = false;\n    }\n  }\n\n  initGeom(): void {\n    // TODO: we should be able to avoid querying the layout engine at this\n    // point. Create an element that fills the content area and query its size.\n    // Calling getElementClientRect on the container element includes element\n    // padding which is wrong for our purposes.\n    const probe = this.element.ownerDocument.createElement(\"div\");\n    probe.style.position = \"absolute\";\n    probe.style.top = `${this.paddingTop}px`;\n    probe.style.right = `${this.paddingRight}px`;\n    probe.style.bottom = `${this.paddingBottom}px`;\n    probe.style.left = `${this.paddingLeft}px`;\n    this.element.appendChild(probe);\n    const columnBBox = this.clientLayout.getElementClientRect(probe);\n    this.element.removeChild(probe);\n    const offsetX = this.originX + this.left + this.getInsetLeft();\n    const offsetY = this.originY + this.top + this.getInsetTop();\n    this.box = new GeometryUtil.Rect(\n      offsetX,\n      offsetY,\n      offsetX + this.width,\n      offsetY + this.height,\n    );\n    this.startEdge = columnBBox\n      ? this.vertical\n        ? this.rtl\n          ? columnBBox.bottom\n          : columnBBox.top\n        : this.rtl\n          ? columnBBox.right\n          : columnBBox.left\n      : 0;\n    this.endEdge = columnBBox\n      ? this.vertical\n        ? this.rtl\n          ? columnBBox.top\n          : columnBBox.bottom\n        : this.rtl\n          ? columnBBox.left\n          : columnBBox.right\n      : 0;\n    this.beforeEdge = columnBBox\n      ? this.vertical\n        ? columnBBox.right\n        : columnBBox.top\n      : 0;\n    this.afterEdge = columnBBox\n      ? this.vertical\n        ? columnBBox.left\n        : columnBBox.bottom\n      : 0;\n    this.leftFloatEdge = this.beforeEdge;\n    this.rightFloatEdge = this.beforeEdge;\n    this.bottommostFloatTop = this.beforeEdge;\n    this.footnoteEdge = this.afterEdge;\n    this.bands = GeometryUtil.shapesToBands(\n      this.box,\n      [this.getInnerShape()],\n      this.getExclusions(),\n      8,\n      this.snapHeight,\n      this.vertical,\n    );\n    this.createFloats();\n  }\n\n  init(): void {\n    this.chunkPositions = [];\n    Base.setCSSProperty(this.element, \"width\", `${this.width}px`);\n    Base.setCSSProperty(this.element, \"height\", `${this.height}px`);\n    this.initGeom();\n    this.computedBlockSize = 0;\n    this.overflown = false;\n    this.pageBreakType = null;\n    this.lastAfterPosition = null;\n  }\n\n  /**\n   * Save the potential breaking position at the edge. Should, in general, save\n   * \"after\" position but only after skipping all of the \"before\" ones and\n   * getting to the non-empty content (to get breakAtEdge right).\n   */\n  saveEdgeBreakPosition(\n    position: Vtree.NodeContext,\n    breakAtEdge: string | null,\n    overflows: boolean,\n  ): void {\n    Asserts.assert(position.formattingContext);\n    const copy = position.copy();\n    const layoutProcessor = new LayoutProcessor.LayoutProcessorResolver().find(\n      position.formattingContext,\n    );\n    const clonedPaddingBorder = this.calculateClonedPaddingBorder(copy);\n    const bp = layoutProcessor.createEdgeBreakPosition(\n      copy,\n      breakAtEdge,\n      overflows,\n      this.computedBlockSize + clonedPaddingBorder,\n    );\n    this.breakPositions.push(bp);\n  }\n\n  /**\n   * @param checkPoints array of breaking points for breakable block\n   */\n  saveBoxBreakPosition(checkPoints: Vtree.NodeContext[]): void {\n    let penalty = checkPoints[0].breakPenalty;\n    if (penalty) {\n      // Fix for issue #546\n      let block = checkPoints[0];\n      while (block.parent && block.inline) {\n        block = block.parent;\n      }\n      penalty = block.breakPenalty;\n    }\n    const bp = new BoxBreakPosition(checkPoints, penalty);\n    this.breakPositions.push(bp);\n  }\n\n  updateMaxReachedAfterEdge(afterEdge: number) {\n    if (!isNaN(afterEdge)) {\n      const size = this.getBoxDir() * (afterEdge - this.beforeEdge);\n      this.computedBlockSize = Math.max(size, this.computedBlockSize);\n    }\n  }\n\n  /**\n   * @param chunkPosition starting position.\n   * @return holding end position.\n   */\n  layout(\n    chunkPosition: Vtree.ChunkPosition,\n    leadingEdge: boolean,\n    breakAfter?: string | null,\n  ): Task.Result<Vtree.ChunkPosition> {\n    this.chunkPositions.push(chunkPosition); // So we can re-layout this column later\n    if (chunkPosition.primary.after) {\n      this.lastAfterPosition = chunkPosition.primary;\n    }\n    if (this.stopAtOverflow && this.overflown) {\n      return Task.newResult(chunkPosition as Vtree.ChunkPosition);\n    }\n    if (this.isFullWithPageFloats()) {\n      if (\n        chunkPosition.primary.after &&\n        chunkPosition.primary.steps.length === 1\n      ) {\n        // End of contents\n        return Task.newResult(null as Vtree.ChunkPosition);\n      } else {\n        return Task.newResult(chunkPosition as Vtree.ChunkPosition);\n      }\n    }\n\n    if (LayoutHelper.isRootColumn(this)) {\n      // Enable page/column breaking using the browser's multi-column feature.\n      LayoutHelper.setBrowserColumnBreaking(this);\n    }\n\n    const frame: Task.Frame<Vtree.ChunkPosition> = Task.newFrame(\"layout\");\n\n    // ------ start the column -----------\n    this.openAllViews(chunkPosition.primary).then((nodeContext) => {\n      let initialNodeContext: Vtree.NodeContext = null;\n      if (nodeContext.viewNode) {\n        initialNodeContext = nodeContext.copy();\n      } else {\n        const nextInTreeListener = (evt) => {\n          if (evt.nodeContext.viewNode) {\n            initialNodeContext = evt.nodeContext;\n            this.layoutContext.removeEventListener(\n              \"nextInTree\",\n              nextInTreeListener,\n            );\n          }\n        };\n        this.layoutContext.addEventListener(\"nextInTree\", nextInTreeListener);\n      }\n      const retryer = new ColumnLayoutRetryer(leadingEdge, breakAfter);\n      retryer.layout(nodeContext, this).then((nodeContextParam) => {\n        this.doFinishBreak(\n          nodeContextParam,\n          retryer.context.overflownNodeContext,\n          initialNodeContext,\n          retryer.initialComputedBlockSize,\n        ).then((positionAfter) => {\n          let cont: Task.Result<boolean> = null;\n          if (!this.pseudoParent) {\n            cont = this.doFinishBreakOfFragmentLayoutConstraints(positionAfter);\n          } else {\n            cont = Task.newResult(null);\n          }\n          cont.then(() => {\n            if (this.pageFloatLayoutContext.isInvalidated()) {\n              frame.finish(null);\n              return;\n            }\n            if (!positionAfter) {\n              frame.finish(null);\n            } else {\n              this.overflown = true;\n              const result = new VtreeImpl.ChunkPosition(\n                positionAfter.toNodePosition(),\n              );\n              frame.finish(result);\n            }\n          });\n        });\n      });\n    });\n    return frame.result();\n  }\n\n  isFullWithPageFloats(): boolean {\n    return this.pageFloatLayoutContext.isColumnFullWithPageFloats(this);\n  }\n\n  getMaxBlockSizeOfPageFloats(): number {\n    return this.pageFloatLayoutContext.getMaxBlockSizeOfPageFloats();\n  }\n\n  doFinishBreakOfFragmentLayoutConstraints(\n    nodeContext: Vtree.NodeContext,\n  ): Task.Result<boolean> {\n    const frame: Task.Frame<boolean> = Task.newFrame(\n      \"doFinishBreakOfFragmentLayoutConstraints\",\n    );\n    const sortedFragmentLayoutConstraints = [].concat(\n      this.fragmentLayoutConstraints,\n    );\n    sortedFragmentLayoutConstraints.sort(\n      (a, b) => a.getPriorityOfFinishBreak() - b.getPriorityOfFinishBreak(),\n    );\n    let i = 0;\n    frame\n      .loop(() => {\n        if (i < sortedFragmentLayoutConstraints.length) {\n          const result = sortedFragmentLayoutConstraints[i++].finishBreak(\n            nodeContext,\n            this,\n          );\n          return result.thenReturn(true);\n        } else {\n          return Task.newResult(false);\n        }\n      })\n      .then(() => {\n        frame.finish(true);\n      });\n    return frame.result();\n  }\n\n  /**\n   * @param nodeContext starting position.\n   * @return holding end position.\n   */\n  doLayout(\n    nodeContext: Vtree.NodeContext,\n    leadingEdge: boolean,\n    breakAfter?: string | null,\n  ): Task.Result<{\n    nodeContext: Vtree.NodeContext;\n    overflownNodeContext: Vtree.NodeContext;\n  }> {\n    const frame: Task.Frame<{\n      nodeContext: Vtree.NodeContext;\n      overflownNodeContext: Vtree.NodeContext;\n    }> = Task.newFrame(\"doLayout\");\n    let overflownNodeContext: Vtree.NodeContext = null;\n\n    // ------ init backtracking list -----\n    this.breakPositions = [];\n    this.nodeContextOverflowingDueToRepetitiveElements = null;\n\n    // ------- fill the column -------------\n    frame\n      .loopWithFrame((loopFrame) => {\n        while (nodeContext) {\n          // fill a single block\n          let pending = true;\n          this.layoutNext(nodeContext, leadingEdge, breakAfter || null).then(\n            (nodeContextParam) => {\n              leadingEdge = false;\n              breakAfter = null;\n              if (\n                this.nodeContextOverflowingDueToRepetitiveElements &&\n                this.stopAtOverflow\n              ) {\n                this.pageBreakType = null;\n                nodeContext =\n                  this.nodeContextOverflowingDueToRepetitiveElements;\n                nodeContext.overflow = true;\n              } else {\n                nodeContext = nodeContextParam;\n              }\n              if (this.pageFloatLayoutContext.isInvalidated()) {\n                loopFrame.breakLoop();\n              } else if (this.pageBreakType) {\n                // explicit page break\n                loopFrame.breakLoop(); // Loop end\n              } else if (nodeContext && this.stopByOverflow(nodeContext)) {\n                // overflow (implicit page break): back up and find a\n                // page break\n                overflownNodeContext = nodeContext;\n                const bp = this.findAcceptableBreakPosition();\n                nodeContext = bp.nodeContext;\n                if (bp.breakPosition) {\n                  bp.breakPosition.breakPositionChosen(this);\n                }\n                loopFrame.breakLoop(); // Loop end\n              } else {\n                if (pending) {\n                  // Sync case\n                  pending = false;\n                } else {\n                  // Async case\n                  loopFrame.continueLoop();\n                }\n              }\n            },\n          );\n          if (pending) {\n            // Async case and loop end\n            pending = false;\n            return;\n          }\n        }\n\n        // Sync case\n        this.computedBlockSize += this.getOffsetByRepetitiveElements();\n        loopFrame.breakLoop();\n      })\n      .then(() => {\n        frame.finish({ nodeContext, overflownNodeContext });\n      });\n    return frame.result();\n  }\n\n  /**\n   * Re-layout already laid-out chunks. Return the position of the last flow if\n   * there is an overflow.\n   * TODO: deal with chunks that did not fit at all.\n   * @return holding end position.\n   */\n  redoLayout(): Task.Result<Vtree.ChunkPosition> {\n    const chunkPositions = this.chunkPositions;\n    let last: Node = this.element.lastChild;\n    while (last != this.last) {\n      const prev = last.previousSibling;\n      if (\n        !(\n          this.element === last.parentNode &&\n          (this.layoutContext as Vgen.ViewFactory).isPseudoelement(last)\n        )\n      ) {\n        this.element.removeChild(last);\n      }\n      last = prev;\n    }\n    this.killFloats();\n    this.init();\n    const frame: Task.Frame<Vtree.ChunkPosition> = Task.newFrame(\"redoLayout\");\n    let i = 0;\n    let res: Vtree.ChunkPosition = null;\n    let leadingEdge = true;\n    frame\n      .loopWithFrame((loopFrame) => {\n        if (i < chunkPositions.length) {\n          const chunkPosition = chunkPositions[i++];\n          this.layout(chunkPosition, leadingEdge).then((pos) => {\n            leadingEdge = false;\n            if (pos) {\n              res = pos;\n              loopFrame.breakLoop();\n            } else {\n              loopFrame.continueLoop();\n            }\n          });\n          return;\n        }\n        loopFrame.breakLoop();\n      })\n      .then(() => {\n        frame.finish(res);\n      });\n    return frame.result();\n  }\n\n  saveDistanceToBlockEndFloats() {\n    const blockStartEdgeOfBlockEndFloats =\n      this.pageFloatLayoutContext.getBlockStartEdgeOfBlockEndFloats();\n    if (\n      blockStartEdgeOfBlockEndFloats > 0 &&\n      isFinite(blockStartEdgeOfBlockEndFloats)\n    ) {\n      this.blockDistanceToBlockEndFloats =\n        this.getBoxDir() *\n        (blockStartEdgeOfBlockEndFloats -\n          this.beforeEdge -\n          this.computedBlockSize);\n    }\n  }\n\n  collectElementsOffset(): RepetitiveElement.ElementsOffset[] {\n    const repetitiveElements: RepetitiveElement.ElementsOffset[] = [];\n    for (let current: Column = this; current; current = current.pseudoParent) {\n      current.fragmentLayoutConstraints.forEach((constraint) => {\n        if (\n          RepetitiveElement.isInstanceOfRepetitiveElementsOwnerLayoutConstraint(\n            constraint,\n          )\n        ) {\n          const repetitiveElement = constraint.getRepetitiveElements();\n          repetitiveElements.push(repetitiveElement);\n        }\n        if (\n          Selectors.isInstanceOfAfterIfContinuesLayoutConstraint(constraint)\n        ) {\n          const repetitiveElement = constraint.getRepetitiveElements();\n          repetitiveElements.push(repetitiveElement);\n        }\n        if (Table.isInstanceOfTableRowLayoutConstraint(constraint)) {\n          constraint\n            .getElementsOffsetsForTableCell(this)\n            .forEach((repetitiveElement) => {\n              repetitiveElements.push(repetitiveElement);\n            });\n        }\n      });\n    }\n    return repetitiveElements;\n  }\n}\n\n/**\n * Represents a \"pseudo\"-column nested inside a real column.\n * This class is created to handle parallel fragmented flows (e.g. table columns\n * in a single table row). A pseudo-column behaves in the same way as the\n * original column, sharing its properties. Property changes on the\n * pseudo-column are not propagated to the original column. The LayoutContext of\n * the original column is also cloned and used by the pseudo-column, not to\n * propagate state changes of the LayoutContext caused by the pseudo-column.\n * @param column The original (parent) column\n * @param viewRoot Root element for the pseudo-column, i.e., the root of the\n *     fragmented flow.\n * @param parentNodeContext A NodeContext generating this PseudoColumn\n */\nexport class PseudoColumn {\n  startNodeContexts: Vtree.NodeContext[] = [];\n  private column: Layout.Column;\n  constructor(\n    column: Layout.Column,\n    viewRoot: HTMLElement,\n    parentNodeContext: Vtree.NodeContext,\n  ) {\n    this.column = Object.create(column) as Layout.Column;\n    this.column.element = viewRoot;\n    this.column.layoutContext = column.layoutContext.clone();\n    this.column.stopAtOverflow = false;\n    this.column.flowRootFormattingContext = parentNodeContext.formattingContext;\n    this.column.pseudoParent = column;\n    const parentClonedPaddingBorder =\n      this.column.calculateClonedPaddingBorder(parentNodeContext);\n    this.column.footnoteEdge =\n      this.column.footnoteEdge - parentClonedPaddingBorder;\n    const pseudoColumn = this;\n    this.column.openAllViews = function (position) {\n      return Column.prototype.openAllViews\n        .call(this, position)\n        .thenAsync((result) => {\n          pseudoColumn.startNodeContexts.push(result.copy());\n          return Task.newResult(result);\n        });\n    };\n  }\n  /**\n   * @param chunkPosition starting position.\n   * @return holding end position.\n   */\n  layout(\n    chunkPosition: Vtree.ChunkPosition,\n    leadingEdge: boolean,\n  ): Task.Result<Vtree.ChunkPosition> {\n    return this.column.layout(chunkPosition, leadingEdge);\n  }\n  findAcceptableBreakPosition(\n    allowBreakAtStartPosition: boolean,\n  ): Layout.BreakPositionAndNodeContext {\n    const p = this.column.findAcceptableBreakPosition();\n    if (allowBreakAtStartPosition) {\n      const startNodeContext = this.startNodeContexts[0].copy();\n      const bp = new BreakPosition.EdgeBreakPosition(\n        startNodeContext,\n        null,\n        startNodeContext.overflow,\n        0,\n      );\n      bp.findAcceptableBreak(this.column, 0);\n      if (!p.nodeContext) {\n        return { breakPosition: bp, nodeContext: startNodeContext };\n      }\n    }\n    return p;\n  }\n  /**\n   * @return holing true\n   */\n  finishBreak(\n    nodeContext: Vtree.NodeContext,\n    forceRemoveSelf: boolean,\n    endOfColumn: boolean,\n  ): Task.Result<boolean> {\n    return this.column.finishBreak(nodeContext, forceRemoveSelf, endOfColumn);\n  }\n  doFinishBreakOfFragmentLayoutConstraints(positionAfter: Vtree.NodeContext) {\n    this.column.doFinishBreakOfFragmentLayoutConstraints(positionAfter);\n  }\n  isStartNodeContext(nodeContext: Vtree.NodeContext): boolean {\n    const startNodeContext = this.startNodeContexts[0];\n    return (\n      startNodeContext.viewNode === nodeContext.viewNode &&\n      startNodeContext.after === nodeContext.after &&\n      startNodeContext.offsetInNode === nodeContext.offsetInNode\n    );\n  }\n  isLastAfterNodeContext(nodeContext: Vtree.NodeContext): boolean {\n    return VtreeImpl.isSameNodePosition(\n      nodeContext.toNodePosition(),\n      this.column.lastAfterPosition,\n    );\n  }\n  getColumnElement(): Element {\n    return this.column.element;\n  }\n  getColumn(): Layout.Column {\n    return this.column;\n  }\n}\n\nexport type SinglePageFloatLayoutResult = Layout.SinglePageFloatLayoutResult;\n\n/**\n * breaking point resolver for Text Node.\n */\nexport class TextNodeBreaker implements Layout.TextNodeBreaker {\n  breakTextNode(\n    textNode: Text,\n    nodeContext: Vtree.NodeContext,\n    low: number,\n    checkPoints: Vtree.NodeContext[],\n    checkpointIndex: number,\n    force: boolean,\n  ): Vtree.NodeContext {\n    if (nodeContext.after) {\n      nodeContext.offsetInNode = textNode.length;\n    } else {\n      // Character with index low is the last one that fits.\n      let viewIndex = low - nodeContext.boxOffset;\n      const text = textNode.data;\n      if (text.charCodeAt(viewIndex) == 173) {\n        viewIndex = this.breakAfterSoftHyphen(\n          textNode,\n          text,\n          viewIndex,\n          nodeContext,\n        );\n      } else {\n        viewIndex = this.breakAfterOtherCharacter(\n          textNode,\n          text,\n          viewIndex,\n          nodeContext,\n        );\n      }\n      if (viewIndex > 0) {\n        nodeContext = this.updateNodeContext(nodeContext, viewIndex, textNode);\n      }\n    }\n    return nodeContext;\n  }\n\n  breakAfterSoftHyphen(\n    textNode: Text,\n    text: string,\n    viewIndex: number,\n    nodeContext: Vtree.NodeContext,\n  ): number {\n    // convert trailing soft hyphen to a real hyphen\n    const checkJoiningType =\n      // /[\\p{Joining_Type=D}\\p{Joining_Type=C}]\\p{Mn}*$/\n      // eslint-disable-next-line no-misleading-character-class\n      /[\\u0620\\u0626\\u0628\\u062A-\\u062E\\u0633-\\u0647\\u0649\\u064A\\u066E\\u066F\\u0678-\\u0687\\u069A-\\u06BF\\u06C1\\u06C2\\u06CC\\u06CE\\u06D0\\u06D1\\u06FA-\\u06FC\\u06FF\\u0712-\\u0714\\u071A-\\u071D\\u071F-\\u0727\\u0729\\u072B\\u072D\\u072E\\u074E-\\u0758\\u075C-\\u076A\\u076D-\\u0770\\u0772\\u0775-\\u0777\\u077A-\\u077F\\u07CA-\\u07EA\\u07FA\\u0841-\\u0845\\u0848\\u084A-\\u0853\\u0855\\u0860\\u0862-\\u0865\\u0868\\u0883-\\u0886\\u0889-\\u088D\\u08A0-\\u08A9\\u08AF\\u08B0\\u08B3-\\u08B8\\u08BA-\\u08C8\\u1807\\u180A\\u1820-\\u1878\\u1887-\\u18A8\\u18AA\\u200D\\uA840-\\uA871\\u{10AC0}-\\u{10AC4}\\u{10AD3}-\\u{10AD6}\\u{10AD8}-\\u{10ADC}\\u{10ADE}-\\u{10AE0}\\u{10AEB}-\\u{10AEE}\\u{10B80}\\u{10B82}\\u{10B86}-\\u{10B88}\\u{10B8A}\\u{10B8B}\\u{10B8D}\\u{10B90}\\u{10BAD}\\u{10BAE}\\u{10D01}-\\u{10D21}\\u{10D23}\\u{10EC3}\\u{10EC4}\\u{10F30}-\\u{10F32}\\u{10F34}-\\u{10F44}\\u{10F51}-\\u{10F53}\\u{10F70}-\\u{10F73}\\u{10F76}-\\u{10F81}\\u{10FB0}\\u{10FB2}\\u{10FB3}\\u{10FB8}\\u{10FBB}\\u{10FBC}\\u{10FBE}\\u{10FBF}\\u{10FC1}\\u{10FC4}\\u{10FCA}\\u{1E900}-\\u{1E943}]\\p{Mn}*$/u;\n    const zwj = checkJoiningType.test(text.slice(0, viewIndex)) ? \"\\u200D\" : \"\";\n    textNode.replaceData(\n      viewIndex,\n      text.length - viewIndex,\n      !nodeContext.breakWord\n        ? zwj + resolveHyphenateCharacter(nodeContext)\n        : \"\",\n    );\n    if (zwj) {\n      const p = nodeContext.preprocessedTextContent[0][1] as string;\n      nodeContext.preprocessedTextContent[0][1] =\n        p.slice(0, viewIndex + 1) + zwj + p.slice(viewIndex + 1);\n    }\n    return viewIndex + 1;\n  }\n\n  breakAfterOtherCharacter(\n    textNode: Text,\n    text: string,\n    viewIndex: number,\n    nodeContext: Vtree.NodeContext,\n  ): number {\n    // keep the trailing character (it may be a space or not)\n    const ch0 = text.charAt(viewIndex);\n    viewIndex++;\n    const ch1 = text.charAt(viewIndex);\n\n    // If automatic hyphen was inserted here, add a real hyphen.\n    textNode.replaceData(\n      viewIndex,\n      text.length - viewIndex,\n      !nodeContext.breakWord && Base.isLetter(ch0) && Base.isLetter(ch1)\n        ? resolveHyphenateCharacter(nodeContext)\n        : \"\",\n    );\n    return viewIndex;\n  }\n\n  updateNodeContext(\n    nodeContext: Vtree.NodeContext,\n    viewIndex: number,\n    textNode: Text,\n  ): Vtree.NodeContext {\n    nodeContext = nodeContext.modify();\n    nodeContext.offsetInNode += viewIndex;\n    nodeContext.breakBefore = null;\n    return nodeContext;\n  }\n\n  static instance: TextNodeBreaker;\n}\nTextNodeBreaker.instance = new TextNodeBreaker();\n\nexport function resolveHyphenateCharacter(\n  nodeContext: Vtree.NodeContext,\n): string {\n  return (\n    nodeContext.hyphenateCharacter ||\n    (nodeContext.parent && nodeContext.parent.hyphenateCharacter) ||\n    \"-\"\n  );\n}\n\nexport class ColumnLayoutRetryer extends LayoutRetryers.AbstractLayoutRetryer {\n  breakAfter: string | null;\n  private initialPageBreakType: string | null = null;\n  initialComputedBlockSize: number = 0;\n  private initialOverflown: boolean = false;\n  context: { overflownNodeContext: Vtree.NodeContext } = {\n    overflownNodeContext: null,\n  };\n\n  constructor(\n    public readonly leadingEdge: boolean,\n    breakAfter?: string | null,\n  ) {\n    super();\n    this.breakAfter = breakAfter || null;\n  }\n\n  override resolveLayoutMode(\n    nodeContext: Vtree.NodeContext,\n  ): Layout.LayoutMode {\n    return new DefaultLayoutMode(\n      this.leadingEdge,\n      this.breakAfter,\n      this.context,\n    );\n  }\n\n  override prepareLayout(\n    nodeContext: Vtree.NodeContext,\n    column: Layout.Column,\n  ) {\n    column.fragmentLayoutConstraints = [];\n    if (!column.pseudoParent) {\n      Shared.clearRepetitiveElementsCache();\n    }\n  }\n\n  override clearNodes(initialPosition: Vtree.NodeContext) {\n    super.clearNodes(initialPosition);\n    let nodeContext = initialPosition;\n    while (nodeContext) {\n      const viewNode = nodeContext.viewNode;\n      if (viewNode) {\n        LayoutHelper.removeFollowingSiblings(viewNode.parentNode, viewNode);\n      }\n      nodeContext = nodeContext.parent;\n    }\n  }\n\n  override saveState(nodeContext: Vtree.NodeContext, column: Layout.Column) {\n    super.saveState(nodeContext, column);\n    this.initialPageBreakType = column.pageBreakType;\n    this.initialComputedBlockSize = column.computedBlockSize;\n    this.initialOverflown = column.overflown;\n  }\n\n  override restoreState(nodeContext: Vtree.NodeContext, column: Layout.Column) {\n    super.restoreState(nodeContext, column);\n    column.pageBreakType = this.initialPageBreakType;\n    column.computedBlockSize = this.initialComputedBlockSize;\n    column.overflown = this.initialOverflown;\n  }\n}\n\nexport class DefaultLayoutMode implements Layout.LayoutMode {\n  constructor(\n    public readonly leadingEdge: boolean,\n    public readonly breakAfter: string | null,\n    public readonly context: { overflownNodeContext: Vtree.NodeContext },\n  ) {}\n\n  /** @override */\n  doLayout(\n    nodeContext: Vtree.NodeContext,\n    column: Layout.Column,\n  ): Task.Result<Vtree.NodeContext> {\n    const frame: Task.Frame<Vtree.NodeContext> = Task.newFrame(\n      \"DefaultLayoutMode.doLayout\",\n    );\n\n    processAfterIfContinuesOfAncestors(nodeContext, column).then(() => {\n      column\n        .doLayout(nodeContext, this.leadingEdge, this.breakAfter)\n        .then((result) => {\n          this.context.overflownNodeContext = result.overflownNodeContext;\n          frame.finish(result.nodeContext);\n        });\n    });\n    return frame.result();\n  }\n\n  /** @override */\n  accept(nodeContext: Vtree.NodeContext, column: Layout.Column): boolean {\n    if (column.pageFloatLayoutContext.isInvalidated() || column.pageBreakType) {\n      return true;\n    }\n    if (column.fragmentLayoutConstraints.length <= 0) {\n      return true;\n    }\n    return column.fragmentLayoutConstraints.every((constraint) =>\n      constraint.allowLayout(\n        nodeContext,\n        this.context.overflownNodeContext,\n        column,\n      ),\n    );\n  }\n\n  /** @override */\n  postLayout(\n    positionAfter: Vtree.NodeContext,\n    initialPosition: Vtree.NodeContext,\n    column: Layout.Column,\n    accepted: boolean,\n  ): boolean {\n    if (!accepted) {\n      const hasNextCandidate = column.fragmentLayoutConstraints.some(\n        (constraint) => constraint.nextCandidate(positionAfter),\n      );\n\n      // If there is no next candidate, we accept the current layout trial.\n      // Later Column#doFinishBreak decides whether the overflowing content\n      // should be placed as is or be deferred to the next column,\n      // depending on the value of Column#forceNonfitting.\n      accepted = !hasNextCandidate;\n    }\n    column.fragmentLayoutConstraints.forEach((constraint) => {\n      constraint.postLayout(accepted, positionAfter, initialPosition, column);\n    });\n    return accepted;\n  }\n}\n\nexport class PageFloatArea extends Column implements Layout.PageFloatArea {\n  private rootViewNodes: Element[] = [];\n  private floatMargins: GeometryUtil.Insets[] = [];\n  adjustContentRelativeSize: boolean = true;\n\n  constructor(\n    public readonly floatSide: string,\n    element: HTMLElement,\n    layoutContext: Vtree.LayoutContext,\n    clientLayout: Vtree.ClientLayout,\n    layoutConstraint: LayoutConstraint,\n    pageFloatLayoutContext: PageFloats.PageFloatLayoutContext,\n    public readonly parentContainer: Vtree.Container,\n  ) {\n    super(\n      element,\n      layoutContext,\n      clientLayout,\n      layoutConstraint,\n      pageFloatLayoutContext,\n    );\n  }\n\n  override openAllViews(\n    position: Vtree.NodePosition,\n  ): Task.Result<Vtree.NodeContext> {\n    return super.openAllViews(position).thenAsync((nodeContext) => {\n      if (nodeContext) {\n        this.fixFloatSizeAndPosition(nodeContext);\n      }\n      return Task.newResult(nodeContext);\n    });\n  }\n\n  convertPercentageSizesToPx(target: Element) {\n    const containingBlockRect = this.parentContainer.getPaddingRect();\n    const refWidth = containingBlockRect.x2 - containingBlockRect.x1;\n    const refHeight = containingBlockRect.y2 - containingBlockRect.y1;\n\n    function convertPercentageToPx(props: string[], refValue: number) {\n      props.forEach((propName) => {\n        const valueString = Base.getCSSProperty(target, propName);\n        if (valueString && valueString.charAt(valueString.length - 1) === \"%\") {\n          const percentageValue = parseFloat(valueString);\n          const value = (refValue * percentageValue) / 100;\n          Base.setCSSProperty(target, propName, `${value}px`);\n        }\n      });\n    }\n    convertPercentageToPx([\"width\", \"max-width\", \"min-width\"], refWidth);\n    convertPercentageToPx([\"height\", \"max-height\", \"min-height\"], refHeight);\n    convertPercentageToPx(\n      [\n        \"margin-top\",\n        \"margin-right\",\n        \"margin-bottom\",\n        \"margin-left\",\n        \"padding-top\",\n        \"padding-right\",\n        \"padding-bottom\",\n        \"padding-left\",\n      ],\n      this.vertical ? refHeight : refWidth,\n    );\n    [\"margin-top\", \"margin-right\", \"margin-bottom\", \"margin-left\"].forEach(\n      (propName) => {\n        const value = Base.getCSSProperty(target, propName);\n        if (value === \"auto\") {\n          Base.setCSSProperty(target, propName, \"0\");\n        }\n      },\n    );\n  }\n\n  fixFloatSizeAndPosition(nodeContext: Vtree.NodeContext) {\n    while (nodeContext.parent) {\n      nodeContext = nodeContext.parent;\n    }\n    Asserts.assert(nodeContext.viewNode.nodeType === 1);\n    const rootViewNode = nodeContext.viewNode as Element;\n    this.rootViewNodes.push(rootViewNode);\n    if (this.adjustContentRelativeSize) {\n      this.convertPercentageSizesToPx(rootViewNode);\n    }\n    this.floatMargins.push(this.getComputedMargin(rootViewNode));\n    if (this.adjustContentRelativeSize) {\n      const floatSide = this.floatSide;\n      const isVertical = this.parentContainer.vertical;\n      if (isVertical) {\n        if (floatSide === \"block-end\" || floatSide === \"left\") {\n          const height = Base.getCSSProperty(rootViewNode, \"height\");\n          if (height !== \"\" && height !== \"auto\") {\n            Base.setCSSProperty(rootViewNode, \"margin-top\", \"auto\");\n          }\n        }\n      } else {\n        if (floatSide === \"block-end\" || floatSide === \"bottom\") {\n          const width = Base.getCSSProperty(rootViewNode, \"width\");\n          if (width !== \"\" && width !== \"auto\") {\n            Base.setCSSProperty(rootViewNode, \"margin-left\", \"auto\");\n          }\n        }\n      }\n    }\n  }\n\n  getContentInlineSize(): number {\n    return Math.max.apply(\n      null,\n      this.rootViewNodes.map((r, i) => {\n        const box = LayoutHelper.getElementClientRectAdjusted(\n          this.clientLayout,\n          r,\n          this.vertical,\n        );\n        const margin = this.floatMargins[i];\n        return this.vertical\n          ? margin.top + box.height + margin.bottom\n          : margin.left + box.width + margin.right;\n      }),\n    );\n  }\n}\n", "/**\n * Copyright 2016 Daishinsha Inc.\n * Copyright 2019 Vivliostyle Foundation\n *\n * Vivliostyle.js is free software: you can redistribute it and/or modify\n * it under the terms of the GNU Affero General Public License as published by\n * the Free Software Foundation, either version 3 of the License, or\n * (at your option) any later version.\n *\n * Vivliostyle.js is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n * GNU Affero General Public License for more details.\n *\n * You should have received a copy of the GNU Affero General Public License\n * along with Vivliostyle.js.  If not, see <http://www.gnu.org/licenses/>.\n *\n * @fileoverview RepetitiveElement - Elements repeated in every fragment\n * by repeat-on-break property.\n */\nimport * as Asserts from \"./asserts\";\nimport * as LayoutHelper from \"./layout-helper\";\nimport * as LayoutProcessor from \"./layout-processor\";\nimport * as LayoutRetryers from \"./layout-retryers\";\nimport * as LayoutUtil from \"./layout-util\";\nimport * as Plugin from \"./plugin\";\nimport * as Shared from \"./shared\";\nimport * as Task from \"./task\";\nimport * as VtreeImpl from \"./vtree\";\nimport * as Layout from \"./layout\";\nimport {\n  FormattingContextType,\n  FragmentLayoutConstraintType,\n  Layout as LayoutType,\n  RepetitiveElement,\n  Table,\n  Vtree,\n} from \"./types\";\n\nexport class RepetitiveElementsOwnerFormattingContext\n  implements RepetitiveElement.RepetitiveElementsOwnerFormattingContext\n{\n  formattingContextType: FormattingContextType = \"RepetitiveElementsOwner\";\n  isRoot: boolean = false;\n  repetitiveElements: RepetitiveElement.RepetitiveElements = null;\n\n  constructor(\n    public readonly parent: Vtree.FormattingContext,\n    public readonly rootSourceNode: Element,\n  ) {}\n\n  /** @override */\n  getName(): string {\n    return \"Repetitive elements owner formatting context (RepetitiveElementsOwnerFormattingContext)\";\n  }\n\n  /** @override */\n  isFirstTime(nodeContext: Vtree.NodeContext, firstTime: boolean): boolean {\n    return firstTime;\n  }\n\n  /** @override */\n  getParent(): Vtree.FormattingContext {\n    return this.parent;\n  }\n\n  getRepetitiveElements(): RepetitiveElement.RepetitiveElements {\n    return this.repetitiveElements;\n  }\n\n  getRootViewNode(position: Vtree.NodeContext): Element | null {\n    const root = this.getRootNodeContext(position);\n    return root ? (root.viewNode as Element) : null;\n  }\n\n  getRootNodeContext(nodeContext: Vtree.NodeContext): Vtree.NodeContext | null {\n    do {\n      if (\n        !nodeContext.belongsTo(this) &&\n        nodeContext.sourceNode === this.rootSourceNode\n      ) {\n        return nodeContext;\n      }\n    } while ((nodeContext = nodeContext.parent));\n    return null;\n  }\n\n  initializeRepetitiveElements(vertical: boolean) {\n    if (this.repetitiveElements) {\n      return;\n    }\n    const found = Shared.repetitiveElementsCache.some((entry) => {\n      if (entry.root === this.rootSourceNode) {\n        this.repetitiveElements = entry.elements;\n        return true;\n      }\n      return false;\n    });\n    if (!found) {\n      this.repetitiveElements = new RepetitiveElements(\n        vertical,\n        this.rootSourceNode,\n      );\n      Shared.repetitiveElementsCache.push({\n        root: this.rootSourceNode,\n        elements: this.repetitiveElements,\n      });\n    }\n  }\n\n  /** @override */\n  saveState(): any {}\n\n  /** @override */\n  restoreState(state: any) {}\n}\n\nexport type ElementsOffset = RepetitiveElement.ElementsOffset;\n\nexport class RepetitiveElements\n  implements RepetitiveElement.RepetitiveElements\n{\n  private headerSourceNode: Element | null = null;\n  private footerSourceNode: Element | null = null;\n  private headerViewNode: Element | null = null;\n  private footerViewNode: Element | null = null;\n  private headerNodePosition: Vtree.NodePosition | null = null;\n  private footerNodePosition: Vtree.NodePosition | null = null;\n  private headerHeight: number = 0;\n  private footerHeight: number = 0;\n  isSkipHeader: boolean = false;\n  isSkipFooter: boolean = false;\n  enableSkippingFooter: boolean = true;\n  enableSkippingHeader: boolean = true;\n  doneInitialLayout: boolean = false;\n  firstContentSourceNode: Element | null = null;\n  lastContentSourceNode: Element | null = null;\n  private affectedNodeCache: {\n    nodeContext: Vtree.NodeContext;\n    result: boolean;\n  }[] = [];\n  private afterLastContentNodeCache: {\n    nodeContext: Vtree.NodeContext;\n    result: boolean;\n  }[] = [];\n  allowInsert: boolean = false;\n  allowInsertRepeatitiveElements: boolean;\n\n  constructor(\n    private readonly vertical: boolean,\n    public ownerSourceNode: Element,\n  ) {}\n\n  setHeaderNodeContext(nodeContext: Vtree.NodeContext) {\n    if (this.headerNodePosition) {\n      return; // use first one.\n    }\n    this.headerNodePosition = VtreeImpl.newNodePositionFromNodeContext(\n      nodeContext,\n      0,\n    );\n    this.headerSourceNode = nodeContext.sourceNode as Element;\n    this.headerViewNode = nodeContext.viewNode as Element;\n  }\n\n  setFooterNodeContext(nodeContext: Vtree.NodeContext) {\n    if (this.footerNodePosition) {\n      return; // use first one.\n    }\n    this.footerNodePosition = VtreeImpl.newNodePositionFromNodeContext(\n      nodeContext,\n      0,\n    );\n    this.footerSourceNode = nodeContext.sourceNode as Element;\n    this.footerViewNode = nodeContext.viewNode as Element;\n  }\n\n  updateHeight(column: LayoutType.Column) {\n    if (this.headerViewNode) {\n      this.headerHeight = LayoutHelper.getElementHeight(\n        this.headerViewNode,\n        column,\n        this.vertical,\n      );\n      this.headerViewNode = null;\n    }\n    if (this.footerViewNode) {\n      this.footerHeight = LayoutHelper.getElementHeight(\n        this.footerViewNode,\n        column,\n        this.vertical,\n      );\n      this.footerViewNode = null;\n    }\n  }\n\n  prepareLayoutFragment() {\n    this.isSkipHeader = this.isSkipFooter = false;\n    this.enableSkippingFooter = true;\n    this.enableSkippingHeader = true;\n  }\n\n  appendHeaderToFragment(\n    rootNodeContext: Vtree.NodeContext,\n    firstChild: Node | null,\n    column: LayoutType.Column,\n  ): Task.Result<boolean> {\n    if (!this.headerNodePosition || this.isSkipHeader) {\n      return Task.newResult(true);\n    }\n    return this.appendElementToFragment(\n      this.headerNodePosition,\n      rootNodeContext,\n      firstChild,\n      column,\n    );\n  }\n\n  appendFooterToFragment(\n    rootNodeContext: Vtree.NodeContext,\n    firstChild: Node | null,\n    column: LayoutType.Column,\n  ): Task.Result<boolean> {\n    if (!this.footerNodePosition || this.isSkipFooter) {\n      return Task.newResult(true);\n    }\n    return this.appendElementToFragment(\n      this.footerNodePosition,\n      rootNodeContext,\n      firstChild,\n      column,\n    );\n  }\n\n  appendElementToFragment(\n    nodePosition: Vtree.NodePosition,\n    rootNodeContext: Vtree.NodeContext,\n    firstChild: Node | null,\n    column: LayoutType.Column,\n  ): Task.Result<boolean> {\n    const doc = rootNodeContext.viewNode.ownerDocument;\n    const rootViewNode = rootNodeContext.viewNode as Element;\n    const viewRoot = doc.createElement(\"div\");\n    rootViewNode.appendChild(viewRoot);\n    const pseudoColumn = new Layout.PseudoColumn(\n      column,\n      viewRoot,\n      rootNodeContext,\n    );\n    const initialPageBreakType = pseudoColumn.getColumn().pageBreakType;\n    pseudoColumn.getColumn().pageBreakType = null;\n    this.allowInsertRepeatitiveElements = true;\n    return pseudoColumn\n      .layout(new VtreeImpl.ChunkPosition(nodePosition), true)\n      .thenAsync(() => {\n        this.allowInsertRepeatitiveElements = false;\n        rootViewNode.removeChild(viewRoot);\n        this.moveChildren(viewRoot, rootViewNode, firstChild);\n        pseudoColumn.getColumn().pageBreakType = initialPageBreakType;\n        return Task.newResult(true);\n      });\n  }\n\n  moveChildren(from: Element, to: Element, firstChild: Node | null) {\n    if (!to) {\n      return;\n    }\n    while (from.firstChild) {\n      const child = from.firstChild;\n      from.removeChild(child);\n      (child as Element).setAttribute(LayoutHelper.SPECIAL_ATTR, \"1\");\n      if (firstChild) {\n        to.insertBefore(child, firstChild);\n      } else {\n        to.appendChild(child);\n      }\n    }\n  }\n\n  /** @override */\n  calculateOffset(nodeContext: Vtree.NodeContext): number {\n    let offset = 0;\n    if (nodeContext && !this.affectTo(nodeContext)) {\n      return offset;\n    }\n    if (\n      !this.isSkipFooter ||\n      (nodeContext && this.isAfterLastContent(nodeContext))\n    ) {\n      offset += this.footerHeight;\n    }\n    if (!this.isSkipHeader) {\n      offset += this.headerHeight;\n    }\n    return offset;\n  }\n\n  /** @override */\n  calculateMinimumOffset(nodeContext: Vtree.NodeContext): number {\n    let offset = 0;\n    if (nodeContext && !this.affectTo(nodeContext)) {\n      return offset;\n    }\n    if (\n      !this.enableSkippingFooter &&\n      nodeContext &&\n      this.isAfterLastContent(nodeContext)\n    ) {\n      offset += this.footerHeight;\n    }\n    if (!this.enableSkippingHeader) {\n      offset += this.headerHeight;\n    }\n    return offset;\n  }\n\n  isAfterLastContent(nodeContext: Vtree.NodeContext): boolean {\n    return this.findResultFromCache(\n      nodeContext,\n      this.afterLastContentNodeCache,\n      (nc) =>\n        this.isAfterNodeContextOf(\n          this.lastContentSourceNode as Element,\n          nodeContext,\n          false,\n        ),\n    );\n  }\n\n  private affectTo(nodeContext: Vtree.NodeContext): boolean {\n    return this.findResultFromCache(nodeContext, this.affectedNodeCache, (nc) =>\n      this.isAfterNodeContextOf(this.ownerSourceNode, nodeContext, true),\n    );\n  }\n\n  private findResultFromCache(\n    nodeContext: Vtree.NodeContext,\n    cache: { nodeContext: Vtree.NodeContext; result: boolean }[],\n    calculator: (p1: Vtree.NodeContext) => boolean,\n  ): boolean {\n    const cacheEntry = cache.filter(\n      (cache) =>\n        cache.nodeContext.sourceNode === nodeContext.sourceNode &&\n        cache.nodeContext.after === nodeContext.after,\n    );\n    if (cacheEntry.length > 0) {\n      return cacheEntry[0].result;\n    } else {\n      const result = calculator(nodeContext);\n      cache.push({ nodeContext, result });\n      return result;\n    }\n  }\n\n  private isAfterNodeContextOf(\n    node: Element,\n    nodeContext: Vtree.NodeContext,\n    includeChildren: boolean,\n  ): boolean {\n    const parentsOfNode = [];\n    for (let n: Node | null = node; n; n = n.parentNode) {\n      if (nodeContext.sourceNode === n) {\n        return nodeContext.after;\n      } else {\n        parentsOfNode.push(n);\n      }\n    }\n    for (\n      let currentParent: Node | null = nodeContext.sourceNode;\n      currentParent;\n      currentParent = currentParent.parentNode\n    ) {\n      const index = parentsOfNode.indexOf(currentParent);\n      if (index >= 0) {\n        return includeChildren ? index === 0 : false;\n      } else {\n        for (\n          let current: Element | null = currentParent as Element;\n          current;\n          current = current.previousElementSibling\n        ) {\n          if (parentsOfNode.includes(current)) {\n            return true;\n          }\n        }\n      }\n    }\n    return nodeContext.after;\n  }\n\n  isFirstContentNode(nodeContext: Vtree.NodeContext): boolean {\n    return (\n      nodeContext && this.firstContentSourceNode === nodeContext.sourceNode\n    );\n  }\n\n  isEnableToUpdateState(): boolean {\n    if (\n      (!this.isSkipFooter &&\n        this.enableSkippingFooter &&\n        this.footerNodePosition) ||\n      (!this.isSkipHeader &&\n        this.enableSkippingHeader &&\n        this.headerNodePosition)\n    ) {\n      return true;\n    } else {\n      return false;\n    }\n  }\n\n  updateState() {\n    if (\n      !this.isSkipFooter &&\n      this.enableSkippingFooter &&\n      this.footerNodePosition\n    ) {\n      this.isSkipFooter = true;\n    } else if (\n      !this.isSkipHeader &&\n      this.enableSkippingHeader &&\n      this.headerNodePosition\n    ) {\n      this.isSkipHeader = true;\n    }\n  }\n\n  preventSkippingHeader() {\n    this.isSkipHeader = false;\n    this.enableSkippingHeader = false;\n  }\n\n  preventSkippingFooter() {\n    this.isSkipFooter = false;\n    this.enableSkippingFooter = false;\n  }\n\n  isHeaderRegistered(): boolean {\n    return !!this.headerNodePosition;\n  }\n\n  isFooterRegistered(): boolean {\n    return !!this.footerNodePosition;\n  }\n\n  isHeaderSourceNode(node: Node): boolean {\n    return this.headerSourceNode === node;\n  }\n\n  isFooterSourceNode(node: Node): boolean {\n    return this.footerSourceNode === node;\n  }\n}\n\n/**\n * @abstract\n */\nexport abstract class LayoutEntireBlock implements LayoutType.LayoutMode {\n  constructor(\n    public formattingContext: RepetitiveElement.RepetitiveElementsOwnerFormattingContext,\n  ) {}\n\n  /** @override */\n  abstract doLayout(\n    nodeContext: Vtree.NodeContext,\n    column: LayoutType.Column,\n  ): Task.Result<Vtree.NodeContext>;\n\n  /** @override */\n  accept(nodeContext: Vtree.NodeContext, column: LayoutType.Column): boolean {\n    return !!nodeContext;\n  }\n\n  /** @override */\n  postLayout(\n    positionAfter: Vtree.NodeContext,\n    initialPosition: Vtree.NodeContext,\n    column: LayoutType.Column,\n    accepted: boolean,\n  ): boolean {\n    const repetitiveElements = this.formattingContext.getRepetitiveElements();\n    if (repetitiveElements) {\n      Asserts.assert(column.clientLayout);\n      if (!repetitiveElements.doneInitialLayout) {\n        repetitiveElements.updateHeight(column);\n        repetitiveElements.doneInitialLayout = true;\n      }\n    }\n    return accepted;\n  }\n}\n\n/**\n * @abstract\n */\nexport abstract class LayoutFragmentedBlock implements LayoutType.LayoutMode {\n  constructor(\n    public formattingContext: RepetitiveElement.RepetitiveElementsOwnerFormattingContext,\n  ) {}\n\n  /** @override */\n  abstract doLayout(\n    nodeContext: Vtree.NodeContext,\n    column: LayoutType.Column,\n  ): Task.Result<Vtree.NodeContext>;\n\n  /** @override */\n  accept(nodeContext: Vtree.NodeContext, column: LayoutType.Column): boolean {\n    return true;\n  }\n\n  /** @override */\n  postLayout(\n    positionAfter: Vtree.NodeContext,\n    initialPosition: Vtree.NodeContext,\n    column: LayoutType.Column,\n    accepted: boolean,\n  ): boolean {\n    return accepted;\n  }\n}\n\nexport class LayoutEntireOwnerBlock extends LayoutEntireBlock {\n  constructor(\n    formattingContext: RepetitiveElement.RepetitiveElementsOwnerFormattingContext,\n    public readonly processor: RepetitiveElementsOwnerLayoutProcessor,\n  ) {\n    super(formattingContext);\n  }\n\n  override doLayout(\n    nodeContext: Vtree.NodeContext,\n    column: LayoutType.Column,\n  ): Task.Result<Vtree.NodeContext> {\n    // FIXME: LayoutEntireBlock.prototype.doLayout is undefined because it's abstract method.\n    //        Probably, removing this call is ok.\n    // LayoutEntireBlock.prototype.doLayout.call(this, nodeContext, column);\n    return this.processor.doInitialLayout(nodeContext, column);\n  }\n\n  override accept(\n    nodeContext: Vtree.NodeContext,\n    column: LayoutType.Column,\n  ): boolean {\n    return false;\n  }\n}\n\nexport class LayoutFragmentedOwnerBlock extends LayoutFragmentedBlock {\n  constructor(\n    formattingContext: RepetitiveElement.RepetitiveElementsOwnerFormattingContext,\n    public readonly processor: RepetitiveElementsOwnerLayoutProcessor,\n  ) {\n    super(formattingContext);\n  }\n\n  override doLayout(\n    nodeContext: Vtree.NodeContext,\n    column: LayoutType.Column,\n  ): Task.Result<Vtree.NodeContext> {\n    if (!nodeContext.belongsTo(this.formattingContext) && !nodeContext.after) {\n      column.fragmentLayoutConstraints.unshift(\n        new RepetitiveElementsOwnerLayoutConstraint(nodeContext),\n      );\n    }\n    return this.processor.doLayout(nodeContext, column);\n  }\n}\n\nexport class RepetitiveElementsOwnerLayoutConstraint\n  implements RepetitiveElement.RepetitiveElementsOwnerLayoutConstraint\n{\n  flagmentLayoutConstraintType: FragmentLayoutConstraintType =\n    \"RepetitiveElementsOwner\";\n  nodeContext: Vtree.NodeContext;\n\n  constructor(nodeContext: Vtree.NodeContext) {\n    const formattingContext = getRepetitiveElementsOwnerFormattingContext(\n      nodeContext.formattingContext,\n    );\n    this.nodeContext = formattingContext.getRootNodeContext(nodeContext);\n  }\n\n  /** @override */\n  allowLayout(\n    nodeContext: Vtree.NodeContext,\n    overflownNodeContext: Vtree.NodeContext,\n    column: LayoutType.Column,\n  ): boolean {\n    const repetitiveElements = this.getRepetitiveElements();\n    if (!repetitiveElements) {\n      return true;\n    }\n    if (LayoutHelper.isOrphan(this.nodeContext.viewNode)) {\n      return true;\n    }\n    if (!repetitiveElements.isEnableToUpdateState()) {\n      return true;\n    }\n    if (\n      (overflownNodeContext && !nodeContext) ||\n      (nodeContext && nodeContext.overflow)\n    ) {\n      return false;\n    } else {\n      return true;\n    }\n  }\n\n  /** @override */\n  nextCandidate(nodeContext: Vtree.NodeContext): boolean {\n    const repetitiveElements = this.getRepetitiveElements();\n    if (!repetitiveElements) {\n      return false;\n    }\n    if (repetitiveElements.isEnableToUpdateState()) {\n      repetitiveElements.updateState();\n      return true;\n    } else {\n      return false;\n    }\n  }\n\n  /** @override */\n  postLayout(\n    allowed: boolean,\n    positionAfter: Vtree.NodeContext,\n    initialPosition: Vtree.NodeContext,\n    column: LayoutType.Column,\n  ) {\n    const repetitiveElements = this.getRepetitiveElements();\n    if (!repetitiveElements) {\n      return;\n    }\n    if (allowed) {\n      if (column.stopAtOverflow) {\n        if (\n          positionAfter == null ||\n          repetitiveElements.isAfterLastContent(positionAfter)\n        ) {\n          repetitiveElements.preventSkippingFooter();\n        }\n      }\n    }\n  }\n\n  /** @override */\n  finishBreak(\n    nodeContext: Vtree.NodeContext,\n    column: LayoutType.Column,\n  ): Task.Result<boolean> {\n    const formattingContext = getRepetitiveElementsOwnerFormattingContext(\n      this.nodeContext.formattingContext,\n    );\n    const repetitiveElements = this.getRepetitiveElements();\n    if (!repetitiveElements) {\n      return Task.newResult(true);\n    }\n    const rootNodeContext = this.nodeContext;\n    return appendHeader(formattingContext, rootNodeContext, column).thenAsync(\n      () =>\n        appendFooter(formattingContext, rootNodeContext, column).thenAsync(\n          () => {\n            repetitiveElements.prepareLayoutFragment();\n            return Task.newResult(true);\n          },\n        ),\n    );\n  }\n\n  getRepetitiveElements(): RepetitiveElement.RepetitiveElements {\n    const formattingContext = getRepetitiveElementsOwnerFormattingContext(\n      this.nodeContext.formattingContext,\n    );\n    return formattingContext.getRepetitiveElements();\n  }\n\n  /** @override */\n  equalsTo(constraint: LayoutType.FragmentLayoutConstraint): boolean {\n    if (!(constraint instanceof RepetitiveElementsOwnerLayoutConstraint)) {\n      return false;\n    }\n    return (\n      getRepetitiveElementsOwnerFormattingContext(\n        this.nodeContext.formattingContext,\n      ) ===\n      getRepetitiveElementsOwnerFormattingContext(\n        constraint.nodeContext.formattingContext,\n      )\n    );\n  }\n\n  /** @override */\n  getPriorityOfFinishBreak(): number {\n    return 10;\n  }\n}\n\nexport class RepetitiveElementsOwnerLayoutRetryer extends LayoutRetryers.AbstractLayoutRetryer {\n  constructor(\n    public readonly formattingContext: RepetitiveElement.RepetitiveElementsOwnerFormattingContext,\n    private readonly processor: RepetitiveElementsOwnerLayoutProcessor,\n  ) {\n    super();\n  }\n\n  override resolveLayoutMode(\n    nodeContext: Vtree.NodeContext,\n  ): LayoutType.LayoutMode {\n    const repetitiveElements = this.formattingContext.getRepetitiveElements();\n    if (\n      !nodeContext.belongsTo(this.formattingContext) &&\n      !repetitiveElements.doneInitialLayout\n    ) {\n      return new LayoutEntireOwnerBlock(this.formattingContext, this.processor);\n    } else {\n      if (\n        !nodeContext.belongsTo(this.formattingContext) &&\n        !nodeContext.after\n      ) {\n        if (repetitiveElements) {\n          repetitiveElements.preventSkippingHeader();\n        }\n      }\n      return new LayoutFragmentedOwnerBlock(\n        this.formattingContext,\n        this.processor,\n      );\n    }\n  }\n}\n\nexport class EntireBlockLayoutStrategy extends LayoutUtil.EdgeSkipper {\n  constructor(\n    public readonly formattingContext: RepetitiveElement.RepetitiveElementsOwnerFormattingContext,\n    public readonly column: LayoutType.Column,\n  ) {\n    super();\n  }\n\n  override startNonInlineElementNode(\n    state: LayoutUtil.LayoutIteratorState,\n  ): void | Task.Result<boolean> {\n    const formattingContext = this.formattingContext;\n    const nodeContext = state.nodeContext;\n    const repetitiveElements = formattingContext.getRepetitiveElements();\n    if (\n      nodeContext.parent &&\n      formattingContext.rootSourceNode === nodeContext.parent.sourceNode\n    ) {\n      switch (nodeContext.repeatOnBreak) {\n        case \"header\":\n          if (!repetitiveElements.isHeaderRegistered()) {\n            repetitiveElements.setHeaderNodeContext(nodeContext);\n            return Task.newResult(true);\n          } else {\n            nodeContext.repeatOnBreak = \"none\";\n          }\n          break;\n        case \"footer\":\n          if (!repetitiveElements.isFooterRegistered()) {\n            repetitiveElements.setFooterNodeContext(nodeContext);\n            return Task.newResult(true);\n          } else {\n            nodeContext.repeatOnBreak = \"none\";\n          }\n          break;\n      }\n      if (!repetitiveElements.firstContentSourceNode) {\n        repetitiveElements.firstContentSourceNode =\n          nodeContext.sourceNode as Element;\n      }\n    }\n    return LayoutUtil.EdgeSkipper.prototype.startNonInlineElementNode.call(\n      this,\n      state,\n    );\n  }\n\n  override afterNonInlineElementNode(\n    state: LayoutUtil.LayoutIteratorState,\n  ): void | Task.Result<boolean> {\n    const formattingContext = this.formattingContext;\n    const nodeContext = state.nodeContext;\n    if (nodeContext.sourceNode === formattingContext.rootSourceNode) {\n      formattingContext.getRepetitiveElements().lastContentSourceNode =\n        state.lastAfterNodeContext &&\n        (state.lastAfterNodeContext.sourceNode as Element);\n      state.break = true;\n    }\n    if (\n      nodeContext.repeatOnBreak === \"header\" ||\n      nodeContext.repeatOnBreak === \"footer\"\n    ) {\n      return Task.newResult(true);\n    } else {\n      return LayoutUtil.EdgeSkipper.prototype.afterNonInlineElementNode.call(\n        this,\n        state,\n      );\n    }\n  }\n}\n\nexport class FragmentedBlockLayoutStrategy extends LayoutUtil.EdgeSkipper {\n  constructor(\n    public readonly formattingContext: RepetitiveElementsOwnerFormattingContext,\n    public readonly column: LayoutType.Column,\n  ) {\n    super();\n  }\n}\n\nexport class RepetitiveElementsOwnerLayoutProcessor\n  extends LayoutProcessor.BlockLayoutProcessor\n  implements LayoutProcessor.LayoutProcessor\n{\n  layout(\n    nodeContext: Vtree.NodeContext,\n    column: LayoutType.Column,\n    leadingEdge: boolean,\n  ): Task.Result<Vtree.NodeContext> {\n    if (column.isFloatNodeContext(nodeContext)) {\n      return column.layoutFloatOrFootnote(nodeContext);\n    }\n    const formattingContext = getRepetitiveElementsOwnerFormattingContext(\n      nodeContext.formattingContext,\n    );\n    const rootViewNode = formattingContext.getRootViewNode(nodeContext);\n    if (!rootViewNode) {\n      return column.buildDeepElementView(nodeContext);\n    } else {\n      if (leadingEdge) {\n        appendHeaderToAncestors(nodeContext.parent, column);\n      }\n      if (!nodeContext.belongsTo(formattingContext)) {\n        return new RepetitiveElementsOwnerLayoutRetryer(\n          formattingContext,\n          this,\n        ).layout(nodeContext, column);\n      } else {\n        return LayoutProcessor.BlockLayoutProcessor.prototype.layout.call(\n          this,\n          nodeContext,\n          column,\n          leadingEdge,\n        );\n      }\n    }\n  }\n\n  startNonInlineElementNode(nodeContext: Vtree.NodeContext): boolean {\n    const formattingContext =\n      getRepetitiveElementsOwnerFormattingContextOrNull(nodeContext);\n    const repetitiveElements = formattingContext.getRepetitiveElements();\n    if (!repetitiveElements) {\n      return false;\n    }\n    if (\n      !repetitiveElements.allowInsertRepeatitiveElements &&\n      (repetitiveElements.isHeaderSourceNode(nodeContext.sourceNode) ||\n        repetitiveElements.isFooterSourceNode(nodeContext.sourceNode))\n    ) {\n      nodeContext.viewNode.parentNode.removeChild(nodeContext.viewNode);\n    }\n    return false;\n  }\n\n  doInitialLayout(\n    nodeContext: Vtree.NodeContext,\n    column: LayoutType.Column,\n  ): Task.Result<Vtree.NodeContext> {\n    const formattingContext = getRepetitiveElementsOwnerFormattingContext(\n      nodeContext.formattingContext,\n    );\n    const frame = Task.newFrame<Vtree.NodeContext>(\n      \"BlockLayoutProcessor.doInitialLayout\",\n    );\n    this.layoutEntireBlock(nodeContext, column).thenFinish(frame);\n    return frame.result();\n  }\n\n  private layoutEntireBlock(\n    nodeContext: Vtree.NodeContext,\n    column: LayoutType.Column,\n  ): Task.Result<Vtree.NodeContext> {\n    const formattingContext = getRepetitiveElementsOwnerFormattingContext(\n      nodeContext.formattingContext,\n    );\n    const strategy = new EntireBlockLayoutStrategy(formattingContext, column);\n    const iterator = new LayoutUtil.LayoutIterator(\n      strategy,\n      column.layoutContext,\n    );\n    return iterator.iterate(nodeContext);\n  }\n\n  doLayout(\n    nodeContext: Vtree.NodeContext,\n    column: LayoutType.Column,\n  ): Task.Result<Vtree.NodeContext> {\n    const formattingContext = getRepetitiveElementsOwnerFormattingContext(\n      nodeContext.formattingContext,\n    );\n    const frame: Task.Frame<Vtree.NodeContext> = Task.newFrame(\"doLayout\");\n    const cont = column.layoutContext.nextInTree(nodeContext, false);\n    Layout.processAfterIfContinues(cont, column).then((resNodeContext) => {\n      let nextNodeContext = resNodeContext;\n      frame\n        .loopWithFrame((loopFrame) => {\n          while (nextNodeContext) {\n            let pending = true;\n            column\n              .layoutNext(nextNodeContext, false)\n              .then((nodeContextParam) => {\n                nextNodeContext = nodeContextParam;\n                if (column.pageFloatLayoutContext.isInvalidated()) {\n                  loopFrame.breakLoop();\n                } else if (column.pageBreakType) {\n                  loopFrame.breakLoop(); // Loop end\n                } else if (\n                  nextNodeContext &&\n                  column.stopByOverflow(nextNodeContext)\n                ) {\n                  loopFrame.breakLoop(); // Loop end\n                } else if (\n                  nextNodeContext &&\n                  nextNodeContext.after &&\n                  nextNodeContext.sourceNode == formattingContext.rootSourceNode\n                ) {\n                  loopFrame.breakLoop(); // Loop end\n                } else {\n                  if (pending) {\n                    // Sync case\n                    pending = false;\n                  } else {\n                    // Async case\n                    loopFrame.continueLoop();\n                  }\n                }\n              });\n            if (pending) {\n              // Async case and loop end\n              pending = false;\n              return;\n            }\n          }\n\n          // Sync case\n          loopFrame.breakLoop();\n        })\n        .then(() => {\n          frame.finish(nextNodeContext);\n        });\n    });\n    return frame.result();\n  }\n\n  override finishBreak(\n    column: LayoutType.Column,\n    nodeContext: Vtree.NodeContext,\n    forceRemoveSelf: boolean,\n    endOfColumn: boolean,\n  ): Task.Result<boolean> | null {\n    return LayoutProcessor.BlockLayoutProcessor.prototype.finishBreak.call(\n      this,\n      column,\n      nodeContext,\n      forceRemoveSelf,\n      endOfColumn,\n    );\n  }\n\n  override clearOverflownViewNodes(\n    column: LayoutType.Column,\n    parentNodeContext: Vtree.NodeContext,\n    nodeContext: Vtree.NodeContext,\n    removeSelf: boolean,\n  ) {\n    LayoutProcessor.BlockLayoutProcessor.prototype.clearOverflownViewNodes(\n      column,\n      parentNodeContext,\n      nodeContext,\n      removeSelf,\n    );\n  }\n}\n\nfunction eachAncestorNodeContext(\n  nodeContext: Vtree.NodeContext,\n  callback: (\n    p1: RepetitiveElementsOwnerFormattingContext,\n    p2: Vtree.NodeContext,\n  ) => any,\n): void {\n  for (let nc = nodeContext; nc; nc = nc.parent) {\n    const formattingContext = nc.formattingContext;\n    if (\n      formattingContext &&\n      formattingContext instanceof RepetitiveElementsOwnerFormattingContext &&\n      !nc.belongsTo(formattingContext)\n    ) {\n      callback(formattingContext, nc);\n    }\n  }\n}\n\nexport function appendHeaderToAncestors(\n  nodeContext: Vtree.NodeContext,\n  column: LayoutType.Column,\n): void {\n  if (!nodeContext) {\n    return;\n  }\n  eachAncestorNodeContext(\n    nodeContext.after ? nodeContext.parent : nodeContext,\n    (formattingContext, nc) => {\n      if (Table.isInstanceOfTableFormattingContext(formattingContext)) {\n        return;\n      }\n      column.fragmentLayoutConstraints.push(\n        new RepetitiveElementsOwnerLayoutConstraint(nc),\n      );\n    },\n  );\n}\n\nexport function appendHeader(\n  formattingContext: RepetitiveElement.RepetitiveElementsOwnerFormattingContext,\n  nodeContext: Vtree.NodeContext,\n  column: LayoutType.Column,\n): Task.Result<boolean> {\n  const repetitiveElements = formattingContext.getRepetitiveElements();\n  if (repetitiveElements) {\n    const rootNodeContext = formattingContext.getRootNodeContext(nodeContext);\n    if (rootNodeContext.viewNode) {\n      const firstChild = rootNodeContext.viewNode.firstChild;\n      return repetitiveElements.appendHeaderToFragment(\n        rootNodeContext,\n        firstChild,\n        column,\n      );\n    }\n  }\n  return Task.newResult(true);\n}\n\nexport function appendFooter(\n  formattingContext: RepetitiveElement.RepetitiveElementsOwnerFormattingContext,\n  nodeContext: Vtree.NodeContext,\n  column: LayoutType.Column,\n): Task.Result<boolean> {\n  const repetitiveElements = formattingContext.getRepetitiveElements();\n  if (repetitiveElements) {\n    if (!repetitiveElements.isSkipFooter) {\n      const rootNodeContext = formattingContext.getRootNodeContext(nodeContext);\n      if (rootNodeContext.viewNode) {\n        return repetitiveElements.appendFooterToFragment(\n          rootNodeContext,\n          null,\n          column,\n        );\n      }\n    }\n  }\n  return Task.newResult(true);\n}\n\nfunction getRepetitiveElementsOwnerFormattingContextOrNull(\n  nodeContext: Vtree.NodeContext,\n): RepetitiveElement.RepetitiveElementsOwnerFormattingContext | null {\n  const formattingContext = nodeContext.formattingContext;\n  if (!formattingContext) {\n    return null;\n  }\n  if (\n    !(formattingContext instanceof RepetitiveElementsOwnerFormattingContext)\n  ) {\n    return null;\n  }\n  return formattingContext;\n}\n\nfunction getRepetitiveElementsOwnerFormattingContext(\n  formattingContext: Vtree.FormattingContext,\n): RepetitiveElement.RepetitiveElementsOwnerFormattingContext {\n  Asserts.assert(\n    formattingContext instanceof RepetitiveElementsOwnerFormattingContext,\n  );\n  return formattingContext as RepetitiveElement.RepetitiveElementsOwnerFormattingContext;\n}\n\nconst repetitiveLayoutProcessor = new RepetitiveElementsOwnerLayoutProcessor();\n\nPlugin.registerHook(\n  Plugin.HOOKS.RESOLVE_LAYOUT_PROCESSOR,\n  (formattingContext) => {\n    if (\n      formattingContext instanceof RepetitiveElementsOwnerFormattingContext &&\n      !Table.isInstanceOfTableFormattingContext(formattingContext)\n    ) {\n      return repetitiveLayoutProcessor;\n    }\n    return null;\n  },\n);\n", "/**\n * Copyright 2016 Daishinsha Inc.\n * Copyright 2019 Vivliostyle Foundation\n *\n * Vivliostyle.js is free software: you can redistribute it and/or modify\n * it under the terms of the GNU Affero General Public License as published by\n * the Free Software Foundation, either version 3 of the License, or\n * (at your option) any later version.\n *\n * Vivliostyle.js is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n * GNU Affero General Public License for more details.\n *\n * You should have received a copy of the GNU Affero General Public License\n * along with Vivliostyle.js.  If not, see <http://www.gnu.org/licenses/>.\n *\n * @fileoverview Table - Table formatting context and layout.\n */\nimport * as Asserts from \"./asserts\";\nimport * as Base from \"./base\";\nimport * as BreakPosition from \"./break-position\";\nimport * as Css from \"./css\";\nimport * as LayoutHelper from \"./layout-helper\";\nimport * as LayoutProcessor from \"./layout-processor\";\nimport * as LayoutRetryers from \"./layout-retryers\";\nimport * as LayoutUtil from \"./layout-util\";\nimport * as Plugin from \"./plugin\";\nimport * as RepetitiveElementImpl from \"./repetitive-element\";\nimport * as Task from \"./task\";\nimport * as Vgen from \"./vgen\";\nimport * as VtreeImpl from \"./vtree\";\nimport * as Layout from \"./layout\";\nimport {\n  FormattingContextType,\n  FragmentLayoutConstraintType,\n  Layout as LayoutType,\n  RepetitiveElement,\n  Table,\n  Vtree,\n} from \"./types\";\n\nexport class TableRow {\n  cells: TableCell[] = [];\n\n  constructor(\n    public readonly rowIndex: number,\n    public readonly sourceNode: Node,\n  ) {}\n\n  addCell(cell: TableCell) {\n    this.cells.push(cell);\n  }\n\n  getMinimumHeight(): number {\n    return Math.min.apply(\n      null,\n      this.cells.map((c) => c.height),\n    );\n  }\n}\n\nexport class TableCell {\n  viewElement: Element | null;\n  colSpan: number;\n  rowSpan: number;\n  height: number = 0;\n  anchorSlot: TableSlot = null;\n\n  constructor(\n    public readonly rowIndex: number,\n    public readonly columnIndex: number,\n    viewElement: Element,\n  ) {\n    this.viewElement = viewElement;\n    this.colSpan = (viewElement as HTMLTableCellElement).colSpan || 1;\n    this.rowSpan = (viewElement as HTMLTableCellElement).rowSpan || 1;\n  }\n\n  setHeight(height: number) {\n    this.height = height;\n  }\n\n  setAnchorSlot(slot: TableSlot) {\n    this.anchorSlot = slot;\n  }\n}\n\nexport class TableSlot {\n  constructor(\n    public readonly rowIndex: number,\n    public readonly columnIndex: number,\n    public readonly cell: TableCell,\n  ) {}\n}\n\nexport class TableCellFragment {\n  pseudoColumn: Layout.PseudoColumn;\n  empty: boolean = false;\n\n  constructor(\n    public readonly column: Layout.Column,\n    pseudoColumnContainer: HTMLElement,\n    public readonly cellNodeContext: Vtree.NodeContext,\n  ) {\n    this.pseudoColumn = new Layout.PseudoColumn(\n      column,\n      pseudoColumnContainer,\n      cellNodeContext,\n    );\n  }\n\n  findAcceptableBreakPosition(): Layout.BreakPositionAndNodeContext {\n    const element = this.cellNodeContext.viewNode as HTMLElement;\n    const { verticalAlign, alignContent } = element.style;\n    if (verticalAlign !== \"top\" && verticalAlign !== \"baseline\") {\n      Base.setCSSProperty(element, \"vertical-align\", \"top\");\n    }\n    if (alignContent && alignContent !== \"normal\") {\n      Base.setCSSProperty(element, \"align-content\", \"normal\");\n    }\n    const bp = this.pseudoColumn.findAcceptableBreakPosition(true);\n    Base.setCSSProperty(element, \"vertical-align\", verticalAlign);\n    if (alignContent && alignContent !== \"normal\") {\n      Base.setCSSProperty(element, \"align-content\", alignContent);\n    }\n    return bp;\n  }\n}\n\nexport class TableCaptionView {\n  constructor(\n    public readonly viewNode: Element,\n    public readonly side: string,\n  ) {}\n}\n\nexport class BetweenTableRowBreakPosition extends BreakPosition.EdgeBreakPosition {\n  private formattingContext: TableFormattingContext;\n\n  acceptableCellBreakPositions: Layout.BreakPositionAndNodeContext[] = null;\n  private rowIndex: number | null = null;\n\n  constructor(\n    position: Vtree.NodeContext,\n    breakOnEdge: string | null,\n    overflows: boolean,\n    columnBlockSize: number,\n  ) {\n    super(position, breakOnEdge, overflows, columnBlockSize);\n    this.formattingContext =\n      position.formattingContext as TableFormattingContext;\n  }\n\n  override findAcceptableBreak(\n    column: Layout.Column,\n    penalty: number,\n  ): Vtree.NodeContext {\n    const breakNodeContext = super.findAcceptableBreak(column, penalty);\n    if (penalty < this.getMinBreakPenalty()) {\n      return null;\n    }\n    const allCellsBreakable = this.getAcceptableCellBreakPositions().every(\n      (bp) => !!bp.nodeContext,\n    );\n    if (allCellsBreakable) {\n      return breakNodeContext;\n    } else {\n      return null;\n    }\n  }\n\n  override getMinBreakPenalty(): number {\n    let penalty = super.getMinBreakPenalty();\n    this.getAcceptableCellBreakPositions().forEach((bp) => {\n      penalty += bp.breakPosition.getMinBreakPenalty();\n    });\n    const cellFragments = this.getCellFragments();\n    penalty += Math.max(\n      0,\n      ...cellFragments.map((cf) => cf.cellNodeContext.breakPenalty),\n    );\n    return penalty;\n  }\n\n  getAcceptableCellBreakPositions(): Layout.BreakPositionAndNodeContext[] {\n    if (!this.acceptableCellBreakPositions) {\n      const formattingContext = this.formattingContext;\n      const cellFragments = this.getCellFragments();\n      this.acceptableCellBreakPositions = cellFragments.map((cellFragment) =>\n        cellFragment.findAcceptableBreakPosition(),\n      );\n    }\n    return this.acceptableCellBreakPositions;\n  }\n\n  private getRowIndex(): number {\n    if (this.rowIndex != null) {\n      return this.rowIndex;\n    }\n    return (this.rowIndex = this.formattingContext.findRowIndexBySourceNode(\n      this.position.sourceNode,\n    ));\n  }\n\n  private getCellFragments() {\n    return this.formattingContext\n      .getRowSpanningCellsOverflowingTheRow(this.getRowIndex())\n      .map(\n        this.formattingContext.getCellFragmentOfCell,\n        this.formattingContext,\n      );\n  }\n}\n\nexport class InsideTableRowBreakPosition extends BreakPosition.AbstractBreakPosition {\n  acceptableCellBreakPositions: Layout.BreakPositionAndNodeContext[] = null;\n\n  constructor(\n    public readonly rowIndex: number,\n    public readonly beforeNodeContext: Vtree.NodeContext,\n    public readonly formattingContext: TableFormattingContext,\n  ) {\n    super();\n  }\n\n  override findAcceptableBreak(\n    column: Layout.Column,\n    penalty: number,\n  ): Vtree.NodeContext {\n    if (\n      this !== column.breakPositions[0] && // Fix for issue #1458, case 2\n      penalty < this.getMinBreakPenalty()\n    ) {\n      return null;\n    }\n    const cellFragments = this.getCellFragments();\n    const acceptableCellBreakPositions = this.getAcceptableCellBreakPositions();\n    const allCellsBreakable =\n      acceptableCellBreakPositions.every((bp) => !!bp.nodeContext) &&\n      acceptableCellBreakPositions.some((bp, index) => {\n        const pseudoColumn = cellFragments[index].pseudoColumn;\n        const nodeContext = bp.nodeContext;\n        return (\n          !pseudoColumn.isStartNodeContext(nodeContext) &&\n          !pseudoColumn.isLastAfterNodeContext(nodeContext)\n        );\n      });\n    this.beforeNodeContext.overflow = acceptableCellBreakPositions.some(\n      (bp) => bp.nodeContext && bp.nodeContext.overflow,\n    );\n    if (allCellsBreakable) {\n      return this.beforeNodeContext;\n    } else {\n      return null;\n    }\n  }\n\n  override getMinBreakPenalty(): number {\n    const formattingContext = this.formattingContext;\n    const row = formattingContext.getRowByIndex(this.rowIndex);\n    let penalty = this.beforeNodeContext.breakPenalty;\n\n    const breakPositions = this.getAcceptableCellBreakPositions();\n    const cellFragments = this.getCellFragments();\n    penalty += Math.max(\n      0,\n      ...cellFragments.map((cf) => cf.cellNodeContext.breakPenalty),\n    );\n\n    // If there is a box break in a row-spanning cell, do not add penalty.\n    // This is to prevent the cell content from disappearing due to the situation\n    // that a box break occurs in a row-spanning cell but the row break fails.\n    // (Issue #1403)\n    const foundBoxBreakInRowSpanningCell = breakPositions.some(\n      (bp, i) =>\n        bp.breakPosition instanceof Layout.BoxBreakPosition &&\n        (cellFragments[i].cellNodeContext.sourceNode as HTMLTableCellElement)\n          .rowSpan > 1,\n    );\n\n    breakPositions.forEach((bp, i) => {\n      let penalty1 = bp.breakPosition.getMinBreakPenalty();\n      if (\n        foundBoxBreakInRowSpanningCell &&\n        bp.breakPosition instanceof BreakPosition.EdgeBreakPosition &&\n        bp.breakPosition.overflows &&\n        penalty1 >= 3\n      ) {\n        // When a box break occurs in a row-spanning cell, the height of the row group decreases,\n        // and the overflows flag that was set before the box break may be no longer valid.\n        // So,check the overflow again, and if the cell does not overflow, reduce the penalty.\n        // (Issue #1403)\n        const overflows = cellFragments[i].column.checkOverflowAndSaveEdge(\n          bp.nodeContext,\n          null,\n        );\n        if (!overflows) {\n          penalty1 -= 3;\n        }\n      }\n      penalty += penalty1;\n    });\n    return penalty;\n  }\n\n  getAcceptableCellBreakPositions(): Layout.BreakPositionAndNodeContext[] {\n    if (!this.acceptableCellBreakPositions) {\n      const cellFragments = this.getCellFragments();\n      this.acceptableCellBreakPositions = cellFragments.map((cellFragment) =>\n        cellFragment.findAcceptableBreakPosition(),\n      );\n    }\n    return this.acceptableCellBreakPositions;\n  }\n\n  private getCellFragments() {\n    return this.formattingContext\n      .getCellsFallingOnRow(this.rowIndex)\n      .map(\n        this.formattingContext.getCellFragmentOfCell,\n        this.formattingContext,\n      );\n  }\n}\n\nexport type BrokenTableCellPosition = {\n  cellNodePosition: Vtree.NodePosition;\n  breakChunkPosition: Vtree.ChunkPosition;\n  cell: TableCell;\n};\n\n/**\n * @param tableSourceNode Source node of the table\n */\nexport class TableFormattingContext\n  extends RepetitiveElementImpl.RepetitiveElementsOwnerFormattingContext\n  implements Table.TableFormattingContext\n{\n  formattingContextType: FormattingContextType = \"Table\";\n  vertical: boolean = false;\n  columnCount: number = -1;\n  tableWidth: number = 0;\n  captions: TableCaptionView[] = [];\n  colGroups: DocumentFragment | null = null;\n  colWidths: number[] | null = null;\n  inlineBorderSpacing: number = 0;\n  rows: TableRow[] = [];\n  slots: TableSlot[][] = [];\n  cellFragments: TableCellFragment[][] = [];\n  lastRowViewNode: Element | null = null;\n  cellBreakPositions: BrokenTableCellPosition[] = [];\n  repetitiveElements: RepetitiveElement.RepetitiveElements | null = null;\n\n  constructor(\n    parent: Vtree.FormattingContext,\n    public readonly tableSourceNode: Element,\n  ) {\n    super(parent, tableSourceNode);\n  }\n\n  override getName(): string {\n    return \"Table formatting context (Table.TableFormattingContext)\";\n  }\n\n  override isFirstTime(\n    nodeContext: Vtree.NodeContext,\n    firstTime: boolean,\n  ): boolean {\n    if (!firstTime) {\n      return firstTime;\n    }\n    switch (nodeContext.display) {\n      case \"table-row\":\n        return this.cellBreakPositions.length === 0;\n      case \"table-cell\":\n        return !this.cellBreakPositions.some(\n          (p) => p.cellNodePosition.steps[0].node === nodeContext.sourceNode,\n        );\n      default:\n        return firstTime;\n    }\n  }\n\n  override getParent(): Vtree.FormattingContext {\n    return this.parent;\n  }\n\n  finishFragment() {\n    this.cellFragments = [];\n  }\n\n  addRow(rowIndex: number, row: TableRow) {\n    this.rows[rowIndex] = row;\n  }\n\n  getRowSlots(rowIndex: number): TableSlot[] {\n    let rowSlots = this.slots[rowIndex];\n    if (!rowSlots) {\n      rowSlots = this.slots[rowIndex] = [];\n    }\n    return rowSlots;\n  }\n\n  addCell(rowIndex: number, cell: TableCell) {\n    let row = this.rows[rowIndex];\n    if (!row) {\n      this.addRow(rowIndex, new TableRow(rowIndex, null));\n      row = this.rows[rowIndex];\n    }\n    Asserts.assert(row);\n    row.addCell(cell);\n    const rowUpper = rowIndex + cell.rowSpan;\n    let rowSlots = this.getRowSlots(rowIndex);\n    let startColIndex = 0;\n    while (rowSlots[startColIndex]) {\n      startColIndex++;\n    }\n    for (; rowIndex < rowUpper; rowIndex++) {\n      rowSlots = this.getRowSlots(rowIndex);\n      for (let i = startColIndex; i < startColIndex + cell.colSpan; i++) {\n        const slot = (rowSlots[i] = new TableSlot(rowIndex, i, cell));\n        if (!cell.anchorSlot) {\n          cell.setAnchorSlot(slot);\n        }\n      }\n    }\n  }\n\n  getRowByIndex(index: number): TableRow {\n    const row = this.rows[index];\n    Asserts.assert(row);\n    return row;\n  }\n\n  findRowIndexBySourceNode(sourceNode: Node): number {\n    return this.rows.findIndex((row) => sourceNode === row.sourceNode);\n  }\n\n  addCellFragment(\n    rowIndex: number,\n    columnIndex: number,\n    cellFragment: TableCellFragment,\n  ) {\n    let list = this.cellFragments[rowIndex];\n    if (!list) {\n      list = this.cellFragments[rowIndex] = [];\n    }\n    list[columnIndex] = cellFragment;\n  }\n\n  getCellsFallingOnRow(rowIndex: number): TableCell[] {\n    const rowSlots = this.getRowSlots(rowIndex);\n    return rowSlots.reduce((uniqueCells, slot) => {\n      if (slot.cell !== uniqueCells[uniqueCells.length - 1]) {\n        return uniqueCells.concat(slot.cell);\n      } else {\n        return uniqueCells;\n      }\n    }, []);\n  }\n\n  getRowSpanningCellsOverflowingTheRow(rowIndex: number): TableCell[] {\n    return this.getCellsFallingOnRow(rowIndex).filter(\n      (cell) => cell.rowIndex + cell.rowSpan - 1 > rowIndex,\n    );\n  }\n\n  getCellFragmentOfCell(cell: TableCell): TableCellFragment {\n    return (\n      this.cellFragments[cell.rowIndex] &&\n      this.cellFragments[cell.rowIndex][cell.columnIndex]\n    );\n  }\n\n  getColumnCount(): number {\n    if (this.columnCount < 0) {\n      this.columnCount = Math.max.apply(\n        null,\n        this.rows.map((row) =>\n          row.cells.reduce((sum, c) => sum + c.colSpan, 0),\n        ),\n      );\n    }\n    return this.columnCount;\n  }\n\n  updateCellSizes(clientLayout: Vtree.ClientLayout) {\n    this.rows.forEach((row) => {\n      row.cells.forEach((cell) => {\n        const rect = LayoutHelper.getElementClientRectAdjusted(\n          clientLayout,\n          cell.viewElement as Element,\n          this.vertical,\n        );\n        cell.viewElement = null;\n        cell.setHeight(this.vertical ? rect[\"width\"] : rect[\"height\"]);\n      });\n    });\n  }\n\n  /**\n   * @return position\n   */\n  findCellFromColumn(\n    column: Layout.Column,\n  ): { rowIndex: number; columnIndex: number } | null {\n    if (!column) {\n      return null;\n    }\n    let tableCell: TableCell = null;\n    let row = 0;\n    let col = 0;\n    loop: for (row = 0; row < this.cellFragments.length; row++) {\n      if (!this.cellFragments[row]) {\n        continue;\n      }\n      for (col = 0; col < this.cellFragments[row].length; col++) {\n        if (!this.cellFragments[row][col]) {\n          continue;\n        }\n        if (column === this.cellFragments[row][col].pseudoColumn.getColumn()) {\n          tableCell = this.rows[row].cells[col];\n          break loop;\n        }\n      }\n    }\n    if (!tableCell) {\n      return null;\n    }\n    for (; row < this.slots.length; row++) {\n      for (; col < this.slots[row].length; col++) {\n        const slot = this.slots[row][col];\n        if (slot.cell === tableCell) {\n          return { rowIndex: slot.rowIndex, columnIndex: slot.columnIndex };\n        }\n      }\n    }\n    return null;\n  }\n\n  collectElementsOffsetOfUpperCells(\n    position: { rowIndex: number; columnIndex: number } | null,\n  ): RepetitiveElement.ElementsOffset[] {\n    const collected = [];\n    return this.slots.reduce((repetitiveElements, row, index) => {\n      if (index >= position.rowIndex) {\n        return repetitiveElements;\n      }\n      const cellFragment =\n        row[position.columnIndex] &&\n        this.getCellFragmentOfCell(row[position.columnIndex].cell);\n      if (!cellFragment || collected.includes(cellFragment)) {\n        return repetitiveElements;\n      }\n      this.collectElementsOffsetFromColumn(\n        cellFragment.pseudoColumn.getColumn(),\n        repetitiveElements,\n      );\n      collected.push(cellFragment);\n      return repetitiveElements;\n    }, [] as RepetitiveElement.ElementsOffset[]);\n  }\n\n  collectElementsOffsetOfHighestColumn(): RepetitiveElement.ElementsOffset[] {\n    const elementsInColumn = [];\n    this.rows.forEach((row) => {\n      row.cells.forEach((cell, index) => {\n        if (!elementsInColumn[index]) {\n          elementsInColumn[index] = { collected: [], elements: [] };\n        }\n        const state = elementsInColumn[index];\n        const cellFragment = this.getCellFragmentOfCell(cell);\n        if (!cellFragment || state.collected.includes(cellFragment)) {\n          return;\n        }\n        this.collectElementsOffsetFromColumn(\n          cellFragment.pseudoColumn.getColumn(),\n          state.elements,\n        );\n        state.collected.push(cellFragment);\n      });\n    });\n    return [\n      new ElementsOffsetOfTableCell(\n        elementsInColumn.map((entry) => entry.elements),\n      ),\n    ];\n  }\n\n  private collectElementsOffsetFromColumn(\n    column: LayoutType.Column,\n    repetitiveElements: RepetitiveElement.ElementsOffset[],\n  ) {\n    column.fragmentLayoutConstraints.forEach((constraint) => {\n      if (\n        RepetitiveElement.isInstanceOfRepetitiveElementsOwnerLayoutConstraint(\n          constraint,\n        )\n      ) {\n        const repetitiveElement = constraint.getRepetitiveElements();\n        repetitiveElements.push(repetitiveElement);\n      }\n      if (Table.isInstanceOfTableRowLayoutConstraint(constraint)) {\n        constraint\n          .getElementsOffsetsForTableCell(null)\n          .forEach((repetitiveElement) => {\n            repetitiveElements.push(repetitiveElement);\n          });\n      }\n    });\n  }\n\n  override saveState(): any {\n    return [].concat(this.cellBreakPositions);\n  }\n\n  override restoreState(state: any) {\n    this.cellBreakPositions = state as BrokenTableCellPosition[];\n  }\n}\n\nexport class ElementsOffsetOfTableCell\n  implements RepetitiveElement.ElementsOffset\n{\n  constructor(\n    public readonly repeatitiveElementsInColumns: RepetitiveElement.ElementsOffset[][],\n  ) {}\n\n  /** @override */\n  calculateOffset(nodeContext: Vtree.NodeContext): number {\n    return this.calculateMaxOffsetOfColumn(\n      nodeContext,\n      (offsets) => offsets.current,\n    );\n  }\n\n  /** @override */\n  calculateMinimumOffset(nodeContext: Vtree.NodeContext): number {\n    return this.calculateMaxOffsetOfColumn(\n      nodeContext,\n      (offsets) => offsets.minimum,\n    );\n  }\n\n  private calculateMaxOffsetOfColumn(nodeContext, resolver) {\n    let maxOffset = 0;\n    this.repeatitiveElementsInColumns.forEach((repetitiveElements) => {\n      const offsets = BreakPosition.calculateOffset(\n        nodeContext,\n        repetitiveElements,\n      );\n      maxOffset = Math.max(maxOffset, resolver(offsets));\n    });\n    return maxOffset;\n  }\n}\n\nfunction getTableFormattingContext(\n  formattingContext: Vtree.FormattingContext,\n): TableFormattingContext {\n  Asserts.assert(formattingContext instanceof TableFormattingContext);\n  return formattingContext as TableFormattingContext;\n}\n\nfunction isTableRowGrouping(display: string | null): boolean {\n  return (\n    display === \"table-row-group\" ||\n    display === \"table-header-group\" ||\n    display === \"table-footer-group\"\n  );\n}\n\nfunction isTableRoot(display: string | null): boolean {\n  return display === \"table\" || display === \"inline-table\";\n}\n\nfunction isValidParentOfTableRow(display: string | null): boolean {\n  return isTableRowGrouping(display) || isTableRoot(display);\n}\n\nfunction skipNestedTable(\n  state: LayoutUtil.LayoutIteratorState,\n  formattingContext: TableFormattingContext,\n  column: Layout.Column,\n): Task.Result<boolean> | null {\n  const nodeContext = state.nodeContext;\n  const display = nodeContext.display;\n  const parentDisplay = nodeContext.parent ? nodeContext.parent.display : null;\n\n  // Is inline-table nested in another table?\n  let isNestedInlineTable = false;\n  if (\n    parentDisplay === \"inline-table\" &&\n    !(nodeContext.formattingContext instanceof TableFormattingContext)\n  ) {\n    for (let nc = nodeContext.parent; nc; nc = nc.parent) {\n      if (nc.formattingContext instanceof TableFormattingContext) {\n        isNestedInlineTable = nc.formattingContext === formattingContext;\n        break;\n      }\n    }\n  }\n  const isNestedTable =\n    isNestedInlineTable ||\n    (display === \"table-row\" && !isValidParentOfTableRow(parentDisplay)) ||\n    (display === \"table-cell\" &&\n      parentDisplay !== \"table-row\" &&\n      !isValidParentOfTableRow(parentDisplay)) ||\n    (nodeContext.formattingContext instanceof TableFormattingContext &&\n      nodeContext.formattingContext !== formattingContext);\n  if (isNestedTable) {\n    return column\n      .buildDeepElementView(nodeContext)\n      .thenAsync((nodeContextAfter) => {\n        state.nodeContext = nodeContextAfter;\n        return Task.newResult(true);\n      });\n  } else {\n    return null;\n  }\n}\n\nexport class EntireTableLayoutStrategy extends LayoutUtil.EdgeSkipper {\n  rowIndex: number = -1;\n  columnIndex: number = 0;\n  inRow: boolean = false;\n  checkPoints: Vtree.NodeContext[] = [];\n  inHeaderOrFooter: boolean = false;\n\n  constructor(\n    public readonly formattingContext: TableFormattingContext,\n    public readonly column: Layout.Column,\n  ) {\n    super();\n  }\n\n  override startNonInlineElementNode(\n    state: LayoutUtil.LayoutIteratorState,\n  ): void | Task.Result<boolean> {\n    const formattingContext = this.formattingContext;\n    const r = skipNestedTable(state, formattingContext, this.column);\n    if (r) {\n      return r;\n    }\n    this.postLayoutBlockContents(state);\n    const nodeContext = state.nodeContext;\n    const display = nodeContext.display;\n    const repetitiveElements = formattingContext.getRepetitiveElements();\n    switch (display) {\n      case \"table\":\n        formattingContext.inlineBorderSpacing = nodeContext.inlineBorderSpacing;\n        break;\n      case \"table-caption\": {\n        const captionView = new TableCaptionView(\n          nodeContext.viewNode as Element,\n          nodeContext.captionSide,\n        );\n        formattingContext.captions.push(captionView);\n        break;\n      }\n      case \"table-header-group\":\n        if (!repetitiveElements.isHeaderRegistered()) {\n          this.inHeaderOrFooter = true;\n          repetitiveElements.setHeaderNodeContext(nodeContext);\n        }\n        return Task.newResult(true);\n      case \"table-footer-group\":\n        if (!repetitiveElements.isFooterRegistered()) {\n          this.inHeaderOrFooter = true;\n          repetitiveElements.setFooterNodeContext(nodeContext);\n        }\n        return Task.newResult(true);\n      case \"table-row\":\n        if (!this.inHeaderOrFooter) {\n          this.inRow = true;\n          this.rowIndex++;\n          Asserts.assert(nodeContext.sourceNode);\n          this.columnIndex = 0;\n          formattingContext.addRow(\n            this.rowIndex,\n            new TableRow(this.rowIndex, nodeContext.sourceNode),\n          );\n          if (!repetitiveElements.firstContentSourceNode) {\n            repetitiveElements.firstContentSourceNode =\n              nodeContext.sourceNode as Element;\n          }\n        }\n        break;\n    }\n    return super.startNonInlineElementNode(state);\n  }\n\n  override afterNonInlineElementNode(\n    state: LayoutUtil.LayoutIteratorState,\n  ): void | Task.Result<boolean> {\n    const formattingContext = this.formattingContext;\n    const nodeContext = state.nodeContext;\n    const display = nodeContext.display;\n    const clientLayout = this.column.clientLayout;\n    this.postLayoutBlockContents(state);\n    if (nodeContext.sourceNode === formattingContext.tableSourceNode) {\n      const computedStyle = clientLayout.getElementComputedStyle(\n        formattingContext.getRootViewNode(nodeContext) as Element,\n      );\n      formattingContext.tableWidth = parseFloat(\n        computedStyle[formattingContext.vertical ? \"height\" : \"width\"],\n      );\n      formattingContext.getRepetitiveElements().lastContentSourceNode =\n        state.lastAfterNodeContext &&\n        (state.lastAfterNodeContext.sourceNode as Element);\n      state.break = true;\n    } else {\n      switch (display) {\n        case \"table-header-group\":\n        case \"table-footer-group\":\n          if (this.inHeaderOrFooter) {\n            this.inHeaderOrFooter = false;\n            return Task.newResult(true);\n          }\n          break;\n        case \"table-row\":\n          if (!this.inHeaderOrFooter) {\n            formattingContext.lastRowViewNode = nodeContext.viewNode as Element;\n            this.inRow = false;\n          }\n          break;\n        case \"table-cell\":\n          if (!this.inHeaderOrFooter) {\n            if (!this.inRow) {\n              this.rowIndex++;\n              this.columnIndex = 0;\n              this.inRow = true;\n            }\n            const elem = nodeContext.viewNode as Element;\n            formattingContext.addCell(\n              this.rowIndex,\n              new TableCell(this.rowIndex, this.columnIndex, elem),\n            );\n            this.columnIndex++;\n          }\n          break;\n      }\n    }\n    return super.afterNonInlineElementNode(state);\n  }\n\n  override startNonElementNode(\n    state: LayoutUtil.LayoutIteratorState,\n  ): void | Task.Result<boolean> {\n    this.registerCheckPoint(state);\n  }\n\n  override afterNonElementNode(\n    state: LayoutUtil.LayoutIteratorState,\n  ): void | Task.Result<boolean> {\n    this.registerCheckPoint(state);\n  }\n\n  override startInlineElementNode(\n    state: LayoutUtil.LayoutIteratorState,\n  ): void | Task.Result<boolean> {\n    this.registerCheckPoint(state);\n  }\n\n  override afterInlineElementNode(\n    state: LayoutUtil.LayoutIteratorState,\n  ): void | Task.Result<boolean> {\n    this.registerCheckPoint(state);\n  }\n\n  registerCheckPoint(state: LayoutUtil.LayoutIteratorState) {\n    const nodeContext = state.nodeContext;\n    if (\n      nodeContext &&\n      nodeContext.viewNode &&\n      !LayoutHelper.isSpecialNodeContext(nodeContext)\n    ) {\n      this.checkPoints.push(nodeContext.clone());\n    }\n  }\n\n  postLayoutBlockContents(state: LayoutUtil.LayoutIteratorState) {\n    if (this.checkPoints.length > 0) {\n      this.column.postLayoutBlock(state.nodeContext, this.checkPoints);\n    }\n    this.checkPoints = [];\n  }\n}\n\nexport class TableLayoutStrategy extends LayoutUtil.EdgeSkipper {\n  private static ignoreList: { [key: string]: boolean } = {\n    \"table-caption\": true,\n    \"table-column-group\": true,\n    \"table-column\": true,\n  };\n  inRow: boolean = false;\n  currentRowIndex: number = -1;\n  currentColumnIndex: number = 0;\n  originalStopAtOverflow: boolean;\n  inHeader: boolean;\n  inFooter: boolean;\n\n  constructor(\n    public readonly formattingContext: TableFormattingContext,\n    public readonly column: Layout.Column,\n  ) {\n    super(true);\n    this.originalStopAtOverflow = column.stopAtOverflow;\n    column.stopAtOverflow = false;\n  }\n\n  resetColumn() {\n    this.column.stopAtOverflow = this.originalStopAtOverflow;\n  }\n\n  getColSpanningCellWidth(cell: TableCell): number {\n    const colWidths = this.formattingContext.colWidths;\n    Asserts.assert(colWidths);\n    let width = 0;\n    for (let i = 0; i < cell.colSpan; i++) {\n      width += colWidths[cell.anchorSlot.columnIndex + i];\n    }\n    width += this.formattingContext.inlineBorderSpacing * (cell.colSpan - 1);\n    return width;\n  }\n\n  layoutCell(\n    cell: TableCell,\n    cellNodeContext: Vtree.NodeContext,\n    startChunkPosition: Vtree.ChunkPosition,\n  ): Task.Result<boolean> {\n    const rowIndex = cell.rowIndex;\n    const columnIndex = cell.columnIndex;\n    const colSpan = cell.colSpan;\n    const cellViewNode = cellNodeContext.viewNode as Element;\n    const verticalAlign = cellNodeContext.verticalAlign;\n    if (colSpan > 1) {\n      Base.setCSSProperty(cellViewNode, \"box-sizing\", \"border-box\");\n      Base.setCSSProperty(\n        cellViewNode,\n        this.formattingContext.vertical ? \"height\" : \"width\",\n        `${this.getColSpanningCellWidth(cell)}px`,\n      );\n    }\n    const pseudoColumnContainer =\n      cellViewNode.ownerDocument.createElement(\"div\");\n    cellViewNode.appendChild(pseudoColumnContainer);\n    const cellFragment = new TableCellFragment(\n      this.column,\n      pseudoColumnContainer,\n      cellNodeContext,\n    );\n    this.formattingContext.addCellFragment(rowIndex, columnIndex, cellFragment);\n    if (\n      startChunkPosition.primary.steps.length === 1 &&\n      startChunkPosition.primary.after\n    ) {\n      // Contents of the cell have ended in the previous fragment\n      cellFragment.empty = true;\n    }\n    return cellFragment.pseudoColumn\n      .layout(startChunkPosition, true)\n      .thenReturn(true);\n  }\n\n  hasBrokenCellAtSlot(slotIndex): boolean {\n    const cellBreakPosition = this.formattingContext.cellBreakPositions[0];\n    if (cellBreakPosition) {\n      return cellBreakPosition.cell.anchorSlot.columnIndex === slotIndex;\n    }\n    return false;\n  }\n\n  private extractRowSpanningCellBreakPositions(): BrokenTableCellPosition[][] {\n    const cellBreakPositions = this.formattingContext.cellBreakPositions;\n    if (cellBreakPositions.length === 0) {\n      return [];\n    }\n    const rowSpanningCellBreakPositions = [];\n    let i = 0;\n    do {\n      const p = cellBreakPositions[i];\n      const rowIndex = p.cell.rowIndex;\n      if (rowIndex < this.currentRowIndex) {\n        let arr = rowSpanningCellBreakPositions[rowIndex];\n        if (!arr) {\n          arr = rowSpanningCellBreakPositions[rowIndex] = [];\n        }\n        arr.push(p);\n        cellBreakPositions.splice(i, 1);\n      } else {\n        i++;\n      }\n    } while (i < cellBreakPositions.length);\n    return rowSpanningCellBreakPositions;\n  }\n\n  layoutRowSpanningCellsFromPreviousFragment(\n    state: LayoutUtil.LayoutIteratorState,\n  ): Task.Result<boolean> {\n    const formattingContext = this.formattingContext;\n    const rowSpanningCellBreakPositions =\n      this.extractRowSpanningCellBreakPositions();\n    const rowCount = rowSpanningCellBreakPositions.reduce((s) => s + 1, 0);\n    if (rowCount === 0) {\n      return Task.newResult(true);\n    }\n    const layoutContext = this.column.layoutContext;\n    const currentRow = state.nodeContext;\n    currentRow.viewNode.parentNode.removeChild(currentRow.viewNode);\n    const frame = Task.newFrame<boolean>(\n      \"layoutRowSpanningCellsFromPreviousFragment\",\n    );\n    let cont = Task.newResult(true);\n    let spanningCellRowIndex = 0;\n    const occupiedSlotIndices = [];\n    rowSpanningCellBreakPositions.forEach((rowCellBreakPositions) => {\n      cont = cont.thenAsync(() => {\n        // Is it always correct to assume steps[1] to be the row?\n        const rowNodeContext = VtreeImpl.makeNodeContextFromNodePositionStep(\n          rowCellBreakPositions[0].cellNodePosition.steps[1],\n          currentRow.parent,\n        );\n        return layoutContext.setCurrent(rowNodeContext, false).thenAsync(() => {\n          let cont1 = Task.newResult(true);\n          let columnIndex = 0;\n\n          function addDummyCellUntil(upperColumnIndex) {\n            while (columnIndex < upperColumnIndex) {\n              if (!occupiedSlotIndices.includes(columnIndex)) {\n                const dummy =\n                  rowNodeContext.viewNode.ownerDocument.createElement(\"td\");\n                Base.setCSSProperty(dummy, \"padding\", \"0\");\n                rowNodeContext.viewNode.appendChild(dummy);\n              }\n              columnIndex++;\n            }\n          }\n          rowCellBreakPositions.forEach((cellBreakPosition) => {\n            cont1 = cont1.thenAsync(() => {\n              const cell = cellBreakPosition.cell;\n              addDummyCellUntil(cell.anchorSlot.columnIndex);\n              const cellNodePosition = cellBreakPosition.cellNodePosition;\n              const cellNodeContext =\n                VtreeImpl.makeNodeContextFromNodePositionStep(\n                  cellNodePosition.steps[0],\n                  rowNodeContext,\n                );\n              cellNodeContext.offsetInNode = cellNodePosition.offsetInNode;\n              cellNodeContext.after = cellNodePosition.after;\n              cellNodeContext.fragmentIndex =\n                cellNodePosition.steps[0].fragmentIndex + 1;\n              return layoutContext\n                .setCurrent(cellNodeContext, false)\n                .thenAsync(() => {\n                  const breakChunkPosition =\n                    cellBreakPosition.breakChunkPosition;\n                  for (let i = 0; i < cell.colSpan; i++) {\n                    occupiedSlotIndices.push(columnIndex + i);\n                  }\n                  columnIndex += cell.colSpan;\n                  return this.layoutCell(\n                    cell,\n                    cellNodeContext,\n                    breakChunkPosition,\n                  ).thenAsync(() => {\n                    (cellNodeContext.viewNode as HTMLTableCellElement).rowSpan =\n                      cell.rowIndex +\n                      cell.rowSpan -\n                      this.currentRowIndex +\n                      rowCount -\n                      spanningCellRowIndex;\n                    return Task.newResult(true);\n                  });\n                });\n            });\n          });\n          return cont1.thenAsync(() => {\n            addDummyCellUntil(formattingContext.getColumnCount());\n            spanningCellRowIndex++;\n            return Task.newResult(true);\n          });\n        });\n      });\n    });\n    cont.then(() => {\n      layoutContext\n        .setCurrent(currentRow, true, state.atUnforcedBreak)\n        .then(() => {\n          frame.finish(true);\n        });\n    });\n    return frame.result();\n  }\n\n  startTableRow(state: LayoutUtil.LayoutIteratorState): Task.Result<boolean> {\n    if (this.inHeader || this.inFooter) {\n      return Task.newResult(true);\n    }\n    const nodeContext = state.nodeContext;\n    const formattingContext = this.formattingContext;\n    if (this.currentRowIndex < 0) {\n      Asserts.assert(nodeContext.sourceNode);\n      this.currentRowIndex = formattingContext.findRowIndexBySourceNode(\n        nodeContext.sourceNode,\n      );\n    } else {\n      this.currentRowIndex++;\n    }\n    this.currentColumnIndex = 0;\n    this.inRow = true;\n    return this.layoutRowSpanningCellsFromPreviousFragment(state).thenAsync(\n      () => {\n        this.registerCellFragmentIndex();\n        const overflown = this.column.checkOverflowAndSaveEdgeAndBreakPosition(\n          state.lastAfterNodeContext,\n          null,\n          true,\n          state.breakAtTheEdge,\n        );\n        if (\n          overflown &&\n          formattingContext.getRowSpanningCellsOverflowingTheRow(\n            this.currentRowIndex - 1,\n          ).length === 0\n        ) {\n          this.resetColumn();\n          nodeContext.overflow = true;\n          state.break = true;\n        }\n        return Task.newResult(true);\n      },\n    );\n  }\n\n  private registerCellFragmentIndex() {\n    const cells = this.formattingContext.getRowByIndex(\n      this.currentRowIndex,\n    ).cells;\n    cells.forEach((cell) => {\n      const cellBreakPosition =\n        this.formattingContext.cellBreakPositions[cell.columnIndex];\n      if (\n        cellBreakPosition &&\n        cellBreakPosition.cell.anchorSlot.columnIndex ==\n          cell.anchorSlot.columnIndex\n      ) {\n        const tdNodeStep = cellBreakPosition.cellNodePosition.steps[0];\n        const offset = (\n          this.column.layoutContext as Vgen.ViewFactory\n        ).xmldoc.getElementOffset(tdNodeStep.node as Element);\n        Layout.registerFragmentIndex(offset, tdNodeStep.fragmentIndex + 1, 1);\n      }\n    });\n  }\n\n  startTableCell(state: LayoutUtil.LayoutIteratorState): Task.Result<boolean> {\n    if (this.inHeader || this.inFooter) {\n      return Task.newResult(true);\n    }\n    const nodeContext = state.nodeContext;\n    if (!this.inRow) {\n      if (this.currentRowIndex < 0) {\n        this.currentRowIndex = 0;\n      } else {\n        this.currentRowIndex++;\n      }\n      this.currentColumnIndex = 0;\n      this.inRow = true;\n    }\n    const cell = this.formattingContext.getRowByIndex(this.currentRowIndex)\n      .cells[this.currentColumnIndex];\n    if (!cell) {\n      // Fix for Issue #712\n      state.break = true;\n      return Task.newResult(true);\n    }\n    const afterNodeContext = nodeContext.copy().modify();\n    afterNodeContext.after = true;\n    state.nodeContext = afterNodeContext;\n    const frame = Task.newFrame<boolean>(\"startTableCell\");\n    let cont: Task.Result<Vtree.ChunkPosition>;\n    if (this.hasBrokenCellAtSlot(cell.anchorSlot.columnIndex)) {\n      const cellBreakPosition =\n        this.formattingContext.cellBreakPositions.shift();\n      nodeContext.fragmentIndex =\n        cellBreakPosition.cellNodePosition.steps[0].fragmentIndex + 1;\n      cont = Task.newResult(cellBreakPosition.breakChunkPosition);\n    } else {\n      cont = this.column\n        .nextInTree(nodeContext, state.atUnforcedBreak)\n        .thenAsync((nextNodeContext) => {\n          if (nextNodeContext.viewNode) {\n            nodeContext.viewNode.removeChild(nextNodeContext.viewNode);\n          }\n          const startNodePosition = VtreeImpl.newNodePositionFromNodeContext(\n            nextNodeContext,\n            0,\n          );\n          return Task.newResult(new VtreeImpl.ChunkPosition(startNodePosition));\n        });\n    }\n    cont.then((startChunkPosition) => {\n      Asserts.assert(nodeContext);\n      this.layoutCell(cell, nodeContext, startChunkPosition).then(() => {\n        this.afterNonInlineElementNode(state);\n        this.currentColumnIndex++;\n        frame.finish(true);\n      });\n    });\n    return frame.result();\n  }\n\n  startNonInlineBox(\n    state: LayoutUtil.LayoutIteratorState,\n  ): Task.Result<boolean> {\n    const r = skipNestedTable(\n      state,\n      getTableFormattingContext(this.formattingContext),\n      this.column,\n    );\n    if (r) {\n      return r;\n    }\n    const nodeContext = state.nodeContext;\n    const repetitiveElements = this.formattingContext.getRepetitiveElements();\n    const display = nodeContext.display;\n    if (\n      display === \"table-header-group\" &&\n      repetitiveElements &&\n      repetitiveElements.isHeaderSourceNode(nodeContext.sourceNode)\n    ) {\n      this.inHeader = true;\n      return Task.newResult(true);\n    } else if (\n      display === \"table-footer-group\" &&\n      repetitiveElements &&\n      repetitiveElements.isFooterSourceNode(nodeContext.sourceNode)\n    ) {\n      this.inFooter = true;\n      return Task.newResult(true);\n    } else if (display === \"table-row\") {\n      return this.startTableRow(state);\n    } else if (display === \"table-cell\") {\n      return this.startTableCell(state);\n    } else {\n      return Task.newResult(true);\n    }\n  }\n\n  endNonInlineBox(state: LayoutUtil.LayoutIteratorState): Task.Result<boolean> {\n    const nodeContext = state.nodeContext;\n    const display = nodeContext.display;\n    if (display === \"table-row\") {\n      this.inRow = false;\n      if (!this.inHeader && !this.inFooter) {\n        const beforeNodeContext = nodeContext.copy().modify();\n        beforeNodeContext.after = false;\n        const bp = new InsideTableRowBreakPosition(\n          this.currentRowIndex,\n          beforeNodeContext,\n          this.formattingContext,\n        );\n        this.column.breakPositions.push(bp);\n      }\n    }\n    return Task.newResult(true);\n  }\n\n  afterNonInlineElementNode(\n    state: LayoutUtil.LayoutIteratorState,\n  ): void | Task.Result<boolean> {\n    const nodeContext = state.nodeContext;\n    const repetitiveElements = this.formattingContext.getRepetitiveElements();\n    const display = nodeContext.display;\n    if (display === \"table-header-group\") {\n      if (\n        repetitiveElements &&\n        !repetitiveElements.allowInsertRepeatitiveElements &&\n        repetitiveElements.isHeaderSourceNode(nodeContext.sourceNode)\n      ) {\n        this.inHeader = false;\n        nodeContext.viewNode.parentNode.removeChild(nodeContext.viewNode);\n      } else {\n        Base.setCSSProperty(\n          nodeContext.viewNode as Element,\n          \"display\",\n          \"table-row-group\",\n        );\n      }\n    } else if (display === \"table-footer-group\") {\n      if (\n        repetitiveElements &&\n        !repetitiveElements.allowInsertRepeatitiveElements &&\n        repetitiveElements.isFooterSourceNode(nodeContext.sourceNode)\n      ) {\n        this.inFooter = false;\n        nodeContext.viewNode.parentNode.removeChild(nodeContext.viewNode);\n      } else {\n        Base.setCSSProperty(\n          nodeContext.viewNode as Element,\n          \"display\",\n          \"table-row-group\",\n        );\n      }\n    }\n    if (display && TableLayoutStrategy.ignoreList[display]) {\n      nodeContext.viewNode.parentNode.removeChild(nodeContext.viewNode);\n    } else if (\n      nodeContext.sourceNode === this.formattingContext.tableSourceNode\n    ) {\n      nodeContext.overflow = this.column.checkOverflowAndSaveEdge(\n        nodeContext,\n        null,\n      );\n      this.resetColumn();\n      state.break = true;\n    } else {\n      return super.afterNonInlineElementNode(state);\n    }\n    return Task.newResult(true);\n  }\n}\n\ntype TableLayoutOption = {\n  calculateBreakPositionsInside: boolean;\n};\nconst tableLayoutOptionCache: {\n  root: Node;\n  tableLayoutOption: TableLayoutOption;\n}[] = [];\n\nfunction getTableLayoutOption(\n  tableRootSourceNode: Node,\n): TableLayoutOption | null {\n  const i = tableLayoutOptionCache.findIndex(\n    (c) => c.root === tableRootSourceNode,\n  );\n  const pair = tableLayoutOptionCache[i];\n  return pair ? pair.tableLayoutOption : null;\n}\n\nfunction clearTableLayoutOptionCache(tableRootSourceNode: Node): void {\n  const i = tableLayoutOptionCache.findIndex(\n    (c) => c.root === tableRootSourceNode,\n  );\n  if (i >= 0) {\n    tableLayoutOptionCache.splice(i, 1);\n  }\n}\n\nexport class TableLayoutProcessor implements LayoutProcessor.LayoutProcessor {\n  private layoutEntireTable(\n    nodeContext: Vtree.NodeContext,\n    column: Layout.Column,\n  ): Task.Result<Vtree.NodeContext> {\n    const formattingContext = getTableFormattingContext(\n      nodeContext.formattingContext,\n    );\n    const strategy = new EntireTableLayoutStrategy(formattingContext, column);\n    const iterator = new LayoutUtil.LayoutIterator(\n      strategy,\n      column.layoutContext,\n    );\n    return iterator.iterate(nodeContext);\n  }\n\n  private getColumnWidths(\n    lastRow: Element,\n    columnCount: number,\n    vertical: boolean,\n    clientLayout: Vtree.ClientLayout,\n  ): number[] {\n    const doc = lastRow.ownerDocument;\n    const dummyRow = doc.createElement(\"tr\");\n    const dummyCells = [];\n    for (let i = 0; i < columnCount; i++) {\n      const cell = doc.createElement(\"td\");\n      dummyRow.appendChild(cell);\n      dummyCells.push(cell);\n    }\n    lastRow.parentNode.insertBefore(dummyRow, lastRow.nextSibling);\n    const colWidths = dummyCells.map((cell) => {\n      const rect = LayoutHelper.getElementClientRectAdjusted(\n        clientLayout,\n        cell,\n        vertical,\n      );\n      const width = vertical ? rect[\"height\"] : rect[\"width\"];\n      // Workaround for issue #958\n      // Non-integer width causes problem, so return rounded-up value.\n      return Math.ceil(width);\n    });\n    lastRow.parentNode.removeChild(dummyRow);\n    return colWidths;\n  }\n\n  private getColGroupElements(tableElement: Element): Element[] {\n    const colGroups = [];\n    let child = tableElement.firstElementChild;\n    while (child) {\n      if (child.localName === \"colgroup\") {\n        colGroups.push(child);\n      }\n      child = child.nextElementSibling;\n    }\n    return colGroups;\n  }\n\n  private normalizeAndGetColElements(colGroups: Element[]): Element[] {\n    const cols = [];\n    colGroups.forEach((colGroup) => {\n      // Replace colgroup[span=n] with colgroup with n col elements\n      let span = (colGroup as any).span;\n      colGroup.removeAttribute(\"span\");\n      let col = colGroup.firstElementChild;\n      while (col) {\n        if (col.localName === \"col\") {\n          // Replace col[span=n] with n col elements\n          let s = (col as any).span;\n          col.removeAttribute(\"span\");\n          span -= s;\n          while (s-- > 1) {\n            const cloned = col.cloneNode(true);\n            colGroup.insertBefore(cloned, col);\n            cols.push(cloned);\n          }\n          cols.push(col);\n        }\n        col = col.nextElementSibling;\n      }\n      while (span-- > 0) {\n        col = colGroup.ownerDocument.createElement(\"col\");\n        colGroup.appendChild(col);\n        cols.push(col);\n      }\n    });\n    return cols;\n  }\n\n  private addMissingColElements(\n    cols: Element[],\n    colGroups: Element[],\n    columnCount: number,\n    tableElement: Element,\n  ) {\n    if (cols.length < columnCount) {\n      const colGroup = tableElement.ownerDocument.createElement(\"colgroup\");\n      colGroups.push(colGroup);\n      for (let i = cols.length; i < columnCount; i++) {\n        const col = tableElement.ownerDocument.createElement(\"col\");\n        colGroup.appendChild(col);\n        cols.push(col);\n      }\n    }\n  }\n\n  /**\n   * Measure width of columns and normalize colgroup and col elements so that\n   * each column has a corresponding col element with the width specified.\n   */\n  normalizeColGroups(\n    formattingContext: TableFormattingContext,\n    tableElement: Element,\n    column: Layout.Column,\n  ) {\n    const vertical = formattingContext.vertical;\n    const lastRow = formattingContext.lastRowViewNode;\n    if (!lastRow) {\n      return;\n    }\n    Asserts.assert(lastRow);\n    formattingContext.lastRowViewNode = null;\n    const doc = lastRow.ownerDocument;\n    const fragment = doc.createDocumentFragment();\n\n    // Count columns\n    const columnCount = formattingContext.getColumnCount();\n    if (!(columnCount > 0)) {\n      formattingContext.colGroups = fragment;\n      return;\n    }\n\n    // Measure column widths\n    const colWidths = (formattingContext.colWidths = this.getColumnWidths(\n      lastRow,\n      columnCount,\n      vertical,\n      column.clientLayout,\n    ));\n\n    // Normalize colgroup and col elements\n    const colGroups = this.getColGroupElements(tableElement);\n    const cols = this.normalizeAndGetColElements(colGroups);\n\n    // Add missing col elements for remaining columns\n    this.addMissingColElements(cols, colGroups, columnCount, tableElement);\n\n    // Assign width to col elements\n    cols.forEach((col, i) => {\n      Base.setCSSProperty(\n        col,\n        vertical ? \"height\" : \"width\",\n        `${colWidths[i]}px`,\n      );\n    });\n    colGroups.forEach((colGroup) => {\n      fragment.appendChild(colGroup.cloneNode(true));\n    });\n    formattingContext.colGroups = fragment;\n  }\n\n  doInitialLayout(\n    nodeContext: Vtree.NodeContext,\n    column: Layout.Column,\n  ): Task.Result<Vtree.NodeContext> {\n    const formattingContext = getTableFormattingContext(\n      nodeContext.formattingContext,\n    );\n    formattingContext.vertical = nodeContext.vertical;\n    formattingContext.initializeRepetitiveElements(nodeContext.vertical);\n    Asserts.assert(nodeContext.sourceNode);\n    const tableLayoutOption = getTableLayoutOption(nodeContext.sourceNode);\n    clearTableLayoutOptionCache(nodeContext.sourceNode);\n    const frame = Task.newFrame<Vtree.NodeContext>(\n      \"TableLayoutProcessor.doInitialLayout\",\n    );\n    const initialNodeContext = nodeContext.copy();\n    this.layoutEntireTable(nodeContext, column).then((nodeContextAfter) => {\n      const tableElement = nodeContextAfter.viewNode as Element;\n      const tableBBox = LayoutHelper.getElementClientRectAdjusted(\n        column.clientLayout,\n        tableElement,\n        column.vertical,\n      );\n      let edge = column.vertical ? tableBBox.left : tableBBox.bottom;\n      edge +=\n        (column.vertical ? -1 : 1) *\n        BreakPosition.calculateOffset(\n          nodeContext,\n          column.collectElementsOffset(),\n        ).current;\n      if (\n        !column.isOverflown(edge) &&\n        (!tableLayoutOption || !tableLayoutOption.calculateBreakPositionsInside)\n      ) {\n        column.breakPositions.push(\n          new EntireTableBreakPosition(initialNodeContext),\n        );\n        frame.finish(nodeContextAfter);\n        return;\n      }\n      this.normalizeColGroups(formattingContext, tableElement, column);\n      formattingContext.updateCellSizes(column.clientLayout);\n      frame.finish(null);\n    });\n    return frame.result();\n  }\n\n  addCaptions(\n    formattingContext: TableFormattingContext,\n    rootViewNode: Element,\n    firstChild: Node | null,\n  ) {\n    const captions = formattingContext.captions;\n    captions.forEach((caption, i) => {\n      if (caption) {\n        rootViewNode.insertBefore(caption.viewNode, firstChild);\n        if (caption.side === \"top\") {\n          captions[i] = null;\n        }\n      }\n    });\n  }\n\n  addColGroups(\n    formattingContext: TableFormattingContext,\n    rootViewNode: Element,\n    firstChild: Node | null,\n  ) {\n    if (\n      formattingContext.colGroups &&\n      this.getColGroupElements(rootViewNode).length === 0\n    ) {\n      rootViewNode.insertBefore(\n        formattingContext.colGroups.cloneNode(true),\n        firstChild,\n      );\n      // Set table-layout to fixed so that the widths of the columns\n      // are respected. (Fix for issue #1475)\n      Base.setCSSProperty(rootViewNode, \"table-layout\", \"fixed\");\n      Base.setCSSProperty(\n        rootViewNode,\n        formattingContext.vertical ? \"height\" : \"width\",\n        `${formattingContext.tableWidth}px`,\n      );\n    }\n  }\n\n  removeColGroups(\n    formattingContext: TableFormattingContext,\n    rootViewNode: Element,\n  ) {\n    if (formattingContext.colGroups && rootViewNode) {\n      const colGroups = this.getColGroupElements(rootViewNode);\n      if (colGroups) {\n        colGroups.forEach((colGroup) => {\n          rootViewNode.removeChild(colGroup);\n        });\n      }\n    }\n  }\n\n  doLayout(\n    nodeContext: Vtree.NodeContext,\n    column: Layout.Column,\n  ): Task.Result<Vtree.NodeContext> {\n    const formattingContext = getTableFormattingContext(\n      nodeContext.formattingContext,\n    );\n    const rootViewNode = formattingContext.getRootViewNode(\n      nodeContext,\n    ) as Element;\n    const firstChild = rootViewNode.firstChild;\n    this.addCaptions(formattingContext, rootViewNode, firstChild);\n    this.addColGroups(formattingContext, rootViewNode, firstChild);\n    const strategy = new TableLayoutStrategy(formattingContext, column);\n    const iterator = new LayoutUtil.LayoutIterator(\n      strategy,\n      column.layoutContext,\n    );\n    const frame = Task.newFrame<Vtree.NodeContext>(\n      \"TableFormattingContext.doLayout\",\n    );\n    iterator.iterate(nodeContext).thenFinish(frame);\n    return frame.result();\n  }\n\n  /** @override */\n  layout(\n    nodeContext: Vtree.NodeContext,\n    column: Layout.Column,\n    leadingEdge: boolean,\n  ): Task.Result<Vtree.NodeContext> {\n    const formattingContext = getTableFormattingContext(\n      nodeContext.formattingContext,\n    );\n    const rootViewNode = formattingContext.getRootViewNode(nodeContext);\n    const frame = Task.newFrame<Vtree.NodeContext>(\n      \"TableFormattingContext.layout\",\n    );\n    let cont: Task.Result<Vtree.NodeContext>;\n    if (!rootViewNode) {\n      cont = column.buildDeepElementView(nodeContext);\n    } else {\n      if (leadingEdge) {\n        RepetitiveElementImpl.appendHeaderToAncestors(\n          nodeContext.parent,\n          column,\n        );\n      }\n      cont = new LayoutRetryer(formattingContext, this).layout(\n        nodeContext,\n        column,\n      );\n    }\n    cont.then((result) => {\n      frame.finish(result);\n\n      // Restore column box size if it was modified in `LayoutHelper.getElementClientRectAdjusted()`.\n      if (\n        column.element.hasAttribute(\"data-vivliostyle-column-height-adjusted\")\n      ) {\n        Base.setCSSProperty(column.element, \"width\", `${column.width}px`);\n        Base.setCSSProperty(column.element, \"height\", `${column.height}px`);\n        column.element.removeAttribute(\n          \"data-vivliostyle-column-height-adjusted\",\n        );\n      }\n    });\n    return frame.result();\n  }\n\n  /** @override */\n  createEdgeBreakPosition(\n    position: Vtree.NodeContext,\n    breakOnEdge: string | null,\n    overflows: boolean,\n    columnBlockSize: number,\n  ): LayoutType.BreakPosition {\n    return new BetweenTableRowBreakPosition(\n      position,\n      breakOnEdge,\n      overflows,\n      columnBlockSize,\n    );\n  }\n\n  /** @override */\n  startNonInlineElementNode(nodeContext: Vtree.NodeContext): boolean {\n    return false;\n  }\n\n  /** @override */\n  afterNonInlineElementNode(\n    nodeContext: Vtree.NodeContext,\n    stopAtOverflow: boolean,\n  ): boolean {\n    adjustRowHeight(nodeContext);\n    return false;\n  }\n\n  /** @override */\n  finishBreak(\n    column: Layout.Column,\n    nodeContext: Vtree.NodeContext,\n    forceRemoveSelf: boolean,\n    endOfColumn: boolean,\n  ): Task.Result<boolean> {\n    const formattingContext = getTableFormattingContext(\n      nodeContext.formattingContext,\n    );\n    if (nodeContext.display === \"table-row\") {\n      Asserts.assert(nodeContext.sourceNode);\n      const rowIndex = formattingContext.findRowIndexBySourceNode(\n        nodeContext.sourceNode,\n      );\n      formattingContext.cellBreakPositions = [];\n      let cells: TableCell[];\n      if (!nodeContext.after) {\n        cells = formattingContext.getCellsFallingOnRow(rowIndex);\n      } else {\n        cells =\n          formattingContext.getRowSpanningCellsOverflowingTheRow(rowIndex);\n      }\n      if (cells.length) {\n        const frame = Task.newFrame<boolean>(\n          \"TableLayoutProcessor.finishBreak\",\n        );\n        let i = 0;\n        frame\n          .loopWithFrame((loopFrame) => {\n            if (i === cells.length) {\n              loopFrame.breakLoop();\n              return;\n            }\n            const cell = cells[i++];\n            const cellFragment = formattingContext.getCellFragmentOfCell(cell);\n            const breakNodeContext =\n              cellFragment.findAcceptableBreakPosition().nodeContext;\n            Asserts.assert(breakNodeContext);\n            const cellNodeContext = cellFragment.cellNodeContext;\n            const cellNodePosition = cellNodeContext.toNodePosition();\n            const breakChunkPosition = new VtreeImpl.ChunkPosition(\n              breakNodeContext.toNodePosition(),\n            );\n            formattingContext.cellBreakPositions.push({\n              cellNodePosition,\n              breakChunkPosition,\n              cell,\n            } as BrokenTableCellPosition);\n            const cellViewNode =\n              cellNodeContext.viewNode as HTMLTableCellElement;\n            cellFragment.column.layoutContext.processFragmentedBlockEdge(\n              cellFragment.cellNodeContext,\n            );\n            if (rowIndex < cell.rowIndex + cell.rowSpan - 1) {\n              cellViewNode.rowSpan = rowIndex - cell.rowIndex + 1;\n            }\n            if (!cellFragment.empty) {\n              cellFragment.pseudoColumn\n                .finishBreak(breakNodeContext, false, true)\n                .then(() => {\n                  Asserts.assert(cellFragment);\n                  adjustCellHeight(\n                    cellFragment,\n                    formattingContext,\n                    breakNodeContext,\n                  );\n                  loopFrame.continueLoop();\n                });\n            } else {\n              loopFrame.continueLoop();\n            }\n          })\n          .then(() => {\n            column.clearOverflownViewNodes(nodeContext, false);\n            column.layoutContext.processFragmentedBlockEdge(nodeContext);\n            adjustRowHeight(nodeContext);\n            formattingContext.finishFragment();\n            frame.finish(true);\n          });\n        return frame.result();\n      }\n    }\n    adjustRowHeight(nodeContext);\n    formattingContext.finishFragment();\n    return LayoutProcessor.blockLayoutProcessor.finishBreak(\n      column,\n      nodeContext,\n      forceRemoveSelf,\n      endOfColumn,\n    );\n  }\n\n  /** @override */\n  clearOverflownViewNodes(\n    column: Layout.Column,\n    parentNodeContext: Vtree.NodeContext,\n    nodeContext: Vtree.NodeContext,\n    removeSelf: boolean,\n  ) {\n    LayoutProcessor.BlockLayoutProcessor.prototype.clearOverflownViewNodes(\n      column,\n      parentNodeContext,\n      nodeContext,\n      removeSelf,\n    );\n  }\n}\n\nfunction adjustCellHeight(\n  cellFragment: TableCellFragment,\n  formattingContext: TableFormattingContext,\n  breakNodeContext: Vtree.NodeContext,\n): void {\n  const repetitiveElements = formattingContext.getRepetitiveElements();\n  if (\n    !repetitiveElements ||\n    !(\n      repetitiveElements.isHeaderRegistered() ||\n      repetitiveElements.isFooterRegistered()\n    ) // Fix for issue #1458, case 1\n  ) {\n    return;\n  }\n  const vertical = formattingContext.vertical;\n  const column = cellFragment.column;\n  const cellContentElement = cellFragment.pseudoColumn.getColumnElement();\n  const cellElement = cellFragment.cellNodeContext.viewNode as Element;\n  const cellElementRect = LayoutHelper.getElementClientRectAdjusted(\n    column.clientLayout,\n    cellElement,\n    vertical,\n  );\n  const padding = column.getComputedPaddingBorder(cellElement);\n  if (vertical) {\n    const width =\n      cellElementRect.right -\n      column.footnoteEdge -\n      repetitiveElements.calculateOffset(breakNodeContext) -\n      padding.right;\n    Base.setCSSProperty(cellContentElement, \"max-width\", `${width}px`);\n  } else {\n    const height =\n      column.footnoteEdge -\n      repetitiveElements.calculateOffset(breakNodeContext) -\n      cellElementRect.top -\n      padding.top;\n    Base.setCSSProperty(cellContentElement, \"max-height\", `${height}px`);\n  }\n}\n\n/**\n * Adjusts the height of a table row to prevent another preceding row\n * containing fragmented rowspanning cells and dummy empty cells which\n * should have zero height from having non-zero height due to\n * Chromium's behavior when rowspanning cells exist.\n * (Fix for issue #1458, case 3)\n *\n * @param nodeContext - node context of table or table-row\n */\nfunction adjustRowHeight(nodeContext: Vtree.NodeContext): void {\n  const tbodyElement =\n    nodeContext.display === \"table-row\"\n      ? nodeContext.viewNode.parentElement\n      : nodeContext.display === \"table\"\n        ? (nodeContext.viewNode as Element).querySelector(\"tbody\")\n        : null;\n  if (!tbodyElement) {\n    return;\n  }\n  // Find row elements that only have rowspanning cells and empty cells.\n  let spanStartRows: NodeListOf<HTMLTableRowElement>;\n  try {\n    spanStartRows = tbodyElement.querySelectorAll(\n      \":scope>tr:has(>:empty):not(:has(>:not([rowspan]:not([rowspan='1']),:empty)))\",\n    );\n  } catch (e) {\n    // Do nothing if the browser does not support `:has()` to avoid error.\n    // (Workaround for issue #1509)\n    return;\n  }\n  if (spanStartRows.length === 0) {\n    return;\n  }\n  const spanStartRowHeight = Array.from(spanStartRows).reduce(\n    (totalHeight, rowElement) => {\n      const rect = rowElement.getBoundingClientRect();\n      const height = nodeContext.vertical ? rect.width : rect.height;\n      return totalHeight + height;\n    },\n    0,\n  );\n  const spanStartLastRow = spanStartRows[spanStartRows.length - 1];\n  const spanStartLastRowIndex = Array.from(tbodyElement.children).indexOf(\n    spanStartLastRow,\n  );\n  const rowSpan = Array.from(spanStartLastRow.children).reduce((r, cell) => {\n    const span = (cell as HTMLTableCellElement).rowSpan;\n    return span > 1 &&\n      spanStartLastRowIndex + span < tbodyElement.childElementCount\n      ? Math.max(r, span)\n      : r;\n  }, 0);\n  // Find the row element that needs to be adjusted.\n  let rowToBeAdjusted = rowSpan\n    ? tbodyElement.children[spanStartLastRowIndex + rowSpan - 1]\n    : tbodyElement.lastElementChild;\n  if (\n    rowToBeAdjusted != tbodyElement.lastElementChild &&\n    rowToBeAdjusted.querySelector(\":scope>*>div>div\")\n  ) {\n    for (\n      let row = rowToBeAdjusted;\n      row && row !== tbodyElement.lastElementChild;\n      row = row.nextElementSibling\n    ) {\n      if (row.querySelector(\":scope>[rowspan]:not([rowspan='1'])\")) {\n        rowToBeAdjusted = row;\n        break;\n      }\n    }\n  }\n  const rowRect = rowToBeAdjusted.getBoundingClientRect();\n  const rowHeight = nodeContext.vertical ? rowRect.width : rowRect.height;\n  const newRowHeight = spanStartRowHeight + rowHeight;\n  Base.setCSSProperty(\n    rowToBeAdjusted,\n    nodeContext.vertical ? \"width\" : \"height\",\n    `${newRowHeight}px`,\n  );\n}\n\nexport class LayoutRetryer extends LayoutRetryers.AbstractLayoutRetryer {\n  constructor(\n    private tableFormattingContext: TableFormattingContext,\n    private readonly processor: TableLayoutProcessor,\n  ) {\n    super();\n  }\n\n  override resolveLayoutMode(\n    nodeContext: Vtree.NodeContext,\n  ): LayoutType.LayoutMode {\n    const repetitiveElements =\n      this.tableFormattingContext.getRepetitiveElements();\n    if (!repetitiveElements || !repetitiveElements.doneInitialLayout) {\n      return new LayoutEntireTable(this.tableFormattingContext, this.processor);\n    } else {\n      if (\n        nodeContext.sourceNode ===\n          this.tableFormattingContext.tableSourceNode &&\n        !nodeContext.after\n      ) {\n        if (repetitiveElements) {\n          repetitiveElements.preventSkippingHeader();\n        }\n      }\n      return new LayoutFragmentedTable(\n        this.tableFormattingContext,\n        this.processor,\n      );\n    }\n  }\n\n  override clearNodes(initialPosition: Vtree.NodeContext) {\n    super.clearNodes(initialPosition);\n    const rootViewNode =\n      this.tableFormattingContext.getRootViewNode(initialPosition);\n    this.processor.removeColGroups(this.tableFormattingContext, rootViewNode);\n  }\n\n  override restoreState(nodeContext: Vtree.NodeContext, column: Layout.Column) {\n    super.restoreState(nodeContext, column);\n    this.tableFormattingContext.finishFragment();\n  }\n}\n\nexport class LayoutEntireTable extends RepetitiveElementImpl.LayoutEntireBlock {\n  constructor(\n    formattingContext: TableFormattingContext,\n    public readonly processor: TableLayoutProcessor,\n  ) {\n    super(formattingContext);\n  }\n\n  override doLayout(\n    nodeContext: Vtree.NodeContext,\n    column: Layout.Column,\n  ): Task.Result<Vtree.NodeContext> {\n    return this.processor.doInitialLayout(nodeContext, column);\n  }\n}\n\nexport class EntireTableBreakPosition extends BreakPosition.EdgeBreakPosition {\n  constructor(tableNodeContext: Vtree.NodeContext) {\n    super(tableNodeContext, null, tableNodeContext.overflow, 0);\n  }\n\n  override getMinBreakPenalty(): number {\n    if (!this.isEdgeUpdated) {\n      throw new Error(\"EdgeBreakPosition.prototype.updateEdge not called\");\n    }\n    return (\n      (this.overflows ? 3 : 0) +\n      (this.position.parent ? this.position.parent.breakPenalty : 0)\n    );\n  }\n\n  override breakPositionChosen(column: Layout.Column): void {\n    column.fragmentLayoutConstraints.push(\n      new EntireTableLayoutConstraint(this.position.sourceNode),\n    );\n  }\n}\n\nexport class EntireTableLayoutConstraint\n  implements Layout.FragmentLayoutConstraint\n{\n  flagmentLayoutConstraintType: FragmentLayoutConstraintType = \"EntireTable\";\n\n  constructor(public tableRootNode: Node) {}\n\n  /** @override */\n  allowLayout(\n    nodeContext: Vtree.NodeContext,\n    overflownNodeContext: Vtree.NodeContext,\n    column: Layout.Column,\n  ): boolean {\n    // If the nodeContext overflows, any EntireTableLayoutConstraint should not\n    // be registered in the first place. See\n    // TableLayoutProcessor.prototype.doInitialLayout.\n\n    Asserts.assert(!nodeContext.overflow);\n    return false;\n  }\n\n  /** @override */\n  nextCandidate(nodeContext: Vtree.NodeContext): boolean {\n    return true;\n  }\n\n  /** @override */\n  postLayout(\n    allowed: boolean,\n    positionAfter: Vtree.NodeContext,\n    initialPosition: Vtree.NodeContext,\n    column: Layout.Column,\n  ) {\n    Asserts.assert(positionAfter.sourceNode);\n    tableLayoutOptionCache.push({\n      root: positionAfter.sourceNode,\n      tableLayoutOption: {\n        calculateBreakPositionsInside: true,\n      } as TableLayoutOption,\n    });\n  }\n\n  /** @override */\n  finishBreak(\n    nodeContext: Vtree.NodeContext,\n    column: Layout.Column,\n  ): Task.Result<boolean> {\n    return Task.newResult(true);\n  }\n\n  /** @override */\n  equalsTo(constraint: Layout.FragmentLayoutConstraint): boolean {\n    return (\n      constraint instanceof EntireTableLayoutConstraint &&\n      constraint.tableRootNode === this.tableRootNode\n    );\n  }\n\n  /** @override */\n  getPriorityOfFinishBreak(): number {\n    return 0;\n  }\n}\n\nexport class LayoutFragmentedTable extends RepetitiveElementImpl.LayoutFragmentedBlock {\n  constructor(\n    formattingContext: TableFormattingContext,\n    public readonly processor: TableLayoutProcessor,\n  ) {\n    super(formattingContext);\n  }\n\n  override doLayout(\n    nodeContext: Vtree.NodeContext,\n    column: Layout.Column,\n  ): Task.Result<Vtree.NodeContext> {\n    const repetitiveElements = this.formattingContext.getRepetitiveElements();\n    if (\n      repetitiveElements &&\n      !repetitiveElements.isAfterLastContent(nodeContext)\n    ) {\n      const constraint = new TableRowLayoutConstraint(nodeContext);\n      if (\n        !column.fragmentLayoutConstraints.some((c) => constraint.equalsTo(c))\n      ) {\n        column.fragmentLayoutConstraints.unshift(constraint);\n      }\n    }\n    return this.processor.doLayout(nodeContext, column);\n  }\n}\n\nexport class TableRowLayoutConstraint\n  extends RepetitiveElementImpl.RepetitiveElementsOwnerLayoutConstraint\n  implements Table.TableRowLayoutConstraint\n{\n  flagmentLayoutConstraintType: FragmentLayoutConstraintType = \"TableRow\";\n  cellFragmentLayoutConstraints: {\n    constraints: Layout.FragmentLayoutConstraint[];\n    breakPosition: Vtree.NodeContext;\n  }[] = [];\n\n  constructor(nodeContext: Vtree.NodeContext) {\n    super(nodeContext);\n  }\n\n  override allowLayout(\n    nodeContext: Vtree.NodeContext,\n    overflownNodeContext: Vtree.NodeContext,\n    column: Layout.Column,\n  ): boolean {\n    const repetitiveElements = this.getRepetitiveElements();\n    if (!repetitiveElements) {\n      return true;\n    }\n    if (column.pseudoParent) {\n      return true;\n    }\n    if (LayoutHelper.isOrphan(this.nodeContext.viewNode)) {\n      return true;\n    }\n    if (!repetitiveElements.isEnableToUpdateState()) {\n      return true;\n    }\n    if (\n      (overflownNodeContext && !nodeContext) ||\n      (nodeContext && nodeContext.overflow)\n    ) {\n      return false;\n    } else {\n      return true;\n    }\n  }\n\n  override nextCandidate(nodeContext: Vtree.NodeContext): boolean {\n    const formattingContext = getTableFormattingContext(\n      this.nodeContext.formattingContext,\n    );\n    const cellFragmentConstraints = this.collectCellFragmentLayoutConstraints(\n      nodeContext,\n      formattingContext,\n    );\n    if (\n      cellFragmentConstraints.some((entry) =>\n        entry.constraints.some((constraint) =>\n          constraint.nextCandidate(nodeContext),\n        ),\n      )\n    ) {\n      return true;\n    }\n    return super.nextCandidate(nodeContext);\n  }\n\n  override postLayout(\n    allowed: boolean,\n    positionAfter: Vtree.NodeContext,\n    initialPosition: Vtree.NodeContext,\n    column: Layout.Column,\n  ) {\n    const formattingContext = getTableFormattingContext(\n      this.nodeContext.formattingContext,\n    );\n    this.cellFragmentLayoutConstraints =\n      this.collectCellFragmentLayoutConstraints(\n        positionAfter,\n        formattingContext,\n      );\n    this.cellFragmentLayoutConstraints.forEach((entry) => {\n      entry.constraints.forEach((constraint) => {\n        constraint.postLayout(\n          allowed,\n          entry.breakPosition,\n          initialPosition,\n          column,\n        );\n      });\n    });\n    if (!allowed) {\n      const rootViewNode = formattingContext.getRootViewNode(this.nodeContext);\n      new TableLayoutProcessor().removeColGroups(\n        formattingContext,\n        rootViewNode as Element,\n      );\n      this.removeDummyRowNodes(initialPosition);\n    }\n    super.postLayout(allowed, positionAfter, initialPosition, column);\n  }\n\n  override finishBreak(\n    nodeContext: Vtree.NodeContext,\n    column: Layout.Column,\n  ): Task.Result<boolean> {\n    const formattingContext = getTableFormattingContext(\n      this.nodeContext.formattingContext,\n    );\n    const frame: Task.Frame<boolean> = Task.newFrame(\"finishBreak\");\n    const constraints = this.cellFragmentLayoutConstraints.reduce(\n      (array, entry) =>\n        array.concat(\n          entry.constraints.map((constraint) => ({\n            constraint,\n            breakPosition: entry.breakPosition,\n          })),\n        ),\n      [],\n    );\n    let i = 0;\n    frame\n      .loop(() => {\n        if (i < constraints.length) {\n          const entry = constraints[i++];\n          return entry.constraint\n            .finishBreak(entry.breakPosition, column)\n            .thenReturn(true);\n        } else {\n          return Task.newResult(false);\n        }\n      })\n      .then(() => {\n        frame.finish(true);\n      });\n    return frame\n      .result()\n      .thenAsync(() => super.finishBreak(nodeContext, column));\n  }\n\n  removeDummyRowNodes(nodeContext: Vtree.NodeContext) {\n    if (\n      !nodeContext ||\n      nodeContext.display !== \"table-row\" ||\n      !nodeContext.viewNode\n    ) {\n      return;\n    }\n    while ((nodeContext.viewNode as Element).previousElementSibling) {\n      const dummyNode = (nodeContext.viewNode as Element)\n        .previousElementSibling;\n      if (dummyNode.parentNode) {\n        dummyNode.parentNode.removeChild(dummyNode);\n      }\n    }\n  }\n\n  private collectCellFragmentLayoutConstraints(\n    nodeContext: Vtree.NodeContext,\n    formattingContext: TableFormattingContext,\n  ): {\n    constraints: Layout.FragmentLayoutConstraint[];\n    breakPosition: Vtree.NodeContext;\n  }[] {\n    return this.getCellFragemnts(nodeContext, formattingContext).map(\n      (entry) => ({\n        constraints:\n          entry.fragment.pseudoColumn.getColumn().fragmentLayoutConstraints,\n        breakPosition: entry.breakPosition,\n      }),\n    );\n  }\n\n  private getCellFragemnts(\n    nodeContext: Vtree.NodeContext,\n    formattingContext: TableFormattingContext,\n  ): { fragment: TableCellFragment; breakPosition: Vtree.NodeContext }[] {\n    let rowIndex = Number.MAX_VALUE;\n    if (nodeContext && nodeContext.display === \"table-row\") {\n      Asserts.assert(nodeContext.sourceNode);\n      rowIndex =\n        formattingContext.findRowIndexBySourceNode(nodeContext.sourceNode) + 1;\n    }\n    rowIndex = Math.min(formattingContext.cellFragments.length, rowIndex);\n    const cellFragments = [];\n    for (let i = 0; i < rowIndex; i++) {\n      if (!formattingContext.cellFragments[i]) {\n        continue;\n      }\n      formattingContext.cellFragments[i].forEach((cellFragment) => {\n        if (!cellFragment) {\n          return;\n        }\n        cellFragments.push({\n          fragment: cellFragment,\n          breakPosition: cellFragment.findAcceptableBreakPosition().nodeContext,\n        });\n      });\n    }\n    return cellFragments;\n  }\n\n  getElementsOffsetsForTableCell(\n    column: Layout.Column,\n  ): RepetitiveElement.ElementsOffset[] {\n    const formattingContext = getTableFormattingContext(\n      this.nodeContext.formattingContext,\n    );\n    const position = formattingContext.findCellFromColumn(column);\n    if (position) {\n      return formattingContext.collectElementsOffsetOfUpperCells(position);\n    } else {\n      return formattingContext.collectElementsOffsetOfHighestColumn();\n    }\n  }\n\n  override equalsTo(constraint: Layout.FragmentLayoutConstraint): boolean {\n    if (!(constraint instanceof TableRowLayoutConstraint)) {\n      return false;\n    }\n    return (\n      getTableFormattingContext(this.nodeContext.formattingContext) ===\n      getTableFormattingContext(constraint.nodeContext.formattingContext)\n    );\n  }\n}\n\nconst tableLayoutProcessor = new TableLayoutProcessor();\n\nfunction resolveFormattingContextHook(\n  nodeContext: Vtree.NodeContext,\n  firstTime: boolean,\n  display: Css.Ident,\n  position: Css.Ident,\n  floatSide: Css.Val,\n  isRoot: boolean,\n): TableFormattingContext | null {\n  if (!firstTime) {\n    return null;\n  }\n  if (display === Css.ident.table) {\n    const parent = nodeContext.parent;\n    return new TableFormattingContext(\n      parent ? parent.formattingContext : null,\n      nodeContext.sourceNode as Element,\n    );\n  }\n  return null;\n}\n\nfunction resolveLayoutProcessor(\n  formattingContext,\n): TableLayoutProcessor | null {\n  if (formattingContext instanceof TableFormattingContext) {\n    return tableLayoutProcessor;\n  }\n  return null;\n}\n\nPlugin.registerHook(\n  Plugin.HOOKS.RESOLVE_FORMATTING_CONTEXT,\n  resolveFormattingContextHook,\n);\n\nPlugin.registerHook(\n  Plugin.HOOKS.RESOLVE_LAYOUT_PROCESSOR,\n  resolveLayoutProcessor,\n);\n", "/**\n * Copyright 2017 Daishinsha Inc.\n * Copyright 2019 Vivliostyle Foundation\n *\n * Vivliostyle.js is free software: you can redistribute it and/or modify\n * it under the terms of the GNU Affero General Public License as published by\n * the Free Software Foundation, either version 3 of the License, or\n * (at your option) any later version.\n *\n * Vivliostyle.js is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n * GNU Affero General Public License for more details.\n *\n * You should have received a copy of the GNU Affero General Public License\n * along with Vivliostyle.js.  If not, see <http://www.gnu.org/licenses/>.\n *\n * @fileoverview MathUtil - Math utilities\n */\n\n/** */\nexport function mean(array: number[]): number {\n  return array.reduce((prev, curr) => prev + curr, 0) / array.length;\n}\n\nexport function variance(array: number[]): number {\n  const meanValue = mean(array);\n  return mean(\n    array.map((x) => {\n      const d = x - meanValue;\n      return d * d;\n    }),\n  );\n}\n", "/**\n * Copyright 2017 Daishinsha Inc.\n * Copyright 2019 Vivliostyle Foundation\n *\n * Vivliostyle.js is free software: you can redistribute it and/or modify\n * it under the terms of the GNU Affero General Public License as published by\n * the Free Software Foundation, either version 3 of the License, or\n * (at your option) any later version.\n *\n * Vivliostyle.js is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n * GNU Affero General Public License for more details.\n *\n * You should have received a copy of the GNU Affero General Public License\n * along with Vivliostyle.js.  If not, see <http://www.gnu.org/licenses/>.\n *\n * @fileoverview Columns - Control column layout.\n */\nimport * as Asserts from \"./asserts\";\nimport * as Css from \"./css\";\nimport * as MathUtil from \"./math-util\";\nimport * as PageFloats from \"./page-floats\";\nimport * as Task from \"./task\";\nimport * as Vtree from \"./vtree\";\nimport { Layout } from \"./types\";\n\nexport type ColumnLayoutResult = {\n  columns: Layout.Column[];\n  position: Vtree.LayoutPosition;\n  columnPageFloatLayoutContexts?: PageFloats.PageFloatLayoutContext[];\n};\n\nexport type ColumnGenerator = () => Task.Result<ColumnLayoutResult | null>;\n\nexport class ColumnBalancingTrialResult {\n  constructor(\n    public readonly layoutResult: ColumnLayoutResult,\n    public readonly penalty: number,\n  ) {}\n}\n\nfunction getBlockSize(container: Vtree.Container): number {\n  if (container.vertical) {\n    return container.width;\n  } else {\n    return container.height;\n  }\n}\n\nfunction setBlockSize(container: Vtree.Container, size: number) {\n  if (container.vertical) {\n    container.width = size;\n  } else {\n    container.height = size;\n  }\n}\n\nexport abstract class ColumnBalancer {\n  originalContainerBlockSize: number;\n\n  constructor(\n    public readonly layoutContainer: Vtree.Container,\n    public readonly columnGenerator: ColumnGenerator,\n    public readonly regionPageFloatLayoutContext: PageFloats.PageFloatLayoutContext,\n  ) {\n    this.originalContainerBlockSize = getBlockSize(layoutContainer);\n  }\n\n  balanceColumns(\n    layoutResult: ColumnLayoutResult,\n  ): Task.Result<ColumnLayoutResult> {\n    const frame: Task.Frame<ColumnLayoutResult> = Task.newFrame(\n      \"ColumnBalancer#balanceColumns\",\n    );\n    this.preBalance(layoutResult);\n    this.savePageFloatLayoutContexts(layoutResult);\n    this.layoutContainer.clear();\n    const candidates = [this.createTrialResult(layoutResult)];\n    frame\n      .loopWithFrame((loopFrame) => {\n        if (!this.hasNextCandidate(candidates)) {\n          loopFrame.breakLoop();\n          return;\n        }\n        this.updateCondition(candidates);\n        this.columnGenerator().then((layoutResult) => {\n          this.savePageFloatLayoutContexts(layoutResult);\n          this.layoutContainer.clear();\n          if (!layoutResult) {\n            loopFrame.breakLoop();\n            return;\n          }\n          candidates.push(this.createTrialResult(layoutResult));\n          loopFrame.continueLoop();\n        });\n      })\n      .then(() => {\n        const result = candidates.reduce(\n          (prev, curr) => (curr.penalty < prev.penalty ? curr : prev),\n          candidates[0],\n        );\n        this.restoreContents(result.layoutResult);\n        this.postBalance();\n        frame.finish(result.layoutResult);\n      });\n    return frame.result();\n  }\n\n  private createTrialResult(\n    layoutResult: ColumnLayoutResult,\n  ): ColumnBalancingTrialResult {\n    const penalty = this.calculatePenalty(layoutResult);\n    return new ColumnBalancingTrialResult(layoutResult, penalty);\n  }\n\n  protected preBalance(layoutResult: ColumnLayoutResult) {}\n\n  protected abstract calculatePenalty(layoutResult: ColumnLayoutResult): number;\n\n  protected abstract hasNextCandidate(\n    candidates: ColumnBalancingTrialResult[],\n  ): boolean;\n\n  protected abstract updateCondition(\n    candidates: ColumnBalancingTrialResult[],\n  ): void;\n\n  protected postBalance() {\n    setBlockSize(this.layoutContainer, this.originalContainerBlockSize);\n  }\n\n  savePageFloatLayoutContexts(layoutResult: ColumnLayoutResult | null) {\n    const children = this.regionPageFloatLayoutContext.detachChildren();\n    if (layoutResult) {\n      layoutResult.columnPageFloatLayoutContexts = children;\n    }\n  }\n\n  private restoreContents(newLayoutResult: ColumnLayoutResult) {\n    const parent = this.layoutContainer.element;\n    newLayoutResult.columns.forEach((c) => {\n      parent.appendChild(c.element);\n    });\n    Asserts.assert(newLayoutResult.columnPageFloatLayoutContexts);\n    this.regionPageFloatLayoutContext.attachChildren(\n      newLayoutResult.columnPageFloatLayoutContexts,\n    );\n  }\n}\nconst COLUMN_LENGTH_STEP = 1;\n\nexport function canReduceContainerSize(\n  candidates: ColumnBalancingTrialResult[],\n): boolean {\n  const lastCandidate = candidates[candidates.length - 1];\n  if (lastCandidate.penalty === 0) {\n    return false;\n  }\n  const secondLastCandidate = candidates[candidates.length - 2];\n  if (\n    secondLastCandidate &&\n    lastCandidate.penalty >= secondLastCandidate.penalty\n  ) {\n    return false;\n  }\n  const columns = lastCandidate.layoutResult.columns;\n  const maxColumnBlockSize = Math.max.apply(\n    null,\n    columns.map((c) => c.computedBlockSize),\n  );\n  const maxPageFloatBlockSize = Math.max.apply(\n    null,\n    columns.map((c) => c.getMaxBlockSizeOfPageFloats()),\n  );\n  return maxColumnBlockSize > maxPageFloatBlockSize + COLUMN_LENGTH_STEP;\n}\n\nexport function reduceContainerSize(\n  candidates: ColumnBalancingTrialResult[],\n  container: Vtree.Container,\n): void {\n  const columns = candidates[candidates.length - 1].layoutResult.columns;\n  const maxColumnBlockSize = Math.max.apply(\n    null,\n    columns.map((c) => {\n      if (!isNaN(c.blockDistanceToBlockEndFloats)) {\n        return (\n          c.computedBlockSize -\n          c.blockDistanceToBlockEndFloats +\n          COLUMN_LENGTH_STEP\n        );\n      } else {\n        return c.computedBlockSize;\n      }\n    }),\n  );\n  const newEdge = maxColumnBlockSize - COLUMN_LENGTH_STEP;\n  if (newEdge < getBlockSize(container)) {\n    setBlockSize(container, newEdge);\n  } else {\n    setBlockSize(container, getBlockSize(container) - 1);\n  }\n  if (container.vertical) {\n    const outerWidth = parseFloat(container.element.style?.width);\n    container.originX = outerWidth - container.width;\n  }\n}\n\nexport class BalanceLastColumnBalancer extends ColumnBalancer {\n  originalPosition: Vtree.LayoutPosition | null = null;\n  foundUpperBound: boolean = false;\n\n  constructor(\n    columnGenerator: ColumnGenerator,\n    regionPageFloatLayoutContext,\n    layoutContainer: Vtree.Container,\n    public readonly columnCount: number,\n  ) {\n    super(layoutContainer, columnGenerator, regionPageFloatLayoutContext);\n  }\n\n  override preBalance(layoutResult: ColumnLayoutResult) {\n    const columns = layoutResult.columns;\n    const totalBlockSize = columns.reduce(\n      (prev, c) => prev + c.computedBlockSize,\n      0,\n    );\n    setBlockSize(this.layoutContainer, totalBlockSize / this.columnCount);\n    this.originalPosition = layoutResult.position;\n  }\n\n  private checkPosition(position: Vtree.LayoutPosition | null): boolean {\n    if (this.originalPosition) {\n      return this.originalPosition.isSamePosition(position);\n    } else {\n      return position === null;\n    }\n  }\n\n  override calculatePenalty(layoutResult: ColumnLayoutResult): number {\n    if (!this.checkPosition(layoutResult.position)) {\n      return Infinity;\n    }\n    const columns = layoutResult.columns;\n    if (isLastColumnLongerThanAnyOtherColumn(columns)) {\n      return Infinity;\n    }\n    return Math.max.apply(\n      null,\n      columns.map((c) => c.computedBlockSize),\n    );\n  }\n\n  override hasNextCandidate(candidates: ColumnBalancingTrialResult[]): boolean {\n    if (candidates.length === 1) {\n      return true;\n    } else if (this.foundUpperBound) {\n      return canReduceContainerSize(candidates);\n    } else {\n      const lastCandidate = candidates[candidates.length - 1];\n      if (this.checkPosition(lastCandidate.layoutResult.position)) {\n        if (\n          !isLastColumnLongerThanAnyOtherColumn(\n            lastCandidate.layoutResult.columns,\n          )\n        ) {\n          this.foundUpperBound = true;\n          return true;\n        }\n      }\n      return (\n        getBlockSize(this.layoutContainer) < this.originalContainerBlockSize\n      );\n    }\n  }\n\n  override updateCondition(candidates: ColumnBalancingTrialResult[]): void {\n    if (this.foundUpperBound) {\n      reduceContainerSize(candidates, this.layoutContainer);\n    } else {\n      const newEdge = Math.min(\n        this.originalContainerBlockSize,\n        getBlockSize(this.layoutContainer) +\n          this.originalContainerBlockSize * 0.1,\n      );\n      setBlockSize(this.layoutContainer, newEdge);\n    }\n  }\n}\n\nfunction isLastColumnLongerThanAnyOtherColumn(\n  columns: Layout.Column[],\n): boolean {\n  if (columns.length <= 1) {\n    return false;\n  }\n  const lastColumnBlockSize = columns[columns.length - 1].computedBlockSize;\n  const otherColumns = columns.slice(0, columns.length - 1);\n\n  // The computedBlockSize of the last column may be a little larger than\n  // the others even though columns are balanced, because of the issue\n  // that only the last column's computedBlockSize includes the last\n  // half-leading space.\n  // To work around this, we add an error margin to the other columns.\n  const errorMargin = 6;\n  return otherColumns.every(\n    (c) => lastColumnBlockSize > c.computedBlockSize + errorMargin,\n  );\n}\n\nexport class BalanceNonLastColumnBalancer extends ColumnBalancer {\n  constructor(\n    columnGenerator: ColumnGenerator,\n    regionPageFloatLayoutContext,\n    layoutContainer: Vtree.Container,\n  ) {\n    super(layoutContainer, columnGenerator, regionPageFloatLayoutContext);\n  }\n\n  override calculatePenalty(layoutResult: ColumnLayoutResult): number {\n    if (layoutResult.columns.every((c) => c.computedBlockSize === 0)) {\n      return Infinity;\n    }\n    const computedBlockSizes = layoutResult.columns\n      .filter((c) => !c.pageBreakType)\n      .map((c) => c.computedBlockSize);\n    return MathUtil.variance(computedBlockSizes);\n  }\n\n  override hasNextCandidate(candidates: ColumnBalancingTrialResult[]): boolean {\n    return canReduceContainerSize(candidates);\n  }\n\n  override updateCondition(candidates: ColumnBalancingTrialResult[]): void {\n    reduceContainerSize(candidates, this.layoutContainer);\n  }\n}\n\nexport function createColumnBalancer(\n  columnCount: number,\n  columnFill: Css.Ident,\n  columnGenerator: ColumnGenerator,\n  regionPageFloatLayoutContext: PageFloats.PageFloatLayoutContext,\n  layoutContainer: Vtree.Container,\n  columns: Layout.Column[],\n  flowPosition: Vtree.FlowPosition,\n): ColumnBalancer | null {\n  if (columnFill === Css.ident.auto) {\n    return null;\n  } else {\n    // TODO: how to handle a case where no more in-flow contents but some\n    // page floats\n    const noMoreContent = flowPosition.positions.length === 0;\n    const lastColumn = columns[columns.length - 1];\n    const isLastColumnForceBroken = !!(lastColumn && lastColumn.pageBreakType);\n    if (noMoreContent || isLastColumnForceBroken) {\n      return new BalanceLastColumnBalancer(\n        columnGenerator,\n        regionPageFloatLayoutContext,\n        layoutContainer,\n        columnCount,\n      );\n    } else if (columnFill === Css.ident.balance_all) {\n      return new BalanceNonLastColumnBalancer(\n        columnGenerator,\n        regionPageFloatLayoutContext,\n        layoutContainer,\n      );\n    } else {\n      Asserts.assert(columnFill === Css.ident.balance);\n      return null;\n    }\n  }\n}\n", "/**\n * Copyright 2025 Vivliostyle Foundation\n *\n * Vivliostyle.js is free software: you can redistribute it and/or modify\n * it under the terms of the GNU Affero General Public License as published by\n * the Free Software Foundation, either version 3 of the License, or\n * (at your option) any later version.\n *\n * Vivliostyle.js is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n * GNU Affero General Public License for more details.\n *\n * You should have received a copy of the GNU Affero General Public License\n * along with Vivliostyle.js.  If not, see <http://www.gnu.org/licenses/>.\n */\n\n/**\n * Not implemented:\n *\n * - Support using <image> in <symbol>\n *     https://drafts.csswg.org/css-counter-styles/#typedef-symbol\n *\n * - Make the disclosure-open/closed values respond to writing modes\n *     https://drafts.csswg.org/css-counter-styles/#disclosure-open\n *   CounterStyle.format may require the writing mode as an argument.\n *   It may be necessary to extend it so that the caller can obtain the writing mode.\n *\n * - Use grapheme clusters for character counting in CounterStyle.#applyPadding.\n *     https://drafts.csswg.org/css-counter-styles/#counter-style-pad\n *   Intl.Segmenter may be useful. CounterStyle.format may require the lang as an argument.\n *\n * - Implement symbols() for defining anonymous counter styles\n *     https://drafts.csswg.org/css-counter-styles/#symbols-function\n *   Extending CounterStyle.defineAnonymous( ... ) should work.\n */\n\nimport * as Css from \"./css\";\nimport * as CssCascade from \"./css-cascade\";\n\ntype SetElement<T> = T extends ReadonlySet<infer U> ? U : never;\n\n/**\n * @see https://drafts.csswg.org/css-counter-styles-3/#non-overridable-counter-style-names\n */\nconst nonOverridableNameList = [\n  \"decimal\",\n  \"disc\",\n  \"square\",\n  \"circle\",\n  \"disclosure-open\",\n  \"disclosure-closed\",\n] as const;\nconst nonOverridableNames: ReadonlySet<\n  (typeof nonOverridableNameList)[number]\n> = new Set(nonOverridableNameList);\n\nfunction validateNameForDefinition(name: string): boolean {\n  // case-insensitive for none\n  // case-sensitive for non-overridable\n  return !(\n    name.toLowerCase() === \"none\" ||\n    nonOverridableNames.has(\n      // @ts-expect-error check membership\n      name,\n    )\n  );\n}\n\nconst systemsDefinedBySingleIdentList = [\n  \"cyclic\",\n  \"numeric\",\n  \"alphabetic\",\n  \"symbolic\",\n  \"additive\",\n  \"fixed\",\n] as const;\nconst systemsDefinedBySingleIdent: ReadonlySet<\n  (typeof systemsDefinedBySingleIdentList)[number]\n> = new Set(systemsDefinedBySingleIdentList);\n\nconst systemsDefinedBySpaceListList = [\n  // [ fixed <integer> ]\n  \"fixed\",\n  // [ extends <counter-style-name> ]\n  \"extends\",\n] as const;\nconst systemsDefinedBySpaceList: ReadonlySet<\n  (typeof systemsDefinedBySpaceListList)[number]\n> = new Set(systemsDefinedBySpaceListList);\n\nconst notCaseInsensitiveMatchForNoneBrand = Symbol();\n/**\n * @see https://drafts.csswg.org/css-counter-styles/#typedef-counter-style-name\n */\ntype CounterStyleName = Css.Ident & {\n  [notCaseInsensitiveMatchForNoneBrand]: unknown;\n};\nfunction validateCounterStyleName(value: Css.Val): value is CounterStyleName {\n  return value instanceof Css.Ident && value.name.toLowerCase() !== \"none\";\n}\nfunction extractCounterStyleName(name: CounterStyleName): string {\n  return name.name;\n}\n\n/**\n * @see https://drafts.csswg.org/css-counter-styles/#descdef-counter-style-system\n */\ntype CyclicSystemValue = Css.Ident & { name: \"cyclic\" };\ntype FixedSystemValue =\n  | (Css.Ident & { name: \"fixed\" })\n  | (Css.SpaceList & { values: [Css.Ident & { name: \"fixed\" }, Css.Int] });\ntype SymbolicSystemValue = Css.Ident & { name: \"symbolic\" };\ntype AlphabeticSystemValue = Css.Ident & { name: \"alphabetic\" };\ntype NumericSystemValue = Css.Ident & { name: \"numeric\" };\ntype AdditiveSystemValue = Css.Ident & { name: \"additive\" };\ntype ExtendsSystemValue = Css.SpaceList & {\n  values: [Css.Ident & { name: \"extends\" }, CounterStyleName];\n};\n\ntype SystemDescriptorValue =\n  | CyclicSystemValue\n  | FixedSystemValue\n  | SymbolicSystemValue\n  | AlphabeticSystemValue\n  | NumericSystemValue\n  | AdditiveSystemValue\n  | ExtendsSystemValue;\n\nfunction validateSystem(value: Css.Val): value is SystemDescriptorValue {\n  if (value instanceof Css.Ident) {\n    return systemsDefinedBySingleIdent.has(\n      // @ts-expect-error check membership\n      value.name,\n    );\n  }\n  if (value instanceof Css.SpaceList && value.values.length === 2) {\n    const first = value.values[0]!;\n    const second = value.values[1]!;\n    if (first instanceof Css.Ident) {\n      const name = first.name;\n      return (\n        systemsDefinedBySpaceList.has(\n          // @ts-expect-error check membership\n          name,\n        ) &&\n        ((name === \"fixed\" && second instanceof Css.Int) ||\n          (name === \"extends\" && validateCounterStyleName(second)))\n      );\n    }\n  }\n  return false;\n}\n\n// Descriptors type with specific system value\ntype SystemDescriptors<T extends SystemDescriptorValue> =\n  CssCascade.ElementStyle & {\n    system: CssCascade.CascadeValue & { value: T };\n  };\n\ntype CyclicDescriptors = SystemDescriptors<CyclicSystemValue>;\ntype FixedDescriptors = SystemDescriptors<FixedSystemValue>;\ntype SymbolicDescriptors =\n  | CssCascade.ElementStyle\n  | SystemDescriptors<SymbolicSystemValue>;\ntype AlphabeticDescriptors = SystemDescriptors<AlphabeticSystemValue>;\ntype NumericDescriptors = SystemDescriptors<NumericSystemValue>;\ntype AdditiveDescriptors = SystemDescriptors<AdditiveSystemValue>;\ntype ExtendsDescriptors = SystemDescriptors<ExtendsSystemValue>;\n\nfunction isCyclicDescriptors(\n  descriptors: CssCascade.ElementStyle,\n): descriptors is CyclicDescriptors {\n  const system = getDescriptorValue(descriptors, \"system\");\n  return system instanceof Css.Ident && system.name === \"cyclic\";\n}\n\nfunction isFixedDescriptors(\n  descriptors: CssCascade.ElementStyle,\n): descriptors is FixedDescriptors {\n  const system = getDescriptorValue(descriptors, \"system\");\n  if (system instanceof Css.Ident && system.name === \"fixed\") {\n    return true;\n  }\n  if (system instanceof Css.SpaceList && system.values.length === 2) {\n    const [first, second] = system.values;\n    return (\n      first instanceof Css.Ident &&\n      first.name === \"fixed\" &&\n      second instanceof Css.Int\n    );\n  }\n  return false;\n}\n\nfunction extractFixedFirstSymbolValue(descriptors: FixedDescriptors): number {\n  const system = getDescriptorValue(descriptors, \"system\") as FixedSystemValue;\n  if (system instanceof Css.Ident) {\n    return 1;\n  }\n  return system.values[1].num;\n}\n\nfunction isAlphabeticDescriptors(\n  descriptors: CssCascade.ElementStyle,\n): descriptors is AlphabeticDescriptors {\n  const system = getDescriptorValue(descriptors, \"system\");\n  return system instanceof Css.Ident && system.name === \"alphabetic\";\n}\n\nfunction isNumericDescriptors(\n  descriptors: CssCascade.ElementStyle,\n): descriptors is NumericDescriptors {\n  const system = getDescriptorValue(descriptors, \"system\");\n  return system instanceof Css.Ident && system.name === \"numeric\";\n}\n\nfunction isAdditiveDescriptors(\n  descriptors: CssCascade.ElementStyle,\n): descriptors is AdditiveDescriptors {\n  const system = getDescriptorValue(descriptors, \"system\");\n  return system instanceof Css.Ident && system.name === \"additive\";\n}\n\nfunction isExtendsDescriptors(\n  descriptors: CssCascade.ElementStyle,\n): descriptors is ExtendsDescriptors {\n  const system = getDescriptorValue(descriptors, \"system\");\n  if (system instanceof Css.SpaceList && system.values.length === 2) {\n    const [first, second] = system.values;\n    return (\n      first instanceof Css.Ident &&\n      first.name === \"extends\" &&\n      validateCounterStyleName(second)\n    );\n  }\n  return false;\n}\n\nfunction extractExtendsBaseName(descriptors: ExtendsDescriptors): string {\n  const system = getDescriptorValue(\n    descriptors,\n    \"system\",\n  ) as ExtendsSystemValue;\n  return extractCounterStyleName(system.values[1]);\n}\n\n/**\n * @see https://drafts.csswg.org/css-counter-styles/#typedef-symbol\n */\ntype SymbolType = Css.Str | Css.Ident;\nfunction validateSymbol(value: Css.Val): value is SymbolType {\n  return value instanceof Css.Str || value instanceof Css.Ident;\n}\nfunction extractSymbol(symbol: SymbolType): string {\n  // > Identifiers are rendered as strings containing the same characters.\n  return symbol instanceof Css.Str ? symbol.str : symbol.name;\n}\n\n/**\n * @see https://drafts.csswg.org/css-counter-styles/#descdef-counter-style-negative\n */\ntype NegativeDescriptorValue =\n  | SymbolType\n  | (Css.SpaceList & { values: [SymbolType, SymbolType] });\nfunction validateNegative(value: Css.Val): value is NegativeDescriptorValue {\n  if (validateSymbol(value)) {\n    return true;\n  }\n  if (value instanceof Css.SpaceList && value.values.length === 2) {\n    const first = value.values[0]!;\n    const second = value.values[1]!;\n    return validateSymbol(first) && validateSymbol(second);\n  }\n  return false;\n}\ntype Negative = Readonly<{ prefix: string; suffix: string | null }>;\nfunction extractNegative(negative: NegativeDescriptorValue): Negative {\n  if (validateSymbol(negative)) {\n    return { prefix: extractSymbol(negative), suffix: null };\n  } else {\n    const first = negative.values[0];\n    const second = negative.values[1];\n    return {\n      prefix: extractSymbol(first),\n      suffix: extractSymbol(second),\n    };\n  }\n}\n\ntype RangeBound = Css.Int | (Css.Ident & { name: \"infinite\" });\nfunction validateRangeBound(value: Css.Val): value is RangeBound {\n  return (\n    value instanceof Css.Int ||\n    (value instanceof Css.Ident && value.name === \"infinite\")\n  );\n}\nfunction extractRangeBound(bound: RangeBound, isLower: boolean): number {\n  return bound instanceof Css.Int ? bound.num : isLower ? -Infinity : Infinity;\n}\n\nconst upperAtOrAboveLowerBrand = Symbol();\ntype RangeTuple = Css.SpaceList & {\n  values: [RangeBound, RangeBound] & {\n    [upperAtOrAboveLowerBrand]: unknown;\n  };\n};\nfunction validateRangeTuple(value: Css.Val): value is RangeTuple {\n  if (!(value instanceof Css.SpaceList && value.values.length === 2)) {\n    return false;\n  }\n  const first = value.values[0]!;\n  const second = value.values[1]!;\n  if (!(validateRangeBound(first) && validateRangeBound(second))) {\n    return false;\n  }\n  const lower = extractRangeBound(first, true);\n  const upper = extractRangeBound(second, false);\n  if (lower > upper) {\n    return false;\n  }\n  return true;\n}\nfunction extractRangeTuple(tuple: RangeTuple): RangeItem {\n  return {\n    lower: extractRangeBound(tuple.values[0], true),\n    upper: extractRangeBound(tuple.values[1], false),\n  };\n}\n\n/**\n * @see https://drafts.csswg.org/css-counter-styles/#descdef-counter-style-range\n */\ntype RangeDescriptorValue =\n  | (Css.Ident & { name: \"auto\" })\n  | RangeTuple\n  | (Css.CommaList & { values: [RangeTuple, ...RangeTuple[]] });\nfunction validateRange(value: Css.Val): value is RangeDescriptorValue {\n  return (\n    (value instanceof Css.Ident && value.name === \"auto\") ||\n    validateRangeTuple(value) ||\n    (value instanceof Css.CommaList &&\n      value.values.length >= 1 &&\n      value.values.every((tuple) => validateRangeTuple(tuple)))\n  );\n}\ntype RangeItem = Readonly<{ lower: number; upper: number }>;\ntype Range = readonly [RangeItem, ...RangeItem[]];\nfunction extractRange(range: RangeDescriptorValue): Range | null {\n  if (range instanceof Css.Ident) {\n    return null;\n  }\n  // > The range of the counter style is the union of all the ranges defined in the list.\n  const tuples = validateRangeTuple(range) ? [range] : range.values;\n  return tuples.map((tuple) => extractRangeTuple(tuple)) as unknown as Range;\n}\n\nconst nonNegativeBrand = Symbol();\ntype NonNegativeInt = Css.Int & { [nonNegativeBrand]: unknown };\n/**\n * <integer [0,inf]> && <symbol>\n * @see https://drafts.csswg.org/css-counter-styles/#descdef-counter-style-pad\n * @see https://drafts.csswg.org/css-counter-styles/#descdef-counter-style-additive-symbols\n */\ntype NonNegativeIntAndSymbolSet = Css.SpaceList & {\n  values: [NonNegativeInt, SymbolType] | [SymbolType, NonNegativeInt];\n};\nfunction validateNonNegativeIntAndSymbolSet(\n  value: Css.Val,\n): value is NonNegativeIntAndSymbolSet {\n  if (!(value instanceof Css.SpaceList && value.values.length === 2)) {\n    return false;\n  }\n  const first = value.values[0]!;\n  const second = value.values[1]!;\n  return (\n    (first instanceof Css.Int && first.num >= 0 && validateSymbol(second)) ||\n    (validateSymbol(first) && second instanceof Css.Int && second.num >= 0)\n  );\n}\nfunction extractNonNegativeIntAndSymbolSet(\n  set: NonNegativeIntAndSymbolSet,\n): readonly [number, string] {\n  const [first, second] = set.values;\n  return first instanceof Css.Int\n    ? [first.num, extractSymbol(second as SymbolType)]\n    : [(second as NonNegativeInt).num, extractSymbol(first as SymbolType)];\n}\n\n/**\n * @see https://drafts.csswg.org/css-counter-styles/#descdef-counter-style-pad\n */\ntype PadDescriptorValue = NonNegativeIntAndSymbolSet;\nfunction validatePad(value: Css.Val): value is PadDescriptorValue {\n  return validateNonNegativeIntAndSymbolSet(value);\n}\ntype Pad = Readonly<{ minLength: number; symbol: string }>;\nfunction extractPad(pad: PadDescriptorValue): Pad {\n  const [minLength, symbol] = extractNonNegativeIntAndSymbolSet(pad);\n  return { minLength, symbol };\n}\n\n/**\n * @see https://drafts.csswg.org/css-counter-styles/#descdef-counter-style-symbols\n */\ntype SymbolsDescriptorValue =\n  | SymbolType\n  | (Omit<Css.SpaceList, \"values\"> & {\n      values: readonly [SymbolType, ...SymbolType[]];\n    });\nfunction validateSymbols(value: Css.Val): value is SymbolsDescriptorValue {\n  return (\n    validateSymbol(value) ||\n    (value instanceof Css.SpaceList &&\n      value.values.length >= 1 &&\n      value.values.every((val) => validateSymbol(val)))\n  );\n}\nfunction extractSymbols(\n  symbols: SymbolsDescriptorValue,\n): readonly [string, ...string[]] {\n  return validateSymbol(symbols)\n    ? [extractSymbol(symbols)]\n    : (symbols.values.map((symbol) => extractSymbol(symbol)) as [\n        string,\n        ...string[],\n      ]);\n}\n\n/**\n * @see https://drafts.csswg.org/css-counter-styles/#additive-tuple\n */\ntype AdditiveTuple = NonNegativeIntAndSymbolSet;\nconst strictlyDescendingWeightOrderBrand = Symbol();\n/**\n * @see https://drafts.csswg.org/css-counter-styles/#descdef-counter-style-additive-symbols\n */\ntype AdditiveSymbolsDescriptorValue =\n  | AdditiveTuple\n  | (Omit<Css.CommaList, \"values\"> & {\n      values: [AdditiveTuple, ...AdditiveTuple[]] & {\n        [strictlyDescendingWeightOrderBrand]: unknown;\n      };\n    });\nfunction validateAdditiveSymbols(\n  value: Css.Val,\n): value is AdditiveSymbolsDescriptorValue {\n  if (validateNonNegativeIntAndSymbolSet(value)) {\n    return true;\n  }\n  if (value instanceof Css.CommaList && value.values.length >= 1) {\n    let prevWeight = Infinity;\n    for (const set of value.values) {\n      if (!validateNonNegativeIntAndSymbolSet(set)) {\n        return false;\n      }\n      const [weight] = extractNonNegativeIntAndSymbolSet(set);\n      // must be in strictly descending weight order\n      if (weight >= prevWeight) {\n        return false;\n      }\n      prevWeight = weight;\n    }\n    return true;\n  }\n  return false;\n}\ntype AdditiveSymbol = Readonly<{ weight: number; symbol: string }>;\nfunction extractAdditiveSymbols(\n  additiveSymbols: AdditiveSymbolsDescriptorValue,\n): readonly [AdditiveSymbol, ...AdditiveSymbol[]] {\n  if (validateNonNegativeIntAndSymbolSet(additiveSymbols)) {\n    const [weight, symbol] = extractNonNegativeIntAndSymbolSet(additiveSymbols);\n    return [{ weight, symbol }];\n  } else {\n    return additiveSymbols.values.map((set) => {\n      const [weight, symbol] = extractNonNegativeIntAndSymbolSet(set);\n      return { weight, symbol };\n    }) as [AdditiveSymbol, ...AdditiveSymbol[]];\n  }\n}\n\nconst speakAsIdentList = [\n  \"auto\",\n  \"bullets\",\n  \"numbers\",\n  \"words\",\n  \"spell-out\",\n] as const;\nconst speakAsIdents: ReadonlySet<(typeof speakAsIdentList)[number]> = new Set(\n  speakAsIdentList,\n);\n\n/**\n * @see https://drafts.csswg.org/css-counter-styles/#descdef-counter-style-speak-as\n */\ntype SpeakAsDescriptorValue =\n  | (Css.Ident & {\n      name: SetElement<typeof speakAsIdents>;\n    })\n  | CounterStyleName;\nfunction validateSpeakAs(value: Css.Val): value is SpeakAsDescriptorValue {\n  return (\n    (value instanceof Css.Ident &&\n      speakAsIdents.has(\n        // @ts-expect-error check membership\n        value.name,\n      )) ||\n    validateCounterStyleName(value)\n  );\n}\n\n/**\n * @see https://drafts.csswg.org/css-counter-styles/\n */\nexport function validateDescriptorValue(name: string, value: Css.Val): boolean {\n  switch (name) {\n    case \"system\":\n      return validateSystem(value);\n    case \"negative\":\n      return validateNegative(value);\n    case \"prefix\":\n    case \"suffix\":\n      return validateSymbol(value);\n    case \"range\":\n      return validateRange(value);\n    case \"pad\":\n      return validatePad(value);\n    case \"fallback\":\n      return validateCounterStyleName(value);\n    case \"symbols\":\n      return validateSymbols(value);\n    case \"additive-symbols\":\n      return validateAdditiveSymbols(value);\n    case \"speak-as\":\n      return validateSpeakAs(value);\n    default:\n      // accept without validation\n      return true;\n  }\n}\n\nfunction getDescriptorValue(\n  descriptors: CssCascade.ElementStyle,\n  name: string,\n): Css.Val | null {\n  const cascadeValue = (\n    descriptors[name] as CssCascade.CascadeValue | undefined\n  )?.value;\n  if (cascadeValue == null) {\n    return null;\n  }\n  return cascadeValue;\n}\n\nfunction isInRange(value: number, range: Range): boolean {\n  // > The range of the counter style is the union of all the ranges defined in the list.\n  return range.some(({ lower, upper }) => value >= lower && value <= upper);\n}\n\ntype CounterStyleStoreMap = Map<string, CounterStyle>;\n\nfunction getDecimal(store: CounterStyleStoreMap): CounterStyle {\n  let decimal = store.get(\"decimal\");\n  if (!decimal) {\n    decimal = CounterStyle.createDecimal(store);\n    store.set(\"decimal\", decimal);\n  }\n  return decimal;\n}\n\nabstract class CounterStyle {\n  protected readonly _store: CounterStyleStoreMap;\n\n  #negative: Negative | null;\n  #prefix: string | null;\n  #suffix: string | null;\n  #range: Range | null;\n  #pad: Pad | null;\n  #fallbackName: string | null;\n  #symbols: readonly [string, ...string[]] | null;\n  #additiveSymbols: readonly [AdditiveSymbol, ...AdditiveSymbol[]] | null;\n\n  protected constructor(\n    store: CounterStyleStoreMap,\n    descriptors: CssCascade.ElementStyle,\n  ) {\n    this._store = store;\n\n    const negative = getDescriptorValue(descriptors, \"negative\");\n    this.#negative =\n      negative && validateNegative(negative) ? extractNegative(negative) : null;\n\n    const prefix = getDescriptorValue(descriptors, \"prefix\");\n    this.#prefix =\n      prefix && validateSymbol(prefix) ? extractSymbol(prefix) : null;\n\n    const suffix = getDescriptorValue(descriptors, \"suffix\");\n    this.#suffix =\n      suffix && validateSymbol(suffix) ? extractSymbol(suffix) : null;\n\n    const range = getDescriptorValue(descriptors, \"range\");\n    this.#range = range && validateRange(range) ? extractRange(range) : null;\n\n    const pad = getDescriptorValue(descriptors, \"pad\");\n    this.#pad = pad && validatePad(pad) ? extractPad(pad) : null;\n\n    const fallbackName = getDescriptorValue(descriptors, \"fallback\");\n    this.#fallbackName =\n      fallbackName && validateCounterStyleName(fallbackName)\n        ? extractCounterStyleName(fallbackName)\n        : null;\n\n    const symbols = getDescriptorValue(descriptors, \"symbols\");\n    this.#symbols =\n      symbols && validateSymbols(symbols) ? extractSymbols(symbols) : null;\n\n    const additiveSymbols = getDescriptorValue(descriptors, \"additive-symbols\");\n    this.#additiveSymbols =\n      additiveSymbols && validateAdditiveSymbols(additiveSymbols)\n        ? extractAdditiveSymbols(additiveSymbols)\n        : null;\n  }\n\n  static create(\n    store: CounterStyleStoreMap,\n    descriptors: CssCascade.ElementStyle,\n  ): CounterStyle {\n    if (isCyclicDescriptors(descriptors)) {\n      return new Cyclic(store, descriptors);\n    }\n    if (isFixedDescriptors(descriptors)) {\n      return new Fixed(store, descriptors);\n    }\n    if (isAlphabeticDescriptors(descriptors)) {\n      return new Alphabetic(store, descriptors);\n    }\n    if (isNumericDescriptors(descriptors)) {\n      return new Numeric(store, descriptors);\n    }\n    if (isAdditiveDescriptors(descriptors)) {\n      return new Additive(store, descriptors);\n    }\n    if (isExtendsDescriptors(descriptors)) {\n      return new Extends(store, descriptors);\n    }\n    // default\n    return new Symbolic(store, descriptors);\n  }\n\n  static readonly #DECIMAL_DESCRIPTORS: CssCascade.ElementStyle = {\n    system: new CssCascade.CascadeValue(Css.getName(\"numeric\"), 0),\n    symbols: new CssCascade.CascadeValue(\n      new Css.SpaceList([\n        new Css.Str(\"0\"),\n        new Css.Str(\"1\"),\n        new Css.Str(\"2\"),\n        new Css.Str(\"3\"),\n        new Css.Str(\"4\"),\n        new Css.Str(\"5\"),\n        new Css.Str(\"6\"),\n        new Css.Str(\"7\"),\n        new Css.Str(\"8\"),\n        new Css.Str(\"9\"),\n      ]),\n      0,\n    ),\n  };\n  static createDecimal(store: CounterStyleStoreMap): CounterStyle {\n    return new Numeric(\n      store,\n      CounterStyle.#DECIMAL_DESCRIPTORS as NumericDescriptors,\n    );\n  }\n\n  static readonly #DISC_DESCRIPTORS: CssCascade.ElementStyle = {\n    system: new CssCascade.CascadeValue(Css.getName(\"cyclic\"), 0),\n    symbols: new CssCascade.CascadeValue(new Css.Str(\"\\u2022\"), 0),\n    suffix: new CssCascade.CascadeValue(new Css.Str(\" \"), 0),\n  };\n  static createDisc(store: CounterStyleStoreMap): CounterStyle {\n    return new Cyclic(\n      store,\n      CounterStyle.#DISC_DESCRIPTORS as CyclicDescriptors,\n    );\n  }\n\n  static readonly #SQUARE_DESCRIPTORS: CssCascade.ElementStyle = {\n    system: new CssCascade.CascadeValue(Css.getName(\"cyclic\"), 0),\n    symbols: new CssCascade.CascadeValue(new Css.Str(\"\\u25AA\"), 0),\n    suffix: new CssCascade.CascadeValue(new Css.Str(\" \"), 0),\n  };\n  static createSquare(store: CounterStyleStoreMap): CounterStyle {\n    return new Cyclic(\n      store,\n      CounterStyle.#SQUARE_DESCRIPTORS as CyclicDescriptors,\n    );\n  }\n\n  static readonly #CIRCLE_DESCRIPTORS: CssCascade.ElementStyle = {\n    system: new CssCascade.CascadeValue(Css.getName(\"cyclic\"), 0),\n    symbols: new CssCascade.CascadeValue(new Css.Str(\"\\u25E6\"), 0),\n    suffix: new CssCascade.CascadeValue(new Css.Str(\" \"), 0),\n  };\n  static createCircle(store: CounterStyleStoreMap): CounterStyle {\n    return new Cyclic(\n      store,\n      CounterStyle.#CIRCLE_DESCRIPTORS as CyclicDescriptors,\n    );\n  }\n\n  static readonly #DISCLOSURE_OPEN_DESCRIPTORS: CssCascade.ElementStyle = {\n    system: new CssCascade.CascadeValue(Css.getName(\"cyclic\"), 0),\n    symbols: new CssCascade.CascadeValue(new Css.Str(\"\\u25BE\"), 0),\n    suffix: new CssCascade.CascadeValue(new Css.Str(\" \"), 0),\n  };\n  static createDisclosureOpen(store: CounterStyleStoreMap): CounterStyle {\n    return new Cyclic(\n      store,\n      CounterStyle.#DISCLOSURE_OPEN_DESCRIPTORS as CyclicDescriptors,\n    );\n  }\n\n  static readonly #DISCLOSURE_CLOSED_DESCRIPTORS: CssCascade.ElementStyle = {\n    system: new CssCascade.CascadeValue(Css.getName(\"cyclic\"), 0),\n    symbols: new CssCascade.CascadeValue(new Css.Str(\"\\u25B8\"), 0),\n    suffix: new CssCascade.CascadeValue(new Css.Str(\" \"), 0),\n  };\n  static createDisclosureClosed(store: CounterStyleStoreMap): CounterStyle {\n    return new Cyclic(\n      store,\n      this.#DISCLOSURE_CLOSED_DESCRIPTORS as CyclicDescriptors,\n    );\n  }\n\n  static readonly #NONE_DESCRIPTORS: CssCascade.ElementStyle = {\n    system: new CssCascade.CascadeValue(Css.getName(\"cyclic\"), 0),\n    symbols: new CssCascade.CascadeValue(new Css.Str(\"\"), 0),\n    suffix: new CssCascade.CascadeValue(new Css.Str(\"\"), 0),\n  };\n  static createNone(store: CounterStyleStoreMap): CounterStyle {\n    return new Cyclic(\n      store,\n      CounterStyle.#NONE_DESCRIPTORS as CyclicDescriptors,\n    );\n  }\n\n  static get CHINESE_LONGHAND_NAMES(): typeof ChineseLonghand.NAMES {\n    return ChineseLonghand.NAMES;\n  }\n  static createChineseLonghand(\n    store: CounterStyleStoreMap,\n    name: SetElement<typeof ChineseLonghand.NAMES>,\n  ): CounterStyle {\n    return new ChineseLonghand(store, name);\n  }\n\n  static createEthiopicNumeric(store: CounterStyleStoreMap): CounterStyle {\n    return new EthiopicNumeric(store);\n  }\n\n  protected _getNegative(): Negative | null {\n    return this.#negative;\n  }\n  protected static _getNegativeFrom(style: CounterStyle): Negative | null {\n    return style._getNegative();\n  }\n  #getNegative(): Negative {\n    return this._getNegative() ?? { prefix: \"-\", suffix: null };\n  }\n\n  protected _getPrefix(): string | null {\n    return this.#prefix;\n  }\n  protected static _getPrefixFrom(style: CounterStyle): string | null {\n    return style._getPrefix();\n  }\n  #getPrefix(): string {\n    return this._getPrefix() ?? \"\";\n  }\n\n  protected _getSuffix(): string | null {\n    return this.#suffix;\n  }\n  protected static _getSuffixFrom(style: CounterStyle): string | null {\n    return style._getSuffix();\n  }\n  #getSuffix(): string {\n    return this._getSuffix() ?? \". \";\n  }\n\n  protected abstract _getAutoRange(): Range;\n  protected static _getAutoRangeFrom(style: CounterStyle): Range {\n    return style._getAutoRange();\n  }\n  protected _getRange(): Range | null {\n    return this.#range;\n  }\n  protected static _getRangeFrom(style: CounterStyle): Range | null {\n    return style._getRange();\n  }\n  #getRange(): Range {\n    return this._getRange() ?? this._getAutoRange();\n  }\n\n  protected _getPad(): Pad | null {\n    return this.#pad;\n  }\n  protected static _getPadFrom(style: CounterStyle): Pad | null {\n    return style._getPad();\n  }\n  #getPad(): Pad {\n    return this._getPad() ?? { minLength: 0, symbol: \"\" };\n  }\n\n  protected _getFallback(): CounterStyle | null {\n    return this._store.get(this.#fallbackName) ?? null;\n  }\n  protected static _getFallbackFrom(style: CounterStyle): CounterStyle | null {\n    return style._getFallback();\n  }\n  #getFallback(): CounterStyle {\n    return this._getFallback() ?? getDecimal(this._store);\n  }\n\n  protected _getSymbols(): readonly [string, ...string[]] | null {\n    return this.#symbols;\n  }\n  protected static _getSymbolsFrom(\n    style: CounterStyle,\n  ): readonly [string, ...string[]] | null {\n    return style._getSymbols();\n  }\n\n  protected _getAdditiveSymbols():\n    | readonly [AdditiveSymbol, ...AdditiveSymbol[]]\n    | null {\n    return this.#additiveSymbols;\n  }\n  protected static _getAdditiveSymbolsFrom(\n    style: CounterStyle,\n  ): readonly [AdditiveSymbol, ...AdditiveSymbol[]] | null {\n    return style._getAdditiveSymbols();\n  }\n\n  /**\n   * @see https://drafts.csswg.org/css-counter-styles-3/#generate-a-counter\n   * @see https://drafts.csswg.org/css-counter-styles-3/#counter-style-pad\n   */\n  #applyPadding(initialRep: string, usesNegative: boolean): string {\n    const { minLength, symbol: padSymbol } = this.#getPad();\n    if (minLength === 0 || padSymbol === \"\") {\n      return initialRep;\n    }\n\n    const { prefix: negPrefix, suffix: negSuffix } = this.#getNegative();\n    const negativeLength = usesNegative\n      ? [...negPrefix].length + (negSuffix ? [...negSuffix].length : 0)\n      : 0;\n\n    const diff = minLength - [...initialRep].length - negativeLength;\n    if (diff <= 0) {\n      return initialRep;\n    }\n\n    const padLength = [...padSymbol].length;\n    const count = Math.ceil(diff / padLength);\n    return padSymbol.repeat(count) + initialRep;\n  }\n\n  /**\n   * @see https://drafts.csswg.org/css-counter-styles-3/#use-a-negative-sign\n   */\n  protected abstract _usesNegativeSign(value: number): boolean;\n  protected static _useNegativeSignFrom(\n    style: CounterStyle,\n    value: number,\n  ): boolean {\n    return style._usesNegativeSign(value);\n  }\n\n  /**\n   * @see https://drafts.csswg.org/css-counter-styles-3/#generate-a-counter\n   */\n  protected abstract _generateInitialRepresentation(\n    value: number,\n  ): string | null;\n  protected static _generateInitialRepresentationFrom(\n    style: CounterStyle,\n    value: number,\n  ): string | null {\n    return style._generateInitialRepresentation(value);\n  }\n\n  /**\n   * Format a counter value to its string representation.\n   * @see https://drafts.csswg.org/css-counter-styles-3/#generate-a-counter\n   */\n  format(value: number): string {\n    return this.#format(value, new Set());\n  }\n  #format(value: number, visited: Set<CounterStyle>): string {\n    // Detect fallback loop\n    if (visited.has(this)) {\n      // Clear the visited set when falling back to decimal to avoid infinite recursion\n      return getDecimal(this._store).#format(value, new Set());\n    }\n    visited.add(this);\n\n    if (!isInRange(value, this.#getRange())) {\n      const fallback = this.#getFallback();\n      return fallback.#format(value, visited);\n    }\n\n    const usesNegative = this._usesNegativeSign(value);\n    const absValue = usesNegative ? Math.abs(value) : value;\n\n    const initialRep = this._generateInitialRepresentation(absValue);\n    if (initialRep === null) {\n      const fallback = this.#getFallback();\n      return fallback.#format(value, visited);\n    }\n\n    let padded = this.#applyPadding(initialRep, usesNegative);\n\n    if (usesNegative) {\n      const { prefix: negPrefix, suffix: negSuffix } = this.#getNegative();\n      padded = negPrefix + padded + (negSuffix ?? \"\");\n    }\n\n    return padded;\n  }\n\n  /**\n   * Format a counter value with prefix and suffix for use in ::marker.\n   * Unlike format(), this includes the prefix and suffix descriptors.\n   * @see https://drafts.csswg.org/css-counter-styles-3/#counter-style-prefix\n   * @see https://drafts.csswg.org/css-counter-styles-3/#counter-style-suffix\n   */\n  formatMarker(value: number): string {\n    return this.#getPrefix() + this.format(value) + this.#getSuffix();\n  }\n}\n\n/**\n * @see https://drafts.csswg.org/css-counter-styles-3/#cyclic-system\n */\nclass Cyclic extends CounterStyle {\n  constructor(store: CounterStyleStoreMap, descriptors: CyclicDescriptors) {\n    super(store, descriptors);\n  }\n\n  protected override _getAutoRange(): Range {\n    return [{ lower: -Infinity, upper: Infinity }];\n  }\n\n  protected override _usesNegativeSign(_: number): boolean {\n    return false;\n  }\n\n  protected override _generateInitialRepresentation(\n    value: number,\n  ): string | null {\n    const symbols = this._getSymbols();\n    // > If the system is cyclic, the symbols descriptor must contain at least one counter symbol,\n    // > otherwise the rule does not define a counter style (but is still a valid rule).\n    if (!symbols || symbols.length === 0) {\n      return null;\n    }\n    const n = symbols.length;\n    // to get proper mathematical modulo for negative values\n    const idx = (((value - 1) % n) + n) % n;\n    return symbols[idx];\n  }\n}\n\n/**\n * @see https://drafts.csswg.org/css-counter-styles-3/#fixed-system\n */\nclass Fixed extends CounterStyle {\n  #firstSymbolValue: number;\n\n  constructor(store: CounterStyleStoreMap, descriptors: FixedDescriptors) {\n    super(store, descriptors);\n    this.#firstSymbolValue = extractFixedFirstSymbolValue(descriptors);\n  }\n\n  protected override _getAutoRange(): Range {\n    return [{ lower: -Infinity, upper: Infinity }];\n  }\n\n  protected override _usesNegativeSign(_: number): boolean {\n    return false;\n  }\n\n  protected override _generateInitialRepresentation(\n    value: number,\n  ): string | null {\n    const symbols = this._getSymbols();\n    // > If the system is fixed, the symbols descriptor must contain at least one counter symbol,\n    // > otherwise the rule does not define a counter style (but is still a valid rule).\n    if (!symbols || symbols.length === 0) {\n      return null;\n    }\n    const idx = value - this.#firstSymbolValue;\n    return symbols[idx] ?? null;\n  }\n}\n\n/**\n * @see https://drafts.csswg.org/css-counter-styles-3/#symbolic-system\n */\nclass Symbolic extends CounterStyle {\n  // Symbolic is the default system, so it accepts any ElementStyle\n  // (including those without a system descriptor)\n  constructor(store: CounterStyleStoreMap, descriptors: SymbolicDescriptors) {\n    super(store, descriptors);\n  }\n\n  protected override _getAutoRange(): Range {\n    return [{ lower: 1, upper: Infinity }];\n  }\n\n  protected override _usesNegativeSign(value: number): boolean {\n    return value < 0;\n  }\n\n  protected override _generateInitialRepresentation(\n    value: number,\n  ): string | null {\n    const symbols = this._getSymbols();\n    // > If the system is symbolic, the symbols descriptor must contain at least one counter symbol,\n    // > otherwise the rule does not define a counter style (but is still a valid rule).\n    if (!symbols || symbols.length === 0) {\n      return null;\n    }\n    // > This system is defined only over strictly positive counter values.\n    if (value < 1) {\n      return null;\n    }\n    const n = symbols.length;\n    const chosen = symbols[(value - 1) % n];\n    const count = Math.ceil(value / n);\n    return chosen.repeat(count);\n  }\n}\n\n/**\n * @see https://drafts.csswg.org/css-counter-styles-3/#alphabetic-system\n */\nclass Alphabetic extends CounterStyle {\n  constructor(store: CounterStyleStoreMap, descriptors: AlphabeticDescriptors) {\n    super(store, descriptors);\n  }\n\n  protected override _getAutoRange(): Range {\n    return [{ lower: 1, upper: Infinity }];\n  }\n\n  protected override _usesNegativeSign(value: number): boolean {\n    return value < 0;\n  }\n\n  protected override _generateInitialRepresentation(\n    value: number,\n  ): string | null {\n    const symbols = this._getSymbols();\n    // > If the system is alphabetic, the symbols descriptor must contain at least two counter symbols,\n    // > otherwise the rule does not define a counter style (but is still a valid rule).\n    if (!symbols || symbols.length < 2) {\n      return null;\n    }\n    // > This system is defined only over strictly positive counter values.\n    if (value < 1) {\n      return null;\n    }\n    const n = symbols.length;\n    let s = \"\";\n    let v = value;\n    while (v !== 0) {\n      v = v - 1;\n      s = symbols[v % n] + s;\n      v = Math.floor(v / n);\n    }\n    return s;\n  }\n}\n\n/**\n * @see https://drafts.csswg.org/css-counter-styles-3/#numeric-system\n */\nclass Numeric extends CounterStyle {\n  constructor(store: CounterStyleStoreMap, descriptors: NumericDescriptors) {\n    super(store, descriptors);\n  }\n\n  protected override _getAutoRange(): Range {\n    return [{ lower: -Infinity, upper: Infinity }];\n  }\n\n  protected override _usesNegativeSign(value: number): boolean {\n    return value < 0;\n  }\n\n  protected override _generateInitialRepresentation(\n    value: number,\n  ): string | null {\n    const symbols = this._getSymbols();\n    // > If the system is numeric, the symbols descriptor must contain at least two counter symbols,\n    // > otherwise the rule does not define a counter style (but is still a valid rule).\n    if (!symbols || symbols.length < 2) {\n      return null;\n    }\n    const n = symbols.length;\n    if (value === 0) {\n      return symbols[0];\n    }\n    let s = \"\";\n    let v = value;\n    while (v !== 0) {\n      s = symbols[v % n] + s;\n      v = Math.floor(v / n);\n    }\n    return s;\n  }\n}\n\n/**\n * @see https://drafts.csswg.org/css-counter-styles-3/#additive-system\n */\nclass Additive extends CounterStyle {\n  constructor(store: CounterStyleStoreMap, descriptors: AdditiveDescriptors) {\n    super(store, descriptors);\n  }\n\n  protected override _getAutoRange(): Range {\n    return [{ lower: 0, upper: Infinity }];\n  }\n\n  protected override _usesNegativeSign(value: number): boolean {\n    return value < 0;\n  }\n\n  protected override _generateInitialRepresentation(\n    value: number,\n  ): string | null {\n    const tuples = this._getAdditiveSymbols();\n    // > If the system is additive, the additive-symbols descriptor must contain at least one additive tuple,\n    // > otherwise the rule does not define a counter style (but is still a valid rule).\n    if (!tuples || tuples.length === 0) {\n      return null;\n    }\n\n    let s = \"\";\n\n    if (value === 0) {\n      const zeroTuple = tuples.find((t) => t.weight === 0);\n      return zeroTuple ? zeroTuple.symbol : null;\n    }\n\n    let remaining = value;\n    for (const tuple of tuples) {\n      const { weight, symbol } = tuple;\n      if (weight === 0 || weight > remaining) {\n        continue;\n      }\n      const reps = Math.floor(remaining / weight);\n      s += symbol.repeat(reps);\n      remaining -= weight * reps;\n      if (remaining === 0) {\n        return s;\n      }\n    }\n\n    return null;\n  }\n}\n\n/**\n * @see https://drafts.csswg.org/css-counter-styles/#extends-system\n */\nclass Extends extends CounterStyle {\n  #baseName: string;\n\n  constructor(store: CounterStyleStoreMap, descriptors: ExtendsDescriptors) {\n    super(store, descriptors);\n    const baseName = extractExtendsBaseName(descriptors);\n    // > If the specified <counter-style-name> is an ASCII case-insensitive match\n    // > for disc, circle, square, disclosure-open, or disclosure-closed ...\n    const lowerName = baseName.toLowerCase();\n    if (\n      lowerName === \"disc\" ||\n      lowerName === \"circle\" ||\n      lowerName === \"square\" ||\n      lowerName === \"disclosure-open\" ||\n      lowerName === \"disclosure-closed\"\n    ) {\n      this.#baseName = lowerName;\n    } else {\n      this.#baseName = baseName;\n    }\n  }\n\n  #resolveBaseStyle(visited: Set<CounterStyle> = new Set()): CounterStyle {\n    // Detect cycle\n    if (visited.has(this)) {\n      return getDecimal(this._store);\n    }\n    visited.add(this);\n\n    const targetStyle = this._store.get(this.#baseName);\n    if (!targetStyle) {\n      return getDecimal(this._store);\n    }\n\n    if (targetStyle instanceof Extends) {\n      return targetStyle.#resolveBaseStyle(visited);\n    }\n\n    return targetStyle;\n  }\n\n  protected override _getNegative(): Negative | null {\n    return (\n      super._getNegative() ??\n      CounterStyle._getNegativeFrom(this.#resolveBaseStyle())\n    );\n  }\n\n  protected override _getPrefix(): string | null {\n    return (\n      super._getPrefix() ??\n      CounterStyle._getPrefixFrom(this.#resolveBaseStyle())\n    );\n  }\n\n  protected override _getSuffix(): string | null {\n    return (\n      super._getSuffix() ??\n      CounterStyle._getSuffixFrom(this.#resolveBaseStyle())\n    );\n  }\n\n  protected override _getAutoRange(): Range {\n    return CounterStyle._getAutoRangeFrom(this.#resolveBaseStyle());\n  }\n  protected override _getRange(): Range | null {\n    return (\n      super._getRange() ?? CounterStyle._getRangeFrom(this.#resolveBaseStyle())\n    );\n  }\n\n  protected override _getPad(): Pad | null {\n    return (\n      super._getPad() ?? CounterStyle._getPadFrom(this.#resolveBaseStyle())\n    );\n  }\n\n  protected override _getFallback(): CounterStyle | null {\n    return (\n      super._getFallback() ??\n      CounterStyle._getFallbackFrom(this.#resolveBaseStyle())\n    );\n  }\n\n  protected override _getSymbols(): readonly [string, ...string[]] | null {\n    return (\n      super._getSymbols() ??\n      CounterStyle._getSymbolsFrom(this.#resolveBaseStyle())\n    );\n  }\n\n  protected override _getAdditiveSymbols():\n    | readonly [AdditiveSymbol, ...AdditiveSymbol[]]\n    | null {\n    return (\n      super._getAdditiveSymbols() ??\n      CounterStyle._getAdditiveSymbolsFrom(this.#resolveBaseStyle())\n    );\n  }\n\n  protected override _usesNegativeSign(value: number): boolean {\n    return CounterStyle._useNegativeSignFrom(this.#resolveBaseStyle(), value);\n  }\n\n  protected override _generateInitialRepresentation(\n    value: number,\n  ): string | null {\n    // > If a @counter-style uses the extends system, it must not contain a symbols or additive-symbols descriptor,\n    // > otherwise the rule does not define a counter style (but is still a valid rule).\n    if (super._getSymbols() || super._getAdditiveSymbols()) {\n      return null;\n    }\n\n    return CounterStyle._generateInitialRepresentationFrom(\n      this.#resolveBaseStyle(),\n      value,\n    );\n  }\n}\n\ntype ChineseLonghandSetting = Readonly<{\n  chars: Readonly<{\n    digits: readonly [\n      string,\n      string,\n      string,\n      string,\n      string,\n      string,\n      string,\n      string,\n      string,\n      string,\n    ];\n    markers: readonly [string, string, string, string];\n    informal: boolean;\n  }>;\n  descriptors: CssCascade.ElementStyle;\n}>;\n\nconst chineseLonghandNameList = [\n  \"simp-chinese-informal\",\n  \"simp-chinese-formal\",\n  \"trad-chinese-informal\",\n  \"trad-chinese-formal\",\n  \"cjk-ideographic\",\n] as const;\n\n/**\n * @see https://drafts.csswg.org/css-counter-styles-3/#limited-chinese\n */\nclass ChineseLonghand extends CounterStyle {\n  static readonly #SIMP_CHINESE_INFORMAL: ChineseLonghandSetting = {\n    chars: {\n      digits: [\n        \"\\u96F6\",\n        \"\\u4E00\",\n        \"\\u4E8C\",\n        \"\\u4E09\",\n        \"\\u56DB\",\n        \"\\u4E94\",\n        \"\\u516D\",\n        \"\\u4E03\",\n        \"\\u516B\",\n        \"\\u4E5D\",\n      ],\n      markers: [\"\", \"\\u5341\", \"\\u767E\", \"\\u5343\"],\n      informal: true,\n    },\n    descriptors: {\n      suffix: new CssCascade.CascadeValue(new Css.Str(\"\\u3001\"), 0),\n      fallback: new CssCascade.CascadeValue(Css.getName(\"cjk-decimal\"), 0),\n      range: new CssCascade.CascadeValue(\n        new Css.SpaceList([new Css.Int(-9999), new Css.Int(9999)]),\n        0,\n      ),\n      negative: new CssCascade.CascadeValue(new Css.Str(\"\\u8D1F\"), 0),\n    },\n  };\n  static readonly #SIMP_CHINESE_FORMAL: ChineseLonghandSetting = {\n    chars: {\n      digits: [\n        \"\\u96F6\",\n        \"\\u58F9\",\n        \"\\u8D30\",\n        \"\\u53C1\",\n        \"\\u8086\",\n        \"\\u4F0D\",\n        \"\\u9646\",\n        \"\\u67D2\",\n        \"\\u634C\",\n        \"\\u7396\",\n      ],\n      markers: [\"\", \"\\u62FE\", \"\\u4F70\", \"\\u4EDF\"],\n      informal: false,\n    },\n    descriptors: {\n      suffix: new CssCascade.CascadeValue(new Css.Str(\"\\u3001\"), 0),\n      fallback: new CssCascade.CascadeValue(Css.getName(\"cjk-decimal\"), 0),\n      range: new CssCascade.CascadeValue(\n        new Css.SpaceList([new Css.Int(-9999), new Css.Int(9999)]),\n        0,\n      ),\n      negative: new CssCascade.CascadeValue(new Css.Str(\"\\u8D1F\"), 0),\n    },\n  };\n  static readonly #TRAD_CHINESE_INFORMAL: ChineseLonghandSetting = {\n    chars: {\n      digits: [\n        \"\\u96F6\",\n        \"\\u4E00\",\n        \"\\u4E8C\",\n        \"\\u4E09\",\n        \"\\u56DB\",\n        \"\\u4E94\",\n        \"\\u516D\",\n        \"\\u4E03\",\n        \"\\u516B\",\n        \"\\u4E5D\",\n      ],\n      markers: [\"\", \"\\u5341\", \"\\u767E\", \"\\u5343\"],\n      informal: true,\n    },\n    descriptors: {\n      suffix: new CssCascade.CascadeValue(new Css.Str(\"\\u3001\"), 0),\n      fallback: new CssCascade.CascadeValue(Css.getName(\"cjk-decimal\"), 0),\n      range: new CssCascade.CascadeValue(\n        new Css.SpaceList([new Css.Int(-9999), new Css.Int(9999)]),\n        0,\n      ),\n      negative: new CssCascade.CascadeValue(new Css.Str(\"\\u8CA0\"), 0),\n    },\n  };\n  static readonly #TRAD_CHINESE_FORMAL: ChineseLonghandSetting = {\n    chars: {\n      digits: [\n        \"\\u96F6\",\n        \"\\u58F9\",\n        \"\\u8CB3\",\n        \"\\u53C3\",\n        \"\\u8086\",\n        \"\\u4F0D\",\n        \"\\u9678\",\n        \"\\u67D2\",\n        \"\\u634C\",\n        \"\\u7396\",\n      ],\n      markers: [\"\", \"\\u62FE\", \"\\u4F70\", \"\\u4EDF\"],\n      informal: false,\n    },\n    descriptors: {\n      suffix: new CssCascade.CascadeValue(new Css.Str(\"\\u3001\"), 0),\n      fallback: new CssCascade.CascadeValue(Css.getName(\"cjk-decimal\"), 0),\n      range: new CssCascade.CascadeValue(\n        new Css.SpaceList([new Css.Int(-9999), new Css.Int(9999)]),\n        0,\n      ),\n      negative: new CssCascade.CascadeValue(new Css.Str(\"\\u8CA0\"), 0),\n    },\n  };\n  static readonly NAMES: ReadonlySet<(typeof chineseLonghandNameList)[number]> =\n    new Set(chineseLonghandNameList);\n  static readonly #SETTINGS: ReadonlyMap<\n    SetElement<typeof ChineseLonghand.NAMES>,\n    ChineseLonghandSetting\n  > = new Map([\n    [\"simp-chinese-informal\", ChineseLonghand.#SIMP_CHINESE_INFORMAL],\n    [\"simp-chinese-formal\", ChineseLonghand.#SIMP_CHINESE_FORMAL],\n    [\"trad-chinese-informal\", ChineseLonghand.#TRAD_CHINESE_INFORMAL],\n    [\"trad-chinese-formal\", ChineseLonghand.#TRAD_CHINESE_FORMAL],\n    // > This counter style is identical to trad-chinese-informal. (It exists for legacy reasons.)\n    [\"cjk-ideographic\", ChineseLonghand.#TRAD_CHINESE_INFORMAL],\n  ]);\n\n  #chars: ChineseLonghandSetting[\"chars\"];\n\n  constructor(\n    store: CounterStyleStoreMap,\n    name: SetElement<typeof ChineseLonghand.NAMES>,\n  ) {\n    const { chars, descriptors } = ChineseLonghand.#SETTINGS.get(name)!;\n    super(store, descriptors);\n    this.#chars = chars;\n  }\n\n  protected override _getAutoRange(): Range {\n    return [{ lower: -9999, upper: 9999 }];\n  }\n\n  protected override _usesNegativeSign(value: number): boolean {\n    return value < 0;\n  }\n\n  protected override _generateInitialRepresentation(\n    value: number,\n  ): string | null {\n    const chars = this.#chars;\n\n    // Step 1: If the counter value is 0, return the character for 0\n    if (value === 0) {\n      return chars.digits[0];\n    }\n\n    // Build representation with digit markers\n    // Process each digit from thousands to ones\n    const digits: { digit: number; position: number }[] = [];\n    let pos = 0;\n    let temp = value;\n    while (temp > 0) {\n      digits.unshift({ digit: temp % 10, position: pos });\n      temp = Math.floor(temp / 10);\n      pos++;\n    }\n\n    // For informal styles, if value is 10-19, remove tens digit (leave marker)\n    const removeTensDigit = chars.informal && value >= 10 && value <= 19;\n\n    // Build the result string\n    let result = \"\";\n    let lastWasZero = false;\n\n    for (let i = 0; i < digits.length; i++) {\n      const { digit, position } = digits[i];\n      const isLastDigit = i === digits.length - 1;\n\n      if (digit === 0) {\n        // Collapse consecutive zeros and drop trailing zeros\n        if (!isLastDigit && !lastWasZero) {\n          // Mark that we encountered a zero (will add it if followed by non-zero)\n          lastWasZero = true;\n        }\n      } else {\n        // Add collapsed zero if needed\n        if (lastWasZero) {\n          result += chars.digits[0];\n          lastWasZero = false;\n        }\n\n        // Skip tens digit for informal 10-19\n        if (removeTensDigit && position === 1) {\n          // Add only the marker, not the digit\n          result += chars.markers[position];\n        } else {\n          // Add digit + marker\n          result += chars.digits[digit];\n          if (position > 0) {\n            result += chars.markers[position];\n          }\n        }\n      }\n    }\n\n    return result;\n  }\n}\n\n/**\n * @see https://drafts.csswg.org/css-counter-styles-3/#ethiopic-numeric-counter-style\n */\nclass EthiopicNumeric extends CounterStyle {\n  static readonly #DESCRIPTORS = {\n    range: new CssCascade.CascadeValue(\n      new Css.SpaceList([new Css.Int(1), Css.getName(\"infinite\")]),\n      0,\n    ),\n    suffix: new CssCascade.CascadeValue(new Css.Str(\"/ \"), 0),\n  } as const;\n\n  static readonly #TENS = [\n    \"\", // 0\n    \"\\u1372\", // 10\n    \"\\u1373\", // 20\n    \"\\u1374\", // 30\n    \"\\u1375\", // 40\n    \"\\u1376\", // 50\n    \"\\u1377\", // 60\n    \"\\u1378\", // 70\n    \"\\u1379\", // 80\n    \"\\u137A\", // 90\n  ] as const;\n\n  static readonly #UNITS = [\n    \"\", // 0\n    \"\\u1369\", // 1\n    \"\\u136A\", // 2\n    \"\\u136B\", // 3\n    \"\\u136C\", // 4\n    \"\\u136D\", // 5\n    \"\\u136E\", // 6\n    \"\\u136F\", // 7\n    \"\\u1370\", // 8\n    \"\\u1371\", // 9\n  ] as const;\n\n  static readonly #HUNDRED = \"\\u137B\"; // U+137B (odd index separator / 100)\n  static readonly #TEN_THOUSAND = \"\\u137C\"; // U+137C (even index separator / 10000)\n\n  constructor(store: CounterStyleStoreMap) {\n    super(store, EthiopicNumeric.#DESCRIPTORS);\n  }\n\n  protected override _getAutoRange(): Range {\n    return [{ lower: 1, upper: Infinity }];\n  }\n\n  protected override _usesNegativeSign(_: number): boolean {\n    // > The ethiopic-numeric counter style is defined for all positive non-zero numbers.\n    return false;\n  }\n\n  protected override _generateInitialRepresentation(\n    value: number,\n  ): string | null {\n    // > The ethiopic-numeric counter style is defined for all positive non-zero numbers.\n    if (value < 1) {\n      return null;\n    }\n\n    // Step 1: If the number is 1, return U+1369\n    if (value === 1) {\n      return EthiopicNumeric.#UNITS[1];\n    }\n\n    // Step 2: Split the number into groups of two digits, starting with the least significant\n    const groups: number[] = [];\n    let remaining = value;\n    while (remaining > 0) {\n      groups.push(remaining % 100);\n      remaining = Math.floor(remaining / 100);\n    }\n\n    // groups[0] is least significant, groups[length-1] is most significant\n    const numGroups = groups.length;\n\n    // Build output from most significant to least significant\n    let result = \"\";\n    for (let i = numGroups - 1; i >= 0; i--) {\n      const groupValue = groups[i];\n      const isOddIndex = i % 2 === 1;\n      const isMostSignificant = i === numGroups - 1;\n\n      // Step 4: Determine if digits should be removed\n      // - If the group has the value zero\n      // - If the group is the most significant one and has the value 1\n      // - If the group has an odd index and has the value 1\n      const removeDigits =\n        groupValue === 0 ||\n        (isMostSignificant && groupValue === 1) ||\n        (isOddIndex && groupValue === 1);\n\n      // Step 5: For each remaining digit, substitute the relevant ethiopic character\n      if (!removeDigits) {\n        const tens = Math.floor(groupValue / 10);\n        const units = groupValue % 10;\n        result += EthiopicNumeric.#TENS[tens] + EthiopicNumeric.#UNITS[units];\n      }\n\n      // Step 6 & 7: Append separators\n      if (isOddIndex) {\n        // Step 6: For odd index groups, except those with original value 0, append U+137B\n        if (groupValue !== 0) {\n          result += EthiopicNumeric.#HUNDRED;\n        }\n      } else {\n        // Step 7: For even index groups, except group 0, append U+137C\n        if (i !== 0) {\n          result += EthiopicNumeric.#TEN_THOUSAND;\n        }\n      }\n    }\n\n    return result;\n  }\n}\n\nexport class CounterStyleStore {\n  #store: CounterStyleStoreMap;\n\n  constructor() {\n    this.#store = new Map();\n\n    this.#store.set(\"none\", CounterStyle.createNone(this.#store));\n\n    // non-overridable counter-style names\n    // https://drafts.csswg.org/css-counter-styles/#non-overridable-counter-style-names\n    this.#store.set(\"decimal\", CounterStyle.createDecimal(this.#store));\n    this.#store.set(\"disc\", CounterStyle.createDisc(this.#store));\n    this.#store.set(\"square\", CounterStyle.createSquare(this.#store));\n    this.#store.set(\"circle\", CounterStyle.createCircle(this.#store));\n    this.#store.set(\n      \"disclosure-open\",\n      CounterStyle.createDisclosureOpen(this.#store),\n    );\n    this.#store.set(\n      \"disclosure-closed\",\n      CounterStyle.createDisclosureClosed(this.#store),\n    );\n\n    // Chinese longhand styles\n    // https://drafts.csswg.org/css-counter-styles/#limited-chinese\n    for (const name of CounterStyle.CHINESE_LONGHAND_NAMES) {\n      this.#store.set(\n        name,\n        CounterStyle.createChineseLonghand(this.#store, name),\n      );\n    }\n\n    // Ethiopic numeric counter style\n    // https://drafts.csswg.org/css-counter-styles/#ethiopic-numeric-counter-style\n    this.#store.set(\n      \"ethiopic-numeric\",\n      CounterStyle.createEthiopicNumeric(this.#store),\n    );\n  }\n\n  define(\n    name: string,\n    descriptors: CssCascade.ElementStyle,\n  ): CounterStyle | null {\n    if (!validateNameForDefinition(name)) {\n      return null;\n    }\n    const counterStyle = CounterStyle.create(this.#store, descriptors);\n    this.#store.set(name, counterStyle);\n    return counterStyle;\n  }\n\n  getStyle(name: string): CounterStyle | null {\n    return this.#store.get(name) ?? null;\n  }\n\n  /**\n   * Format a counter value using the specified counter style.\n   * @see https://drafts.csswg.org/css-counter-styles/\n   */\n  format(name: string, value: number): string {\n    return (this.getStyle(name) ?? getDecimal(this.#store)).format(value);\n  }\n\n  /**\n   * Format a counter value with prefix and suffix for use in ::marker.\n   * Not yet in use, but will be used in the future. #732\n   * @see https://drafts.csswg.org/css-counter-styles/\n   */\n  formatMarker(name: string, value: number): string {\n    return (this.getStyle(name) ?? getDecimal(this.#store)).formatMarker(value);\n  }\n}\n", "/**\n * Copyright 2013 Google, Inc.\n * Copyright 2015 Daishinsha Inc.\n * Copyright 2019 Vivliostyle Foundation\n *\n * Vivliostyle.js is free software: you can redistribute it and/or modify\n * it under the terms of the GNU Affero General Public License as published by\n * the Free Software Foundation, either version 3 of the License, or\n * (at your option) any later version.\n *\n * Vivliostyle.js is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n * GNU Affero General Public License for more details.\n *\n * You should have received a copy of the GNU Affero General Public License\n * along with Vivliostyle.js.  If not, see <http://www.gnu.org/licenses/>.\n *\n * @fileoverview CssStyler - Apply CSS cascade to a document incrementally and\n * cache the result.\n */\nimport * as Asserts from \"./asserts\";\nimport * as Base from \"./base\";\nimport * as Break from \"./break\";\nimport * as CounterStyle from \"./counter-style\";\nimport * as Css from \"./css\";\nimport * as CssCascade from \"./css-cascade\";\nimport * as CssParser from \"./css-parser\";\nimport * as CssProp from \"./css-prop\";\nimport * as CssValidator from \"./css-validator\";\nimport * as Display from \"./display\";\nimport * as Exprs from \"./exprs\";\nimport * as Vtree from \"./vtree\";\nimport { CssStyler, XmlDoc } from \"./types\";\n\nexport class SlipRange {\n  endStuckFixed: number;\n  endFixed: number;\n  endSlipped: number;\n\n  constructor(endStuckFixed, endFixed, endSlipped) {\n    this.endStuckFixed = endStuckFixed;\n    this.endFixed = endFixed;\n    this.endSlipped = endSlipped;\n  }\n}\n\n/**\n * Maps all ints in a range (\"fixed\") to ints with slippage (\"slipped\")\n */\nexport class SlipMap {\n  map = [] as SlipRange[];\n\n  getMaxFixed(): number {\n    if (this.map.length == 0) {\n      return 0;\n    }\n    const range = this.map[this.map.length - 1];\n    return range.endFixed;\n  }\n\n  getMaxSlipped(): number {\n    if (this.map.length == 0) {\n      return 0;\n    }\n    const range = this.map[this.map.length - 1];\n    return range.endSlipped;\n  }\n\n  addStuckRange(endFixed: number): void {\n    if (this.map.length == 0) {\n      this.map.push(new SlipRange(endFixed, endFixed, endFixed));\n    } else {\n      const range = this.map[this.map.length - 1];\n      const endSlipped = range.endSlipped + endFixed - range.endFixed;\n      if (range.endFixed == range.endStuckFixed) {\n        range.endFixed = endFixed;\n        range.endStuckFixed = endFixed;\n        range.endSlipped = endSlipped;\n      } else {\n        this.map.push(new SlipRange(endFixed, endFixed, endSlipped));\n      }\n    }\n  }\n\n  addSlippedRange(endFixed: number): void {\n    if (this.map.length == 0) {\n      this.map.push(new SlipRange(endFixed, 0, 0));\n    } else {\n      this.map[this.map.length - 1].endFixed = endFixed;\n    }\n  }\n\n  slippedByFixed(fixed: number): number {\n    const index = Base.binarySearch(\n      this.map.length,\n      (index) => fixed <= this.map[index].endFixed,\n    );\n    const range = this.map[index];\n    return range.endSlipped - Math.max(0, range.endStuckFixed - fixed);\n  }\n\n  /**\n   * Smallest fixed for a given slipped.\n   */\n  fixedBySlipped(slipped: number): number {\n    const index = Base.binarySearch(\n      this.map.length,\n      (index) => slipped <= this.map[index].endSlipped,\n    );\n    const range = this.map[index];\n    return range.endStuckFixed - (range.endSlipped - slipped);\n  }\n}\n\nexport interface FlowListener {\n  encounteredFlowChunk(flowChunk: Vtree.FlowChunk, flow: Vtree.Flow): void;\n}\n\nexport interface AbstractStyler extends CssStyler.AbstractStyler {}\n\n/**\n * Represent a box generated by a (pseudo)element. When constructed, a box\n * corresponding to `::before` pseudoelement is also constructed and stored in\n * `beforeBox` property, whereas one corresponding `::after` pseudoelement is\n * not constructed and `afterBox` property is `null`. `afterBox` is constructed\n * by `buildAfterPseudoElementBox` method.\n * @param style Cascaded style values for the box.\n * @param offset The start offset of the box. It coincides with the start offset\n *     of the element if the box is generated by the element or the `::before`\n *     pseudoelement. When the box corresponds to the `::after` pseudoelement,\n *     the offset is just after the content before the `::after` pseudoelement.\n * @param isRoot True if the box is generated by the root element (not\n *     pseudoelement).\n * @param flowChunk FlowChunk to which the box belongs to.\n * @param atBlockStart True if the box is right after the block start edge.\n * @param atFlowStart True if the box is right after the flow start.\n * @param isParentBoxDisplayed True if the parent box has a displayed box.\n */\nexport class Box {\n  flowName: string;\n  isBlockValue: boolean | null = null;\n  hasBoxValue: boolean | null = null;\n  styleValues = {} as { [key: string]: Css.Val };\n  beforeBox: Box = null;\n  afterBox: Box = null;\n  breakBefore: string | null = null;\n\n  constructor(\n    public readonly context: Exprs.Context,\n    public readonly style: CssCascade.ElementStyle,\n    public readonly offset: number,\n    public readonly isRoot: boolean,\n    public readonly flowChunk: Vtree.FlowChunk,\n    public readonly atBlockStart: boolean,\n    public readonly atFlowStart: boolean,\n    public readonly isParentBoxDisplayed: boolean,\n  ) {\n    this.flowName = flowChunk.flowName;\n    if (this.hasBox()) {\n      const pseudoMap = style[\"_pseudos\"];\n      if (pseudoMap) {\n        if (pseudoMap[\"before\"]) {\n          const beforeBox = new Box(\n            context,\n            pseudoMap[\"before\"],\n            offset,\n            false,\n            flowChunk,\n            this.isBlock(),\n            atFlowStart,\n            true,\n          );\n          const beforeContent = beforeBox.styleValue(\"content\");\n          if (Vtree.nonTrivialContent(beforeContent)) {\n            this.beforeBox = beforeBox;\n            this.breakBefore = beforeBox.breakBefore;\n          }\n        }\n      }\n    }\n    this.breakBefore = Break.resolveEffectiveBreakValue(\n      this.getBreakValue(\"before\"),\n      this.breakBefore,\n    );\n    if (this.atFlowStart && Break.isForcedBreakValue(this.breakBefore)) {\n      flowChunk.breakBefore = Break.resolveEffectiveBreakValue(\n        flowChunk.breakBefore,\n        this.breakBefore,\n      );\n    }\n  }\n\n  /**\n   * Build a box corresponding to `::after` pseudoelement and stores it in\n   * `afterBox` property.\n   * @param offset The start offset of the `::after` pseudoelement box, which is\n   *     just after the content before the `::after` pseudoelement.\n   * @param atBlockStart True if the box is right after the block start edge.\n   * @param atFlowStart True if the box is right after the flow start.\n   */\n  buildAfterPseudoElementBox(\n    offset: number,\n    atBlockStart: boolean,\n    atFlowStart: boolean,\n  ) {\n    if (this.hasBox()) {\n      const pseudoMap = this.style[\"_pseudos\"];\n      if (pseudoMap) {\n        if (pseudoMap[\"after\"]) {\n          const afterBox = new Box(\n            this.context,\n            pseudoMap[\"after\"],\n            offset,\n            false,\n            this.flowChunk,\n            atBlockStart,\n            atFlowStart,\n            true,\n          );\n          const afterContent = afterBox.styleValue(\"content\");\n          if (Vtree.nonTrivialContent(afterContent)) {\n            this.afterBox = afterBox;\n          }\n        }\n      }\n    }\n  }\n\n  styleValue(name: string, defaultValue?: Css.Val): Css.Val | null {\n    if (!(name in this.styleValues)) {\n      const cv = this.style[name] as CssCascade.CascadeValue;\n      this.styleValues[name] = cv\n        ? cv.evaluate(this.context, name)\n        : defaultValue || null;\n    }\n    return this.styleValues[name];\n  }\n\n  displayValue(): Css.Val {\n    return this.styleValue(\"display\", Css.ident.inline);\n  }\n\n  isBlock(): boolean {\n    if (this.isBlockValue === null) {\n      const display = this.displayValue() as Css.Ident;\n      const position = this.styleValue(\"position\") as Css.Ident;\n      const float = this.styleValue(\"float\") as Css.Ident;\n      this.isBlockValue = Display.isBlock(\n        display,\n        position,\n        float,\n        this.isRoot,\n      );\n    }\n    return this.isBlockValue;\n  }\n\n  hasBox(): boolean {\n    if (this.hasBoxValue === null) {\n      this.hasBoxValue =\n        this.isParentBoxDisplayed &&\n        this.displayValue() !== Css.ident.none &&\n        !Display.isRunning(this.styleValue(\"position\"));\n    }\n    return this.hasBoxValue;\n  }\n\n  getBreakValue(edge: string): string | null {\n    let breakValue: string | null = null;\n    if (this.isBlock()) {\n      const val = this.styleValue(`break-${edge}`);\n      if (val) {\n        breakValue = val.toString();\n      }\n    }\n    return breakValue;\n  }\n}\n\n/**\n * Manages boxes generated by elements as a stack.\n */\nexport class BoxStack {\n  stack = [] as Box[];\n  atBlockStart: boolean = true; // indicates if the next pushed box will be at the block start\n  atFlowStart: boolean = true; // indicates if the next pushed box will be at the flow start\n  atStartStack = [] as { atBlockStart: boolean; atFlowStart: boolean }[]; // pushed when a new flow starts\n\n  constructor(public readonly context: Exprs.Context) {}\n\n  /**\n   * Returns if the stack is empty.\n   */\n  empty(): boolean {\n    return this.stack.length === 0;\n  }\n\n  /**\n   * Returns the last box in the stack.\n   */\n  lastBox(): Box | undefined {\n    return this.stack[this.stack.length - 1];\n  }\n\n  /**\n   * Returns the flow name of the last box in the stack.\n   */\n  lastFlowName(): string | null {\n    const lastBox = this.lastBox();\n    return lastBox ? lastBox.flowChunk.flowName : null;\n  }\n\n  /**\n   * Returns if the last box in the stack is displayed.\n   */\n  isCurrentBoxDisplayed(): boolean {\n    return this.stack.every((box) => box.displayValue() !== Css.ident.none);\n  }\n\n  /**\n   * Create a new box and push it to the stack.\n   * @param style Cascaded style values for the box.\n   * @param offset The start offset of the box.\n   * @param isRoot True if the box is generated by the root element\n   * @param newFlowChunk Specify if the element is a flow element (i.e. the\n   *     element is specified a new `flow-into` value)\n   */\n  push(\n    style: CssCascade.ElementStyle,\n    offset: number,\n    isRoot: boolean,\n    newFlowChunk?: Vtree.FlowChunk,\n  ): Box {\n    const lastBox = this.lastBox();\n    if (newFlowChunk && lastBox && newFlowChunk.flowName !== lastBox.flowName) {\n      this.atStartStack.push({\n        atBlockStart: this.atBlockStart,\n        atFlowStart: this.atFlowStart,\n      });\n    }\n    const flowChunk = newFlowChunk || lastBox.flowChunk;\n    const isAtFlowStart = this.atFlowStart || !!newFlowChunk;\n    const isParentBoxDisplayed = this.isCurrentBoxDisplayed();\n    const box = new Box(\n      this.context,\n      style,\n      offset,\n      isRoot,\n      flowChunk,\n      isAtFlowStart || this.atBlockStart,\n      isAtFlowStart,\n      isParentBoxDisplayed,\n    );\n    this.stack.push(box);\n    this.atBlockStart = box.hasBox()\n      ? !box.beforeBox && box.isBlock()\n      : this.atBlockStart;\n    this.atFlowStart = box.hasBox()\n      ? !box.beforeBox && isAtFlowStart\n      : this.atFlowStart;\n    return box;\n  }\n\n  encounteredTextNode(node: Node) {\n    const box = this.lastBox();\n    if (\n      (node.nodeType === Node.TEXT_NODE ||\n        node.nodeType === Node.CDATA_SECTION_NODE) &&\n      (this.atBlockStart || this.atFlowStart) &&\n      box.hasBox()\n    ) {\n      const whitespaceValue = box\n        .styleValue(\"white-space\", Css.ident.normal)\n        .toString();\n      const whitespace = Vtree.whitespaceFromPropertyValue(whitespaceValue);\n      if (whitespace && !Vtree.canIgnore(node, whitespace)) {\n        this.atBlockStart = false;\n        this.atFlowStart = false;\n      }\n    }\n  }\n\n  /**\n   * Pop the last box.\n   */\n  pop(offset: number): Box {\n    const box = this.stack.pop();\n    box.buildAfterPseudoElementBox(offset, this.atBlockStart, this.atFlowStart);\n    if (this.atFlowStart && box.afterBox) {\n      const breakBefore = box.afterBox.getBreakValue(\"before\");\n      box.flowChunk.breakBefore = Break.resolveEffectiveBreakValue(\n        box.flowChunk.breakBefore,\n        breakBefore,\n      );\n    }\n    const parent = this.lastBox();\n    if (parent) {\n      if (parent.flowName === box.flowName) {\n        if (box.hasBox()) {\n          this.atBlockStart = this.atFlowStart = false;\n        }\n      } else {\n        const atStart = this.atStartStack.pop();\n        this.atBlockStart = atStart.atBlockStart;\n        this.atFlowStart = atStart.atFlowStart;\n      }\n    }\n    return box;\n  }\n\n  /**\n   * Find the start offset of the nearest block start edge to which the\n   * `break-before` value of the box should be propagated. This method can be\n   * called when after pushing the box into the stack or after popping the box\n   * out of the stack.\n   */\n  nearestBlockStartOffset(box: Box): number {\n    if (!box.atBlockStart) {\n      return box.offset;\n    }\n    let i = this.stack.length - 1;\n    let parent = this.stack[i];\n\n    // When called just after the box is popped out, the last box in the stack\n    // is different from the box and it is the parent of the box. When called\n    // after the box is pushed, the last box in the stack is identical to the\n    // box and the parent of the box is a box right before the specified box.\n    if (parent === box) {\n      i--;\n      parent = this.stack[i];\n    }\n    while (i >= 0) {\n      if (parent.flowName !== box.flowName) {\n        return box.offset;\n      }\n      if (!parent.atBlockStart) {\n        return parent.offset;\n      }\n      if (parent.isRoot) {\n        return parent.offset;\n      }\n      box = parent;\n      parent = this.stack[--i];\n    }\n    throw new Error(\"No block start offset found!\");\n  }\n}\n\nexport class Styler implements AbstractStyler {\n  root: Element;\n  cascadeHolder: CssCascade.Cascade;\n  last: Node;\n  rootStyle = {} as CssCascade.ElementStyle;\n  styleMap: { [key: string]: CssCascade.ElementStyle } = {};\n  flows = {} as { [key: string]: Vtree.Flow };\n  flowChunks = [] as Vtree.FlowChunk[];\n  flowListener: FlowListener = null;\n  flowToReach: string | null = null;\n  idToReach: string | null = null;\n  cascade: CssCascade.CascadeInstance;\n  offsetMap: SlipMap;\n  primary: boolean = true;\n  primaryStack = [] as boolean[];\n  rootBackgroundAssigned: boolean = false;\n  rootLayoutAssigned: boolean = false;\n  lastOffset: number;\n  breakBeforeValues = {} as { [key: number]: string | null };\n  boxStack: BoxStack;\n  bodyReached: boolean = true;\n\n  constructor(\n    public readonly xmldoc: XmlDoc.XMLDocHolder,\n    cascade: CssCascade.Cascade,\n    public readonly scope: Exprs.LexicalScope,\n    public readonly context: Exprs.Context,\n    public readonly primaryFlows: { [key: string]: boolean },\n    public readonly validatorSet: CssValidator.ValidatorSet,\n    public readonly counterListener: CssCascade.CounterListener,\n    counterResolver: CssCascade.CounterResolver,\n    counterStyleStore: CounterStyle.CounterStyleStore,\n  ) {\n    this.root = xmldoc.root;\n    this.cascadeHolder = cascade;\n    this.last = this.root;\n    this.cascade = cascade.createInstance(\n      context,\n      counterListener,\n      counterResolver,\n      xmldoc.lang,\n      counterStyleStore,\n    );\n    this.offsetMap = new SlipMap();\n    const rootOffset = xmldoc.getElementOffset(this.root);\n    this.lastOffset = rootOffset;\n    this.boxStack = new BoxStack(context);\n    this.offsetMap.addStuckRange(rootOffset);\n    const style = this.getAttrStyle(this.root);\n    this.cascade.pushElement(this, this.root, style, rootOffset);\n    this.postprocessTopStyle(style, false);\n    switch (this.root.namespaceURI) {\n      case Base.NS.XHTML:\n        this.bodyReached = false;\n        break;\n    }\n    this.primaryStack.push(true);\n    this.styleMap = {};\n    this.styleMap[`e${rootOffset}`] = style;\n    this.lastOffset++;\n    this.replayFlowElementsFromOffset(-1);\n  }\n\n  hasProp(\n    style: CssCascade.ElementStyle,\n    map: CssValidator.ValueMap,\n    name: string,\n  ): boolean {\n    const cascVal = style[name] as CssCascade.CascadeValue;\n    return cascVal && cascVal.evaluate(this.context) !== map[name];\n  }\n\n  transferPropsToRoot(\n    srcStyle: CssCascade.ElementStyle,\n    map: CssValidator.ValueMap,\n  ): void {\n    for (const pname in map) {\n      const cascval = srcStyle[pname];\n      if (cascval) {\n        this.rootStyle[pname] = cascval;\n        delete srcStyle[pname];\n      } else {\n        const val = map[pname];\n        if (val) {\n          this.rootStyle[pname] = new CssCascade.CascadeValue(\n            val,\n            CssParser.SPECIFICITY_AUTHOR,\n          );\n        }\n      }\n    }\n  }\n\n  /**\n   * Transfer properties that should be applied on the container (partition)\n   * level to this.rootStyle.\n   * @param elemStyle (source) element style\n   */\n  postprocessTopStyle(\n    elemStyle: CssCascade.ElementStyle,\n    isBody: boolean,\n  ): void {\n    if (isBody) {\n      for (const propName of [\"writing-mode\", \"direction\"]) {\n        if (elemStyle[propName] && !(isBody && this.rootStyle[propName])) {\n          // Copy it over, but keep it at the root element as well.\n          this.rootStyle[propName] = elemStyle[propName];\n        }\n      }\n    } else {\n      for (const propName in elemStyle) {\n        if (CssCascade.isInherited(propName)) {\n          this.rootStyle[propName] = elemStyle[propName];\n        }\n      }\n    }\n    if (!this.rootBackgroundAssigned) {\n      const backgroundColor = this.hasProp(\n        elemStyle,\n        this.validatorSet.backgroundProps,\n        \"background-color\",\n      )\n        ? (elemStyle[\"background-color\"] as CssCascade.CascadeValue).evaluate(\n            this.context,\n          )\n        : (null as Css.Val);\n      const backgroundImage = this.hasProp(\n        elemStyle,\n        this.validatorSet.backgroundProps,\n        \"background-image\",\n      )\n        ? (elemStyle[\"background-image\"] as CssCascade.CascadeValue).evaluate(\n            this.context,\n          )\n        : (null as Css.Val);\n      if (\n        (backgroundColor && !Css.isDefaultingValue(backgroundColor)) ||\n        (backgroundImage && !Css.isDefaultingValue(backgroundImage))\n      ) {\n        this.transferPropsToRoot(elemStyle, this.validatorSet.backgroundProps);\n        this.rootBackgroundAssigned = true;\n      }\n    }\n    if (!this.rootLayoutAssigned) {\n      for (let i = 0; i < columnProps.length; i++) {\n        if (\n          this.hasProp(elemStyle, this.validatorSet.layoutProps, columnProps[i])\n        ) {\n          this.transferPropsToRoot(elemStyle, this.validatorSet.layoutProps);\n          this.rootLayoutAssigned = true;\n          break;\n        }\n      }\n    }\n    if (!isBody) {\n      // root element\n      const fontSize = elemStyle[\"font-size\"] as CssCascade.CascadeValue;\n      let isRelativeFontSize = true;\n      if (fontSize && !Css.isDefaultingValue(fontSize.value)) {\n        const val = fontSize.evaluate(this.context);\n        if (val instanceof Css.Numeric) {\n          let px = val.num;\n          switch (val.unit) {\n            case \"em\":\n            case \"rem\":\n              px *= this.context.initialFontSize;\n              break;\n            case \"%\":\n              px *= this.context.initialFontSize / 100;\n              break;\n            case \"lh\":\n            case \"rlh\":\n              px *=\n                (this.context.initialFontSize * Exprs.defaultUnitSizes[\"lh\"]) /\n                Exprs.defaultUnitSizes[\"em\"];\n              break;\n            default: {\n              const unitSize = Exprs.defaultUnitSizes[val.unit];\n              if (unitSize) {\n                px *= unitSize;\n              }\n              isRelativeFontSize = false;\n            }\n          }\n          this.context.rootFontSize = px;\n          this.context.isRelativeRootFontSize = isRelativeFontSize;\n        }\n      }\n      const rootFontSize =\n        this.context.rootFontSize ?? this.context.initialFontSize;\n      const lineHeight = elemStyle[\"line-height\"] as CssCascade.CascadeValue;\n      if (lineHeight && !Css.isDefaultingValue(lineHeight.value)) {\n        const val = lineHeight.evaluate(this.context);\n        if (val instanceof Css.Num) {\n          this.context.rootLineHeight = val.num * rootFontSize;\n        } else if (val instanceof Css.Numeric) {\n          let px = val.num;\n          switch (val.unit) {\n            case \"em\":\n            case \"rem\":\n              px *= rootFontSize;\n              break;\n            case \"%\":\n              px *= rootFontSize / 100;\n              break;\n            case \"lh\":\n            case \"rlh\":\n              px *= this.context.initialFontSize * this.context.pref.lineHeight;\n              break;\n            default: {\n              const unitSize = Exprs.defaultUnitSizes[val.unit];\n              if (unitSize) {\n                px *= unitSize;\n              }\n            }\n          }\n          this.context.rootLineHeight = px;\n        }\n      } else {\n        this.context.rootLineHeight =\n          this.context.fontSize() * this.context.pref.lineHeight;\n      }\n    }\n  }\n\n  getTopContainerStyle(): CssCascade.ElementStyle {\n    let offset = 0;\n    while (!this.bodyReached) {\n      offset += 5000;\n      if (this.styleUntil(offset, 0) == Number.POSITIVE_INFINITY) {\n        break;\n      }\n    }\n    return this.rootStyle;\n  }\n\n  getAttrStyle(elem: Element): CssCascade.ElementStyle {\n    // skip cases in which elements for XML other than HTML or SVG\n    // have 'style' attribute not for CSS declaration\n    if ((elem as any).style instanceof CSSStyleDeclaration) {\n      const styleAttrValue = elem.getAttribute(\"style\");\n      if (styleAttrValue) {\n        return CssCascade.parseStyleAttribute(\n          this.scope,\n          this.validatorSet,\n          this.xmldoc.url,\n          styleAttrValue,\n        );\n      }\n    }\n    return {} as CssCascade.ElementStyle;\n  }\n\n  /**\n   * @return currently reached offset\n   */\n  getReachedOffset(): number {\n    return this.lastOffset;\n  }\n\n  /**\n   * Replay flow elements that were encountered since the given offset\n   */\n  replayFlowElementsFromOffset(offset: number): void {\n    if (offset >= this.lastOffset) {\n      return;\n    }\n    const context = this.context;\n    const rootOffset = this.xmldoc.getElementOffset(this.root);\n    if (offset < rootOffset) {\n      const rootStyle = this.getStyle(this.root, false);\n      Asserts.assert(rootStyle);\n      const flowName = CssCascade.getProp(rootStyle, \"flow-into\");\n      const flowNameStr = flowName\n        ? flowName.evaluate(context, \"flow-into\").toString()\n        : \"body\";\n      const newFlowChunk = this.encounteredFlowElement(\n        flowNameStr,\n        rootStyle,\n        this.root,\n        rootOffset,\n      );\n      if (this.boxStack.empty()) {\n        this.boxStack.push(rootStyle, rootOffset, true, newFlowChunk);\n      }\n    }\n    let node = this.xmldoc.getNodeByOffset(offset);\n    let nodeOffset = this.xmldoc.getNodeOffset(node, 0, false);\n    if (nodeOffset >= this.lastOffset) {\n      return;\n    }\n    while (true) {\n      if (node.nodeType != 1) {\n        nodeOffset += node.textContent.length;\n      } else {\n        const elem = node as Element;\n        if (VIVLIOSTYLE_DEBUG) {\n          if (nodeOffset != this.xmldoc.getElementOffset(elem)) {\n            throw new Error(\"Inconsistent offset\");\n          }\n        }\n        const style = this.getStyle(elem, false);\n        const flowName = style[\"flow-into\"] as CssCascade.CascadeValue;\n        if (flowName) {\n          const flowNameStr = flowName\n            .evaluate(context, \"flow-into\")\n            .toString();\n          this.encounteredFlowElement(flowNameStr, style, elem, nodeOffset);\n        }\n        nodeOffset++;\n      }\n      if (nodeOffset >= this.lastOffset) {\n        break;\n      }\n      let next: Node = node.firstChild;\n      if (next == null) {\n        while (true) {\n          next = node.nextSibling;\n          if (next) {\n            break;\n          }\n          node = node.parentNode;\n          if (node === this.root) {\n            return;\n          }\n        }\n      }\n      node = next;\n    }\n  }\n\n  resetFlowChunkStream(flowListener: FlowListener): void {\n    this.flowListener = flowListener;\n    for (let i = 0; i < this.flowChunks.length; i++) {\n      this.flowListener.encounteredFlowChunk(\n        this.flowChunks[i],\n        this.flows[this.flowChunks[i].flowName],\n      );\n    }\n  }\n\n  styleUntilFlowIsReached(flowName: string) {\n    this.flowToReach = flowName;\n    let offset = 0;\n    while (true) {\n      if (this.flowToReach == null) {\n        break;\n      }\n      offset += 5000;\n      if (this.styleUntil(offset, 0) == Number.POSITIVE_INFINITY) {\n        break;\n      }\n    }\n  }\n\n  styleUntilIdIsReached(id: string) {\n    if (!id) {\n      return;\n    }\n    this.idToReach = id;\n    let offset = 0;\n    while (true) {\n      if (!this.idToReach) {\n        break;\n      }\n      offset += 5000;\n      if (this.styleUntil(offset, 0) === Number.POSITIVE_INFINITY) {\n        break;\n      }\n    }\n    this.idToReach = null;\n  }\n\n  private encounteredFlowElement(\n    flowName: string,\n    style: CssCascade.ElementStyle,\n    elem: Element,\n    startOffset: number,\n  ): Vtree.FlowChunk {\n    let priority = 0;\n    let linger = Number.POSITIVE_INFINITY;\n    let exclusive = false;\n    let repeated = false;\n    let last = false;\n    const optionsCV = style[\"flow-options\"] as CssCascade.CascadeValue;\n    if (optionsCV) {\n      const options = CssProp.toSet(\n        optionsCV.evaluate(this.context, \"flow-options\"),\n      );\n      exclusive = !!options[\"exclusive\"];\n      repeated = !!options[\"static\"];\n      last = !!options[\"last\"];\n    }\n    const lingerCV = style[\"flow-linger\"] as CssCascade.CascadeValue;\n    if (lingerCV) {\n      linger = CssProp.toInt(\n        lingerCV.evaluate(this.context, \"flow-linger\"),\n        Number.POSITIVE_INFINITY,\n      );\n    }\n    const priorityCV = style[\"flow-priority\"] as CssCascade.CascadeValue;\n    if (priorityCV) {\n      priority = CssProp.toInt(\n        priorityCV.evaluate(this.context, \"flow-priority\"),\n        0,\n      );\n    }\n    const breakBefore = this.breakBeforeValues[startOffset] || null;\n    let flow = this.flows[flowName];\n    if (!flow) {\n      const parentFlowName = this.boxStack.lastFlowName();\n      flow = this.flows[flowName] = new Vtree.Flow(flowName, parentFlowName);\n    }\n    const flowChunk = new Vtree.FlowChunk(\n      flowName,\n      elem,\n      startOffset,\n      priority,\n      linger,\n      exclusive,\n      repeated,\n      last,\n      breakBefore,\n    );\n    this.flowChunks.push(flowChunk);\n    if (this.flowToReach == flowName) {\n      this.flowToReach = null;\n    }\n    if (this.flowListener) {\n      this.flowListener.encounteredFlowChunk(flowChunk, flow);\n    }\n    return flowChunk;\n  }\n\n  registerForcedBreakOffset(\n    breakValue: string | null,\n    offset: number,\n    flowName: string,\n  ) {\n    if (Break.isForcedBreakValue(breakValue)) {\n      const forcedBreakOffsets = this.flows[flowName].forcedBreakOffsets;\n      if (\n        forcedBreakOffsets.length === 0 ||\n        forcedBreakOffsets[forcedBreakOffsets.length - 1] < offset\n      ) {\n        forcedBreakOffsets.push(offset);\n      }\n    }\n    const previousValue = this.breakBeforeValues[offset];\n    this.breakBeforeValues[offset] = Break.resolveEffectiveBreakValue(\n      previousValue,\n      breakValue,\n    );\n  }\n\n  /**\n   * @param startOffset current position in the document\n   * @param lookup lookup window size for the next page\n   * @return lookup offset in the document for the next page\n   */\n  styleUntil(startOffset: number, lookup: number): number {\n    let targetSlippedOffset = -1;\n    let slippedOffset: number;\n    if (startOffset <= this.lastOffset) {\n      slippedOffset = this.offsetMap.slippedByFixed(startOffset);\n      targetSlippedOffset = slippedOffset + lookup;\n      if (targetSlippedOffset < this.offsetMap.getMaxSlipped()) {\n        // got to the desired point\n        return this.offsetMap.fixedBySlipped(targetSlippedOffset);\n      }\n    }\n    if (this.last == null) {\n      return Number.POSITIVE_INFINITY;\n    }\n    const context = this.context;\n    while (true) {\n      let next: Node = this.last.firstChild;\n      if (next == null) {\n        while (true) {\n          if (this.last.nodeType == 1) {\n            this.cascade.popElement(this.last as Element);\n            this.primary = this.primaryStack.pop();\n            const box = this.boxStack.pop(this.lastOffset);\n            let breakAfter: string | null = null;\n            if (box.afterBox) {\n              const afterPseudoBreakBefore =\n                box.afterBox.getBreakValue(\"before\");\n              this.registerForcedBreakOffset(\n                afterPseudoBreakBefore,\n                box.afterBox.atBlockStart\n                  ? this.boxStack.nearestBlockStartOffset(box)\n                  : box.afterBox.offset,\n                box.flowName,\n              );\n              breakAfter = box.afterBox.getBreakValue(\"after\");\n            }\n            breakAfter = Break.resolveEffectiveBreakValue(\n              breakAfter,\n              box.getBreakValue(\"after\"),\n            );\n            this.registerForcedBreakOffset(\n              breakAfter,\n              this.lastOffset,\n              box.flowName,\n            );\n          }\n          next = this.last.nextSibling;\n          if (next) {\n            break;\n          }\n          this.last = this.last.parentNode;\n          if (this.last === this.root) {\n            this.last = null;\n            if (startOffset < this.lastOffset) {\n              if (targetSlippedOffset < 0) {\n                slippedOffset = this.offsetMap.slippedByFixed(startOffset);\n                targetSlippedOffset = slippedOffset + lookup;\n              }\n              if (targetSlippedOffset <= this.offsetMap.getMaxSlipped()) {\n                // got to the desired point\n                return this.offsetMap.fixedBySlipped(targetSlippedOffset);\n              }\n            }\n            return Number.POSITIVE_INFINITY;\n          }\n        }\n      }\n      this.last = next;\n      if (this.last.nodeType != 1) {\n        this.lastOffset += this.last.textContent.length;\n        this.boxStack.encounteredTextNode(this.last);\n        if (this.primary) {\n          this.offsetMap.addStuckRange(this.lastOffset);\n        } else {\n          this.offsetMap.addSlippedRange(this.lastOffset);\n        }\n      } else {\n        const elem = this.last as Element;\n        const style = this.getAttrStyle(elem);\n        this.primaryStack.push(this.primary);\n        this.cascade.pushElement(this, elem, style, this.lastOffset);\n        const id =\n          elem.getAttribute(\"id\") || elem.getAttributeNS(Base.NS.XML, \"id\");\n        if (id && id === this.idToReach) {\n          this.idToReach = null;\n        }\n        if (\n          !this.bodyReached &&\n          elem.localName == \"body\" &&\n          elem.parentNode == this.root\n        ) {\n          this.postprocessTopStyle(style, true);\n          this.bodyReached = true;\n        }\n        let box: Box;\n        const flowName = style[\"flow-into\"] as CssCascade.CascadeValue;\n        if (flowName) {\n          const flowNameStr = flowName\n            .evaluate(context, \"flow-into\")\n            .toString();\n          const newFlowChunk = this.encounteredFlowElement(\n            flowNameStr,\n            style,\n            elem,\n            this.lastOffset,\n          );\n          this.primary = !!this.primaryFlows[flowNameStr];\n          box = this.boxStack.push(\n            style,\n            this.lastOffset,\n            elem === this.root,\n            newFlowChunk,\n          );\n        } else {\n          box = this.boxStack.push(style, this.lastOffset, elem === this.root);\n\n          // For not ignoring break-before on :root (issue #666)\n          if (elem === this.xmldoc.body) {\n            box.breakBefore = Break.resolveEffectiveBreakValue(\n              box.flowChunk.breakBefore,\n              box.breakBefore,\n            );\n          }\n        }\n        const blockStartOffset = this.boxStack.nearestBlockStartOffset(box);\n\n        if (blockStartOffset === 0) {\n          // Named page type at first page\n          const pageCV = style[\"page\"] as CssCascade.CascadeValue;\n          const pageType =\n            pageCV &&\n            !Css.isDefaultingValue(pageCV.value) &&\n            pageCV.value.toString();\n          if (pageType && pageType.toLowerCase() !== \"auto\") {\n            this.cascade.firstPageType = pageType;\n          }\n        }\n\n        this.registerForcedBreakOffset(\n          box.breakBefore,\n          blockStartOffset,\n          box.flowName,\n        );\n        if (box.beforeBox) {\n          const beforePseudoBreakAfter = box.beforeBox.getBreakValue(\"after\");\n          this.registerForcedBreakOffset(\n            beforePseudoBreakAfter,\n            box.beforeBox.atBlockStart ? blockStartOffset : box.offset,\n            box.flowName,\n          );\n        }\n        if (this.primary) {\n          if (box.displayValue() === Css.ident.none) {\n            this.primary = false;\n          }\n        }\n        if (VIVLIOSTYLE_DEBUG) {\n          const offset = this.xmldoc.getElementOffset(this.last as Element);\n          if (offset != this.lastOffset) {\n            throw new Error(\"Inconsistent offset\");\n          }\n        }\n        this.styleMap[`e${this.lastOffset}`] = style;\n        this.lastOffset++;\n        if (this.primary) {\n          this.offsetMap.addStuckRange(this.lastOffset);\n        } else {\n          this.offsetMap.addSlippedRange(this.lastOffset);\n        }\n        if (this.bodyReached && blockStartOffset === 0) {\n          // body reached but the named page type at first page is not determined\n          // (Fix for issue #770)\n          continue;\n        }\n        if (startOffset < this.lastOffset) {\n          if (targetSlippedOffset < 0) {\n            slippedOffset = this.offsetMap.slippedByFixed(startOffset);\n            targetSlippedOffset = slippedOffset + lookup;\n          }\n          if (targetSlippedOffset <= this.offsetMap.getMaxSlipped()) {\n            // got to the desired point\n            return this.offsetMap.fixedBySlipped(targetSlippedOffset);\n          }\n        }\n      }\n    }\n  }\n\n  /** @override */\n  getStyle(element: Element, deep: boolean): CssCascade.ElementStyle {\n    let offset = this.xmldoc.getElementOffset(element);\n    const key = `e${offset}`;\n    if (deep) {\n      offset = this.xmldoc.getNodeOffset(element, 0, true);\n    }\n    if (this.lastOffset <= offset) {\n      this.styleUntil(offset, 0);\n    }\n    return this.styleMap[key];\n  }\n\n  /** @override */\n  processContent(\n    element: Element,\n    styles: { [key: string]: Css.Val },\n    nodeContext: Vtree.NodeContext,\n  ) {}\n}\n\nexport const columnProps = [\"column-count\", \"column-width\", \"column-fill\"];\n", "/**\n * Copyright 2013 Google, Inc.\n * Copyright 2015 Daishinsha Inc.\n * Copyright 2019 Vivliostyle Foundation\n *\n * Vivliostyle.js is free software: you can redistribute it and/or modify\n * it under the terms of the GNU Affero General Public License as published by\n * the Free Software Foundation, either version 3 of the License, or\n * (at your option) any later version.\n *\n * Vivliostyle.js is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n * GNU Affero General Public License for more details.\n *\n * You should have received a copy of the GNU Affero General Public License\n * along with Vivliostyle.js.  If not, see <http://www.gnu.org/licenses/>.\n *\n * @fileoverview CssValidator - Parse validation rules (validation.txt), validate\n * properties and shorthands.\n */\nimport * as CounterStyle from \"./counter-style\";\nimport * as Css from \"./css\";\nimport * as CssTokenizer from \"./css-tokenizer\";\nimport * as Base from \"./base\";\nimport { ValidationTxt } from \"./assets\";\nimport { TokenType } from \"./css-tokenizer\";\n\nexport interface PropertyReceiver {\n  unknownProperty(name: string, value: Css.Val): void;\n\n  invalidPropertyValue(name: string, value: Css.Val): void;\n\n  simpleProperty(name: string, value: Css.Val, important): void;\n}\n\nexport class Node {\n  success: Node = null;\n  failure: Node = null;\n  code: number = 0;\n\n  constructor(public validator: PropertyValidator) {}\n\n  isSpecial(): boolean {\n    return this.code != 0;\n  }\n\n  markAsStartGroup(): void {\n    this.code = -1;\n  }\n\n  isStartGroup(): boolean {\n    return this.code == -1;\n  }\n\n  markAsEndGroup(): void {\n    this.code = -2;\n  }\n\n  isEndGroup(): boolean {\n    return this.code == -2;\n  }\n\n  markAsStartAlternate(index: number): void {\n    this.code = 2 * index + 1;\n  }\n\n  isStartAlternate(): boolean {\n    return this.code > 0 && this.code % 2 != 0;\n  }\n\n  markAsEndAlternate(index: number): void {\n    this.code = 2 * index + 2;\n  }\n\n  isEndAlternate(): boolean {\n    return this.code > 0 && this.code % 2 == 0;\n  }\n\n  getAlternate(): number {\n    return Math.floor((this.code - 1) / 2);\n  }\n}\n\nexport class Connection {\n  what: number = -1;\n\n  constructor(\n    public where: number,\n    public success: boolean,\n  ) {}\n}\n\n/**\n * @enum {number}\n */\nexport enum Add {\n  FOLLOW = 1,\n  OPTIONAL,\n  REPEATED,\n  ALTERNATE,\n}\n\n/**\n * A class to build a list validator from other validators.\n */\nexport class ValidatingGroup {\n  nodes: Node[] = [];\n  connections: Connection[] = [];\n  match: number[] = []; // connector indicies\n  nomatch: number[] = []; // connector indicies\n  error: number[] = []; // connector indicies\n  emptyHead: boolean = true;\n\n  connect(arr: number[], nodeIndex: number): void {\n    for (let i = 0; i < arr.length; i++) {\n      this.connections[arr[i]].what = nodeIndex;\n    }\n    arr.splice(0, arr.length);\n  }\n\n  clone(): ValidatingGroup {\n    const group = new ValidatingGroup();\n    for (let i = 0; i < this.nodes.length; i++) {\n      const node = this.nodes[i];\n      const clonedNode = new Node(node.validator);\n      clonedNode.code = node.code;\n      group.nodes.push(clonedNode);\n    }\n    for (let i = 0; i < this.connections.length; i++) {\n      const connection = this.connections[i];\n      const groupConnection = new Connection(\n        connection.where,\n        connection.success,\n      );\n      groupConnection.what = connection.what;\n      group.connections.push(groupConnection);\n    }\n    group.match.push(...this.match);\n    group.nomatch.push(...this.nomatch);\n    group.error.push(...this.error);\n    return group;\n  }\n\n  /**\n   * Add \"special\" validation node to a given array (match, nomatch, or error).\n   * @param start if this a start or the end of a clause/group\n   * @param clause 0 indicates group start/end, otherwise clause index\n   */\n  private addSpecialToArr(arr: number[], start: boolean, clause: number): void {\n    const index = this.nodes.length;\n    const node = new Node(ALWAYS_FAIL);\n    if (clause >= 0) {\n      if (start) {\n        node.markAsStartAlternate(clause);\n      } else {\n        node.markAsEndAlternate(clause);\n      }\n    } else {\n      if (start) {\n        node.markAsStartGroup();\n      } else {\n        node.markAsEndGroup();\n      }\n    }\n    this.nodes.push(node);\n    this.connect(arr, index);\n    const success = new Connection(index, true);\n    const failure = new Connection(index, false);\n    arr.push(this.connections.length);\n    this.connections.push(failure);\n    arr.push(this.connections.length);\n    this.connections.push(success);\n  }\n\n  endSpecialGroup(): void {\n    const arrs = [this.match, this.nomatch, this.error];\n    for (let i = 0; i < arrs.length; i++) {\n      this.addSpecialToArr(arrs[i], false, -1);\n    }\n  }\n\n  startSpecialGroup(): void {\n    if (this.nodes.length) {\n      throw new Error(\"invalid call\");\n    }\n    this.addSpecialToArr(this.match, true, -1);\n  }\n\n  endClause(clause: number): void {\n    this.addSpecialToArr(this.match, false, clause);\n  }\n\n  startClause(clause: number): void {\n    if (this.nodes.length) {\n      throw new Error(\"invalid call\");\n    }\n    const node = new Node(ALWAYS_FAIL);\n    node.markAsStartAlternate(clause);\n    this.nodes.push(node);\n    const success = new Connection(0, true);\n    const failure = new Connection(0, false);\n    this.nomatch.push(this.connections.length);\n    this.connections.push(failure);\n    this.match.push(this.connections.length);\n    this.connections.push(success);\n  }\n\n  addPrimitive(validator: PropertyValidator): void {\n    const index = this.nodes.length;\n    this.nodes.push(new Node(validator));\n    const success = new Connection(index, true);\n    const failure = new Connection(index, false);\n    this.connect(this.match, index);\n    if (this.emptyHead) {\n      // if did not validate -> no match\n      this.nomatch.push(this.connections.length);\n      this.emptyHead = false;\n    } else {\n      // if did not validate -> failure\n      this.error.push(this.connections.length);\n    }\n    this.connections.push(failure);\n    this.match.push(this.connections.length);\n    this.connections.push(success);\n  }\n\n  isSimple(): boolean {\n    return this.nodes.length == 1 && !this.nodes[0].isSpecial();\n  }\n\n  isPrimitive(): boolean {\n    return (\n      this.isSimple() && this.nodes[0].validator instanceof PrimitiveValidator\n    );\n  }\n\n  addGroup(group: ValidatingGroup, how: Add): void {\n    if (group.nodes.length == 0) {\n      return;\n    }\n    const index = this.nodes.length;\n\n    // optimization for alternate primitive validators\n    if (\n      how == Add.ALTERNATE &&\n      index == 1 &&\n      group.isPrimitive() &&\n      this.isPrimitive()\n    ) {\n      this.nodes[0].validator = (\n        this.nodes[0].validator as PrimitiveValidator\n      ).combine(group.nodes[0].validator as PrimitiveValidator);\n      return;\n    }\n    for (let i = 0; i < group.nodes.length; i++) {\n      this.nodes.push(group.nodes[i]);\n    }\n\n    // nodes[index] is group start\n    if (how == Add.ALTERNATE) {\n      this.emptyHead = true;\n      this.connect(this.nomatch, index);\n    } else {\n      this.connect(this.match, index);\n    }\n    const connectionIndex = this.connections.length;\n    for (let i = 0; i < group.connections.length; i++) {\n      const connection = group.connections[i];\n      connection.where += index;\n      if (connection.what >= 0) {\n        connection.what += index;\n      }\n      this.connections.push(connection);\n    }\n    for (let i = 0; i < group.match.length; i++) {\n      this.match.push(group.match[i] + connectionIndex);\n    }\n    if (how == Add.REPEATED) {\n      this.connect(this.match, index);\n    }\n    if (how == Add.OPTIONAL || how == Add.REPEATED) {\n      for (let i = 0; i < group.nomatch.length; i++) {\n        this.match.push(group.nomatch[i] + connectionIndex);\n      }\n    } else if (this.emptyHead) {\n      for (let i = 0; i < group.nomatch.length; i++) {\n        this.nomatch.push(group.nomatch[i] + connectionIndex);\n      }\n      this.emptyHead = group.emptyHead;\n    } else {\n      for (let i = 0; i < group.nomatch.length; i++) {\n        this.error.push(group.nomatch[i] + connectionIndex);\n      }\n    }\n    for (let i = 0; i < group.error.length; i++) {\n      this.error.push(group.error[i] + connectionIndex);\n    }\n\n    // invalidate group\n    group.nodes = null;\n    group.connections = null;\n  }\n\n  /**\n   * @return how\n   */\n  finish(successTerminal: Node, failTerminal: Node): Node {\n    const index = this.nodes.length;\n    this.nodes.push(successTerminal);\n    this.nodes.push(failTerminal);\n    this.connect(this.match, index);\n    this.connect(this.nomatch, index + 1);\n    this.connect(this.error, index + 1);\n    for (const connection of this.connections) {\n      if (connection.success) {\n        this.nodes[connection.where].success = this.nodes[connection.what];\n      } else {\n        this.nodes[connection.where].failure = this.nodes[connection.what];\n      }\n    }\n\n    // make sure that our data structure is correct\n    for (let j = 0; j < index; j++) {\n      if (this.nodes[j].failure == null || this.nodes[j].success == null) {\n        throw new Error(\"Invalid validator state\");\n      }\n    }\n    return this.nodes[0];\n  }\n}\n\nexport const ALLOW_EMPTY = 0x01;\n\nexport const ALLOW_STR = 0x02;\n\nexport const ALLOW_IDENT = 0x04;\n\nexport const ALLOW_POS_NUMERIC = 0x08;\n\nexport const ALLOW_POS_NUM = 0x10;\n\nexport const ALLOW_POS_INT = 0x20;\n\nexport const ALLOW_COLOR = 0x40;\n\nexport const ALLOW_URL = 0x80;\n\nexport const ALLOW_NEGATIVE = 0x100;\n\nexport const ALLOW_ZERO = 0x200;\n\nexport const ALLOW_ZERO_PERCENT = 0x400;\n\nexport const ALLOW_SLASH = 0x800;\n\nexport const ALLOW_URANGE = 0x1000;\n\nexport const ALLOW_IMAGE = 0x2000;\n\nexport type ValueMap = {\n  [key: string]: Css.Val;\n};\n\n/**\n * Abstract class to validate simple CSS property value (not a shorthand)\n */\nexport class PropertyValidator extends Css.Visitor {\n  constructor() {\n    super();\n  }\n\n  /**\n   * Validate a subsequence of the given values from the given index. Return the\n   * list of matched values or null if there is no match.\n   */\n  validateForShorthand(values: Css.Val[], index: number): Css.Val[] {\n    const rval = values[index].visit(this);\n    if (rval) {\n      return [rval];\n    }\n    return null;\n  }\n}\n\n/**\n * Validate a primitive CSS value (not a list or function).\n * @param allowed mask of ALLOW_*** constants.\n */\nexport class PrimitiveValidator extends PropertyValidator {\n  constructor(\n    public readonly allowed: number,\n    public readonly idents: ValueMap,\n    public readonly units: ValueMap,\n  ) {\n    super();\n  }\n\n  override visitEmpty(empty: Css.Val): Css.Val {\n    if (this.allowed & ALLOW_EMPTY) {\n      return empty;\n    }\n    return null;\n  }\n\n  override visitSlash(slash: Css.Val): Css.Val {\n    if (this.allowed & ALLOW_SLASH) {\n      return slash;\n    }\n    return null;\n  }\n\n  override visitStr(str: Css.Str): Css.Val {\n    if (this.allowed & ALLOW_STR) {\n      return str;\n    }\n    return null;\n  }\n\n  override visitIdent(ident: Css.Ident): Css.Val {\n    const val = this.idents[ident.name.toLowerCase()];\n    if (val) {\n      return val;\n    }\n    if (this.allowed & ALLOW_IDENT) {\n      return ident;\n    }\n    if (this.allowed & ALLOW_COLOR) {\n      if (CSS.supports(\"color\", ident.name)) {\n        return ident;\n      }\n    }\n    return null;\n  }\n\n  override visitNumeric(numeric: Css.Numeric): Css.Val {\n    if (numeric.num == 0 && !(this.allowed & ALLOW_ZERO)) {\n      if (numeric.unit == \"%\" && this.allowed & ALLOW_ZERO_PERCENT) {\n        return numeric;\n      }\n      return null;\n    }\n    if (numeric.num < 0 && !(this.allowed & ALLOW_NEGATIVE)) {\n      return null;\n    }\n    if (this.units[numeric.unit]) {\n      return numeric;\n    }\n    return null;\n  }\n\n  override visitNum(num: Css.Num): Css.Val {\n    if (num.num == 0) {\n      return this.allowed & ALLOW_ZERO ? num : null;\n    }\n    if (num.num <= 0 && !(this.allowed & ALLOW_NEGATIVE)) {\n      return null;\n    }\n    if (this.allowed & ALLOW_POS_NUM) {\n      return num;\n    }\n    return null;\n  }\n\n  override visitInt(num: Css.Int): Css.Val {\n    if (num.num == 0) {\n      return this.allowed & ALLOW_ZERO ? num : null;\n    }\n    if (num.num <= 0 && !(this.allowed & ALLOW_NEGATIVE)) {\n      return null;\n    }\n    if (this.allowed & (ALLOW_POS_INT | ALLOW_POS_NUM)) {\n      return num;\n    }\n    const val = this.idents[`${num.num}`];\n    if (val) {\n      return val;\n    }\n    return null;\n  }\n\n  override visitHexColor(color: Css.HexColor): Css.Val {\n    if (this.allowed & ALLOW_COLOR) {\n      if (/^([0-9A-F]{3,4}|([0-9A-F]{2}){3,4})$/i.test(color.hex)) {\n        return color;\n      }\n    }\n    return null;\n  }\n\n  override visitURL(url: Css.URL): Css.Val {\n    if (this.allowed & ALLOW_URL) {\n      return url;\n    }\n    return null;\n  }\n\n  override visitURange(urange: Css.URange): Css.Val {\n    if (this.allowed & ALLOW_URANGE) {\n      return urange;\n    }\n    return null;\n  }\n\n  override visitSpaceList(list: Css.SpaceList): Css.Val {\n    return null;\n  }\n\n  override visitCommaList(list: Css.CommaList): Css.Val {\n    return null;\n  }\n\n  override visitFunc(func: Css.Func): Css.Val {\n    if (this.allowed & ALLOW_COLOR) {\n      if (CSS.supports(\"color\", func.toString())) {\n        return func;\n      }\n    }\n    if (this.allowed & ALLOW_IMAGE) {\n      if (CSS.supports(\"background-image\", func.toString())) {\n        return func;\n      }\n    }\n    if (\n      func.name === \"calc\" &&\n      this.allowed &\n        (ALLOW_POS_NUMERIC |\n          ALLOW_POS_NUM |\n          ALLOW_POS_INT |\n          ALLOW_NEGATIVE |\n          ALLOW_ZERO |\n          ALLOW_ZERO_PERCENT)\n    ) {\n      return func;\n    }\n    return null;\n  }\n\n  override visitExpr(expr: Css.Expr): Css.Val {\n    if (this.allowed & 0x7fe) {\n      // ALLOW_STR|ALLOW_IDENT|...|ALLOW_ZERO_PERCENT\n      return expr;\n    }\n    return null;\n  }\n\n  combine(other: PrimitiveValidator): PrimitiveValidator {\n    const idents: ValueMap = {};\n    const units: ValueMap = {};\n    for (const ident in this.idents) {\n      idents[ident] = this.idents[ident];\n    }\n    for (const ident in other.idents) {\n      idents[ident] = other.idents[ident];\n    }\n    for (const unit in this.units) {\n      units[unit] = this.units[unit];\n    }\n    for (const unit in other.units) {\n      units[unit] = other.units[unit];\n    }\n    return new PrimitiveValidator(this.allowed | other.allowed, idents, units);\n  }\n}\n\nconst NO_IDENTS: ValueMap = {};\n\nexport const ALWAYS_FAIL = new PrimitiveValidator(0, NO_IDENTS, NO_IDENTS);\n\n/**\n * Base class for list validation.\n */\nexport class ListValidator extends PropertyValidator {\n  successTerminal: Node;\n  failureTerminal: Node;\n  first: Node;\n\n  constructor(group: ValidatingGroup) {\n    super();\n    this.successTerminal = new Node(null);\n    this.failureTerminal = new Node(null);\n    this.first = group.finish(this.successTerminal, this.failureTerminal);\n  }\n\n  validateList(arr: Css.Val[], slice: boolean, startIndex: number): Css.Val[] {\n    let out: Css.Val[] = slice ? [] : arr;\n    let current = this.first;\n    let index = startIndex;\n    let alternativeStack: string[][] = null;\n    let alternatives: string[] = null;\n    while (\n      current !== this.successTerminal &&\n      current !== this.failureTerminal\n    ) {\n      if (index >= arr.length) {\n        current = current.failure;\n        continue;\n      }\n      const inval = arr[index];\n      let outval = inval;\n      if (current.isSpecial()) {\n        let success = true;\n        if (current.isStartGroup()) {\n          if (alternativeStack) {\n            alternativeStack.push(alternatives);\n          } else {\n            alternativeStack = [alternatives];\n          }\n          alternatives = [];\n        } else if (current.isEndGroup()) {\n          if (alternativeStack.length > 0) {\n            alternatives = alternativeStack.pop();\n          } else {\n            alternatives = null;\n          }\n        } else if (current.isEndAlternate()) {\n          alternatives[current.getAlternate()] = \"taken\";\n        } else {\n          success = alternatives[current.getAlternate()] == null;\n        }\n        current = success ? current.success : current.failure;\n      } else {\n        if (\n          index == 0 &&\n          !slice &&\n          current.validator instanceof SpaceListValidator &&\n          this instanceof SpaceListValidator\n        ) {\n          // Special nesting case: validate the input space list as a whole.\n          outval = new Css.SpaceList(arr).visit(current.validator);\n          if (outval) {\n            index = arr.length;\n            current = current.success;\n            continue;\n          }\n        } else if (\n          index == 0 &&\n          !slice &&\n          current.validator instanceof CommaListValidator &&\n          this instanceof SpaceListValidator\n        ) {\n          // Special nesting case: validate the input comma list as a whole.\n          outval = new Css.CommaList(arr).visit(current.validator);\n          if (outval) {\n            index = arr.length;\n            current = current.success;\n            continue;\n          }\n        } else {\n          outval = inval.visit(current.validator);\n        }\n        if (!outval) {\n          current = current.failure;\n          continue;\n        }\n        if (outval !== inval && arr === out) {\n          // startIndex is zero here\n          out = [];\n          for (let k = 0; k < index; k++) {\n            out[k] = arr[k];\n          }\n        }\n        if (arr !== out) {\n          out[index - startIndex] = outval;\n        }\n        index++;\n        current = current.success;\n      }\n    }\n    if (current === this.successTerminal) {\n      if (slice ? out.length > 0 : index == arr.length) {\n        return out;\n      }\n    }\n    return null;\n  }\n\n  validateSingle(inval: Css.Val): Css.Val {\n    // no need to worry about \"specials\"\n    let outval: Css.Val = null;\n    let current = this.first;\n    while (\n      current !== this.successTerminal &&\n      current !== this.failureTerminal\n    ) {\n      if (!inval) {\n        current = current.failure;\n        continue;\n      }\n      if (current.isSpecial()) {\n        current = current.success;\n        continue;\n      }\n      outval = inval.visit(current.validator);\n      if (!outval) {\n        current = current.failure;\n        continue;\n      }\n      inval = null;\n      current = current.success;\n    }\n    if (current === this.successTerminal) {\n      return outval;\n    }\n    return null;\n  }\n\n  override visitEmpty(empty: Css.Val): Css.Val {\n    return this.validateSingle(empty);\n  }\n\n  override visitSlash(slash: Css.Val): Css.Val {\n    return this.validateSingle(slash);\n  }\n\n  override visitStr(str: Css.Str): Css.Val {\n    return this.validateSingle(str);\n  }\n\n  override visitIdent(ident: Css.Ident): Css.Val {\n    return this.validateSingle(ident);\n  }\n\n  override visitNumeric(numeric: Css.Numeric): Css.Val {\n    return this.validateSingle(numeric);\n  }\n\n  override visitNum(num: Css.Num): Css.Val {\n    return this.validateSingle(num);\n  }\n\n  override visitInt(num: Css.Int): Css.Val {\n    return this.validateSingle(num);\n  }\n\n  override visitHexColor(color: Css.HexColor): Css.Val {\n    return this.validateSingle(color);\n  }\n\n  override visitURL(url: Css.URL): Css.Val {\n    return this.validateSingle(url);\n  }\n\n  override visitURange(urange: Css.URange): Css.Val {\n    return this.validateSingle(urange);\n  }\n\n  override visitSpaceList(list: Css.SpaceList): Css.Val {\n    return null;\n  }\n\n  override visitCommaList(list: Css.CommaList): Css.Val {\n    return null;\n  }\n\n  override visitFunc(func: Css.Func): Css.Val {\n    return this.validateSingle(func);\n  }\n\n  override visitExpr(expr: Css.Expr): Css.Val {\n    return null;\n  }\n}\n\nexport class SpaceListValidator extends ListValidator {\n  constructor(group: ValidatingGroup) {\n    super(group);\n  }\n\n  override visitSpaceList(list: Css.SpaceList): Css.Val {\n    const arr = this.validateList(list.values, false, 0);\n    if (arr === list.values) {\n      return list;\n    }\n    if (!arr) {\n      return null;\n    }\n    return new Css.SpaceList(arr);\n  }\n\n  override visitCommaList(list: Css.CommaList): Css.Val {\n    // Special Case : Issue #156\n    let node = this.first;\n    let hasCommaListValidator = false;\n    while (node) {\n      if (node.validator instanceof CommaListValidator) {\n        hasCommaListValidator = true;\n        break;\n      }\n      node = node.failure;\n    }\n    if (hasCommaListValidator) {\n      const arr = this.validateList(list.values, false, 0);\n      if (arr === list.values) {\n        return list;\n      }\n      if (!arr) {\n        return null;\n      }\n      return new Css.CommaList(arr);\n    }\n    return null;\n  }\n\n  override validateForShorthand(values: Css.Val[], index: number): Css.Val[] {\n    return this.validateList(values, true, index);\n  }\n}\n\nexport class CommaListValidator extends ListValidator {\n  constructor(group: ValidatingGroup) {\n    super(group);\n  }\n\n  override visitSpaceList(list: Css.SpaceList): Css.Val {\n    return this.validateSingle(list);\n  }\n\n  override visitCommaList(list: Css.CommaList): Css.Val {\n    const arr = this.validateList(list.values, false, 0);\n    if (arr === list.values) {\n      return list;\n    }\n    if (!arr) {\n      return null;\n    }\n    return new Css.CommaList(arr);\n  }\n\n  override validateForShorthand(values: Css.Val[], index: number): Css.Val[] {\n    let current = this.first;\n    let rval: Css.Val[];\n    while (current !== this.failureTerminal) {\n      rval = current.validator.validateForShorthand(values, index);\n      if (rval) {\n        return rval;\n      }\n      current = current.failure;\n    }\n    return null;\n  }\n}\n\nexport class FuncValidator extends ListValidator {\n  constructor(\n    public readonly name: string,\n    group: ValidatingGroup,\n  ) {\n    super(group);\n  }\n\n  override validateSingle(inval: Css.Val): Css.Val {\n    return null;\n  }\n\n  override visitFunc(func: Css.Func): Css.Val {\n    if (func.name.toLowerCase() != this.name) {\n      return null;\n    }\n    const arr = this.validateList(func.values, false, 0);\n    if (arr === func.values) {\n      return func;\n    }\n    if (!arr) {\n      return null;\n    }\n    return new Css.Func(func.name, arr);\n  }\n}\n\n//----------------------- Shorthands\n//------------------------------------------------------------\nexport class ShorthandSyntaxNode {\n  /**\n   * @return new index.\n   */\n  tryParse(\n    values: Css.Val[],\n    index: number,\n    shorthandValidator: ShorthandValidator,\n  ): number {\n    return index;\n  }\n\n  success(rval: Css.Val, shorthandValidator: ShorthandValidator): void {}\n}\n\nexport class ShorthandSyntaxProperty extends ShorthandSyntaxNode {\n  validator: PropertyValidator;\n\n  constructor(\n    validatorSet: ValidatorSet,\n    public readonly name: string,\n  ) {\n    super();\n    this.validator = validatorSet.validators[this.name];\n  }\n\n  override tryParse(\n    values: Css.Val[],\n    index: number,\n    shorthandValidator: ShorthandValidator,\n  ): number {\n    if (shorthandValidator.values[this.name]) {\n      return index;\n    }\n    const rvals = this.validator.validateForShorthand(values, index);\n    if (rvals) {\n      const len = rvals.length;\n      const rval = len > 1 ? new Css.SpaceList(rvals) : rvals[0];\n      this.success(rval, shorthandValidator);\n      return index + len;\n    }\n    return index;\n  }\n\n  override success(\n    rval: Css.Val,\n    shorthandValidator: ShorthandValidator,\n  ): void {\n    shorthandValidator.values[this.name] = rval;\n  }\n}\n\nexport class ShorthandSyntaxPropertyN extends ShorthandSyntaxProperty {\n  constructor(\n    validatorSet: ValidatorSet,\n    public readonly names: string[],\n  ) {\n    super(validatorSet, names[0]);\n  }\n\n  override success(\n    rval: Css.Val,\n    shorthandValidator: ShorthandValidator,\n  ): void {\n    for (let i = 0; i < this.names.length; i++) {\n      shorthandValidator.values[this.names[i]] = rval;\n    }\n  }\n}\n\nexport class ShorthandSyntaxCompound extends ShorthandSyntaxNode {\n  constructor(\n    public readonly nodes: ShorthandSyntaxNode[],\n    public readonly slash: boolean,\n  ) {\n    super();\n  }\n\n  override tryParse(\n    values: Css.Val[],\n    index: number,\n    shorthandValidator: ShorthandValidator,\n  ): number {\n    const index0 = index;\n    if (this.slash) {\n      if (values[index] == Css.slash) {\n        if (++index == values.length) {\n          return index0;\n        }\n      } else {\n        return index0;\n      }\n    }\n    let newIndex = this.nodes[0].tryParse(values, index, shorthandValidator);\n    if (newIndex == index) {\n      return index0;\n    }\n    index = newIndex;\n    for (let i = 1; i < this.nodes.length && index < values.length; i++) {\n      newIndex = this.nodes[i].tryParse(values, index, shorthandValidator);\n      if (newIndex == index) {\n        break;\n      }\n      index = newIndex;\n    }\n    return index;\n  }\n}\n\nexport class ShorthandValidator extends Css.Visitor {\n  syntax: ShorthandSyntaxNode[] = null;\n  propList: string[] = null;\n  error: boolean = false;\n  values: ValueMap = {};\n  validatorSet: ValidatorSet = null;\n\n  setOwner(validatorSet: ValidatorSet) {\n    this.validatorSet = validatorSet;\n  }\n\n  syntaxNodeForProperty(name: string): ShorthandSyntaxNode {\n    return new ShorthandSyntaxProperty(this.validatorSet, name);\n  }\n\n  clone(): this {\n    const other = new (this.constructor as any)();\n    other.syntax = this.syntax;\n    other.propList = this.propList;\n    other.validatorSet = this.validatorSet;\n    return other;\n  }\n\n  init(syntax: ShorthandSyntaxNode[], propList: string[]): void {\n    this.syntax = syntax;\n    this.propList = propList;\n  }\n\n  finish(important: boolean, receiver: PropertyReceiver): boolean {\n    if (!this.error) {\n      for (const name of this.propList) {\n        receiver.simpleProperty(\n          name,\n          this.values[name] ??\n            this.validatorSet.defaultValues[name] ??\n            Css.ident.initial,\n          important,\n        );\n      }\n      return true;\n    }\n    return false;\n  }\n\n  propagateDefaultingValue(\n    value: Css.Val,\n    important: boolean,\n    receiver: PropertyReceiver,\n  ): void {\n    for (const name of this.propList) {\n      receiver.simpleProperty(name, value, important);\n    }\n  }\n\n  validateList(list: Css.Val[]): number {\n    this.error = true;\n    return 0;\n  }\n\n  validateSingle(val: Css.Val): Css.Val {\n    this.validateList([val]);\n    return null;\n  }\n\n  override visitEmpty(empty: Css.Val): Css.Val {\n    return this.validateSingle(empty);\n  }\n\n  override visitStr(str: Css.Str): Css.Val {\n    return this.validateSingle(str);\n  }\n\n  override visitIdent(ident: Css.Ident): Css.Val {\n    return this.validateSingle(ident);\n  }\n\n  override visitNumeric(numeric: Css.Numeric): Css.Val {\n    return this.validateSingle(numeric);\n  }\n\n  override visitNum(num: Css.Num): Css.Val {\n    return this.validateSingle(num);\n  }\n\n  override visitInt(num: Css.Int): Css.Val {\n    return this.validateSingle(num);\n  }\n\n  override visitHexColor(color: Css.HexColor): Css.Val {\n    return this.validateSingle(color);\n  }\n\n  override visitURL(url: Css.URL): Css.Val {\n    return this.validateSingle(url);\n  }\n\n  override visitSpaceList(list: Css.SpaceList): Css.Val {\n    this.validateList(list.values);\n    return null;\n  }\n\n  override visitCommaList(list: Css.CommaList): Css.Val {\n    this.error = true;\n    return null;\n  }\n\n  override visitFunc(func: Css.Func): Css.Val {\n    return this.validateSingle(func);\n  }\n\n  override visitExpr(expr: Css.Expr): Css.Val {\n    return this.validateSingle(expr);\n  }\n}\n\nexport class SimpleShorthandValidator extends ShorthandValidator {\n  constructor() {\n    super();\n  }\n\n  override validateList(list: Css.Val[]): number {\n    let index = 0;\n    let i = 0;\n    while (index < list.length) {\n      const newIndex = this.syntax[i].tryParse(list, index, this);\n      if (newIndex > index) {\n        index = newIndex;\n        i = 0;\n        continue;\n      }\n      if (++i == this.syntax.length) {\n        this.error = true;\n        break;\n      }\n    }\n    return index;\n  }\n}\n\nexport class InsetsShorthandValidator extends ShorthandValidator {\n  constructor() {\n    super();\n  }\n\n  override validateList(list: Css.Val[]): number {\n    if (list.length > this.syntax.length || list.length == 0) {\n      this.error = true;\n      return 0;\n    }\n    for (let i = 0; i < this.syntax.length; i++) {\n      let index = i;\n      while (index >= list.length) {\n        index = index == 1 ? 0 : index - 2;\n      }\n      if (this.syntax[i].tryParse(list, index, this) != index + 1) {\n        this.error = true;\n        return 0;\n      }\n    }\n    return list.length;\n  }\n\n  createSyntaxNode(): ShorthandSyntaxPropertyN {\n    return new ShorthandSyntaxPropertyN(this.validatorSet, this.propList);\n  }\n}\n\nexport class InsetsSlashShorthandValidator extends ShorthandValidator {\n  constructor() {\n    super();\n  }\n\n  override validateList(list: Css.Val[]): number {\n    let slashIndex = list.length;\n    for (let i = 0; i < list.length; i++) {\n      if (list[i] === Css.slash) {\n        slashIndex = i;\n        break;\n      }\n    }\n    if (slashIndex > this.syntax.length || list.length == 0) {\n      this.error = true;\n      return 0;\n    }\n    for (let i = 0; i < this.syntax.length; i++) {\n      let index0 = i;\n      while (index0 >= slashIndex) {\n        index0 = index0 == 1 ? 0 : index0 - 2;\n      }\n      let index1: number;\n      if (slashIndex + 1 < list.length) {\n        index1 = slashIndex + i + 1;\n        while (index1 >= list.length) {\n          index1 = index1 - (index1 == slashIndex + 2 ? 1 : 2);\n        }\n      } else {\n        index1 = index0;\n      }\n      const vals = [list[index0], list[index1]];\n      if (this.syntax[i].tryParse(vals, 0, this) != 2) {\n        this.error = true;\n        return 0;\n      }\n    }\n    return list.length;\n  }\n}\n\nexport class CommaShorthandValidator extends SimpleShorthandValidator {\n  constructor() {\n    super();\n  }\n\n  mergeIn(acc: { [key: string]: Css.Val[] }, values: ValueMap) {\n    for (const name of this.propList) {\n      const val =\n        values[name] ??\n        this.validatorSet.defaultValues[name] ??\n        Css.ident.initial;\n      let arr = acc[name];\n      if (!arr) {\n        arr = [];\n        acc[name] = arr;\n      }\n      arr.push(val);\n    }\n  }\n\n  override visitCommaList(list: Css.CommaList): Css.Val {\n    const acc: { [key: string]: Css.Val[] } = {};\n    for (let i = 0; i < list.values.length; i++) {\n      this.values = {};\n      if (list.values[i] instanceof Css.CommaList) {\n        this.error = true;\n      } else {\n        list.values[i].visit(this);\n        this.mergeIn(acc, this.values);\n        if (this.values[\"background-color\"] && i != list.values.length - 1) {\n          this.error = true;\n        }\n      }\n      if (this.error) {\n        return null;\n      }\n    }\n    this.values = {};\n    for (const name in acc) {\n      if (name == \"background-color\") {\n        this.values[name] = acc[name].pop();\n      } else {\n        this.values[name] = new Css.CommaList(acc[name]);\n      }\n    }\n    return null;\n  }\n}\n\nexport class FontShorthandValidator extends SimpleShorthandValidator {\n  constructor() {\n    super();\n  }\n\n  override init(syntax: ShorthandSyntaxNode[], propList: string[]): void {\n    super.init(syntax, propList);\n    this.propList.push(\n      \"font-family\",\n      \"line-height\",\n      \"font-size\",\n      \"font-stretch\",\n      \"font-variant-ligatures\",\n      \"font-variant-caps\",\n      \"font-variant-numeric\",\n      \"font-variant-east-asian\",\n    );\n  }\n\n  override validateList(list: Css.Val[]): number {\n    let index = super.validateList(list);\n\n    const fontVariant = this.values[\"font-variant_css2\"];\n    if (fontVariant) {\n      delete this.values[\"font-variant_css2\"];\n      this.values[\"font-variant-caps\"] = fontVariant;\n    }\n    const fontStretch = this.values[\"font-stretch_css3\"];\n    if (fontStretch) {\n      delete this.values[\"font-stretch_css3\"];\n      this.values[\"font-stretch\"] = fontStretch;\n    }\n\n    // must at least have font-size and font-family at the end\n    if (index + 2 > list.length) {\n      this.error = true;\n      return index;\n    }\n    this.error = false;\n    const validators = this.validatorSet.validators;\n    if (!list[index].visit(validators[\"font-size\"])) {\n      this.error = true;\n      return index;\n    }\n    this.values[\"font-size\"] = list[index++];\n    if (list[index] === Css.slash) {\n      index++;\n\n      // must at least have line-height and font-family at the end\n      if (index + 2 > list.length) {\n        this.error = true;\n        return index;\n      }\n      if (!list[index].visit(validators[\"line-height\"])) {\n        this.error = true;\n        return index;\n      }\n      this.values[\"line-height\"] = list[index++];\n    }\n    const fontFamily =\n      index == list.length - 1\n        ? list[index]\n        : new Css.SpaceList(list.slice(index, list.length));\n    if (!fontFamily.visit(validators[\"font-family\"])) {\n      this.error = true;\n      return index;\n    }\n    this.values[\"font-family\"] = fontFamily;\n    return list.length;\n  }\n\n  override visitCommaList(list: Css.CommaList): Css.Val {\n    list.values[0].visit(this);\n    if (this.error) {\n      return null;\n    }\n    const familyList = [this.values[\"font-family\"]];\n    for (let i = 1; i < list.values.length; i++) {\n      familyList.push(list.values[i]);\n    }\n    const family = new Css.CommaList(familyList);\n    if (!family.visit(this.validatorSet.validators[\"font-family\"])) {\n      this.error = true;\n    } else {\n      this.values[\"font-family\"] = family;\n    }\n    return null;\n  }\n\n  override visitIdent(ident: Css.Ident): Css.Val {\n    const props = this.validatorSet.systemFonts[ident.name];\n    if (props) {\n      for (const name in props) {\n        this.values[name] = props[name];\n      }\n    } else {\n      this.error = true;\n    }\n    return null;\n  }\n}\n\nexport class TextSpacingShorthandValidator extends SimpleShorthandValidator {\n  override validateList(list: Css.Val[]): number {\n    if (list.length === 1 && list[0] instanceof Css.Ident) {\n      switch (list[0].name.toLowerCase()) {\n        case \"normal\":\n          list = [\n            this.validatorSet.defaultValues[\"text-autospace\"],\n            this.validatorSet.defaultValues[\"text-spacing-trim\"],\n          ];\n          break;\n        case \"auto\":\n          list = [Css.ident.auto, Css.ident.auto];\n          break;\n        case \"none\":\n          list = [Css.getName(\"no-autospace\"), Css.getName(\"space-all\")];\n          break;\n      }\n    }\n    return super.validateList(list);\n  }\n}\n\nconst propsExcludedFromAll = [\n  \"unicode-bidi\",\n  \"direction\",\n\n  // excludes css-logical\n  \"margin-block-start\",\n  \"margin-block-end\",\n  \"margin-inline-start\",\n  \"margin-inline-end\",\n  \"padding-block-start\",\n  \"padding-block-end\",\n  \"padding-inline-start\",\n  \"padding-inline-end\",\n  \"border-block-start-color\",\n  \"border-block-end-color\",\n  \"border-inline-start-color\",\n  \"border-inline-end-color\",\n  \"border-block-start-style\",\n  \"border-block-end-style\",\n  \"border-inline-start-style\",\n  \"border-inline-end-style\",\n  \"border-block-start-width\",\n  \"border-block-end-width\",\n  \"border-inline-start-width\",\n  \"border-inline-end-width\",\n  \"block-start\",\n  \"block-end\",\n  \"inline-start\",\n  \"inline-end\",\n  \"block-size\",\n  \"inline-size\",\n  \"max-block-size\",\n  \"max-inline-size\",\n  \"min-block-size\",\n  \"min-inline-size\",\n\n  // excludes non-standards and special\n  \"behavior\",\n  \"bleed\",\n  \"conflicting-partitions\",\n  \"crop-offset\",\n  \"crop-marks-line-color\",\n  \"enabled\",\n  \"flow-consume\",\n  \"flow-from\",\n  \"flow-into\",\n  \"flow-linger\",\n  \"flow-options\",\n  \"flow-priority\",\n  \"font-display\",\n  \"font-size-adjust\",\n  \"font-stretch_css3\",\n  \"font-variant_css2\",\n  \"glyph-orientation-vertical\",\n  \"marks\",\n  \"min-page-height\",\n  \"min-page-width\",\n  \"repeat-on-break\",\n  \"required\",\n  \"required-partitions\",\n  \"ruby-align\",\n  \"shape-inside\",\n  \"snap-height\",\n  \"snap-width\",\n  \"template\",\n  \"text-decoration-skip\",\n  \"text-justify\",\n  \"text-zoom\",\n  \"unicode-range\",\n  \"utilization\",\n  \"wrap-flow\",\n];\n\nexport class AllShorthandValidator extends SimpleShorthandValidator {\n  constructor() {\n    super();\n  }\n\n  override init(syntax: ShorthandSyntaxNode[], propList: string[]): void {\n    super.init(syntax, propList);\n    for (const name in this.validatorSet.validators) {\n      if (!propsExcludedFromAll.includes(name)) {\n        this.propList.push(name);\n      }\n    }\n  }\n\n  override validateList(list: Css.Val[]): number {\n    this.error = true;\n    return 0;\n  }\n}\n\nexport const shorthandValidators: {\n  [key: string]: typeof ShorthandValidator;\n} = {\n  SIMPLE: SimpleShorthandValidator,\n  INSETS: InsetsShorthandValidator,\n  INSETS_SLASH: InsetsSlashShorthandValidator,\n  COMMA: CommaShorthandValidator,\n  FONT: FontShorthandValidator,\n  TEXT_SPACING: TextSpacingShorthandValidator,\n  ALL: AllShorthandValidator,\n};\n\n//---- validation grammar parser and public property validator\n//------------------------\n\n/**\n * Object that validates simple and shorthand properties, breaking up shorthand\n * properties into corresponding simple ones, also stripping property prefixes.\n */\nexport class ValidatorSet {\n  validators: { [key: string]: PropertyValidator } = {};\n  prefixes: { [key: string]: { [key: string]: boolean } } = {};\n  defaultValues: ValueMap = {};\n  namedValidators: { [key: string]: ValidatingGroup } = {};\n  systemFonts: { [key: string]: ValueMap } = {};\n  shorthands: { [key: string]: ShorthandValidator } = {};\n  layoutProps: ValueMap = {};\n  backgroundProps: ValueMap = {};\n\n  private addReplacement(\n    val: ValidatingGroup,\n    token: CssTokenizer.Token,\n  ): ValidatingGroup {\n    let cssval: Css.Val;\n    if (token.type == TokenType.NUMERIC) {\n      cssval = new Css.Numeric(token.num, token.text);\n    } else if (token.type == TokenType.HASH) {\n      cssval = new Css.HexColor(token.text);\n    } else if (token.type == TokenType.IDENT) {\n      cssval = Css.getName(token.text);\n    } else {\n      throw new Error(\"unexpected replacement\");\n    }\n    if (val.isPrimitive()) {\n      const validator = val.nodes[0].validator as PrimitiveValidator;\n      const idents = validator.idents;\n      for (const ident in idents) {\n        idents[ident] = cssval;\n      }\n      return val;\n    }\n    throw new Error(\"unexpected replacement\");\n  }\n\n  private newGroup(op: string, vals: ValidatingGroup[]): ValidatingGroup {\n    const group = new ValidatingGroup();\n    if (op == \"||\") {\n      for (let i = 0; i < vals.length; i++) {\n        const subgroup = new ValidatingGroup();\n        subgroup.startClause(i);\n        subgroup.addGroup(vals[i], Add.FOLLOW);\n        subgroup.endClause(i);\n        group.addGroup(subgroup, i == 0 ? Add.FOLLOW : Add.ALTERNATE);\n      }\n      const outer = new ValidatingGroup();\n      outer.startSpecialGroup();\n      outer.addGroup(group, Add.REPEATED);\n      outer.endSpecialGroup();\n      return outer;\n    } else {\n      let how: Add;\n      switch (op) {\n        case \" \":\n          how = Add.FOLLOW;\n          break;\n        case \"|\":\n        case \"||\":\n          how = Add.ALTERNATE;\n          break;\n        default:\n          throw new Error(\"unexpected op\");\n      }\n      for (let i = 0; i < vals.length; i++) {\n        group.addGroup(vals[i], i == 0 ? Add.FOLLOW : how);\n      }\n      return group;\n    }\n  }\n\n  private addCounts(\n    val: ValidatingGroup,\n    min: number,\n    max: number,\n  ): ValidatingGroup {\n    const group = new ValidatingGroup();\n    for (let i = 0; i < min; i++) {\n      group.addGroup(val.clone(), Add.FOLLOW);\n    }\n    if (max == Number.POSITIVE_INFINITY) {\n      group.addGroup(val, Add.REPEATED);\n    } else {\n      for (let i = min; i < max; i++) {\n        group.addGroup(val.clone(), Add.OPTIONAL);\n      }\n    }\n    return group;\n  }\n\n  private primitive(validator: PropertyValidator): ValidatingGroup {\n    const group = new ValidatingGroup();\n    group.addPrimitive(validator);\n    return group;\n  }\n\n  private newFunc(fn: string, val: ValidatingGroup): ValidatingGroup {\n    let validator: PropertyValidator;\n    switch (fn) {\n      case \"COMMA\":\n        validator = new CommaListValidator(val);\n        break;\n      case \"SPACE\":\n        validator = new SpaceListValidator(val);\n        break;\n      default:\n        validator = new FuncValidator(fn.toLowerCase(), val);\n        break;\n    }\n    return this.primitive(validator);\n  }\n\n  initBuiltInValidators(): void {\n    this.namedValidators[\"COLOR\"] = this.primitive(\n      new PrimitiveValidator(ALLOW_COLOR, NO_IDENTS, NO_IDENTS),\n    );\n    this.namedValidators[\"IMAGE_FUNCTION\"] = this.primitive(\n      new PrimitiveValidator(ALLOW_IMAGE, NO_IDENTS, NO_IDENTS),\n    );\n    this.namedValidators[\"POS_INT\"] = this.primitive(\n      new PrimitiveValidator(ALLOW_POS_INT, NO_IDENTS, NO_IDENTS),\n    );\n    this.namedValidators[\"POS_NUM\"] = this.primitive(\n      new PrimitiveValidator(ALLOW_POS_NUM, NO_IDENTS, NO_IDENTS),\n    );\n    this.namedValidators[\"POS_PERCENTAGE\"] = this.primitive(\n      new PrimitiveValidator(ALLOW_POS_NUMERIC, NO_IDENTS, { \"%\": Css.empty }),\n    );\n    this.namedValidators[\"NEGATIVE\"] = this.primitive(\n      new PrimitiveValidator(ALLOW_NEGATIVE, NO_IDENTS, NO_IDENTS),\n    );\n    this.namedValidators[\"ZERO\"] = this.primitive(\n      new PrimitiveValidator(ALLOW_ZERO, NO_IDENTS, NO_IDENTS),\n    );\n    this.namedValidators[\"ZERO_PERCENTAGE\"] = this.primitive(\n      new PrimitiveValidator(ALLOW_ZERO_PERCENT, NO_IDENTS, NO_IDENTS),\n    );\n    this.namedValidators[\"POS_LENGTH\"] = this.primitive(\n      new PrimitiveValidator(ALLOW_POS_NUMERIC, NO_IDENTS, {\n        em: Css.empty,\n        ex: Css.empty,\n        ch: Css.empty,\n        rem: Css.empty,\n        lh: Css.empty,\n        rlh: Css.empty,\n        vw: Css.empty,\n        vh: Css.empty,\n        vi: Css.empty,\n        vb: Css.empty,\n        vmin: Css.empty,\n        vmax: Css.empty,\n        pvw: Css.empty,\n        pvh: Css.empty,\n        pvi: Css.empty,\n        pvb: Css.empty,\n        pvmin: Css.empty,\n        pvmax: Css.empty,\n        cm: Css.empty,\n        mm: Css.empty,\n        in: Css.empty,\n        px: Css.empty,\n        pt: Css.empty,\n        pc: Css.empty,\n        q: Css.empty,\n      }),\n    );\n    this.namedValidators[\"POS_ANGLE\"] = this.primitive(\n      new PrimitiveValidator(ALLOW_POS_NUMERIC, NO_IDENTS, {\n        deg: Css.empty,\n        grad: Css.empty,\n        rad: Css.empty,\n        turn: Css.empty,\n      }),\n    );\n    this.namedValidators[\"POS_TIME\"] = this.primitive(\n      new PrimitiveValidator(ALLOW_POS_NUMERIC, NO_IDENTS, {\n        s: Css.empty,\n        ms: Css.empty,\n      }),\n    );\n    this.namedValidators[\"FREQUENCY\"] = this.primitive(\n      new PrimitiveValidator(ALLOW_POS_NUMERIC, NO_IDENTS, {\n        Hz: Css.empty,\n        kHz: Css.empty,\n      }),\n    );\n    this.namedValidators[\"RESOLUTION\"] = this.primitive(\n      new PrimitiveValidator(ALLOW_POS_NUMERIC, NO_IDENTS, {\n        dpi: Css.empty,\n        dpcm: Css.empty,\n        dppx: Css.empty,\n      }),\n    );\n    this.namedValidators[\"URI\"] = this.primitive(\n      new PrimitiveValidator(ALLOW_URL, NO_IDENTS, NO_IDENTS),\n    );\n    this.namedValidators[\"URANGE\"] = this.primitive(\n      new PrimitiveValidator(ALLOW_URANGE, NO_IDENTS, NO_IDENTS),\n    );\n    this.namedValidators[\"IDENT\"] = this.primitive(\n      new PrimitiveValidator(ALLOW_IDENT, NO_IDENTS, NO_IDENTS),\n    );\n    this.namedValidators[\"STRING\"] = this.primitive(\n      new PrimitiveValidator(ALLOW_STR, NO_IDENTS, NO_IDENTS),\n    );\n    this.namedValidators[\"SLASH\"] = this.primitive(\n      new PrimitiveValidator(ALLOW_SLASH, NO_IDENTS, NO_IDENTS),\n    );\n    const stdfont = { \"font-family\": Css.getName(\"sans-serif\") };\n    this.systemFonts[\"caption\"] = stdfont;\n    this.systemFonts[\"icon\"] = stdfont;\n    this.systemFonts[\"menu\"] = stdfont;\n    this.systemFonts[\"message-box\"] = stdfont;\n    this.systemFonts[\"small-caption\"] = stdfont;\n    this.systemFonts[\"status-bar\"] = stdfont;\n  }\n\n  private isBuiltIn(name: string): boolean {\n    return !!name.match(/^[A-Z_0-9]+$/);\n  }\n\n  private readNameAndPrefixes(\n    tok: CssTokenizer.Tokenizer,\n    section: number,\n  ): string | null {\n    let token = tok.token();\n    if (token.type == TokenType.EOF) {\n      // Finished normally\n      return null;\n    }\n    const rulePrefixes: { [key: string]: boolean } = { \"\": true };\n    if (token.type == TokenType.O_BRK) {\n      do {\n        tok.consume();\n        token = tok.token();\n        if (token.type != TokenType.IDENT) {\n          throw new Error(\"Prefix name expected\");\n        }\n        rulePrefixes[token.text] = true;\n        tok.consume();\n        token = tok.token();\n      } while (token.type == TokenType.COMMA);\n      if (token.type != TokenType.C_BRK) {\n        throw new Error(\"']' expected\");\n      }\n      tok.consume();\n      token = tok.token();\n    }\n    if (token.type != TokenType.IDENT) {\n      throw new Error(\"Property name expected\");\n    }\n    if (section == 2 ? token.text == \"SHORTHANDS\" : token.text == \"DEFAULTS\") {\n      tok.consume();\n      return null;\n    }\n    const name = token.text;\n    tok.consume();\n    if (section != 2) {\n      if (tok.token().type != TokenType.EQ) {\n        throw new Error(\"'=' expected\");\n      }\n      if (!this.isBuiltIn(name)) {\n        this.prefixes[name] = rulePrefixes;\n      }\n    } else {\n      if (tok.token().type != TokenType.COLON) {\n        throw new Error(\"':' expected\");\n      }\n    }\n    return name;\n  }\n\n  private parseValidators(tok: CssTokenizer.Tokenizer): void {\n    while (true) {\n      const ruleName = this.readNameAndPrefixes(tok, 1);\n      if (!ruleName) {\n        return;\n      }\n      let vals: ValidatingGroup[] = [];\n      const stack = [];\n      let op = \"\";\n      let val: ValidatingGroup;\n      let expectval = true;\n      const reduce = (): ValidatingGroup => {\n        if (vals.length == 0) {\n          throw new Error(\"No values\");\n        }\n        if (vals.length == 1) {\n          return vals[0];\n        }\n        return this.newGroup(op, vals);\n      };\n      const setop = (currop: string): void => {\n        if (expectval) {\n          throw new Error(`'${currop}': unexpected`);\n        }\n        if (op && op != currop) {\n          throw new Error(`mixed operators: '${currop}' and '${op}'`);\n        }\n        op = currop;\n        expectval = true;\n      };\n      let result: ValidatingGroup = null;\n      while (!result) {\n        tok.consume();\n        let token = tok.token();\n        switch (token.type) {\n          case TokenType.IDENT:\n            if (!expectval) {\n              setop(\" \");\n            }\n            if (this.isBuiltIn(token.text)) {\n              const builtIn = this.namedValidators[token.text];\n              if (!builtIn) {\n                throw new Error(`'${token.text}' unexpected`);\n              }\n              vals.push(builtIn.clone());\n            } else {\n              const idents: ValueMap = {};\n              idents[token.text.toLowerCase()] = Css.getName(token.text);\n              vals.push(\n                this.primitive(new PrimitiveValidator(0, idents, NO_IDENTS)),\n              );\n            }\n            expectval = false;\n            break;\n          case TokenType.INT: {\n            const idents: ValueMap = {};\n            idents[`${token.num}`] = new Css.Int(token.num);\n            vals.push(\n              this.primitive(new PrimitiveValidator(0, idents, NO_IDENTS)),\n            );\n            expectval = false;\n            break;\n          }\n          case TokenType.BAR:\n            setop(\"|\");\n            break;\n          case TokenType.BAR_BAR:\n            setop(\"||\");\n            break;\n          case TokenType.O_BRK:\n            if (!expectval) {\n              setop(\" \");\n            }\n            stack.push({ vals, op, b: \"[\" });\n            op = \"\";\n            vals = [];\n            expectval = true;\n            break;\n          case TokenType.FUNC:\n            if (!expectval) {\n              setop(\" \");\n            }\n            stack.push({ vals, op, b: \"(\", fn: token.text });\n            op = \"\";\n            vals = [];\n            expectval = true;\n            break;\n          case TokenType.C_BRK: {\n            val = reduce();\n            const open = stack.pop();\n            if (open.b != \"[\") {\n              throw new Error(\"']' unexpected\");\n            }\n            vals = open.vals;\n            vals.push(val);\n            op = open.op;\n            expectval = false;\n            break;\n          }\n          case TokenType.C_PAR: {\n            val = reduce();\n            const open = stack.pop();\n            if (open.b != \"(\") {\n              throw new Error(\"')' unexpected\");\n            }\n            vals = open.vals;\n            vals.push(this.newFunc(open.fn, val));\n            op = open.op;\n            expectval = false;\n            break;\n          }\n          case TokenType.COLON:\n            if (expectval) {\n              throw new Error(\"':' unexpected\");\n            }\n            tok.consume();\n            vals.push(this.addReplacement(vals.pop(), tok.token()));\n            break;\n          case TokenType.QMARK:\n            if (expectval) {\n              throw new Error(\"'?' unexpected\");\n            }\n            vals.push(this.addCounts(vals.pop(), 0, 1));\n            break;\n          case TokenType.STAR:\n            if (expectval) {\n              throw new Error(\"'*' unexpected\");\n            }\n            vals.push(this.addCounts(vals.pop(), 0, Number.POSITIVE_INFINITY));\n            break;\n          case TokenType.PLUS:\n            if (expectval) {\n              throw new Error(\"'+' unexpected\");\n            }\n            vals.push(this.addCounts(vals.pop(), 1, Number.POSITIVE_INFINITY));\n            break;\n          case TokenType.O_BRC: {\n            tok.consume();\n            token = tok.token();\n            if (token.type != TokenType.INT) {\n              throw new Error(\"<int> expected\");\n            }\n            const min = token.num;\n            let max = min;\n            tok.consume();\n            token = tok.token();\n            if (token.type == TokenType.COMMA) {\n              tok.consume();\n              token = tok.token();\n              if (token.type != TokenType.INT) {\n                throw new Error(\"<int> expected\");\n              }\n              max = token.num;\n              tok.consume();\n              token = tok.token();\n            }\n            if (token.type != TokenType.C_BRC) {\n              throw new Error(\"'}' expected\");\n            }\n            vals.push(this.addCounts(vals.pop(), min, max));\n            break;\n          }\n          case TokenType.SEMICOL:\n            result = reduce();\n            if (stack.length > 0) {\n              throw new Error(`unclosed '${stack.pop().b}'`);\n            }\n            break;\n          default:\n            throw new Error(\"unexpected token\");\n        }\n      }\n      tok.consume();\n      if (this.isBuiltIn(ruleName)) {\n        this.namedValidators[ruleName] = result;\n      } else {\n        if (result.isSimple()) {\n          this.validators[ruleName] = result.nodes[0].validator;\n        } else {\n          this.validators[ruleName] = new SpaceListValidator(result);\n        }\n      }\n    }\n  }\n\n  private parseDefaults(tok: CssTokenizer.Tokenizer): void {\n    while (true) {\n      const propName = this.readNameAndPrefixes(tok, 2);\n      if (!propName) {\n        return;\n      }\n      const vals: Css.Val[] = [];\n      while (true) {\n        tok.consume();\n        const token = tok.token();\n        if (token.type == TokenType.SEMICOL) {\n          tok.consume();\n          break;\n        }\n        switch (token.type) {\n          case TokenType.IDENT:\n            vals.push(Css.getName(token.text));\n            break;\n          case TokenType.NUM:\n            vals.push(new Css.Num(token.num));\n            break;\n          case TokenType.INT:\n            vals.push(new Css.Int(token.num));\n            break;\n          case TokenType.NUMERIC:\n            vals.push(new Css.Numeric(token.num, token.text));\n            break;\n          default:\n            throw new Error(\"unexpected token\");\n        }\n      }\n      this.defaultValues[propName] =\n        vals.length > 1 ? new Css.SpaceList(vals) : vals[0];\n    }\n  }\n\n  private parseShorthands(tok: CssTokenizer.Tokenizer): void {\n    while (true) {\n      const ruleName = this.readNameAndPrefixes(tok, 3);\n      if (!ruleName) {\n        return;\n      }\n      let token = tok.nthToken(1);\n      let shorthandValidator: ShorthandValidator;\n      if (token.type == TokenType.IDENT && shorthandValidators[token.text]) {\n        shorthandValidator = new shorthandValidators[token.text]();\n        tok.consume();\n      } else {\n        shorthandValidator = new SimpleShorthandValidator();\n      }\n      shorthandValidator.setOwner(this);\n      let result = false;\n      let syntax: ShorthandSyntaxNode[] = [];\n      let slash = false;\n      const stack = [];\n      const propList = [];\n      while (!result) {\n        tok.consume();\n        token = tok.token();\n        switch (token.type) {\n          case TokenType.IDENT:\n            if (this.validators[token.text]) {\n              syntax.push(shorthandValidator.syntaxNodeForProperty(token.text));\n              // `font-variant_css2` and `font-stretch_css3` are not real properties\n              if (!token.text.includes(\"_\")) {\n                propList.push(token.text);\n              }\n            } else if (\n              this.shorthands[token.text] instanceof InsetsShorthandValidator\n            ) {\n              const insetShorthand = this.shorthands[\n                token.text\n              ] as InsetsShorthandValidator;\n              syntax.push(insetShorthand.createSyntaxNode());\n              propList.push(...insetShorthand.propList);\n            } else {\n              throw new Error(\n                `'${token.text}' is neither a simple property nor an inset shorthand`,\n              );\n            }\n            break;\n          case TokenType.SLASH:\n            if (syntax.length > 0 || slash) {\n              throw new Error(\"unexpected slash\");\n            }\n            slash = true;\n            break;\n          case TokenType.O_BRK:\n            stack.push({ slash, syntax });\n            syntax = [];\n            slash = false;\n            break;\n          case TokenType.C_BRK: {\n            const compound = new ShorthandSyntaxCompound(syntax, slash);\n            const item = stack.pop();\n            syntax = item.syntax;\n            slash = item.slash;\n            syntax.push(compound);\n            break;\n          }\n          case TokenType.SEMICOL:\n            result = true;\n            tok.consume();\n            break;\n          default:\n            throw new Error(\"unexpected token\");\n        }\n      }\n      shorthandValidator.init(syntax, propList);\n      this.shorthands[ruleName] = shorthandValidator;\n    }\n  }\n\n  parse(text: string): void {\n    // Not as robust as CSS parser.\n    const tok = new CssTokenizer.Tokenizer(text, null);\n    this.parseValidators(tok);\n    this.parseDefaults(tok);\n    this.parseShorthands(tok);\n    this.backgroundProps = this.makePropSet([\"background\"]);\n    this.layoutProps = this.makePropSet([\n      \"margin\",\n      \"border\",\n      \"padding\",\n      \"columns\",\n      \"column-gap\",\n      \"column-rule\",\n      \"column-fill\",\n    ]);\n  }\n\n  makePropSet(propList: string[]): ValueMap {\n    const map: ValueMap = {};\n    for (const prop of propList) {\n      const shorthand = this.shorthands[prop];\n      const list = shorthand ? shorthand.propList : [prop];\n      for (const pname of list) {\n        map[pname] = this.defaultValues[pname] ?? Css.ident.initial;\n      }\n    }\n    return map;\n  }\n\n  validatePropertyAndHandleShorthand(\n    name: string,\n    value: Css.Val,\n    important: boolean,\n    receiver: PropertyReceiver,\n  ): void {\n    const ruleType = (receiver as PropertyReceiver & { ruleType?: string })\n      .ruleType;\n    if (\n      Css.isCustomPropName(name) ||\n      // Check if it is a `@font-face` descriptor (Issue #1307)\n      ruleType === \"font-face\" ||\n      // Check if the property value containing `var(\u2026)`\n      containsVar(value)\n    ) {\n      receiver.simpleProperty(name, value, important);\n      return;\n    }\n    if (ruleType === \"counter-style\") {\n      if (CounterStyle.validateDescriptorValue(name, value)) {\n        receiver.simpleProperty(name, value, important);\n      } else {\n        receiver.invalidPropertyValue(name, value);\n      }\n      return;\n    }\n    let prefix = \"\";\n    const origName = name;\n    name = name.toLowerCase();\n    const r = name.match(/^-([a-z]+)-([-a-z0-9]+)$/);\n    if (r) {\n      prefix = r[1];\n      name = r[2];\n    }\n    const px = this.prefixes[name];\n    if (!px || !px[prefix]) {\n      if (CSS.supports(origName, value.toString())) {\n        // Browser supports this property\n        receiver.simpleProperty(origName, value, important);\n      } else if (prefix && !Base.knownPrefixes.includes(`-${prefix}-`)) {\n        // Ignore properties with unknown prefix to avoid unnecessary warnings\n      } else {\n        receiver.unknownProperty(origName, value);\n      }\n      return;\n    }\n    const validator = this.validators[name];\n    if (validator) {\n      const rvalue =\n        Css.isDefaultingValue(value) || value.isExpr()\n          ? value\n          : value.visit(validator);\n      if (rvalue) {\n        receiver.simpleProperty(name, rvalue, important);\n      } else if (!prefix && CSS.supports(name, value.toString())) {\n        // Browser supports this property value\n        receiver.simpleProperty(name, value, important);\n      } else {\n        receiver.invalidPropertyValue(origName, value);\n      }\n    } else {\n      const shorthand = this.shorthands[name].clone();\n      if (Css.isDefaultingValue(value)) {\n        shorthand.propagateDefaultingValue(value, important, receiver);\n      } else {\n        value.visit(shorthand);\n        if (!shorthand.finish(important, receiver)) {\n          receiver.invalidPropertyValue(origName, value);\n        }\n      }\n    }\n  }\n}\n\nexport function baseValidatorSet(): ValidatorSet {\n  const validatorSet = new ValidatorSet();\n  validatorSet.initBuiltInValidators();\n  validatorSet.parse(ValidationTxt);\n  return validatorSet;\n}\n\nclass VarCheckVisitor extends Css.Visitor {\n  varFound = false;\n\n  visitFunc(func: Css.Func): Css.Val {\n    if (func.name === \"var\") {\n      this.varFound = true;\n    } else if (!this.varFound) {\n      this.visitValues(func.values);\n    }\n    return null;\n  }\n}\n\nexport function containsVar(val: Css.Val): boolean {\n  const varCheckVisitor = new VarCheckVisitor();\n  val.visit(varCheckVisitor);\n  return varCheckVisitor.varFound;\n}\n", "/**\n * Copyright 2013 Google, Inc.\n * Copyright 2015 Daishinsha Inc.\n * Copyright 2019 Vivliostyle Foundation\n *\n * Vivliostyle.js is free software: you can redistribute it and/or modify\n * it under the terms of the GNU Affero General Public License as published by\n * the Free Software Foundation, either version 3 of the License, or\n * (at your option) any later version.\n *\n * Vivliostyle.js is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n * GNU Affero General Public License for more details.\n *\n * You should have received a copy of the GNU Affero General Public License\n * along with Vivliostyle.js.  If not, see <http://www.gnu.org/licenses/>.\n *\n * @fileoverview Font - Deal with embedded fonts.\n */\nimport * as Base from \"./base\";\nimport * as Css from \"./css\";\nimport * as CssCascade from \"./css-cascade\";\nimport * as Exprs from \"./exprs\";\nimport * as Logging from \"./logging\";\nimport * as Net from \"./net\";\nimport * as Task from \"./task\";\nimport * as TaskUtil from \"./task-util\";\n\nexport const bogusFontData = `OTTO${new Date().valueOf()}`;\n\nexport let bogusFontCounter: number = 1;\n\nfunction getFontTraitNames(properties: { [key: string]: Css.Val }): string[] {\n  return Object.keys(properties)\n    .filter((prop) => ![\"src\", \"font-family\", \"font-display\"].includes(prop))\n    .sort();\n}\n\nexport function makeFontTraitKey(properties: {\n  [key: string]: Css.Val;\n}): string {\n  const sb = new Base.StringBuffer();\n  for (const prop of getFontTraitNames(properties)) {\n    sb.append(`${prop}:${properties[prop].toString()};`);\n  }\n  return sb.toString();\n}\n\nexport function prepareProperties(\n  properties: CssCascade.ElementStyle,\n  context: Exprs.Context,\n): { [key: string]: Css.Val } {\n  const result = {} as { [key: string]: Css.Val };\n  for (const prop in properties) {\n    result[prop] = CssCascade.getProp(properties, prop).evaluate(context, prop);\n  }\n  return result;\n}\n\n/**\n * A font declared in a font-face rule.\n */\nexport class Face {\n  fontTraitKey: string;\n  src: string | null;\n  blobURLs: string[] = [];\n  blobs: Blob[] = [];\n  family: string | null;\n\n  constructor(public readonly properties: { [key: string]: Css.Val }) {\n    this.fontTraitKey = makeFontTraitKey(this.properties);\n    this.src = this.properties[\"src\"]\n      ? this.properties[\"src\"].toString()\n      : null;\n    const family = this.properties[\"font-family\"];\n    this.family = family ? family.stringValue() : null;\n  }\n\n  /**\n   * Check if font traits are the same for two font faces\n   */\n  traitsEqual(other: Face): boolean {\n    return this.fontTraitKey == other.fontTraitKey;\n  }\n\n  /**\n   * Create \"at\" font-face rule.\n   */\n  makeAtRule(src: string, fontBytes: Blob): string {\n    const sb = new Base.StringBuffer();\n    sb.append(\"@font-face {\\n  font-family: \");\n    sb.append(this.family as string);\n    sb.append(\";\\n  \");\n    for (const prop of getFontTraitNames(this.properties)) {\n      sb.append(prop);\n      sb.append(\": \");\n      this.properties[prop].appendTo(sb, true);\n      sb.append(\";\\n  \");\n    }\n    if (fontBytes) {\n      sb.append('src: url(\"');\n      const blobURL = Net.createObjectURL(fontBytes);\n      sb.append(blobURL);\n      this.blobURLs.push(blobURL);\n      this.blobs.push(fontBytes);\n      sb.append('\")');\n    } else {\n      sb.append(\"src: \");\n      sb.append(src);\n    }\n    sb.append(\";\\n}\\n\");\n    return sb.toString();\n  }\n}\n\n/**\n * Set of the fonts declared in all stylesheets of a document.\n * @param deobfuscator function\n *     that takes url and returns data deobfuscator\n */\nexport class DocumentFaces {\n  /**\n   * Maps source font family names to the family names used in the HTML view.\n   */\n  familyMap = {} as { [key: string]: string };\n\n  constructor(\n    public readonly deobfuscator:\n      | ((p1: string) => ((p1: Blob) => Task.Result<Blob>) | null)\n      | null,\n  ) {}\n\n  registerFamily(srcFace: Face, viewFace: Face): void {\n    const srcFamily = srcFace.family as string;\n    const viewFamilyFromSrc = this.familyMap[srcFamily];\n    const viewFamilyFromView = viewFace.family;\n    if (viewFamilyFromSrc) {\n      if (viewFamilyFromSrc != viewFamilyFromView) {\n        throw new Error(`E_FONT_FAMILY_INCONSISTENT ${srcFace.family}`);\n      }\n    } else {\n      this.familyMap[srcFamily] = viewFamilyFromView as string;\n    }\n  }\n\n  filterFontFamily(val: Css.Val): Css.Val {\n    if (val instanceof Css.CommaList) {\n      const list = (val as Css.CommaList).values;\n      const newValues = [] as Css.Val[];\n      for (const v of list) {\n        const r = this.familyMap[v.stringValue()];\n        if (r) {\n          newValues.push(Css.getName(r));\n        }\n        newValues.push(v);\n      }\n      return new Css.CommaList(newValues);\n    } else {\n      const rf = this.familyMap[val.stringValue()];\n      if (rf) {\n        return new Css.CommaList([Css.getName(rf), val]);\n      }\n      return val;\n    }\n  }\n}\n\n/**\n * Object that loads fonts in a document and allocates font families for them\n * in the view document\n * @param head where to add styles in the view document (normally head element)\n * @param body where to probe text in the view document (normally body element)\n */\nexport class Mapper {\n  /**\n   * Maps Face.src to an entry for an already-loaded font.\n   */\n  srcURLMap: { [key: string]: TaskUtil.Fetcher<Face> } = {};\n  familyPrefix: string;\n  familyCounter: number = 0;\n\n  constructor(\n    public readonly head: Element,\n    public readonly body: Element,\n    opt_familyPrefix?: string,\n  ) {\n    this.familyPrefix = opt_familyPrefix || \"Fnt_\";\n  }\n\n  getViewFontFamily(srcFace: Face, documentFaces: DocumentFaces): string {\n    const srcFamily = srcFace.family as string;\n    let viewFamily = documentFaces.familyMap[srcFamily];\n    if (viewFamily) {\n      return viewFamily;\n    }\n    viewFamily = this.familyPrefix + ++this.familyCounter;\n    documentFaces.familyMap[srcFamily] = viewFamily;\n    return viewFamily;\n  }\n\n  /**\n   * @param fontBytes deobfuscated font bytes (if deobfuscation is needed)\n   */\n  private initFont(\n    srcFace: Face,\n    fontBytes: Blob,\n    documentFaces: DocumentFaces,\n  ): Task.Result<Face> {\n    const frame: Task.Frame<Face> = Task.newFrame(\"initFont\");\n    const src = srcFace.src as string;\n    const props = {} as { [key: string]: Css.Val };\n    for (const prop of getFontTraitNames(srcFace.properties)) {\n      props[prop] = srcFace.properties[prop];\n    }\n    const fontFamily = this.getViewFontFamily(srcFace, documentFaces);\n    props[\"font-family\"] = Css.getName(fontFamily);\n    const viewFontFace = new Face(props);\n    const style = this.head.ownerDocument.createElement(\"style\");\n    style.textContent = viewFontFace.makeAtRule(src, fontBytes);\n    this.head.appendChild(style);\n    Logging.logger.debug(\"Load font:\", src);\n    frame.finish(viewFontFace);\n    return frame.result();\n  }\n\n  loadFont(\n    srcFace: Face,\n    documentFaces: DocumentFaces,\n  ): TaskUtil.Fetcher<Face> {\n    const src = srcFace.src as string;\n    const srcFamilySrc = srcFace.family + \";\" + src;\n    let fetcher = this.srcURLMap[srcFamilySrc];\n    if (fetcher) {\n      fetcher.piggyback((viewFaceParam) => {\n        const viewFace = viewFaceParam as Face;\n        if (!viewFace.traitsEqual(srcFace)) {\n          Logging.logger.warn(\"E_FONT_FACE_INCOMPATIBLE\", srcFace.src);\n        } else {\n          documentFaces.registerFamily(srcFace, viewFace);\n          Logging.logger.debug(\"Found already-loaded font:\", src);\n        }\n      });\n    } else {\n      fetcher = new TaskUtil.Fetcher(() => {\n        const frame: Task.Frame<Face> = Task.newFrame(\"loadFont\");\n        // Get URL from `@font-face` src value.\n        const url = src.replace(/^url\\(\"([^\"]+)\"\\).*$/, \"$1\");\n        const deobfuscator = documentFaces.deobfuscator\n          ? documentFaces.deobfuscator(url)\n          : null;\n        if (deobfuscator) {\n          Net.fetchFromURL(url, Net.FetchResponseType.BLOB).then((response) => {\n            if (!response.responseBlob) {\n              frame.finish(null);\n              return;\n            }\n            deobfuscator(response.responseBlob).then((fontBytes) => {\n              this.initFont(srcFace, fontBytes, documentFaces).thenFinish(\n                frame,\n              );\n            });\n          });\n        } else {\n          this.initFont(srcFace, null, documentFaces).thenFinish(frame);\n        }\n        return frame.result();\n      }, `loadFont ${src}`);\n      this.srcURLMap[srcFamilySrc] = fetcher;\n      fetcher.start();\n    }\n    return fetcher;\n  }\n\n  findOrLoadFonts(\n    srcFaces: Face[],\n    documentFaces: DocumentFaces,\n  ): Task.Result<boolean> {\n    const fetchers = [] as TaskUtil.Fetcher<Face>[];\n    for (const srcFace of srcFaces) {\n      if (!srcFace.src || !srcFace.family) {\n        Logging.logger.warn(\"E_FONT_FACE_INVALID\");\n        continue;\n      }\n      fetchers.push(this.loadFont(srcFace, documentFaces));\n    }\n    return TaskUtil.waitForFetchers(fetchers).thenAsync(() =>\n      this.waitFontLoading(),\n    );\n  }\n\n  waitFontLoading(): Task.Result<boolean> {\n    const fonts = this.head.ownerDocument.fonts; // FontFaceSet\n    let unloadedCount = 0;\n    fonts.forEach((fontFace) => {\n      if (fontFace.status === \"unloaded\") {\n        unloadedCount++;\n        fontFace.load().catch((e) => {\n          // Prevent \"A network error occurred.\" errors in console\n        });\n      }\n    });\n    if (unloadedCount === 0) {\n      return Task.newResult(true);\n    }\n    const frame: Task.Frame<boolean> = Task.newFrame(\"waitFontLoading\");\n    frame\n      .loop(() => {\n        return frame.sleep(20).thenAsync(() => {\n          if (fonts.status === \"loading\") {\n            return Task.newResult(true); // continue\n          }\n          return Task.newResult(false); // break\n        });\n      })\n      .thenFinish(frame);\n    return frame.result();\n  }\n}\n", "/**\n * Copyright 2013 Google, Inc.\n * Copyright 2015 Daishinsha Inc.\n * Copyright 2019 Vivliostyle Foundation\n *\n * Vivliostyle.js is free software: you can redistribute it and/or modify\n * it under the terms of the GNU Affero General Public License as published by\n * the Free Software Foundation, either version 3 of the License, or\n * (at your option) any later version.\n *\n * Vivliostyle.js is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n * GNU Affero General Public License for more details.\n *\n * You should have received a copy of the GNU Affero General Public License\n * along with Vivliostyle.js.  If not, see <http://www.gnu.org/licenses/>.\n *\n * @fileoverview PageMaster - Deal with page masters, partition groups, and partitions.\n */\nimport * as Base from \"./base\";\nimport * as Css from \"./css\";\nimport * as CssCascade from \"./css-cascade\";\nimport { PageRuleMaster, PageRuleMasterInstance } from \"./css-page\";\nimport * as CssParser from \"./css-parser\";\nimport * as CssValidator from \"./css-validator\";\nimport * as Exprs from \"./exprs\";\nimport * as Font from \"./font\";\nimport * as LayoutHelper from \"./layout-helper\";\nimport { StyleInstance } from \"./ops\";\nimport * as Vtree from \"./vtree\";\n\nexport let keyCount: number = 1;\n\n/**\n * Represent an at-rule which creates a page-level CSS box (page-master,\n * partition, and partition-group).\n */\nexport abstract class PageBox<\n  I extends PageBoxInstance = PageBoxInstance<any>,\n> {\n  // styles specified in the at-rule\n  specified: CssCascade.ElementStyle = {};\n  children: PageBox[] = [];\n  pageMaster: PageMaster = null;\n  index: number = 0;\n  key: string;\n\n  protected _scope: Exprs.LexicalScope;\n\n  get scope(): Exprs.LexicalScope {\n    return this._scope;\n  }\n\n  constructor(\n    scope: Exprs.LexicalScope,\n    public readonly name: string | null,\n    public readonly pseudoName: string | null,\n    public readonly classes: string[],\n    public readonly parent: PageBox,\n  ) {\n    this._scope = scope;\n    this.key = `p${keyCount++}`;\n    if (parent) {\n      this.index = parent.children.length;\n      parent.children.push(this);\n    }\n  }\n\n  createInstance(parentInstance: PageBoxInstance): PageBoxInstance {\n    throw new Error(\"E_UNEXPECTED_CALL\");\n  }\n\n  /**\n   * Clone the PageBox.\n   * @param param parent: The parent of the cloned PageBox.\n   *     pseudoName: Assign this value as the pseudoName of the cloned PageBox.\n   */\n  clone(param: { parent?: PageBox; pseudoName?: string }): PageBox<I> {\n    throw new Error(\"E_UNEXPECTED_CALL\");\n  }\n\n  /**\n   * Copy 'specified' properties to another instance.\n   * @param dest The PageBox into which 'specified' properties are copied\n   */\n  protected copySpecified(dest: PageBox) {\n    const specified = this.specified;\n    const destSpecified = dest.specified;\n    for (const prop in specified) {\n      if (Object.prototype.hasOwnProperty.call(specified, prop)) {\n        destSpecified[prop] = specified[prop];\n      }\n    }\n  }\n\n  /**\n   * Clone children with the specified PageBox as their parent.\n   */\n  protected cloneChildren(parent: PageBox) {\n    for (let i = 0; i < this.children.length; i++) {\n      // the cloned child is added to parent.children in the child constructor.\n      this.children[i].clone({ parent });\n    }\n  }\n}\n\n/**\n * Parent of all page masters\n */\nexport class RootPageBox extends PageBox<RootPageBoxInstance> {\n  constructor(scope: Exprs.LexicalScope) {\n    super(scope, null, null, [], null);\n    this.specified[\"width\"] = new CssCascade.CascadeValue(Css.fullWidth, 0);\n    this.specified[\"height\"] = new CssCascade.CascadeValue(Css.fullHeight, 0);\n  }\n}\n\nexport class PageMasterScope extends Exprs.LexicalScope {\n  constructor(\n    scope: Exprs.LexicalScope,\n    public pageMaster: PageMaster,\n  ) {\n    super(scope, resolver);\n    const self = this;\n    function resolver(qualifiedName, isFunc) {\n      const r = qualifiedName.match(/^([^.]+)\\.([^.]+)$/);\n      if (r) {\n        const key = self.pageMaster.keyMap[r[1]];\n        if (key) {\n          const holder = this as InstanceHolder;\n          const boxInstance = holder.lookupInstance(key);\n          if (boxInstance) {\n            if (isFunc) {\n              return boxInstance.resolveFunc(r[2]);\n            } else {\n              return boxInstance.resolveName(r[2]);\n            }\n          }\n        }\n      }\n      return null;\n    }\n  }\n}\n\n/**\n * Represent a page-master rule\n */\nexport class PageMaster<\n  I extends PageMasterInstance = PageMasterInstance<any>,\n> extends PageBox<I> {\n  keyMap: { [key: string]: string } = {};\n\n  constructor(\n    scope: Exprs.LexicalScope,\n    name: string | null,\n    pseudoName: string | null,\n    classes: string[],\n    parent: RootPageBox,\n    public readonly condition: Exprs.Val,\n    public readonly specificity: number,\n  ) {\n    super(scope, name, pseudoName, classes, parent);\n    // if PageMasterScope object is passed, use (share) it.\n    if (!(scope instanceof PageMasterScope)) {\n      this._scope = new PageMasterScope(scope, this);\n    }\n    this.pageMaster = this;\n    this.specified[\"width\"] = new CssCascade.CascadeValue(Css.fullWidth, 0);\n    this.specified[\"height\"] = new CssCascade.CascadeValue(Css.fullHeight, 0);\n    this.specified[\"wrap-flow\"] = new CssCascade.CascadeValue(\n      Css.ident.auto,\n      0,\n    );\n    this.specified[\"position\"] = new CssCascade.CascadeValue(\n      Css.ident.relative,\n      0,\n    );\n    this.specified[\"overflow\"] = new CssCascade.CascadeValue(\n      Css.ident.visible,\n      0,\n    );\n  }\n\n  override createInstance(parentInstance: PageBoxInstance): PageBoxInstance {\n    return new PageMasterInstance(parentInstance, this);\n  }\n\n  override clone(param): PageMaster {\n    // The cloned page master shares the same scope object with the original\n    // one.\n    const cloned = new PageMaster(\n      this.scope,\n      this.name,\n      param.pseudoName || this.pseudoName,\n      this.classes,\n      this.parent as RootPageBox,\n      this.condition,\n      this.specificity,\n    );\n    this.copySpecified(cloned);\n    this.cloneChildren(cloned);\n    return cloned;\n  }\n\n  /**\n   * Point the pageMaster reference in the PageMasterScope to the current page\n   * master. This is needed when a page master is cloned and shares a common\n   * scope with the original page master. Since every Exprs.Val which the\n   * page master holds has a reference to the scope and uses it for variable\n   * resolution, this reference must be updated properly before the page master\n   * instance is used.\n   */\n  resetScope() {\n    (this.scope as any).pageMaster = this;\n  }\n}\n\n/**\n * Represent a partition-group rule\n */\nexport class PartitionGroup extends PageBox<PartitionGroupInstance> {\n  constructor(\n    scope: Exprs.LexicalScope,\n    name: string | null,\n    pseudoName: string | null,\n    classes: string[],\n    parent: PageBox,\n  ) {\n    super(scope, name, pseudoName, classes, parent);\n    this.pageMaster = parent.pageMaster;\n    if (name) {\n      this.pageMaster.keyMap[name] = this.key;\n    }\n    this.specified[\"wrap-flow\"] = new CssCascade.CascadeValue(\n      Css.ident.auto,\n      0,\n    );\n  }\n\n  override createInstance(parentInstance: PageBoxInstance): PageBoxInstance {\n    return new PartitionGroupInstance(parentInstance, this);\n  }\n\n  override clone(param): PartitionGroup {\n    const cloned = new PartitionGroup(\n      param.parent.scope,\n      this.name,\n      this.pseudoName,\n      this.classes,\n      param.parent,\n    );\n    this.copySpecified(cloned);\n    this.cloneChildren(cloned);\n    return cloned;\n  }\n}\n\n/**\n * Represent a partition rule\n */\nexport class Partition<\n  I extends PartitionInstance = PartitionInstance,\n> extends PageBox<I> {\n  constructor(\n    scope: Exprs.LexicalScope,\n    name: string | null,\n    pseudoName: string | null,\n    classes: string[],\n    parent: PageBox,\n  ) {\n    super(scope, name, pseudoName, classes, parent);\n    this.pageMaster = parent.pageMaster;\n    if (name) {\n      this.pageMaster.keyMap[name] = this.key;\n    }\n  }\n\n  override createInstance(parentInstance: PageBoxInstance): PageBoxInstance {\n    return new PartitionInstance(parentInstance, this);\n  }\n\n  override clone(param): Partition {\n    const cloned = new Partition(\n      param.parent.scope,\n      this.name,\n      this.pseudoName,\n      this.classes,\n      param.parent,\n    );\n    this.copySpecified(cloned);\n    this.cloneChildren(cloned);\n    return cloned;\n  }\n}\n\n//---------------------------- Instance --------------------------------\n\n/**\n * @param def default value\n */\nexport function toExprIdent(\n  scope: Exprs.LexicalScope,\n  val: Css.Val,\n  def: string,\n): Exprs.Val {\n  if (!val || Css.isDefaultingValue(val)) {\n    return new Exprs.Const(scope, def);\n  }\n  return val.toExpr(scope, scope.zero);\n}\n\nexport function toExprAuto(\n  scope: Exprs.LexicalScope,\n  val: Css.Val,\n  ref: Exprs.Val,\n): Exprs.Val {\n  if (!val || val === Css.ident.auto || Css.isDefaultingValue(val)) {\n    return null;\n  }\n  return val.toExpr(scope, ref);\n}\n\nexport function toExprNormal(\n  scope: Exprs.LexicalScope,\n  val: Css.Val,\n  ref: Exprs.Val,\n): Exprs.Val {\n  if (!val || val === Css.ident.normal || Css.isDefaultingValue(val)) {\n    return null;\n  }\n  return val.toExpr(scope, ref);\n}\n\nexport function toExprZero(\n  scope: Exprs.LexicalScope,\n  val: Css.Val,\n  ref: Exprs.Val,\n): Exprs.Val {\n  if (!val || val === Css.ident.auto || Css.isDefaultingValue(val)) {\n    return scope.zero;\n  }\n  return val.toExpr(scope, ref);\n}\n\n/**\n * If the value is not specified (null), returns zero.\n * If the value is 'auto', returns null.\n * Otherwise, return the value itself.\n */\nexport function toExprZeroAuto(\n  scope: Exprs.LexicalScope,\n  val: Css.Val,\n  ref: Exprs.Val,\n): Exprs.Val {\n  if (!val || Css.isDefaultingValue(val)) {\n    return scope.zero;\n  } else if (val === Css.ident.auto) {\n    return null;\n  } else {\n    return val.toExpr(scope, ref);\n  }\n}\n\nexport function toExprZeroBorder(\n  scope: Exprs.LexicalScope,\n  val: Css.Val,\n  styleVal: Css.Val,\n  ref: Exprs.Val,\n): Exprs.Val {\n  if (!val || styleVal === Css.ident.none || Css.isDefaultingValue(val)) {\n    return scope.zero;\n  }\n  return val.toExpr(scope, ref);\n}\n\nexport function toExprBool(\n  scope: Exprs.LexicalScope,\n  val: Css.Val,\n  def: Exprs.Val,\n): Exprs.Val {\n  if (!val || Css.isDefaultingValue(val)) {\n    return def;\n  }\n  if (val === Css.ident._true) {\n    return scope._true;\n  }\n  if (val === Css.ident._false) {\n    return scope._false;\n  }\n  return val.toExpr(scope, scope.zero);\n}\n\nexport interface InstanceHolder extends Exprs.Context {\n  registerInstance(key: string, instance: PageBoxInstance): void;\n\n  /**\n   * @return instance\n   */\n  lookupInstance(key: string): PageBoxInstance;\n}\n\nexport class PageBoxInstance<P extends PageBox = PageBox<any>> {\n  /**\n   * cascaded styles, geometric ones converted to Css.Expr\n   */\n  protected cascaded: CssCascade.ElementStyle = {};\n  style: { [key: string]: Css.Val } = {};\n  private autoWidth: Exprs.Native = null;\n  private autoHeight: Exprs.Native = null;\n  children: PageBoxInstance[] = [];\n  isAutoWidth: boolean = false;\n  isAutoHeight: boolean = false;\n  isTopDependentOnAutoHeight: boolean = false;\n  isRightDependentOnAutoWidth: boolean = false;\n  private calculatedWidth: number = 0;\n  private calculatedHeight: number = 0;\n  pageMasterInstance: PageMasterInstance = null;\n  namedValues: { [key: string]: Exprs.Val } = {};\n  namedFuncs: { [key: string]: Exprs.Val } = {};\n  vertical: boolean = false;\n  rtl: boolean = false;\n  suppressEmptyBoxGeneration: boolean = false;\n  borderBoxSizing: boolean = false;\n\n  constructor(\n    public readonly parentInstance: PageBoxInstance,\n    public readonly pageBox: P,\n  ) {\n    if (parentInstance) {\n      parentInstance.children.push(this);\n    }\n  }\n\n  /**\n   * Reset information related to layout.\n   */\n  reset() {\n    this.calculatedWidth = 0;\n    this.calculatedHeight = 0;\n  }\n\n  private addNamedValues(name1: string, name2: string): Exprs.Val {\n    const v1 = this.resolveName(name1);\n    const v2 = this.resolveName(name2);\n    if (!v1 || !v2) {\n      throw new Error(\"E_INTERNAL\");\n    }\n    return Exprs.add(this.pageBox.scope, v1, v2);\n  }\n\n  resolveName(name: string): Exprs.Val {\n    let expr = this.namedValues[name];\n    if (expr) {\n      return expr;\n    }\n    const val = this.style[name];\n    if (val) {\n      expr = val.toExpr(this.pageBox.scope, this.pageBox.scope.zero);\n    }\n    switch (name) {\n      case \"margin-left-edge\":\n        expr = this.resolveName(\"left\");\n        break;\n      case \"margin-top-edge\":\n        expr = this.resolveName(\"top\");\n        break;\n      case \"margin-right-edge\":\n        expr = this.addNamedValues(\"border-right-edge\", \"margin-right\");\n        break;\n      case \"margin-bottom-edge\":\n        expr = this.addNamedValues(\"border-bottom-edge\", \"margin-bottom\");\n        break;\n      case \"border-left-edge\":\n        expr = this.addNamedValues(\"margin-left-edge\", \"margin-left\");\n        break;\n      case \"border-top-edge\":\n        expr = this.addNamedValues(\"margin-top-edge\", \"margin-top\");\n        break;\n      case \"border-right-edge\":\n        expr = this.addNamedValues(\"padding-right-edge\", \"border-right-width\");\n        break;\n      case \"border-bottom-edge\":\n        expr = this.addNamedValues(\n          \"padding-bottom-edge\",\n          \"border-bottom-width\",\n        );\n        break;\n      case \"padding-left-edge\":\n        expr = this.addNamedValues(\"border-left-edge\", \"border-left-width\");\n        break;\n      case \"padding-top-edge\":\n        expr = this.addNamedValues(\"border-top-edge\", \"border-top-width\");\n        break;\n      case \"padding-right-edge\":\n        expr = this.addNamedValues(\"right-edge\", \"padding-right\");\n        break;\n      case \"padding-bottom-edge\":\n        expr = this.addNamedValues(\"bottom-edge\", \"padding-bottom\");\n        break;\n      case \"left-edge\":\n        expr = this.addNamedValues(\"padding-left-edge\", \"padding-left\");\n        break;\n      case \"top-edge\":\n        expr = this.addNamedValues(\"padding-top-edge\", \"padding-top\");\n        break;\n      case \"right-edge\":\n        expr = this.addNamedValues(\"left-edge\", \"width\");\n        break;\n      case \"bottom-edge\":\n        expr = this.addNamedValues(\"top-edge\", \"height\");\n        break;\n    }\n    if (!expr) {\n      let altName: string;\n      if (name == \"extent\") {\n        altName = this.vertical ? \"width\" : \"height\";\n      } else if (name == \"measure\") {\n        altName = this.vertical ? \"height\" : \"width\";\n      } else {\n        const map = this.vertical\n          ? CssCascade.couplingMapVert\n          : CssCascade.couplingMapHor;\n        altName = name;\n        for (const key in map) {\n          altName = altName.replace(key, map[key]);\n        }\n      }\n      if (altName != name) {\n        expr = this.resolveName(altName);\n      }\n    }\n    if (expr) {\n      this.namedValues[name] = expr;\n    }\n    return expr;\n  }\n\n  resolveFunc(name) {\n    let expr = this.namedFuncs[name];\n    if (expr) {\n      return expr;\n    }\n    switch (name) {\n      case \"columns\": {\n        // min(count,column-count) * (column-width + column-gap) - column-gap\n        const scope = this.pageBox.scope;\n        const count = new Exprs.Param(scope, 0);\n        const columnCount = this.resolveName(\"column-count\");\n        const columnWidth = this.resolveName(\"column-width\");\n        const columnGap = this.resolveName(\"column-gap\");\n        expr = Exprs.sub(\n          scope,\n          Exprs.mul(\n            scope,\n            new Exprs.Call(scope, \"min\", [count, columnCount]),\n            Exprs.add(scope, columnWidth, columnGap),\n          ),\n          columnGap,\n        );\n        break;\n      }\n    }\n    if (expr) {\n      this.namedFuncs[name] = expr;\n    }\n    return expr;\n  }\n\n  private initEnabled(): void {\n    const scope = this.pageBox.scope;\n    const style = this.style;\n    let enabled = toExprBool(scope, style[\"enabled\"], scope._true);\n    const page = toExprAuto(scope, style[\"page\"], scope.zero);\n    if (page) {\n      const currentPage = new Exprs.Named(scope, \"page-number\");\n      enabled = Exprs.and(\n        scope,\n        enabled,\n        new Exprs.Eq(scope, page, currentPage),\n      );\n    }\n    const minPageWidth = toExprAuto(scope, style[\"min-page-width\"], scope.zero);\n    if (minPageWidth) {\n      enabled = Exprs.and(\n        scope,\n        enabled,\n        new Exprs.Ge(scope, new Exprs.Named(scope, \"page-width\"), minPageWidth),\n      );\n    }\n    const minPageHeight = toExprAuto(\n      scope,\n      style[\"min-page-height\"],\n      scope.zero,\n    );\n    if (minPageHeight) {\n      enabled = Exprs.and(\n        scope,\n        enabled,\n        new Exprs.Ge(\n          scope,\n          new Exprs.Named(scope, \"page-height\"),\n          minPageHeight,\n        ),\n      );\n    }\n    enabled = this.boxSpecificEnabled(enabled);\n    style[\"enabled\"] = new Css.Expr(enabled);\n  }\n\n  protected boxSpecificEnabled(enabled: Exprs.Val): Exprs.Val {\n    return enabled;\n  }\n\n  protected initHorizontal(): void {\n    const scope = this.pageBox.scope;\n    const style = this.style;\n    const parentWidth = this.parentInstance\n      ? this.parentInstance.style[\"width\"].toExpr(scope, null)\n      : null;\n    let left = toExprAuto(scope, style[\"left\"], parentWidth);\n    let marginLeft = toExprAuto(scope, style[\"margin-left\"], parentWidth);\n    const borderLeftWidth = toExprZeroBorder(\n      scope,\n      style[\"border-left-width\"],\n      style[\"border-left-style\"],\n      parentWidth,\n    );\n    const paddingLeft = toExprZero(scope, style[\"padding-left\"], parentWidth);\n    let width = toExprAuto(scope, style[\"width\"], parentWidth);\n    let maxWidth = toExprAuto(scope, style[\"max-width\"], parentWidth);\n    const paddingRight = toExprZero(scope, style[\"padding-right\"], parentWidth);\n    const borderRightWidth = toExprZeroBorder(\n      scope,\n      style[\"border-right-width\"],\n      style[\"border-right-style\"],\n      parentWidth,\n    );\n    let marginRight = toExprAuto(scope, style[\"margin-right\"], parentWidth);\n    let right = toExprAuto(scope, style[\"right\"], parentWidth);\n    const leftBP = Exprs.add(scope, borderLeftWidth, paddingLeft);\n    const rightBP = Exprs.add(scope, borderLeftWidth, paddingRight);\n    if (left && right && width) {\n      let extra = Exprs.sub(\n        scope,\n        parentWidth,\n        Exprs.add(\n          scope,\n          width,\n          Exprs.add(scope, Exprs.add(scope, left, leftBP), rightBP),\n        ),\n      );\n      if (!marginLeft) {\n        extra = Exprs.sub(scope, extra, right);\n        if (!marginRight) {\n          marginLeft = Exprs.mul(scope, extra, new Exprs.Const(scope, 0.5));\n          marginRight = marginLeft;\n        } else {\n          marginLeft = Exprs.sub(scope, extra, marginRight);\n        }\n      } else {\n        if (!marginRight) {\n          marginRight = Exprs.sub(\n            scope,\n            extra,\n            Exprs.add(scope, right, marginLeft),\n          );\n        } else {\n          // overconstraint\n          right = Exprs.sub(scope, extra, marginRight);\n        }\n      }\n    } else {\n      if (!marginLeft) {\n        marginLeft = scope.zero;\n      }\n      if (!marginRight) {\n        marginRight = scope.zero;\n      }\n      if (!left && !right && !width) {\n        left = scope.zero;\n      }\n      if (!left && !width) {\n        width = this.autoWidth;\n        this.isAutoWidth = true;\n      } else if (!left && !right) {\n        left = scope.zero;\n      } else if (!width && !right) {\n        width = this.autoWidth;\n        this.isAutoWidth = true;\n      }\n      const remains = Exprs.sub(\n        scope,\n        parentWidth,\n        Exprs.add(\n          scope,\n          Exprs.add(scope, marginLeft, leftBP),\n          Exprs.add(scope, marginRight, rightBP),\n        ),\n      );\n      if (this.isAutoWidth) {\n        if (!maxWidth) {\n          // TODO: handle the case when right/left depends on width\n          maxWidth = Exprs.sub(scope, remains, left ? left : right);\n        }\n\n        // For multi-column layout, width is max-width.\n        if (\n          !this.vertical &&\n          (toExprAuto(scope, style[\"column-width\"], null) ||\n            toExprAuto(scope, style[\"column-count\"], null))\n        ) {\n          width = maxWidth;\n          this.isAutoWidth = false;\n        }\n      }\n      if (!left) {\n        left = Exprs.sub(scope, remains, Exprs.add(scope, right, width));\n      } else if (!width) {\n        width = Exprs.sub(scope, remains, Exprs.add(scope, left, right));\n      } else if (!right) {\n        right = Exprs.sub(scope, remains, Exprs.add(scope, left, width));\n      }\n    }\n\n    // snap-width is inherited\n    const snapWidthVal =\n      style[\"snap-width\"] ||\n      (this.parentInstance ? this.parentInstance.style[\"snap-width\"] : null);\n    const snapWidth = toExprZero(scope, snapWidthVal, parentWidth);\n    style[\"left\"] = new Css.Expr(left);\n    style[\"margin-left\"] = new Css.Expr(marginLeft);\n    style[\"border-left-width\"] = new Css.Expr(borderLeftWidth);\n    style[\"padding-left\"] = new Css.Expr(paddingLeft);\n    style[\"width\"] = new Css.Expr(width);\n    style[\"max-width\"] = new Css.Expr(maxWidth ? maxWidth : width);\n    style[\"padding-right\"] = new Css.Expr(paddingRight);\n    style[\"border-right-width\"] = new Css.Expr(borderRightWidth);\n    style[\"margin-right\"] = new Css.Expr(marginRight);\n    style[\"right\"] = new Css.Expr(right);\n    style[\"snap-width\"] = new Css.Expr(snapWidth);\n  }\n\n  protected initVertical(): void {\n    const scope = this.pageBox.scope;\n    const style = this.style;\n    const parentWidth = this.parentInstance\n      ? this.parentInstance.style[\"width\"].toExpr(scope, null)\n      : null;\n    const parentHeight = this.parentInstance\n      ? this.parentInstance.style[\"height\"].toExpr(scope, null)\n      : null;\n    let top = toExprAuto(scope, style[\"top\"], parentHeight);\n    let marginTop = toExprAuto(scope, style[\"margin-top\"], parentWidth);\n    const borderTopWidth = toExprZeroBorder(\n      scope,\n      style[\"border-top-width\"],\n      style[\"border-top-style\"],\n      parentWidth,\n    );\n    const paddingTop = toExprZero(scope, style[\"padding-top\"], parentWidth);\n    let height = toExprAuto(scope, style[\"height\"], parentHeight);\n    let maxHeight = toExprAuto(scope, style[\"max-height\"], parentHeight);\n    const paddingBottom = toExprZero(\n      scope,\n      style[\"padding-bottom\"],\n      parentWidth,\n    );\n    const borderBottomWidth = toExprZeroBorder(\n      scope,\n      style[\"border-bottom-width\"],\n      style[\"border-bottom-style\"],\n      parentWidth,\n    );\n    let marginBottom = toExprAuto(scope, style[\"margin-bottom\"], parentWidth);\n    let bottom = toExprAuto(scope, style[\"bottom\"], parentHeight);\n    const topBP = Exprs.add(scope, borderTopWidth, paddingTop);\n    const bottomBP = Exprs.add(scope, borderBottomWidth, paddingBottom);\n    if (top && bottom && height) {\n      let extra = Exprs.sub(\n        scope,\n        parentHeight,\n        Exprs.add(\n          scope,\n          height,\n          Exprs.add(scope, Exprs.add(scope, top, topBP), bottomBP),\n        ),\n      );\n      if (!marginTop) {\n        extra = Exprs.sub(scope, extra, bottom);\n        if (!marginBottom) {\n          marginTop = Exprs.mul(scope, extra, new Exprs.Const(scope, 0.5));\n          marginBottom = marginTop;\n        } else {\n          marginTop = Exprs.sub(scope, extra, marginBottom);\n        }\n      } else {\n        if (!marginBottom) {\n          marginBottom = Exprs.sub(\n            scope,\n            extra,\n            Exprs.add(scope, bottom, marginTop),\n          );\n        } else {\n          // overconstraint\n          bottom = Exprs.sub(scope, extra, marginTop);\n        }\n      }\n    } else {\n      if (!marginTop) {\n        marginTop = scope.zero;\n      }\n      if (!marginBottom) {\n        marginBottom = scope.zero;\n      }\n      if (!top && !bottom && !height) {\n        top = scope.zero;\n      }\n      if (!top && !height) {\n        height = this.autoHeight;\n        this.isAutoHeight = true;\n      } else if (!top && !bottom) {\n        top = scope.zero;\n      } else if (!height && !bottom) {\n        height = this.autoHeight;\n        this.isAutoHeight = true;\n      }\n      const remains = Exprs.sub(\n        scope,\n        parentHeight,\n        Exprs.add(\n          scope,\n          Exprs.add(scope, marginTop, topBP),\n          Exprs.add(scope, marginBottom, bottomBP),\n        ),\n      );\n      if (this.isAutoHeight) {\n        if (!maxHeight) {\n          // TODO: handle the case when top/bottom depends on height\n          maxHeight = Exprs.sub(scope, remains, top ? top : bottom);\n        }\n\n        // For multi-column layout in vertical writing, height is max-height.\n        if (\n          this.vertical &&\n          (toExprAuto(scope, style[\"column-width\"], null) ||\n            toExprAuto(scope, style[\"column-count\"], null))\n        ) {\n          height = maxHeight;\n          this.isAutoHeight = false;\n        }\n      }\n      if (!top) {\n        top = Exprs.sub(scope, remains, Exprs.add(scope, bottom, height));\n      } else if (!height) {\n        height = Exprs.sub(scope, remains, Exprs.add(scope, bottom, top));\n      } else if (!bottom) {\n        bottom = Exprs.sub(scope, remains, Exprs.add(scope, top, height));\n      }\n    }\n\n    // snap-height is inherited\n    const snapHeightVal =\n      style[\"snap-height\"] ||\n      (this.parentInstance ? this.parentInstance.style[\"snap-height\"] : null);\n    const snapHeight = toExprZero(scope, snapHeightVal, parentWidth);\n    style[\"top\"] = new Css.Expr(top);\n    style[\"margin-top\"] = new Css.Expr(marginTop);\n    style[\"border-top-width\"] = new Css.Expr(borderTopWidth);\n    style[\"padding-top\"] = new Css.Expr(paddingTop);\n    style[\"height\"] = new Css.Expr(height);\n    style[\"max-height\"] = new Css.Expr(maxHeight ? maxHeight : height);\n    style[\"padding-bottom\"] = new Css.Expr(paddingBottom);\n    style[\"border-bottom-width\"] = new Css.Expr(borderBottomWidth);\n    style[\"margin-bottom\"] = new Css.Expr(marginBottom);\n    style[\"bottom\"] = new Css.Expr(bottom);\n    style[\"snap-height\"] = new Css.Expr(snapHeight);\n  }\n\n  private initColumns(): void {\n    const scope = this.pageBox.scope;\n    const style = this.style;\n    const width = toExprAuto(\n      scope,\n      style[this.vertical ? \"height\" : \"width\"],\n      null,\n    );\n    let columnWidth = toExprAuto(scope, style[\"column-width\"], width);\n    let columnCount = toExprAuto(scope, style[\"column-count\"], null);\n    let columnGap = toExprNormal(scope, style[\"column-gap\"], null);\n    if (!columnGap) {\n      columnGap = new Exprs.Numeric(scope, 1, \"em\");\n    }\n    if (columnWidth && !columnCount) {\n      columnCount = new Exprs.Call(scope, \"floor\", [\n        Exprs.div(\n          scope,\n          Exprs.add(scope, width, columnGap),\n          Exprs.add(scope, columnWidth, columnGap),\n        ),\n      ]);\n      columnCount = new Exprs.Call(scope, \"max\", [scope.one, columnCount]);\n    }\n    if (!columnCount) {\n      columnCount = scope.one;\n    }\n    columnWidth = Exprs.sub(\n      scope,\n      Exprs.div(scope, Exprs.add(scope, width, columnGap), columnCount),\n      columnGap,\n    );\n    style[\"column-width\"] = new Css.Expr(columnWidth);\n    style[\"column-count\"] = new Css.Expr(columnCount);\n    style[\"column-gap\"] = new Css.Expr(columnGap);\n  }\n\n  private depends(\n    propName: string,\n    val: Exprs.Val,\n    context: Exprs.Context,\n  ): boolean {\n    return this.style[propName]\n      .toExpr(this.pageBox.scope, null)\n      .depend(val, context);\n  }\n\n  private init(context: Exprs.Context): void {\n    // If context does not implement InstanceHolder we would not be able to\n    // resolve \"partition.property\" names later.\n    const holder = context as InstanceHolder;\n    holder.registerInstance(this.pageBox.key, this);\n    const scope = this.pageBox.scope;\n    const style = this.style;\n    const regionIds = this.parentInstance\n      ? this.parentInstance.getActiveRegions(context)\n      : null;\n    const cascMap = CssCascade.flattenCascadedStyle(\n      this.cascaded,\n      context,\n      regionIds,\n      false,\n      null,\n    );\n    this.vertical = CssCascade.isVertical(\n      cascMap,\n      context,\n      this.parentInstance ? this.parentInstance.vertical : false,\n    );\n    this.rtl = CssCascade.isRtl(\n      cascMap,\n      context,\n      this.parentInstance ? this.parentInstance.rtl : false,\n    );\n    this.borderBoxSizing =\n      cascMap[\"box-sizing\"]?.value === Css.ident.border_box;\n    const isLeftPage = !!(\n      context instanceof StyleInstance &&\n      context.currentLayoutPosition &&\n      new Exprs.Named(scope, \"left-page\").evaluate(context)\n    );\n    CssCascade.convertToPhysical(\n      cascMap,\n      style,\n      this.vertical,\n      this.rtl,\n      isLeftPage,\n      (name, cascVal) => cascVal.value,\n    );\n    this.autoWidth = new Exprs.Native(\n      scope,\n      () => this.calculatedWidth,\n      \"autoWidth\",\n    );\n    this.autoHeight = new Exprs.Native(\n      scope,\n      () => this.calculatedHeight,\n      \"autoHeight\",\n    );\n    this.initHorizontal();\n    this.initVertical();\n    this.initColumns();\n    this.initEnabled();\n  }\n\n  getProp(context: Exprs.Context, name: string): Css.Val {\n    let val = this.style[name];\n    if (\n      !val &&\n      CssCascade.isInherited(name) &&\n      // root style is inherited to `@page` but not to `@-epubx-page-master`\n      // (Issue #1565)\n      this.pageMasterInstance instanceof PageRuleMasterInstance\n    ) {\n      // inherit from root style\n      if (\n        name === \"font-size\" &&\n        context.isRelativeRootFontSize &&\n        context.rootFontSize\n      ) {\n        val = new Css.Numeric(context.rootFontSize, \"px\");\n      } else {\n        const rootStyle = (\n          context as Exprs.Context & {\n            styler: { rootStyle: { [key: string]: CssCascade.CascadeValue } };\n          }\n        ).styler?.rootStyle;\n        val = rootStyle[name]?.value;\n      }\n    }\n    if (val) {\n      val = CssCascade.evaluateCSSToCSS(context, val, name);\n    }\n    return val;\n  }\n\n  getPropAsNumber(context: Exprs.Context, name: string): number {\n    let val = this.style[name];\n    if (val) {\n      let percentRef = /\\b(height|top|bottom)\\b/.test(name)\n        ? (context.pageAreaHeight ?? context.pageHeight())\n        : (context.pageAreaWidth ?? context.pageWidth());\n      val = CssCascade.evaluateCSSToCSS(context, val, name, percentRef);\n    }\n    return Css.toNumber(val, context);\n  }\n\n  getSpecial(context: Exprs.Context, name: string): Css.Val[] {\n    const arr = CssCascade.getSpecial(this.cascaded, name);\n    if (arr) {\n      const result = [] as Css.Val[];\n      for (let i = 0; i < arr.length; i++) {\n        const v = arr[i].evaluate(context, \"\");\n        if (v && v !== Css.empty) {\n          result.push(v);\n        }\n      }\n      if (result.length) {\n        return result;\n      }\n    }\n    return null;\n  }\n\n  getActiveRegions(context: Exprs.Context): string[] {\n    const arr = this.getSpecial(context, \"region-id\");\n    if (arr) {\n      const result = [] as string[];\n      for (let i = 0; i < arr.length; i++) {\n        result[i] = arr[i].toString();\n      }\n      return result;\n    }\n    return null;\n  }\n\n  propagateProperty(\n    context: Exprs.Context,\n    container: Vtree.Container,\n    name: string,\n    docFaces: Font.DocumentFaces,\n  ): void {\n    this.propagatePropertyToElement(context, container.element, name, docFaces);\n  }\n\n  propagatePropertyToElement(\n    context: Exprs.Context,\n    element: Element,\n    name: string,\n    docFaces: Font.DocumentFaces,\n  ): void {\n    let val = this.getProp(context, name);\n    if (val) {\n      if (\n        val.isNumeric() &&\n        Exprs.needUnitConversion((val as Css.Numeric).unit)\n      ) {\n        val = Css.convertNumericToPx(val, context);\n      }\n      if (name === \"font-family\") {\n        val = docFaces.filterFontFamily(val);\n      }\n      if (\n        (name.startsWith(\"background\") || name === \"z-index\") &&\n        element.parentElement.hasAttribute(\"data-vivliostyle-bleed-box\")\n      ) {\n        // Move background properties and z-index to the parent bleed-box element.\n        // (Fix for issue #644, #1166)\n        element = element.parentElement;\n      }\n      Base.setCSSProperty(element, name, val.toString());\n    }\n  }\n\n  propagateDelayedProperty(\n    context: Exprs.Context,\n    container: Vtree.Container,\n    name: string,\n    delayedItems: Vtree.DelayedItem[],\n  ): void {\n    const val = this.getProp(context, name);\n    if (val) {\n      delayedItems.push(new Vtree.DelayedItem(container.element, name, val));\n    }\n  }\n\n  assignLeftPosition(context: Exprs.Context, container: Vtree.Container): void {\n    const left = this.getPropAsNumber(context, \"left\");\n    const marginLeft = this.getPropAsNumber(context, \"margin-left\");\n    const paddingLeft = this.getPropAsNumber(context, \"padding-left\");\n    const borderLeftWidth = this.getPropAsNumber(context, \"border-left-width\");\n    const width = this.getPropAsNumber(context, \"width\");\n    container.setHorizontalPosition(left, width);\n    Base.setCSSProperty(container.element, \"margin-left\", `${marginLeft}px`);\n    Base.setCSSProperty(container.element, \"padding-left\", `${paddingLeft}px`);\n    Base.setCSSProperty(\n      container.element,\n      \"border-left-width\",\n      `${borderLeftWidth}px`,\n    );\n    container.marginLeft = marginLeft;\n    container.borderLeft = borderLeftWidth;\n    container.paddingLeft = paddingLeft;\n  }\n\n  assignRightPosition(\n    context: Exprs.Context,\n    container: Vtree.Container,\n  ): void {\n    const right = this.getPropAsNumber(context, \"right\");\n    const snapWidth = this.getPropAsNumber(context, \"snap-height\");\n    const marginRight = this.getPropAsNumber(context, \"margin-right\");\n    let paddingRight = this.getPropAsNumber(context, \"padding-right\");\n    const borderRightWidth = this.getPropAsNumber(\n      context,\n      \"border-right-width\",\n    );\n    Base.setCSSProperty(container.element, \"margin-right\", `${marginRight}px`);\n    Base.setCSSProperty(\n      container.element,\n      \"padding-right\",\n      `${paddingRight}px`,\n    );\n    Base.setCSSProperty(\n      container.element,\n      \"border-right-width\",\n      `${borderRightWidth}px`,\n    );\n    container.marginRight = marginRight;\n    container.borderRight = borderRightWidth;\n    if (this.vertical && snapWidth > 0) {\n      const xpos = right + container.getInsetRight();\n      const r = xpos - Math.floor(xpos / snapWidth) * snapWidth;\n      if (r > 0) {\n        container.snapOffsetX = snapWidth - r;\n        paddingRight += container.snapOffsetX;\n      }\n    }\n    container.paddingRight = paddingRight;\n    container.snapWidth = snapWidth;\n  }\n\n  assignTopPosition(context: Exprs.Context, container: Vtree.Container): void {\n    const snapHeight = this.getPropAsNumber(context, \"snap-height\");\n    const top = this.getPropAsNumber(context, \"top\");\n    const marginTop = this.getPropAsNumber(context, \"margin-top\");\n    let paddingTop = this.getPropAsNumber(context, \"padding-top\");\n    const borderTopWidth = this.getPropAsNumber(context, \"border-top-width\");\n    container.top = top;\n    container.marginTop = marginTop;\n    container.borderTop = borderTopWidth;\n    container.snapHeight = snapHeight;\n    if (!this.vertical && snapHeight > 0) {\n      const ypos = top + container.getInsetTop();\n      const r = ypos - Math.floor(ypos / snapHeight) * snapHeight;\n      if (r > 0) {\n        container.snapOffsetY = snapHeight - r;\n        paddingTop += container.snapOffsetY;\n      }\n    }\n    container.paddingTop = paddingTop;\n    Base.setCSSProperty(container.element, \"top\", `${top}px`);\n    Base.setCSSProperty(container.element, \"margin-top\", `${marginTop}px`);\n    Base.setCSSProperty(container.element, \"padding-top\", `${paddingTop}px`);\n    Base.setCSSProperty(\n      container.element,\n      \"border-top-width\",\n      `${borderTopWidth}px`,\n    );\n  }\n\n  assignBottomPosition(\n    context: Exprs.Context,\n    container: Vtree.Container,\n  ): void {\n    const marginBottom = this.getPropAsNumber(context, \"margin-bottom\");\n    const paddingBottom = this.getPropAsNumber(context, \"padding-bottom\");\n    const borderBottomWidth = this.getPropAsNumber(\n      context,\n      \"border-bottom-width\",\n    );\n    const height =\n      this.getPropAsNumber(context, \"height\") - container.snapOffsetY;\n    Base.setCSSProperty(container.element, \"height\", `${height}px`);\n    Base.setCSSProperty(\n      container.element,\n      \"margin-bottom\",\n      `${marginBottom}px`,\n    );\n    Base.setCSSProperty(\n      container.element,\n      \"padding-bottom\",\n      `${paddingBottom}px`,\n    );\n    Base.setCSSProperty(\n      container.element,\n      \"border-bottom-width\",\n      `${borderBottomWidth}px`,\n    );\n    container.height = height - container.snapOffsetY;\n    container.marginBottom = marginBottom;\n    container.borderBottom = borderBottomWidth;\n    container.paddingBottom = paddingBottom;\n  }\n\n  assignBeforePosition(\n    context: Exprs.Context,\n    container: Vtree.Container,\n  ): void {\n    if (this.vertical) {\n      this.assignRightPosition(context, container);\n    } else {\n      this.assignTopPosition(context, container);\n    }\n  }\n\n  assignAfterPosition(\n    context: Exprs.Context,\n    container: Vtree.Container,\n  ): void {\n    if (this.vertical) {\n      this.assignLeftPosition(context, container);\n    } else {\n      this.assignBottomPosition(context, container);\n    }\n  }\n\n  assignStartEndPosition(\n    context: Exprs.Context,\n    container: Vtree.Container,\n  ): void {\n    if (this.vertical) {\n      this.assignTopPosition(context, container);\n      this.assignBottomPosition(context, container);\n    } else {\n      this.assignRightPosition(context, container);\n      this.assignLeftPosition(context, container);\n    }\n  }\n\n  sizeWithMaxHeight(context: Exprs.Context, container: Vtree.Container): void {\n    Base.setCSSProperty(container.element, \"border-top-width\", \"0px\");\n    let height = this.getPropAsNumber(context, \"max-height\");\n    if (this.isTopDependentOnAutoHeight) {\n      container.setVerticalPosition(0, height);\n    } else {\n      this.assignTopPosition(context, container);\n      height -= container.snapOffsetY;\n      container.height = height;\n      Base.setCSSProperty(container.element, \"height\", `${height}px`);\n    }\n  }\n\n  sizeWithMaxWidth(context: Exprs.Context, container: Vtree.Container): void {\n    Base.setCSSProperty(container.element, \"border-left-width\", \"0px\");\n    let width = this.getPropAsNumber(context, \"max-width\");\n    if (this.isRightDependentOnAutoWidth) {\n      container.setHorizontalPosition(0, width);\n    } else {\n      this.assignRightPosition(context, container);\n      width -= container.snapOffsetX;\n      container.width = width;\n      const right = this.getPropAsNumber(context, \"right\");\n      Base.setCSSProperty(container.element, \"right\", `${right}px`);\n      Base.setCSSProperty(container.element, \"width\", `${width}px`);\n    }\n  }\n\n  prepareContainer(\n    context: Exprs.Context,\n    container: Vtree.Container,\n    page: Vtree.Page,\n    docFaces: Font.DocumentFaces,\n    clientLayout: Vtree.ClientLayout,\n  ): void {\n    if (!this.parentInstance || this.vertical != this.parentInstance.vertical) {\n      Base.setCSSProperty(\n        container.element,\n        \"writing-mode\",\n        this.vertical ? \"vertical-rl\" : \"horizontal-tb\",\n      );\n    }\n    if (!this.parentInstance || this.rtl != this.parentInstance.rtl) {\n      Base.setCSSProperty(\n        container.element,\n        \"direction\",\n        this.rtl ? \"rtl\" : \"ltr\",\n      );\n    }\n    if (this.vertical ? this.isAutoWidth : this.isAutoHeight) {\n      if (this.vertical) {\n        this.sizeWithMaxWidth(context, container);\n      } else {\n        this.sizeWithMaxHeight(context, container);\n      }\n    } else {\n      this.assignBeforePosition(context, container);\n      this.assignAfterPosition(context, container);\n    }\n    if (this.vertical ? this.isAutoHeight : this.isAutoWidth) {\n      if (this.vertical) {\n        this.sizeWithMaxHeight(context, container);\n      } else {\n        this.sizeWithMaxWidth(context, container);\n      }\n    } else {\n      this.assignStartEndPosition(context, container);\n    }\n    for (let i = 0; i < passPreProperties.length; i++) {\n      this.propagateProperty(\n        context,\n        container,\n        passPreProperties[i],\n        docFaces,\n      );\n    }\n  }\n\n  transferContentProps(\n    context: Exprs.Context,\n    container: Vtree.Container,\n    page: Vtree.Page,\n    docFaces: Font.DocumentFaces,\n  ): void {\n    for (let i = 0; i < passContentProperties.length; i++) {\n      this.propagateProperty(\n        context,\n        container,\n        passContentProperties[i],\n        docFaces,\n      );\n    }\n\n    if (this.style[\"text-overflow\"]) {\n      // To ensure that text-overflow works, we need to set text-overflow and\n      // overflow on the child element, because the container element is a\n      // flex container and the text-overflow does not work on it.\n      // (Issue #1473)\n      const child = container.element.firstElementChild;\n      Base.setCSSProperty(child, \"text-overflow\", \"inherit\");\n      Base.setCSSProperty(child, \"overflow\", \"inherit\");\n    }\n  }\n\n  transferSingleUriContentProps(\n    context: Exprs.Context,\n    element: Element,\n    docFaces: Font.DocumentFaces,\n  ): void {\n    const hasWidth = (): boolean => {\n      const width = (\n        (this.cascaded[\"width\"] ??\n          this.cascaded[\n            this.vertical ? \"block-size\" : \"inline-size\"\n          ]) as CssCascade.CascadeValue\n      )?.value;\n      return (\n        !!width && width !== Css.ident.auto && !Css.isDefaultingValue(width)\n      );\n    };\n    const hasHeight = (): boolean => {\n      const height = (\n        (this.cascaded[\"height\"] ??\n          this.cascaded[\n            this.vertical ? \"inline-size\" : \"block-size\"\n          ]) as CssCascade.CascadeValue\n      )?.value;\n      return (\n        !!height && height !== Css.ident.auto && !Css.isDefaultingValue(height)\n      );\n    };\n\n    for (let i = 0; i < passSingleUriContentProperties.length; i++) {\n      const name = passSingleUriContentProperties[i];\n      if (name === \"width\" || name === \"height\") {\n        if (\n          (name === \"width\" && !hasWidth()) ||\n          (name === \"height\" && !hasHeight())\n        ) {\n          // Don't propagate width/height to the img element if it's not specified.\n          // (Issue #1177)\n          continue;\n        }\n        // Since the width/height is already set on the container element,\n        // we set it to 100% on the img element so that it fills the container.\n        // This is needed for the `box-sizing: border-box` to work correctly.\n        Base.setCSSProperty(element, name, \"100%\");\n        continue;\n      }\n      this.propagatePropertyToElement(context, element, name, docFaces);\n    }\n  }\n\n  /**\n   * @param column (null when content comes from the content property)\n   */\n  finishContainer(\n    context: Exprs.Context,\n    container: Vtree.Container,\n    page: Vtree.Page,\n    column: Vtree.Container | null,\n    columnCount: number,\n    clientLayout: Vtree.ClientLayout,\n    docFaces: Font.DocumentFaces,\n  ): void {\n    if (this.vertical) {\n      this.calculatedWidth =\n        container.computedBlockSize + container.snapOffsetX;\n    } else {\n      this.calculatedHeight =\n        container.computedBlockSize + container.snapOffsetY;\n    }\n    const readHeight = (this.vertical || !column) && this.isAutoHeight;\n    const readWidth = (!this.vertical || !column) && this.isAutoWidth;\n    let bbox: Vtree.ClientRect = null;\n    if (readWidth || readHeight) {\n      if (readWidth) {\n        Base.setCSSProperty(container.element, \"width\", \"auto\");\n      }\n      if (readHeight) {\n        Base.setCSSProperty(container.element, \"height\", \"auto\");\n      }\n      const usingBrowserColumnBreaking =\n        column && LayoutHelper.isUsingBrowserColumnBreaking(column);\n      if (usingBrowserColumnBreaking) {\n        // To get correct bounding box, temporarily disable multi-column style.\n        LayoutHelper.unsetBrowserColumnBreaking(column);\n      }\n      bbox = clientLayout.getElementClientRect(\n        column ? column.element : container.element,\n      );\n      if (usingBrowserColumnBreaking) {\n        // Restore multi-column style.\n        LayoutHelper.setBrowserColumnBreaking(column);\n      }\n      if (readWidth) {\n        this.calculatedWidth = Math.ceil(\n          bbox.right -\n            bbox.left -\n            container.paddingLeft -\n            container.borderLeft -\n            container.paddingRight -\n            container.borderRight,\n        );\n        if (this.vertical) {\n          this.calculatedWidth += container.snapOffsetX;\n        }\n      }\n      if (readHeight) {\n        this.calculatedHeight =\n          bbox.bottom -\n          bbox.top -\n          container.paddingTop -\n          container.borderTop -\n          container.paddingBottom -\n          container.borderBottom;\n        if (!this.vertical) {\n          this.calculatedHeight += container.snapOffsetY;\n        }\n      }\n    }\n    if (this.vertical ? this.isAutoHeight : this.isAutoWidth) {\n      this.assignStartEndPosition(context, container);\n    }\n    if (this.vertical ? this.isAutoWidth : this.isAutoHeight) {\n      if (\n        this.vertical\n          ? this.isRightDependentOnAutoWidth\n          : this.isTopDependentOnAutoHeight\n      ) {\n        this.assignBeforePosition(context, container);\n      }\n      this.assignAfterPosition(context, container);\n    }\n    if (columnCount > 1) {\n      const ruleWidth = this.getPropAsNumber(context, \"column-rule-width\");\n      const ruleStyle = this.getProp(context, \"column-rule-style\");\n      const ruleColor = this.getProp(context, \"column-rule-color\");\n      if (\n        ruleWidth > 0 &&\n        ruleStyle &&\n        ruleStyle != Css.ident.none &&\n        ruleColor != Css.ident.transparent\n      ) {\n        const columnGap = this.getPropAsNumber(context, \"column-gap\");\n        const containerSize = this.vertical\n          ? container.height\n          : container.width;\n        const border = this.vertical ? \"border-top\" : \"border-left\";\n        for (let i = 1; i < columnCount; i++) {\n          const pos = this.vertical\n            ? ((containerSize + columnGap) * i) / columnCount -\n              columnGap / 2 +\n              container.paddingTop -\n              ruleWidth / 2\n            : ((containerSize + columnGap) * i) / columnCount -\n              columnGap / 2 +\n              container.paddingLeft -\n              ruleWidth / 2;\n          const size = this.vertical\n            ? container.width + container.paddingLeft + container.paddingRight\n            : container.height + container.paddingTop + container.paddingBottom;\n          const rule = container.element.ownerDocument.createElement(\"div\");\n          Base.setCSSProperty(rule, \"position\", \"absolute\");\n          Base.setCSSProperty(rule, this.vertical ? \"left\" : \"top\", \"0px\");\n          Base.setCSSProperty(rule, this.vertical ? \"top\" : \"left\", `${pos}px`);\n          Base.setCSSProperty(rule, this.vertical ? \"height\" : \"width\", \"0px\");\n          Base.setCSSProperty(\n            rule,\n            this.vertical ? \"width\" : \"height\",\n            `${size}px`,\n          );\n          Base.setCSSProperty(\n            rule,\n            border,\n            `${ruleWidth}px ${ruleStyle.toString()}${\n              ruleColor ? ` ${ruleColor.toString()}` : \"\"\n            }`,\n          );\n          container.element.insertBefore(rule, container.element.firstChild);\n        }\n      }\n    }\n    for (let i = 0; i < passPostProperties.length; i++) {\n      this.propagateProperty(\n        context,\n        container,\n        passPostProperties[i],\n        docFaces,\n      );\n    }\n    for (let i = 0; i < delayedProperties.length; i++) {\n      this.propagateDelayedProperty(\n        context,\n        container,\n        delayedProperties[i],\n        page.delayedItems,\n      );\n    }\n  }\n\n  applyCascadeAndInit(\n    cascade: CssCascade.CascadeInstance,\n    docElementStyle: CssCascade.ElementStyle,\n  ): void {\n    const style = this.cascaded;\n    const specified = this.pageBox.specified;\n    for (const name in specified) {\n      if (\n        this instanceof PageRuleMasterInstance &&\n        this.pageBox.pseudoName == \"vivliostyle-page-rule-master\" &&\n        (name === \"writing-mode\" || name === \"direction\")\n      ) {\n        // Prevent writing-mode and direction specified on `@page` not working.\n        // (Fix for issue #1392)\n        continue;\n      }\n      if (CssCascade.isPropName(name)) {\n        CssCascade.setProp(style, name, CssCascade.getProp(specified, name));\n      }\n    }\n    if (this.pageBox.pseudoName == userAgentPageMasterPseudo) {\n      for (const name in docElementStyle) {\n        if (name.match(/^background-/) || name == \"writing-mode\") {\n          style[name] = docElementStyle[name];\n        }\n      }\n    }\n    if (this.pageBox.pseudoName == \"layout-host\") {\n      for (const name in docElementStyle) {\n        if (!name.match(/^background-/) && name != \"writing-mode\") {\n          style[name] = docElementStyle[name];\n        }\n      }\n    }\n    cascade.pushRule(this.pageBox.classes, null, style);\n    const content = style[\"content\"] as CssCascade.CascadeValue;\n    if (content) {\n      style[\"content\"] = content.filterValue(\n        new CssCascade.ContentPropVisitor(\n          cascade,\n          null,\n          cascade.counterResolver,\n        ),\n      );\n    }\n    this.init(cascade.context);\n    for (const child of this.pageBox.children) {\n      const childInstance = child.createInstance(this);\n      childInstance.applyCascadeAndInit(cascade, docElementStyle);\n    }\n    cascade.popRule();\n  }\n\n  resolveAutoSizing(context: Exprs.Context): void {\n    // all implicit dependencies are set up at this point\n    if (this.isAutoWidth) {\n      this.isRightDependentOnAutoWidth =\n        this.depends(\"right\", this.autoWidth, context) ||\n        this.depends(\"margin-right\", this.autoWidth, context) ||\n        this.depends(\"border-right-width\", this.autoWidth, context) ||\n        this.depends(\"padding-right\", this.autoWidth, context);\n    }\n    if (this.isAutoHeight) {\n      this.isTopDependentOnAutoHeight =\n        this.depends(\"top\", this.autoHeight, context) ||\n        this.depends(\"margin-top\", this.autoHeight, context) ||\n        this.depends(\"border-top-width\", this.autoHeight, context) ||\n        this.depends(\"padding-top\", this.autoHeight, context);\n    }\n    for (const childInstance of this.children) {\n      childInstance.resolveAutoSizing(context);\n    }\n  }\n}\n\n/**\n * Properties that are passed through before the layout.\n */\nexport const passPreProperties = [\n  \"border-left-style\",\n  \"border-right-style\",\n  \"border-top-style\",\n  \"border-bottom-style\",\n  \"border-left-color\",\n  \"border-right-color\",\n  \"border-top-color\",\n  \"border-bottom-color\",\n  \"box-sizing\",\n  \"outline-style\",\n  \"outline-color\",\n  \"outline-width\",\n  \"overflow\",\n  \"visibility\",\n];\n\n/**\n * Properties that are passed through after the layout.\n */\nexport const passPostProperties = [\n  \"border-top-left-radius\",\n  \"border-top-right-radius\",\n  \"border-bottom-right-radius\",\n  \"border-bottom-left-radius\",\n  \"border-start-start-radius\",\n  \"border-start-end-radius\",\n  \"border-end-start-radius\",\n  \"border-end-end-radius\",\n  \"border-image-source\",\n  \"border-image-slice\",\n  \"border-image-width\",\n  \"border-image-outset\",\n  \"border-image-repeat\",\n  \"background-attachment\",\n  \"background-color\",\n  \"background-image\",\n  \"background-repeat\",\n  \"background-position\",\n  \"background-clip\",\n  \"background-origin\",\n  \"background-size\",\n  \"box-shadow\",\n  \"opacity\",\n  \"z-index\",\n  \"background-blend-mode\",\n  \"isolation\",\n  \"mix-blend-mode\",\n  \"filter\",\n];\n\n/**\n * Only passed when there is content assigned by the content property.\n */\nexport const passContentProperties = [\n  \"color\",\n  \"font-family\",\n  \"font-size\",\n  \"font-style\",\n  \"font-weight\",\n  \"line-height\",\n  \"letter-spacing\",\n  \"text-align\",\n  \"text-align-last\",\n  \"text-decoration\",\n  \"text-indent\",\n  \"text-transform\",\n  \"white-space\",\n  \"text-wrap\",\n  \"text-wrap-mode\",\n  \"text-wrap-style\",\n  \"word-spacing\",\n  \"font-feature-settings\",\n  \"font-kerning\",\n  \"font-size-adjust\",\n  \"font-variant-ligatures\",\n  \"font-variant-caps\",\n  \"font-variant-numeric\",\n  \"font-variant-east-asian\",\n  \"font-stretch\",\n  \"text-combine-upright\",\n  \"text-decoration-color\",\n  \"text-decoration-line\",\n  \"text-decoration-skip\",\n  \"text-decoration-skip-ink\",\n  \"text-decoration-style\",\n  \"text-decoration-thickness\",\n  \"text-emphasis\",\n  \"text-emphasis-color\",\n  \"text-emphasis-position\",\n  \"text-emphasis-style\",\n  \"text-fill-color\",\n  \"text-orientation\",\n  \"text-shadow\",\n  \"text-stroke-color\",\n  \"text-stroke-width\",\n  \"text-underline-offset\",\n  \"text-underline-position\",\n  \"text-overflow\",\n];\n\nexport const passSingleUriContentProperties = [\n  \"width\",\n  \"height\",\n  \"image-resolution\",\n  \"object-fit\",\n  \"object-position\",\n];\n\nexport const delayedProperties = [\"transform\", \"transform-origin\"];\n\nexport const userAgentPageMasterPseudo = \"background-host\";\n\nexport class RootPageBoxInstance extends PageBoxInstance<RootPageBox> {\n  constructor(pageBox: RootPageBox) {\n    super(null, pageBox);\n  }\n\n  override applyCascadeAndInit(\n    cascade: CssCascade.CascadeInstance,\n    docElementStyle: CssCascade.ElementStyle,\n  ): void {\n    super.applyCascadeAndInit(cascade, docElementStyle);\n\n    // Sort page masters using order and specificity.\n    const pageMasters = this.children;\n    (pageMasters as PageMasterInstance[]).sort(\n      (a, b) =>\n        (b.pageBox as any).specificity - (a.pageBox as any).specificity || // probably cause NaN\n        a.pageBox.index - b.pageBox.index,\n    );\n  }\n}\n\nexport class PageMasterInstance<\n  P extends PageMaster = PageMaster<PageMasterInstance<any>>,\n> extends PageBoxInstance<P> {\n  constructor(parentInstance: PageBoxInstance, pageBox: P) {\n    super(parentInstance, pageBox);\n    this.pageMasterInstance = this;\n  }\n\n  override boxSpecificEnabled(enabled: Exprs.Val): Exprs.Val {\n    const pageMaster = this.pageBox.pageMaster;\n    if (pageMaster.condition) {\n      enabled = Exprs.and(pageMaster.scope, enabled, pageMaster.condition);\n    }\n    return enabled;\n  }\n\n  /**\n   * Called after layout of contents of the page has done to adjust the overall\n   * page layout. Override in subclasses.\n   */\n  adjustPageLayout(\n    context: Exprs.Context,\n    page: Vtree.Page,\n    clientLayout: Vtree.ClientLayout,\n  ) {}\n}\n\nexport class PartitionGroupInstance extends PageBoxInstance<PartitionGroup> {\n  constructor(parentInstance: PageBoxInstance, pageBox: PageBox) {\n    super(parentInstance, pageBox);\n    this.pageMasterInstance = parentInstance.pageMasterInstance;\n  }\n}\n\nexport class PartitionInstance<\n  P extends Partition = Partition<PartitionInstance<any>>,\n> extends PageBoxInstance<P> {\n  constructor(parentInstance: PageBoxInstance, pageBox: P) {\n    super(parentInstance, pageBox);\n    this.pageMasterInstance = parentInstance.pageMasterInstance;\n  }\n\n  processPartitionList(\n    enabled: Exprs.Val,\n    listVal: Css.Val,\n    conflicting: boolean,\n  ): Exprs.Val {\n    let list: Css.Val[] = null;\n    if (listVal instanceof Css.Ident) {\n      list = [listVal];\n    }\n    if (listVal instanceof Css.CommaList) {\n      list = (listVal as Css.CommaList).values;\n    }\n    if (list) {\n      const scope = this.pageBox.scope;\n      for (let i = 0; i < list.length; i++) {\n        if (list[i] instanceof Css.Ident) {\n          const qname = Exprs.makeQualifiedName(\n            (list[i] as Css.Ident).name,\n            \"enabled\",\n          );\n          let term: Exprs.Val = new Exprs.Named(scope, qname);\n          if (conflicting) {\n            term = new Exprs.Not(scope, term);\n          }\n          enabled = Exprs.and(scope, enabled, term);\n        }\n      }\n    }\n    return enabled;\n  }\n\n  override boxSpecificEnabled(enabled: Exprs.Val): Exprs.Val {\n    const scope = this.pageBox.scope;\n    const style = this.style;\n    const required =\n      toExprBool(scope, style[\"required\"], scope._false) !== scope._false;\n    if (required || this.isAutoHeight) {\n      const flowName = toExprIdent(scope, style[\"flow-from\"], \"body\");\n      const hasContent = new Exprs.Call(scope, \"has-content\", [flowName]);\n      enabled = Exprs.and(scope, enabled, hasContent);\n    }\n    enabled = this.processPartitionList(\n      enabled,\n      style[\"required-partitions\"],\n      false,\n    );\n    enabled = this.processPartitionList(\n      enabled,\n      style[\"conflicting-partitions\"],\n      true,\n    );\n    if (required) {\n      const pmEnabledVal = this.pageMasterInstance.style[\"enabled\"];\n      let pmEnabled = pmEnabledVal\n        ? pmEnabledVal.toExpr(scope, null)\n        : scope._true;\n      pmEnabled = Exprs.and(scope, pmEnabled, enabled);\n      this.pageMasterInstance.style[\"enabled\"] = new Css.Expr(pmEnabled);\n    }\n    return enabled;\n  }\n\n  override prepareContainer(\n    context: Exprs.Context,\n    container: Vtree.Container,\n    page: Vtree.Page,\n    docFaces: Font.DocumentFaces,\n    clientLayout: Vtree.ClientLayout,\n  ): void {\n    if (!(this.pageBox.pageMaster instanceof PageRuleMaster)) {\n      // The overflow property of a `@-epubx-partition` is set by default to hidden.\n      Base.setCSSProperty(container.element, \"overflow\", \"hidden\");\n      container.element.setAttribute(\n        \"data-vivliostyle-page-partition\",\n        this.pageBox.name ?? \"\",\n      );\n    }\n    super.prepareContainer(context, container, page, docFaces, clientLayout);\n  }\n}\n\n//--------------------- parsing -----------------------\nexport class PageBoxParserHandler\n  extends CssParser.SlaveParserHandler\n  implements CssValidator.PropertyReceiver\n{\n  constructor(\n    scope: Exprs.LexicalScope,\n    owner: CssParser.DispatchParserHandler,\n    public readonly target: PageBox,\n    public readonly validatorSet: CssValidator.ValidatorSet,\n  ) {\n    super(scope, owner, false);\n  }\n\n  override property(name: string, value: Css.Val, important: boolean): void {\n    this.validatorSet.validatePropertyAndHandleShorthand(\n      name,\n      value,\n      important,\n      this,\n    );\n  }\n\n  /** @override */\n  unknownProperty(name: string, value: Css.Val): void {\n    this.report(`E_INVALID_PROPERTY ${name}: ${value.toString()}`);\n  }\n\n  /** @override */\n  invalidPropertyValue(name: string, value: Css.Val): void {\n    this.report(`E_INVALID_PROPERTY_VALUE ${name}: ${value.toString()}`);\n  }\n\n  /** @override */\n  simpleProperty(name: string, value: Css.Val, important): void {\n    this.target.specified[name] = new CssCascade.CascadeValue(\n      value,\n      important\n        ? CssParser.SPECIFICITY_STYLE\n        : CssParser.SPECIFICITY_STYLE_IMPORTANT,\n    );\n  }\n}\n\nexport class PartitionParserHandler extends PageBoxParserHandler {\n  constructor(\n    scope: Exprs.LexicalScope,\n    owner: CssParser.DispatchParserHandler,\n    target: Partition,\n    validatorSet: CssValidator.ValidatorSet,\n  ) {\n    super(scope, owner, target, validatorSet);\n  }\n}\n\nexport class PartitionGroupParserHandler extends PageBoxParserHandler {\n  constructor(\n    scope: Exprs.LexicalScope,\n    owner: CssParser.DispatchParserHandler,\n    target: PartitionGroup,\n    validatorSet: CssValidator.ValidatorSet,\n  ) {\n    super(scope, owner, target, validatorSet);\n    target.specified[\"width\"] = new CssCascade.CascadeValue(\n      Css.hundredPercent,\n      0,\n    );\n    target.specified[\"height\"] = new CssCascade.CascadeValue(\n      Css.hundredPercent,\n      0,\n    );\n  }\n\n  override startPartitionRule(\n    name: string | null,\n    pseudoName: string | null,\n    classes: string[],\n  ): void {\n    const partition = new Partition(\n      this.scope,\n      name,\n      pseudoName,\n      classes,\n      this.target,\n    );\n    const handler = new PartitionParserHandler(\n      this.scope,\n      this.owner,\n      partition,\n      this.validatorSet,\n    );\n    this.owner.pushHandler(handler);\n  }\n\n  override startPartitionGroupRule(\n    name: string | null,\n    pseudoName: string | null,\n    classes: string[],\n  ): void {\n    const partitionGroup = new PartitionGroup(\n      this.scope,\n      name,\n      pseudoName,\n      classes,\n      this.target,\n    );\n    const handler = new PartitionGroupParserHandler(\n      this.scope,\n      this.owner,\n      partitionGroup,\n      this.validatorSet,\n    );\n    this.owner.pushHandler(handler);\n  }\n}\n\nexport class PageMasterParserHandler extends PageBoxParserHandler {\n  constructor(\n    scope: Exprs.LexicalScope,\n    owner: CssParser.DispatchParserHandler,\n    target: PageMaster,\n    validatorSet: CssValidator.ValidatorSet,\n  ) {\n    super(scope, owner, target, validatorSet);\n  }\n\n  override startPartitionRule(\n    name: string | null,\n    pseudoName: string | null,\n    classes: string[],\n  ): void {\n    const partition = new Partition(\n      this.scope,\n      name,\n      pseudoName,\n      classes,\n      this.target,\n    );\n    const handler = new PartitionParserHandler(\n      this.scope,\n      this.owner,\n      partition,\n      this.validatorSet,\n    );\n    this.owner.pushHandler(handler);\n  }\n\n  override startPartitionGroupRule(\n    name: string | null,\n    pseudoName: string | null,\n    classes: string[],\n  ): void {\n    const partitionGroup = new PartitionGroup(\n      this.scope,\n      name,\n      pseudoName,\n      classes,\n      this.target,\n    );\n    const handler = new PartitionGroupParserHandler(\n      this.scope,\n      this.owner,\n      partitionGroup,\n      this.validatorSet,\n    );\n    this.owner.pushHandler(handler);\n  }\n}\n", "/**\n * Copyright 2015 Daishinsha Inc.\n * Copyright 2019 Vivliostyle Foundation\n *\n * Vivliostyle.js is free software: you can redistribute it and/or modify\n * it under the terms of the GNU Affero General Public License as published by\n * the Free Software Foundation, either version 3 of the License, or\n * (at your option) any later version.\n *\n * Vivliostyle.js is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n * GNU Affero General Public License for more details.\n *\n * You should have received a copy of the GNU Affero General Public License\n * along with Vivliostyle.js.  If not, see <http://www.gnu.org/licenses/>.\n *\n * @fileoverview CssPage - `@page` rule (CSS Paged Media) support https://drafts.csswg.org/css-page/\n */\nimport * as Asserts from \"./asserts\";\nimport * as Base from \"./base\";\nimport * as Constants from \"./constants\";\nimport * as Css from \"./css\";\nimport * as CssCascade from \"./css-cascade\";\nimport * as CssParser from \"./css-parser\";\nimport * as CssValidator from \"./css-validator\";\nimport * as Exprs from \"./exprs\";\nimport * as Font from \"./font\";\nimport * as PageMaster from \"./page-master\";\nimport * as Sizing from \"./sizing\";\nimport * as Vtree from \"./vtree\";\n\n/**\n * Resolve page progression direction from writing-mode and direction.\n */\nexport function resolvePageProgression(\n  style: CssCascade.ElementStyle,\n): Constants.PageProgression {\n  const writingMode = (style[\"writing-mode\"] as CssCascade.CascadeValue)?.value;\n  const direction = (style[\"direction\"] as CssCascade.CascadeValue)?.value;\n  if (\n    writingMode === Css.ident.vertical_lr ||\n    (writingMode !== Css.ident.vertical_rl && direction !== Css.ident.rtl)\n  ) {\n    return Constants.PageProgression.LTR;\n  } else {\n    return Constants.PageProgression.RTL;\n  }\n}\nexport type PageSize = {\n  width: Css.Numeric;\n  height: Css.Numeric;\n};\n\n/**\n * Named page sizes.\n */\nexport const pageSizes: { [key: string]: PageSize } = {\n  a10: { width: new Css.Numeric(26, \"mm\"), height: new Css.Numeric(37, \"mm\") },\n  a9: { width: new Css.Numeric(37, \"mm\"), height: new Css.Numeric(52, \"mm\") },\n  a8: { width: new Css.Numeric(52, \"mm\"), height: new Css.Numeric(74, \"mm\") },\n  a7: { width: new Css.Numeric(74, \"mm\"), height: new Css.Numeric(105, \"mm\") },\n  a6: { width: new Css.Numeric(105, \"mm\"), height: new Css.Numeric(148, \"mm\") },\n  a5: { width: new Css.Numeric(148, \"mm\"), height: new Css.Numeric(210, \"mm\") },\n  a4: { width: new Css.Numeric(210, \"mm\"), height: new Css.Numeric(297, \"mm\") },\n  a3: { width: new Css.Numeric(297, \"mm\"), height: new Css.Numeric(420, \"mm\") },\n  a2: { width: new Css.Numeric(420, \"mm\"), height: new Css.Numeric(594, \"mm\") },\n  a1: { width: new Css.Numeric(594, \"mm\"), height: new Css.Numeric(841, \"mm\") },\n  a0: {\n    width: new Css.Numeric(841, \"mm\"),\n    height: new Css.Numeric(1189, \"mm\"),\n  },\n  b10: { width: new Css.Numeric(31, \"mm\"), height: new Css.Numeric(44, \"mm\") },\n  b9: { width: new Css.Numeric(44, \"mm\"), height: new Css.Numeric(62, \"mm\") },\n  b8: { width: new Css.Numeric(62, \"mm\"), height: new Css.Numeric(88, \"mm\") },\n  b7: { width: new Css.Numeric(88, \"mm\"), height: new Css.Numeric(125, \"mm\") },\n  b6: { width: new Css.Numeric(125, \"mm\"), height: new Css.Numeric(176, \"mm\") },\n  b5: { width: new Css.Numeric(176, \"mm\"), height: new Css.Numeric(250, \"mm\") },\n  b4: { width: new Css.Numeric(250, \"mm\"), height: new Css.Numeric(353, \"mm\") },\n  b3: { width: new Css.Numeric(353, \"mm\"), height: new Css.Numeric(500, \"mm\") },\n  b2: { width: new Css.Numeric(500, \"mm\"), height: new Css.Numeric(707, \"mm\") },\n  b1: {\n    width: new Css.Numeric(707, \"mm\"),\n    height: new Css.Numeric(1000, \"mm\"),\n  },\n  b0: {\n    width: new Css.Numeric(1000, \"mm\"),\n    height: new Css.Numeric(1414, \"mm\"),\n  },\n  c10: { width: new Css.Numeric(28, \"mm\"), height: new Css.Numeric(40, \"mm\") },\n  c9: { width: new Css.Numeric(40, \"mm\"), height: new Css.Numeric(57, \"mm\") },\n  c8: { width: new Css.Numeric(57, \"mm\"), height: new Css.Numeric(81, \"mm\") },\n  c7: { width: new Css.Numeric(81, \"mm\"), height: new Css.Numeric(114, \"mm\") },\n  c6: { width: new Css.Numeric(114, \"mm\"), height: new Css.Numeric(162, \"mm\") },\n  c5: { width: new Css.Numeric(162, \"mm\"), height: new Css.Numeric(229, \"mm\") },\n  c4: { width: new Css.Numeric(229, \"mm\"), height: new Css.Numeric(324, \"mm\") },\n  c3: { width: new Css.Numeric(324, \"mm\"), height: new Css.Numeric(458, \"mm\") },\n  c2: { width: new Css.Numeric(458, \"mm\"), height: new Css.Numeric(648, \"mm\") },\n  c1: { width: new Css.Numeric(648, \"mm\"), height: new Css.Numeric(917, \"mm\") },\n  c0: {\n    width: new Css.Numeric(917, \"mm\"),\n    height: new Css.Numeric(1297, \"mm\"),\n  },\n  \"jis-b10\": {\n    width: new Css.Numeric(32, \"mm\"),\n    height: new Css.Numeric(45, \"mm\"),\n  },\n  \"jis-b9\": {\n    width: new Css.Numeric(45, \"mm\"),\n    height: new Css.Numeric(64, \"mm\"),\n  },\n  \"jis-b8\": {\n    width: new Css.Numeric(64, \"mm\"),\n    height: new Css.Numeric(91, \"mm\"),\n  },\n  \"jis-b7\": {\n    width: new Css.Numeric(91, \"mm\"),\n    height: new Css.Numeric(128, \"mm\"),\n  },\n  \"jis-b6\": {\n    width: new Css.Numeric(128, \"mm\"),\n    height: new Css.Numeric(182, \"mm\"),\n  },\n  \"jis-b5\": {\n    width: new Css.Numeric(182, \"mm\"),\n    height: new Css.Numeric(257, \"mm\"),\n  },\n  \"jis-b4\": {\n    width: new Css.Numeric(257, \"mm\"),\n    height: new Css.Numeric(364, \"mm\"),\n  },\n  \"jis-b3\": {\n    width: new Css.Numeric(364, \"mm\"),\n    height: new Css.Numeric(515, \"mm\"),\n  },\n  \"jis-b2\": {\n    width: new Css.Numeric(515, \"mm\"),\n    height: new Css.Numeric(728, \"mm\"),\n  },\n  \"jis-b1\": {\n    width: new Css.Numeric(728, \"mm\"),\n    height: new Css.Numeric(1030, \"mm\"),\n  },\n  \"jis-b0\": {\n    width: new Css.Numeric(1030, \"mm\"),\n    height: new Css.Numeric(1456, \"mm\"),\n  },\n  letter: {\n    width: new Css.Numeric(8.5, \"in\"),\n    height: new Css.Numeric(11, \"in\"),\n  },\n  legal: {\n    width: new Css.Numeric(8.5, \"in\"),\n    height: new Css.Numeric(14, \"in\"),\n  },\n  ledger: {\n    width: new Css.Numeric(11, \"in\"),\n    height: new Css.Numeric(17, \"in\"),\n  },\n};\n\n/**\n * Default value for line width of printer marks\n */\nexport const defaultPrinterMarkLineWidth: Css.Numeric = new Css.Numeric(\n  0.24,\n  \"pt\",\n);\n\n/**\n * Default value for distance between an edge of the page and printer marks\n */\nexport const defaultPrinterMarkOffset: Css.Numeric = new Css.Numeric(3, \"mm\");\n\n/**\n * Default value for line length of the (shorter) line of a crop mark and the\n * shorter line of a cross mark\n */\nexport const defaultPrinterMarkLineLength: Css.Numeric = new Css.Numeric(\n  10,\n  \"mm\",\n);\n\n/**\n * Default value for bleed offset (= defaultPrinterMarkOffset +\n * defaultPrinterMarkLineLength)\n */\nexport const defaultBleedOffset: Css.Numeric = new Css.Numeric(3 + 10, \"mm\");\n\nexport type PageSizeAndBleed = {\n  width: Css.Numeric;\n  height: Css.Numeric;\n  bleed: Css.Numeric;\n  bleedOffset: Css.Numeric;\n  cropOffset: Css.Numeric;\n};\n\nexport function resolvePageSizeAndBleed(style: {\n  [key: string]: CssCascade.CascadeValue;\n}): PageSizeAndBleed {\n  // default value (fit to viewport, no bleed)\n  const pageSizeAndBleed: PageSizeAndBleed = {\n    width: Css.fullWidth,\n    height: Css.fullHeight,\n    bleed: Css.numericZero,\n    bleedOffset: Css.numericZero,\n    cropOffset: Css.numericZero,\n  };\n  const size: CssCascade.CascadeValue = style[\"size\"];\n\n  if (!size || size.value === Css.ident.auto) {\n    // if size is auto, fit to the viewport (use default value)\n  } else {\n    /** !type {!Css.Val} */\n    const value = size.value;\n    let val1: Css.Val;\n    let val2: Css.Val;\n    if (value.isSpaceList()) {\n      val1 = (value as Css.SpaceList).values[0];\n      val2 = (value as Css.SpaceList).values[1];\n    } else {\n      val1 = value;\n      val2 = null;\n    }\n    if (val1.isNumeric()) {\n      // <length>{1,2}\n      pageSizeAndBleed.width = val1 as Css.Numeric;\n      pageSizeAndBleed.height = (val2 || val1) as Css.Numeric;\n    } else {\n      // <page-size> || [ portrait | landscape ]\n      const s =\n        (val1 as any).name && pageSizes[(val1 as Css.Ident).name.toLowerCase()];\n      if (!s) {\n        // portrait or landscape is specified alone. fallback to fit to the\n        // viewport (use default value)\n      } else if (val2 && val2 === Css.ident.landscape) {\n        // swap\n        pageSizeAndBleed.width = s.height;\n        pageSizeAndBleed.height = s.width;\n      } else {\n        // return {\n        pageSizeAndBleed.width = s.width;\n        pageSizeAndBleed.height = s.height;\n      }\n    }\n  }\n  const marksCV = style[\"marks\"];\n  const bleedCV = style[\"bleed\"];\n  const marks =\n    marksCV && !Css.isDefaultingValue(marksCV.value)\n      ? marksCV.value\n      : Css.ident.none;\n  const bleed =\n    bleedCV && !Css.isDefaultingValue(bleedCV.value)\n      ? bleedCV.value\n      : Css.ident.auto;\n  if (bleed === Css.ident.auto) {\n    // \"('auto' value) Computes to 6pt if marks has crop and to zero\n    // otherwise.\" https://drafts.csswg.org/css-page/#valdef-page-bleed-auto\n    if (marks !== Css.ident.none) {\n      let hasCrop = false;\n      if (marks.isSpaceList()) {\n        hasCrop = (marks as Css.SpaceList).values.some(\n          (v) => v === Css.ident.crop,\n        );\n      } else {\n        hasCrop = marks === Css.ident.crop;\n      }\n      if (hasCrop) {\n        pageSizeAndBleed.bleed = new Css.Numeric(6, \"pt\");\n      }\n    }\n  } else if (bleed.isNumeric()) {\n    pageSizeAndBleed.bleed = bleed as Css.Numeric;\n  }\n\n  // crop-offset (Issue #913)\n  const cropOffsetCV = style[\"crop-offset\"];\n  const cropOffset =\n    cropOffsetCV && !Css.isDefaultingValue(cropOffsetCV.value)\n      ? cropOffsetCV.value\n      : Css.ident.auto;\n  if (cropOffset === Css.ident.auto) {\n    if (marks !== Css.ident.none) {\n      pageSizeAndBleed.bleedOffset = defaultBleedOffset;\n    }\n  } else if (cropOffset.isNumeric()) {\n    pageSizeAndBleed.cropOffset = cropOffset as Css.Numeric;\n  }\n  return pageSizeAndBleed;\n}\n\nexport type EvaluatedPageSizeAndBleed = {\n  pageWidth: number;\n  pageHeight: number;\n  bleed: number;\n  bleedOffset: number;\n  cropOffset: number;\n};\n\n/**\n * Evaluate actual page width, height and bleed from style specified in page\n * context.\n */\nexport function evaluatePageSizeAndBleed(\n  pageSizeAndBleed: PageSizeAndBleed,\n  context: Exprs.Context,\n): EvaluatedPageSizeAndBleed {\n  const evaluated = {} as EvaluatedPageSizeAndBleed;\n  const bleed =\n    Math.max(0, pageSizeAndBleed.bleed.num) *\n    context.queryUnitSize(pageSizeAndBleed.bleed.unit, false);\n  const bleedOffset =\n    !pageSizeAndBleed.cropOffset.num && pageSizeAndBleed.bleedOffset.num\n      ? pageSizeAndBleed.bleedOffset.num *\n        context.queryUnitSize(pageSizeAndBleed.bleedOffset.unit, false)\n      : Math.max(\n          0,\n          pageSizeAndBleed.cropOffset.num *\n            context.queryUnitSize(pageSizeAndBleed.cropOffset.unit, false) -\n            bleed,\n        );\n  const cropOffset = bleed + bleedOffset;\n  const width = pageSizeAndBleed.width;\n  if (width === Css.fullWidth) {\n    if (context.pref.defaultPaperSize) {\n      evaluated.pageWidth =\n        context.pref.defaultPaperSize.width *\n        context.queryUnitSize(\"px\", false);\n    } else {\n      evaluated.pageWidth =\n        (context.pref.spreadView\n          ? Math.floor(context.viewportWidth / 2) - context.pref.pageBorder\n          : context.viewportWidth) -\n        cropOffset * 2;\n    }\n  } else {\n    evaluated.pageWidth = width.num * context.queryUnitSize(width.unit, false);\n  }\n  const height = pageSizeAndBleed.height;\n  if (height === Css.fullHeight) {\n    if (context.pref.defaultPaperSize) {\n      evaluated.pageHeight =\n        context.pref.defaultPaperSize.height *\n        context.queryUnitSize(\"px\", false);\n    } else {\n      evaluated.pageHeight = context.viewportHeight - cropOffset * 2;\n    }\n  } else {\n    evaluated.pageHeight =\n      height.num * context.queryUnitSize(height.unit, false);\n  }\n  evaluated.bleed = bleed;\n  evaluated.bleedOffset = bleedOffset;\n  evaluated.cropOffset = cropOffset;\n  return evaluated;\n}\n\n/**\n * Create an 'svg' element for a printer mark.\n */\nexport function createPrinterMarkSvg(\n  doc: Document,\n  width: number,\n  height: number,\n): Element {\n  const mark = doc.createElementNS(Base.NS.SVG, \"svg\");\n  mark.setAttribute(\"width\", width);\n  mark.setAttribute(\"height\", height);\n  mark.style.position = \"absolute\";\n  return mark;\n}\n\n/**\n * Create an SVG element for a printer mark line.\n * @param elementType Specifies which type of element to create. Default value\n *     is \"polyline\".\n */\nexport function createPrinterMarkElement(\n  doc: Document,\n  lineWidth: number,\n  lineColor: Css.Val,\n  elementType?: string,\n): Element {\n  elementType = elementType || \"polyline\";\n  const line = doc.createElementNS(Base.NS.SVG, elementType);\n  line.setAttribute(\n    \"stroke\",\n    lineColor === Css.ident.auto ? \"#010101\" : lineColor.toString(),\n  );\n  line.setAttribute(\"stroke-width\", lineWidth);\n  line.setAttribute(\"fill\", \"none\");\n  return line;\n}\n\n/**\n * Position of a corner mark\n * @enum {string}\n */\nexport enum CornerMarkPosition {\n  TOP_LEFT = \"top left\",\n  TOP_RIGHT = \"top right\",\n  BOTTOM_LEFT = \"bottom left\",\n  BOTTOM_RIGHT = \"bottom right\",\n}\n\n/**\n * Create a corner mark.\n */\nexport function createCornerMark(\n  doc: Document,\n  position: CornerMarkPosition,\n  lineWidth: number,\n  lineColor: Css.Val,\n  cropMarkLineLength: number,\n  bleed: number,\n  offset: number,\n): Element {\n  let bleedMarkLineLength = cropMarkLineLength;\n\n  // bleed mark line should be longer than bleed + 2mm\n  if (bleedMarkLineLength <= bleed + 2 * Exprs.defaultUnitSizes[\"mm\"]) {\n    bleedMarkLineLength = bleed + cropMarkLineLength / 2;\n  }\n  const maxLineLength = Math.max(cropMarkLineLength, bleedMarkLineLength);\n  const svgWidth = bleed + maxLineLength + lineWidth / 2;\n  const mark = createPrinterMarkSvg(doc, svgWidth, svgWidth);\n  let points1 = [\n    [0, bleed + cropMarkLineLength],\n    [cropMarkLineLength, bleed + cropMarkLineLength],\n    [cropMarkLineLength, bleed + cropMarkLineLength - bleedMarkLineLength],\n  ];\n\n  // reflect with respect to y=x\n  let points2 = points1.map((p) => [p[1], p[0]]);\n  if (\n    position === CornerMarkPosition.TOP_RIGHT ||\n    position === CornerMarkPosition.BOTTOM_RIGHT\n  ) {\n    // reflect with respect to a vertical axis\n    points1 = points1.map((p) => [bleed + maxLineLength - p[0], p[1]]);\n    points2 = points2.map((p) => [bleed + maxLineLength - p[0], p[1]]);\n  }\n  if (\n    position === CornerMarkPosition.BOTTOM_LEFT ||\n    position === CornerMarkPosition.BOTTOM_RIGHT\n  ) {\n    // reflect with respect to a vertical axis\n    points1 = points1.map((p) => [p[0], bleed + maxLineLength - p[1]]);\n    points2 = points2.map((p) => [p[0], bleed + maxLineLength - p[1]]);\n  }\n  const line1 = createPrinterMarkElement(doc, lineWidth, lineColor);\n  line1.setAttribute(\"points\", points1.map((p) => p.join(\",\")).join(\" \"));\n  mark.appendChild(line1);\n  const line2 = createPrinterMarkElement(doc, lineWidth, lineColor);\n  line2.setAttribute(\"points\", points2.map((p) => p.join(\",\")).join(\" \"));\n  mark.appendChild(line2);\n  position.split(\" \").forEach((side) => {\n    (mark as any).style[side] = `${offset}px`;\n  });\n  return mark;\n}\n\n/**\n * Position of a cross mark\n * @enum {string}\n */\nexport enum CrossMarkPosition {\n  TOP = \"top\",\n  BOTTOM = \"bottom\",\n  LEFT = \"left\",\n  RIGHT = \"right\",\n}\n\n/**\n * Create a cross mark.\n */\nexport function createCrossMark(\n  doc: Document,\n  position: CrossMarkPosition,\n  lineWidth: number,\n  lineColor: Css.Val,\n  lineLength: number,\n  offset: number,\n): Element {\n  const longLineLength = lineLength * 2;\n  let width: number;\n  let height: number;\n  if (\n    position === CrossMarkPosition.TOP ||\n    position === CrossMarkPosition.BOTTOM\n  ) {\n    width = longLineLength;\n    height = lineLength;\n  } else {\n    width = lineLength;\n    height = longLineLength;\n  }\n  const mark = createPrinterMarkSvg(doc, width, height);\n  const horizontalLine = createPrinterMarkElement(doc, lineWidth, lineColor);\n  horizontalLine.setAttribute(\n    \"points\",\n    `0,${height / 2} ${width},${height / 2}`,\n  );\n  mark.appendChild(horizontalLine);\n  const verticalLine = createPrinterMarkElement(doc, lineWidth, lineColor);\n  verticalLine.setAttribute(\"points\", `${width / 2},0 ${width / 2},${height}`);\n  mark.appendChild(verticalLine);\n  const circle = createPrinterMarkElement(doc, lineWidth, lineColor, \"circle\");\n  circle.setAttribute(\"cx\", width / 2);\n  circle.setAttribute(\"cy\", height / 2);\n  circle.setAttribute(\"r\", lineLength / 4);\n  mark.appendChild(circle);\n  let opposite: CrossMarkPosition;\n  switch (position) {\n    case CrossMarkPosition.TOP:\n      opposite = CrossMarkPosition.BOTTOM;\n      break;\n    case CrossMarkPosition.BOTTOM:\n      opposite = CrossMarkPosition.TOP;\n      break;\n    case CrossMarkPosition.LEFT:\n      opposite = CrossMarkPosition.RIGHT;\n      break;\n    case CrossMarkPosition.RIGHT:\n      opposite = CrossMarkPosition.LEFT;\n      break;\n  }\n  Object.keys(CrossMarkPosition).forEach((key) => {\n    const side = CrossMarkPosition[key];\n    if (side === position) {\n      (mark as any).style[side] = `${offset}px`;\n    } else if (side !== opposite) {\n      (mark as any).style[side] = \"0\";\n      (mark as any).style[`margin-${side}`] = \"auto\";\n    }\n  });\n  return mark;\n}\n\n/**\n * Add printer marks to the page.\n */\nexport function addPrinterMarks(\n  cascadedPageStyle: CssCascade.ElementStyle,\n  evaluatedPageSizeAndBleed: EvaluatedPageSizeAndBleed,\n  page: Vtree.Page,\n  context: Exprs.Context,\n): void {\n  let crop = false;\n  let cross = false;\n  const marks = cascadedPageStyle[\"marks\"] as CssCascade.CascadeValue;\n  if (marks) {\n    const value = marks.value;\n    if (value instanceof Css.SpaceList) {\n      value.values.forEach((v) => {\n        if (v === Css.ident.crop) {\n          crop = true;\n        } else if (v === Css.ident.cross) {\n          cross = true;\n        }\n      });\n    } else if (value === Css.ident.crop) {\n      crop = true;\n    } else if (value === Css.ident.cross) {\n      cross = true;\n    }\n  }\n\n  const bleed = evaluatedPageSizeAndBleed.bleed;\n  if (!crop && !cross) {\n    return;\n  }\n  const container = page.container;\n  const doc = container.ownerDocument as Document;\n  Asserts.assert(doc);\n  const lineWidth = Css.toNumber(defaultPrinterMarkLineWidth, context);\n  const printerMarkOffset = Math.max(\n    0,\n    evaluatedPageSizeAndBleed.bleedOffset -\n      Css.toNumber(defaultPrinterMarkLineLength, context),\n  );\n  const lineLength = evaluatedPageSizeAndBleed.bleedOffset - printerMarkOffset;\n\n  const lineColorCV = cascadedPageStyle[\n    \"crop-marks-line-color\"\n  ] as CssCascade.CascadeValue;\n  const lineColor =\n    lineColorCV && !Css.isDefaultingValue(lineColorCV.value)\n      ? lineColorCV.value\n      : Css.ident.auto;\n\n  // corner marks\n  if (crop) {\n    Object.keys(CornerMarkPosition).forEach((key) => {\n      const position = CornerMarkPosition[key];\n      const mark = createCornerMark(\n        doc,\n        position,\n        lineWidth,\n        lineColor,\n        lineLength,\n        bleed,\n        printerMarkOffset,\n      );\n      container.appendChild(mark);\n    });\n  }\n\n  // cross marks\n  if (cross) {\n    Object.keys(CrossMarkPosition).forEach((key) => {\n      const position = CrossMarkPosition[key];\n      const mark = createCrossMark(\n        doc,\n        position,\n        lineWidth,\n        lineColor,\n        lineLength,\n        printerMarkOffset,\n      );\n      container.appendChild(mark);\n    });\n  }\n}\n\n/**\n * Properties transferred from the PageRuleMaster to the PageRulePartition\n */\nexport const propertiesAppliedToPartition = (() => {\n  const sides = [\n    \"left\",\n    \"right\",\n    \"top\",\n    \"bottom\",\n    \"before\",\n    \"after\",\n    \"start\",\n    \"end\",\n    \"block-start\",\n    \"block-end\",\n    \"inline-start\",\n    \"inline-end\",\n    \"inside\",\n    \"outside\",\n  ];\n  const props = {\n    width: true,\n    height: true,\n    \"block-size\": true,\n    \"inline-size\": true,\n    margin: true,\n    padding: true,\n    border: true,\n    outline: true,\n    \"outline-width\": true,\n    \"outline-style\": true,\n    \"outline-color\": true,\n    \"border-radius\": true,\n    \"border-top-left-radius\": true,\n    \"border-top-right-radius\": true,\n    \"border-bottom-right-radius\": true,\n    \"border-bottom-left-radius\": true,\n    \"border-start-start-radius\": true,\n    \"border-start-end-radius\": true,\n    \"border-end-start-radius\": true,\n    \"border-end-end-radius\": true,\n    \"box-shadow\": true,\n    \"box-sizing\": true,\n  };\n  sides.forEach((side) => {\n    props[`margin-${side}`] = true;\n    props[`padding-${side}`] = true;\n    props[`border-${side}-width`] = true;\n    props[`border-${side}-style`] = true;\n    props[`border-${side}-color`] = true;\n  });\n  return props;\n})();\n\n/**\n * Represents position of a margin box along the variable dimension of the page.\n * START and END can be interpreted as 'inline-start' and 'inline-end' in\n * horizontal and vertical writing modes. For example, for top margin boxes\n * (@top-left-corner, @top-left, @top-center, @top-right, @top-right-corner),\n * @top-left corresponds to START, @top-center to CENTER, and @top-right to END.\n * The corner boxes (@top-left-corner and @top-right-corner) have a 'null'\n * position.\n * @enum {string}\n */\nexport enum MarginBoxPositionAlongVariableDimension {\n  START = \"start\",\n  CENTER = \"center\",\n  END = \"end\",\n}\n\nexport type PageMarginBoxInformation = {\n  order: number;\n  isInTopRow: boolean;\n  isInBottomRow: boolean;\n  isInLeftColumn: boolean;\n  isInRightColumn: boolean;\n  positionAlongVariableDimension: MarginBoxPositionAlongVariableDimension;\n};\n\n/**\n * Page-margin boxes.\n * @dict\n */\nexport const pageMarginBoxes: { [key: string]: PageMarginBoxInformation } = {\n  \"top-left-corner\": {\n    order: 1,\n    isInTopRow: true,\n    isInBottomRow: false,\n    isInLeftColumn: true,\n    isInRightColumn: false,\n    positionAlongVariableDimension: null,\n  },\n  \"top-left\": {\n    order: 2,\n    isInTopRow: true,\n    isInBottomRow: false,\n    isInLeftColumn: false,\n    isInRightColumn: false,\n    positionAlongVariableDimension:\n      MarginBoxPositionAlongVariableDimension.START,\n  },\n  \"top-center\": {\n    order: 3,\n    isInTopRow: true,\n    isInBottomRow: false,\n    isInLeftColumn: false,\n    isInRightColumn: false,\n    positionAlongVariableDimension:\n      MarginBoxPositionAlongVariableDimension.CENTER,\n  },\n  \"top-right\": {\n    order: 4,\n    isInTopRow: true,\n    isInBottomRow: false,\n    isInLeftColumn: false,\n    isInRightColumn: false,\n    positionAlongVariableDimension: MarginBoxPositionAlongVariableDimension.END,\n  },\n  \"top-right-corner\": {\n    order: 5,\n    isInTopRow: true,\n    isInBottomRow: false,\n    isInLeftColumn: false,\n    isInRightColumn: true,\n    positionAlongVariableDimension: null,\n  },\n  \"right-top\": {\n    order: 6,\n    isInTopRow: false,\n    isInBottomRow: false,\n    isInLeftColumn: false,\n    isInRightColumn: true,\n    positionAlongVariableDimension:\n      MarginBoxPositionAlongVariableDimension.START,\n  },\n  \"right-middle\": {\n    order: 7,\n    isInTopRow: false,\n    isInBottomRow: false,\n    isInLeftColumn: false,\n    isInRightColumn: true,\n    positionAlongVariableDimension:\n      MarginBoxPositionAlongVariableDimension.CENTER,\n  },\n  \"right-bottom\": {\n    order: 8,\n    isInTopRow: false,\n    isInBottomRow: false,\n    isInLeftColumn: false,\n    isInRightColumn: true,\n    positionAlongVariableDimension: MarginBoxPositionAlongVariableDimension.END,\n  },\n  \"bottom-right-corner\": {\n    order: 9,\n    isInTopRow: false,\n    isInBottomRow: true,\n    isInLeftColumn: false,\n    isInRightColumn: true,\n    positionAlongVariableDimension: null,\n  },\n  \"bottom-right\": {\n    order: 10,\n    isInTopRow: false,\n    isInBottomRow: true,\n    isInLeftColumn: false,\n    isInRightColumn: false,\n    positionAlongVariableDimension: MarginBoxPositionAlongVariableDimension.END,\n  },\n  \"bottom-center\": {\n    order: 11,\n    isInTopRow: false,\n    isInBottomRow: true,\n    isInLeftColumn: false,\n    isInRightColumn: false,\n    positionAlongVariableDimension:\n      MarginBoxPositionAlongVariableDimension.CENTER,\n  },\n  \"bottom-left\": {\n    order: 12,\n    isInTopRow: false,\n    isInBottomRow: true,\n    isInLeftColumn: false,\n    isInRightColumn: false,\n    positionAlongVariableDimension:\n      MarginBoxPositionAlongVariableDimension.START,\n  },\n  \"bottom-left-corner\": {\n    order: 13,\n    isInTopRow: false,\n    isInBottomRow: true,\n    isInLeftColumn: true,\n    isInRightColumn: false,\n    positionAlongVariableDimension: null,\n  },\n  \"left-bottom\": {\n    order: 14,\n    isInTopRow: false,\n    isInBottomRow: false,\n    isInLeftColumn: true,\n    isInRightColumn: false,\n    positionAlongVariableDimension: MarginBoxPositionAlongVariableDimension.END,\n  },\n  \"left-middle\": {\n    order: 15,\n    isInTopRow: false,\n    isInBottomRow: false,\n    isInLeftColumn: true,\n    isInRightColumn: false,\n    positionAlongVariableDimension:\n      MarginBoxPositionAlongVariableDimension.CENTER,\n  },\n  \"left-top\": {\n    order: 16,\n    isInTopRow: false,\n    isInBottomRow: false,\n    isInLeftColumn: true,\n    isInRightColumn: false,\n    positionAlongVariableDimension:\n      MarginBoxPositionAlongVariableDimension.START,\n  },\n};\n\n/**\n * Names for page-margin boxes order in the default painting order.\n */\nexport const pageMarginBoxNames: string[] = (() => {\n  const boxes = pageMarginBoxes;\n  return Object.keys(boxes).sort((a, b) => boxes[a].order - boxes[b].order);\n})();\n\n/**\n * Indicates that the page master is generated for `@page` rules.\n */\nexport const pageRuleMasterPseudoName = \"vivliostyle-page-rule-master\";\n\n/**\n * Key for properties in margin contexts.\n * Styles in margin contexts are stored in pageStyle[\"_marginBoxes\"][(margin\n * box's name)].\n */\nexport const marginBoxesKey: string = \"_marginBoxes\";\n\n/**\n * Represent a page master generated for `@page` rules\n * @param style Cascaded style for `@page` rules\n */\nexport class PageRuleMaster extends PageMaster.PageMaster<PageRuleMasterInstance> {\n  private pageMarginBoxes = {} as {\n    [key: string]: PageMarginBoxPartition;\n  };\n\n  constructor(\n    scope: Exprs.LexicalScope,\n    parent: PageMaster.RootPageBox,\n    style: CssCascade.ElementStyle,\n  ) {\n    super(scope, null, pageRuleMasterPseudoName, [], parent, null, 0);\n    const pageSize = resolvePageSizeAndBleed(style as any);\n    const partition = new PageRulePartition(this.scope, this, style, pageSize);\n    this.createPageMarginBoxes(style);\n    this.applySpecified(style, pageSize);\n  }\n\n  /**\n   * Create page-margin boxes\n   */\n  createPageMarginBoxes(style: CssCascade.ElementStyle) {\n    const marginBoxesMap = style[marginBoxesKey];\n    if (marginBoxesMap) {\n      pageMarginBoxNames.forEach((name) => {\n        if (marginBoxesMap[name]) {\n          this.pageMarginBoxes[name] = new PageMarginBoxPartition(\n            this.scope,\n            this,\n            name,\n            style,\n          );\n        }\n      });\n    }\n  }\n\n  /**\n   * Transfer cascaded style for `@page` rules to 'specified' style of this\n   * PageBox\n   */\n  private applySpecified(style: CssCascade.ElementStyle, pageSize: PageSize) {\n    this.specified[\"position\"] = new CssCascade.CascadeValue(\n      Css.ident.relative,\n      0,\n    );\n    this.specified[\"width\"] = new CssCascade.CascadeValue(pageSize.width, 0);\n    this.specified[\"height\"] = new CssCascade.CascadeValue(pageSize.height, 0);\n    for (const name in style) {\n      if (!propertiesAppliedToPartition[name] && name !== \"background-clip\") {\n        this.specified[name] = style[name];\n      }\n    }\n  }\n\n  override createInstance(\n    parentInstance: PageMaster.PageBoxInstance,\n  ): PageRuleMasterInstance {\n    return new PageRuleMasterInstance(parentInstance, this);\n  }\n}\n\n/**\n * Represent a partition placed in a PageRuleMaster\n * @param style Cascaded style for `@page` rules\n */\nexport class PageRulePartition extends PageMaster.Partition<PageRulePartitionInstance> {\n  constructor(\n    scope: Exprs.LexicalScope,\n    parent: PageRuleMaster,\n    style: CssCascade.ElementStyle,\n    public readonly pageSize: PageSize,\n  ) {\n    super(scope, null, null, [], parent);\n    const partition = new PageAreaPartition(this.scope, this);\n    this.applySpecified(style);\n  }\n\n  /**\n   * Transfer cascaded style for `@page` rules to 'specified' style of this\n   * PageBox\n   */\n  private applySpecified(style: CssCascade.ElementStyle) {\n    this.specified[\"wrap-flow\"] = new CssCascade.CascadeValue(\n      Css.ident.auto,\n      0,\n    );\n    this.specified[\"z-index\"] = new CssCascade.CascadeValue(new Css.Int(0), 0);\n    this.specified[\"position\"] = new CssCascade.CascadeValue(\n      Css.ident.absolute,\n      0,\n    );\n    this.specified[\"overflow\"] = new CssCascade.CascadeValue(\n      Css.ident.visible,\n      0,\n    );\n    for (const prop in propertiesAppliedToPartition) {\n      if (propertiesAppliedToPartition.hasOwnProperty(prop)) {\n        this.specified[prop] = style[prop];\n      }\n    }\n  }\n\n  override createInstance(\n    parentInstance: PageMaster.PageBoxInstance,\n  ): PageRulePartitionInstance {\n    return new PageRulePartitionInstance(parentInstance, this);\n  }\n}\n\nexport class PageAreaPartition extends PageMaster.Partition<PageAreaPartitionInstance> {\n  constructor(scope: Exprs.LexicalScope, parent: PageRulePartition) {\n    super(scope, null, null, [], parent);\n    this.specified[\"flow-from\"] = new CssCascade.CascadeValue(\n      Css.getName(\"body\"),\n      0,\n    );\n  }\n\n  override createInstance(\n    parentInstance: PageMaster.PageBoxInstance,\n  ): PageMaster.PageBoxInstance {\n    return new PageAreaPartitionInstance(parentInstance, this);\n  }\n}\n\n/**\n * Represent a partition for a page-margin box\n */\nexport class PageMarginBoxPartition extends PageMaster.Partition<PageMarginBoxPartitionInstance> {\n  constructor(\n    scope: Exprs.LexicalScope,\n    parent: PageRuleMaster,\n    public readonly marginBoxName: string,\n    style: CssCascade.ElementStyle,\n  ) {\n    super(scope, null, null, [], parent);\n    this.applySpecified(style);\n  }\n\n  /**\n   * Transfer cascaded style for `@page` rules to 'specified' style of this\n   * PageMarginBox\n   */\n  applySpecified(style: CssCascade.ElementStyle) {\n    const ownStyle = style[marginBoxesKey][\n      this.marginBoxName\n    ] as CssCascade.ElementStyle;\n\n    // Inherit properties in the page context to the page-margin context\n    for (const prop in style) {\n      const val = style[prop] as CssCascade.CascadeValue;\n      const ownVal = ownStyle[prop] as CssCascade.CascadeValue;\n      if (\n        CssCascade.inheritedProps[prop] ||\n        (ownVal && ownVal.value === Css.ident.inherit)\n      ) {\n        this.specified[prop] = val;\n      }\n    }\n    for (const prop in ownStyle) {\n      if (Object.prototype.hasOwnProperty.call(ownStyle, prop)) {\n        const val = ownStyle[prop] as CssCascade.CascadeValue;\n        if (\n          val &&\n          val.value !== Css.empty &&\n          val.value !== Css.ident.inherit &&\n          val.value !== Css.ident.unset &&\n          val.value !== Css.ident.revert\n        ) {\n          this.specified[prop] = val;\n        }\n      }\n    }\n  }\n\n  override createInstance(\n    parentInstance: PageMaster.PageBoxInstance,\n  ): PageMaster.PageBoxInstance {\n    return new PageMarginBoxPartitionInstance(parentInstance, this);\n  }\n}\n\n//---------------------------- Instance --------------------------------\nexport type PageAreaDimension = {\n  borderBoxWidth: Exprs.Val;\n  borderBoxHeight: Exprs.Val;\n  marginTop: Exprs.Val;\n  marginBottom: Exprs.Val;\n  marginLeft: Exprs.Val;\n  marginRight: Exprs.Val;\n};\n\nexport class PageRuleMasterInstance extends PageMaster.PageMasterInstance<PageRuleMaster> {\n  pageAreaDimension: PageAreaDimension | null = null;\n  pageMarginBoxInstances: {\n    [key: string]: PageMarginBoxPartitionInstance;\n  } = {};\n\n  constructor(\n    parentInstance: PageMaster.PageBoxInstance,\n    pageRuleMaster: PageRuleMaster,\n  ) {\n    super(parentInstance, pageRuleMaster);\n  }\n\n  override applyCascadeAndInit(\n    cascade: CssCascade.CascadeInstance,\n    docElementStyle: CssCascade.ElementStyle,\n  ): void {\n    const style = this.cascaded;\n    for (const name in docElementStyle) {\n      if (Object.prototype.hasOwnProperty.call(docElementStyle, name)) {\n        switch (name) {\n          case \"writing-mode\":\n          case \"direction\":\n            style[name] = docElementStyle[name];\n        }\n      }\n    }\n    super.applyCascadeAndInit(cascade, docElementStyle);\n  }\n\n  override initHorizontal(): void {\n    const style = this.style;\n    style[\"left\"] = Css.numericZero;\n    style[\"margin-left\"] = Css.numericZero;\n    style[\"border-left-width\"] = Css.numericZero;\n    style[\"padding-left\"] = Css.numericZero;\n    style[\"padding-right\"] = Css.numericZero;\n    style[\"border-right-width\"] = Css.numericZero;\n    style[\"margin-right\"] = Css.numericZero;\n    style[\"right\"] = Css.numericZero;\n  }\n\n  override initVertical(): void {\n    const style = this.style;\n\n    style[\"top\"] = Css.numericZero;\n    style[\"margin-top\"] = Css.numericZero;\n    style[\"border-top-width\"] = Css.numericZero;\n    style[\"padding-top\"] = Css.numericZero;\n    style[\"padding-bottom\"] = Css.numericZero;\n    style[\"border-bottom-width\"] = Css.numericZero;\n    style[\"margin-bottom\"] = Css.numericZero;\n    style[\"bottom\"] = Css.numericZero;\n  }\n\n  setPageAreaDimension(dim: PageAreaDimension) {\n    this.pageAreaDimension = dim;\n    const style = this.style;\n    style[\"width\"] = new Css.Expr(dim.borderBoxWidth);\n    style[\"height\"] = new Css.Expr(dim.borderBoxHeight);\n    style[\"padding-left\"] = new Css.Expr(dim.marginLeft);\n    style[\"padding-right\"] = new Css.Expr(dim.marginRight);\n    style[\"padding-top\"] = new Css.Expr(dim.marginTop);\n    style[\"padding-bottom\"] = new Css.Expr(dim.marginBottom);\n  }\n\n  override adjustPageLayout(\n    context: Exprs.Context,\n    page: Vtree.Page,\n    clientLayout: Vtree.ClientLayout,\n  ) {\n    const marginBoxContainers = page.marginBoxes;\n    const horizontalDimensions = {\n      start: this.pageAreaDimension.marginLeft,\n      end: this.pageAreaDimension.marginRight,\n      extent: this.pageAreaDimension.borderBoxWidth,\n    };\n    const verticalDimensions = {\n      start: this.pageAreaDimension.marginTop,\n      end: this.pageAreaDimension.marginBottom,\n      extent: this.pageAreaDimension.borderBoxHeight,\n    };\n    this.sizeMarginBoxesAlongVariableDimension(\n      marginBoxContainers.top,\n      true,\n      horizontalDimensions,\n      context,\n      clientLayout,\n    );\n    this.sizeMarginBoxesAlongVariableDimension(\n      marginBoxContainers.bottom,\n      true,\n      horizontalDimensions,\n      context,\n      clientLayout,\n    );\n    this.sizeMarginBoxesAlongVariableDimension(\n      marginBoxContainers.left,\n      false,\n      verticalDimensions,\n      context,\n      clientLayout,\n    );\n    this.sizeMarginBoxesAlongVariableDimension(\n      marginBoxContainers.right,\n      false,\n      verticalDimensions,\n      context,\n      clientLayout,\n    );\n  }\n\n  /**\n   * Determine and set margin boxes' sizes along variable dimension using an\n   * algorithm specified in CSS Paged Media spec.\n   * @param marginBoxContainers Containers corresponding to the target margin\n   *     boxes in one page edge (top, bottom, left, right)\n   * @param isHorizontal Indicates if the target margin boxes are on the\n   *     horizontal edge (top or bottom) or not (left or right).\n   * @param dimensions Page dimensions. start: margin-left or margin-top. end:\n   *     margin-right or margin-bottom. extent: border-box width or height of\n   *     the page area (= available width or height for the target margin boxes)\n   */\n  private sizeMarginBoxesAlongVariableDimension(\n    marginBoxContainers: { [key: string]: Vtree.Container },\n    isHorizontal: boolean,\n    dimensions: { start: Exprs.Val; end: Exprs.Val; extent: Exprs.Val },\n    context: Exprs.Context,\n    clientLayout: Vtree.ClientLayout,\n  ) {\n    const START = MarginBoxPositionAlongVariableDimension.START;\n    const CENTER = MarginBoxPositionAlongVariableDimension.CENTER;\n    const END = MarginBoxPositionAlongVariableDimension.END;\n\n    // prepare parameters\n    const scope = this.pageBox.scope;\n    const containers: {\n      [key in MarginBoxPositionAlongVariableDimension]?: Vtree.Container;\n    } = {};\n    const boxInstances: {\n      [key in MarginBoxPositionAlongVariableDimension]?: PageMarginBoxPartitionInstance;\n    } = {};\n    const boxParams: {\n      [key in MarginBoxPositionAlongVariableDimension]?: MarginBoxSizingParam;\n    } = {};\n    for (const name in marginBoxContainers) {\n      const boxInfo = pageMarginBoxes[name];\n      if (boxInfo) {\n        const container = marginBoxContainers[name];\n        const boxInstance = this.pageMarginBoxInstances[name];\n        const boxParam = new SingleBoxMarginBoxSizingParam(\n          container,\n          boxInstance.style,\n          isHorizontal,\n          scope,\n          clientLayout,\n        );\n        containers[boxInfo.positionAlongVariableDimension] = container;\n        boxInstances[boxInfo.positionAlongVariableDimension] = boxInstance;\n        boxParams[boxInfo.positionAlongVariableDimension] = boxParam;\n      }\n    }\n\n    // determine sizes\n    const evaluatedDim = {\n      start: dimensions.start.evaluate(context) as number,\n      end: dimensions.end.evaluate(context) as number,\n      extent: dimensions.extent.evaluate(context) as number,\n    };\n    let sizes = this.getSizesOfMarginBoxesAlongVariableDimension(\n      boxParams,\n      evaluatedDim.extent,\n    );\n    let needRecalculate: boolean = false;\n\n    // Check max-width/max-height\n    const maxOuterSizes: {\n      [key in MarginBoxPositionAlongVariableDimension]?: number;\n    } = {};\n    Object.keys(containers).forEach((n) => {\n      const name = n as MarginBoxPositionAlongVariableDimension;\n      const maxSize = PageMaster.toExprAuto(\n        scope,\n        boxInstances[name].style[isHorizontal ? \"max-width\" : \"max-height\"],\n        dimensions.extent,\n      );\n      if (maxSize) {\n        const evaluatedMaxSize = maxSize.evaluate(context) as number;\n        if (sizes[name] > evaluatedMaxSize) {\n          const p = (boxParams[name] = new FixedSizeMarginBoxSizingParam(\n            containers[name],\n            boxInstances[name].style,\n            isHorizontal,\n            scope,\n            clientLayout,\n            evaluatedMaxSize,\n          ));\n          maxOuterSizes[name] = p.getOuterSize();\n          needRecalculate = true;\n        }\n      }\n    });\n    if (needRecalculate) {\n      sizes = this.getSizesOfMarginBoxesAlongVariableDimension(\n        boxParams,\n        evaluatedDim.extent,\n      );\n      needRecalculate = false;\n      [START, CENTER, END].forEach((name) => {\n        sizes[name] = maxOuterSizes[name] ?? sizes[name];\n      });\n    }\n\n    // Check min-width/min-height\n    const minOuterSizes: {\n      [key in MarginBoxPositionAlongVariableDimension]?: number;\n    } = {};\n    Object.keys(containers).forEach((n) => {\n      const name = n as MarginBoxPositionAlongVariableDimension;\n      const minSize = PageMaster.toExprAuto(\n        scope,\n        boxInstances[name].style[isHorizontal ? \"min-width\" : \"min-height\"],\n        dimensions.extent,\n      );\n      if (minSize) {\n        const evaluatedMinSize = minSize.evaluate(context) as number;\n        if (sizes[name] < evaluatedMinSize) {\n          const p = (boxParams[name] = new FixedSizeMarginBoxSizingParam(\n            containers[name],\n            boxInstances[name].style,\n            isHorizontal,\n            scope,\n            clientLayout,\n            evaluatedMinSize,\n          ));\n          minOuterSizes[name] = p.getOuterSize();\n          needRecalculate = true;\n        }\n      }\n    });\n    if (needRecalculate) {\n      sizes = this.getSizesOfMarginBoxesAlongVariableDimension(\n        boxParams,\n        evaluatedDim.extent,\n      );\n      [START, CENTER, END].forEach((name) => {\n        sizes[name] = minOuterSizes[name] || sizes[name];\n      });\n    }\n\n    // set sizes\n    const endEdge = evaluatedDim.start + evaluatedDim.extent;\n    const startEndSum =\n      evaluatedDim.start + (evaluatedDim.start + evaluatedDim.extent);\n    [START, CENTER, END].forEach((name) => {\n      const outerSize = sizes[name];\n      if (outerSize != null) {\n        const container = containers[name];\n        let offset = 0;\n        switch (name) {\n          case START:\n            offset = isHorizontal ? container.left : container.top;\n            break;\n          case CENTER:\n            offset = (startEndSum - outerSize) / 2;\n            break;\n          case END:\n            offset = endEdge - outerSize;\n            break;\n        }\n        if (isHorizontal) {\n          container.setHorizontalPosition(\n            offset,\n            outerSize - container.getInsetLeft() - container.getInsetRight(),\n          );\n        } else {\n          container.setVerticalPosition(\n            offset,\n            outerSize - container.getInsetTop() - container.getInsetBottom(),\n          );\n        }\n      }\n    });\n  }\n\n  private getSizesOfMarginBoxesAlongVariableDimension(\n    boxParams: {\n      [key in MarginBoxPositionAlongVariableDimension]?: MarginBoxSizingParam;\n    },\n    availableSize: number,\n  ): { [key in MarginBoxPositionAlongVariableDimension]?: number } {\n    const startBoxParam =\n      boxParams[MarginBoxPositionAlongVariableDimension.START];\n    const centerBoxParam =\n      boxParams[MarginBoxPositionAlongVariableDimension.CENTER];\n    const endBoxParam = boxParams[MarginBoxPositionAlongVariableDimension.END];\n    const sizes: {\n      [key in MarginBoxPositionAlongVariableDimension]?: number;\n    } = {};\n    if (!centerBoxParam) {\n      const startEndSizes = this.distributeAutoMarginBoxSizes(\n        startBoxParam,\n        endBoxParam,\n        availableSize,\n      );\n      if (startEndSizes.xSize != null) {\n        sizes[MarginBoxPositionAlongVariableDimension.START] =\n          startEndSizes.xSize;\n      }\n      if (startEndSizes.ySize != null) {\n        sizes[MarginBoxPositionAlongVariableDimension.END] =\n          startEndSizes.ySize;\n      }\n    } else {\n      const params = [startBoxParam, endBoxParam];\n      const startEndBoxParam = new MultipleBoxesMarginBoxSizingParam(params);\n      const centerSizes = this.distributeAutoMarginBoxSizes(\n        centerBoxParam,\n        startEndBoxParam,\n        availableSize,\n      );\n      if (centerSizes.xSize != null) {\n        sizes[MarginBoxPositionAlongVariableDimension.CENTER] =\n          centerSizes.xSize;\n      }\n      const centerSize = centerSizes.xSize ?? centerBoxParam.getOuterSize();\n      // Ensure the calculated size is not negative, which can happen if the center content exceeds the available space.\n      const startEndAutoSize = Math.max((availableSize - centerSize) / 2, 0);\n      if (startBoxParam) {\n        sizes[MarginBoxPositionAlongVariableDimension.START] =\n          startBoxParam.hasAutoSize()\n            ? startEndAutoSize\n            : startBoxParam.getOuterSize();\n      }\n      if (endBoxParam) {\n        sizes[MarginBoxPositionAlongVariableDimension.END] =\n          endBoxParam.hasAutoSize()\n            ? startEndAutoSize\n            : endBoxParam.getOuterSize();\n      }\n    }\n    return sizes;\n  }\n\n  /**\n   * Distribute auto margin sizes among two margin boxes using an algorithm\n   * specified in CSS Paged Media spec.\n   * @param x Parameter for the first margin box. null if the box is not\n   *     generated.\n   * @param y Parameter for the second margin box. null if the box is not\n   *     generated.\n   * @param availableSize Available size for the margin boxes.\n   * @returns Determined sizes for the two boxes. Each value is present only\n   *     when the size of the corresponding box is 'auto'.\n   */\n  private distributeAutoMarginBoxSizes(\n    x: MarginBoxSizingParam,\n    y: MarginBoxSizingParam,\n    availableSize: number,\n  ): { xSize: number | null; ySize: number | null } {\n    const result: { xSize: number | null; ySize: number | null } = {\n      xSize: null,\n      ySize: null,\n    };\n\n    // Sizing with min-content/max-content/fit-content support\n    if (x instanceof SingleBoxMarginBoxSizingParam && x.minMaxFitContent) {\n      result.xSize = x.getOuterSize();\n    }\n    if (y instanceof SingleBoxMarginBoxSizingParam && y.minMaxFitContent) {\n      result.ySize = y.getOuterSize();\n    }\n\n    if (x && y) {\n      if (x.hasAutoSize() && y.hasAutoSize()) {\n        const xOuterMaxContentSize = x.getOuterMaxContentSize();\n        const yOuterMaxContentSize = y.getOuterMaxContentSize();\n        if (xOuterMaxContentSize > 0 && yOuterMaxContentSize > 0) {\n          const maxContentSizeSum = xOuterMaxContentSize + yOuterMaxContentSize;\n          if (maxContentSizeSum < availableSize) {\n            result.xSize =\n              (availableSize * xOuterMaxContentSize) / maxContentSizeSum;\n          } else {\n            const xOuterMinContentSize = x.getOuterMinContentSize();\n            const yOuterMinContentSize = y.getOuterMinContentSize();\n            const minContentSizeSum =\n              xOuterMinContentSize + yOuterMinContentSize;\n            if (minContentSizeSum < availableSize) {\n              result.xSize =\n                xOuterMinContentSize +\n                ((availableSize - minContentSizeSum) *\n                  (xOuterMaxContentSize - xOuterMinContentSize)) /\n                  (maxContentSizeSum - minContentSizeSum);\n            } else if (minContentSizeSum > 0) {\n              result.xSize =\n                (availableSize * xOuterMinContentSize) / minContentSizeSum;\n            }\n          }\n          if (result.xSize > 0) {\n            result.ySize = availableSize - result.xSize;\n          }\n        } else if (xOuterMaxContentSize > 0) {\n          result.xSize = availableSize;\n        } else if (yOuterMaxContentSize > 0) {\n          result.ySize = availableSize;\n        }\n      } else if (x.hasAutoSize()) {\n        result.xSize = Math.max(availableSize - y.getOuterSize(), 0);\n      } else if (y.hasAutoSize()) {\n        result.ySize = Math.max(availableSize - x.getOuterSize(), 0);\n      }\n    } else if (x) {\n      if (x.hasAutoSize()) {\n        result.xSize = availableSize;\n      }\n    } else if (y) {\n      if (y.hasAutoSize()) {\n        result.ySize = availableSize;\n      }\n    }\n    return result;\n  }\n\n  override prepareContainer(\n    context: Exprs.Context,\n    container: Vtree.Container,\n    page: Vtree.Page,\n    docFaces: Font.DocumentFaces,\n    clientLayout: Vtree.ClientLayout,\n  ): void {\n    // Add an attribute to the element so that it can be referred from external\n    // style sheets.\n    container.element.setAttribute(\"data-vivliostyle-page-box\", true);\n    super.prepareContainer(context, container, page, docFaces, clientLayout);\n  }\n}\n\n/**\n * Interface used for parameters passed to distributeAutoMarginBoxSizes method.\n */\ninterface MarginBoxSizingParam {\n  hasAutoSize(): boolean;\n\n  getOuterMaxContentSize(): number;\n\n  getOuterMinContentSize(): number;\n\n  getOuterSize(): number;\n}\n\n/**\n * MarginBoxSizingParam for a single page-margin box.\n * @param container A container corresponding to the target margin box.\n * @param style Styles specified to the target margin box.\n */\nclass SingleBoxMarginBoxSizingParam implements MarginBoxSizingParam {\n  private hasAutoSize_: boolean;\n  private size: { [key in Sizing.Size]: number } | null = null;\n  public readonly minMaxFitContent:\n    | \"min-content\"\n    | \"max-content\"\n    | \"fit-content\"\n    | null = null;\n\n  constructor(\n    protected readonly container: Vtree.Container,\n    style: { [key: string]: Css.Val },\n    protected readonly isHorizontal: boolean,\n    scope: Exprs.LexicalScope,\n    private readonly clientLayout: Vtree.ClientLayout,\n  ) {\n    const val = style[isHorizontal ? \"width\" : \"height\"];\n    this.hasAutoSize_ =\n      !val || val === Css.ident.auto || Css.isDefaultingValue(val);\n\n    this.minMaxFitContent =\n      val instanceof Css.Ident &&\n      (val.name === \"min-content\" ||\n        val.name === \"max-content\" ||\n        val.name === \"fit-content\")\n        ? val.name\n        : null;\n\n    if (this.minMaxFitContent) {\n      const size = this.getSize();\n      if (this.isHorizontal) {\n        const width =\n          size[\n            this.minMaxFitContent === \"min-content\"\n              ? Sizing.Size.MIN_CONTENT_WIDTH\n              : this.minMaxFitContent === \"max-content\"\n                ? Sizing.Size.MAX_CONTENT_WIDTH\n                : Sizing.Size.FIT_CONTENT_WIDTH\n          ];\n        this.container.setHorizontalPosition(this.container.left, width);\n      } else {\n        const height =\n          size[\n            this.minMaxFitContent === \"min-content\"\n              ? Sizing.Size.MIN_CONTENT_HEIGHT\n              : this.minMaxFitContent === \"max-content\"\n                ? Sizing.Size.MAX_CONTENT_HEIGHT\n                : Sizing.Size.FIT_CONTENT_HEIGHT\n          ];\n        this.container.setVerticalPosition(this.container.top, height);\n      }\n    }\n  }\n\n  /** @override */\n  hasAutoSize(): boolean {\n    return this.hasAutoSize_;\n  }\n\n  private getSize(): { [key in Sizing.Size]: number } {\n    if (!this.size) {\n      const sizes = this.isHorizontal\n        ? [\n            Sizing.Size.MAX_CONTENT_WIDTH,\n            Sizing.Size.MIN_CONTENT_WIDTH,\n            Sizing.Size.FIT_CONTENT_WIDTH,\n          ]\n        : [\n            Sizing.Size.MAX_CONTENT_HEIGHT,\n            Sizing.Size.MIN_CONTENT_HEIGHT,\n            Sizing.Size.FIT_CONTENT_HEIGHT,\n          ];\n      this.size = Sizing.getSize(\n        this.clientLayout,\n        this.container.element,\n        sizes,\n      );\n    }\n    return this.size;\n  }\n\n  /** @override */\n  getOuterMaxContentSize(): number {\n    const size = this.getSize();\n    if (this.isHorizontal) {\n      return (\n        this.container.getInsetLeft() +\n        size[Sizing.Size.MAX_CONTENT_WIDTH] +\n        this.container.getInsetRight()\n      );\n    } else {\n      return (\n        this.container.getInsetTop() +\n        size[Sizing.Size.MAX_CONTENT_HEIGHT] +\n        this.container.getInsetBottom()\n      );\n    }\n  }\n\n  /** @override */\n  getOuterMinContentSize(): number {\n    const size = this.getSize();\n    if (this.isHorizontal) {\n      return (\n        this.container.getInsetLeft() +\n        size[Sizing.Size.MIN_CONTENT_WIDTH] +\n        this.container.getInsetRight()\n      );\n    } else {\n      return (\n        this.container.getInsetTop() +\n        size[Sizing.Size.MIN_CONTENT_HEIGHT] +\n        this.container.getInsetBottom()\n      );\n    }\n  }\n\n  /** @override */\n  getOuterSize(): number {\n    if (this.isHorizontal) {\n      return (\n        this.container.getInsetLeft() +\n        this.container.width +\n        this.container.getInsetRight()\n      );\n    } else {\n      return (\n        this.container.getInsetTop() +\n        this.container.height +\n        this.container.getInsetBottom()\n      );\n    }\n  }\n}\n\n/**\n * MarginBoxSizingParam with which multiple margin boxes are treated as one\n * margin box. Each method querying a dimension returns the maximum of the boxes\n * multiplied by the number of the boxes.\n * @param params MarginBoxSizingParam's of the target margin boxes. It allows empty\n *     parameters, which are treated as zero-sized boxes.\n */\nclass MultipleBoxesMarginBoxSizingParam implements MarginBoxSizingParam {\n  constructor(\n    private readonly params: (MarginBoxSizingParam | null | undefined)[],\n  ) {}\n\n  /** @override */\n  hasAutoSize(): boolean {\n    return this.params.some((p) => p?.hasAutoSize() ?? false);\n  }\n\n  /** @override */\n  getOuterMaxContentSize(): number {\n    const sizes = this.params.map((p) => p?.getOuterMaxContentSize() ?? 0);\n    return Math.max.apply(null, sizes) * sizes.length;\n  }\n\n  /** @override */\n  getOuterMinContentSize(): number {\n    const sizes = this.params.map((p) => p?.getOuterMinContentSize() ?? 0);\n    return Math.max.apply(null, sizes) * sizes.length;\n  }\n\n  /** @override */\n  getOuterSize(): number {\n    const sizes = this.params.map((p) => p?.getOuterSize() ?? 0);\n    return Math.max.apply(null, sizes) * sizes.length;\n  }\n}\n\n/**\n * MarginBoxSizingParam for a single page-margin box with a fixed size along the\n * variable dimension.\n * @param container A container corresponding to the target margin box.\n * @param style Styles specified to the target margin box.\n * @param size The fixed size (width or height) along the variable dimension.\n */\nclass FixedSizeMarginBoxSizingParam extends SingleBoxMarginBoxSizingParam {\n  private fixedSize: number;\n\n  constructor(\n    container: Vtree.Container,\n    style: { [key: string]: Css.Val },\n    isHorizontal: boolean,\n    scope: Exprs.LexicalScope,\n    clientLayout: Vtree.ClientLayout,\n    size: number,\n  ) {\n    super(container, style, isHorizontal, scope, clientLayout);\n    this.fixedSize = size;\n  }\n\n  override hasAutoSize(): boolean {\n    return false;\n  }\n\n  override getOuterMaxContentSize(): number {\n    return this.getOuterSize();\n  }\n\n  override getOuterMinContentSize(): number {\n    return this.getOuterSize();\n  }\n\n  override getOuterSize(): number {\n    if (this.isHorizontal) {\n      return (\n        this.container.getInsetLeft() +\n        this.fixedSize +\n        this.container.getInsetRight()\n      );\n    } else {\n      return (\n        this.container.getInsetTop() +\n        this.fixedSize +\n        this.container.getInsetBottom()\n      );\n    }\n  }\n}\n\nexport class PageRulePartitionInstance extends PageMaster.PartitionInstance<PageRulePartition> {\n  borderBoxWidth: Exprs.Val = null;\n  borderBoxHeight: Exprs.Val = null;\n  contentBoxWidth: Exprs.Val = null;\n  contentBoxHeight: Exprs.Val = null;\n  marginTop: Exprs.Val = null;\n  marginRight: Exprs.Val = null;\n  marginBottom: Exprs.Val = null;\n  marginLeft: Exprs.Val = null;\n\n  constructor(\n    parentInstance: PageMaster.PageBoxInstance,\n    pageRulePartition: PageRulePartition,\n  ) {\n    super(parentInstance, pageRulePartition);\n  }\n\n  override applyCascadeAndInit(\n    cascade: CssCascade.CascadeInstance,\n    docElementStyle: CssCascade.ElementStyle,\n  ): void {\n    for (const name in docElementStyle) {\n      if (name.match(/^background-/)) {\n        this.cascaded[name] = docElementStyle[name];\n      }\n    }\n    super.applyCascadeAndInit(cascade, docElementStyle);\n    const pageRuleMasterInstance = this\n      .parentInstance as PageRuleMasterInstance;\n    pageRuleMasterInstance.setPageAreaDimension({\n      borderBoxWidth: this.borderBoxWidth,\n      borderBoxHeight: this.borderBoxHeight,\n      marginTop: this.marginTop,\n      marginRight: this.marginRight,\n      marginBottom: this.marginBottom,\n      marginLeft: this.marginLeft,\n    });\n  }\n\n  override initHorizontal(): void {\n    const dim = this.resolvePageBoxDimensions({\n      start: \"left\",\n      end: \"right\",\n      extent: \"width\",\n    });\n    this.borderBoxWidth = dim.borderBoxExtent;\n    this.contentBoxWidth = dim.contentBoxExtent;\n    this.marginLeft = dim.marginStart;\n    this.marginRight = dim.marginEnd;\n  }\n\n  override initVertical(): void {\n    const dim = this.resolvePageBoxDimensions({\n      start: \"top\",\n      end: \"bottom\",\n      extent: \"height\",\n    });\n    this.borderBoxHeight = dim.borderBoxExtent;\n    this.contentBoxHeight = dim.contentBoxExtent;\n    this.marginTop = dim.marginStart;\n    this.marginBottom = dim.marginEnd;\n  }\n\n  /**\n   * Calculate page dimensions as specified in CSS Paged Media\n   * (http://dev.w3.org/csswg/css-page/#page-model) Page border box extent and\n   * margins. Since the containing block can be resized in the over-constrained\n   * case, the sum of these values is not necessarily same to the original page\n   * dimension specified in the page at-rules.\n   */\n  private resolvePageBoxDimensions(names: {\n    start: \"top\" | \"left\";\n    end: \"bottom\" | \"right\";\n    extent: \"width\" | \"height\";\n  }): {\n    borderBoxExtent: Exprs.Val;\n    contentBoxExtent: Exprs.Val;\n    marginStart: Exprs.Val;\n    marginEnd: Exprs.Val;\n  } {\n    const style = this.style;\n    const pageSize = this.pageBox.pageSize;\n    const scope = this.pageBox.scope;\n    const startSide = names.start;\n    const endSide = names.end;\n    const extentName = names.extent;\n    const pageExtent = pageSize[extentName].toExpr(scope, null);\n    let extent = PageMaster.toExprAuto(scope, style[extentName], pageExtent);\n    let marginStart = PageMaster.toExprAuto(\n      scope,\n      style[`margin-${startSide}`],\n      pageExtent,\n    );\n    let marginEnd = PageMaster.toExprAuto(\n      scope,\n      style[`margin-${endSide}`],\n      pageExtent,\n    );\n    const paddingStart = PageMaster.toExprZero(\n      scope,\n      style[`padding-${startSide}`],\n      pageExtent,\n    );\n    const paddingEnd = PageMaster.toExprZero(\n      scope,\n      style[`padding-${endSide}`],\n      pageExtent,\n    );\n    const borderStartWidth = PageMaster.toExprZeroBorder(\n      scope,\n      style[`border-${startSide}-width`],\n      style[`border-${startSide}-style`],\n      pageExtent,\n    );\n    const borderEndWidth = PageMaster.toExprZeroBorder(\n      scope,\n      style[`border-${endSide}-width`],\n      style[`border-${endSide}-style`],\n      pageExtent,\n    );\n    const borderPaddingSum = Exprs.add(\n      scope,\n      Exprs.add(scope, borderStartWidth, paddingStart),\n      Exprs.add(scope, borderEndWidth, paddingEnd),\n    );\n\n    // The dimensions are calculated as for a non-replaced block element in\n    // normal flow (http://www.w3.org/TR/CSS21/visudet.html#blockwidth)\n    let marginSum: Exprs.Val;\n    let borderBoxExtent: Exprs.Val;\n    let contentBoxExtent: Exprs.Val;\n    if (!extent) {\n      if (!marginStart) {\n        marginStart = scope.zero;\n      }\n      if (!marginEnd) {\n        marginEnd = scope.zero;\n      }\n      marginSum = Exprs.add(scope, marginStart, marginEnd);\n      borderBoxExtent = Exprs.sub(scope, pageExtent, marginSum);\n      contentBoxExtent = Exprs.sub(scope, borderBoxExtent, borderPaddingSum);\n      extent = this.borderBoxSizing ? borderBoxExtent : contentBoxExtent;\n    } else {\n      if (this.borderBoxSizing) {\n        borderBoxExtent = extent;\n        contentBoxExtent = Exprs.sub(scope, borderBoxExtent, borderPaddingSum);\n      } else {\n        contentBoxExtent = extent;\n        borderBoxExtent = Exprs.add(scope, contentBoxExtent, borderPaddingSum);\n      }\n      marginSum = Exprs.sub(scope, pageExtent, borderBoxExtent);\n      if (!marginStart && !marginEnd) {\n        marginStart = Exprs.mul(scope, marginSum, new Exprs.Const(scope, 0.5));\n        marginEnd = marginStart;\n      } else if (marginStart) {\n        marginEnd = Exprs.sub(scope, marginSum, marginStart);\n      } else {\n        marginStart = Exprs.sub(scope, marginSum, marginEnd);\n      }\n    }\n\n    // TODO over-constrained case\n    // \"if the values are over-constrained, instead of ignoring any margins, the\n    // containing block is resized to coincide with the margin edges of the page\n    // box.\" (CSS Paged Media http://dev.w3.org/csswg/css-page/#page-model)\n\n    style[startSide] = new Css.Expr(marginStart);\n    style[endSide] = new Css.Expr(marginEnd);\n    style[`margin-${startSide}`] = Css.numericZero;\n    style[`margin-${endSide}`] = Css.numericZero;\n    style[`border-${startSide}-width`] = new Css.Expr(borderStartWidth);\n    style[`border-${endSide}-width`] = new Css.Expr(borderEndWidth);\n    style[`padding-${startSide}`] = new Css.Expr(paddingStart);\n    style[`padding-${endSide}`] = new Css.Expr(paddingEnd);\n    style[extentName] = new Css.Expr(extent);\n    style[`max-${extentName}`] = new Css.Expr(extent);\n    return {\n      borderBoxExtent,\n      contentBoxExtent,\n      marginStart,\n      marginEnd,\n    };\n  }\n\n  override prepareContainer(\n    context: Exprs.Context,\n    container: Vtree.Container,\n    page: Vtree.Page,\n    docFaces: Font.DocumentFaces,\n    clientLayout: Vtree.ClientLayout,\n  ): void {\n    container.element.setAttribute(\n      \"data-vivliostyle-page-area-container\",\n      true,\n    );\n    super.prepareContainer(context, container, page, docFaces, clientLayout);\n  }\n}\n\nexport class PageAreaPartitionInstance extends PageMaster.PartitionInstance<PageAreaPartition> {\n  constructor(\n    parentInstance: PageMaster.PageBoxInstance,\n    pageAreaPartition: PageAreaPartition,\n  ) {\n    super(parentInstance, pageAreaPartition);\n  }\n\n  override applyCascadeAndInit(\n    cascade: CssCascade.CascadeInstance,\n    docElementStyle: CssCascade.ElementStyle,\n  ): void {\n    for (const name in docElementStyle) {\n      if (name.match(/^column.*$/)) {\n        this.cascaded[name] = docElementStyle[name];\n      }\n    }\n    super.applyCascadeAndInit(cascade, {});\n  }\n\n  override initHorizontal(): void {\n    const style = this.style;\n    const parentStyle = this.parentInstance.style;\n    const scope = this.pageBox.scope;\n    style[\"left\"] = parentStyle[\"padding-left\"];\n    style[\"width\"] = new Css.Expr(\n      (this.parentInstance as PageRulePartitionInstance).contentBoxWidth,\n    );\n\n    // Use negative margins and transparent borders to improve text selection behavior.\n    style[\"margin-left\"] = new Css.Expr(\n      new Exprs.Negate(scope, parentStyle[\"left\"].toExpr(scope, null)),\n    );\n    style[\"margin-right\"] = new Css.Expr(\n      new Exprs.Negate(scope, parentStyle[\"right\"].toExpr(scope, null)),\n    );\n    style[\"border-left-width\"] = parentStyle[\"left\"];\n    style[\"border-right-width\"] = parentStyle[\"right\"];\n    style[\"border-left-style\"] = Css.ident.solid;\n    style[\"border-right-style\"] = Css.ident.solid;\n    style[\"border-left-color\"] = Css.ident.transparent;\n    style[\"border-right-color\"] = Css.ident.transparent;\n  }\n\n  override initVertical(): void {\n    const style = this.style;\n    const parentStyle = this.parentInstance.style;\n    const scope = this.pageBox.scope;\n    style[\"top\"] = parentStyle[\"padding-top\"];\n    style[\"height\"] = new Css.Expr(\n      (this.parentInstance as PageRulePartitionInstance).contentBoxHeight,\n    );\n\n    // Use negative margins and transparent borders to improve text selection behavior.\n    style[\"margin-top\"] = new Css.Expr(\n      new Exprs.Negate(scope, parentStyle[\"top\"].toExpr(scope, null)),\n    );\n    style[\"margin-bottom\"] = new Css.Expr(\n      new Exprs.Negate(scope, parentStyle[\"bottom\"].toExpr(scope, null)),\n    );\n    style[\"border-top-width\"] = parentStyle[\"top\"];\n    style[\"border-bottom-width\"] = parentStyle[\"bottom\"];\n    style[\"border-top-style\"] = Css.ident.solid;\n    style[\"border-bottom-style\"] = Css.ident.solid;\n    style[\"border-top-color\"] = Css.ident.transparent;\n    style[\"border-bottom-color\"] = Css.ident.transparent;\n  }\n\n  override prepareContainer(\n    context: Exprs.Context,\n    container: Vtree.Container,\n    page: Vtree.Page,\n    docFaces: Font.DocumentFaces,\n    clientLayout: Vtree.ClientLayout,\n  ): void {\n    container.element.setAttribute(\"data-vivliostyle-page-area\", true);\n    page.pageAreaElement = container.element;\n    super.prepareContainer(context, container, page, docFaces, clientLayout);\n\n    // Set page area size for vw/vh unit calculation\n    context.pageAreaWidth = container.width;\n    context.pageAreaHeight = container.height;\n  }\n}\n\nexport class PageMarginBoxPartitionInstance extends PageMaster.PartitionInstance<PageMarginBoxPartition> {\n  boxInfo: PageMarginBoxInformation;\n  suppressEmptyBoxGeneration: boolean = true;\n\n  constructor(\n    parentInstance: PageMaster.PageBoxInstance,\n    pageMarginBoxPartition: PageMarginBoxPartition,\n  ) {\n    super(parentInstance, pageMarginBoxPartition);\n    const name = pageMarginBoxPartition.marginBoxName;\n    this.boxInfo = pageMarginBoxes[name];\n    const pageRuleMasterInstance = parentInstance as PageRuleMasterInstance;\n    pageRuleMasterInstance.pageMarginBoxInstances[name] = this;\n  }\n\n  override prepareContainer(\n    context: Exprs.Context,\n    container: Vtree.Container,\n    page: Vtree.Page,\n    docFaces: Font.DocumentFaces,\n    clientLayout: Vtree.ClientLayout,\n  ): void {\n    container.element.setAttribute(\n      \"data-vivliostyle-page-margin-box\",\n      this.pageBox.marginBoxName,\n    );\n    this.applyVerticalAlign(context, container.element);\n    super.prepareContainer(context, container, page, docFaces, clientLayout);\n  }\n\n  private applyVerticalAlign(context: Exprs.Context, element: Element) {\n    Base.setCSSProperty(element, \"display\", \"flex\");\n    Base.setCSSProperty(\n      element,\n      \"flex-flow\",\n      this.vertical ? (this.rtl ? \"row-reverse\" : \"row\") : \"column\",\n    );\n    const verticalAlign: Css.Val = this.getProp(context, \"vertical-align\");\n    let flexAlign: string | null = null;\n    if (verticalAlign === Css.getName(\"middle\")) {\n      flexAlign = \"center\";\n    } else if (verticalAlign === Css.getName(\"top\")) {\n      flexAlign = \"flex-start\";\n    } else if (verticalAlign === Css.getName(\"bottom\")) {\n      flexAlign = \"flex-end\";\n    }\n    if (flexAlign) {\n      Base.setCSSProperty(element, \"justify-content\", flexAlign);\n    }\n    const content: Css.Val = this.getProp(context, \"content\");\n    if (\n      this.vertical ||\n      content instanceof Css.URL ||\n      (content instanceof Css.Expr &&\n        content.expr instanceof Exprs.Native &&\n        content.expr.str.startsWith(\"running-element-\"))\n    ) {\n      let align = \"center\";\n      if (this.boxInfo.isInTopRow || this.boxInfo.isInBottomRow) {\n        if (\n          this.boxInfo.isInLeftColumn ||\n          this.boxInfo.positionAlongVariableDimension ===\n            MarginBoxPositionAlongVariableDimension.END\n        ) {\n          align = this.vertical || this.rtl ? \"start\" : \"end\";\n        } else if (\n          this.boxInfo.isInRightColumn ||\n          this.boxInfo.positionAlongVariableDimension ===\n            MarginBoxPositionAlongVariableDimension.START\n        ) {\n          align = this.vertical || this.rtl ? \"end\" : \"start\";\n        }\n      }\n      Base.setCSSProperty(element, \"align-items\", align);\n    }\n  }\n\n  /**\n   * Calculate page-margin boxes positions along the variable dimension of the\n   * page. For CENTER and END margin boxes, the position is calculated only if\n   * the dimension (width or height) is non-auto, so that it can be resolved at\n   * this point. If the dimension is auto, the calculation is deferred.\n   */\n  private positionAlongVariableDimension(\n    names: {\n      start: \"top\" | \"left\";\n      end: \"bottom\" | \"right\";\n      extent: \"width\" | \"height\";\n    },\n    dim: PageAreaDimension | null,\n  ): void {\n    const style = this.style;\n    const scope = this.pageBox.scope;\n    const startSide = names.start;\n    const endSide = names.end;\n    const extentName = names.extent;\n    const isHorizontal = startSide === \"left\";\n    const availableExtent = isHorizontal\n      ? dim.borderBoxWidth\n      : dim.borderBoxHeight;\n    const extent = PageMaster.toExprAuto(\n      scope,\n      style[extentName],\n      availableExtent,\n    );\n    const startOffset = isHorizontal ? dim.marginLeft : dim.marginTop;\n    if (\n      this.boxInfo.positionAlongVariableDimension ===\n      MarginBoxPositionAlongVariableDimension.START\n    ) {\n      style[startSide] = new Css.Expr(startOffset);\n    } else if (extent) {\n      const marginStart = PageMaster.toExprZero(\n        scope,\n        style[`margin-${startSide}`],\n        availableExtent,\n      );\n      const marginEnd = PageMaster.toExprZero(\n        scope,\n        style[`margin-${endSide}`],\n        availableExtent,\n      );\n      const paddingStart = PageMaster.toExprZero(\n        scope,\n        style[`padding-${startSide}`],\n        availableExtent,\n      );\n      const paddingEnd = PageMaster.toExprZero(\n        scope,\n        style[`padding-${endSide}`],\n        availableExtent,\n      );\n      const borderStartWidth = PageMaster.toExprZeroBorder(\n        scope,\n        style[`border-${startSide}-width`],\n        style[`border-${startSide}-style`],\n        availableExtent,\n      );\n      const borderEndWidth = PageMaster.toExprZeroBorder(\n        scope,\n        style[`border-${endSide}-width`],\n        style[`border-${endSide}-style`],\n        availableExtent,\n      );\n      const outerExtent = Exprs.add(\n        scope,\n        extent,\n        Exprs.add(\n          scope,\n          this.borderBoxSizing\n            ? scope.zero\n            : Exprs.add(\n                scope,\n                Exprs.add(scope, paddingStart, paddingEnd),\n                Exprs.add(scope, borderStartWidth, borderEndWidth),\n              ),\n          Exprs.add(scope, marginStart, marginEnd),\n        ),\n      );\n      switch (this.boxInfo.positionAlongVariableDimension) {\n        case MarginBoxPositionAlongVariableDimension.CENTER:\n          style[startSide] = new Css.Expr(\n            Exprs.add(\n              scope,\n              startOffset,\n              Exprs.div(\n                scope,\n                Exprs.sub(scope, availableExtent, outerExtent),\n                new Exprs.Const(scope, 2),\n              ),\n            ),\n          );\n          break;\n        case MarginBoxPositionAlongVariableDimension.END:\n          style[startSide] = new Css.Expr(\n            Exprs.sub(\n              scope,\n              Exprs.add(scope, startOffset, availableExtent),\n              outerExtent,\n            ),\n          );\n          break;\n      }\n    }\n  }\n\n  /**\n   * Calculate page-margin boxes positions along the fixed dimension of the\n   * page.\n   */\n  private positionAndSizeAlongFixedDimension(\n    names: {\n      inside: \"left\" | \"right\" | \"top\" | \"bottom\";\n      outside: \"left\" | \"right\" | \"top\" | \"bottom\";\n      extent: \"width\" | \"height\";\n    },\n    dim: PageAreaDimension | null,\n  ): void {\n    const style = this.style;\n    const scope = this.pageBox.scope;\n    const borderBoxSizing = this.borderBoxSizing;\n    const insideName = names.inside;\n    const outsideName = names.outside;\n    const extentName = names.extent;\n    const pageMargin =\n      dim[\n        `margin${outsideName.charAt(0).toUpperCase()}${outsideName.substring(\n          1,\n        )}`\n      ];\n    const marginInside = PageMaster.toExprZeroAuto(\n      scope,\n      style[`margin-${insideName}`],\n      pageMargin,\n    );\n    const marginOutside = PageMaster.toExprZeroAuto(\n      scope,\n      style[`margin-${outsideName}`],\n      pageMargin,\n    );\n    const paddingInside = PageMaster.toExprZero(\n      scope,\n      style[`padding-${insideName}`],\n      pageMargin,\n    );\n    const paddingOutside = PageMaster.toExprZero(\n      scope,\n      style[`padding-${outsideName}`],\n      pageMargin,\n    );\n    const borderInsideWidth = PageMaster.toExprZeroBorder(\n      scope,\n      style[`border-${insideName}-width`],\n      style[`border-${insideName}-style`],\n      pageMargin,\n    );\n    const borderOutsideWidth = PageMaster.toExprZeroBorder(\n      scope,\n      style[`border-${outsideName}-width`],\n      style[`border-${outsideName}-style`],\n      pageMargin,\n    );\n    const extent = PageMaster.toExprAuto(scope, style[extentName], pageMargin);\n    let result: {\n      extent: Exprs.Result;\n      marginInside: Exprs.Result;\n      marginOutside: Exprs.Result;\n    } = null;\n\n    function getComputedValues(context: Exprs.Context): {\n      extent: Exprs.Result | null;\n      marginInside: Exprs.Result | null;\n      marginOutside: Exprs.Result | null;\n    } {\n      if (result) {\n        return result;\n      }\n      result = {\n        extent: extent ? extent.evaluate(context) : null,\n        marginInside: marginInside ? marginInside.evaluate(context) : null,\n        marginOutside: marginOutside ? marginOutside.evaluate(context) : null,\n      };\n      const pageMarginValue = pageMargin.evaluate(context);\n      let borderAndPadding = 0;\n      if (!borderBoxSizing) {\n        [\n          borderInsideWidth,\n          paddingInside,\n          paddingOutside,\n          borderOutsideWidth,\n        ].forEach((x) => {\n          if (x) {\n            borderAndPadding += x.evaluate(context) as number;\n          }\n        });\n      }\n      if (result.marginInside === null || result.marginOutside === null) {\n        const total =\n          borderAndPadding +\n          (result.extent as number) +\n          (result.marginInside as number) +\n          (result.marginOutside as number);\n        if (total > pageMarginValue) {\n          if (result.marginInside === null) {\n            result.marginInside = 0;\n          }\n          if (result.marginOutside === null) {\n            result.marginOutside = 0;\n          }\n        }\n      }\n      if (\n        result.extent !== null &&\n        result.marginInside !== null &&\n        result.marginOutside !== null\n      ) {\n        // over-constrained\n        result.marginOutside = null;\n      }\n      if (result.extent === null) {\n        result.extent =\n          pageMarginValue -\n          borderAndPadding -\n          (result.marginInside as number) -\n          (result.marginOutside as number);\n        if (result.marginInside === null) {\n          result.marginInside = 0;\n        }\n        if (result.marginOutside === null) {\n          result.marginOutside = 0;\n        }\n      } else if (typeof result.extent === \"number\") {\n        if (\n          result.marginInside === null &&\n          typeof result.marginOutside === \"number\"\n        ) {\n          result.marginInside =\n            pageMarginValue -\n            borderAndPadding -\n            result.extent -\n            result.marginOutside;\n        } else if (\n          typeof result.marginInside === \"number\" &&\n          result.marginOutside === null\n        ) {\n          result.marginOutside =\n            pageMarginValue -\n            borderAndPadding -\n            result.extent -\n            result.marginInside;\n        } else {\n          result.marginInside = result.marginOutside =\n            (pageMarginValue - borderAndPadding - result.extent) / 2;\n        }\n      }\n      return result;\n    }\n    style[extentName] = new Css.Expr(\n      new Exprs.Native(\n        scope,\n        function () {\n          const value = getComputedValues(this).extent;\n          return value === null ? \"auto\" : value;\n        },\n        extentName,\n      ),\n    );\n    style[`margin-${insideName}`] = new Css.Expr(\n      new Exprs.Native(\n        scope,\n        function () {\n          const value = getComputedValues(this).marginInside;\n          return value === null ? \"auto\" : value;\n        },\n        `margin-${insideName}`,\n      ),\n    );\n    style[`margin-${outsideName}`] = new Css.Expr(\n      new Exprs.Native(\n        scope,\n        function () {\n          const value = getComputedValues(this).marginOutside;\n          return value === null ? \"auto\" : value;\n        },\n        `margin-${outsideName}`,\n      ),\n    );\n    if (insideName === \"left\") {\n      style[\"left\"] = new Css.Expr(\n        Exprs.add(scope, dim.marginLeft, dim.borderBoxWidth),\n      );\n    } else if (insideName === \"top\") {\n      style[\"top\"] = new Css.Expr(\n        Exprs.add(scope, dim.marginTop, dim.borderBoxHeight),\n      );\n    }\n  }\n\n  override initHorizontal(): void {\n    const pageRuleMasterInstance = this\n      .parentInstance as PageRuleMasterInstance;\n    const dim = pageRuleMasterInstance.pageAreaDimension;\n    if (this.boxInfo.isInLeftColumn) {\n      this.positionAndSizeAlongFixedDimension(\n        { inside: \"right\", outside: \"left\", extent: \"width\" },\n        dim,\n      );\n    } else if (this.boxInfo.isInRightColumn) {\n      this.positionAndSizeAlongFixedDimension(\n        { inside: \"left\", outside: \"right\", extent: \"width\" },\n        dim,\n      );\n    } else {\n      this.positionAlongVariableDimension(\n        { start: \"left\", end: \"right\", extent: \"width\" },\n        dim,\n      );\n    }\n  }\n\n  override initVertical(): void {\n    const pageRuleMasterInstance = this\n      .parentInstance as PageRuleMasterInstance;\n    const dim = pageRuleMasterInstance.pageAreaDimension;\n    if (this.boxInfo.isInTopRow) {\n      this.positionAndSizeAlongFixedDimension(\n        { inside: \"bottom\", outside: \"top\", extent: \"height\" },\n        dim,\n      );\n    } else if (this.boxInfo.isInBottomRow) {\n      this.positionAndSizeAlongFixedDimension(\n        { inside: \"top\", outside: \"bottom\", extent: \"height\" },\n        dim,\n      );\n    } else {\n      this.positionAlongVariableDimension(\n        { start: \"top\", end: \"bottom\", extent: \"height\" },\n        dim,\n      );\n    }\n  }\n\n  override finishContainer(\n    context: Exprs.Context,\n    container: Vtree.Container,\n    page: Vtree.Page,\n    column: Vtree.Container | null,\n    columnCount: number,\n    clientLayout: Vtree.ClientLayout,\n    docFaces: Font.DocumentFaces,\n  ): void {\n    super.finishContainer(\n      context,\n      container,\n      page,\n      column,\n      columnCount,\n      clientLayout,\n      docFaces,\n    );\n\n    // finishContainer is called only when the margin box is generated.\n    // In this case, store the generated container for the margin box in the\n    // page object. (except when it is a corner margin box, because size of a\n    // corner margin box does not need to be adjusted after the layout)\n    const marginBoxes = page.marginBoxes;\n    const name = this.pageBox.marginBoxName;\n    const boxInfo = this.boxInfo;\n    if (!boxInfo.isInLeftColumn && !boxInfo.isInRightColumn) {\n      if (boxInfo.isInTopRow) {\n        marginBoxes.top[name] = container;\n      } else if (boxInfo.isInBottomRow) {\n        marginBoxes.bottom[name] = container;\n      }\n    } else if (!boxInfo.isInTopRow && !boxInfo.isInBottomRow) {\n      if (boxInfo.isInLeftColumn) {\n        marginBoxes.left[name] = container;\n      } else if (boxInfo.isInRightColumn) {\n        marginBoxes.right[name] = container;\n      }\n    }\n\n    // Margin box sizing with min-content/max-content/fit-content support\n    const pageAreaDimension = (this.parentInstance as PageRuleMasterInstance)\n      .pageAreaDimension;\n    const widthVal = this.getProp(context, \"width\");\n    const widthMinMaxFitContent =\n      widthVal instanceof Css.Ident &&\n      (widthVal.name === \"min-content\" ||\n        widthVal.name === \"max-content\" ||\n        widthVal.name === \"fit-content\")\n        ? widthVal.name\n        : null;\n    const minWidthVal = this.getPropAsNumber(context, \"min-width\");\n    const maxWidthVal = this.getPropAsNumber(context, \"max-width\");\n    if (widthMinMaxFitContent || minWidthVal || maxWidthVal) {\n      if (widthMinMaxFitContent) {\n        Base.setCSSProperty(container.element, \"width\", widthMinMaxFitContent);\n      }\n      if (minWidthVal) {\n        Base.setCSSProperty(container.element, \"min-width\", `${minWidthVal}px`);\n      }\n      if (maxWidthVal) {\n        Base.setCSSProperty(container.element, \"max-width\", `${maxWidthVal}px`);\n      }\n      const marginLeft = this.getProp(context, \"margin-left\");\n      const marginRight = this.getProp(context, \"margin-right\");\n      if (boxInfo.isInLeftColumn) {\n        const right =\n          (pageAreaDimension.borderBoxWidth.evaluate(context) as number) +\n          (pageAreaDimension.marginRight.evaluate(context) as number);\n        Base.setCSSProperty(container.element, \"right\", `${right}px`);\n        if (marginLeft === Css.ident.auto || marginRight !== Css.ident.auto) {\n          Base.setCSSProperty(container.element, \"margin-left\", \"auto\");\n        }\n        if (marginRight === Css.ident.auto) {\n          Base.setCSSProperty(container.element, \"margin-right\", \"auto\");\n        }\n      } else if (boxInfo.isInRightColumn) {\n        Base.setCSSProperty(container.element, \"right\", \"0\");\n        if (marginRight === Css.ident.auto || marginLeft !== Css.ident.auto) {\n          Base.setCSSProperty(container.element, \"margin-right\", \"auto\");\n        }\n        if (marginLeft === Css.ident.auto) {\n          Base.setCSSProperty(container.element, \"margin-left\", \"auto\");\n        }\n      }\n    }\n    const heightVal = this.getProp(context, \"height\");\n    const heightMinMaxFitContent =\n      heightVal instanceof Css.Ident &&\n      (heightVal.name === \"min-content\" ||\n        heightVal.name === \"max-content\" ||\n        heightVal.name === \"fit-content\")\n        ? heightVal.name\n        : null;\n    const minHeightVal = this.getPropAsNumber(context, \"min-height\");\n    const maxHeightVal = this.getPropAsNumber(context, \"max-height\");\n    if (heightMinMaxFitContent || minHeightVal || maxHeightVal) {\n      if (heightMinMaxFitContent) {\n        Base.setCSSProperty(\n          container.element,\n          \"height\",\n          heightMinMaxFitContent,\n        );\n      }\n      if (minHeightVal) {\n        Base.setCSSProperty(\n          container.element,\n          \"min-height\",\n          `${minHeightVal}px`,\n        );\n      }\n      if (maxHeightVal) {\n        Base.setCSSProperty(\n          container.element,\n          \"max-height\",\n          `${maxHeightVal}px`,\n        );\n      }\n      const marginTop = this.getProp(context, \"margin-top\");\n      const marginBottom = this.getProp(context, \"margin-bottom\");\n      if (boxInfo.isInTopRow) {\n        const bottom =\n          (pageAreaDimension.borderBoxHeight.evaluate(context) as number) +\n          (pageAreaDimension.marginBottom.evaluate(context) as number);\n        Base.setCSSProperty(container.element, \"bottom\", `${bottom}px`);\n        if (marginTop === Css.ident.auto || marginBottom !== Css.ident.auto) {\n          Base.setCSSProperty(container.element, \"margin-top\", \"auto\");\n        }\n        if (marginBottom === Css.ident.auto) {\n          Base.setCSSProperty(container.element, \"margin-bottom\", \"auto\");\n        }\n      } else if (boxInfo.isInBottomRow) {\n        Base.setCSSProperty(container.element, \"bottom\", \"0\");\n        if (marginBottom === Css.ident.auto || marginTop !== Css.ident.auto) {\n          Base.setCSSProperty(container.element, \"margin-bottom\", \"auto\");\n        }\n        if (marginTop === Css.ident.auto) {\n          Base.setCSSProperty(container.element, \"margin-top\", \"auto\");\n        }\n      }\n    }\n  }\n}\n\n/**\n * Dynamically generate and manage page masters corresponding to page at-rules.\n */\nexport class PageManager {\n  private pageMasterCache: any = {} as {\n    [key: string]: PageMaster.PageMasterInstance;\n  };\n\n  constructor(\n    private readonly cascadeInstance: CssCascade.CascadeInstance,\n    private readonly pageScope: Exprs.LexicalScope,\n    private readonly rootPageBoxInstance: PageMaster.RootPageBoxInstance,\n    private readonly context: Exprs.Context,\n    private readonly docElementStyle: CssCascade.ElementStyle,\n  ) {\n    this.definePageProgression();\n  }\n\n  /**\n   * Determine the page progression and define left/right/recto/verso pages.\n   */\n  private definePageProgression() {\n    // If a page break is forced before the root element, recto/verso pages\n    // are no longer odd/even pages. left/right are reversed too.\n    const scope = this.pageScope;\n    const styleInstance: any /* Ops.StyleInstance */ = this.context;\n    const isVersoFirstPage = styleInstance.isVersoFirstPage;\n    const pageNumber = new Exprs.Named(scope, \"page-number\");\n    const isVersoPage = new Exprs.Eq(\n      scope,\n      new Exprs.Modulo(scope, pageNumber, new Exprs.Const(scope, 2)),\n      isVersoFirstPage ? scope.one : scope.zero,\n    );\n    scope.defineName(\"recto-page\", new Exprs.Not(scope, isVersoPage));\n    scope.defineName(\"verso-page\", isVersoPage);\n    const pageProgression =\n      styleInstance.pageProgression ||\n      resolvePageProgression(this.docElementStyle);\n    if (pageProgression === Constants.PageProgression.LTR) {\n      scope.defineName(\"left-page\", isVersoPage);\n      scope.defineName(\"right-page\", new Exprs.Not(scope, isVersoPage));\n    } else {\n      scope.defineName(\"left-page\", new Exprs.Not(scope, isVersoPage));\n      scope.defineName(\"right-page\", isVersoPage);\n    }\n  }\n\n  /**\n   * Get cascaded page style specified in page context for the current page.\n   */\n  getCascadedPageStyle(pageType: string): CssCascade.ElementStyle {\n    const style = {} as CssCascade.ElementStyle;\n    this.cascadeInstance.pushRule([], pageType, style);\n    this.cascadeInstance.popRule();\n    return style;\n  }\n\n  /**\n   * Return a PageMasterInstance with page rules applied. Return a cached\n   * instance if there already exists one with the same styles.\n   * @param pageMasterInstance The original page master instance.\n   * @param cascadedPageStyle Cascaded page style specified in page context.\n   */\n  getPageRulePageMaster(\n    pageMasterInstance: PageMaster.PageMasterInstance,\n    cascadedPageStyle: CssCascade.ElementStyle,\n  ): PageMaster.PageMasterInstance {\n    const pageMaster = pageMasterInstance.pageBox as PageMaster.PageMaster;\n\n    // If no properties are specified in @page rules, use the original page\n    // master.\n    if (Object.keys(cascadedPageStyle).length === 0) {\n      pageMaster.resetScope();\n      return pageMasterInstance;\n    }\n    const key = this.makeCacheKey(cascadedPageStyle, pageMaster);\n    let applied = this.pageMasterCache[key];\n    if (!applied) {\n      if (pageMaster.pseudoName === PageMaster.userAgentPageMasterPseudo) {\n        // If the passed page master is a UA page master,\n        // ignore it and generate a new page master from @page rules.\n        applied = this.generatePageRuleMaster(cascadedPageStyle);\n      } else {\n        // Otherwise cascade some properties from @page rules to the page\n        // master.\n        applied = this.generateCascadedPageMaster(\n          cascadedPageStyle,\n          pageMaster,\n        );\n      }\n      this.pageMasterCache[key] = applied;\n    }\n    applied.pageBox.resetScope();\n    return applied;\n  }\n\n  /**\n   * Generate a cache key from the specified styles and the original page master\n   * key.\n   */\n  private makeCacheKey(\n    style: CssCascade.ElementStyle,\n    pageMaster: PageMaster.PageMaster,\n  ): string {\n    const propsStr = this.makeCascadeValueObjectKey(style);\n    const pageMod2 = (this.context as any).currentLayoutPosition?.page % 2;\n    return `${pageMaster.key}^${propsStr}^${pageMod2}`;\n  }\n\n  private makeCascadeValueObjectKey(object: CssCascade.ElementStyle): string {\n    const props = [] as string[];\n    for (const prop in object) {\n      if (Object.prototype.hasOwnProperty.call(object, prop)) {\n        const val = object[prop] as CssCascade.CascadeValue;\n        let str: string;\n        if (val instanceof CssCascade.CascadeValue) {\n          str = `${val.value}`;\n        } else {\n          str = this.makeCascadeValueObjectKey(val);\n        }\n        props.push(prop + str + (val.priority || \"\"));\n      }\n    }\n    return props.sort().join(\"^\");\n  }\n\n  private generatePageRuleMaster(\n    style: CssCascade.ElementStyle,\n  ): PageRuleMasterInstance {\n    const pageMaster = new PageRuleMaster(\n      this.pageScope,\n      this.rootPageBoxInstance.pageBox as PageMaster.RootPageBox,\n      style,\n    );\n    const pageMasterInstance = pageMaster.createInstance(\n      this.rootPageBoxInstance,\n    );\n\n    // Do the same initialization as in Ops.StyleInstance.prototype.init\n    pageMasterInstance.applyCascadeAndInit(\n      this.cascadeInstance,\n      this.docElementStyle,\n    );\n    pageMasterInstance.resolveAutoSizing(this.context);\n    return pageMasterInstance;\n  }\n\n  /**\n   * Cascade some properties from `@page` rules to a page master.\n   * For now, only 'width' and 'height' resolved from 'size' value are cascaded.\n   * @param style Cascaded style in the page context\n   * @param pageMaster The original page master\n   */\n  private generateCascadedPageMaster(\n    style: CssCascade.ElementStyle,\n    pageMaster: PageMaster.PageMaster,\n  ): PageMaster.PageMasterInstance {\n    const newPageMaster = pageMaster.clone({\n      pseudoName: pageRuleMasterPseudoName,\n    });\n    const pageMasterStyle = newPageMaster.specified;\n    const size = style[\"size\"] as CssCascade.CascadeValue;\n    if (size && !Css.isDefaultingValue(size.value)) {\n      const pageSize = resolvePageSizeAndBleed(style as any);\n      const priority = size.priority;\n      CssCascade.setPropCascadeValue(\n        pageMasterStyle,\n        \"width\",\n        new CssCascade.CascadeValue(pageSize.width, priority),\n        this.context,\n      );\n      CssCascade.setPropCascadeValue(\n        pageMasterStyle,\n        \"height\",\n        new CssCascade.CascadeValue(pageSize.height, priority),\n        this.context,\n      );\n    }\n\n    // Transfer counter properties to the page style so that these specified in\n    // the page master are also effective. Note that these values (if specified)\n    // always override values in page contexts.\n    [\"counter-reset\", \"counter-increment\"].forEach((name) => {\n      if (pageMasterStyle[name]) {\n        style[name] = pageMasterStyle[name];\n      }\n    });\n    const pageMasterInstance = newPageMaster.createInstance(\n      this.rootPageBoxInstance,\n    ) as PageMaster.PageMasterInstance;\n\n    // Do the same initialization as in Ops.StyleInstance.prototype.init\n    pageMasterInstance.applyCascadeAndInit(\n      this.cascadeInstance,\n      this.docElementStyle,\n    );\n    pageMasterInstance.resolveAutoSizing(this.context);\n    return pageMasterInstance;\n  }\n}\n\nexport class CheckPageTypeAction extends CssCascade.ChainedAction {\n  constructor(public readonly pageType: string) {\n    super();\n  }\n\n  override apply(cascadeInstance: CssCascade.CascadeInstance): void {\n    if (cascadeInstance.currentPageType === this.pageType) {\n      this.chained.apply(cascadeInstance);\n    }\n  }\n\n  override getPriority(): number {\n    return 3;\n  }\n\n  override makePrimary(cascade: CssCascade.Cascade): boolean {\n    if (this.chained) {\n      cascade.insertInTable(cascade.pagetypes, this.pageType, this.chained);\n    }\n    return true;\n  }\n}\n\nexport class IsFirstPageAction extends CssCascade.ChainedAction {\n  constructor(public readonly scope: Exprs.LexicalScope) {\n    super();\n  }\n\n  override apply(cascadeInstance: CssCascade.CascadeInstance): void {\n    const pageNumber = new Exprs.Named(this.scope, \"page-number\");\n    if (pageNumber.evaluate(cascadeInstance.context) === 1) {\n      this.chained.apply(cascadeInstance);\n    }\n  }\n\n  override getPriority(): number {\n    return 2;\n  }\n}\n\nexport class IsBlankPageAction extends CssCascade.ChainedAction {\n  constructor(public readonly scope: Exprs.LexicalScope) {\n    super();\n  }\n\n  override apply(cascadeInstance: CssCascade.CascadeInstance): void {\n    const blankPage = new Exprs.Named(this.scope, \"blank-page\");\n    if (blankPage.evaluate(cascadeInstance.context)) {\n      this.chained.apply(cascadeInstance);\n    }\n  }\n\n  override getPriority(): number {\n    return 2;\n  }\n}\n\nexport class IsLeftPageAction extends CssCascade.ChainedAction {\n  constructor(public readonly scope: Exprs.LexicalScope) {\n    super();\n  }\n\n  override apply(cascadeInstance: CssCascade.CascadeInstance): void {\n    const leftPage = new Exprs.Named(this.scope, \"left-page\");\n    if (leftPage.evaluate(cascadeInstance.context)) {\n      this.chained.apply(cascadeInstance);\n    }\n  }\n\n  override getPriority(): number {\n    return 1;\n  }\n}\n\nexport class IsRightPageAction extends CssCascade.ChainedAction {\n  constructor(public readonly scope: Exprs.LexicalScope) {\n    super();\n  }\n\n  override apply(cascadeInstance: CssCascade.CascadeInstance): void {\n    const rightPage = new Exprs.Named(this.scope, \"right-page\");\n    if (rightPage.evaluate(cascadeInstance.context)) {\n      this.chained.apply(cascadeInstance);\n    }\n  }\n\n  override getPriority(): number {\n    return 1;\n  }\n}\n\nexport class IsRectoPageAction extends CssCascade.ChainedAction {\n  constructor(public readonly scope: Exprs.LexicalScope) {\n    super();\n  }\n\n  override apply(cascadeInstance: CssCascade.CascadeInstance): void {\n    const rectoPage = new Exprs.Named(this.scope, \"recto-page\");\n    if (rectoPage.evaluate(cascadeInstance.context)) {\n      this.chained.apply(cascadeInstance);\n    }\n  }\n\n  override getPriority(): number {\n    return 1;\n  }\n}\n\nexport class IsVersoPageAction extends CssCascade.ChainedAction {\n  constructor(public readonly scope: Exprs.LexicalScope) {\n    super();\n  }\n\n  override apply(cascadeInstance: CssCascade.CascadeInstance): void {\n    const versoPage = new Exprs.Named(this.scope, \"verso-page\");\n    if (versoPage.evaluate(cascadeInstance.context)) {\n      this.chained.apply(cascadeInstance);\n    }\n  }\n\n  override getPriority(): number {\n    return 1;\n  }\n}\n\nexport class IsNthPageAction extends CssCascade.IsNthAction {\n  constructor(\n    public readonly scope: Exprs.LexicalScope,\n    public readonly a: number,\n    public readonly b: number,\n  ) {\n    super(a, b);\n  }\n\n  override apply(cascadeInstance: CssCascade.CascadeInstance): void {\n    const styleInstance: any /* Ops.StyleInstance */ = cascadeInstance.context;\n    let pageNumber = styleInstance.layoutPositionAtPageStart.page;\n    if (styleInstance.blankPageAtStart) {\n      pageNumber--;\n    }\n    if (pageNumber && this.matchANPlusB(pageNumber)) {\n      this.chained.apply(cascadeInstance);\n    }\n  }\n\n  override getPriority(): number {\n    return 2;\n  }\n}\n\n/**\n * Action applying an at-page rule\n */\nexport class ApplyPageRuleAction extends CssCascade.ApplyRuleAction {\n  constructor(style: CssCascade.ElementStyle, specificity: number) {\n    super(style, specificity, null, null, null);\n  }\n\n  override apply(cascadeInstance: CssCascade.CascadeInstance): void {\n    mergeInPageRule(\n      cascadeInstance.context,\n      cascadeInstance.currentStyle,\n      this.style,\n      this.specificity,\n      cascadeInstance,\n    );\n  }\n}\n\n/**\n * Merge page styles, including styles specified on page-margin boxes,\n * considering specificity. Intended to be used in place of\n * CssCascade.mergeIn, which is for element styles.\n */\nexport function mergeInPageRule(\n  context: Exprs.Context,\n  target: CssCascade.ElementStyle,\n  style: CssCascade.ElementStyle,\n  specificity: number,\n  cascadeInstance: CssCascade.CascadeInstance,\n): void {\n  CssCascade.mergeIn(context, target, style, specificity, null, null, null);\n  const marginBoxes = style[marginBoxesKey];\n  if (marginBoxes) {\n    const targetMap = CssCascade.getMutableStyleMap(target, marginBoxesKey);\n    for (const boxName in marginBoxes) {\n      if (marginBoxes.hasOwnProperty(boxName)) {\n        let targetBox = targetMap[boxName];\n        if (!targetBox) {\n          targetBox = {} as CssCascade.ElementStyle;\n          targetMap[boxName] = targetBox;\n        }\n        CssCascade.mergeIn(\n          context,\n          targetBox,\n          marginBoxes[boxName],\n          specificity,\n          null,\n          null,\n          null,\n        );\n      }\n    }\n  }\n}\n\n/**\n * ParserHandler for `@page` rules. It handles properties specified with page\n * contexts. It also does basic cascading (which can be done without information\n * other than the page rules themselves) and stores the result in `pageProps`\n * object as a map from page selectors to sets of properties. This result is\n * later used for adding `@page` rules to the real DOM, which are then used by\n * the PDF renderer (Chromium) to determine page sizes.\n */\nexport class PageParserHandler\n  extends CssCascade.CascadeParserHandler\n  implements CssValidator.PropertyReceiver\n{\n  private currentPageSelectors: {\n    selectors: string[] | null;\n    specificity: number;\n  }[] = [];\n  private currentNamedPageSelector: string = \"\";\n  private currentPseudoPageClassSelectors: string[] = [];\n\n  constructor(\n    scope: Exprs.LexicalScope,\n    owner: CssParser.DispatchParserHandler,\n    parent: CssCascade.CascadeParserHandler,\n    validatorSet: CssValidator.ValidatorSet,\n    private readonly pageProps: { [key: string]: CssCascade.ElementStyle },\n  ) {\n    super(scope, owner, parent?.condition, parent, null, validatorSet, false);\n  }\n\n  override startPageRule(): void {\n    this.startSelectorRule();\n  }\n\n  override tagSelector(ns: string | null, name: string | null): void {\n    Asserts.assert(name);\n    this.currentNamedPageSelector = name;\n    if (name) {\n      this.chain.push(new CheckPageTypeAction(name));\n      this.specificity += 65536;\n    }\n  }\n\n  override pseudoclassSelector(\n    name: string,\n    params: (number | string)[],\n  ): void {\n    name = name.toLowerCase();\n    if (params) {\n      switch (name) {\n        case \"nth\":\n          {\n            const [a, b] = params as number[];\n            this.currentPseudoPageClassSelectors.push(\n              `:${name}(${a}n${b < 0 ? b : \"+\" + b})`,\n            );\n            this.chain.push(new IsNthPageAction(this.scope, a, b));\n            this.specificity += 256;\n          }\n          break;\n        default:\n          this.reportAndSkip(\n            `E_INVALID_PAGE_SELECTOR :${name}(${params.join(\"\")})`,\n          );\n          break;\n      }\n    } else {\n      this.currentPseudoPageClassSelectors.push(`:${name}`);\n      switch (name) {\n        case \"first\":\n          this.chain.push(new IsFirstPageAction(this.scope));\n          this.specificity += 256;\n          break;\n        case \"blank\":\n          this.chain.push(new IsBlankPageAction(this.scope));\n          this.specificity += 256;\n          break;\n        case \"left\":\n          this.chain.push(new IsLeftPageAction(this.scope));\n          this.specificity += 1;\n          break;\n        case \"right\":\n          this.chain.push(new IsRightPageAction(this.scope));\n          this.specificity += 1;\n          break;\n        case \"recto\":\n          this.chain.push(new IsRectoPageAction(this.scope));\n          this.specificity += 1;\n          break;\n        case \"verso\":\n          this.chain.push(new IsVersoPageAction(this.scope));\n          this.specificity += 1;\n          break;\n        default:\n          this.reportAndSkip(`E_INVALID_PAGE_SELECTOR :${name}`);\n          break;\n      }\n    }\n  }\n\n  /**\n   * Save currently processed selector and reset variables.\n   */\n  private finishSelector() {\n    let selectors: string[];\n    if (\n      !this.currentNamedPageSelector &&\n      !this.currentPseudoPageClassSelectors.length\n    ) {\n      selectors = null;\n    } else {\n      selectors = [this.currentNamedPageSelector].concat(\n        this.currentPseudoPageClassSelectors.sort(),\n      );\n    }\n    this.currentPageSelectors.push({\n      selectors,\n      specificity: this.specificity,\n    });\n    this.currentNamedPageSelector = \"\";\n    this.currentPseudoPageClassSelectors = [];\n  }\n\n  override nextSelector(): void {\n    this.finishSelector();\n    super.nextSelector();\n  }\n\n  override startRuleBody(): void {\n    this.finishSelector();\n    super.startRuleBody();\n  }\n\n  override simpleProperty(name: string, value: Css.Val, important): void {\n    // we limit 'bleed' and 'marks' to be effective only when specified without\n    // page selectors\n    if (\n      (name === \"bleed\" || name === \"marks\") &&\n      !this.currentPageSelectors.some((s) => s.selectors === null)\n    ) {\n      return;\n    }\n    super.simpleProperty(name, value, important);\n    const cascVal = CssCascade.getProp(this.elementStyle, name);\n    const pageProps = this.pageProps;\n    if (name === \"bleed\" || name === \"marks\") {\n      if (!pageProps[\"\"]) {\n        pageProps[\"\"] = {} as CssCascade.ElementStyle;\n      }\n\n      // we can simply overwrite without considering specificity\n      // since 'bleed' and 'marks' always come from a page rule without page\n      // selectors.\n      Object.keys(pageProps).forEach((selector) => {\n        CssCascade.setProp(pageProps[selector], name, cascVal);\n      });\n    } else if (name === \"size\") {\n      const noPageSelectorProps = pageProps[\"\"];\n      this.currentPageSelectors.forEach((s) => {\n        // update specificity to reflect the specificity of the selector\n        const result = new CssCascade.CascadeValue(\n          cascVal.value,\n          cascVal.priority + s.specificity,\n        );\n        const selector = s.selectors ? s.selectors.join(\"\") : \"\";\n        let props = pageProps[selector];\n        if (!props) {\n          // since no properties for this selector have been stored before,\n          // we can simply set the 'size', 'bleed' and 'marks' properties.\n          props = pageProps[selector] = {} as CssCascade.ElementStyle;\n          CssCascade.setProp(props, name, result);\n          if (noPageSelectorProps) {\n            [\"bleed\", \"marks\"].forEach((n) => {\n              if (noPageSelectorProps[n]) {\n                CssCascade.setProp(\n                  props,\n                  n,\n                  noPageSelectorProps[n] as CssCascade.CascadeValue,\n                );\n              }\n            });\n          }\n        } else {\n          // consider specificity when setting 'size' property.\n          // we don't have to set 'bleed' and 'marks' since they should have\n          // been already updated.\n          CssCascade.setPropCascadeValue(props, name, result);\n        }\n      });\n    }\n  }\n\n  override insertNonPrimary(action: CssCascade.CascadeAction): void {\n    // We represent page rules without selectors by *, though it is illegal in\n    // CSS\n    this.cascade.insertInTable(this.cascade.pagetypes, \"*\", action);\n  }\n\n  override makeApplyRuleAction(\n    specificity: number,\n  ): CssCascade.ApplyRuleAction {\n    return new ApplyPageRuleAction(this.elementStyle, specificity);\n  }\n\n  override startPageMarginBoxRule(name: string): void {\n    const marginBoxMap = CssCascade.getMutableStyleMap(\n      this.elementStyle,\n      marginBoxesKey,\n    );\n    let boxStyle = marginBoxMap[name];\n    if (!boxStyle) {\n      boxStyle = {} as CssCascade.ElementStyle;\n      marginBoxMap[name] = boxStyle;\n    }\n    const handler = new PageMarginBoxParserHandler(\n      this.scope,\n      this.owner,\n      this.validatorSet,\n      boxStyle,\n    );\n    this.owner.pushHandler(handler);\n  }\n}\n\n/**\n * Parser handler for a page-margin box rule.\n */\nexport class PageMarginBoxParserHandler\n  extends CssParser.SlaveParserHandler\n  implements CssValidator.PropertyReceiver\n{\n  constructor(\n    scope: Exprs.LexicalScope,\n    owner: CssParser.DispatchParserHandler,\n    public readonly validatorSet: CssValidator.ValidatorSet,\n    public readonly boxStyle: CssCascade.ElementStyle,\n  ) {\n    super(scope, owner, false);\n  }\n\n  override property(name: string, value: Css.Val, important: boolean): void {\n    this.validatorSet.validatePropertyAndHandleShorthand(\n      name,\n      value,\n      important,\n      this,\n    );\n  }\n\n  /** @override */\n  invalidPropertyValue(name: string, value: Css.Val): void {\n    this.report(`E_INVALID_PROPERTY_VALUE ${name}: ${value.toString()}`);\n  }\n\n  /** @override */\n  unknownProperty(name: string, value: Css.Val): void {\n    this.report(`E_INVALID_PROPERTY ${name}: ${value.toString()}`);\n  }\n\n  /** @override */\n  simpleProperty(name: string, value: Css.Val, important): void {\n    const specificity = important\n      ? this.getImportantSpecificity()\n      : this.getBaseSpecificity();\n    const cascval = new CssCascade.CascadeValue(value, specificity);\n    CssCascade.setProp(this.boxStyle, name, cascval);\n  }\n}\n", "/**\n * Copyright 2022 Vivliostyle Foundation\n *\n * Vivliostyle.js is free software: you can redistribute it and/or modify\n * it under the terms of the GNU Affero General Public License as published by\n * the Free Software Foundation, either version 3 of the License, or\n * (at your option) any later version.\n *\n * Vivliostyle.js is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n * GNU Affero General Public License for more details.\n *\n * You should have received a copy of the GNU Affero General Public License\n * along with Vivliostyle.js.  If not, see <http://www.gnu.org/licenses/>.\n *\n * @fileoverview Scripts - Supports JavaScript in source document.\n */\nimport * as CssCascade from \"./css-cascade\";\nimport * as CssStyler from \"./css-styler\";\nimport * as Net from \"./net\";\nimport * as Task from \"./task\";\nimport * as Logging from \"./logging\";\nimport * as TaskUtil from \"./task-util\";\n\n/**\n * Enable or disable JavaScript in html support\n */\nexport let allowScripts = true;\nexport function setAllowScripts(value: boolean): void {\n  allowScripts = value;\n}\n\nconst deferredScripts: HTMLScriptElement[] = [];\n\nfunction sameScripts(s1: HTMLScriptElement, s2: HTMLScriptElement): boolean {\n  return (\n    s1 === s2 ||\n    (s1.src || s2.src ? s1.src === s2.src : s1.textContent === s2.textContent)\n  );\n}\n\nfunction getScriptsInOrNearHead(document: Document): HTMLScriptElement[] {\n  // To support Chrome < 88 and Firefox < 84, we cannot use\n  // the selector \"body > script:not(:not(script, link, style) ~ *)\".\n  // (Issue #919)\n  const scriptsInBodyNotNearHead = Array.from(\n    document.querySelectorAll(\n      \"body > :not(script):not(link):not(style) ~ script\",\n    ),\n  ) as HTMLScriptElement[];\n  return (\n    Array.from(\n      document.querySelectorAll(\"head > script, body > script\"),\n    ) as HTMLScriptElement[]\n  ).filter((script) => !scriptsInBodyNotNearHead.includes(script));\n}\n\nexport function loadScript(\n  srcScriptElem: HTMLScriptElement,\n  window: Window,\n  flags?: { inHead?: boolean; atEnd?: boolean; forceDefer?: boolean },\n): Task.Result<boolean> {\n  if (!allowScripts) {\n    return Task.newResult(false);\n  }\n  if (\n    !flags?.inHead &&\n    !flags?.atEnd &&\n    getScriptsInOrNearHead(srcScriptElem.ownerDocument).includes(srcScriptElem)\n  ) {\n    // The script elements at beginning of body have already been processed.\n    return Task.newResult(false);\n  }\n\n  const scriptContent = srcScriptElem.textContent;\n  const src = srcScriptElem.src;\n  const isModule = srcScriptElem.type === \"module\";\n\n  // Special handling for MathJax\n  // NOTE: We support MathJax 2 only for now.\n  const isMathJax = src && src.includes(\"/MathJax.js\");\n  if (isMathJax) {\n    if (window.document.head.querySelector(\"script[src*='/MathJax.js']\")) {\n      // Ignore if MathJax is already loaded\n      return Task.newResult(true);\n    }\n    if (!window[\"MathJax\"]) {\n      // mathjax-config.js\n      window[\"MathJax\"] = {\n        MathML: {\n          extensions: [\"content-mathml.js\"],\n        },\n        showProcessingMessages: false,\n        messageStyle: \"none\",\n        skipStartupTypeset: true,\n        CommonHTML: {\n          linebreaks: {\n            automatic: true,\n          },\n        },\n        \"fast-preview\": {\n          disabled: true,\n        },\n        AuthorInit: function () {\n          window[\"MathJax\"].Hub.processSectionDelay = 0;\n        },\n      };\n    }\n  }\n\n  const async = (isModule || src) && srcScriptElem.async && !isMathJax;\n  const defer =\n    ((isModule && !async) || (src && srcScriptElem.defer)) && !isMathJax;\n  const needDefer = !flags?.atEnd && (flags?.forceDefer || defer || async);\n\n  if (!hasScripts(window)) {\n    // `window.onload = startViewer`, which was set by vivliostyle-viewer,\n    // has to be unset to prevent `startViewer` restarting because of\n    // `window.dispatchEvent(new Event(\"load\"))` in `loadScriptsAtEnd()`.\n    window.onload = null;\n  }\n\n  if (needDefer) {\n    if (!deferredScripts.some((s) => sameScripts(s, srcScriptElem))) {\n      deferredScripts.push(srcScriptElem);\n    }\n    return Task.newResult(true);\n  }\n\n  for (const s of window.document.head.getElementsByTagName(\"script\")) {\n    if (\n      s.hasAttribute(\"data-vivliostyle-scripting\") &&\n      sameScripts(s, srcScriptElem)\n    ) {\n      // If same script is already loaded, remove the already loaded one before load the new one.\n      window.document.head.removeChild(s);\n    }\n  }\n\n  const scriptElem = window.document.createElement(\"script\");\n  scriptElem.textContent = scriptContent;\n  if (src) {\n    scriptElem.src = src;\n  }\n  scriptElem.async = async;\n  scriptElem.defer = defer;\n  scriptElem.setAttribute(\"data-vivliostyle-scripting\", \"true\");\n\n  for (const attr of srcScriptElem.attributes) {\n    if (![\"src\", \"async\", \"defer\"].includes(attr.name)) {\n      scriptElem.setAttribute(attr.name, attr.value);\n    }\n  }\n  Logging.logger.debug(\"script:\", src);\n  if (!src) {\n    window.document.head.appendChild(scriptElem);\n    return Task.newResult(true);\n  } else {\n    const fetcher = Net.loadElement(scriptElem);\n    window.document.head.appendChild(scriptElem);\n    return TaskUtil.waitForFetchers([fetcher]);\n  }\n}\n\nfunction getAllFontFamilyList(\n  srcDocument: Document,\n  styler: CssStyler.Styler,\n): string {\n  const fontFamilySet = {};\n  const findFontFamilyInStyle = (style: any): void => {\n    const fontFamily = style[\"font-family\"]?.value;\n    if (fontFamily) {\n      if (fontFamily.values) {\n        for (const family1 of fontFamily.values) {\n          fontFamilySet[family1.stringValue()] = true;\n        }\n      } else {\n        fontFamilySet[fontFamily.stringValue()] = true;\n      }\n    }\n    const marginBoxes = style[\"_marginBoxes\"];\n    if (marginBoxes) {\n      for (const marginBoxStyle of Object.values(marginBoxes)) {\n        findFontFamilyInStyle(marginBoxStyle);\n      }\n    }\n  };\n  const findAllFontFamily = (arg: any): void => {\n    if (arg instanceof CssCascade.ApplyRuleAction) {\n      findFontFamilyInStyle(arg.style);\n    } else if (arg instanceof CssCascade.CascadeAction || Array.isArray(arg)) {\n      for (const v of Object.values(arg)) {\n        findAllFontFamily(v);\n      }\n    }\n  };\n  // Find all font-family values in stylesheets.\n  for (const obj of Object.values(styler.cascade.code)) {\n    for (const arg of Object.values(obj ?? {})) {\n      findAllFontFamily(arg);\n    }\n  }\n  // Find all font-family values in inline style.\n  for (const elem of srcDocument.querySelectorAll(\"[style]\")) {\n    if ((elem as HTMLElement).style?.fontFamily) {\n      fontFamilySet[(elem as HTMLElement).style.fontFamily] = true;\n    }\n  }\n  return Object.keys(fontFamilySet).join(\",\");\n}\n\nfunction prepareTextContentForWebFonts(\n  srcDocument: Document,\n  window: Window,\n  styler: CssStyler.Styler,\n): HTMLElement {\n  const textContentDiv: HTMLElement =\n    window.document.querySelector(\"[data-vivliostyle-textcontent]\") ??\n    window.document.createElement(\"div\");\n  textContentDiv.style.position = \"fixed\";\n  textContentDiv.style.fontSize = \"0\";\n  textContentDiv.setAttribute(\"data-vivliostyle-textcontent\", \"true\");\n  textContentDiv.setAttribute(\"aria-hidden\", \"true\");\n  textContentDiv.style.fontFamily = getAllFontFamilyList(srcDocument, styler);\n  textContentDiv.textContent = srcDocument.documentElement.textContent;\n  window.document.body.appendChild(textContentDiv);\n  return textContentDiv;\n}\n\nexport function loadScriptsInHead(\n  srcDocument: Document,\n  window: Window,\n  styler: CssStyler.Styler,\n): Task.Result<boolean> {\n  if (!allowScripts) {\n    return Task.newResult(false);\n  }\n  // Process script elements in head and also beginning of body\n  const srcScripts: HTMLScriptElement[] = getScriptsInOrNearHead(srcDocument);\n  if (srcScripts.length === 0) {\n    return Task.newResult(false);\n  }\n  const needPrepareForWebFonts = srcScripts.some(\n    (s) => !(s.async || s.defer || s.type === \"module\"),\n  );\n\n  // Web fonts needs text content of the document\n  const textContentDiv = needPrepareForWebFonts\n    ? prepareTextContentForWebFonts(srcDocument, window, styler)\n    : null;\n  const fonts = window.document.fonts; // FontFaceSet\n  const savedDollar = window[\"$\"];\n  let forceDefer = false;\n  const frame: Task.Frame<boolean> = Task.newFrame(\"loadScripts\");\n  frame\n    .loop(() => {\n      if (srcScripts.length === 0) {\n        if (!needPrepareForWebFonts) {\n          return Task.newResult(false); // break\n        }\n        return frame.sleep(20).thenAsync(() => {\n          if (\n            fonts.status === \"loading\" ||\n            // for Typekit Web Font Loader (Adobe Fonts)\n            window.document.documentElement.classList.contains(\"wf-loading\") ||\n            // For DynaFont\n            // FIXME: checking the global variable `ret` set in https://dfo.dynacw.co.jp/JSDynaFont/DynaFont.js\n            // would be not very good, because it seems to have been made global by mistake.\n            (window[\"FontJSON\"]?.Font &&\n              window[\"ret\"]?.readyState &&\n              window[\"ret\"].readyState < 4)\n          ) {\n            return Task.newResult(true); // continue\n          }\n          return Task.newResult(false); // break\n        });\n      }\n      const srcScriptElem = srcScripts.shift();\n      return loadScript(srcScriptElem, window, {\n        inHead: true,\n        forceDefer,\n      }).thenAsync(() => {\n        if (!forceDefer && window[\"$\"] !== savedDollar) {\n          // jQuery `$(\u2026)` does not work before document is loaded, so need to defer\n          deferredScripts.push(srcScriptElem);\n          forceDefer = true;\n        }\n        if (srcScripts.length === 0) {\n          if (needPrepareForWebFonts) {\n            // Some web font loaders (DynaFont, FONTPLUS) need DOMContentLoaded event\n            Logging.logger.debug(\"dispatchEvent: DOMContentLoaded (document)\");\n            window.document.dispatchEvent(new Event(\"DOMContentLoaded\"));\n          }\n        }\n        return Task.newResult(true); // continue\n      });\n    })\n    .then(() => {\n      if (textContentDiv) {\n        textContentDiv.remove();\n      }\n      frame.finish(true);\n    });\n  return frame.result();\n}\n\nexport function loadScriptsAtEnd(window: Window): Task.Result<boolean> {\n  if (!allowScripts) {\n    return Task.newResult(false);\n  }\n  const frame: Task.Frame<boolean> = Task.newFrame(\"loadScripts\");\n  frame\n    .loop(() => {\n      if (deferredScripts.length === 0) {\n        return Task.newResult(false);\n      }\n      return loadScript(deferredScripts.shift(), window, {\n        atEnd: true,\n      }).thenReturn(deferredScripts.length > 0);\n    })\n    .then(() => {\n      Logging.logger.debug(\"dispatchEvent: DOMContentLoaded (window)\");\n      window.dispatchEvent(new Event(\"DOMContentLoaded\"));\n      Logging.logger.debug(\"dispatchEvent: load (window)\");\n      window.dispatchEvent(new Event(\"load\"));\n      frame.finish(true);\n    });\n  return frame.result();\n}\n\nexport function hasScripts(window: Window) {\n  if (!allowScripts) {\n    return false;\n  }\n  return (\n    deferredScripts.length > 0 ||\n    !!window.document.head.querySelector(\"script[data-vivliostyle-scripting]\")\n  );\n}\n", "/**\n * Copyright 2015 Daishinsha Inc.\n * Copyright 2019 Vivliostyle Foundation\n *\n * Vivliostyle.js is free software: you can redistribute it and/or modify\n * it under the terms of the GNU Affero General Public License as published by\n * the Free Software Foundation, either version 3 of the License, or\n * (at your option) any later version.\n *\n * Vivliostyle.js is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n * GNU Affero General Public License for more details.\n *\n * You should have received a copy of the GNU Affero General Public License\n * along with Vivliostyle.js.  If not, see <http://www.gnu.org/licenses/>.\n *\n * @fileoverview Urls - URL Utilities\n */\n\n/**\n * transform all urls in attributeValue using documentURLTransformer.\n *\n * @returns transformed attributeValue\n */\n\nexport const transformURIs = (\n  attributeValue,\n  baseUrl,\n  documentURLTransformer,\n) =>\n  attributeValue\n    .replace(\n      /[uU][rR][lL]\\(\\s*\"((\\\\([^0-9a-fA-F]+|[0-9a-fA-F]+\\s*)|[^\"\\r\\n])+)\"/gm,\n      (match, m1) =>\n        `url(\"${documentURLTransformer.transformURL(m1, baseUrl)}\"`,\n    )\n    .replace(\n      /[uU][rR][lL]\\(\\s*'((\\\\([^0-9a-fA-F]+|[0-9a-fA-F]+\\s*)|[^'\\r\\n])+)'/gm,\n      (match, m1) =>\n        `url('${documentURLTransformer.transformURL(m1, baseUrl)}'`,\n    )\n    .replace(\n      /[uU][rR][lL]\\(\\s*((\\\\([^0-9a-fA-F]+|[0-9a-fA-F]+\\s*)|[^\"'\\r\\n\\)\\s])+)/gm,\n      (match, m1) => `url(${documentURLTransformer.transformURL(m1, baseUrl)}`,\n    );\n", "/**\n * Copyright 2013 Google, Inc.\n * Copyright 2015 Daishinsha Inc.\n * Copyright 2019 Vivliostyle Foundation\n *\n * Vivliostyle.js is free software: you can redistribute it and/or modify\n * it under the terms of the GNU Affero General Public License as published by\n * the Free Software Foundation, either version 3 of the License, or\n * (at your option) any later version.\n *\n * Vivliostyle.js is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n * GNU Affero General Public License for more details.\n *\n * You should have received a copy of the GNU Affero General Public License\n * along with Vivliostyle.js.  If not, see <http://www.gnu.org/licenses/>.\n *\n * @fileoverview Vgen - View tree generator.\n */\nimport * as Asserts from \"./asserts\";\nimport * as Base from \"./base\";\nimport * as Break from \"./break\";\nimport * as Css from \"./css\";\nimport * as CssCascade from \"./css-cascade\";\nimport * as CssProp from \"./css-prop\";\nimport * as CssStyler from \"./css-styler\";\nimport * as Diff from \"./diff\";\nimport * as Display from \"./display\";\nimport * as Exprs from \"./exprs\";\nimport * as Font from \"./font\";\nimport * as LayoutHelper from \"./layout-helper\";\nimport * as Logging from \"./logging\";\nimport * as Matchers from \"./matchers\";\nimport * as Net from \"./net\";\nimport * as PageFloats from \"./page-floats\";\nimport * as Plugin from \"./plugin\";\nimport * as PseudoElement from \"./pseudo-element\";\nimport * as RepetitiveElement from \"./repetitive-element\";\nimport * as Scripts from \"./scripts\";\nimport * as Task from \"./task\";\nimport * as TaskUtil from \"./task-util\";\nimport * as Urls from \"./urls\";\nimport * as Vtree from \"./vtree\";\nimport * as Layout from \"./layout\";\nimport { XmlDoc } from \"./types\";\n\nconst namespacePrefixMap: { [key: string]: string } = {};\n\nexport type CustomRenderer = (\n  p1: Element,\n  p2: Element,\n  p3: { [key: string]: Css.Val },\n) => Task.Result<Element>;\n\nexport interface CustomRendererFactory {\n  makeCustomRenderer(xmldoc: XmlDoc.XMLDocHolder): CustomRenderer;\n}\n\n/**\n * Creates an epubReadingSystem object in the iframe.contentWindow.navigator\n * when load event fires.\n */\nexport function initIFrame(iframe: HTMLIFrameElement): void {\n  iframe.addEventListener(\n    \"load\",\n    () => {\n      iframe.contentWindow.navigator[\"epubReadingSystem\"] = {\n        name: \"adapt\",\n        version: \"0.1\",\n        layoutStyle: \"paginated\",\n        hasFeature: function (name, version) {\n          switch (name) {\n            case \"mouse-events\":\n              return true;\n          }\n          return false;\n        },\n      };\n    },\n    false,\n  );\n}\n\nexport interface StylerProducer {\n  getStylerForDoc(xmldoc: XmlDoc.XMLDocHolder): CssStyler.AbstractStyler;\n}\n\nexport class ViewFactory\n  extends Base.SimpleEventTarget\n  implements Vtree.LayoutContext\n{\n  private static SVG_URL_ATTRIBUTES: string[] = [\n    \"color-profile\",\n    \"clip-path\",\n    \"cursor\",\n    \"filter\",\n    \"marker\",\n    \"marker-start\",\n    \"marker-end\",\n    \"marker-mid\",\n    \"fill\",\n    \"stroke\",\n    \"mask\",\n  ];\n  document: Document;\n  exprContentListener: Vtree.ExprContentListener;\n\n  // provided by layout\n  nodeContext: Vtree.NodeContext | null = null;\n  viewRoot: Element | null = null;\n  isFootnote: boolean = false;\n  sourceNode: Node | null = null;\n  offsetInNode: number = 0;\n\n  // computed\n  // TODO: only set it on NodeContext\n  viewNode: Node | null = null;\n\n  constructor(\n    public readonly flowName: string,\n    public readonly context: Exprs.Context,\n    public readonly viewport: Viewport,\n    public readonly styler: CssStyler.Styler,\n    public readonly regionIds: string[],\n    public readonly xmldoc: XmlDoc.XMLDocHolder,\n    public readonly docFaces: Font.DocumentFaces,\n    public readonly footnoteStyle: CssCascade.ElementStyle,\n    public readonly stylerProducer: StylerProducer,\n    public readonly page: Vtree.Page,\n    public readonly customRenderer: CustomRenderer,\n    public readonly fallbackMap: { [key: string]: string },\n    public readonly documentURLTransformer: Base.DocumentURLTransformer,\n  ) {\n    super();\n    this.document = viewport.document;\n    this.exprContentListener = styler.counterListener.getExprContentListener();\n  }\n\n  /** @override */\n  clone(): Vtree.LayoutContext {\n    return new ViewFactory(\n      this.flowName,\n      this.context,\n      this.viewport,\n      this.styler,\n      this.regionIds,\n      this.xmldoc,\n      this.docFaces,\n      this.footnoteStyle,\n      this.stylerProducer,\n      this.page,\n      this.customRenderer,\n      this.fallbackMap,\n      this.documentURLTransformer,\n    );\n  }\n\n  createPseudoelementShadow(\n    element: Element,\n    isRoot: boolean,\n    cascStyle: CssCascade.ElementStyle,\n    computedStyle: { [key: string]: Css.Val },\n    styler: CssStyler.AbstractStyler,\n    context: Exprs.Context,\n    parentShadow: Vtree.ShadowContext,\n    subShadow: Vtree.ShadowContext,\n  ): Vtree.ShadowContext {\n    const pseudoMap = this.getPseudoMap(\n      cascStyle,\n      this.regionIds,\n      this.isFootnote,\n      this.nodeContext,\n      context,\n    );\n    if (!pseudoMap) {\n      return subShadow;\n    }\n    const addedNames: string[] = [];\n    const root = PseudoElement.document.createElementNS(Base.NS.SHADOW, \"root\");\n    let att = root;\n    for (const name of PseudoElement.pseudoNames) {\n      let elem: Element;\n      if (name) {\n        if (!pseudoMap[name]) {\n          continue;\n        }\n        if (name == \"footnote-marker\" && !(isRoot && this.isFootnote)) {\n          continue;\n        }\n        if (name.match(/^first-/)) {\n          const display = computedStyle[\"display\"];\n          if (!display || display === Css.ident.inline) {\n            continue;\n          }\n          const child = element.firstElementChild;\n          if (child && Vtree.canIgnore(child.previousSibling)) {\n            const childStyle = styler.getStyle(child, false);\n            if (childStyle) {\n              const childDisplay = CssCascade.getProp(childStyle, \"display\");\n              if (\n                childDisplay?.value &&\n                childDisplay.value !== Css.ident.inline\n              ) {\n                continue;\n              }\n            }\n          }\n        }\n        if (name === \"before\" || name === \"after\" || name === \"marker\") {\n          const content = pseudoMap[name][\"content\"] as CssCascade.CascadeValue;\n          if (!content || !Vtree.nonTrivialContent(content.value)) {\n            continue;\n          }\n          if (\n            name === \"marker\" &&\n            (!Display.isListItem(computedStyle[\"display\"]) ||\n              // Disable ::marker for \"toc-node\" in the TOC box\n              CssCascade.getProp(cascStyle, \"behavior\")?.value ===\n                Css.getName(\"toc-node\"))\n          ) {\n            continue;\n          }\n        }\n        addedNames.push(name);\n        elem = PseudoElement.document.createElementNS(Base.NS.XHTML, \"span\");\n        PseudoElement.setPseudoName(elem, name);\n      } else {\n        elem = PseudoElement.document.createElementNS(\n          Base.NS.SHADOW,\n          \"content\",\n        );\n      }\n      att.appendChild(elem);\n      if (name.match(/^first-/)) {\n        att = elem;\n      }\n    }\n    if (!addedNames.length) {\n      return subShadow;\n    }\n    const shadowStyler = new PseudoElement.PseudoelementStyler(\n      element,\n      cascStyle,\n      styler,\n      context,\n      this.exprContentListener,\n    );\n    return new Vtree.ShadowContext(\n      element,\n      root,\n      null,\n      parentShadow,\n      subShadow,\n      Vtree.ShadowType.ROOTLESS,\n      shadowStyler,\n    );\n  }\n\n  getPseudoMap(\n    cascStyle: CssCascade.ElementStyle,\n    regionIds: string[],\n    isFootnote: boolean,\n    nodeContext: Vtree.NodeContext,\n    context: Exprs.Context,\n  ): CssCascade.ElementStyleMap {\n    const pseudoMap = CssCascade.getStyleMap(cascStyle, \"_pseudos\");\n    if (!pseudoMap) {\n      return null;\n    }\n    const computedPseudoStyleMap: CssCascade.ElementStyleMap = {};\n    for (const key in pseudoMap) {\n      const computedPseudoStyle: { [key: string]: CssCascade.CascadeValue } =\n        (computedPseudoStyleMap[key] = {});\n      CssCascade.mergeStyle(computedPseudoStyle, pseudoMap[key], context);\n      CssCascade.mergeViewConditionalStyles(\n        computedPseudoStyle,\n        context,\n        pseudoMap[key],\n      );\n      CssCascade.forEachStylesInRegion(\n        pseudoMap[key],\n        regionIds,\n        isFootnote,\n        (regionId, regionStyle) => {\n          CssCascade.mergeStyle(computedPseudoStyle, regionStyle, context);\n          CssCascade.forEachViewConditionalStyles(\n            regionStyle,\n            (viewConditionalStyles) => {\n              CssCascade.mergeStyle(\n                computedPseudoStyle,\n                viewConditionalStyles,\n                context,\n              );\n            },\n          );\n        },\n      );\n    }\n    return computedPseudoStyleMap;\n  }\n\n  createRefShadow(\n    href: string,\n    type: Vtree.ShadowType,\n    element: Element,\n    parentShadow: Vtree.ShadowContext,\n    subShadow: Vtree.ShadowContext,\n  ): Task.Result<Vtree.ShadowContext> {\n    const frame: Task.Frame<Vtree.ShadowContext> =\n      Task.newFrame(\"createRefShadow\");\n    this.xmldoc.store.load(href).then((refDocParam) => {\n      const refDoc = refDocParam;\n      if (refDoc) {\n        const refElement = refDoc.getElement(href);\n        if (refElement) {\n          const refStyler = this.stylerProducer.getStylerForDoc(refDoc);\n          subShadow = new Vtree.ShadowContext(\n            element,\n            refElement,\n            refDoc,\n            parentShadow,\n            subShadow,\n            type,\n            refStyler,\n          );\n        }\n      }\n      frame.finish(subShadow);\n    });\n    return frame.result();\n  }\n\n  createShadows(\n    element: Element,\n    isRoot,\n    cascStyle: CssCascade.ElementStyle,\n    computedStyle: { [key: string]: Css.Val },\n    styler: CssStyler.AbstractStyler,\n    context: Exprs.Context,\n    shadowContext: Vtree.ShadowContext,\n  ): Task.Result<Vtree.ShadowContext> {\n    const frame: Task.Frame<Vtree.ShadowContext> =\n      Task.newFrame(\"createShadows\");\n    const shadow: Vtree.ShadowContext = null;\n    const templateURLVal = computedStyle[\"template\"];\n    let cont: Task.Result<Vtree.ShadowContext>;\n    if (\n      templateURLVal instanceof Css.URL ||\n      templateURLVal === Css.ident.footnote\n    ) {\n      const url =\n        templateURLVal instanceof Css.URL\n          ? templateURLVal.url\n          : Base.resolveURL(\"user-agent.xml#footnote\", Base.resourceBaseURL);\n      cont = this.createRefShadow(\n        url,\n        Vtree.ShadowType.ROOTLESS,\n        element,\n        shadowContext,\n        shadow,\n      );\n    } else {\n      cont = Task.newResult(shadow);\n    }\n    cont.then((shadow) => {\n      let cont1: Task.Result<Vtree.ShadowContext> = null;\n      if (element.namespaceURI == Base.NS.SHADOW) {\n        if (element.localName == \"include\") {\n          let href = element.getAttribute(\"href\");\n          let xmldoc: XmlDoc.XMLDocHolder = null;\n          if (href) {\n            xmldoc = shadowContext ? shadowContext.xmldoc : this.xmldoc;\n          } else if (shadowContext) {\n            if (shadowContext.owner.namespaceURI == Base.NS.XHTML) {\n              href = shadowContext.owner.getAttribute(\"href\");\n            } else {\n              href = shadowContext.owner.getAttributeNS(Base.NS.XLINK, \"href\");\n            }\n            xmldoc = shadowContext.parentShadow\n              ? shadowContext.parentShadow.xmldoc\n              : this.xmldoc;\n          }\n          if (href) {\n            href = Base.resolveURL(href, xmldoc.url);\n            cont1 = this.createRefShadow(\n              href,\n              Vtree.ShadowType.ROOTED,\n              element,\n              shadowContext,\n              shadow,\n            );\n          }\n        }\n      }\n      if (cont1 == null) {\n        cont1 = Task.newResult(shadow);\n      }\n      let cont2: Task.Result<Vtree.ShadowContext> = null;\n      cont1.then((shadow) => {\n        if (computedStyle[\"display\"] === Css.ident.table_cell) {\n          const url = Base.resolveURL(\n            \"user-agent.xml#table-cell\",\n            Base.resourceBaseURL,\n          );\n          cont2 = this.createRefShadow(\n            url,\n            Vtree.ShadowType.ROOTLESS,\n            element,\n            shadowContext,\n            shadow,\n          );\n        } else {\n          cont2 = Task.newResult(shadow);\n        }\n        cont2.then((shadow) => {\n          shadow = this.createPseudoelementShadow(\n            element,\n            isRoot,\n            cascStyle,\n            computedStyle,\n            styler,\n            context,\n            shadowContext,\n            shadow,\n          );\n          frame.finish(shadow);\n        });\n      });\n    });\n    return frame.result();\n  }\n\n  /** @override */\n  setViewRoot(viewRoot: Element, isFootnote: boolean) {\n    this.viewRoot = viewRoot;\n    this.isFootnote = isFootnote;\n  }\n\n  /**\n   * @return vertical\n   */\n  computeStyle(\n    vertical: boolean,\n    rtl: boolean,\n    style: CssCascade.ElementStyle,\n    computedStyle: { [key: string]: Css.Val },\n  ): boolean {\n    const context = this.context;\n    const cascMap = CssCascade.flattenCascadedStyle(\n      style,\n      context,\n      this.regionIds,\n      this.isFootnote,\n      this.nodeContext,\n    );\n    const isRoot = !this.nodeContext?.parent;\n    if (isRoot) {\n      // Ensure that writing-mode and direction are set on the root element.\n      if (!cascMap[\"writing-mode\"] && this.styler.rootStyle[\"writing-mode\"]) {\n        cascMap[\"writing-mode\"] = this.styler.rootStyle[\n          \"writing-mode\"\n        ] as CssCascade.CascadeValue;\n      }\n      if (!cascMap[\"direction\"] && this.styler.rootStyle[\"direction\"]) {\n        cascMap[\"direction\"] = this.styler.rootStyle[\n          \"direction\"\n        ] as CssCascade.CascadeValue;\n      }\n    }\n    const verticalParent = vertical;\n    vertical = CssCascade.isVertical(cascMap, context, vertical);\n    const verticalChanged = !isRoot && vertical !== verticalParent;\n    rtl = CssCascade.isRtl(cascMap, context, rtl);\n\n    const transform = (\n      name: string,\n      cascVal: CssCascade.CascadeValue,\n    ): Css.Val => {\n      // The percent value of inline-size on vertical-in-horizontal or\n      // horizontal-in-vertical block needs to be resolved against the\n      // page area height or width. (Fix for issue #1264)\n      let percentRef: number;\n      if (verticalChanged) {\n        if (vertical) {\n          if (/^(min-|max-)?(height|inline-size)$/.test(name)) {\n            percentRef = context.pageAreaHeight;\n          }\n        } else {\n          if (/^(min-|max-)?(width|inline-size)$/.test(name)) {\n            percentRef = context.pageAreaWidth;\n          }\n        }\n      }\n      let value = cascVal.evaluate(context, name, percentRef, vertical);\n      if (name == \"font-family\") {\n        value = this.docFaces.filterFontFamily(value);\n      }\n      return value;\n    };\n\n    const isLeftPage = !!new Exprs.Named(\n      (context as any).style.pageScope,\n      \"left-page\",\n    ).evaluate(context);\n\n    CssCascade.convertToPhysical(\n      cascMap,\n      computedStyle,\n      vertical,\n      rtl,\n      isLeftPage,\n      transform,\n    );\n\n    if (verticalChanged) {\n      // The auto value of inline-size on vertical-in-horizontal or\n      // horizontal-in-vertical block is changed to max-content.\n      // (Fix for issue #1264)\n      const inlineSize = computedStyle[vertical ? \"height\" : \"width\"];\n      if (!inlineSize || inlineSize === Css.ident.auto) {\n        computedStyle[vertical ? \"height\" : \"width\"] = Css.ident.max_content;\n      }\n    }\n\n    if (Display.isRunning(computedStyle[\"position\"])) {\n      // Running elements\n      computedStyle[\"position\"] = Css.ident.fixed;\n      computedStyle[\"visibility\"] = Css.ident.hidden;\n      return vertical;\n    }\n\n    // Compute values of display, position and float\n    const position = computedStyle[\"position\"] as Css.Ident;\n    const float = computedStyle[\"float\"];\n    const display =\n      (computedStyle[\"display\"] as Css.Ident) ||\n      ((this.sourceNode as Element).namespaceURI === Base.NS.XHTML\n        ? Css.ident.inline\n        : undefined); // leave it to the browser for MathML and SVG\n    const displayValues = Display.getComputedDisplayValue(\n      display,\n      position,\n      float,\n      this.sourceNode === this.xmldoc.root,\n    );\n    [\"display\", \"position\", \"float\"].forEach((name) => {\n      if (displayValues[name]) {\n        computedStyle[name] = displayValues[name];\n      }\n    });\n    return vertical;\n  }\n\n  private inheritFromSourceParent(elementStyle: CssCascade.ElementStyle): {\n    lang: string | null;\n    elementStyle: CssCascade.ElementStyle;\n  } {\n    let node = this.nodeContext.sourceNode;\n    const styles = [];\n    let lang: string | null = null;\n\n    // TODO: this is hacky. We need to recover the path through the shadow\n    // trees, but we do not have the full shadow tree structure at this point.\n    // This code handles coming out of the shadow trees, but does not go back in\n    // (through shadow:content element).\n    let shadowContext = this.nodeContext.shadowContext;\n    let steps = -1;\n    while (node && node.nodeType == 1) {\n      const shadowRoot = shadowContext && shadowContext.root == node;\n      if (!shadowRoot || shadowContext.type == Vtree.ShadowType.ROOTLESS) {\n        const styler = shadowContext\n          ? (shadowContext.styler as CssStyler.AbstractStyler)\n          : this.styler;\n        const nodeStyle = styler.getStyle(node as Element, false);\n        styles.push(nodeStyle);\n        lang = lang || Base.getLangAttribute(node as Element);\n      }\n      if (shadowRoot) {\n        node = shadowContext.owner;\n        shadowContext = shadowContext.parentShadow;\n      } else {\n        node = node.parentNode;\n        steps++;\n      }\n    }\n    const isRoot = steps === 0;\n    const fontSize = this.context.queryUnitSize(\"em\", isRoot);\n    const props = {\n      \"font-size\": new CssCascade.CascadeValue(\n        new Css.Numeric(fontSize, \"px\"),\n        0,\n      ),\n    } as CssCascade.ElementStyle;\n    if (isRoot) {\n      props[\"line-height\"] = new CssCascade.CascadeValue(\n        new Css.Num(this.context.pref.lineHeight),\n        0,\n      );\n    }\n    const inheritanceVisitor = new CssCascade.InheritanceVisitor(\n      props,\n      this.context,\n    );\n    for (let i = styles.length - 1; i >= 0; --i) {\n      const style = styles[i];\n      const propList = [];\n      for (const propName in style) {\n        if (CssCascade.isInherited(propName)) {\n          propList.push(propName);\n        }\n      }\n      propList.sort(Css.processingOrderFn);\n      let fontSize: Css.Val;\n      let lineHeight: Css.Val;\n\n      for (const name of propList) {\n        inheritanceVisitor.setPropName(name);\n        const prop = CssCascade.getProp(style, name);\n        let prop1 = prop;\n        if (!Css.isDefaultingValue(prop.value)) {\n          if (\n            name === \"font-size\" &&\n            i === styles.length - 1 &&\n            this.context.isRelativeRootFontSize &&\n            this.context.rootFontSize\n          ) {\n            // Fix for issue #608, #549\n            prop1 = new CssCascade.CascadeValue(\n              new Css.Numeric(this.context.rootFontSize, \"px\"),\n              prop.priority,\n            );\n          } else if (\n            name === \"line-height\" &&\n            i === styles.length - 1 &&\n            this.context.rootLineHeight &&\n            prop.value instanceof Css.Numeric &&\n            (prop.value.unit === \"lh\" || prop.value.unit === \"rlh\")\n          ) {\n            // line-height with lh or rlh unit on root element\n            prop1 = new CssCascade.CascadeValue(\n              new Css.Numeric(this.context.rootLineHeight, \"px\"),\n              prop.priority,\n            );\n          } else if (\n            i === 0 &&\n            prop.value instanceof Css.Numeric &&\n            prop.value.unit === \"lh\"\n          ) {\n            // line-height with lh unit on current element\n            const lhUnitSize = this.getLineHeightUnitSize(\n              name,\n              fontSize,\n              lineHeight,\n            );\n            if (lhUnitSize != null) {\n              prop1 = new CssCascade.CascadeValue(\n                new Css.Numeric(prop.value.num * lhUnitSize, \"px\"),\n                prop.priority,\n              );\n            }\n          } else if (!Css.isCustomPropName(name)) {\n            prop1 = prop.filterValue(inheritanceVisitor);\n          }\n\n          if (name === \"font-size\") {\n            fontSize = prop1.value;\n          } else if (name === \"line-height\") {\n            lineHeight = prop1.value;\n          }\n\n          props[name] = prop1;\n        }\n      }\n    }\n    for (const sname in elementStyle) {\n      if (!CssCascade.isInherited(sname)) {\n        props[sname] = elementStyle[sname];\n      }\n    }\n    return { lang, elementStyle: props };\n  }\n\n  resolveURL(url: string): string {\n    url = Base.resolveURL(url, this.xmldoc.url);\n    return this.fallbackMap[url] || url;\n  }\n\n  inheritLangAttribute() {\n    this.nodeContext.lang =\n      Base.getLangAttribute(this.nodeContext.sourceNode as Element) ||\n      (this.nodeContext.parent && this.nodeContext.parent.lang) ||\n      this.nodeContext.lang;\n  }\n\n  transferPolyfilledInheritedProps(computedStyle: { [key: string]: Css.Val }) {\n    const polyfilledInheritedProps =\n      CssCascade.getPolyfilledInheritedProps().filter(\n        (name) => computedStyle[name],\n      );\n    if (polyfilledInheritedProps.length) {\n      let props = this.nodeContext.inheritedProps;\n      if (this.nodeContext.parent) {\n        props = this.nodeContext.inheritedProps = {};\n        for (const n in this.nodeContext.parent.inheritedProps) {\n          props[n] = this.nodeContext.parent.inheritedProps[n];\n        }\n      }\n      polyfilledInheritedProps.forEach((name) => {\n        const value = computedStyle[name];\n        if (value) {\n          if (Css.isDefaultingValue(value)) {\n            if (value === Css.ident.initial) {\n              props[name] = undefined;\n            }\n          } else if (value instanceof Css.Int) {\n            props[name] = (value as Css.Int).num;\n          } else if (value instanceof Css.Ident) {\n            props[name] = (value as Css.Ident).name;\n          } else if (value instanceof Css.Numeric) {\n            const numericVal = value as Css.Numeric;\n            switch (numericVal.unit) {\n              case \"dpi\":\n              case \"dpcm\":\n              case \"dppx\":\n                props[name] =\n                  numericVal.num * Exprs.defaultUnitSizes[numericVal.unit];\n                break;\n              default:\n                props[name] = value;\n            }\n          } else {\n            props[name] = value;\n          }\n          if (![\"widows\", \"orphans\"].includes(name)) {\n            // Note: widows and orphans are polyfilled for page and\n            // root multi-column, but they should be left to the browser\n            // for multi-column boxes inside body. (Issue #1182)\n            delete computedStyle[name];\n          }\n        }\n      });\n    }\n  }\n\n  resolveFormattingContext(\n    nodeContext: Vtree.NodeContext,\n    firstTime: boolean,\n    display: Css.Val,\n    position: Css.Ident,\n    float: Css.Val,\n    isRoot: boolean,\n  ) {\n    const hooks: Plugin.ResolveFormattingContextHook[] = Plugin.getHooksForName(\n      Plugin.HOOKS.RESOLVE_FORMATTING_CONTEXT,\n    );\n    for (let i = 0; i < hooks.length; i++) {\n      const formattingContext = hooks[i](\n        nodeContext,\n        firstTime,\n        display,\n        position,\n        float,\n        isRoot,\n      );\n      if (formattingContext) {\n        nodeContext.formattingContext = formattingContext;\n        return;\n      }\n    }\n  }\n\n  /**\n   * @return holding true if children should be processed\n   */\n  private createElementView(\n    firstTime: boolean,\n    atUnforcedBreak: boolean,\n  ): Task.Result<boolean> {\n    let needToProcessChildren = true;\n    const frame: Task.Frame<boolean> = Task.newFrame(\"createElementView\");\n\n    // Figure out element's styles\n    let element = this.sourceNode as Element;\n    const styler = this.nodeContext.shadowContext\n      ? this.nodeContext.shadowContext.styler\n      : this.styler;\n    let elementStyle = styler.getStyle(element, false);\n    if (!this.nodeContext.shadowContext) {\n      const offset = this.xmldoc.getElementOffset(element);\n      Matchers.NthFragmentMatcher.registerFragmentIndex(\n        offset,\n        this.nodeContext.fragmentIndex,\n        0,\n      );\n    }\n    const computedStyle: { [key: string]: Css.Val } = {};\n    if (!this.nodeContext.parent) {\n      const inheritedValues = this.inheritFromSourceParent(elementStyle);\n      elementStyle = inheritedValues.elementStyle;\n      this.nodeContext.lang = inheritedValues.lang;\n    }\n    const positionCV: CssCascade.CascadeValue = elementStyle[\"position\"];\n    const floatCV: CssCascade.CascadeValue = elementStyle[\"float\"];\n    const floatReferenceCV: CssCascade.CascadeValue =\n      elementStyle[\"float-reference\"];\n    const floatReference =\n      floatCV &&\n      !Css.isDefaultingValue(floatCV.value) &&\n      floatCV.value !== Css.ident.none &&\n      floatReferenceCV &&\n      !Css.isDefaultingValue(floatReferenceCV.value)\n        ? PageFloats.floatReferenceOf(floatReferenceCV.value.toString())\n        : null;\n    if (\n      this.nodeContext.parent &&\n      (Display.isRunning(positionCV?.value) ||\n        (floatReference && PageFloats.isPageFloat(floatReference)))\n    ) {\n      // Since a page float will be detached from a view node of its parent,\n      // inherited properties need to be inherited from its source parent.\n      const inheritedValues = this.inheritFromSourceParent(elementStyle);\n      elementStyle = inheritedValues.elementStyle;\n      this.nodeContext.lang = inheritedValues.lang;\n    }\n    this.nodeContext.vertical = this.computeStyle(\n      this.nodeContext.vertical,\n      this.nodeContext.direction === \"rtl\",\n      elementStyle,\n      computedStyle,\n    );\n    if (\n      floatReference &&\n      PageFloats.isPageFloat(floatReference) &&\n      computedStyle[\"display\"] === Css.ident.block\n    ) {\n      // Fix page float margin collapsing issue (Issue #1282)\n      computedStyle[\"display\"] = Css.ident.flow_root;\n    }\n    styler.processContent(element, computedStyle, this.nodeContext);\n    this.transferPolyfilledInheritedProps(computedStyle);\n    this.inheritLangAttribute();\n    if (computedStyle[\"direction\"]) {\n      this.nodeContext.direction = computedStyle[\"direction\"].toString();\n    }\n\n    // Sort out the properties\n    const flow = computedStyle[\"flow-into\"];\n    if (flow && flow.toString() != this.flowName) {\n      // foreign flow, don't create a view\n      frame.finish(false);\n      return frame.result();\n    }\n    if (\n      Scripts.allowScripts &&\n      element.localName === \"script\" &&\n      element.namespaceURI === Base.NS.XHTML\n    ) {\n      Scripts.loadScript(\n        element as HTMLScriptElement,\n        this.viewport.window,\n      ).thenFinish(frame);\n      return frame.result();\n    }\n\n    let display = computedStyle[\"display\"];\n\n    if (Css.isDefaultingValue(display)) {\n      if (display === Css.ident.initial || display === Css.ident.unset) {\n        display = Css.ident.inline;\n      } else if (display === Css.ident.inherit) {\n        display =\n          this.nodeContext.parent?.display &&\n          Css.getName(this.nodeContext.parent?.display);\n      } else {\n        display = null;\n      }\n    }\n    if (display === Css.ident.none) {\n      // no content\n      frame.finish(false);\n      return frame.result();\n    }\n    const isRoot = this.nodeContext.parent == null;\n    this.nodeContext.flexContainer = display === Css.ident.flex;\n    this.createShadows(\n      element,\n      isRoot,\n      elementStyle,\n      computedStyle,\n      styler,\n      this.context,\n      this.nodeContext.shadowContext as Vtree.ShadowContext,\n    ).then((shadowParam) => {\n      this.nodeContext.nodeShadow = shadowParam;\n      const position = computedStyle[\"position\"] as Css.Ident;\n      let floatSide = computedStyle[\"float\"];\n      let clearSide = computedStyle[\"clear\"] as Css.Ident;\n      const writingMode = this.nodeContext.vertical\n        ? Css.ident.vertical_rl\n        : Css.ident.horizontal_tb;\n      const parentWritingMode = this.nodeContext.parent\n        ? this.nodeContext.parent.vertical\n          ? Css.ident.vertical_rl\n          : Css.ident.horizontal_tb\n        : writingMode;\n      const isFlowRoot = Display.isFlowRoot(element);\n      const columnCount = computedStyle[\"column-count\"];\n      const columnWidth = computedStyle[\"column-width\"];\n      const isMultiColumn =\n        (columnCount &&\n          columnCount !== Css.ident.auto &&\n          !Css.isDefaultingValue(columnCount)) ||\n        (columnWidth &&\n          columnWidth !== Css.ident.auto &&\n          !Css.isDefaultingValue(columnWidth));\n      this.nodeContext.establishesBFC = Display.establishesBFC(\n        display,\n        position,\n        floatSide,\n        computedStyle[\"overflow\"] as Css.Ident,\n        writingMode,\n        parentWritingMode,\n        isMultiColumn || isFlowRoot,\n      );\n      this.nodeContext.containingBlockForAbsolute =\n        Display.establishesCBForAbsolute(position);\n      if (\n        this.nodeContext.isInsideBFC() &&\n        floatSide !== Css.ident.footnote &&\n        !(floatReference && PageFloats.isPageFloat(floatReference))\n      ) {\n        // When the element is already inside a block formatting context\n        // (except one from the root), float and clear can be controlled by\n        // the browser and we don't need to care.\n        floatSide = null;\n        clearSide = null;\n      }\n      let floating =\n        floatSide instanceof Css.SpaceList ||\n        floatSide === Css.ident.left ||\n        floatSide === Css.ident.right ||\n        floatSide === Css.ident.top ||\n        floatSide === Css.ident.bottom ||\n        floatSide === Css.ident.inline_start ||\n        floatSide === Css.ident.inline_end ||\n        floatSide === Css.ident.block_start ||\n        floatSide === Css.ident.block_end ||\n        floatSide === Css.ident.snap_block ||\n        floatSide === Css.ident.snap_inline ||\n        floatSide === Css.ident.inside ||\n        floatSide === Css.ident.outside ||\n        floatSide === Css.ident.footnote;\n      if (floatSide) {\n        // Don't want to set it in view DOM CSS.\n        delete computedStyle[\"float\"];\n        if (floatSide === Css.ident.footnote) {\n          if (this.isFootnote) {\n            // No footnotes inside footnotes. this is most likely the root\n            // of the footnote body being rendered in footnote area. Treat\n            // as block.\n            floating = false;\n            computedStyle[\"display\"] = Css.ident.block;\n          } else {\n            computedStyle[\"display\"] = Css.ident.inline;\n          }\n        }\n      }\n      if (clearSide) {\n        if (clearSide === Css.ident.inherit) {\n          if (this.nodeContext.parent && this.nodeContext.parent.clearSide) {\n            clearSide = Css.getName(this.nodeContext.parent.clearSide);\n          }\n        }\n        if (\n          clearSide === Css.ident.left ||\n          clearSide === Css.ident.right ||\n          clearSide === Css.ident.top ||\n          clearSide === Css.ident.bottom ||\n          clearSide === Css.ident.inline_start ||\n          clearSide === Css.ident.inline_end ||\n          clearSide === Css.ident.block_start ||\n          clearSide === Css.ident.block_end ||\n          clearSide === Css.ident.inside ||\n          clearSide === Css.ident.outside ||\n          clearSide === Css.ident.both ||\n          clearSide === Css.ident.all ||\n          clearSide === Css.ident.same ||\n          clearSide === Css.ident.column ||\n          clearSide === Css.ident.region ||\n          clearSide === Css.ident.page\n        ) {\n          delete computedStyle[\"clear\"];\n          if (\n            computedStyle[\"display\"] &&\n            computedStyle[\"display\"] != Css.ident.inline\n          ) {\n            this.nodeContext.clearSide = clearSide.toString();\n          }\n        }\n      }\n      const isListItem =\n        Display.isListItem(display) && !!computedStyle[\"ua-list-item-count\"];\n      const breakInside = computedStyle[\"break-inside\"];\n      if (\n        floating ||\n        (breakInside &&\n          !Css.isDefaultingValue(breakInside) &&\n          breakInside !== Css.ident.auto)\n      ) {\n        this.nodeContext.breakPenalty++;\n      }\n      if (\n        display &&\n        display !== Css.ident.inline &&\n        Display.isInlineLevel(display)\n      ) {\n        // Don't break inside ruby, inline-block, etc.\n        this.nodeContext.breakPenalty++;\n      }\n      this.nodeContext.inline =\n        (!floating && !display) ||\n        Display.isInlineLevel(display) ||\n        Display.isRubyInternalDisplay(display);\n      this.nodeContext.display = display ? display.toString() : \"inline\";\n      this.nodeContext.floatSide = floating ? floatSide.toString() : null;\n      this.nodeContext.floatReference =\n        floatReference || PageFloats.FloatReference.INLINE;\n      const floatMinWrapBlock = computedStyle[\"float-min-wrap-block\"];\n      this.nodeContext.floatMinWrapBlock =\n        floatMinWrapBlock && !Css.isDefaultingValue(floatMinWrapBlock)\n          ? (floatMinWrapBlock as Css.Numeric)\n          : null;\n\n      // Leaves handling of multicol specified on non-root/body elements to the browser\n      const insideNonRootMultiColumn = this.isInsideNonRootMultiColumn();\n\n      const columnSpan = computedStyle[\"column-span\"];\n      this.nodeContext.columnSpan =\n        !insideNonRootMultiColumn &&\n        columnSpan &&\n        !Css.isDefaultingValue(columnSpan)\n          ? columnSpan\n          : null;\n      if (!this.nodeContext.inline) {\n        const breakAfter = computedStyle[\"break-after\"];\n        if (\n          breakAfter &&\n          !Css.isDefaultingValue(breakAfter) &&\n          !(insideNonRootMultiColumn && breakAfter === Css.ident.column)\n        ) {\n          this.nodeContext.breakAfter = breakAfter.toString();\n          if (Break.forcedBreakValues[this.nodeContext.breakAfter]) {\n            // delete computedStyle[\"break-after\"];\n\n            // Instead of deleting, set to \"column\" so that the browser can handle it.\n            computedStyle[\"break-after\"] = Css.ident.column;\n          }\n        }\n        const breakBefore = computedStyle[\"break-before\"];\n        if (\n          breakBefore &&\n          !Css.isDefaultingValue(breakBefore) &&\n          !(insideNonRootMultiColumn && breakBefore === Css.ident.column)\n        ) {\n          this.nodeContext.breakBefore = breakBefore.toString();\n          if (Break.forcedBreakValues[this.nodeContext.breakBefore]) {\n            if (this.isAtStartOfPage()) {\n              delete computedStyle[\"break-before\"];\n            } else {\n              // Set to \"column\" so that the browser can handle it.\n              computedStyle[\"break-before\"] = Css.ident.column;\n            }\n          }\n          if (this.nodeContext.fragmentIndex !== 1) {\n            this.nodeContext.breakBefore = null;\n          }\n        }\n        // Named page type\n        const pageVal: Css.Val = computedStyle[\"page\"];\n        let pageType =\n          pageVal && !Css.isDefaultingValue(pageVal) && pageVal.toString();\n        if (\n          !pageType &&\n          !this.nodeContext.parent &&\n          (this.nodeContext.shadowContext ||\n            display === Css.ident.table_header_group ||\n            display === Css.ident.table_footer_group)\n        ) {\n          // Keep currentPageType for shadowContext (Fix for issue #1233)\n          pageType = this.styler.cascade.currentPageType;\n        }\n        if (!pageType || pageType.toLowerCase() === \"auto\") {\n          pageType = this.nodeContext.pageType;\n        } else {\n          this.nodeContext.pageType = pageType;\n        }\n        if (\n          this.styler.cascade.currentPageType !== pageType &&\n          // Fixed positioned or running elements should not affect page type\n          // unless page type is explicitly set\n          !(!pageType && computedStyle[\"position\"] === Css.ident.fixed)\n        ) {\n          if (\n            this.nodeContext.fragmentIndex === 1 &&\n            !Break.isSpreadBreakValue(this.nodeContext.breakBefore)\n          ) {\n            this.nodeContext.breakBefore = \"page\";\n          }\n          // Fix for issue #1309\n          if (pageType !== this.styler.cascade.previousPageType) {\n            this.styler.cascade.previousPageType =\n              this.styler.cascade.currentPageType;\n          }\n          this.styler.cascade.currentPageType = pageType;\n        }\n      }\n      this.nodeContext.verticalAlign =\n        (computedStyle[\"vertical-align\"] &&\n          computedStyle[\"vertical-align\"].toString()) ||\n        \"baseline\";\n      this.nodeContext.captionSide =\n        (computedStyle[\"caption-side\"] &&\n          computedStyle[\"caption-side\"].toString()) ||\n        \"top\";\n      const borderCollapse = computedStyle[\"border-collapse\"];\n      if (!borderCollapse || borderCollapse === Css.getName(\"separate\")) {\n        const borderSpacing = computedStyle[\"border-spacing\"];\n        let inlineBorderSpacing: Css.Val;\n        let blockBorderSpacing: Css.Val;\n        if (borderSpacing) {\n          if (borderSpacing instanceof Css.SpaceList) {\n            inlineBorderSpacing = borderSpacing.values[0];\n            blockBorderSpacing = borderSpacing.values[1];\n          } else {\n            inlineBorderSpacing = blockBorderSpacing = borderSpacing;\n          }\n          if (inlineBorderSpacing.isNumeric()) {\n            this.nodeContext.inlineBorderSpacing = Css.toNumber(\n              inlineBorderSpacing,\n              this.context,\n            );\n          }\n          if (blockBorderSpacing.isNumeric()) {\n            this.nodeContext.blockBorderSpacing = Css.toNumber(\n              blockBorderSpacing,\n              this.context,\n            );\n          }\n        }\n      }\n      const footnotePolicy = computedStyle[\"footnote-policy\"] as Css.Ident;\n      this.nodeContext.footnotePolicy =\n        footnotePolicy && !Css.isDefaultingValue(footnotePolicy)\n          ? footnotePolicy\n          : null;\n      const firstPseudo = computedStyle[\"x-first-pseudo\"] as Css.Int;\n      if (firstPseudo) {\n        const outerPseudo = this.nodeContext.parent\n          ? this.nodeContext.parent.firstPseudo\n          : null;\n        this.nodeContext.firstPseudo = new Vtree.FirstPseudo(\n          outerPseudo,\n          /** Css.Int */\n          firstPseudo.num,\n        );\n      }\n      if (!this.nodeContext.inline) {\n        this.processAfterIfcontinues(\n          element,\n          elementStyle,\n          styler,\n          this.context,\n        );\n      }\n      const whitespace = computedStyle[\"white-space\"];\n      if (whitespace) {\n        const whitespaceValue = Vtree.whitespaceFromPropertyValue(\n          whitespace.toString(),\n        );\n        if (whitespaceValue !== null) {\n          this.nodeContext.whitespace = whitespaceValue;\n        }\n      }\n      const hyphenateCharacter = computedStyle[\"hyphenate-character\"];\n      if (hyphenateCharacter && hyphenateCharacter instanceof Css.Str) {\n        this.nodeContext.hyphenateCharacter = hyphenateCharacter.str;\n      }\n      const wordBreak = computedStyle[\"word-break\"];\n      const lineBreak = computedStyle[\"line-break\"];\n      const overflowWrap = computedStyle[\"overflow-wrap\"];\n      if (\n        wordBreak === Css.ident.break_all ||\n        lineBreak === Css.ident.anywhere ||\n        overflowWrap === Css.ident.break_word ||\n        overflowWrap === Css.ident.anywhere\n      ) {\n        this.nodeContext.breakWord = true;\n      }\n\n      // Resolve formatting context\n      this.resolveFormattingContext(\n        this.nodeContext,\n        firstTime,\n        display,\n        position,\n        floatSide,\n        isRoot,\n      );\n      if (\n        this.nodeContext.parent &&\n        this.nodeContext.parent.formattingContext\n      ) {\n        firstTime = this.nodeContext.parent.formattingContext.isFirstTime(\n          this.nodeContext,\n          firstTime,\n        );\n      }\n      if (!this.nodeContext.inline) {\n        this.nodeContext.repeatOnBreak =\n          this.processRepeatOnBreak(computedStyle);\n        this.findAndProcessRepeatingElements(element, styler);\n      }\n\n      // Create the view element\n      let custom = false;\n      let inner: Element = null;\n      const fetchers = [];\n      let ns = element.namespaceURI;\n      let tag = element.localName;\n      let originalTag = tag;\n      if (ns == Base.NS.XHTML) {\n        if (\n          tag == \"html\" ||\n          tag == \"body\" ||\n          tag == \"script\" ||\n          tag == \"link\" ||\n          tag == \"meta\"\n        ) {\n          tag = \"div\";\n        } else if (tag == \"vide_\") {\n          tag = \"video\";\n        } else if (tag == \"audi_\") {\n          tag = \"audio\";\n        } else if (tag == \"object\") {\n          custom = !!this.customRenderer;\n        }\n        if (\n          element.hasAttribute(PseudoElement.PSEUDO_ATTR) &&\n          element.hasAttribute(\"src\") &&\n          computedStyle[\"content\"] instanceof Css.URL\n        ) {\n          tag = \"img\";\n        }\n      } else if (ns == Base.NS.epub) {\n        tag = \"span\";\n        ns = Base.NS.XHTML;\n      } else if (ns == Base.NS.SHADOW) {\n        ns = Base.NS.XHTML;\n        tag = this.nodeContext.inline ? \"span\" : \"div\";\n      } else {\n        custom = !!this.customRenderer;\n      }\n      if (isListItem) {\n        // We don't use browser's list item rendering, so we change\n        // `display: list-item` to `display: block` and\n        // `display: inline list-item` to `display: inline`.\n        display = Display.isInlineLevel(display)\n          ? Css.ident.inline\n          : Css.ident.block;\n        computedStyle[\"display\"] = display;\n        if (firstTime) {\n          tag = \"li\";\n        } else {\n          tag = \"div\";\n        }\n      } else if (tag == \"body\" || tag == \"li\") {\n        tag = \"div\";\n      } else if (tag == \"q\") {\n        tag = \"span\";\n      } else if (tag == \"a\") {\n        const hp = computedStyle[\"hyperlink-processing\"];\n        if (hp && hp.toString() != \"normal\") {\n          tag = \"span\";\n        }\n      }\n      if (computedStyle[\"behavior\"]) {\n        const behavior = computedStyle[\"behavior\"].toString();\n        if (behavior != \"none\" && this.customRenderer) {\n          custom = true;\n        }\n      }\n      if (\n        (element as HTMLElement).dataset &&\n        element.getAttribute(\"data-math-typeset\") === \"true\"\n      ) {\n        custom = true;\n      }\n      let elemResult: Task.Result<Element>;\n      if (custom) {\n        const parentNode = this.nodeContext.parent\n          ? this.nodeContext.parent.viewNode\n          : null;\n        elemResult = this.customRenderer(\n          element,\n          parentNode as Element,\n          computedStyle,\n        );\n      } else {\n        elemResult = Task.newResult(null);\n      }\n      elemResult.then((result) => {\n        if (result) {\n          if (custom) {\n            needToProcessChildren =\n              result.getAttribute(\"data-adapt-process-children\") == \"true\";\n          }\n        } else if (computedStyle[\"display\"] === Css.ident.none) {\n          // No element should be created if display:none is set.\n          // (Fix issue #924)\n          frame.finish(false);\n          return;\n        } else {\n          result = this.createElement(ns, tag);\n        }\n\n        if (\n          !isRoot &&\n          isMultiColumn &&\n          computedStyle[\"column-fill\"] === Css.ident.auto\n        ) {\n          // To make `column-fill: auto` work on non-root multi-column,\n          // we change it to `balance` here, and after layout, we change it back.\n          result.setAttribute(\"data-vivliostyle-column-fill\", \"auto\");\n          computedStyle[\"column-fill\"] = Css.ident.balance;\n        }\n\n        if (tag != originalTag) {\n          result.setAttribute(\"data-vivliostyle-original-tag\", originalTag);\n          if (originalTag === \"html\" || originalTag === \"body\") {\n            result.role = \"presentation\";\n          }\n        }\n        if (tag == \"a\") {\n          result.addEventListener(\"click\", this.page.hrefHandler, false);\n        }\n        if (inner) {\n          this.applyPseudoelementStyle(this.nodeContext, \"inner\", inner);\n          result.appendChild(inner);\n        }\n        if (\n          result.localName == \"iframe\" &&\n          result.namespaceURI == Base.NS.XHTML\n        ) {\n          initIFrame(result as HTMLIFrameElement);\n        }\n        const imageResolution = this.nodeContext.inheritedProps[\n          \"image-resolution\"\n        ] as number | undefined;\n        const images: {\n          image: HTMLElement;\n          element: HTMLElement;\n          fetcher: TaskUtil.Fetcher<string>;\n        }[] = [];\n        const cssWidth = computedStyle[\"width\"];\n        const cssHeight = computedStyle[\"height\"];\n        const attrWidth = element.getAttribute(\"width\");\n        const attrHeight = element.getAttribute(\"height\");\n        const hasAutoWidth =\n          cssWidth === Css.ident.auto || (!cssWidth && !attrWidth);\n        const hasAutoHeight =\n          cssHeight === Css.ident.auto || (!cssHeight && !attrHeight);\n        const attributes = element.attributes;\n        const attributeCount = attributes.length;\n        let delayedSrc: string | null = null;\n        let delayedAlt: string | null = null;\n\n        // Workaround for issue #1439\n        // `<tr><a id=\"\u2026\"></a><td>\u2026` causes table layout issue, so change to\n        // `<tr><td><a id=\"\u2026\"></a>\u2026`\n        if (\n          display === Css.ident.table_cell &&\n          (this.nodeContext.parent?.viewNode as Element)?.lastElementChild\n            ?.localName === \"a\"\n        ) {\n          result.appendChild(\n            (this.nodeContext.parent.viewNode as Element).lastElementChild,\n          );\n        }\n\n        for (let i = 0; i < attributeCount; i++) {\n          const attribute = attributes[i];\n          const attributeNS = attribute.namespaceURI;\n          let attributeName = attribute.localName;\n          let attributeValue = attribute.nodeValue;\n          if (!attributeNS) {\n            if (!Scripts.allowScripts && attributeName.match(/^on/)) {\n              continue; // don't propagate JavaScript code\n            }\n            if (attributeName == \"style\") {\n              continue; // we do styling ourselves\n            }\n            if (attributeName == \"id\" || attributeName == \"name\") {\n              // Propagate transformed ids and collect them on the page\n              // (only first time).\n              if (firstTime) {\n                const transformedValue =\n                  this.documentURLTransformer.transformFragment(\n                    attributeValue,\n                    this.xmldoc.url,\n                  );\n\n                // Keep original id value so that JavaScript can manipulate it\n                result.setAttribute(attributeName, attributeValue);\n                result.setAttribute(\"data-vivliostyle-id\", transformedValue);\n\n                // Create an anchor element with transformed id, necessary for internal links in output PDF\n                // (issue #877)\n                const anchorElem = result.ownerDocument.createElement(\"a\");\n                anchorElem.setAttribute(attributeName, transformedValue);\n                anchorElem.setAttribute(LayoutHelper.SPECIAL_ATTR, \"1\");\n                anchorElem.style.position = \"absolute\";\n                result.appendChild(anchorElem);\n\n                this.page.registerElementWithId(result, transformedValue);\n                continue;\n              }\n            }\n\n            // TODO: understand the element we are working with.\n            if (\n              attributeName == \"src\" ||\n              attributeName == \"href\" ||\n              attributeName == \"poster\"\n            ) {\n              attributeValue = this.resolveURL(attributeValue);\n              if (attributeName === \"href\") {\n                attributeValue = this.documentURLTransformer.transformURL(\n                  attributeValue,\n                  this.xmldoc.url,\n                );\n              }\n            } else if (attributeName == \"srcset\") {\n              attributeValue = attributeValue\n                .split(\",\")\n                .map((value) => this.resolveURL(value.trim()))\n                .join(\",\");\n            } else if (\n              attributeName === \"data\" &&\n              custom &&\n              tag === \"object\" &&\n              result.hasAttribute(\"data\")\n            ) {\n              // the data attribute is already set in OPFView.makeObjectView()\n              continue;\n            }\n            if (\n              attributeName === \"poster\" &&\n              tag === \"video\" &&\n              ns === Base.NS.XHTML &&\n              hasAutoWidth &&\n              hasAutoHeight\n            ) {\n              const image = new Image();\n              const fetcher = Net.loadElement(image, attributeValue);\n              fetchers.push(fetcher);\n              images.push({\n                image,\n                element: result as HTMLElement,\n                fetcher,\n              });\n            }\n          } else if (attributeNS == \"http://www.w3.org/2000/xmlns/\") {\n            continue; // namespace declaration (in Firefox)\n          } else if (attributeNS == Base.NS.XLINK) {\n            if (attributeName == \"href\") {\n              attributeValue = this.documentURLTransformer.transformURL(\n                this.resolveURL(attributeValue),\n                this.xmldoc.url,\n              );\n            }\n          }\n          if (ns == Base.NS.SVG && /^[A-Z\\-]+$/.test(attributeName)) {\n            // Workaround for Edge bug\n            // See\n            // https://developer.microsoft.com/en-us/microsoft-edge/platform/issues/5579311/\n            attributeName = attributeName.toLowerCase();\n          }\n          if (this.isSVGUrlAttribute(attributeName)) {\n            attributeValue = Urls.transformURIs(\n              attributeValue,\n              this.xmldoc.url,\n              this.documentURLTransformer,\n            );\n          }\n          if (attributeNS) {\n            const attributePrefix = namespacePrefixMap[attributeNS];\n            if (attributePrefix) {\n              attributeName = `${attributePrefix}:${attributeName}`;\n            }\n          }\n          if (\n            attributeName == \"src\" &&\n            !attributeNS &&\n            (tag == \"img\" || tag == \"input\") &&\n            ns == Base.NS.XHTML\n          ) {\n            // HTML img element should start loading only once all\n            // attributes are assigned.\n            delayedSrc = attributeValue;\n          } else if (\n            attributeName == \"alt\" &&\n            !attributeNS &&\n            tag == \"img\" &&\n            ns == Base.NS.XHTML\n          ) {\n            // The alt attribute should be assigned after the src attribute\n            // to avoid the image box size being determined by the alt text.\n            // (Issue #1343)\n            delayedAlt = attributeValue;\n          } else if (\n            attributeName == \"href\" &&\n            tag == \"image\" &&\n            ns == Base.NS.SVG &&\n            attributeNS == Base.NS.XLINK\n          ) {\n            this.page.fetchers.push(Net.loadElement(result, attributeValue));\n          } else {\n            // When the document is not XML document (e.g. non-XML HTML)\n            // attributeNS can be null\n            if (attributeNS) {\n              result.setAttributeNS(attributeNS, attributeName, attributeValue);\n            } else {\n              try {\n                result.setAttribute(attributeName, attributeValue);\n              } catch (err) {\n                Logging.logger.warn(err);\n              }\n            }\n          }\n        }\n        if (delayedSrc) {\n          const image = tag === \"input\" ? new Image() : result;\n          const imageFetcher = Net.loadElement(image, delayedSrc, delayedAlt);\n          if (image !== result) {\n            (result as HTMLImageElement).src = delayedSrc;\n          }\n          const isInsideRunningElement = (): boolean => {\n            // Check if the image is inside a position:fixed or running element\n            // which is converted to position:fixed.\n            if (computedStyle[\"position\"] === Css.ident.fixed) {\n              return true;\n            }\n            for (\n              let p = this.nodeContext.parent?.viewNode as HTMLElement;\n              p && p !== this.viewRoot;\n              p = p.parentElement\n            ) {\n              if (p.style?.[\"position\"] === \"fixed\") {\n                return true;\n              }\n            }\n            return false;\n          };\n          const hasPercentBlockSize = (): boolean => {\n            // Check if the image has percentage block size, which is usually same as auto,\n            // which means the size is not determined until the image is loaded.\n            const blockSize = this.nodeContext.vertical ? cssWidth : cssHeight;\n            return blockSize instanceof Css.Numeric && blockSize.unit === \"%\";\n          };\n          if (\n            !hasAutoWidth &&\n            !hasAutoHeight &&\n            !hasPercentBlockSize() &&\n            !isInsideRunningElement()\n          ) {\n            // No need to wait for the image, does not affect layout\n            this.page.fetchers.push(imageFetcher);\n          } else {\n            if (\n              hasAutoWidth &&\n              hasAutoHeight &&\n              imageResolution &&\n              imageResolution !== 1\n            ) {\n              images.push({\n                image: image as HTMLElement,\n                element: result as HTMLElement,\n                fetcher: imageFetcher,\n              });\n            }\n            fetchers.push(imageFetcher);\n          }\n        }\n        delete computedStyle[\"content\"];\n        const listStyleImage = computedStyle[\"list-style-image\"];\n        if (listStyleImage && listStyleImage instanceof Css.URL) {\n          const listStyleURL = (listStyleImage as Css.URL).url;\n          fetchers.push(Net.loadElement(new Image(), listStyleURL));\n        }\n        this.preprocessElementStyle(computedStyle);\n        this.applyComputedStyles(result, computedStyle);\n\n        if (this.nodeContext.inline) {\n          if (!firstTime) {\n            Break.setBoxBreakFlag(result, \"inline-start\");\n            if (Break.isCloneBoxDecorationBreak(result)) {\n              Break.setBoxBreakFlag(result, \"clone\");\n            }\n          }\n        } else {\n          if (!firstTime) {\n            const blockSizeP = this.nodeContext.vertical ? \"width\" : \"height\";\n            if (Base.getCSSProperty(result, blockSizeP)) {\n              // When a box with a specified block size is fragmented,\n              // the fragmented box should not have the block size.\n              // If the box is table-row, set a very small block size\n              // (0 does not work in Firefox, so use 0.01px instead)\n              // to prevent the row block size from expanding due to\n              // large rowspanning cells.\n              Base.setCSSProperty(\n                result,\n                blockSizeP,\n                this.nodeContext.display === \"table-row\" ? \"0.01px\" : \"\",\n              );\n            }\n            Break.setBoxBreakFlag(result, \"block-start\");\n            if (Break.isCloneBoxDecorationBreak(result)) {\n              Break.setBoxBreakFlag(result, \"clone\");\n            }\n            Break.setMarginDiscardFlag(result, \"block-start\");\n          } else if (\n            !Display.isAbsolutelyPositioned(computedStyle[\"position\"])\n          ) {\n            const marginBreak = computedStyle[\"margin-break\"];\n\n            // Detect forced or unforced break at this point\n            // to handle margin-break properly.\n            // Note: Do not use `atUnforcedBreak` which may be inaccurate.\n            const breakType = this.getBreakTypeAt(this.nodeContext);\n            const anyBreak = breakType !== null;\n            const unforcedBreak = breakType === \"auto\";\n            if (\n              (marginBreak === Css.ident.discard && anyBreak) ||\n              (marginBreak !== Css.ident.keep &&\n                unforcedBreak &&\n                !this.nodeContext.floatSide)\n            ) {\n              Break.setMarginDiscardFlag(result, \"block-start\");\n            }\n          }\n        }\n        if (isListItem) {\n          result.setAttribute(\n            \"value\",\n            computedStyle[\"ua-list-item-count\"].stringValue(),\n          );\n        }\n        if (result.classList.contains(\"_viv-marker-outside-content\")) {\n          // Adjust marker position for outside markers\n          if (Display.isListItem(this.nodeContext.parent?.parent?.display)) {\n            const style = this.viewport.window.getComputedStyle(\n              this.nodeContext.parent.parent.viewNode as Element,\n            );\n            const markerOffset =\n              parseFloat(style.borderInlineStartWidth) +\n              parseFloat(style.paddingInlineStart) +\n              parseFloat(style.textIndent);\n            if (markerOffset) {\n              (result as HTMLElement).style.insetInlineEnd =\n                `${markerOffset}px`;\n            }\n          }\n        }\n\n        this.viewNode = result;\n        if (fetchers.length) {\n          TaskUtil.waitForFetchers(fetchers).then(() => {\n            if (imageResolution > 0) {\n              this.modifyElemDimensionWithImageResolution(\n                images,\n                imageResolution,\n                computedStyle,\n                this.nodeContext.vertical,\n              );\n            }\n            frame.finish(needToProcessChildren);\n          });\n        } else {\n          frame.timeSlice().then(() => {\n            frame.finish(needToProcessChildren);\n          });\n        }\n      });\n    });\n    return frame.result();\n  }\n\n  /**\n   * Check if the current position is at the start of a page.\n   * This is used to determine whether a forced break should be ignored.\n   * (Issue #1608)\n   */\n  private isAtStartOfPage(): boolean {\n    for (let nc = this.nodeContext; nc?.parent && !nc.after; nc = nc.parent) {\n      let node =\n        nc === this.nodeContext && !nc.viewNode\n          ? nc.parent.viewNode?.lastChild\n          : nc.viewNode?.previousSibling;\n      while (\n        node &&\n        (Vtree.canIgnore(node, nc.parent.whitespace) ||\n          LayoutHelper.isOutOfFlow(node))\n      ) {\n        node = node.previousSibling;\n      }\n      if (node) {\n        return false;\n      }\n    }\n    return true;\n  }\n\n  /**\n   * Check if the current element is inside multi-column element\n   * that is not root or body element in the source tree.\n   *\n   * Note: vivliostyle handles multi-column on the root and body element on its own,\n   * but leaves it to the browser to handle other multi-column.\n   * This check is for such non-root/body multi-column.\n   */\n  private isInsideNonRootMultiColumn(): boolean {\n    const element = this.nodeContext.parent?.viewNode as Element;\n    return !!(element && LayoutHelper.findAncestorNonRootMultiColumn(element));\n  }\n\n  /**\n   * Check if the current position is at a forced or unforced break\n   * (Fix for Issue #690)\n   *\n   * @param nodeContext\n   * @returns forced break type, or \"auto\" for unforced break, or null for not break\n   */\n  private getBreakTypeAt(nodeContext: Vtree.NodeContext): string | null {\n    // Skip break detection for tables; fragmentation is handled by table.ts\n    if (this.isInsideTable(nodeContext)) {\n      return null;\n    }\n    for (let nc = nodeContext; nc && !nc.after; nc = nc.parent) {\n      if (Break.isForcedBreakValue(nc.breakBefore)) {\n        return nc.breakBefore; // forced break\n      }\n      if (nc.fragmentIndex === 1 && !nc.parent) {\n        if (nc.sourceNode === nc.sourceNode.ownerDocument.documentElement) {\n          // beginning of document\n          return \"page\";\n        } else {\n          // page floats, etc.\n          return null;\n        }\n      }\n      if (nc.parent?.floatSide) {\n        // inside float, not break (Issue #1282)\n        return null;\n      }\n      const parentViewNode = nc.parent?.viewNode as Element;\n      if (parentViewNode) {\n        const style = this.viewport.window.getComputedStyle(parentViewNode);\n        const paddingBlockStart = parseFloat(style.paddingBlockStart);\n        const borderBlockStartWidth = parseFloat(style.borderBlockStartWidth);\n        if (paddingBlockStart || borderBlockStartWidth) {\n          // parent's viewNode has block-start padding or border\n          return null;\n        }\n        let node = parentViewNode?.firstChild;\n        while (\n          node &&\n          (Vtree.canIgnore(node, nc.parent.whitespace) ||\n            (!nc.floatSide && LayoutHelper.isOutOfFlow(node)))\n        ) {\n          node = node.nextSibling;\n        }\n        if (node && node !== nc.viewNode) {\n          // parent's viewNode already has other content\n          return null;\n        }\n      }\n    }\n\n    const startBreakType = (\n      this.context as Exprs.Context & {\n        currentLayoutPosition: Vtree.LayoutPosition;\n      }\n    )?.currentLayoutPosition?.flowPositions[this.flowName]?.startBreakType;\n\n    if (Break.isForcedBreakValue(startBreakType)) {\n      return startBreakType; // forced break\n    } else {\n      return \"auto\"; // unforced break\n    }\n  }\n\n  private isInsideTable(nodeContext: Vtree.NodeContext): boolean {\n    for (let nc = nodeContext; nc && !nc.after; nc = nc.parent) {\n      if (nc.display && nc.display.startsWith(\"table\")) {\n        return true;\n      }\n    }\n    return false;\n  }\n\n  private processAfterIfcontinues(\n    element: Element,\n    cascStyle: CssCascade.ElementStyle,\n    styler: CssStyler.AbstractStyler,\n    context: Exprs.Context,\n  ) {\n    const pseudoMap = this.getPseudoMap(\n      cascStyle,\n      this.regionIds,\n      this.isFootnote,\n      this.nodeContext,\n      context,\n    );\n    if (!pseudoMap) {\n      return;\n    }\n    if (\n      pseudoMap[\"after-if-continues\"] &&\n      pseudoMap[\"after-if-continues\"][\"content\"]\n    ) {\n      const shadowStyler = new PseudoElement.PseudoelementStyler(\n        element,\n        cascStyle,\n        styler,\n        context,\n        this.exprContentListener,\n      );\n      this.nodeContext.afterIfContinues = new Layout.AfterIfContinues(\n        element,\n        shadowStyler,\n      );\n    }\n  }\n\n  isSVGUrlAttribute(attributeName: string): boolean {\n    return ViewFactory.SVG_URL_ATTRIBUTES.includes(attributeName.toLowerCase());\n  }\n\n  modifyElemDimensionWithImageResolution(\n    images: {\n      image: HTMLElement;\n      element: HTMLElement;\n      fetcher: TaskUtil.Fetcher<string>;\n    }[],\n    imageResolution: number,\n    computedStyle: { [key: string]: Css.Val },\n    isVertical: boolean,\n  ) {\n    images.forEach((param) => {\n      if (param.fetcher.get().get() === \"load\") {\n        const img = param.image;\n        let scaledWidth = (img as HTMLImageElement).width / imageResolution;\n        let scaledHeight = (img as HTMLImageElement).height / imageResolution;\n        const elem = param.element;\n        if (scaledWidth > 0 && scaledHeight > 0) {\n          if (computedStyle[\"box-sizing\"] === Css.ident.border_box) {\n            if (computedStyle[\"border-left-style\"] !== Css.ident.none) {\n              scaledWidth += Css.toNumber(\n                computedStyle[\"border-left-width\"],\n                this.context,\n              );\n            }\n            if (computedStyle[\"border-right-style\"] !== Css.ident.none) {\n              scaledWidth += Css.toNumber(\n                computedStyle[\"border-right-width\"],\n                this.context,\n              );\n            }\n            if (computedStyle[\"border-top-style\"] !== Css.ident.none) {\n              scaledHeight += Css.toNumber(\n                computedStyle[\"border-top-width\"],\n                this.context,\n              );\n            }\n            if (computedStyle[\"border-bottom-style\"] !== Css.ident.none) {\n              scaledHeight += Css.toNumber(\n                computedStyle[\"border-bottom-width\"],\n                this.context,\n              );\n            }\n          }\n          if (imageResolution > 1) {\n            const maxWidth = computedStyle[\"max-width\"] || Css.ident.none;\n            const maxHeight = computedStyle[\"max-height\"] || Css.ident.none;\n            if (maxWidth === Css.ident.none && maxHeight === Css.ident.none) {\n              Base.setCSSProperty(elem, \"max-width\", `${scaledWidth}px`);\n            } else if (\n              maxWidth !== Css.ident.none &&\n              maxHeight === Css.ident.none\n            ) {\n              Base.setCSSProperty(elem, \"width\", `${scaledWidth}px`);\n            } else if (\n              maxWidth === Css.ident.none &&\n              maxHeight !== Css.ident.none\n            ) {\n              Base.setCSSProperty(elem, \"height\", `${scaledHeight}px`);\n            } else {\n              // maxWidth != none && maxHeight != none\n              Asserts.assert(maxWidth.isNumeric());\n              Asserts.assert(maxHeight.isNumeric());\n              const numericMaxWidth = maxWidth as Css.Numeric;\n              const numericMaxHeight = maxHeight as Css.Numeric;\n              if (numericMaxWidth.unit !== \"%\") {\n                Base.setCSSProperty(\n                  elem,\n                  \"max-width\",\n                  `${Math.min(\n                    scaledWidth,\n                    Css.toNumber(numericMaxWidth, this.context),\n                  )}px`,\n                );\n              } else if (numericMaxHeight.unit !== \"%\") {\n                Base.setCSSProperty(\n                  elem,\n                  \"max-height\",\n                  `${Math.min(\n                    scaledHeight,\n                    Css.toNumber(numericMaxHeight, this.context),\n                  )}px`,\n                );\n              } else {\n                if (isVertical) {\n                  Base.setCSSProperty(elem, \"height\", `${scaledHeight}px`);\n                } else {\n                  Base.setCSSProperty(elem, \"width\", `${scaledWidth}px`);\n                }\n              }\n            }\n          } else if (imageResolution < 1) {\n            const minWidth = computedStyle[\"min-width\"] || Css.numericZero;\n            const minHeight = computedStyle[\"min-height\"] || Css.numericZero;\n            Asserts.assert(minWidth.isNumeric());\n            Asserts.assert(minWidth.isNumeric());\n            const numericMinWidth = minWidth as Css.Numeric;\n            const numericMinHeight = minHeight as Css.Numeric;\n            if (numericMinWidth.num === 0 && numericMinHeight.num === 0) {\n              Base.setCSSProperty(elem, \"min-width\", `${scaledWidth}px`);\n            } else if (\n              numericMinWidth.num !== 0 &&\n              numericMinHeight.num === 0\n            ) {\n              Base.setCSSProperty(elem, \"width\", `${scaledWidth}px`);\n            } else if (\n              numericMinWidth.num === 0 &&\n              numericMinHeight.num !== 0\n            ) {\n              Base.setCSSProperty(elem, \"height\", `${scaledHeight}px`);\n            } else {\n              // minWidth != 0 && minHeight != 0\n              if (numericMinWidth.unit !== \"%\") {\n                Base.setCSSProperty(\n                  elem,\n                  \"min-width\",\n                  `${Math.max(\n                    scaledWidth,\n                    Css.toNumber(numericMinWidth, this.context),\n                  )}px`,\n                );\n              } else if (numericMinHeight.unit !== \"%\") {\n                Base.setCSSProperty(\n                  elem,\n                  \"min-height\",\n                  `${Math.max(\n                    scaledHeight,\n                    Css.toNumber(numericMinHeight, this.context),\n                  )}px`,\n                );\n              } else {\n                if (isVertical) {\n                  Base.setCSSProperty(elem, \"height\", `${scaledHeight}px`);\n                } else {\n                  Base.setCSSProperty(elem, \"width\", `${scaledWidth}px`);\n                }\n              }\n            }\n          }\n        }\n      }\n    });\n  }\n\n  private preprocessElementStyle(computedStyle: { [key: string]: Css.Val }) {\n    const hooks: Plugin.PreProcessElementStyleHook[] = Plugin.getHooksForName(\n      Plugin.HOOKS.PREPROCESS_ELEMENT_STYLE,\n    );\n    hooks.forEach((hook) => {\n      hook(this.nodeContext, computedStyle);\n    });\n  }\n\n  private findAndProcessRepeatingElements(\n    element: Element,\n    styler: CssStyler.AbstractStyler,\n  ) {\n    for (\n      let child: Node = element.firstChild;\n      child;\n      child = child.nextSibling\n    ) {\n      if (child.nodeType !== 1) {\n        continue;\n      }\n      const computedStyle: { [key: string]: Css.Val } = {};\n      const elementStyle = styler.getStyle(child as Element, false);\n      this.computeStyle(\n        this.nodeContext.vertical,\n        this.nodeContext.direction === \"rtl\",\n        elementStyle,\n        computedStyle,\n      );\n      const processRepeatOnBreak = this.processRepeatOnBreak(computedStyle);\n      if (!processRepeatOnBreak) {\n        continue;\n      }\n      if (\n        this.nodeContext.formattingContext instanceof\n          RepetitiveElement.RepetitiveElementsOwnerFormattingContext &&\n        !this.nodeContext.belongsTo(this.nodeContext.formattingContext)\n      ) {\n        return;\n      }\n      const parent = this.nodeContext.parent;\n      const parentFormattingContext = parent && parent.formattingContext;\n      this.nodeContext.formattingContext =\n        new RepetitiveElement.RepetitiveElementsOwnerFormattingContext(\n          parentFormattingContext,\n          this.nodeContext.sourceNode as Element,\n        );\n      (\n        this.nodeContext\n          .formattingContext as RepetitiveElement.RepetitiveElementsOwnerFormattingContext\n      ).initializeRepetitiveElements(this.nodeContext.vertical);\n      return;\n    }\n  }\n\n  private processRepeatOnBreak(computedStyle: { [key: string]: Css.Val }) {\n    let repeatOnBreak = computedStyle[\"repeat-on-break\"];\n    if (repeatOnBreak !== Css.ident.none) {\n      if (\n        repeatOnBreak === Css.ident.auto ||\n        Css.isDefaultingValue(repeatOnBreak)\n      ) {\n        if (computedStyle[\"display\"] === Css.ident.table_header_group) {\n          repeatOnBreak = Css.ident.header;\n        } else if (computedStyle[\"display\"] === Css.ident.table_footer_group) {\n          repeatOnBreak = Css.ident.footer;\n        } else {\n          repeatOnBreak = Css.ident.none;\n        }\n      }\n      if (repeatOnBreak && repeatOnBreak !== Css.ident.none) {\n        return repeatOnBreak.toString();\n      }\n    }\n    return null;\n  }\n\n  private createTextNodeView(): Task.Result<boolean> {\n    const frame: Task.Frame<boolean> = Task.newFrame(\"createTextNodeView\");\n    this.preprocessTextContent().then(() => {\n      const offsetInNode = this.offsetInNode || 0;\n      const textContent = Diff.restoreNewText(\n        this.nodeContext.preprocessedTextContent,\n      ).substr(offsetInNode);\n      this.viewNode = document.createTextNode(textContent);\n      frame.finish(true);\n    });\n    return frame.result();\n  }\n\n  private preprocessTextContent(): Task.Result<boolean> {\n    if (this.nodeContext.preprocessedTextContent != null) {\n      return Task.newResult(true);\n    }\n    let originl: string;\n    let textContent = (originl = this.sourceNode.textContent);\n    const frame: Task.Frame<boolean> = Task.newFrame(\"preprocessTextContent\");\n    const hooks: Plugin.PreProcessTextContentHook[] = Plugin.getHooksForName(\n      Plugin.HOOKS.PREPROCESS_TEXT_CONTENT,\n    );\n    let index = 0;\n    frame\n      .loop(() => {\n        if (index >= hooks.length) {\n          return Task.newResult(false);\n        }\n        return hooks[index++](this.nodeContext, textContent).thenAsync(\n          (processedText) => {\n            textContent = processedText;\n            return Task.newResult(true);\n          },\n        );\n      })\n      .then(() => {\n        this.nodeContext.preprocessedTextContent = Diff.diffChars(\n          originl,\n          textContent,\n        );\n        frame.finish(true);\n      });\n    return frame.result();\n  }\n\n  /**\n   * @return holding true if children should be processed\n   */\n  createNodeView(\n    firstTime: boolean,\n    atUnforcedBreak: boolean,\n  ): Task.Result<boolean> {\n    const frame: Task.Frame<boolean> = Task.newFrame(\"createNodeView\");\n    let result: Task.Result<boolean>;\n    let needToProcessChildren = true;\n    if (this.sourceNode.nodeType == 1) {\n      result = this.createElementView(firstTime, atUnforcedBreak);\n    } else {\n      if (this.sourceNode.nodeType == 8) {\n        this.viewNode = null; // comment node\n        result = Task.newResult(true);\n      } else {\n        result = this.createTextNodeView();\n      }\n    }\n    result.then((processChildren) => {\n      needToProcessChildren = processChildren;\n      this.nodeContext.viewNode = this.viewNode;\n      if (this.viewNode) {\n        const isPseudo = (node: Node, name: string): boolean =>\n          node?.nodeType === 1 &&\n          PseudoElement.getPseudoName(node as Element) === name;\n        const p = this.nodeContext.parent;\n        const parent = p\n          ? isPseudo(this.viewNode, \"after\") &&\n            isPseudo(p.viewNode, \"first-letter\") &&\n            p.viewNode?.hasChildNodes()\n            ? (p.parent.viewNode as Element) // Fix for issue #1175\n            : (p.viewNode as Element)\n          : this.viewRoot;\n        if (parent) {\n          if (\n            this.nodeContext.inline &&\n            // ignore whitespace text node\n            !(this.viewNode.nodeType === 3 && Vtree.canIgnore(this.viewNode)) &&\n            !parent.hasChildNodes() &&\n            Break.getBoxBreakFlags(parent).includes(\"block-start\")\n          ) {\n            Break.setBoxBreakFlag(parent, \"text-start\");\n          }\n          parent.appendChild(this.viewNode);\n\n          // Fix overflow caused by forced column breaks\n          LayoutHelper.fixOverflowAtForcedColumnBreak(this.viewNode);\n        }\n      }\n      frame.finish(needToProcessChildren);\n    });\n    return frame.result();\n  }\n\n  /** @override */\n  setCurrent(\n    nodeContext: Vtree.NodeContext,\n    firstTime: boolean,\n    atUnforcedBreak?: boolean,\n  ): Task.Result<boolean> {\n    this.nodeContext = nodeContext;\n    if (nodeContext) {\n      this.sourceNode = nodeContext.sourceNode;\n      this.offsetInNode = nodeContext.offsetInNode;\n    } else {\n      this.sourceNode = null;\n      this.offsetInNode = -1;\n    }\n    this.viewNode = null;\n    if (this.nodeContext) {\n      return this.createNodeView(firstTime, !!atUnforcedBreak);\n    }\n    return Task.newResult(true);\n  }\n\n  processShadowContent(pos: Vtree.NodeContext): Vtree.NodeContext {\n    if (\n      pos.shadowContext == null ||\n      (pos.sourceNode as Element).localName != \"content\" ||\n      (pos.sourceNode as Element).namespaceURI != Base.NS.SHADOW\n    ) {\n      return pos;\n    }\n    const boxOffset = pos.boxOffset;\n    const shadow = pos.shadowContext;\n    const parent = pos.parent;\n\n    // content that will be inserted\n    let contentNode: Node;\n    let contentShadowType: Vtree.ShadowType;\n    const contentShadow = shadow.subShadow || shadow.parentShadow;\n    if (shadow.subShadow) {\n      contentNode = shadow.root;\n      contentShadowType = shadow.type;\n      if (contentShadowType == Vtree.ShadowType.ROOTLESS) {\n        contentNode = contentNode.firstChild;\n      }\n    } else {\n      contentNode = shadow.owner.firstChild;\n      contentShadowType = Vtree.ShadowType.ROOTLESS;\n    }\n    const nextSibling = pos.sourceNode.nextSibling;\n    if (nextSibling) {\n      pos.sourceNode = nextSibling;\n      pos.resetView();\n    } else if (pos.shadowSibling) {\n      pos = pos.shadowSibling;\n    } else if (contentNode) {\n      pos = null;\n    } else {\n      pos = pos.parent.modify();\n      pos.after = true;\n    }\n    if (contentNode) {\n      const r = new Vtree.NodeContext(contentNode, parent, boxOffset);\n      r.shadowContext = contentShadow;\n      r.shadowType = contentShadowType;\n      r.shadowSibling = pos;\n      return r;\n    }\n    pos.boxOffset = boxOffset;\n    return pos;\n  }\n\n  private nextPositionInTree(pos: Vtree.NodeContext): Vtree.NodeContext {\n    let boxOffset = pos.boxOffset + 1; // offset for the next position\n    if (pos.after) {\n      // root, that was the last possible position\n      if (!pos.parent) {\n        return null;\n      }\n\n      // we are done with this sourceNode, see if there is a next sibling,\n      // unless this is the root of the shadow tree\n      if (pos.shadowType != Vtree.ShadowType.ROOTED) {\n        const next = pos.sourceNode.nextSibling;\n        if (next) {\n          pos = pos.modify();\n\n          // keep shadowType\n          pos.boxOffset = boxOffset;\n          pos.sourceNode = next;\n          pos.resetView();\n          return this.processShadowContent(pos);\n        }\n      }\n\n      // if no viable siblings, check if there are shadow siblings\n      if (pos.shadowSibling) {\n        // our next position is the element after shadow:content in the parent\n        // shadow tree\n        pos = pos.shadowSibling.modify();\n        pos.boxOffset = boxOffset;\n        return pos;\n      }\n\n      // if not rootless shadow, move to the \"after\" position for the parent\n      pos = pos.parent.modify();\n      pos.boxOffset = boxOffset;\n      pos.after = true;\n      return pos;\n    } else {\n      // any shadow trees?\n      if (pos.nodeShadow) {\n        let shadowNode: Node | null = pos.nodeShadow.root;\n        if (pos.nodeShadow.type == Vtree.ShadowType.ROOTLESS) {\n          shadowNode = shadowNode.firstChild;\n        }\n        if (shadowNode) {\n          const sr = new Vtree.NodeContext(shadowNode, pos, boxOffset);\n          sr.shadowContext = pos.nodeShadow;\n          sr.shadowType = pos.nodeShadow.type;\n          return this.processShadowContent(sr);\n        }\n      }\n\n      // any children?\n      const child = pos.sourceNode.firstChild;\n      if (child) {\n        return this.processShadowContent(\n          new Vtree.NodeContext(child, pos, boxOffset),\n        );\n      }\n\n      // no children - was there text content?\n      if (pos.sourceNode.nodeType != 1) {\n        const content = Diff.restoreNewText(pos.preprocessedTextContent);\n        boxOffset += content.length - 1 - pos.offsetInNode;\n      }\n      pos = pos.modify();\n      pos.boxOffset = boxOffset;\n      pos.after = true;\n      return pos;\n    }\n  }\n\n  isTransclusion(\n    element: Element,\n    elementStyle: CssCascade.ElementStyle,\n    transclusionType: string | null,\n  ) {\n    const proc = CssCascade.getProp(elementStyle, \"hyperlink-processing\");\n    if (!proc) {\n      return false;\n    }\n    const prop = proc.evaluate(this.context, \"hyperlink-processing\");\n    if (!prop) {\n      return false;\n    }\n    return prop.toString() == transclusionType;\n  }\n\n  /** @override */\n  nextInTree(\n    position: Vtree.NodeContext,\n    atUnforcedBreak?: boolean,\n  ): Task.Result<Vtree.NodeContext> {\n    let nodeContext = this.nextPositionInTree(position);\n    if (!nodeContext || nodeContext.after) {\n      return Task.newResult(nodeContext);\n    }\n    const frame: Task.Frame<Vtree.NodeContext> = Task.newFrame(\"nextInTree\");\n    this.setCurrent(nodeContext, true, atUnforcedBreak).then(\n      (processChildren) => {\n        if (!nodeContext.viewNode || !processChildren) {\n          nodeContext = nodeContext.modify();\n          nodeContext.after = true; // skip\n          if (!nodeContext.viewNode) {\n            nodeContext.inline = true;\n          }\n        }\n        this.dispatchEvent({ type: \"nextInTree\", nodeContext } as any);\n        frame.finish(nodeContext);\n      },\n    );\n    return frame.result();\n  }\n\n  addImageFetchers(bg: Css.Val) {\n    if (bg instanceof Css.CommaList) {\n      const values = (bg as Css.CommaList).values;\n      for (let i = 0; i < values.length; i++) {\n        this.addImageFetchers(values[i]);\n      }\n    } else if (bg instanceof Css.URL) {\n      const url = (bg as Css.URL).url;\n      this.page.fetchers.push(Net.loadElement(new Image(), url));\n    }\n  }\n\n  applyComputedStyles(\n    target: Element,\n    computedStyle: { [key: string]: Css.Val },\n  ) {\n    const bg = computedStyle[\"background-image\"];\n    if (bg) {\n      this.addImageFetchers(bg);\n    }\n    const isRelativePositioned =\n      computedStyle[\"position\"] === Css.ident.relative;\n    const isRoot =\n      this.nodeContext?.parent === null &&\n      this.sourceNode?.parentElement === null &&\n      !!this.viewRoot?.parentElement;\n\n    const propList = Object.keys(computedStyle);\n    propList.sort(Css.processingOrderFn);\n    let fontSize: Css.Val;\n    let lineHeight: Css.Val;\n\n    for (const propName of propList) {\n      if (propertiesNotPassedToDOM[propName]) {\n        continue;\n      }\n      let value = computedStyle[propName];\n      if (!value || (value === Css.empty && !Css.isCustomPropName(propName))) {\n        continue;\n      }\n      value = value.visit(\n        new CssProp.UrlTransformVisitor(\n          this.xmldoc.url,\n          this.documentURLTransformer,\n        ),\n      );\n      if (value instanceof Css.Numeric) {\n        if (value.unit === \"em\") {\n          const emUnitSize = this.getEmUnitSize(propName, fontSize);\n          if (emUnitSize != null) {\n            value = new Css.Numeric(value.num * emUnitSize, \"px\");\n          }\n        } else if (value.unit === \"lh\") {\n          const lhUnitSize = this.getLineHeightUnitSize(\n            propName,\n            fontSize,\n            lineHeight,\n          );\n          if (lhUnitSize != null) {\n            value = new Css.Numeric(value.num * lhUnitSize, \"px\");\n          }\n        } else if (Exprs.needUnitConversion(value.unit)) {\n          // font-size for the root element is already converted to px\n          value = Css.convertNumericToPx(value, this.context);\n        }\n      }\n\n      if (propName === \"font-size\" || propName === \"line-height\") {\n        if (propName === \"font-size\") {\n          fontSize = value;\n        } else {\n          lineHeight = value;\n        }\n\n        // Adjust font-size and line-height to prevent rounding issues\n        // when calculating the size of text and line boxes. (Issue #1590)\n        //\n        // Chromium and Firefox round to the nearest multiple of LayoutUnit\n        // (the smallest unit of length in the browser) when positioning boxes,\n        // which may cause the box size to be slightly larger than specified,\n        // resulting in text not fitting in the specified number of characters/lines.\n        // To prevent this, we adjust the font size and line height to be\n        // 1 LayoutUnit less.\n        if (\n          this.viewport.layoutUnitAdj &&\n          value instanceof Css.Numeric &&\n          value.unit !== \"%\" &&\n          value.unit !== \"em\" &&\n          value.unit !== \"lh\"\n        ) {\n          value = new Css.AnyToken(\n            `calc(${value.toString()} - var(--viv-layoutUnitAdj))`,\n          );\n        }\n      }\n\n      if (\n        Vtree.delayedProps[propName] ||\n        (isRelativePositioned &&\n          Vtree.delayedPropsIfRelativePositioned[propName])\n      ) {\n        // Set it after page layout is done.\n        this.page.delayedItems.push(\n          new Vtree.DelayedItem(target, propName, value),\n        );\n        continue;\n      }\n      if (\n        isRoot &&\n        this.page.pageAreaElement &&\n        CssCascade.isInherited(propName)\n      ) {\n        // Fix for Issue #568\n        Base.setCSSProperty(\n          this.page.pageAreaElement.parentElement.parentElement,\n          propName,\n          value.toString(),\n        );\n      } else {\n        Base.setCSSProperty(target, propName, value.toString());\n      }\n    }\n  }\n\n  /**\n   * Parse a CSS value with \"px\" unit plus layoutUnitAdj.\n   * This is to get accurate font-size and line-height values from computed style\n   * that have been set with minus layoutUnitAdj.\n   * @param val CSS value string\n   * @returns parsed and adjusted value in px, or null if cannot parse as \"px\" unit, e.g. \"normal\"\n   */\n  private parsePlusLayoutUnitAdj(val: string): number | null {\n    if (val.endsWith(\"px\")) {\n      const parsedVal = parseFloat(val);\n      if (!isNaN(parsedVal)) {\n        return (\n          Math.round(\n            (parsedVal + this.viewport.layoutUnitAdj) *\n              this.viewport.layoutUnitPerPixel,\n          ) / this.viewport.layoutUnitPerPixel\n        );\n      }\n    }\n    return null;\n  }\n\n  /**\n   * Get \"lh\" unit size in px\n   * @return line-height in px, or null if cannot be determined\n   */\n  private getLineHeightUnitSize(\n    propName: string,\n    fontSize: Css.Val,\n    lineHeight: Css.Val,\n  ): number | null {\n    const parentStyle =\n      this.nodeContext?.parent?.viewNode?.nodeType === 1\n        ? this.viewport.window.getComputedStyle(\n            this.nodeContext.parent.viewNode as Element,\n          )\n        : null;\n\n    const parentLineHeight = parentStyle\n      ? this.parsePlusLayoutUnitAdj(parentStyle.lineHeight)\n      : this.context.rootLineHeight;\n\n    if (propName === \"line-height\" || propName === \"font-size\") {\n      // For line-height property or for font-size property, return parent line-height.\n      // Note: parentLineHeight may be null (cannot determine).\n      return parentLineHeight;\n    }\n\n    // Font-size relative line-height value\n    let lineHeightNum: number | null = null;\n\n    if (lineHeight) {\n      if (\n        lineHeight instanceof Css.Num ||\n        (lineHeight instanceof Css.Numeric &&\n          (lineHeight.unit === \"em\" || lineHeight.unit === \"%\"))\n      ) {\n        // The line-height is relative to the font-size\n        lineHeightNum =\n          lineHeight instanceof Css.Numeric && lineHeight.unit === \"%\"\n            ? lineHeight.num / 100\n            : lineHeight.num;\n      } else {\n        if (lineHeight instanceof Css.Numeric && lineHeight.unit !== \"lh\") {\n          const unitSize = this.context.queryUnitSize(lineHeight.unit, false);\n          if (unitSize != null) {\n            // Return line-height in px\n            return lineHeight.num * unitSize;\n          }\n        }\n        return null; // cannot determine\n      }\n    }\n\n    if (lineHeightNum == null) {\n      // Try to get font-size relative line-height value from ancestor elements\n      for (\n        let viewNode = this.nodeContext?.parent?.viewNode;\n        viewNode && viewNode.nodeType === 1;\n        viewNode = viewNode.parentNode\n      ) {\n        const ancestorLH = (viewNode as HTMLElement)?.style?.lineHeight;\n        if (ancestorLH) {\n          // Found line-height style in ancestor\n          if (/^[0-9.]+$/.test(ancestorLH)) {\n            // If it's a number without unit, it's relative to font-size\n            lineHeightNum = parseFloat(ancestorLH);\n          }\n          break;\n        }\n      }\n    }\n\n    if (lineHeightNum != null) {\n      // The line-height is relative to the font-size\n      if (fontSize && !(fontSize instanceof Css.Numeric)) {\n        return null; // cannot determine\n      }\n      const parentFontSize = parentStyle\n        ? this.parsePlusLayoutUnitAdj(parentStyle.fontSize)\n        : this.context.rootFontSize;\n      if (fontSize instanceof Css.Numeric) {\n        const fontSizePx = CssCascade.convertFontSizeToPx(\n          fontSize,\n          parentFontSize,\n          this.context,\n        ).num;\n        // parentFontSize may be null and the fontSizePx may be NaN\n        if (typeof fontSizePx !== \"number\" || isNaN(fontSizePx)) {\n          return null; // cannot determine\n        }\n        return lineHeightNum * fontSizePx;\n      } else {\n        if (parentFontSize == null) {\n          return null;\n        }\n        return lineHeightNum * parentFontSize;\n      }\n    }\n    // parentLineHeight may be null (cannot determine)\n    return parentLineHeight;\n  }\n\n  /**\n   * Get \"em\" unit size in px\n   * @return font-size in px, or null if cannot be determined\n   */\n  private getEmUnitSize(propName: string, fontSize: Css.Val): number | null {\n    const parentStyle =\n      this.nodeContext?.parent?.viewNode?.nodeType === 1\n        ? this.viewport.window.getComputedStyle(\n            this.nodeContext.parent.viewNode as Element,\n          )\n        : null;\n\n    const parentFontSize = parentStyle\n      ? this.parsePlusLayoutUnitAdj(parentStyle.fontSize)\n      : this.context.rootFontSize;\n\n    if (propName === \"font-size\" || fontSize == null) {\n      // For font-size property or when font-size is not specified, return parent font-size.\n      // Note: parentFontSize may be null (cannot determine).\n      return parentFontSize;\n    }\n    if (fontSize instanceof Css.Numeric) {\n      // When font-size is specified, convert it to px\n      const fontSizePx = CssCascade.convertFontSizeToPx(\n        fontSize,\n        parentFontSize,\n        this.context,\n      ).num;\n      if (typeof fontSizePx === \"number\" && !isNaN(fontSizePx)) {\n        return fontSizePx;\n      }\n    }\n    return null; // cannot determine\n  }\n\n  /** @override */\n  applyPseudoelementStyle(\n    nodeContext: Vtree.NodeContext,\n    pseudoName: string,\n    target: Element,\n  ): void {\n    if (nodeContext.after) {\n      return;\n    }\n    const element = this.sourceNode as Element;\n    const styler = nodeContext.shadowContext\n      ? (nodeContext.shadowContext.styler as CssStyler.AbstractStyler)\n      : this.styler;\n    let elementStyle = styler.getStyle(element, false);\n    const pseudoMap = CssCascade.getStyleMap(elementStyle, \"_pseudos\");\n    if (!pseudoMap) {\n      return;\n    }\n    elementStyle = pseudoMap[pseudoName];\n    if (!elementStyle) {\n      return;\n    }\n    const computedStyle: { [key: string]: Css.Val } = {};\n    nodeContext.vertical = this.computeStyle(\n      nodeContext.vertical,\n      nodeContext.direction === \"rtl\",\n      elementStyle,\n      computedStyle,\n    );\n    const content = computedStyle[\"content\"];\n    if (Vtree.nonTrivialContent(content)) {\n      content.visit(\n        new Vtree.ContentPropertyHandler(\n          target,\n          this.context,\n          content,\n          this.exprContentListener,\n        ),\n      );\n      delete computedStyle[\"content\"];\n    }\n    this.applyComputedStyles(target, computedStyle);\n  }\n\n  /** @override */\n  peelOff(\n    nodeContext: Vtree.NodeContext,\n    nodeOffset: number,\n  ): Task.Result<Vtree.NodeContext> {\n    const frame: Task.Frame<Vtree.NodeContext> = Task.newFrame(\"peelOff\");\n    const firstPseudo = nodeContext.firstPseudo;\n    let offsetInNode = nodeContext.offsetInNode;\n    const after = nodeContext.after;\n    if (nodeOffset > 0) {\n      const text = nodeContext.viewNode.textContent;\n      nodeContext.viewNode.textContent = text.substr(0, nodeOffset);\n      offsetInNode += nodeOffset;\n    } else if (!after && nodeContext.viewNode && offsetInNode == 0) {\n      const parent = nodeContext.viewNode.parentNode;\n      if (parent) {\n        parent.removeChild(nodeContext.viewNode);\n      }\n    }\n    const boxOffset = nodeContext.boxOffset + nodeOffset;\n    const arr = [];\n    while (nodeContext.firstPseudo === firstPseudo) {\n      arr.push(nodeContext);\n      nodeContext = nodeContext.parent;\n    }\n    let pn = arr.pop(); // container for that pseudoelement\n    let shadowSibling = pn.shadowSibling;\n    frame\n      .loop(() => {\n        while (arr.length > 0) {\n          pn = arr.pop();\n          nodeContext = new Vtree.NodeContext(\n            pn.sourceNode,\n            nodeContext,\n            boxOffset,\n          );\n          if (arr.length == 0) {\n            nodeContext.offsetInNode = offsetInNode;\n            nodeContext.after = after;\n          }\n          nodeContext.shadowType = pn.shadowType;\n          nodeContext.shadowContext = pn.shadowContext;\n          nodeContext.nodeShadow = pn.nodeShadow;\n          nodeContext.shadowSibling = pn.shadowSibling\n            ? pn.shadowSibling\n            : shadowSibling;\n          shadowSibling = null;\n          const result = this.setCurrent(nodeContext, false);\n          if (result.isPending()) {\n            return result;\n          }\n        }\n        return Task.newResult(false);\n      })\n      .then(() => {\n        frame.finish(nodeContext);\n      });\n    return frame.result();\n  }\n\n  createElement(ns: string, tag: string): Element {\n    if (ns == Base.NS.XHTML) {\n      return this.document.createElement(tag);\n    }\n    return this.document.createElementNS(ns, tag);\n  }\n\n  /** @override */\n  applyFootnoteStyle(\n    vertical: boolean,\n    rtl: boolean,\n    target: Element,\n  ): boolean {\n    const computedStyle: { [key: string]: Css.Val } = {};\n    const pseudoMap = CssCascade.getStyleMap(this.footnoteStyle, \"_pseudos\");\n    vertical = this.computeStyle(\n      vertical,\n      rtl,\n      this.footnoteStyle,\n      computedStyle,\n    );\n    if (pseudoMap && pseudoMap[\"before\"]) {\n      const childComputedStyle: { [key: string]: Css.Val } = {};\n      const span = this.createElement(Base.NS.XHTML, \"span\");\n      PseudoElement.setPseudoName(span, \"before\");\n      target.appendChild(span);\n      this.computeStyle(vertical, rtl, pseudoMap[\"before\"], childComputedStyle);\n      delete childComputedStyle[\"content\"];\n      this.applyComputedStyles(span, childComputedStyle);\n    }\n    delete computedStyle[\"content\"];\n    this.applyComputedStyles(target, computedStyle);\n    return vertical;\n  }\n\n  /** @override */\n  processFragmentedBlockEdge(nodeContext: Vtree.NodeContext) {\n    const nodeContext1 =\n      !nodeContext.inline && nodeContext.after\n        ? nodeContext.parent\n        : nodeContext;\n    // Fix for problem with math (Issue #1038)\n    let isBeforeBlock = false;\n    if (\n      nodeContext.inline &&\n      nodeContext.after &&\n      !nodeContext.shadowContext &&\n      nodeContext.sourceNode.nextSibling?.nodeType === 1\n    ) {\n      const nextElem = nodeContext.sourceNode.nextSibling as Element;\n      const display = CssCascade.getProp(\n        this.styler.getStyle(nextElem, false),\n        \"display\",\n      )?.value.toString();\n      isBeforeBlock =\n        (display && !Display.isInlineLevel(display)) ||\n        (nextElem.getAttribute(\"data-math-typeset\") === \"true\" &&\n          /^\\s*(\\$\\$|\\\\\\[)/.test(nextElem.textContent));\n    }\n\n    let blockNestCount = 0;\n    for (let nc = nodeContext1; nc; nc = nc.parent) {\n      if (nc.viewNode?.nodeType !== 1) continue;\n\n      const elem = nc.viewNode as HTMLElement;\n      if (!elem.style) continue;\n\n      if (nc.inline) {\n        Break.setBoxBreakFlag(elem, \"inline-end\");\n        if (Break.isCloneBoxDecorationBreak(elem)) {\n          const extentBefore = nc.vertical\n            ? elem.offsetWidth\n            : elem.offsetHeight;\n          Break.setBoxBreakFlag(elem, \"clone\");\n          const extentAfter = nc.vertical\n            ? elem.offsetWidth\n            : elem.offsetHeight;\n          if (extentAfter > extentBefore) {\n            // Workaround for Chrome box-decoration-break:clone problem\n            this.fixClonedBoxDecorationOverflow(elem);\n          }\n        }\n      } else {\n        const blockSizeP = this.nodeContext.vertical ? \"width\" : \"height\";\n        if (Base.getCSSProperty(elem, blockSizeP)) {\n          // When a box with a specified block size is fragmented,\n          // the fragmented box should not have the block size.\n          Base.setCSSProperty(elem, blockSizeP, \"\");\n        }\n        Break.setBoxBreakFlag(elem, \"block-end\");\n        if (!blockNestCount++) {\n          if (nc !== nodeContext1) {\n            const { textAlign } = this.viewport.window.getComputedStyle(elem);\n            if (textAlign === \"justify\" && !isBeforeBlock) {\n              // Workaround for the problem that text-align-last:justify is\n              // not only effective at the last line of the block but also\n              // effective at lines just before child block-level or `<br>`\n              // elements.\n              const elem2 = this.createChildAnonymousBlockIfNeeded(elem);\n              if (elem2) {\n                if (elem2 !== elem) {\n                  // child anonymous block created\n                  Break.setBoxBreakFlags(elem2, [\n                    \"block-start\",\n                    \"text-start\",\n                    \"block-end\",\n                    \"text-end\",\n                    \"justify\",\n                  ]);\n                } else {\n                  Break.setBoxBreakFlag(elem, \"text-end\");\n                  Break.setBoxBreakFlag(elem, \"justify\");\n                }\n              } else {\n                // text-align-last:justify is not necessary (`<br>` at very last)\n                // or not appropriate (e.g. the last `<br>` is in middle of nested inline)\n                Break.setBoxBreakFlag(elem, \"text-end\");\n              }\n            } else {\n              Break.setBoxBreakFlag(elem, \"text-end\");\n            }\n          }\n        }\n        if (Break.isCloneBoxDecorationBreak(elem)) {\n          Break.setBoxBreakFlag(elem, \"clone\");\n        }\n        Break.setMarginDiscardFlag(elem, \"block-end\");\n      }\n    }\n  }\n\n  private fixClonedBoxDecorationOverflow(elem: HTMLElement): void {\n    const computedStyle = this.viewport.window.getComputedStyle(elem);\n    const paddingInlineEnd = parseFloat(computedStyle.paddingInlineEnd);\n    const borderInlineEndWidth = parseFloat(computedStyle.borderInlineEndWidth);\n    const adjust = -(paddingInlineEnd + borderInlineEndWidth);\n    if (!isNaN(adjust)) {\n      elem.style.marginInlineEnd = `${adjust}px`;\n    }\n  }\n\n  private createChildAnonymousBlockIfNeeded(\n    elem: HTMLElement,\n  ): HTMLElement | null {\n    const checkForcedLineBreakElem = (elem1: Element): boolean | null => {\n      const { display, position, float } =\n        this.viewport.window.getComputedStyle(elem1);\n      if (elem1.localName === \"ruby\" || Base.mediaTags[elem1.localName]) {\n        return false;\n      }\n      if (elem1.localName === \"br\") {\n        return true;\n      }\n      if (\n        (display === \"inline\" || display === \"contents\") &&\n        elem1.hasChildNodes()\n      ) {\n        const lastChild = elem1.lastElementChild;\n        if (\n          lastChild &&\n          (!lastChild.nextSibling ||\n            (lastChild.nextSibling === elem1.lastChild &&\n              Vtree.canIgnore(lastChild.nextSibling)))\n        ) {\n          const found = checkForcedLineBreakElem(lastChild);\n          if (found || found === null) {\n            return found;\n          }\n        }\n        for (\n          let child = lastChild?.previousElementSibling;\n          child;\n          child = child.previousElementSibling\n        ) {\n          const found = checkForcedLineBreakElem(child);\n          if (found || found === null) {\n            // forced line break is found at middle of nested inline\n            return null;\n          }\n        }\n        return false;\n      }\n      if (\n        display === \"none\" ||\n        position === \"absolute\" ||\n        position === \"fixed\" ||\n        (float && float !== \"none\") ||\n        elem1.hasAttribute(LayoutHelper.SPECIAL_ATTR)\n      ) {\n        const prevElem = elem1.previousElementSibling;\n        if (\n          prevElem &&\n          (prevElem.nextSibling === elem1 ||\n            (prevElem.nextSibling === elem1.previousSibling &&\n              Vtree.canIgnore(prevElem.nextSibling)))\n        ) {\n          return checkForcedLineBreakElem(prevElem);\n        }\n        return false;\n      }\n      if (!display || Display.isInlineLevel(display)) {\n        return false;\n      }\n      return true;\n    };\n\n    let forcedBreakElem: Element | null = null;\n    for (\n      let child = elem.lastElementChild;\n      child;\n      child = child.previousElementSibling\n    ) {\n      const found = checkForcedLineBreakElem(child);\n      if (found) {\n        forcedBreakElem = child;\n        break;\n      }\n      if (found === null) {\n        // forced line break is found at middle of nested inline\n        return null;\n      }\n    }\n\n    if (!forcedBreakElem) {\n      // forced line break is not found\n      return elem;\n    }\n\n    if (\n      forcedBreakElem === elem.lastElementChild &&\n      (!forcedBreakElem.nextSibling ||\n        (forcedBreakElem.nextSibling === elem.lastChild &&\n          Vtree.canIgnore(forcedBreakElem.nextSibling)))\n    ) {\n      // forced line break is found at very last\n      return null;\n    }\n\n    const anonymousBlock = elem.ownerDocument.createElement(\"span\");\n    anonymousBlock.className = \"viv-anonymous-block\";\n\n    for (\n      let node = forcedBreakElem.nextSibling, nextNode = null;\n      node;\n      node = nextNode\n    ) {\n      nextNode = node.nextSibling;\n      anonymousBlock.appendChild(node);\n    }\n    elem.appendChild(anonymousBlock);\n    return anonymousBlock;\n  }\n\n  /** @override */\n  convertLengthToPx(\n    numeric: Css.Numeric,\n    viewNode: Node,\n    clientLayout: Vtree.ClientLayout,\n  ): number | Css.Numeric {\n    const num = numeric.num;\n    const unit = numeric.unit;\n    if (Exprs.isFontRelativeLengthUnit(unit)) {\n      let elem = viewNode;\n      while (elem && elem.nodeType !== 1) {\n        elem = elem.parentNode;\n      }\n      Asserts.assert(elem);\n      const fontSize = parseFloat(\n        clientLayout.getElementComputedStyle(elem as Element)[\"font-size\"],\n      );\n      Asserts.assert(this.context);\n      return CssCascade.convertFontRelativeLengthToPx(\n        numeric,\n        fontSize,\n        this.context,\n      ).num;\n    } else {\n      const unitSize = this.context.queryUnitSize(unit, false);\n      if (unitSize) {\n        return num * unitSize;\n      } else {\n        return numeric;\n      }\n    }\n  }\n\n  /**\n   * Returns if two NodePositionStep are equivalent.\n   */\n  isSameNodePositionStep(\n    step1: Vtree.NodePositionStep,\n    step2: Vtree.NodePositionStep,\n  ): boolean {\n    if (step1.shadowContext) {\n      if (!step2.shadowContext) {\n        return false;\n      }\n      const elem1 =\n        step1.node.nodeType === 1\n          ? (step1.node as Element)\n          : (step1.node.parentElement as Element);\n      const elem2 =\n        step2.node.nodeType === 1\n          ? (step2.node as Element)\n          : (step2.node.parentElement as Element);\n      return (\n        step1.shadowContext.owner === step2.shadowContext.owner &&\n        PseudoElement.getPseudoName(elem1) ===\n          PseudoElement.getPseudoName(elem2)\n      );\n    } else {\n      return step1.node === step2.node;\n    }\n  }\n\n  /** @override */\n  isSameNodePosition(\n    nodePosition1: Vtree.NodePosition,\n    nodePosition2: Vtree.NodePosition,\n  ): boolean {\n    return (\n      nodePosition1.offsetInNode === nodePosition2.offsetInNode &&\n      nodePosition1.after == nodePosition2.after &&\n      nodePosition1.steps.length === nodePosition2.steps.length &&\n      nodePosition1.steps.every((step1, i) => {\n        const step2 = nodePosition2.steps[i];\n        return this.isSameNodePositionStep(step1, step2);\n      })\n    );\n  }\n\n  isPseudoelement(elem) {\n    return !!PseudoElement.getPseudoName(elem);\n  }\n}\n\nexport const propertiesNotPassedToDOM = {\n  \"float-min-wrap-block\": true,\n  \"float-reference\": true,\n  \"flow-into\": true,\n  \"flow-linger\": true,\n  \"flow-options\": true,\n  \"flow-priority\": true,\n  \"footnote-policy\": true,\n  \"margin-break\": true,\n  page: true,\n};\n\nexport class DefaultClientLayout implements Vtree.ClientLayout {\n  layoutBox: Element;\n  window: Window;\n  pixelRatio: number;\n  scaleRatio: number;\n  layoutUnitPerPixel: number;\n\n  constructor(viewport: Viewport) {\n    this.layoutBox = viewport.layoutBox;\n    this.window = viewport.window;\n    this.pixelRatio = viewport.pixelRatio;\n    this.scaleRatio = viewport.scaleRatio;\n    this.layoutUnitPerPixel = viewport.layoutUnitPerPixel;\n  }\n\n  private subtractOffsets(\n    rect: Vtree.ClientRect,\n    originRect: Vtree.ClientRect,\n  ): Vtree.ClientRect {\n    const viewportLeft = originRect.left;\n    const viewportTop = originRect.top;\n    return {\n      left: rect.left - viewportLeft,\n      top: rect.top - viewportTop,\n      right: rect.right - viewportLeft,\n      bottom: rect.bottom - viewportTop,\n      width: rect.width,\n      height: rect.height,\n    } as Vtree.ClientRect;\n  }\n\n  /** @override */\n  getRangeClientRects(range: Range): Vtree.ClientRect[] {\n    const rects = range.getClientRects();\n    const layoutBoxRect = this.layoutBox.getBoundingClientRect();\n    return Array.from(rects).map((rect) =>\n      this.subtractOffsets(rect, layoutBoxRect),\n    );\n  }\n\n  /** @override */\n  getElementClientRect(element: Element): Vtree.ClientRect {\n    const htmlElement = element as HTMLElement;\n    const rect = htmlElement.getBoundingClientRect() as Vtree.ClientRect;\n    if (\n      rect.left === 0 &&\n      rect.top === 0 &&\n      rect.right === 0 &&\n      rect.bottom === 0\n    ) {\n      // getBoundingClientRect() returns 0,0,0,0 for WBR element (Chrome)\n      // (Fix for issue #802)\n      return rect;\n    }\n    const layoutBoxRect = this.layoutBox.getBoundingClientRect();\n    return this.subtractOffsets(rect, layoutBoxRect);\n  }\n\n  /** @override */\n  getElementComputedStyle(element: Element): CSSStyleDeclaration {\n    return this.window.getComputedStyle(element, null);\n  }\n\n  /**\n   * Adjust length value with rendering precision.\n   * @param value Length value to adjust\n   * @return Adjusted length value\n   * @override\n   */\n  adjustLengthValue(value: number): number {\n    return this.layoutUnitPerPixel\n      ? Math.floor(value * this.layoutUnitPerPixel) / this.layoutUnitPerPixel\n      : value;\n  }\n}\n\nexport class Viewport {\n  document: Document;\n  root: HTMLElement;\n  private outerZoomBox: HTMLElement;\n  contentContainer: HTMLElement;\n  layoutBox: HTMLElement;\n  width: number;\n  height: number;\n  scaleRatio: number = 1;\n  layoutUnitPerPixel: number;\n  layoutUnitAdj: number = 0;\n\n  constructor(\n    public readonly window: Window,\n    public readonly fontSize: number,\n    public readonly pixelRatio: number,\n    opt_root?: HTMLElement,\n    opt_width?: number,\n    opt_height?: number,\n  ) {\n    this.document = window.document;\n    this.root = opt_root || this.document.body;\n\n    let outerZoomBox = this.root.firstElementChild as HTMLElement;\n    if (!outerZoomBox) {\n      outerZoomBox = this.document.createElement(\"div\");\n      outerZoomBox.setAttribute(\"data-vivliostyle-outer-zoom-box\", \"true\");\n      outerZoomBox.role = \"presentation\";\n      this.root.appendChild(outerZoomBox);\n    }\n    let contentContainer = outerZoomBox.firstElementChild as HTMLElement;\n    if (!contentContainer) {\n      contentContainer = this.document.createElement(\"div\");\n      contentContainer.setAttribute(\n        \"data-vivliostyle-spread-container\",\n        \"true\",\n      );\n      contentContainer.role = \"presentation\";\n      outerZoomBox.appendChild(contentContainer);\n    }\n\n    if (pixelRatio > 0 && CSS.supports(\"zoom\", \"8\")) {\n      // Emulate high pixel ratio using zoom and transform:scale().\n      // Workaround for issue #419 (minimum border width too thick)\n      // and #1076 (layout depends on device pixel ratio).\n      //\n      // CSS variables --viv-outputPixelRatio, --viv-devicePixelRatio,\n      // and --viv-outputScale are used in zoom and transform property values\n      // to emulate high pixel ratio output.\n      // (see VivliostyleViewportCss in assets.ts)\n      Base.setCSSProperty(this.root, \"--viv-outputPixelRatio\", `${pixelRatio}`);\n      Base.setCSSProperty(\n        this.root,\n        \"--viv-devicePixelRatio\",\n        `${window.devicePixelRatio}`,\n      );\n\n      this.scaleRatio = pixelRatio / window.devicePixelRatio;\n    }\n\n    // Determine layout unit per CSS pixel and adjustment value needed for\n    // accurate layout of text and line boxes to avoid rounding issues\n    // based on browser type. (Issue #1590)\n    switch (Base.browserType) {\n      case \"chromium\":\n        this.layoutUnitPerPixel =\n          64 * (this.pixelRatio || window.devicePixelRatio);\n        this.layoutUnitAdj = 1 / this.layoutUnitPerPixel;\n        break;\n      case \"firefox\":\n        this.layoutUnitPerPixel = 60;\n        this.layoutUnitAdj = 1 / this.layoutUnitPerPixel;\n        break;\n      case \"webkit\":\n      default:\n        // WebKit uses 1/64 px layout unit, but it seems to floor\n        // the position values instead of rounding them,\n        // so text overflow does not occur without adjustment.\n        this.layoutUnitPerPixel = 64;\n        this.layoutUnitAdj = 0;\n    }\n    if (this.layoutUnitAdj) {\n      Base.setCSSProperty(\n        this.root,\n        \"--viv-layoutUnitAdj\",\n        `${this.layoutUnitAdj}px`,\n      );\n    }\n\n    let layoutBox = outerZoomBox.nextElementSibling as HTMLElement;\n    if (!layoutBox) {\n      layoutBox = this.document.createElement(\"div\");\n      layoutBox.setAttribute(\"data-vivliostyle-layout-box\", \"true\");\n      layoutBox.role = \"presentation\";\n      this.root.appendChild(layoutBox);\n    }\n    this.outerZoomBox = outerZoomBox;\n    this.contentContainer = contentContainer;\n    this.layoutBox = layoutBox;\n    this.width =\n      opt_width ||\n      parseFloat(window.getComputedStyle(this.root).width) ||\n      this.root.offsetWidth ||\n      window.innerWidth;\n    this.height =\n      opt_height ||\n      parseFloat(window.getComputedStyle(this.root).height) ||\n      this.root.offsetHeight ||\n      window.innerHeight;\n\n    // Use the fallbackPageSize if window size is 0 or browser is in headless mode.\n    const fallbackPageSize = {\n      // compromise between A4 (210mm 297mm) and letter (8.5in 11in)\n      width: 794, // 210mm (8.27in)\n      height: 1056, // 279.4mm (11in)\n    };\n    const isHeadlessBrowser =\n      (!window.outerWidth && !window.outerHeight) ||\n      /Headless/.test(navigator.userAgent) ||\n      (navigator.webdriver &&\n        window.innerWidth === 800 &&\n        window.innerHeight === 600);\n\n    if (!this.width || (!opt_width && isHeadlessBrowser)) {\n      this.width = fallbackPageSize.width;\n    }\n    if (!this.height || (!opt_height && isHeadlessBrowser)) {\n      this.height = fallbackPageSize.height;\n    }\n  }\n\n  /**\n   * Reset zoom.\n   */\n  resetZoom() {\n    Base.setCSSProperty(this.outerZoomBox, \"width\", \"\");\n    Base.setCSSProperty(this.outerZoomBox, \"height\", \"\");\n    Base.setCSSProperty(this.contentContainer, \"width\", \"\");\n    Base.setCSSProperty(this.contentContainer, \"height\", \"\");\n    Base.setCSSProperty(this.contentContainer, \"transform\", \"\");\n  }\n\n  /**\n   * Zoom viewport.\n   * @param width Overall width of contents before scaling (px)\n   * @param height Overall height of contents before scaling (px)\n   * @param scale Factor to which the viewport will be scaled.\n   */\n  zoom(width: number, height: number, scale: number) {\n    Base.setCSSProperty(this.root, \"--viv-outputScale\", `${scale}`);\n    Base.setCSSProperty(this.outerZoomBox, \"width\", `${width * scale}px`);\n    Base.setCSSProperty(this.outerZoomBox, \"height\", `${height * scale}px`);\n    Base.setCSSProperty(this.contentContainer, \"width\", `${width}px`);\n    Base.setCSSProperty(this.contentContainer, \"height\", `${height}px`);\n  }\n\n  /**\n   * Remove all pages inside the viewport.\n   */\n  clear() {\n    const root = this.root;\n    while (root.lastChild) {\n      root.removeChild(root.lastChild);\n    }\n  }\n}\n", "/**\n * Copyright 2013 Google, Inc.\n * Copyright 2015 Daishinsha Inc.\n * Copyright 2019 Vivliostyle Foundation\n *\n * Vivliostyle.js is free software: you can redistribute it and/or modify\n * it under the terms of the GNU Affero General Public License as published by\n * the Free Software Foundation, either version 3 of the License, or\n * (at your option) any later version.\n *\n * Vivliostyle.js is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n * GNU Affero General Public License for more details.\n *\n * You should have received a copy of the GNU Affero General Public License\n * along with Vivliostyle.js.  If not, see <http://www.gnu.org/licenses/>.\n *\n * @fileoverview XmlDoc - Utility functions to work with XML (mostly XHTML)\n * documents.\n */\nimport * as Base from \"./base\";\nimport * as Net from \"./net\";\nimport * as Task from \"./task\";\nimport { XmlDoc } from \"./types\";\n\nexport type XMLDocStore = XmlDoc.XMLDocStore;\n\nexport class XMLDocHolder implements XmlDoc.XMLDocHolder {\n  lang: string | null = null;\n  totalOffset: number = -1;\n  root: Element;\n  body: Element;\n  head: Element;\n  last: Element;\n  lastOffset: number = 1;\n  idMap: { [key: string]: Element };\n\n  constructor(\n    public readonly store: XMLDocStore,\n    public readonly url: string,\n    public readonly document: Document,\n  ) {\n    this.root = document.documentElement; // html element\n    let body: Element = null;\n    let head: Element = null;\n    if (this.root.namespaceURI == Base.NS.XHTML) {\n      for (\n        let child: Node = this.root.firstChild;\n        child;\n        child = child.nextSibling\n      ) {\n        if (child.nodeType != 1) {\n          continue;\n        }\n        const elem = child as Element;\n        if (elem.namespaceURI == Base.NS.XHTML) {\n          switch (elem.localName) {\n            case \"head\":\n              head = elem;\n              break;\n            case \"body\":\n              body = elem;\n              break;\n          }\n        }\n      }\n      this.lang = this.root.getAttribute(\"lang\");\n    }\n    this.body = body as Element;\n    this.head = head as Element;\n    this.last = this.root;\n    this.last.setAttribute(Base.ELEMENT_OFFSET_ATTR, \"0\");\n  }\n\n  doc(): XmlDoc.NodeList {\n    return new NodeList([this.document]);\n  }\n\n  getElementOffset(element: Element): number {\n    const offsetStr = element.getAttribute(Base.ELEMENT_OFFSET_ATTR);\n    if (offsetStr) {\n      return parseInt(offsetStr, 10);\n    }\n    let offset = this.lastOffset;\n    let last: Node | null = this.last;\n    while (last != element) {\n      let next: Node | null = last.firstChild;\n      if (!next) {\n        while (true) {\n          next = last.nextSibling;\n          if (next) {\n            break;\n          }\n          last = last.parentNode;\n          if (last == null) {\n            throw new Error(\"Internal error\");\n          }\n        }\n      }\n      last = next;\n      if (next.nodeType == 1) {\n        const nextElement = next as Element;\n        nextElement.setAttribute(Base.ELEMENT_OFFSET_ATTR, offset.toString());\n        ++offset;\n      } else {\n        offset += (next.textContent as string).length;\n      }\n    }\n    this.lastOffset = offset;\n    this.last = element;\n    return offset - 1;\n  }\n\n  getNodeOffset(srcNode: Node, offsetInNode: number, after: boolean) {\n    let extraOffset = 0;\n    let node: Node | null = srcNode;\n    let prev: Node | null = null;\n    if (node.nodeType == 1) {\n      // after = true is only valid for elements\n      if (!after) {\n        return this.getElementOffset(node as Element);\n      }\n    } else {\n      // offsetInNode is only valid for text nodes\n      extraOffset = offsetInNode;\n      prev = node.previousSibling;\n      if (!prev) {\n        node = node.parentNode;\n        extraOffset += 1;\n        return this.getElementOffset(node as Element) + extraOffset;\n      }\n      node = prev;\n    }\n    while (true) {\n      while (node.lastChild) {\n        node = node.lastChild;\n      }\n      if (node.nodeType == 1) {\n        // empty element\n        break;\n      }\n      extraOffset += (node.textContent as string).length;\n      prev = node.previousSibling;\n      if (!prev) {\n        node = node.parentNode;\n        break;\n      }\n      node = prev;\n    }\n    extraOffset += 1;\n    return this.getElementOffset(node as Element) + extraOffset;\n  }\n\n  getTotalOffset(): number {\n    if (this.totalOffset < 0) {\n      this.totalOffset = this.getNodeOffset(this.root, 0, true);\n    }\n    return this.totalOffset;\n  }\n\n  /**\n   * @return last node such that its offset is less or equal to the given\n   */\n  getNodeByOffset(offset: number): Node {\n    let elementOffset: number;\n\n    // First, find the last element in the document, such that\n    // this.getElementOffset(element) <= offset; if offest matches\n    // exactly, just return it.\n    let element = this.root;\n    while (true) {\n      elementOffset = this.getElementOffset(element);\n      if (elementOffset >= offset) {\n        return element;\n      }\n      const children = element.children; // Element children\n      if (!children) {\n        break;\n      }\n      const index = Base.binarySearch(children.length, (index) => {\n        const child = children[index];\n        const childOffset = this.getElementOffset(child);\n        return childOffset > offset;\n      });\n      if (index == 0) {\n        break;\n      }\n      if (VIVLIOSTYLE_DEBUG) {\n        if (index < children.length) {\n          const elemOffset = this.getElementOffset(children[index]);\n          if (elemOffset <= offset) {\n            throw new Error(\"Consistency check failed!\");\n          }\n        }\n      }\n      element = children[index - 1];\n    }\n\n    // Now we have element with offset less than desired. Find following\n    // (non-element) node with the right offset.\n    let nodeOffset = elementOffset + 1;\n    let node: Node | null = element;\n    let next: Node | null = node.firstChild || node.nextSibling;\n    let lastGood: Node | null = null;\n    while (true) {\n      if (next) {\n        if (next.nodeType == 1) {\n          break;\n        }\n        node = next;\n        lastGood = node;\n        nodeOffset += (next.textContent as string).length;\n        if (nodeOffset > offset && !/^\\s*$/.test(next.textContent)) {\n          break;\n        }\n      } else {\n        node = node.parentNode;\n        if (!node) {\n          break;\n        }\n      }\n      next = node.nextSibling;\n    }\n    if (next && lastGood && /^\\s*$/.test(lastGood.textContent)) {\n      // skip white-space text node\n      lastGood = next;\n    }\n    return lastGood || element;\n  }\n\n  private buildIdMap(e: Element): void {\n    const id = e.getAttribute(\"id\");\n    if (id && !this.idMap[id]) {\n      this.idMap[id] = e;\n    }\n    const xmlid = e.getAttributeNS(Base.NS.XML, \"id\");\n    if (xmlid && !this.idMap[xmlid]) {\n      this.idMap[xmlid] = e;\n    }\n    for (let c = e.firstElementChild; c; c = c.nextElementSibling) {\n      this.buildIdMap(c);\n    }\n  }\n\n  /**\n   * Get element by URL in the source document(s). URL must be in either '#id'\n   * or 'url#id' form.\n   */\n  getElement(url: string): Element | null {\n    const m = url.match(/([^#]*)#(.+)$/);\n    if (!m || (m[1] && m[1] != this.url)) {\n      return null;\n    }\n    const id = m[2];\n    let r: Element = this.document.getElementById(id);\n    if (!r && this.document.getElementsByName) {\n      r = this.document.getElementsByName(id)[0];\n    }\n    if (!r) {\n      if (!this.idMap) {\n        this.idMap = {};\n        this.buildIdMap(this.document.documentElement);\n      }\n      r = this.idMap[id];\n    }\n    return r;\n  }\n}\n\n/**\n * cf. https://w3c.github.io/DOM-Parsing/#the-domparser-interface\n * @enum {string}\n */\nexport enum DOMParserSupportedType {\n  TEXT_HTML = \"text/html\",\n  TEXT_XML = \"text/xml\",\n  APPLICATION_XML = \"application/xml\",\n  APPLICATION_XHTML_XML = \"application/xhtml+xml\",\n  IMAGE_SVG_XML = \"image/svg+xml\",\n}\n\n/**\n * Parses a string with a DOMParser and returns the document.\n * If a parse error occurs, return null.\n */\nexport function parseAndReturnNullIfError(\n  str: string,\n  type: string,\n  opt_parser?: DOMParser,\n): Document | null {\n  const parser = opt_parser || new DOMParser();\n  let doc: Document;\n  try {\n    doc = parser.parseFromString(str, type as DOMParserSupportedType);\n  } catch (e) {}\n  if (!doc) {\n    return null;\n  } else {\n    const docElement = doc.documentElement;\n    const errorTagName = \"parsererror\";\n    if (docElement.localName === errorTagName) {\n      return null;\n    } else {\n      for (let c = docElement.firstElementChild; c; c = c.nextElementSibling) {\n        if (c.localName === errorTagName) {\n          return null;\n        }\n      }\n    }\n  }\n  return doc;\n}\n\n/**\n * @returns null if contentType cannot be inferred from HTTP header and file\n *     extension\n */\nexport function resolveContentType(response: Net.FetchResponse): string | null {\n  const contentType = response.contentType;\n  if (contentType) {\n    const supportedKeys = Object.keys(DOMParserSupportedType);\n    for (let i = 0; i < supportedKeys.length; i++) {\n      if (DOMParserSupportedType[supportedKeys[i]] === contentType) {\n        return contentType;\n      }\n    }\n    if (contentType.match(/\\+xml$/)) {\n      return DOMParserSupportedType.APPLICATION_XML;\n    }\n  }\n  const match = response.url.match(/\\.([^./#?]+)([#?]|$)/);\n  if (match) {\n    const extension = match[1];\n    switch (extension) {\n      case \"html\":\n      case \"htm\":\n        return DOMParserSupportedType.TEXT_HTML;\n      case \"xhtml\":\n      case \"xht\":\n        return DOMParserSupportedType.APPLICATION_XHTML_XML;\n      case \"svg\":\n      case \"svgz\":\n        return DOMParserSupportedType.IMAGE_SVG_XML;\n      case \"opf\":\n      case \"xml\":\n        return DOMParserSupportedType.APPLICATION_XML;\n    }\n  }\n  return null;\n}\n\nexport function parseXMLResource(\n  response: Net.FetchResponse,\n  store: XMLDocStore,\n): Task.Result<XmlDoc.XMLDocHolder> {\n  let doc = response.responseXML;\n  if (!doc) {\n    const parser = new DOMParser();\n    const text = response.responseText;\n    if (text) {\n      const contentType = resolveContentType(response);\n      doc = parseAndReturnNullIfError(\n        text,\n        contentType || DOMParserSupportedType.APPLICATION_XML,\n        parser,\n      );\n\n      // When contentType cannot be inferred from HTTP header and file\n      // extension, we use root element's tag name to infer the contentType. If\n      // it is html or svg, we re-parse the source with an appropriate\n      // contentType.\n      if (doc && !contentType) {\n        const root = doc.documentElement;\n        if (root.localName.toLowerCase() === \"html\" && !root.namespaceURI) {\n          doc = parseAndReturnNullIfError(\n            text,\n            DOMParserSupportedType.TEXT_HTML,\n            parser,\n          );\n        } else if (\n          root.localName.toLowerCase() === \"svg\" &&\n          (doc as any).contentType !== DOMParserSupportedType.IMAGE_SVG_XML\n        ) {\n          doc = parseAndReturnNullIfError(\n            text,\n            DOMParserSupportedType.IMAGE_SVG_XML,\n            parser,\n          );\n        }\n      }\n      if (!doc) {\n        // Fallback to HTML parsing\n        doc = parseAndReturnNullIfError(\n          text,\n          DOMParserSupportedType.TEXT_HTML,\n          parser,\n        );\n      }\n    }\n  }\n  const xmldoc = doc ? new XMLDocHolder(store, response.url, doc) : null;\n  return Task.newResult(xmldoc);\n}\n\nexport function newXMLDocStore(): XMLDocStore {\n  return new Net.ResourceStore(\n    parseXMLResource,\n    Net.FetchResponseType.DOCUMENT,\n  );\n}\n\nexport class Predicate implements XmlDoc.Predicate {\n  constructor(public readonly fn: (p1: Node) => boolean) {}\n\n  check(node: Node): boolean {\n    return this.fn(node);\n  }\n\n  withAttribute(name: string, value: string): Predicate {\n    return new Predicate(\n      (node) =>\n        this.check(node) &&\n        node.nodeType == 1 &&\n        (node as Element).getAttribute(name) == value,\n    );\n  }\n\n  withChild(name: string, opt_childPredicate?: Predicate): Predicate {\n    return new Predicate((node) => {\n      if (!this.check(node)) {\n        return false;\n      }\n      let list = new NodeList([node]);\n      list = list.child(name);\n      if (opt_childPredicate) {\n        list = list.predicate(opt_childPredicate);\n      }\n      return list.size() > 0;\n    });\n  }\n}\n\nexport const predicate = new Predicate((node) => true);\n\nexport class NodeList implements XmlDoc.NodeList {\n  constructor(public readonly nodes: Node[]) {}\n\n  asArray(): Node[] {\n    return this.nodes;\n  }\n\n  size(): number {\n    return this.nodes.length;\n  }\n\n  /**\n   * Filter with predicate\n   */\n  predicate(pr: Predicate): NodeList {\n    const arr = [];\n    for (const n of this.nodes) {\n      if (pr.check(n)) {\n        arr.push(n);\n      }\n    }\n    return new NodeList(arr);\n  }\n\n  forEachNode(fn: (p1: Node, p2: (p1: Node) => void) => void): NodeList {\n    const arr = [];\n    const add = (n) => {\n      arr.push(n);\n    };\n    for (let i = 0; i < this.nodes.length; i++) {\n      fn(this.nodes[i], add);\n    }\n    return new NodeList(arr);\n  }\n\n  /**\n   * @template T\n   */\n  forEach<T>(fn: (p1: Node) => T): T[] {\n    const arr = [];\n    for (let i = 0; i < this.nodes.length; i++) {\n      arr.push(fn(this.nodes[i]));\n    }\n    return arr;\n  }\n\n  /**\n   * @template T\n   */\n  forEachNonNull<T>(fn: (p1: Node) => T): T[] {\n    const arr = [];\n    for (let i = 0; i < this.nodes.length; i++) {\n      const t = fn(this.nodes[i]);\n      if (t != null) {\n        arr.push(t);\n      }\n    }\n    return arr;\n  }\n\n  child(tag: string): NodeList {\n    return this.forEachNode((node, add) => {\n      for (let c: Node = node.firstChild; c; c = c.nextSibling) {\n        if (c.nodeType == 1 && (c as Element).localName == tag) {\n          add(c);\n        }\n      }\n    });\n  }\n\n  childElements(): NodeList {\n    return this.forEachNode((node, add) => {\n      for (let c: Node = node.firstChild; c; c = c.nextSibling) {\n        if (c.nodeType == 1) {\n          add(c);\n        }\n      }\n    });\n  }\n\n  attribute(name: string): (string | null)[] {\n    return this.forEachNonNull((node) => {\n      if (node.nodeType == 1) {\n        return (node as Element).getAttribute(name);\n      }\n      return null;\n    });\n  }\n\n  textContent(): (string | null)[] {\n    return this.forEach((node) => node.textContent);\n  }\n}\n", "/**\n * Copyright 2013 Google, Inc.\n * Copyright 2015 Daishinsha Inc.\n * Copyright 2019 Vivliostyle Foundation\n *\n * Vivliostyle.js is free software: you can redistribute it and/or modify\n * it under the terms of the GNU Affero General Public License as published by\n * the Free Software Foundation, either version 3 of the License, or\n * (at your option) any later version.\n *\n * Vivliostyle.js is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n * GNU Affero General Public License for more details.\n *\n * You should have received a copy of the GNU Affero General Public License\n * along with Vivliostyle.js.  If not, see <http://www.gnu.org/licenses/>.\n *\n * @fileoverview Ops - Render EPUB content files by applying page masters,\n * styling and layout.\n */\nimport \"./footnotes\";\nimport \"./table\";\nimport * as Asserts from \"./asserts\";\nimport * as Base from \"./base\";\nimport * as Break from \"./break\";\nimport * as Columns from \"./columns\";\nimport * as Constants from \"./constants\";\nimport * as Counters from \"./counters\";\nimport * as CounterStyle from \"./counter-style\";\nimport * as Css from \"./css\";\nimport * as CssCascade from \"./css-cascade\";\nimport * as CssParser from \"./css-parser\";\nimport * as CssProp from \"./css-prop\";\nimport * as CssStyler from \"./css-styler\";\nimport * as CssTokenizer from \"./css-tokenizer\";\nimport * as CssValidator from \"./css-validator\";\nimport * as Exprs from \"./exprs\";\nimport * as Font from \"./font\";\nimport * as GeometryUtil from \"./geometry-util\";\nimport * as Layout from \"./layout\";\nimport * as LayoutProcessor from \"./layout-processor\";\nimport * as Logging from \"./logging\";\nimport * as Net from \"./net\";\nimport * as PageFloats from \"./page-floats\";\nimport * as CssPage from \"./css-page\";\nimport * as Plugin from \"./plugin\";\nimport * as PageMaster from \"./page-master\";\nimport * as Scripts from \"./scripts\";\nimport * as Task from \"./task\";\nimport * as TaskUtil from \"./task-util\";\nimport * as TextPolyfill from \"./text-polyfill\";\nimport * as Vgen from \"./vgen\";\nimport * as Vtree from \"./vtree\";\nimport * as XmlDoc from \"./xml-doc\";\nimport { Layout as LayoutType } from \"./types\";\nimport {\n  UserAgentBaseCss,\n  UserAgentCounterStylesCss,\n  UserAgentPageCss,\n  UserAgentTocCss,\n} from \"./assets\";\n\nexport const uaStylesheetBaseFetcher: TaskUtil.Fetcher<boolean> =\n  new TaskUtil.Fetcher(() => {\n    const frame: Task.Frame<boolean> = Task.newFrame(\"uaStylesheetBase\");\n    const validatorSet = CssValidator.baseValidatorSet();\n    const url = Base.resolveURL(\"user-agent-base.css\", Base.resourceBaseURL);\n    const handler = new CssCascade.CascadeParserHandler(\n      null,\n      null,\n      null,\n      null,\n      null,\n      validatorSet,\n      true,\n    );\n    handler.startStylesheet(CssParser.StylesheetFlavor.USER_AGENT);\n    CssCascade.setUABaseCascade(handler.cascade);\n    CssParser.parseStylesheetFromText(\n      UserAgentBaseCss,\n      handler,\n      url,\n      null,\n      null,\n    ).thenFinish(frame);\n    return frame.result();\n  }, \"uaStylesheetBaseFetcher\");\n\nexport function loadUABase(): Task.Result<boolean> {\n  return uaStylesheetBaseFetcher.get();\n}\n\nexport type FontFace = {\n  properties: CssCascade.ElementStyle;\n  condition: Exprs.Val;\n};\n\nclass CounterStyleParserHandler extends CssCascade.PropSetParserHandler {\n  constructor(\n    scope: Exprs.LexicalScope,\n    owner: CssParser.DispatchParserHandler,\n    elementStyle: CssCascade.ElementStyle,\n    validatorSet: CssValidator.ValidatorSet,\n    private readonly counterStyleName: string,\n    private readonly counterStyles: CounterStyle.CounterStyleStore,\n  ) {\n    super(scope, owner, null, elementStyle, validatorSet, \"counter-style\");\n  }\n\n  override endRule(): void {\n    super.endRule();\n    if (!this.counterStyles.define(this.counterStyleName, this.elementStyle)) {\n      Logging.logger.warn(\n        `E_CSS_COUNTER_STYLE_INVALID: @counter-style ${this.counterStyleName}`,\n      );\n    }\n  }\n}\n\nexport class Style {\n  fontDeobfuscator:\n    | ((p1: string) => ((p1: Blob) => Task.Result<Blob>) | null)\n    | null;\n  validatorSet: CssValidator.ValidatorSet;\n\n  constructor(\n    public readonly store: OPSDocStore,\n    public readonly rootScope: Exprs.LexicalScope,\n    public readonly pageScope: Exprs.LexicalScope,\n    public readonly cascade: CssCascade.Cascade,\n    public readonly rootBox: PageMaster.RootPageBox,\n    public readonly fontFaces: FontFace[],\n    public readonly footnoteProps: CssCascade.ElementStyle,\n    public readonly flowProps: { [key: string]: CssCascade.ElementStyle },\n    public readonly viewportProps: CssCascade.ElementStyle[],\n    public readonly pageProps: { [key: string]: CssCascade.ElementStyle },\n    public readonly counterStyleStore: CounterStyle.CounterStyleStore,\n  ) {\n    this.fontDeobfuscator = store.fontDeobfuscator;\n    this.validatorSet = store.validatorSet;\n    this.pageScope.defineBuiltIn(\"has-content\", function (name) {\n      name = name as string;\n      const styleInstance = this as StyleInstance;\n      const cp = styleInstance.currentLayoutPosition;\n      const flowChunk = cp.firstFlowChunkOfFlow(name);\n      return (\n        styleInstance.matchPageSide(cp.startSideOfFlow(name as string)) &&\n        cp.hasContent(name as string, styleInstance.lookupOffset) &&\n        !!flowChunk &&\n        !styleInstance.flowChunkIsAfterParentFlowForcedBreak(flowChunk)\n      );\n    });\n    this.pageScope.defineName(\n      \"page-number\",\n      new Exprs.Native(\n        this.pageScope,\n        function () {\n          const styleInstance = this as StyleInstance;\n          return (\n            styleInstance.pageNumberOffset +\n            styleInstance.currentLayoutPosition.page\n          );\n        },\n        \"page-number\",\n      ),\n    );\n    this.pageScope.defineName(\n      \"blank-page\",\n      new Exprs.Native(\n        this.pageScope,\n        function () {\n          const styleInstance = this as StyleInstance;\n          const cp = styleInstance.currentLayoutPosition;\n          return cp?.isBlankPage;\n        },\n        \"blank-page\",\n      ),\n    );\n  }\n\n  sizeViewport(\n    viewportWidth: number,\n    viewportHeight: number,\n    fontSize: number,\n    pref?: Exprs.Preferences,\n  ): { width: number; height: number; fontSize: number } {\n    if (this.viewportProps.length) {\n      const context = new Exprs.Context(\n        this.rootScope,\n        viewportWidth,\n        viewportHeight,\n        fontSize,\n      );\n      const viewportProps = CssCascade.mergeAll(context, this.viewportProps);\n      const width = viewportProps[\"width\"] as CssCascade.CascadeValue;\n      const height = viewportProps[\"height\"] as CssCascade.CascadeValue;\n      const textZoom = viewportProps[\"text-zoom\"] as CssCascade.CascadeValue;\n      let scaleFactor = 1;\n      if ((width && height) || textZoom) {\n        const defaultFontSize = Exprs.defaultUnitSizes[\"em\"];\n        const zoomVal = textZoom\n          ? textZoom.evaluate(context, \"text-zoom\")\n          : null;\n        if (zoomVal === Css.ident.scale) {\n          scaleFactor = defaultFontSize / fontSize;\n          fontSize = defaultFontSize;\n          viewportWidth *= scaleFactor;\n          viewportHeight *= scaleFactor;\n        }\n        if (width && height) {\n          const widthVal = Css.toNumber(\n            width.evaluate(context, \"width\"),\n            context,\n          );\n          const heightVal = Css.toNumber(\n            height.evaluate(context, \"height\"),\n            context,\n          );\n          if (widthVal > 0 && heightVal > 0) {\n            const spreadWidth =\n              pref && pref.spreadView\n                ? (widthVal + pref.pageBorder) * 2\n                : widthVal;\n            return { width: spreadWidth, height: heightVal, fontSize };\n          }\n        }\n      }\n    }\n    return { width: viewportWidth, height: viewportHeight, fontSize };\n  }\n}\n\n//-------------------------------------------------------------------------------\nexport class StyleInstance\n  extends Exprs.Context\n  implements\n    CssStyler.FlowListener,\n    PageMaster.InstanceHolder,\n    Vgen.StylerProducer\n{\n  lang: string | null;\n  primaryFlows = { body: true } as { [key: string]: boolean };\n  rootPageBoxInstance: PageMaster.RootPageBoxInstance = null;\n  styler: CssStyler.Styler = null;\n  stylerMap: { [key: string]: CssStyler.Styler } = null;\n  currentLayoutPosition: Vtree.LayoutPosition = null;\n  layoutPositionAtPageStart: Vtree.LayoutPosition = null;\n  lookupOffset: number = 0;\n  faces: Font.DocumentFaces;\n  pageBoxInstances: { [key: string]: PageMaster.PageBoxInstance } = {};\n  pageManager: CssPage.PageManager = null;\n  private rootPageFloatLayoutContext: PageFloats.PageFloatLayoutContext;\n  pageBreaks: { [key: string]: boolean } = {};\n  pageProgression: Constants.PageProgression | null = null;\n  isVersoFirstPage: boolean = false;\n  blankPageAtStart: boolean = false;\n  pageSheetSize: { [key: string]: { width: number; height: number } } = {};\n  pageSheetHeight: number = 0;\n  pageSheetWidth: number = 0;\n\n  constructor(\n    public readonly style: Style,\n    public readonly xmldoc: XmlDoc.XMLDocHolder,\n    defaultLang: string | null,\n    public readonly viewport: Vgen.Viewport,\n    public readonly clientLayout: Vtree.ClientLayout,\n    public readonly fontMapper: Font.Mapper,\n    public readonly customRenderer: Vgen.CustomRenderer,\n    public readonly fallbackMap: { [key: string]: string },\n    public readonly pageNumberOffset: number,\n    public readonly documentURLTransformer: Base.DocumentURLTransformer,\n    public readonly counterStore: Counters.CounterStore,\n    pageProgression?: Constants.PageProgression,\n    isVersoFirstPage?: boolean,\n  ) {\n    super(style.rootScope, viewport.width, viewport.height, viewport.fontSize);\n    this.lang = xmldoc.lang || defaultLang;\n    this.faces = new Font.DocumentFaces(this.style.fontDeobfuscator);\n    this.rootPageFloatLayoutContext = new PageFloats.PageFloatLayoutContext(\n      null,\n      null,\n      null,\n      null,\n      null,\n      null,\n      null,\n    );\n    this.pageProgression = pageProgression || null;\n    this.isVersoFirstPage = !!isVersoFirstPage;\n    for (const flowName in style.flowProps) {\n      const flowStyle = style.flowProps[flowName];\n      const consume = CssCascade.getProp(flowStyle, \"flow-consume\");\n      if (consume) {\n        const consumeVal = consume.evaluate(this, \"flow-consume\");\n        if (consumeVal == Css.ident.all) {\n          this.primaryFlows[flowName] = true;\n        } else {\n          delete this.primaryFlows[flowName];\n        }\n      }\n    }\n  }\n\n  init(): Task.Result<boolean> {\n    const frame: Task.Frame<boolean> = Task.newFrame(\"StyleInstance.init\");\n    const counterListener = this.counterStore.createCounterListener(\n      this.xmldoc.url,\n    );\n    const counterResolver = this.counterStore.createCounterResolver(\n      this.xmldoc.url,\n      this.style.rootScope,\n      this.style.pageScope,\n    );\n    this.styler = new CssStyler.Styler(\n      this.xmldoc,\n      this.style.cascade,\n      this.style.rootScope,\n      this,\n      this.primaryFlows,\n      this.style.validatorSet,\n      counterListener,\n      counterResolver,\n      this.style.counterStyleStore,\n    );\n    counterResolver.setStyler(this.styler);\n    this.styler.resetFlowChunkStream(this);\n    this.stylerMap = {};\n    this.stylerMap[this.xmldoc.url] = this.styler;\n    const docElementStyle = this.styler.getTopContainerStyle();\n    if (!this.pageProgression) {\n      this.pageProgression = CssPage.resolvePageProgression(docElementStyle);\n    }\n\n    // Check the spread break at beginning of a document that may cause\n    // the first page verso side or cause a blank page (issue #666)\n    if (!this.matchStartPageSide(this.styler.breakBeforeValues[0])) {\n      if (this.pageNumberOffset === 0) {\n        this.isVersoFirstPage = true;\n      } else {\n        this.blankPageAtStart = true;\n      }\n    }\n\n    const rootBox = this.style.rootBox;\n    this.rootPageBoxInstance = new PageMaster.RootPageBoxInstance(rootBox);\n    const cascadeInstance = this.style.cascade.createInstance(\n      this,\n      counterListener,\n      counterResolver,\n      this.lang,\n      this.style.counterStyleStore,\n    );\n\n    // Named page type at first page\n    this.styler.cascade.currentPageType = this.styler.cascade.firstPageType;\n\n    this.rootPageBoxInstance.applyCascadeAndInit(\n      cascadeInstance,\n      docElementStyle,\n    );\n    this.rootPageBoxInstance.resolveAutoSizing(this);\n    this.pageManager = new CssPage.PageManager(\n      cascadeInstance,\n      this.style.pageScope,\n      this.rootPageBoxInstance,\n      this,\n      docElementStyle,\n    );\n    const srcFaces = [] as Font.Face[];\n    for (const fontFace of this.style.fontFaces) {\n      if (fontFace.condition && !fontFace.condition.evaluate(this)) {\n        continue;\n      }\n      const properties = Font.prepareProperties(fontFace.properties, this);\n      const srcFace = new Font.Face(properties);\n      srcFaces.push(srcFace);\n    }\n    this.fontMapper.findOrLoadFonts(srcFaces, this.faces).then(() => {\n      // JavaScript in HTML documents support\n      Scripts.loadScriptsInHead(\n        this.xmldoc.document,\n        this.viewport.window,\n        this.styler,\n      ).thenFinish(frame);\n    });\n\n    // Determine page sheet sizes corresponding to page selectors\n    const pageProps = this.style.pageProps;\n    if (!pageProps[\"\"]) {\n      pageProps[\"\"] = {};\n    }\n    Object.keys(pageProps).forEach((selector) => {\n      let pageStyle = pageProps[selector] as {\n        [key: string]: CssCascade.CascadeValue;\n      };\n\n      // Substitute var() in @page\n      this.styler.cascade.applyVarFilter([pageStyle], this.styler, null);\n\n      // Calculate calc()\n      this.styler.cascade.applyCalcFilter(pageStyle, this.styler.context);\n\n      const pageSizeAndBleed = CssPage.evaluatePageSizeAndBleed(\n        CssPage.resolvePageSizeAndBleed(pageStyle),\n        this,\n      );\n      this.pageSheetSize[selector] = {\n        width: pageSizeAndBleed.pageWidth + pageSizeAndBleed.cropOffset * 2,\n        height: pageSizeAndBleed.pageHeight + pageSizeAndBleed.cropOffset * 2,\n      };\n    });\n    return frame.result();\n  }\n\n  private matchStartPageSide(side: string): boolean {\n    const isRectoStart =\n      this.pageNumberOffset % 2 == (this.isVersoFirstPage ? 1 : 0);\n    const isLTR = this.pageProgression == Constants.PageProgression.LTR;\n    switch (side) {\n      case \"left\":\n        return isRectoStart !== isLTR;\n      case \"right\":\n        return isRectoStart === isLTR;\n      case \"recto\":\n        return isRectoStart;\n      case \"verso\":\n        return !isRectoStart;\n      default:\n        return true;\n    }\n  }\n\n  /** @override */\n  getStylerForDoc(xmldoc: XmlDoc.XMLDocHolder): CssStyler.AbstractStyler {\n    let styler = this.stylerMap[xmldoc.url];\n    if (!styler) {\n      const style = this.style.store.getStyleForDoc(xmldoc);\n\n      // We need a separate content, so that variables can get potentially\n      // different values.\n      const context = new Exprs.Context(\n        style.rootScope,\n        this.pageWidth(),\n        this.pageHeight(),\n        this.initialFontSize,\n      );\n      const counterListener = this.counterStore.createCounterListener(\n        xmldoc.url,\n      );\n      const counterResolver = this.counterStore.createCounterResolver(\n        xmldoc.url,\n        style.rootScope,\n        style.pageScope,\n      );\n      styler = new CssStyler.Styler(\n        xmldoc,\n        style.cascade,\n        style.rootScope,\n        context,\n        this.primaryFlows,\n        style.validatorSet,\n        counterListener,\n        counterResolver,\n        style.counterStyleStore,\n      );\n      this.stylerMap[xmldoc.url] = styler;\n    }\n    return styler;\n  }\n\n  /** @override */\n  registerInstance(key: string, instance: PageMaster.PageBoxInstance): void {\n    this.pageBoxInstances[key] = instance;\n  }\n\n  /** @override */\n  lookupInstance(key: string): PageMaster.PageBoxInstance {\n    return this.pageBoxInstances[key];\n  }\n\n  /** @override */\n  encounteredFlowChunk(flowChunk: Vtree.FlowChunk, flow: Vtree.Flow): void {\n    const cp = this.currentLayoutPosition;\n    if (cp) {\n      if (!cp.flows[flowChunk.flowName]) {\n        cp.flows[flowChunk.flowName] = flow;\n      } else {\n        flow = cp.flows[flowChunk.flowName];\n      }\n      let flowPosition = cp.flowPositions[flowChunk.flowName];\n      if (!flowPosition) {\n        flowPosition = new Vtree.FlowPosition();\n        cp.flowPositions[flowChunk.flowName] = flowPosition;\n      }\n      const nodePosition = Vtree.newNodePositionFromNode(flowChunk.element);\n      const chunkPosition = new Vtree.ChunkPosition(nodePosition);\n      const flowChunkPosition = new Vtree.FlowChunkPosition(\n        chunkPosition,\n        flowChunk,\n      );\n      flowPosition.positions.push(flowChunkPosition);\n    }\n  }\n\n  override evalSupportsTest(\n    name: string,\n    value: string,\n    isFunc: boolean,\n  ): boolean {\n    if (isFunc) {\n      if (name === \"selector\") {\n        return this.evalSupportsSelector(value);\n      }\n      return false;\n    }\n    if (!name) {\n      // `(...)` without `name:`\n      return false;\n    }\n\n    let supported = true;\n\n    class SupportsReceiver implements CssValidator.PropertyReceiver {\n      unknownProperty(name: string, value: Css.Val): void {\n        supported = false;\n      }\n      invalidPropertyValue(name: string, value: Css.Val): void {\n        supported = false;\n      }\n      simpleProperty(name: string, value: Css.Val, important): void {}\n    }\n\n    const supportsReceiver = new SupportsReceiver();\n    const val = CssParser.parseValue(\n      this.style.rootScope,\n      new CssTokenizer.Tokenizer(value, null),\n      \"\",\n    );\n    if (!val) {\n      return false;\n    }\n    const validatorSet = (this.xmldoc.store as OPSDocStore).validatorSet;\n    validatorSet.validatePropertyAndHandleShorthand(\n      name,\n      val,\n      false,\n      supportsReceiver,\n    );\n    return supported;\n  }\n\n  /**\n   * @param selectorText\n   * @returns true if selectorText is supported selector\n   */\n  private evalSupportsSelector(selectorText: string): boolean {\n    const sph = new StyleParserHandler(null);\n    const tokenizer = new CssTokenizer.Tokenizer(selectorText + \"{}\", sph);\n    const parser = new CssParser.Parser(\n      CssParser.actionsBase,\n      tokenizer,\n      sph,\n      \"\",\n    );\n    if (\n      parser.runParser(Number.POSITIVE_INFINITY, false, false, false, false)\n    ) {\n      return !sph.cascadeParserHandler.invalid;\n    }\n    return false;\n  }\n\n  getConsumedOffset(flowPosition: Vtree.FlowPosition): number {\n    let offset = Number.POSITIVE_INFINITY;\n    for (let i = 0; i < flowPosition.positions.length; i++) {\n      const pos = flowPosition.positions[i].chunkPosition.primary;\n      let node = pos.steps[0].node;\n      let offsetInNode = pos.offsetInNode;\n      let after = pos.after;\n      let k = 0;\n      while (node.ownerDocument != this.xmldoc.document) {\n        k++;\n        node = pos.steps[k].node;\n        after = false;\n        offsetInNode = 0;\n      }\n      const chunkOffset = this.xmldoc.getNodeOffset(node, offsetInNode, after);\n      if (chunkOffset < offset) {\n        offset = chunkOffset;\n      }\n    }\n    return offset;\n  }\n\n  /**\n   * @param noLookAhead Do not look ahead elements that are not styled yet\n   * @return document offset of the given layoutPosition\n   */\n  getPosition(\n    layoutPosition?: Vtree.LayoutPosition,\n    noLookAhead?: boolean,\n  ): number {\n    if (!layoutPosition) {\n      return 0;\n    }\n    let currentPosition = Number.POSITIVE_INFINITY;\n    for (const flowName in this.primaryFlows) {\n      let flowPosition = layoutPosition.flowPositions[flowName];\n      if (\n        !noLookAhead &&\n        (!flowPosition || flowPosition.positions.length == 0) &&\n        this.currentLayoutPosition\n      ) {\n        this.styler.styleUntilFlowIsReached(flowName);\n        flowPosition = this.currentLayoutPosition.flowPositions[flowName];\n        if (layoutPosition != this.currentLayoutPosition) {\n          if (flowPosition) {\n            flowPosition = flowPosition.clone();\n            layoutPosition.flowPositions[flowName] = flowPosition;\n          }\n        }\n      }\n      if (flowPosition) {\n        const consumedOffset = this.getConsumedOffset(flowPosition);\n        if (consumedOffset < currentPosition) {\n          currentPosition = consumedOffset;\n        }\n      }\n    }\n    return currentPosition;\n  }\n\n  dumpLocation(position) {\n    Logging.logger.debug(\"Location - page\", this.currentLayoutPosition.page);\n    Logging.logger.debug(\"  current:\", position);\n    Logging.logger.debug(\"  lookup:\", this.lookupOffset);\n    for (const flowName in this.currentLayoutPosition.flowPositions) {\n      const flowPosition = this.currentLayoutPosition.flowPositions[flowName];\n      for (const p of flowPosition.positions) {\n        Logging.logger.debug(\n          \"  Chunk\",\n          `${flowName}:`,\n          p.flowChunk.startOffset,\n        );\n      }\n    }\n  }\n\n  matchPageSide(side: string | null): boolean {\n    switch (side) {\n      case \"left\":\n      case \"right\":\n      case \"recto\":\n      case \"verso\":\n        return new Exprs.Named(this.style.pageScope, `${side}-page`).evaluate(\n          this,\n        ) as boolean;\n      default:\n        return true;\n    }\n  }\n\n  updateStartSide(layoutPosition: Vtree.LayoutPosition) {\n    for (const name in layoutPosition.flowPositions) {\n      const flowPos = layoutPosition.flowPositions[name];\n      if (flowPos && flowPos.positions.length > 0) {\n        const flowChunk = flowPos.positions[0].flowChunk;\n        if (this.getConsumedOffset(flowPos) === flowChunk.startOffset) {\n          const flowChunkBreakBefore =\n            flowPos.positions[0].flowChunk.breakBefore;\n          const flowBreakAfter = flowPos.startBreakType;\n          flowPos.startBreakType = Break.breakValueToStartBreakType(\n            Break.resolveEffectiveBreakValue(\n              flowBreakAfter,\n              flowChunkBreakBefore,\n            ),\n          );\n        }\n      }\n    }\n  }\n\n  /**\n   * @param cascadedPageStyle Cascaded page style specified in page context\n   */\n  selectPageMaster(\n    cascadedPageStyle: CssCascade.ElementStyle,\n  ): PageMaster.PageMasterInstance {\n    const cp = this.currentLayoutPosition;\n\n    // 3.5. Page Layout Processing Model\n    // 1. Determine current position in the document: Find the minimal\n    // consumed-offset for all elements not fully-consumed in each primary flow.\n    // Current position is maximum of the results among all primary flows.\n    const currentPosition = this.getPosition(cp);\n    if (currentPosition == Number.POSITIVE_INFINITY) {\n      // end of primary content is reached\n      return null;\n    }\n\n    // 2. Page master selection: for each page master:\n    const pageMasters = this.rootPageBoxInstance\n      .children as PageMaster.PageMasterInstance[];\n    let pageMaster: PageMaster.PageMasterInstance;\n    for (let i = 0; i < pageMasters.length; i++) {\n      pageMaster = pageMasters[i];\n\n      // Skip a page master generated for @page rules\n      if (pageMaster.pageBox.pseudoName === CssPage.pageRuleMasterPseudoName) {\n        continue;\n      }\n      let coeff = 1;\n      if (\n        pageMaster.pageBox.pseudoName ===\n          PageMaster.userAgentPageMasterPseudo &&\n        !(this.actualPageWidth && this.actualPageHeight)\n      ) {\n        // If page master is UA page master and page size is not determined,\n        // set lookup position to infinity.\n        // This is to prevent pagination problem depending on viewport size.\n        // (Fix for Issue #1228)\n        coeff = Infinity;\n      }\n\n      // A. Calculate lookup position using current position and utilization\n      // (see -epubx-utilization property)\n      const utilization = pageMaster.getProp(this, \"utilization\");\n      if (utilization && utilization.isNum()) {\n        coeff = (utilization as Css.Num).num;\n      }\n      const em = this.queryUnitSize(\"em\", false);\n      const pageArea = this.pageWidth() * this.pageHeight();\n      const lookup = Math.ceil((coeff * pageArea) / (em * em));\n\n      // B. Determine element eligibility. Each element in a flow is considered\n      // eligible if it is is not marked as fully consumed and it comes in the\n      // document before the lookup position. Feed lookupOffset and flow\n      // availability into the context\n      const savedPageType = this.styler.cascade.currentPageType;\n      this.lookupOffset = this.styler.styleUntil(currentPosition, lookup);\n      this.styler.cascade.currentPageType = savedPageType; // Fix for Issue #1450\n      Asserts.assert(cp);\n      this.updateStartSide(cp);\n\n      // update layoutPositionAtPageStart since startSide of FlowChunks may be\n      // updated\n      this.layoutPositionAtPageStart = cp.clone();\n      this.initLingering();\n      this.clearScope(this.style.pageScope);\n\n      // C. Determine content availability. Flow has content available if it\n      // contains eligible elements. D. Determine if page master is enabled\n      // using rules in Section 3.4.7\n      const enabled = pageMaster.getProp(this, \"enabled\");\n\n      // E. First enabled page master is used for the next page\n      if (!enabled || enabled === Css.ident._true) {\n        if (VIVLIOSTYLE_DEBUG) {\n          this.dumpLocation(currentPosition);\n        }\n\n        // The blank page caused by a spread break between two documents\n        // should have no margin box content (issue #666)\n        if (cp.page === 1 && this.blankPageAtStart) {\n          pageMaster.style = {}; // clear root background-color/image\n          const size = cascadedPageStyle[\"size\"];\n          cascadedPageStyle = {}; // clear margin boxes\n          if (size) {\n            // Restore page size (fix for issue #743)\n            cascadedPageStyle[\"size\"] = size;\n          }\n        }\n\n        // Apply @page rules\n        return this.pageManager.getPageRulePageMaster(\n          pageMaster,\n          cascadedPageStyle,\n        );\n      }\n    }\n    throw new Error(\"No enabled page masters\");\n  }\n\n  flowChunkIsAfterParentFlowForcedBreak(flowChunk: Vtree.FlowChunk): boolean {\n    const flows = this.layoutPositionAtPageStart.flows;\n    const parentFlowName = flows[flowChunk.flowName].parentFlowName;\n    if (parentFlowName) {\n      const startOffset = flowChunk.startOffset;\n      const forcedBreakOffsets = flows[parentFlowName].forcedBreakOffsets;\n      if (!forcedBreakOffsets.length || startOffset < forcedBreakOffsets[0]) {\n        return false;\n      }\n      const breakOffsetBeforeStartIndex =\n        Base.binarySearch(\n          forcedBreakOffsets.length,\n          (i) => forcedBreakOffsets[i] > startOffset,\n        ) - 1;\n      const breakOffsetBeforeStart =\n        forcedBreakOffsets[breakOffsetBeforeStartIndex];\n      const parentFlowPosition =\n        this.layoutPositionAtPageStart.flowPositions[parentFlowName];\n      const parentStartOffset = this.getConsumedOffset(parentFlowPosition);\n      if (breakOffsetBeforeStart < parentStartOffset) {\n        return false;\n      }\n      if (parentStartOffset < breakOffsetBeforeStart) {\n        return true;\n      }\n\n      // Special case: parentStartOffset === breakOffsetBeforeStart\n      // In this case, the flowChunk can be used if the start side of the parent\n      // flow matches the current page side.\n      return !this.matchPageSide(parentFlowPosition.startBreakType);\n    }\n    return false;\n  }\n\n  setFormattingContextToColumn(column: LayoutType.Column, flowName: string) {\n    const flow = this.currentLayoutPosition.flows[flowName];\n    if (!flow.formattingContext) {\n      flow.formattingContext = new LayoutProcessor.BlockFormattingContext(null);\n    }\n    column.flowRootFormattingContext = flow.formattingContext;\n  }\n\n  layoutDeferredPageFloats(column: LayoutType.Column): Task.Result<boolean> {\n    const pageFloatLayoutContext = column.pageFloatLayoutContext;\n    const deferredFloats =\n      pageFloatLayoutContext.getDeferredPageFloatContinuations();\n\n    // Prevent deferred page floats from appearing in the preceding pages,\n    // e.g., during re-layout the TOC page with target-counter() referencing\n    // later sections containing page floats. (Issue #681)\n    const checkPageFloatForLaterPage = (\n      float: PageFloats.PageFloat,\n    ): boolean => {\n      // FIXME: This check is incomplete when float-reference is other than \"page\".\n      // so give up for now to prevent another problem (Issue #962, #1273).\n      if (float.floatReference !== PageFloats.FloatReference.PAGE) {\n        return false;\n      }\n      const pageStartPos = this.layoutPositionAtPageStart.flowPositions.body;\n      const pageStartOffset =\n        pageStartPos && this.getConsumedOffset(pageStartPos);\n      const deferredFloatOffset = this.xmldoc.getNodeOffset(\n        float.nodePosition.steps[0].node,\n        0,\n        false,\n      );\n      return (\n        deferredFloatOffset != null &&\n        pageStartOffset != null &&\n        deferredFloatOffset > pageStartOffset\n      );\n    };\n\n    const frame = Task.newFrame<boolean>(\"layoutDeferredPageFloats\");\n    let invalidated = false;\n    let i = 0;\n    frame\n      .loopWithFrame((loopFrame) => {\n        if (i === deferredFloats.length) {\n          loopFrame.breakLoop();\n          return;\n        }\n        const continuation = deferredFloats[i++];\n        const float = continuation.float;\n\n        // Prevent deferred page floats from appearing in the preceding pages\n        // (Issue #681)\n        if (checkPageFloatForLaterPage(float)) {\n          loopFrame.breakLoop();\n          return;\n        }\n\n        const strategy =\n          new PageFloats.PageFloatLayoutStrategyResolver().findByFloat(float);\n        const pageFloatFragment = strategy.findPageFloatFragment(\n          float,\n          pageFloatLayoutContext,\n        );\n        if (pageFloatFragment && pageFloatFragment.hasFloat(float)) {\n          loopFrame.continueLoop();\n          return;\n        } else if (\n          pageFloatLayoutContext.isForbidden(float) ||\n          pageFloatLayoutContext.hasPrecedingFloatsDeferredToNext(float)\n        ) {\n          pageFloatLayoutContext.deferPageFloat(continuation);\n          loopFrame.breakLoop();\n          return;\n        }\n        column\n          .layoutPageFloatInner(continuation, strategy, null, pageFloatFragment)\n          .then((success) => {\n            if (!success) {\n              loopFrame.breakLoop();\n              return;\n            }\n            const parentInvalidated =\n              pageFloatLayoutContext.parent.isInvalidated();\n            if (parentInvalidated) {\n              loopFrame.breakLoop();\n              return;\n            } else if (\n              pageFloatLayoutContext.isInvalidated() &&\n              !parentInvalidated\n            ) {\n              invalidated = true;\n              pageFloatLayoutContext.validate();\n            }\n            loopFrame.continueLoop();\n          });\n      })\n      .then(() => {\n        if (invalidated) {\n          pageFloatLayoutContext.invalidate();\n        }\n        frame.finish(true);\n      });\n    return frame.result();\n  }\n\n  getLastAfterPositionIfDeferredFloatsExists(\n    column: LayoutType.Column,\n    newPosition: Vtree.ChunkPosition | null,\n  ): Vtree.ChunkPosition | null {\n    const pageFloatLayoutContext = column.pageFloatLayoutContext;\n    const deferredFloats =\n      pageFloatLayoutContext.getPageFloatContinuationsDeferredToNext();\n    if (deferredFloats.length > 0) {\n      if (column.lastAfterPosition) {\n        let result: Vtree.ChunkPosition;\n        if (newPosition) {\n          // Need overflown footnotes owned by newPosition\n          result = newPosition.clone();\n          result.primary = column.lastAfterPosition;\n        } else {\n          result = new Vtree.ChunkPosition(column.lastAfterPosition);\n        }\n        return result;\n      } else {\n        Asserts.assert(\"column.lastAfterPosition === null\");\n        return null;\n      }\n    } else {\n      return null;\n    }\n  }\n\n  /**\n   * @return holding true\n   */\n  layoutColumn(\n    column: LayoutType.Column,\n    flowName: string,\n  ): Task.Result<boolean> {\n    const flowPosition = this.currentLayoutPosition.flowPositions[flowName];\n    if (!flowPosition || !this.matchPageSide(flowPosition.startBreakType)) {\n      return Task.newResult(true);\n    }\n\n    this.setFormattingContextToColumn(column, flowName);\n    column.init();\n    if (this.primaryFlows[flowName] && column.bands.length > 0) {\n      // In general, we force non-fitting content. Exception is only for primary\n      // flow columns that have exclusions.\n      column.forceNonfitting = false;\n    }\n    const frame: Task.Frame<boolean> = Task.newFrame(\"layoutColumn\");\n    this.layoutDeferredPageFloats(column).then(() => {\n      if (column.pageFloatLayoutContext.isInvalidated()) {\n        frame.finish(true);\n        return;\n      }\n\n      // Record indices of repeated positions and removed positions\n      const repeatedIndices = [] as number[];\n      const removedIndices = [] as number[];\n      let leadingEdge = true;\n      frame\n        .loopWithFrame((loopFrame) => {\n          if (\n            column.pageFloatLayoutContext.hasContinuingFloatFragmentsInFlow(\n              flowName,\n            )\n          ) {\n            loopFrame.breakLoop();\n            return;\n          }\n          while (flowPosition.positions.length - removedIndices.length > 0) {\n            let index = 0;\n\n            // Skip all removed positions\n            while (removedIndices.includes(index)) {\n              index++;\n            }\n            let selected = flowPosition.positions[index];\n            if (\n              selected.flowChunk.startOffset > this.lookupOffset ||\n              this.flowChunkIsAfterParentFlowForcedBreak(selected.flowChunk)\n            ) {\n              break;\n            }\n            for (let k = index + 1; k < flowPosition.positions.length; k++) {\n              if (removedIndices.includes(k)) {\n                continue; // Skip removed positions\n              }\n              const alt = flowPosition.positions[k];\n              if (\n                alt.flowChunk.startOffset > this.lookupOffset ||\n                this.flowChunkIsAfterParentFlowForcedBreak(alt.flowChunk)\n              ) {\n                break;\n              }\n              if (alt.flowChunk.isBetter(selected.flowChunk)) {\n                selected = alt;\n                index = k;\n              }\n            }\n            const flowChunk = selected.flowChunk;\n            let pending = true;\n            column\n              .layout(\n                selected.chunkPosition,\n                leadingEdge,\n                flowPosition.breakAfter,\n              )\n              .then((newPosition) => {\n                if (column.pageFloatLayoutContext.isInvalidated()) {\n                  loopFrame.breakLoop();\n                  return;\n                }\n                leadingEdge = false;\n\n                // static: keep in the flow\n                if (\n                  selected.flowChunk.repeated &&\n                  (newPosition === null || flowChunk.exclusive)\n                ) {\n                  repeatedIndices.push(index);\n                }\n                if (flowChunk.exclusive) {\n                  // exclusive, only can have one, remove from the flow even\n                  // if it did not fit\n                  removedIndices.push(index);\n                  loopFrame.breakLoop();\n                  return;\n                } else {\n                  // not exclusive\n                  const endOfColumn = !!newPosition || !!column.pageBreakType;\n                  const lastAfterPosition =\n                    this.getLastAfterPositionIfDeferredFloatsExists(\n                      column,\n                      newPosition,\n                    );\n                  if (column.pageBreakType && lastAfterPosition) {\n                    selected.chunkPosition = lastAfterPosition;\n\n                    // TODO propagate pageBreakType\n                    flowPosition.breakAfter = column.pageBreakType;\n                    column.pageBreakType = null;\n                  } else {\n                    // go to the next element in the flow\n                    removedIndices.push(index);\n                    if (newPosition || lastAfterPosition) {\n                      // did not fit completely\n                      selected.chunkPosition = newPosition || lastAfterPosition;\n                      repeatedIndices.push(index);\n                    }\n                    // forced break or \"auto\"\n                    flowPosition.startBreakType =\n                      Break.breakValueToStartBreakType(column.pageBreakType);\n                  }\n                  if (endOfColumn) {\n                    loopFrame.breakLoop();\n                    return;\n                  }\n                }\n\n                // Since at least one flowChunk has been placed in the\n                // column, the next flowChunk of the flow can be deferred to\n                // the next partition if there is not enough space in the\n                // current partition.\n                column.forceNonfitting = false;\n                if (pending) {\n                  // Sync result\n                  pending = false;\n                } else {\n                  // Async result\n                  loopFrame.continueLoop();\n                }\n              });\n            if (pending) {\n              // Async result\n              pending = false;\n              return;\n            }\n          }\n\n          // Sync result\n          loopFrame.breakLoop();\n        })\n        .then(() => {\n          if (!column.pageFloatLayoutContext.isInvalidated()) {\n            // Keep positions repeated or not removed\n            flowPosition.positions = flowPosition.positions.filter(\n              (pos, i) =>\n                repeatedIndices.includes(i) || !removedIndices.includes(i),\n            );\n            if (flowPosition.breakAfter === \"column\") {\n              flowPosition.breakAfter = null;\n            }\n            column.saveDistanceToBlockEndFloats();\n            const edge = column.pageFloatLayoutContext.getMaxReachedAfterEdge();\n            column.updateMaxReachedAfterEdge(edge);\n          }\n          frame.finish(true);\n        });\n    });\n    return frame.result();\n  }\n\n  createLayoutConstraint(\n    pageFloatLayoutContext: PageFloats.PageFloatLayoutContext,\n  ): LayoutType.LayoutConstraint {\n    const pageIndex = this.currentLayoutPosition.page - 1;\n    const counterConstraint =\n      this.counterStore.createLayoutConstraint(pageIndex);\n    return new Layout.AllLayoutConstraint(\n      [counterConstraint].concat(pageFloatLayoutContext.getLayoutConstraints()),\n    );\n  }\n\n  private createAndLayoutColumn(\n    boxInstance: PageMaster.PageBoxInstance,\n    offsetX: number,\n    offsetY: number,\n    exclusions: GeometryUtil.Shape[],\n    layoutContainer: Vtree.Container,\n    currentColumnIndex: number,\n    flowNameStr: string,\n    regionPageFloatLayoutContext: PageFloats.PageFloatLayoutContext,\n    columnCount: number,\n    columnGap: number,\n    columnWidth: number,\n    innerShape: GeometryUtil.Shape,\n    layoutContext: Vtree.LayoutContext,\n    forceNonFitting: boolean,\n  ): Task.Result<LayoutType.Column> {\n    const dontApplyExclusions = boxInstance.vertical\n      ? boxInstance.isAutoWidth && boxInstance.isRightDependentOnAutoWidth\n      : boxInstance.isAutoHeight && boxInstance.isTopDependentOnAutoHeight;\n    const boxContainer = layoutContainer.element;\n    const columnPageFloatLayoutContext = new PageFloats.PageFloatLayoutContext(\n      regionPageFloatLayoutContext,\n      PageFloats.FloatReference.COLUMN,\n      null,\n      flowNameStr,\n      null,\n      null,\n      null,\n    );\n    const positionAtColumnStart = this.currentLayoutPosition.clone();\n    const frame: Task.Frame<LayoutType.Column> = Task.newFrame(\n      \"createAndLayoutColumn\",\n    );\n    let column: LayoutType.Column;\n    frame\n      .loopWithFrame((loopFrame) => {\n        const layoutConstraint = this.createLayoutConstraint(\n          columnPageFloatLayoutContext,\n        );\n        if (columnCount > 1) {\n          const columnContainer = this.viewport.document.createElement(\"div\");\n          Base.setCSSProperty(columnContainer, \"position\", \"absolute\");\n          boxContainer.appendChild(columnContainer);\n          column = new Layout.Column(\n            columnContainer,\n            layoutContext,\n            this.clientLayout,\n            layoutConstraint,\n            columnPageFloatLayoutContext,\n          );\n          column.forceNonfitting = forceNonFitting;\n          column.vertical = layoutContainer.vertical;\n          column.rtl = layoutContainer.rtl;\n          column.snapHeight = layoutContainer.snapHeight;\n          column.snapWidth = layoutContainer.snapWidth;\n          if (layoutContainer.vertical) {\n            const columnY =\n              (layoutContainer.rtl\n                ? columnCount - currentColumnIndex - 1\n                : currentColumnIndex) *\n                (columnWidth + columnGap) +\n              layoutContainer.paddingTop;\n            const outerWidth = parseFloat(boxContainer.style.width);\n            column.setHorizontalPosition(\n              layoutContainer.paddingLeft + outerWidth - layoutContainer.width,\n              layoutContainer.width,\n            );\n            column.setVerticalPosition(columnY, columnWidth);\n          } else {\n            const columnX =\n              (layoutContainer.rtl\n                ? columnCount - currentColumnIndex - 1\n                : currentColumnIndex) *\n                (columnWidth + columnGap) +\n              layoutContainer.paddingLeft;\n            column.setVerticalPosition(\n              layoutContainer.paddingTop,\n              layoutContainer.height,\n            );\n            column.setHorizontalPosition(columnX, columnWidth);\n          }\n          column.originX = offsetX;\n          column.originY = offsetY;\n        } else {\n          column = new Layout.Column(\n            boxContainer,\n            layoutContext,\n            this.clientLayout,\n            layoutConstraint,\n            columnPageFloatLayoutContext,\n          );\n          column.copyFrom(layoutContainer);\n        }\n        column.exclusions = dontApplyExclusions ? [] : exclusions.concat();\n        column.innerShape = innerShape;\n        columnPageFloatLayoutContext.setContainer(column);\n        if ((column.vertical ? column.height : column.width) >= 0) {\n          // column.element.style.outline = \"1px dotted green\";\n          this.layoutColumn(column, flowNameStr).then(() => {\n            if (!columnPageFloatLayoutContext.isInvalidated()) {\n              columnPageFloatLayoutContext.finish();\n            }\n            if (\n              column.pageFloatLayoutContext.isInvalidated() &&\n              !regionPageFloatLayoutContext.isInvalidated()\n            ) {\n              column.pageFloatLayoutContext.validate();\n              this.currentLayoutPosition = positionAtColumnStart.clone();\n              if (column.element !== boxContainer) {\n                boxContainer.removeChild(column.element);\n              }\n              loopFrame.continueLoop();\n            } else {\n              loopFrame.breakLoop();\n            }\n          });\n        } else {\n          columnPageFloatLayoutContext.finish();\n          loopFrame.breakLoop();\n        }\n      })\n      .then(() => {\n        frame.finish(column);\n      });\n    return frame.result();\n  }\n\n  setPagePageFloatLayoutContextContainer(\n    pagePageFloatLayoutContext: PageFloats.PageFloatLayoutContext,\n    boxInstance: PageMaster.PageBoxInstance,\n    layoutContainer: Vtree.Container,\n  ) {\n    if (\n      boxInstance instanceof CssPage.PageAreaPartitionInstance ||\n      (boxInstance instanceof PageMaster.PageMasterInstance &&\n        !(boxInstance instanceof CssPage.PageRuleMasterInstance))\n    ) {\n      pagePageFloatLayoutContext.setContainer(layoutContainer);\n    }\n  }\n\n  getRegionPageFloatLayoutContext(\n    pagePageFloatLayoutContext: PageFloats.PageFloatLayoutContext,\n    boxInstance: PageMaster.PageBoxInstance,\n    layoutContainer: Vtree.Container,\n    flowName: string,\n  ): PageFloats.PageFloatLayoutContext {\n    Asserts.assert(boxInstance instanceof PageMaster.PartitionInstance);\n    const writingMode = boxInstance.getProp(this, \"writing-mode\") || null;\n    const direction = boxInstance.getProp(this, \"direction\") || null;\n    return new PageFloats.PageFloatLayoutContext(\n      pagePageFloatLayoutContext,\n      PageFloats.FloatReference.REGION,\n      layoutContainer,\n      flowName,\n      null,\n      writingMode,\n      direction,\n    );\n  }\n\n  layoutFlowColumnsWithBalancing(\n    page: Vtree.Page,\n    boxInstance: PageMaster.PageBoxInstance,\n    offsetX: number,\n    offsetY: number,\n    exclusions: GeometryUtil.Shape[],\n    pagePageFloatLayoutContext: PageFloats.PageFloatLayoutContext,\n    layoutContainer: Vtree.Container,\n    flowNameStr: string,\n    columnCount: number,\n  ): Task.Result<LayoutType.Column[]> {\n    const positionAtContainerStart = this.currentLayoutPosition.clone();\n    const regionPageFloatLayoutContext = this.getRegionPageFloatLayoutContext(\n      pagePageFloatLayoutContext,\n      boxInstance,\n      layoutContainer,\n      flowNameStr,\n    );\n    let isFirstTime = true;\n\n    const layoutColumns = () => {\n      this.currentLayoutPosition = positionAtContainerStart.clone();\n      return this.layoutFlowColumns(\n        page,\n        boxInstance,\n        offsetX,\n        offsetY,\n        exclusions,\n        pagePageFloatLayoutContext,\n        regionPageFloatLayoutContext,\n        layoutContainer,\n        flowNameStr,\n        columnCount,\n        isFirstTime,\n      ).thenAsync((columns) => {\n        if (columns) {\n          return Task.newResult({\n            columns,\n            position: this.currentLayoutPosition,\n          });\n        } else {\n          return Task.newResult(null);\n        }\n      });\n    };\n\n    return layoutColumns().thenAsync((generatorResult) => {\n      if (!generatorResult) {\n        return Task.newResult(null);\n      }\n      if (columnCount <= 1) {\n        return Task.newResult(generatorResult.columns);\n      }\n      const columnFill =\n        (boxInstance.getProp(this, \"column-fill\") as Css.Ident) ||\n        Css.ident.balance;\n      const flowPosition =\n        this.currentLayoutPosition.flowPositions[flowNameStr];\n      Asserts.assert(flowPosition);\n      const columnBalancer = Columns.createColumnBalancer(\n        columnCount,\n        columnFill,\n        layoutColumns,\n        regionPageFloatLayoutContext,\n        layoutContainer,\n        generatorResult.columns,\n        flowPosition,\n      );\n      if (!columnBalancer) {\n        return Task.newResult(generatorResult.columns);\n      }\n      isFirstTime = false;\n      pagePageFloatLayoutContext.lock();\n      regionPageFloatLayoutContext.lock();\n      return columnBalancer\n        .balanceColumns(generatorResult)\n        .thenAsync((result) => {\n          pagePageFloatLayoutContext.unlock();\n          pagePageFloatLayoutContext.validate();\n          regionPageFloatLayoutContext.unlock();\n          this.currentLayoutPosition = result.position;\n          return Task.newResult(result.columns);\n        });\n    });\n  }\n\n  layoutFlowColumns(\n    page: Vtree.Page,\n    boxInstance: PageMaster.PageBoxInstance,\n    offsetX: number,\n    offsetY: number,\n    exclusions: GeometryUtil.Shape[],\n    pagePageFloatLayoutContext: PageFloats.PageFloatLayoutContext,\n    regionPageFloatLayoutContext: PageFloats.PageFloatLayoutContext,\n    layoutContainer: Vtree.Container,\n    flowNameStr: string,\n    columnCount: number,\n    forceNonFitting: boolean,\n  ): Task.Result<LayoutType.Column[] | null> {\n    const frame: Task.Frame<LayoutType.Column[] | null> =\n      Task.newFrame(\"layoutFlowColumns\");\n    const positionAtContainerStart = this.currentLayoutPosition.clone();\n    const columnGap = boxInstance.getPropAsNumber(this, \"column-gap\");\n\n    // Don't query columnWidth when it's not needed, so that width calculation\n    // can be delayed for width: auto columns.\n    const columnWidth =\n      columnCount > 1\n        ? boxInstance.getPropAsNumber(this, \"column-width\")\n        : layoutContainer.vertical\n          ? layoutContainer.height\n          : layoutContainer.width;\n    const regionIds = boxInstance.getActiveRegions(this);\n    const innerShapeVal = boxInstance.getProp(this, \"shape-inside\");\n    const innerShape = CssProp.toShape(\n      innerShapeVal,\n      0,\n      0,\n      layoutContainer.width,\n      layoutContainer.height,\n      this,\n    );\n    const layoutContext = new Vgen.ViewFactory(\n      flowNameStr,\n      this,\n      this.viewport,\n      this.styler,\n      regionIds,\n      this.xmldoc,\n      this.faces,\n      this.style.footnoteProps,\n      this,\n      page,\n      this.customRenderer,\n      this.fallbackMap,\n      this.documentURLTransformer,\n    );\n    let columnIndex = 0;\n    let column: LayoutType.Column = null;\n    let columns: LayoutType.Column[] = [];\n    frame\n      .loopWithFrame((loopFrame) => {\n        this.createAndLayoutColumn(\n          boxInstance,\n          offsetX,\n          offsetY,\n          exclusions,\n          layoutContainer,\n          columnIndex++,\n          flowNameStr,\n          regionPageFloatLayoutContext,\n          columnCount,\n          columnGap,\n          columnWidth,\n          innerShape,\n          layoutContext,\n          forceNonFitting,\n        ).then((c) => {\n          if (pagePageFloatLayoutContext.isInvalidated()) {\n            columns = null;\n            loopFrame.breakLoop();\n            return;\n          }\n          const forcedRegionBreak =\n            !!c.pageBreakType && c.pageBreakType !== \"column\";\n          if (\n            (forcedRegionBreak || columnIndex === columnCount) &&\n            !regionPageFloatLayoutContext.isInvalidated()\n          ) {\n            regionPageFloatLayoutContext.finish();\n          }\n          if (regionPageFloatLayoutContext.isInvalidated()) {\n            columnIndex = 0;\n            this.currentLayoutPosition = positionAtContainerStart.clone();\n            regionPageFloatLayoutContext.validate();\n            if (regionPageFloatLayoutContext.isLocked()) {\n              columns = null;\n              loopFrame.breakLoop();\n            } else {\n              loopFrame.continueLoop();\n            }\n            return;\n          }\n          column = c;\n          columns[columnIndex - 1] = column;\n          if (column.pageBreakType) {\n            if (column.pageBreakType != \"column\") {\n              // skip remaining columns\n              columnIndex = columnCount;\n              if (column.pageBreakType != \"region\") {\n                // skip remaining regions\n                this.pageBreaks[flowNameStr] = true;\n              }\n            }\n          }\n          if (columnIndex < columnCount) {\n            loopFrame.continueLoop();\n          } else {\n            loopFrame.breakLoop();\n          }\n        });\n      })\n      .then(() => {\n        frame.finish(columns);\n      });\n    return frame.result();\n  }\n\n  /**\n   * @return holding true\n   */\n  layoutContainer(\n    page: Vtree.Page,\n    boxInstance: PageMaster.PageBoxInstance,\n    parentContainer: HTMLElement,\n    offsetX: number,\n    offsetY: number,\n    exclusions: GeometryUtil.Shape[],\n    pagePageFloatLayoutContext: PageFloats.PageFloatLayoutContext,\n  ): Task.Result<boolean> {\n    boxInstance.reset();\n    const enabled = boxInstance.getProp(this, \"enabled\");\n    if (enabled && enabled !== Css.ident._true) {\n      return Task.newResult(true);\n    }\n    const frame: Task.Frame<boolean> = Task.newFrame(\"layoutContainer\");\n    const wrapFlow = boxInstance.getProp(this, \"wrap-flow\");\n    const dontExclude = wrapFlow === Css.ident.auto;\n    const flowName = boxInstance.getProp(this, \"flow-from\");\n    const boxContainer = this.viewport.document.createElement(\"div\");\n    boxContainer.role =\n      boxInstance instanceof CssPage.PageMarginBoxPartitionInstance\n        ? \"complementary\"\n        : \"presentation\";\n    const position = boxInstance.getProp(this, \"position\");\n    Base.setCSSProperty(\n      boxContainer,\n      \"position\",\n      position ? (position as any).name : \"absolute\",\n    );\n\n    // The -epubx-page-master partitions are laid out in the reverse order\n    // (see the spec http://idpf.org/epub/pgt/ ),\n    // but for css-page rules, now use forward order, i.e., the page-area first.\n    // This is necessary for running headers named strings support.\n    const forwardOrderInLayout =\n      boxInstance instanceof CssPage.PageRuleMasterInstance;\n    const forwardOrderInTree =\n      boxInstance instanceof PageMaster.PartitionInstance;\n\n    if (forwardOrderInTree) {\n      parentContainer.appendChild(boxContainer);\n    } else {\n      parentContainer.insertBefore(boxContainer, parentContainer.firstChild);\n    }\n\n    let layoutContainer = new Vtree.Container(boxContainer);\n    layoutContainer.vertical = boxInstance.vertical;\n    layoutContainer.rtl = boxInstance.rtl;\n    layoutContainer.borderBoxSizing = boxInstance.borderBoxSizing;\n    layoutContainer.exclusions = exclusions;\n    boxInstance.prepareContainer(\n      this,\n      layoutContainer,\n      page,\n      this.faces,\n      this.clientLayout,\n    );\n\n    if (\n      boxInstance instanceof CssPage.PageRuleMasterInstance &&\n      (layoutContainer.width <= 0 || layoutContainer.height <= 0)\n    ) {\n      Logging.logger.warn(\"Negative or zero page area size\");\n    }\n\n    layoutContainer.originX = offsetX;\n    layoutContainer.originY = offsetY;\n    offsetX +=\n      layoutContainer.left +\n      layoutContainer.marginLeft +\n      layoutContainer.borderLeft;\n    offsetY +=\n      layoutContainer.top +\n      layoutContainer.marginTop +\n      layoutContainer.borderTop;\n    this.setPagePageFloatLayoutContextContainer(\n      pagePageFloatLayoutContext,\n      boxInstance,\n      layoutContainer,\n    );\n    let cont: Task.Result<boolean>;\n    let removed = false;\n    if (!flowName || !flowName.isIdent()) {\n      const contentVal = boxInstance.getProp(this, \"content\");\n      if (\n        contentVal instanceof Css.Expr &&\n        contentVal.expr instanceof Exprs.Native &&\n        contentVal.expr.str.startsWith(\"running-element-\")\n      ) {\n        // Single running element\n        contentVal.visit(\n          new Vtree.ContentPropertyHandler(\n            boxContainer,\n            this,\n            contentVal,\n            this.counterStore.getExprContentListener(),\n          ),\n        );\n      } else if (Vtree.nonTrivialContent(contentVal)) {\n        let innerContainerTag = \"span\";\n        if (contentVal instanceof Css.URL) {\n          innerContainerTag = \"img\";\n        }\n        const innerContainer =\n          this.viewport.document.createElement(innerContainerTag);\n        contentVal.visit(\n          new Vtree.ContentPropertyHandler(\n            innerContainer,\n            this,\n            contentVal,\n            this.counterStore.getExprContentListener(),\n          ),\n        );\n        boxContainer.appendChild(innerContainer);\n        if (innerContainerTag == \"img\") {\n          boxInstance.transferSingleUriContentProps(\n            this,\n            innerContainer,\n            this.faces,\n          );\n        }\n        boxInstance.transferContentProps(\n          this,\n          layoutContainer,\n          page,\n          this.faces,\n        );\n        if (innerContainerTag == \"span\") {\n          // text-spacing & hanging-punctuation on margin boxes\n          TextPolyfill.processGeneratedContent(\n            innerContainer,\n            boxInstance.getProp(this, \"text-autospace\"),\n            boxInstance.getProp(this, \"text-spacing-trim\"),\n            boxInstance.getProp(this, \"hanging-punctuation\"),\n            this.lang,\n            boxInstance.vertical,\n          );\n        }\n      } else if (boxInstance.suppressEmptyBoxGeneration) {\n        parentContainer.removeChild(boxContainer);\n        removed = true;\n      }\n      if (!removed) {\n        boxInstance.finishContainer(\n          this,\n          layoutContainer,\n          page,\n          null,\n          1,\n          this.clientLayout,\n          this.faces,\n        );\n      }\n      cont = Task.newResult(true);\n    } else if (!this.pageBreaks[flowName.toString()]) {\n      const innerFrame: Task.Frame<boolean> = Task.newFrame(\n        \"layoutContainer.inner\",\n      );\n      const flowNameStr = flowName.toString();\n\n      // for now only a single column in vertical case\n      const columnCount = boxInstance.getPropAsNumber(this, \"column-count\");\n      this.layoutFlowColumnsWithBalancing(\n        page,\n        boxInstance,\n        offsetX,\n        offsetY,\n        exclusions,\n        pagePageFloatLayoutContext,\n        layoutContainer,\n        flowNameStr,\n        columnCount,\n      ).then((columns) => {\n        if (!pagePageFloatLayoutContext.isInvalidated()) {\n          const column = columns[0];\n          Asserts.assert(column);\n          if (column.element === boxContainer) {\n            layoutContainer = column;\n          }\n          layoutContainer.computedBlockSize = Math.max.apply(\n            null,\n            columns.map((c) => c.computedBlockSize),\n          );\n          boxInstance.finishContainer(\n            this,\n            layoutContainer,\n            page,\n            column,\n            columnCount,\n            this.clientLayout,\n            this.faces,\n          );\n          const flowPosition =\n            this.currentLayoutPosition.flowPositions[flowNameStr];\n          if (flowPosition && flowPosition.breakAfter === \"region\") {\n            flowPosition.breakAfter = null;\n          }\n        }\n        innerFrame.finish(true);\n      });\n      cont = innerFrame.result();\n    } else {\n      if (!pagePageFloatLayoutContext.isInvalidated()) {\n        boxInstance.finishContainer(\n          this,\n          layoutContainer,\n          page,\n          null,\n          1,\n          this.clientLayout,\n          this.faces,\n        );\n      }\n      cont = Task.newResult(true);\n    }\n    cont.then(() => {\n      if (pagePageFloatLayoutContext.isInvalidated()) {\n        frame.finish(true);\n        return;\n      }\n      if (\n        !boxInstance.isAutoHeight ||\n        Math.floor(layoutContainer.computedBlockSize) > 0\n      ) {\n        if (!removed && !dontExclude) {\n          const outerShapeProp = boxInstance.getProp(this, \"shape-outside\");\n          const outerShape = layoutContainer.getOuterShape(\n            outerShapeProp,\n            this,\n          );\n          exclusions.push(outerShape);\n        }\n      } else if (boxInstance.children.length == 0) {\n        parentContainer.removeChild(boxContainer);\n        frame.finish(true);\n        return;\n      }\n      let i = forwardOrderInLayout ? 0 : boxInstance.children.length - 1;\n      frame\n        .loop(() => {\n          while (i >= 0 && i < boxInstance.children.length) {\n            const child =\n              boxInstance.children[forwardOrderInLayout ? i++ : i--];\n            const r = this.layoutContainer(\n              page,\n              child,\n              boxContainer,\n              offsetX,\n              offsetY,\n              exclusions,\n              pagePageFloatLayoutContext,\n            );\n            if (r.isPending()) {\n              return r.thenAsync(() =>\n                Task.newResult(!pagePageFloatLayoutContext.isInvalidated()),\n              );\n            } else if (pagePageFloatLayoutContext.isInvalidated()) {\n              break;\n            }\n          }\n          return Task.newResult(false);\n        })\n        .then(() => {\n          frame.finish(true);\n        });\n    });\n    return frame.result();\n  }\n\n  processLinger(): void {\n    const pageNumber = this.currentLayoutPosition.page;\n    for (const flowName in this.currentLayoutPosition.flowPositions) {\n      const flowPosition = this.currentLayoutPosition.flowPositions[flowName];\n      for (let i = flowPosition.positions.length - 1; i >= 0; i--) {\n        const pos = flowPosition.positions[i];\n        if (\n          pos.flowChunk.startPage >= 0 &&\n          pos.flowChunk.startPage + pos.flowChunk.linger - 1 <= pageNumber\n        ) {\n          flowPosition.positions.splice(i, 1);\n        }\n      }\n    }\n  }\n\n  initLingering(): void {\n    const pageNumber = this.currentLayoutPosition.page;\n    for (const flowName in this.currentLayoutPosition.flowPositions) {\n      const flowPosition = this.currentLayoutPosition.flowPositions[flowName];\n      for (let i = flowPosition.positions.length - 1; i >= 0; i--) {\n        const pos = flowPosition.positions[i];\n        if (\n          pos.flowChunk.startPage < 0 &&\n          pos.flowChunk.startOffset < this.lookupOffset\n        ) {\n          pos.flowChunk.startPage = pageNumber;\n        }\n      }\n    }\n  }\n\n  noMorePrimaryFlows(cp: Vtree.LayoutPosition): boolean {\n    for (const flowName in this.primaryFlows) {\n      const flowPosition = cp.flowPositions[flowName];\n      if (flowPosition && flowPosition.positions.length > 0) {\n        return false;\n      }\n    }\n    return true;\n  }\n\n  layoutNextPage(\n    page: Vtree.Page,\n    cp?: Vtree.LayoutPosition,\n  ): Task.Result<Vtree.LayoutPosition> {\n    // TOC box is special page container, no pagination\n    const isTocBox = page.container === page.bleedBox;\n\n    this.pageBreaks = {};\n    if (cp) {\n      this.currentLayoutPosition = cp.clone();\n      this.styler.replayFlowElementsFromOffset(cp.highestSeenOffset);\n    } else {\n      this.currentLayoutPosition = new Vtree.LayoutPosition();\n      this.styler.replayFlowElementsFromOffset(-1);\n    }\n    if (this.lang) {\n      page.bleedBox.setAttribute(\"lang\", this.lang);\n    }\n    cp = this.currentLayoutPosition;\n\n    // Limit number of pages to prevent endless page generation\n    const LIMIT_PAGES = 10000;\n    if (cp.page > LIMIT_PAGES) {\n      throw new Error(`Too many pages generated (over ${LIMIT_PAGES} pages)`);\n    }\n\n    const startSide = cp.startSideOfFlow(\"body\");\n    cp.isBlankPage =\n      Break.isSpreadBreakValue(startSide) && this.matchPageSide(startSide);\n    page.isBlankPage = cp.isBlankPage;\n    cp.page++;\n\n    if (page.pageType == null) {\n      page.pageType =\n        (page.isBlankPage\n          ? this.styler.cascade.previousPageType\n          : this.styler.cascade.currentPageType) ?? \"\";\n      // Fix for issue #1309\n      this.styler.cascade.previousPageType =\n        this.styler.cascade.currentPageType;\n    }\n\n    this.clearScope(this.style.pageScope);\n    this.layoutPositionAtPageStart = cp.clone();\n\n    // Resolve page size before page master selection.\n    const cascadedPageStyle = isTocBox\n      ? ({} as CssCascade.ElementStyle)\n      : this.pageManager.getCascadedPageStyle(page.pageType);\n\n    // Substitute var()\n    this.styler.cascade.applyVarFilter([cascadedPageStyle], this.styler, null);\n\n    // Calculate calc()\n    this.styler.cascade.applyCalcFilter(cascadedPageStyle, this.styler.context);\n\n    if (!isTocBox) {\n      const isLeftPage = new Exprs.Named(this.style.pageScope, \"left-page\");\n      page.side = isLeftPage.evaluate(this)\n        ? Constants.PageSide.LEFT\n        : Constants.PageSide.RIGHT;\n\n      page.container.setAttribute(\n        \"data-vivliostyle-page-side\",\n        page.side as string,\n      );\n    }\n\n    const pageMaster = this.selectPageMaster(cascadedPageStyle);\n    if (!pageMaster) {\n      // end of primary content\n      return Task.newResult(null as Vtree.LayoutPosition);\n    }\n    let bleedBoxPaddingEdge = 0;\n    if (!isTocBox) {\n      page.setAutoPageWidth(\n        (pageMaster.pageBox.specified[\"width\"] as CssCascade.CascadeValue)\n          .value === Css.fullWidth,\n      );\n      page.setAutoPageHeight(\n        (pageMaster.pageBox.specified[\"height\"] as CssCascade.CascadeValue)\n          .value === Css.fullHeight,\n      );\n      this.counterStore.setCurrentPage(page);\n      this.counterStore.updatePageCounters(cascadedPageStyle, this);\n\n      // setup bleed area and crop marks\n      const evaluatedPageSizeAndBleed = CssPage.evaluatePageSizeAndBleed(\n        CssPage.resolvePageSizeAndBleed(cascadedPageStyle as any),\n        this,\n      );\n      this.setPageSizeAndBleed(evaluatedPageSizeAndBleed, page);\n\n      CssPage.addPrinterMarks(\n        cascadedPageStyle,\n        evaluatedPageSizeAndBleed,\n        page,\n        this,\n      );\n      bleedBoxPaddingEdge =\n        evaluatedPageSizeAndBleed.bleedOffset + evaluatedPageSizeAndBleed.bleed;\n    }\n\n    const writingMode =\n      (!isTocBox && pageMaster.getProp(this, \"writing-mode\")) ||\n      Css.ident.horizontal_tb;\n\n    this.pageVertical = writingMode != Css.ident.horizontal_tb;\n\n    const direction = pageMaster.getProp(this, \"direction\") || Css.ident.ltr;\n    const pageFloatLayoutContext = new PageFloats.PageFloatLayoutContext(\n      this.rootPageFloatLayoutContext,\n      PageFloats.FloatReference.PAGE,\n      null,\n      null,\n      null,\n      writingMode,\n      direction,\n    );\n    const frame: Task.Frame<Vtree.LayoutPosition> =\n      Task.newFrame(\"layoutNextPage\");\n    frame\n      .loopWithFrame((loopFrame) => {\n        // this.layoutContainer(page, pageMaster, page.bleedBox, bleedBoxPaddingEdge, bleedBoxPaddingEdge+1, // Compensate 'top: -1px' on page master\n        this.layoutContainer(\n          page,\n          pageMaster,\n          page.bleedBox,\n          bleedBoxPaddingEdge,\n          bleedBoxPaddingEdge,\n          [],\n          pageFloatLayoutContext,\n        ).then(() => {\n          if (!pageFloatLayoutContext.isInvalidated()) {\n            pageFloatLayoutContext.finish();\n          }\n          if (pageFloatLayoutContext.isInvalidated()) {\n            this.currentLayoutPosition = this.layoutPositionAtPageStart.clone();\n            pageFloatLayoutContext.validate();\n            loopFrame.continueLoop();\n          } else {\n            loopFrame.breakLoop();\n          }\n        });\n      })\n      .then(() => {\n        pageMaster.adjustPageLayout(this, page, this.clientLayout);\n        if (!isTocBox) {\n          this.processLinger();\n          cp = this.currentLayoutPosition;\n          Object.keys(cp.flowPositions).forEach((flowName) => {\n            const flowPosition = cp.flowPositions[flowName];\n            const breakAfter = flowPosition.breakAfter;\n            if (\n              breakAfter &&\n              (breakAfter === \"page\" || !this.matchPageSide(breakAfter))\n            ) {\n              flowPosition.breakAfter = null;\n            }\n          });\n        }\n        this.currentLayoutPosition = this.layoutPositionAtPageStart = null;\n        cp.highestSeenOffset = this.styler.getReachedOffset();\n        const triggers = this.style.store.getTriggersForDoc(this.xmldoc);\n        page.finish(triggers, this.clientLayout);\n        if (this.noMorePrimaryFlows(cp)) {\n          cp = null;\n        }\n        frame.finish(cp);\n      });\n    return frame.result();\n  }\n\n  /**\n   * Set actual page width, height and bleed from style specified in page\n   * context.\n   */\n  private setPageSizeAndBleed(\n    evaluatedPageSizeAndBleed: CssPage.EvaluatedPageSizeAndBleed,\n    page: Vtree.Page,\n  ) {\n    this.actualPageWidth = evaluatedPageSizeAndBleed.pageWidth;\n    this.actualPageHeight = evaluatedPageSizeAndBleed.pageHeight;\n    this.pageSheetWidth =\n      evaluatedPageSizeAndBleed.pageWidth +\n      evaluatedPageSizeAndBleed.cropOffset * 2;\n    this.pageSheetHeight =\n      evaluatedPageSizeAndBleed.pageHeight +\n      evaluatedPageSizeAndBleed.cropOffset * 2;\n    page.container.style.width = `${this.pageSheetWidth}px`;\n    page.container.style.height = `${this.pageSheetHeight}px`;\n    page.bleedBox.style.left = `${evaluatedPageSizeAndBleed.bleedOffset}px`;\n    page.bleedBox.style.right = `${evaluatedPageSizeAndBleed.bleedOffset}px`;\n    page.bleedBox.style.top = `${evaluatedPageSizeAndBleed.bleedOffset}px`;\n    page.bleedBox.style.bottom = `${evaluatedPageSizeAndBleed.bleedOffset}px`;\n    page.bleedBox.style.padding = `${evaluatedPageSizeAndBleed.bleed}px`;\n  }\n}\n\nexport class BaseParserHandler extends CssCascade.CascadeParserHandler {\n  insideRegion: boolean = false;\n\n  constructor(\n    public masterHandler: StyleParserHandler,\n    condition: Exprs.Val,\n    parent: BaseParserHandler,\n    regionId: string | null,\n  ) {\n    super(\n      masterHandler.rootScope,\n      masterHandler,\n      condition,\n      parent,\n      regionId,\n      masterHandler.validatorSet,\n      !parent,\n    );\n  }\n\n  override startPageTemplateRule(): void {}\n\n  override startPageMasterRule(\n    name: string | null,\n    pseudoName: string | null,\n    classes: string[],\n  ): void {\n    const pageMaster = new PageMaster.PageMaster(\n      this.masterHandler.pageScope,\n      name,\n      pseudoName,\n      classes,\n      this.masterHandler.rootBox,\n      this.condition,\n      this.owner.getBaseSpecificity(),\n    );\n    this.masterHandler.pushHandler(\n      new PageMaster.PageMasterParserHandler(\n        pageMaster.scope,\n        this.masterHandler,\n        pageMaster,\n        this.validatorSet,\n      ),\n    );\n  }\n\n  override startWhenRule(expr: Css.Expr): void {\n    let condition = expr.expr;\n    if (this.condition != null) {\n      condition = Exprs.and(this.scope, this.condition, condition);\n    }\n    this.masterHandler.pushHandler(\n      new BaseParserHandler(this.masterHandler, condition, this, this.regionId),\n    );\n  }\n\n  override startDefineRule(): void {\n    this.masterHandler.pushHandler(\n      new CssCascade.DefineParserHandler(this.scope, this.owner),\n    );\n  }\n\n  override startFontFaceRule(): void {\n    const properties = {} as CssCascade.ElementStyle;\n    this.masterHandler.fontFaces.push({\n      properties,\n      condition: this.condition,\n    });\n    this.masterHandler.pushHandler(\n      new CssCascade.PropSetParserHandler(\n        this.scope,\n        this.owner,\n        null,\n        properties,\n        this.masterHandler.validatorSet,\n        \"font-face\",\n      ),\n    );\n  }\n\n  override startCounterStyleRule(name: string): void {\n    this.masterHandler.pushHandler(\n      new CounterStyleParserHandler(\n        this.scope,\n        this.owner,\n        {} as CssCascade.ElementStyle,\n        this.masterHandler.validatorSet,\n        name,\n        this.masterHandler.counterStyles,\n      ),\n    );\n  }\n\n  override startFlowRule(flowName: string): void {\n    let style = this.masterHandler.flowProps[flowName];\n    if (!style) {\n      style = {} as CssCascade.ElementStyle;\n      this.masterHandler.flowProps[flowName] = style;\n    }\n    this.masterHandler.pushHandler(\n      new CssCascade.PropSetParserHandler(\n        this.scope,\n        this.owner,\n        null,\n        style,\n        this.masterHandler.validatorSet,\n      ),\n    );\n  }\n\n  override startViewportRule(): void {\n    const viewportProps = {} as CssCascade.ElementStyle;\n    this.masterHandler.viewportProps.push(viewportProps);\n    this.masterHandler.pushHandler(\n      new CssCascade.PropSetParserHandler(\n        this.scope,\n        this.owner,\n        this.condition,\n        viewportProps,\n        this.masterHandler.validatorSet,\n      ),\n    );\n  }\n\n  override startFootnoteRule(pseudoelem: string | null): void {\n    let style = this.masterHandler.footnoteProps;\n    if (pseudoelem) {\n      const pseudos = CssCascade.getMutableStyleMap(style, \"_pseudos\");\n      style = pseudos[pseudoelem];\n      if (!style) {\n        style = {} as CssCascade.ElementStyle;\n        pseudos[pseudoelem] = style;\n      }\n    }\n    this.masterHandler.pushHandler(\n      new CssCascade.PropSetParserHandler(\n        this.scope,\n        this.owner,\n        null,\n        style,\n        this.masterHandler.validatorSet,\n      ),\n    );\n  }\n\n  override startRegionRule(): void {\n    this.insideRegion = true;\n    this.startSelectorRule();\n  }\n\n  override startPageRule(): void {\n    const pageHandler = new CssPage.PageParserHandler(\n      this.masterHandler.pageScope,\n      this.masterHandler,\n      this,\n      this.validatorSet,\n      this.masterHandler.pageProps,\n    );\n    this.masterHandler.pushHandler(pageHandler);\n    pageHandler.startPageRule();\n  }\n\n  override startRuleBody(): void {\n    CssCascade.CascadeParserHandler.prototype.startRuleBody.call(this);\n    if (this.insideRegion) {\n      this.insideRegion = false;\n      const regionId = `R${this.masterHandler.regionCount++}`;\n      this.special(\"region-id\", Css.getName(regionId));\n      this.endRule();\n      const regionHandler = new BaseParserHandler(\n        this.masterHandler,\n        this.condition,\n        this,\n        regionId,\n      );\n      this.masterHandler.pushHandler(regionHandler);\n      regionHandler.startRuleBody();\n    }\n  }\n}\n\nexport class StyleParserHandler extends CssParser.DispatchParserHandler {\n  rootScope: Exprs.LexicalScope;\n  pageScope: Exprs.LexicalScope;\n  rootBox: PageMaster.RootPageBox;\n  cascadeParserHandler: BaseParserHandler;\n  regionCount: number = 0;\n  fontFaces = [] as FontFace[];\n  counterStyles = new CounterStyle.CounterStyleStore();\n  footnoteProps = {} as CssCascade.ElementStyle;\n  flowProps = {} as { [key: string]: CssCascade.ElementStyle };\n  viewportProps = [] as CssCascade.ElementStyle[];\n  pageProps = {} as { [key: string]: CssCascade.ElementStyle };\n\n  constructor(public readonly validatorSet: CssValidator.ValidatorSet) {\n    super();\n    this.rootScope = new Exprs.LexicalScope(null);\n    this.pageScope = new Exprs.LexicalScope(this.rootScope);\n    this.rootBox = new PageMaster.RootPageBox(this.rootScope);\n    this.cascadeParserHandler = new BaseParserHandler(this, null, null, null);\n    this.slave = this.cascadeParserHandler;\n  }\n}\n\nexport type StyleSource = {\n  url: string;\n  text: string | null;\n  flavor: CssParser.StylesheetFlavor;\n  classes: string | null;\n  media: string | null;\n};\n\nexport function parseOPSResource(\n  response: Net.FetchResponse,\n  store: XmlDoc.XMLDocStore,\n): Task.Result<XmlDoc.XMLDocHolder> {\n  return (store as OPSDocStore).parseOPSResource(response);\n}\n\nexport class OPSDocStore extends Net.ResourceStore<XmlDoc.XMLDocHolder> {\n  styleByKey: { [key: string]: Style } = {};\n  styleFetcherByKey: { [key: string]: TaskUtil.Fetcher<Style> } = {};\n  styleByDocURL: { [key: string]: Style } = {};\n  triggersByDocURL: { [key: string]: Vtree.Trigger[] } = {};\n  validatorSet: CssValidator.ValidatorSet = null;\n  private styleSheets: StyleSource[] = [];\n  private triggerSingleDocumentPreprocessing: boolean = false;\n\n  constructor(\n    public fontDeobfuscator:\n      | ((p1: string) => ((p1: Blob) => Task.Result<Blob>) | null)\n      | null,\n  ) {\n    super(parseOPSResource, Net.FetchResponseType.DOCUMENT);\n  }\n\n  init(\n    authorStyleSheets: { url: string | null; text: string | null }[] | null,\n    userStyleSheets: { url: string | null; text: string | null }[] | null,\n  ): Task.Result<boolean> {\n    this.setStyleSheets(authorStyleSheets as any, userStyleSheets as any);\n    const frame = Task.newFrame<boolean>(\"OPSDocStore.init\");\n    this.validatorSet = CssValidator.baseValidatorSet();\n    loadUABase().then(() => {\n      this.triggerSingleDocumentPreprocessing = true;\n      frame.finish(true);\n    });\n    return frame.result();\n  }\n\n  getStyleForDoc(xmldoc: XmlDoc.XMLDocHolder): Style {\n    return this.styleByDocURL[xmldoc.url];\n  }\n\n  getTriggersForDoc(xmldoc: XmlDoc.XMLDocHolder): Vtree.Trigger[] {\n    return this.triggersByDocURL[xmldoc.url];\n  }\n\n  /**\n   * Set author stylesheets and user stylesheets. Existing style sheets are\n   * removed.\n   */\n  private setStyleSheets(\n    authorStyleSheets: StyleSource[] | null,\n    userStyleSheets: StyleSource[] | null,\n  ) {\n    this.clearStyleSheets();\n    if (authorStyleSheets) {\n      authorStyleSheets.forEach(this.addAuthorStyleSheet, this);\n    }\n    if (userStyleSheets) {\n      userStyleSheets.forEach(this.addUserStyleSheet, this);\n    }\n  }\n\n  private clearStyleSheets() {\n    this.styleSheets.splice(0);\n  }\n\n  private addAuthorStyleSheet(stylesheet: StyleSource) {\n    let url = stylesheet.url;\n    if (url) {\n      url = Base.resolveURL(Base.convertSpecialURL(url), Base.baseURL);\n    }\n    this.styleSheets.push({\n      url,\n      text: stylesheet.text,\n      flavor: CssParser.StylesheetFlavor.AUTHOR,\n      classes: null,\n      media: null,\n    });\n  }\n\n  private addUserStyleSheet(stylesheet: StyleSource) {\n    let url = stylesheet.url;\n    if (url) {\n      url = Base.resolveURL(Base.convertSpecialURL(url), Base.baseURL);\n    }\n    this.styleSheets.push({\n      url,\n      text: stylesheet.text,\n      flavor: CssParser.StylesheetFlavor.USER,\n      classes: null,\n      media: null,\n    });\n  }\n\n  parseOPSResource(\n    response: Net.FetchResponse,\n  ): Task.Result<XmlDoc.XMLDocHolder> {\n    const frame: Task.Frame<XmlDoc.XMLDocHolder> =\n      Task.newFrame(\"OPSDocStore.load\");\n    const url = response.url;\n\n    // Hack for TOCView.showTOC()\n    const isTocBox = url.endsWith(\"?viv-toc-box\");\n\n    XmlDoc.parseXMLResource(response, this).then(\n      (xmldoc: XmlDoc.XMLDocHolder) => {\n        if (!xmldoc) {\n          frame.finish(null);\n          return;\n        }\n        if (this.triggerSingleDocumentPreprocessing) {\n          const hooks: Plugin.PreProcessSingleDocumentHook[] =\n            Plugin.getHooksForName(Plugin.HOOKS.PREPROCESS_SINGLE_DOCUMENT);\n          for (let i = 0; i < hooks.length; i++) {\n            try {\n              hooks[i](xmldoc.document);\n            } catch (e) {\n              Logging.logger.warn(\n                \"Error during single document preprocessing:\",\n                e,\n              );\n            }\n          }\n        }\n        const triggers = [];\n        const triggerList = xmldoc.document.getElementsByTagNameNS(\n          Base.NS.epub,\n          \"trigger\",\n        );\n        for (let i = 0; i < triggerList.length; i++) {\n          const triggerElem = triggerList[i];\n          const observer = triggerElem.getAttributeNS(Base.NS.EV, \"observer\");\n          const event = triggerElem.getAttributeNS(Base.NS.EV, \"event\");\n          const action = triggerElem.getAttribute(\"action\");\n          const ref = triggerElem.getAttribute(\"ref\");\n          if (observer && event && action && ref) {\n            triggers.push({ observer, event, action, ref });\n          }\n        }\n        this.triggersByDocURL[url] = triggers;\n        const sources = [] as StyleSource[];\n        sources.push({\n          url: Base.resolveURL(\"user-agent-page.css\", Base.resourceBaseURL),\n          text: UserAgentPageCss,\n          flavor: CssParser.StylesheetFlavor.USER_AGENT,\n          classes: null,\n          media: null,\n        });\n        sources.push({\n          url: Base.resolveURL(\n            \"user-agent-counter-styles.css\",\n            Base.resourceBaseURL,\n          ),\n          text: UserAgentCounterStylesCss,\n          flavor: CssParser.StylesheetFlavor.USER_AGENT,\n          classes: null,\n          media: null,\n        });\n        if (isTocBox) {\n          sources.push({\n            url: Base.resolveURL(\"user-agent-toc.css\", Base.resourceBaseURL),\n            text: UserAgentTocCss,\n            flavor: CssParser.StylesheetFlavor.USER_AGENT,\n            classes: null,\n            media: null,\n          });\n        } else {\n          const elemList =\n            xmldoc.document.querySelectorAll(\"style, link, meta\");\n          for (const elem of elemList) {\n            const ns = elem.namespaceURI;\n            const localName = elem.localName;\n            if (ns == Base.NS.XHTML) {\n              if (localName == \"style\") {\n                const classes = elem.getAttribute(\"class\");\n                const media = elem.getAttribute(\"media\");\n                const title = elem.getAttribute(\"title\");\n                sources.push({\n                  url,\n                  text: elem.textContent,\n                  flavor: CssParser.StylesheetFlavor.AUTHOR,\n                  classes: title ? classes : null,\n                  media,\n                });\n              } else if (localName == \"link\") {\n                const href = elem.getAttribute(\"href\");\n                const rel = elem.getAttribute(\"rel\")?.split(/\\s+/);\n                const classes = elem.getAttribute(\"class\");\n                const media = elem.getAttribute(\"media\");\n                if (\n                  href &&\n                  rel?.includes(\"stylesheet\") &&\n                  (!rel.includes(\"alternate\") || classes)\n                ) {\n                  const src = Base.resolveURL(href, url);\n                  const title = elem.getAttribute(\"title\");\n                  sources.push({\n                    url: src,\n                    text: null,\n                    classes: title ? classes : null,\n                    media,\n                    flavor: CssParser.StylesheetFlavor.AUTHOR,\n                  });\n                }\n              } else if (\n                localName == \"meta\" &&\n                elem.getAttribute(\"name\") == \"viewport\"\n              ) {\n                sources.push({\n                  url,\n                  text: this.processViewportMeta(elem),\n                  flavor: CssParser.StylesheetFlavor.AUTHOR,\n                  classes: null,\n                  media: null,\n                });\n              }\n            }\n          }\n          for (let i = 0; i < this.styleSheets.length; i++) {\n            sources.push(this.styleSheets[i]);\n          }\n        }\n        let key = \"\";\n        for (let i = 0; i < sources.length; i++) {\n          key += sources[i].url;\n          key += \"^\";\n          if (sources[i].text) {\n            key += sources[i].text;\n          }\n          key += \"^\";\n        }\n        let style = this.styleByKey[key];\n        if (style) {\n          this.styleByDocURL[url] = style;\n          frame.finish(xmldoc);\n          return;\n        }\n        let fetcher = this.styleFetcherByKey[key];\n        if (!fetcher) {\n          fetcher = new TaskUtil.Fetcher(() => {\n            const innerFrame: Task.Frame<Style> =\n              Task.newFrame(\"fetchStylesheet\");\n            let index = 0;\n            const sph = new StyleParserHandler(this.validatorSet);\n            innerFrame\n              .loop(() => {\n                if (index < sources.length) {\n                  const source = sources[index++];\n                  sph.startStylesheet(source.flavor);\n                  if (source.text !== null) {\n                    return CssParser.parseStylesheetFromText(\n                      source.text,\n                      sph,\n                      source.url,\n                      source.classes,\n                      source.media,\n                    ).thenReturn(true);\n                  } else {\n                    return CssParser.parseStylesheetFromURL(\n                      source.url,\n                      sph,\n                      source.classes,\n                      source.media,\n                    );\n                  }\n                }\n                return Task.newResult(false);\n              })\n              .then(() => {\n                const cascade = sph.cascadeParserHandler.finish();\n                style = new Style(\n                  this,\n                  sph.rootScope,\n                  sph.pageScope,\n                  cascade,\n                  sph.rootBox,\n                  sph.fontFaces,\n                  sph.footnoteProps,\n                  sph.flowProps,\n                  sph.viewportProps,\n                  sph.pageProps,\n                  sph.counterStyles,\n                );\n                this.styleByKey[key] = style;\n                delete this.styleFetcherByKey[key];\n                innerFrame.finish(style);\n              });\n            return innerFrame.result();\n          }, `FetchStylesheet ${url}`);\n          this.styleFetcherByKey[key] = fetcher;\n          fetcher.start();\n        }\n        fetcher.get().then((style) => {\n          this.styleByDocURL[url] = style;\n          frame.finish(xmldoc);\n        });\n      },\n    );\n    return frame.result();\n  }\n\n  processViewportMeta(meta: Element): string {\n    return \"\";\n  }\n}\n", "/**\n * Copyright 2013 Google, Inc.\n * Copyright 2015 Daishinsha Inc.\n * Copyright 2019 Vivliostyle Foundation\n *\n * Vivliostyle.js is free software: you can redistribute it and/or modify\n * it under the terms of the GNU Affero General Public License as published by\n * the Free Software Foundation, either version 3 of the License, or\n * (at your option) any later version.\n *\n * Vivliostyle.js is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n * GNU Affero General Public License for more details.\n *\n * You should have received a copy of the GNU Affero General Public License\n * along with Vivliostyle.js.  If not, see <http://www.gnu.org/licenses/>.\n *\n * @fileoverview Toc - Table of Contents view.\n */\nimport * as Base from \"./base\";\nimport * as Counters from \"./counters\";\nimport * as Css from \"./css\";\nimport * as Exprs from \"./exprs\";\nimport * as Font from \"./font\";\nimport * as OPS from \"./ops\";\nimport * as Task from \"./task\";\nimport * as Vgen from \"./vgen\";\nimport * as Vtree from \"./vtree\";\nimport * as XmlDoc from \"./xml-doc\";\n\n// closed: 25B8\n// open: 25BE\n// empty: 25B9\nexport const bulletClosed = \"\\u25b8\";\n\nexport const bulletOpen = \"\\u25be\";\n\nexport const bulletEmpty = \"\\u25b9\";\n\nexport type TOCItem = {\n  id: string;\n  title: string;\n  children: TOCItem[];\n};\n\nexport function findTocElements(doc: Document): Array<Element> {\n  // Find `<nav epub:type=\"toc\">` etc. for EPUB.\n  let tocElems = Array.from(\n    doc.querySelectorAll(\"nav[*|type],nav[epub\\\\:type]\"),\n  );\n  if (tocElems.length > 0) {\n    return tocElems;\n  }\n  // Find `role=\"doc-toc\"` for webpub.\n  tocElems = Array.from(doc.querySelectorAll(\"[role=doc-toc]\"));\n  if (tocElems.length > 0) {\n    return tocElems;\n  }\n  // If neither found, find TOC elements with the following selector.\n  const navs = \"nav,.toc,#toc,#table-of-contents,#contents,[role=directory]\";\n  for (const elem of doc.querySelectorAll(navs)) {\n    if (tocElems.find((e) => e.contains(elem))) {\n      continue; // Skip nested TOC elements.\n    }\n    let tocElem = elem;\n    if (/^h[1-6]$/.test(tocElem.localName)) {\n      // If the element is a heading, use its parent or next sibling as TOC element.\n      if (!tocElem.previousElementSibling) {\n        // If the heading is the first element, use its parent.\n        tocElem = tocElem.parentElement;\n      } else {\n        // Otherwise, use its next sibling.\n        tocElem = tocElem.nextElementSibling;\n      }\n    }\n    // TOC element must have at least one list item with an anchor element.\n    if (tocElem && tocElem.querySelector(\"li a[href]\")) {\n      tocElems.push(tocElem);\n    }\n  }\n  return tocElems;\n}\n\nexport function findTocAnchorElements(doc: Document): Array<Element> {\n  const tocElems = findTocElements(doc);\n  const anchors = [] as Array<Element>;\n  for (const tocElem of tocElems) {\n    for (const anchor of tocElem.querySelectorAll(\"li a[href]\")) {\n      anchors.push(anchor);\n    }\n  }\n  return anchors;\n}\n\nexport class TOCView implements Vgen.CustomRendererFactory {\n  pref: Exprs.Preferences;\n  page: Vtree.Page = null;\n  instance: OPS.StyleInstance = null;\n\n  constructor(\n    public readonly store: OPS.OPSDocStore,\n    public readonly url: string,\n    public readonly lang: string | null,\n    public readonly clientLayout: Vtree.ClientLayout,\n    public readonly fontMapper: Font.Mapper,\n    pref: Exprs.Preferences,\n    public readonly rendererFactory: Vgen.CustomRendererFactory,\n    public readonly fallbackMap: { [key: string]: string },\n    public readonly documentURLTransformer: Base.DocumentURLTransformer,\n    public readonly counterStore: Counters.CounterStore,\n  ) {\n    this.pref = Exprs.clonePreferences(pref);\n    this.pref.spreadView = false; // No spred view for TOC box\n  }\n\n  setAutoHeight(elem: Element, depth: number): void {\n    if (depth-- == 0) {\n      return;\n    }\n    for (let c: Node = elem.firstChild; c; c = c.nextSibling) {\n      if (c.nodeType == 1) {\n        const e = c as Element;\n        if (Base.getCSSProperty(e, \"height\", \"auto\") != \"auto\") {\n          Base.setCSSProperty(e, \"height\", \"auto\");\n          this.setAutoHeight(e, depth);\n        }\n        if (Base.getCSSProperty(e, \"position\", \"static\") == \"absolute\") {\n          Base.setCSSProperty(e, \"position\", \"relative\");\n          this.setAutoHeight(e, depth);\n        }\n      }\n    }\n  }\n\n  /** @override */\n  makeCustomRenderer(xmldoc: XmlDoc.XMLDocHolder): Vgen.CustomRenderer {\n    const renderer = this.rendererFactory.makeCustomRenderer(xmldoc);\n    return (\n      srcElem: Element,\n      viewParent: Element,\n      computedStyle: { [key: string]: Css.Val },\n    ): Task.Result<Element> => {\n      const behavior = computedStyle[\"behavior\"];\n      if (behavior) {\n        switch (behavior.toString()) {\n          case \"toc-node-anchor\":\n            computedStyle[\"color\"] = Css.ident.inherit;\n            computedStyle[\"text-decoration\"] = Css.ident.none;\n            break;\n          case \"toc-node\":\n            computedStyle[\"display\"] = Css.ident.block;\n            computedStyle[\"margin\"] = Css.numericZero;\n            computedStyle[\"padding\"] = Css.numericZero;\n            computedStyle[\"padding-inline-start\"] = new Css.Numeric(1.25, \"em\");\n            break;\n          case \"toc-node-first-child\":\n            computedStyle[\"display\"] = Css.ident.inline_block;\n            computedStyle[\"margin\"] = new Css.Numeric(0.2, \"em\");\n            computedStyle[\"vertical-align\"] = Css.ident.top;\n            computedStyle[\"color\"] = Css.ident.inherit;\n            computedStyle[\"text-decoration\"] = Css.ident.none;\n            break;\n          case \"toc-container\":\n            computedStyle[\"padding\"] = Css.numericZero;\n            break;\n        }\n      }\n      if (\n        !behavior ||\n        (behavior.toString() != \"toc-node\" &&\n          behavior.toString() != \"toc-container\")\n      ) {\n        return renderer(srcElem, viewParent, computedStyle);\n      }\n      // Remove white-space textnode that becomes unwanted space between button and anchor element.\n      const firstChild = srcElem.firstChild;\n      if (\n        firstChild &&\n        firstChild.nodeType !== 1 &&\n        Vtree.canIgnore(firstChild)\n      ) {\n        // To avoid \"Inconsistent offset\" error, create a comment node with same white-space text.\n        srcElem.replaceChild(\n          srcElem.ownerDocument.createComment(firstChild.textContent),\n          firstChild,\n        );\n      }\n      const adaptParentClass = viewParent.getAttribute(\"data-adapt-class\");\n      if (adaptParentClass == \"toc-node\") {\n        const button = viewParent.firstChild as Element;\n        if (button.textContent != bulletClosed) {\n          button.textContent = bulletClosed;\n          Base.setCSSProperty(button, \"cursor\", \"pointer\");\n          button.addEventListener(\"click\", toggleNodeExpansion, false);\n\n          button.setAttribute(\"role\", \"button\");\n          button.setAttribute(\"aria-expanded\", \"false\");\n          viewParent.setAttribute(\"aria-expanded\", \"false\");\n\n          // Enable tab move to the button unless hidden.\n          if ((viewParent as HTMLElement).style.height !== \"0px\") {\n            (button as HTMLElement).tabIndex = 0;\n          }\n        }\n      }\n      const element = viewParent.ownerDocument.createElement(\"div\");\n      element.setAttribute(\"data-adapt-process-children\", \"true\");\n      if (behavior.toString() == \"toc-node\") {\n        const button = viewParent.ownerDocument.createElement(\"div\");\n        button.textContent = bulletEmpty;\n\n        // TODO: define pseudo-element for the button?\n        Base.setCSSProperty(button, \"margin\", \"0.2em 0 0 -1em\");\n        Base.setCSSProperty(button, \"margin-inline-start\", \"-1em\");\n        Base.setCSSProperty(button, \"margin-inline-end\", \"0\");\n        Base.setCSSProperty(button, \"display\", \"inline-block\");\n        Base.setCSSProperty(button, \"width\", \"1em\");\n        Base.setCSSProperty(button, \"text-align\", \"center\");\n        Base.setCSSProperty(button, \"vertical-align\", \"top\");\n        Base.setCSSProperty(button, \"cursor\", \"default\");\n        Base.setCSSProperty(button, \"font-family\", \"Menlo,sans-serif\");\n        element.appendChild(button);\n        Base.setCSSProperty(element, \"overflow\", \"hidden\");\n        element.setAttribute(\"data-adapt-class\", \"toc-node\");\n        element.setAttribute(\"role\", \"treeitem\");\n\n        if (\n          adaptParentClass == \"toc-node\" ||\n          adaptParentClass == \"toc-container\"\n        ) {\n          Base.setCSSProperty(element, \"height\", \"0px\");\n\n          // Prevent tab move to hidden anchor.\n          const anchorElem = srcElem.firstElementChild;\n          if (anchorElem && anchorElem.localName === \"a\") {\n            (anchorElem as HTMLElement).tabIndex = -1;\n          }\n        } else {\n          viewParent.setAttribute(\"role\", \"tree\");\n        }\n      } else {\n        if (adaptParentClass == \"toc-node\") {\n          element.setAttribute(\"data-adapt-class\", \"toc-container\");\n          element.setAttribute(\"role\", \"group\");\n          element.setAttribute(\"aria-hidden\", \"true\");\n        }\n      }\n      return Task.newResult(element as Element);\n    };\n  }\n\n  showTOC(\n    elem: HTMLElement,\n    viewport: Vgen.Viewport,\n    width: number,\n    height: number,\n    fontSize: number,\n  ): Task.Result<Vtree.Page> {\n    if (this.page) {\n      return Task.newResult(this.page as Vtree.Page);\n    }\n    const frame: Task.Frame<Vtree.Page> = Task.newFrame(\"showTOC\");\n    const page = new Vtree.Page(elem, elem);\n    this.page = page;\n\n    // The (X)HTML doc for the TOC box may be reused for the TOC page in the book,\n    // but they need different styles. So, add \"?viv-toc-box\" to distinguish with TOC page URL.\n    const tocBoxUrl = Base.stripFragment(this.url) + \"?viv-toc-box\";\n\n    this.store.load(tocBoxUrl).then((xmldoc) => {\n      for (const tocElem of findTocElements(xmldoc.document)) {\n        // Set `data-vivliostyle-role=\"doc-toc\"`\n        tocElem.setAttribute(\"data-vivliostyle-role\", \"doc-toc\");\n      }\n\n      const style = this.store.getStyleForDoc(xmldoc);\n      const viewportSize = style.sizeViewport(width, 100000, fontSize);\n      viewport = new Vgen.Viewport(\n        viewport.window,\n        viewportSize.fontSize,\n        0,\n        viewport.root,\n        viewportSize.width,\n        viewportSize.height,\n      );\n      const customRenderer = this.makeCustomRenderer(xmldoc);\n      const instance = new OPS.StyleInstance(\n        style,\n        xmldoc,\n        this.lang,\n        viewport,\n        this.clientLayout,\n        this.fontMapper,\n        customRenderer,\n        this.fallbackMap,\n        0,\n        this.documentURLTransformer,\n        this.counterStore,\n      );\n      this.instance = instance;\n      instance.pref = this.pref;\n      instance.init().then(() => {\n        instance.layoutNextPage(page, null).then(() => {\n          this.setAutoHeight(elem, 2);\n          frame.finish(page);\n        });\n      });\n    });\n    return frame.result();\n  }\n\n  hideTOC(): void {\n    if (this.page) {\n      this.page.container.style.visibility = \"hidden\";\n      this.page.container.setAttribute(\"aria-hidden\", \"true\");\n    }\n  }\n\n  isTOCVisible(): boolean {\n    return !!this.page && this.page.container.style.visibility === \"visible\";\n  }\n\n  getTOC(): TOCItem[] {\n    if (!this.page) {\n      return [];\n    }\n\n    function exportTree(tag): TOCItem[] {\n      if (!tag) {\n        return [];\n      }\n      const links = tag.querySelectorAll(\":scope > [role=treeitem] > a[href]\");\n      return Array.from(links).map(exportLink);\n    }\n\n    function exportLink(tag): TOCItem {\n      const url = new URL(tag.href);\n      const [, id] = url.hash.match(/^#?(.*)$/);\n\n      const title = tag.innerText;\n\n      const container = tag.parentElement.querySelector(\"[role=group]\");\n      const children = exportTree(container);\n\n      return { id, title, children };\n    }\n\n    const topLevelTree = this.page.container.querySelector(\"[role=tree]\");\n    return exportTree(topLevelTree);\n  }\n}\n\nexport function toggleNodeExpansion(evt: Event): void {\n  const elem = evt.target as Element;\n  const open = elem.textContent == bulletClosed;\n  elem.textContent = open ? bulletOpen : bulletClosed;\n  const tocNodeElem = elem.parentNode as Element;\n  elem.setAttribute(\"aria-expanded\", open ? \"true\" : \"false\");\n  tocNodeElem.setAttribute(\"aria-expanded\", open ? \"true\" : \"false\");\n  let c: Node = tocNodeElem.firstChild;\n  while (c) {\n    if (c.nodeType === 1) {\n      const ce = c as HTMLElement;\n      const adaptClass = ce.getAttribute(\"data-adapt-class\");\n      if (adaptClass === \"toc-container\") {\n        ce.setAttribute(\"aria-hidden\", !open ? \"true\" : \"false\");\n        if (ce.firstChild) {\n          c = ce.firstChild;\n          continue;\n        }\n      } else if (adaptClass === \"toc-node\") {\n        ce.style.height = open ? \"auto\" : \"0px\";\n\n        // Update enable/disable tab move to the button and anchor.\n        if (ce.children.length >= 2) {\n          (ce.children[1] as HTMLElement).tabIndex = open ? 0 : -1;\n        }\n        if (ce.children.length >= 3) {\n          (ce.children[0] as HTMLElement).tabIndex = open ? 0 : -1;\n          if (!open) {\n            const elem1 = ce.children[0];\n            if (elem1.textContent == bulletOpen) {\n              elem1.textContent = bulletClosed;\n              elem1.setAttribute(\"aria-expanded\", \"false\");\n              ce.setAttribute(\"aria-expanded\", \"false\");\n              c = ce.children[2];\n              continue;\n            }\n          }\n        }\n      }\n    }\n    while (!c.nextSibling && c.parentNode !== tocNodeElem) {\n      c = c.parentNode;\n    }\n    c = c.nextSibling;\n  }\n  evt.stopPropagation();\n}\n", "/**\n * Copyright 2013 Google, Inc.\n * Copyright 2015 Daishinsha Inc.\n * Copyright 2018 Vivliostyle Foundation\n *\n * Vivliostyle.js is free software: you can redistribute it and/or modify\n * it under the terms of the GNU Affero General Public License as published by\n * the Free Software Foundation, either version 3 of the License, or\n * (at your option) any later version.\n *\n * Vivliostyle.js is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n * GNU Affero General Public License for more details.\n *\n * You should have received a copy of the GNU Affero General Public License\n * along with Vivliostyle.js.  If not, see <http://www.gnu.org/licenses/>.\n *\n * @fileoverview Epub - Deal with META-INF/ and .opf files in EPUB container.\n */\nimport * as Asserts from \"./asserts\";\nimport * as Base from \"./base\";\nimport * as CFI from \"./cfi\";\nimport * as Constants from \"./constants\";\nimport * as Counters from \"./counters\";\nimport * as Css from \"./css\";\nimport * as CssCascade from \"./css-cascade\";\nimport * as CssParser from \"./css-parser\";\nimport * as CssTokenizer from \"./css-tokenizer\";\nimport * as Exprs from \"./exprs\";\nimport * as Font from \"./font\";\nimport * as Logging from \"./logging\";\nimport * as Net from \"./net\";\nimport * as OPS from \"./ops\";\nimport * as Task from \"./task\";\nimport * as Toc from \"./toc\";\nimport * as Vgen from \"./vgen\";\nimport * as Vtree from \"./vtree\";\nimport * as XmlDoc from \"./xml-doc\";\n\nexport type Position = {\n  spineIndex: number;\n  pageIndex: number;\n  offsetInItem: number;\n};\n\nexport class EPUBDocStore extends OPS.OPSDocStore {\n  plainXMLStore: XmlDoc.XMLDocStore;\n  jsonStore: Net.JSONStore;\n  opfByURL: { [key: string]: OPFDoc } = {};\n  primaryOPFByEPubURL: { [key: string]: OPFDoc } = {};\n  deobfuscators: { [key: string]: (p1: Blob) => Task.Result<Blob> } = {};\n  documents: { [key: string]: Task.Result<XmlDoc.XMLDocHolder> } = {};\n\n  constructor() {\n    super(null);\n    this.fontDeobfuscator = this.makeDeobfuscatorFactory();\n    this.plainXMLStore = XmlDoc.newXMLDocStore();\n    this.jsonStore = Net.newJSONStore();\n  }\n\n  makeDeobfuscatorFactory():\n    | ((p1: string) => ((p1: Blob) => Task.Result<Blob>) | null)\n    | null {\n    return (url: string): ((p1: Blob) => Task.Result<Blob>) | null => {\n      return this.deobfuscators[url];\n    };\n  }\n\n  loadAsPlainXML(\n    url: string,\n    opt_required?: boolean,\n    opt_message?: string,\n  ): Task.Result<XmlDoc.XMLDocHolder> {\n    return this.plainXMLStore.load(\n      url,\n      opt_required,\n      opt_message,\n    ) as Task.Result<XmlDoc.XMLDocHolder>;\n  }\n\n  startLoadingAsPlainXML(url: string): void {\n    this.plainXMLStore.fetch(url);\n  }\n\n  loadAsJSON(\n    url: string,\n    opt_required?: boolean,\n    opt_message?: string,\n  ): Task.Result<Base.JSON> {\n    return this.jsonStore.load(url, opt_required, opt_message);\n  }\n\n  loadPubDoc(url: string): Task.Result<OPFDoc> {\n    const frame: Task.Frame<OPFDoc> = Task.newFrame(\"loadPubDoc\");\n\n    Net.fetchFromURL(url, null, \"HEAD\").then((response) => {\n      if (response.status >= 400) {\n        // This url can be the root of an unzipped EPUB.\n        this.loadEPUBDoc(url).then((opf) => {\n          if (opf) {\n            frame.finish(opf);\n            return;\n          }\n          Logging.logger.error(\n            `Failed to fetch a source document from ${url} (${response.status}${\n              response.statusText ? \" \" + response.statusText : \"\"\n            })`,\n          );\n          frame.finish(null);\n        });\n      } else {\n        if (\n          !response.status &&\n          !response.responseXML &&\n          !response.responseText &&\n          !response.responseBlob &&\n          !response.contentType\n        ) {\n          // Empty response\n          if (/\\/[^/.]+(?:[#?]|$)/.test(url)) {\n            // Adding trailing \"/\" may solve the problem.\n            url = url.replace(/([#?]|$)/, \"/$1\");\n          } else {\n            // Ignore empty response of HEAD request, it may become OK with GET request.\n          }\n        }\n        if (\n          response.contentType == \"application/oebps-package+xml\" ||\n          /\\.opf(?:[#?]|$)/.test(url)\n        ) {\n          // EPUB OPF\n          const [, pubURL, root] = url.match(/^((?:.*\\/)?)([^/]*)$/);\n          this.loadOPF(pubURL, root).thenFinish(frame);\n        } else if (\n          response.contentType == \"application/ld+json\" ||\n          response.contentType == \"application/webpub+json\" ||\n          response.contentType == \"application/audiobook+json\" ||\n          response.contentType == \"application/json\" ||\n          /\\.json(?:ld)?(?:[#?]|$)/.test(url)\n        ) {\n          // Web Publication Manifest\n          this.loadAsJSON(url, true).then((manifestObj) => {\n            if (!manifestObj) {\n              this.reportLoadError(url);\n              frame.finish(null);\n              return;\n            }\n            const opf = new OPFDoc(this, url);\n            opf.initWithWebPubManifest(manifestObj, undefined, url).then(() => {\n              frame.finish(opf);\n            });\n          });\n        } else {\n          // Web Publication primary entry (X)HTML\n          this.loadWebPub(url).then((opf) => {\n            if (opf) {\n              frame.finish(opf);\n              return;\n            }\n            // This url can be the root of an unzipped EPUB.\n            this.loadEPUBDoc(url).then((opf) => {\n              if (opf) {\n                frame.finish(opf);\n                return;\n              }\n              Logging.logger.error(`Failed to load ${url}.`);\n              frame.finish(null);\n            });\n          });\n        }\n      }\n    });\n    return frame.result();\n  }\n\n  loadEPUBDoc(url: string): Task.Result<OPFDoc> {\n    const frame: Task.Frame<OPFDoc> = Task.newFrame(\"loadEPUBDoc\");\n    if (!url.endsWith(\"/\")) {\n      url = url + \"/\";\n    }\n    this.startLoadingAsPlainXML(url + \"META-INF/encryption.xml\");\n    const containerURL = url + \"META-INF/container.xml\";\n    this.loadAsPlainXML(containerURL).then((containerXML) => {\n      if (containerXML) {\n        const roots = containerXML\n          .doc()\n          .child(\"container\")\n          .child(\"rootfiles\")\n          .child(\"rootfile\")\n          .attribute(\"full-path\");\n        for (const root of roots) {\n          if (root) {\n            this.loadOPF(url, root).thenFinish(frame);\n            return;\n          }\n        }\n      }\n      frame.finish(null);\n    });\n    return frame.result();\n  }\n\n  loadOPF(pubURL: string, root: string): Task.Result<OPFDoc> {\n    const url = pubURL + root;\n    let opf = this.opfByURL[url];\n    if (opf) {\n      return Task.newResult(opf);\n    }\n    const frame: Task.Frame<OPFDoc> = Task.newFrame(\"loadOPF\");\n    this.loadAsPlainXML(url, true, `Failed to fetch EPUB OPF ${url}`).then(\n      (opfXML) => {\n        if (!opfXML) {\n          this.reportLoadError(url);\n        } else {\n          opf = new OPFDoc(this, pubURL);\n          this.opfByURL[url] = opf;\n          this.primaryOPFByEPubURL[pubURL] = opf;\n          if (this.plainXMLStore.resources[pubURL + \"META-INF/container.xml\"]) {\n            this.loadAsPlainXML(pubURL + \"META-INF/encryption.xml\").then(\n              (encXML) => {\n                opf.initWithXMLDoc(opfXML, encXML).then(() => {\n                  frame.finish(opf);\n                });\n              },\n            );\n          } else {\n            // OPF file is directly specified, not via container.xml.\n            // In this case, encryption.xml is not available.\n            opf.initWithXMLDoc(opfXML, null).then(() => {\n              frame.finish(opf);\n            });\n          }\n        }\n      },\n    );\n    return frame.result();\n  }\n\n  loadWebPub(url: string): Task.Result<OPFDoc> {\n    const frame: Task.Frame<OPFDoc> = Task.newFrame(\"loadWebPub\");\n\n    // Load the primary entry page (X)HTML\n    this.load(url).then((xmldoc) => {\n      if (!xmldoc) {\n        this.reportLoadError(url);\n      } else if (\n        xmldoc.document.querySelector(\n          \"a[href='META-INF/'],a[href$='/META-INF/']\",\n        )\n      ) {\n        // This is likely the directory listing of unzipped EPUB top directory\n        frame.finish(null);\n      } else {\n        const doc = xmldoc.document;\n        const opf = new OPFDoc(this, url);\n\n        // Find manifest, W3C WebPublication or Readium Web Publication Manifest\n        const manifestLink = doc.querySelector(\n          \"link[rel='publication'],link[rel='manifest'][type='application/webpub+json']\",\n        );\n        if (manifestLink) {\n          const href = manifestLink.getAttribute(\"href\");\n          if (/^#/.test(href)) {\n            const manifestObj = Base.stringToJSON(\n              doc.getElementById(href.substr(1)).textContent,\n            );\n            opf.initWithWebPubManifest(manifestObj, doc).then(() => {\n              frame.finish(opf);\n            });\n          } else {\n            const manifestUrl = Base.resolveURL(\n              manifestLink.getAttribute(\"href\"),\n              url,\n            );\n            this.loadAsJSON(\n              manifestUrl,\n              true,\n              `Failed to fetch Publication Manifest ${manifestUrl}`,\n            ).then((manifestObj) => {\n              opf\n                .initWithWebPubManifest(manifestObj, doc, manifestUrl)\n                .then(() => {\n                  frame.finish(opf);\n                });\n            });\n          }\n        } else {\n          // No manifest\n          opf.initWithWebPubManifest({}, doc).then(() => {\n            if (opf.toc && opf.toc.src === xmldoc.url) {\n              // toc is the primary entry (X)HTML\n              if (Toc.findTocElements(doc).length === 0) {\n                // TOC is not found in the primary entry (X)HTML\n                opf.toc = null;\n              }\n            }\n            frame.finish(opf);\n          });\n        }\n      }\n    });\n    return frame.result();\n  }\n\n  addDocument(url: string, doc: Document) {\n    const frame = Task.newFrame<XmlDoc.XMLDocHolder>(\"EPUBDocStore.load\");\n    const docURL = Base.stripFragment(url);\n    const r = (this.documents[docURL] = this.parseOPSResource({\n      status: 200,\n      statusText: \"\",\n      url: docURL,\n      contentType: (doc as any).contentType,\n      responseText: null,\n      responseXML: doc,\n      responseBlob: null,\n    }));\n    r.thenFinish(frame);\n    return frame.result();\n  }\n\n  reportLoadError(docURL: string): void {\n    const removePath = (url: string) => {\n      return url.replace(/([^:/?#]|^)[/?#].*/, \"$1\");\n    };\n    const likelyCorsProblem = () => {\n      const domain = removePath(docURL);\n      if (domain === removePath(Base.baseURL)) {\n        // same domain, no CORS problem\n        return false;\n      }\n      const urls = Object.keys(this.resources);\n      if (\n        urls.find((url) => this.resources[url] && removePath(url) === domain)\n      ) {\n        // if there is an already loaded resource with the same domain, no CORS problem\n        return false;\n      }\n      if (!/^https?:?\\/\\/[^/]/.test(docURL)) {\n        // not a valid URL\n        return false;\n      }\n      if (/\\.(xhtml|xht|xml|opf)$/i.test(docURL)) {\n        // maybe, XML error\n        return false;\n      }\n      // likely, CORS problem\n      return true;\n    };\n\n    if (docURL.startsWith(\"data:\")) {\n      Logging.logger.error(`Failed to load ${docURL}. Invalid data.`);\n    } else if (\n      docURL.startsWith(\"http:\") &&\n      Base.baseURL.startsWith(\"https:\")\n    ) {\n      Logging.logger.error(\n        `Failed to load ${docURL}. Mixed Content (\"http:\" content on \"https:\" context) is not allowed.`,\n      );\n    } else if (likelyCorsProblem()) {\n      Logging.logger.error(\n        `Failed to load ${docURL}. This may be caused by the server not allowing cross-origin resource sharing (CORS).`,\n      );\n    } else {\n      Logging.logger.error(\n        `Failed to load ${docURL}. The target resource is invalid.`,\n      );\n    }\n  }\n\n  override load(url: string): Task.Result<XmlDoc.XMLDocHolder> {\n    const docURL = Base.stripFragment(url);\n    let r = this.documents[docURL];\n    if (r) {\n      return r.isPending() ? r : Task.newResult(r.get());\n    } else {\n      const frame = Task.newFrame<XmlDoc.XMLDocHolder>(\"EPUBDocStore.load\");\n      r = super.load(\n        docURL,\n        true,\n        `Failed to fetch a source document from ${docURL}`,\n      );\n      r.then((xmldoc: XmlDoc.XMLDocHolder) => {\n        if (!xmldoc) {\n          this.reportLoadError(docURL);\n        } else {\n          frame.finish(xmldoc);\n        }\n      });\n      return frame.result();\n    }\n  }\n\n  override processViewportMeta(meta: Element): string {\n    let content = meta.getAttribute(\"content\");\n    if (!content) {\n      return \"\";\n    }\n    const vals = {};\n    let r: RegExpMatchArray;\n    while (\n      (r = content.match(\n        /^,?\\s*([-A-Za-z_.][-A-Za-z_0-9.]*)\\s*=\\s*([-+A-Za-z_0-9.]*)\\s*/,\n      )) != null\n    ) {\n      content = content.substr(r[0].length);\n      vals[r[1]] = r[2];\n    }\n    const width = vals[\"width\"] - 0;\n    const height = vals[\"height\"] - 0;\n    if (width && height) {\n      const prePaginated = !!Object.values(this.primaryOPFByEPubURL).find(\n        (opf) => opf.prePaginated,\n      );\n      return (\n        `@-epubx-viewport{width:${width}px;height:${height}px;}` +\n        (prePaginated\n          ? `@page{size:${width}px ${height}px;margin:0;}`\n          : `@page{margin:0;}`)\n      );\n    }\n    return \"\";\n  }\n}\n\nexport type OPFItemParam = {\n  url: string;\n  index: number;\n  startPage: number | null;\n  skipPagesBefore: number | null;\n};\n\nexport class OPFItem {\n  id: string | null = null;\n  src: string = \"\";\n  mediaType: string | null = null;\n  title: string | null = null;\n  itemRefElement: Element | null = null;\n  spineIndex: number = -1;\n  compressedSize: number = 0;\n  compressed: boolean | null = null;\n  epage: number = 0;\n  epageCount: number = 0;\n  startPage: number | null = null;\n  skipPagesBefore: number | null = null;\n  itemProperties: { [key: string]: boolean };\n\n  constructor() {\n    this.itemProperties = Base.emptyObj;\n  }\n\n  initWithElement(itemElem: Element, opfURL: string): void {\n    this.id = itemElem.getAttribute(\"id\");\n    this.src = Base.resolveURL(itemElem.getAttribute(\"href\"), opfURL);\n    this.mediaType = itemElem.getAttribute(\"media-type\");\n    const propStr = itemElem.getAttribute(\"properties\");\n    if (propStr) {\n      this.itemProperties = Base.arrayToSet(propStr.split(/\\s+/));\n    }\n  }\n\n  initWithParam(param: OPFItemParam) {\n    this.spineIndex = param.index;\n    this.id = `item${param.index + 1}`;\n    this.src = param.url;\n    this.startPage = param.startPage;\n    this.skipPagesBefore = param.skipPagesBefore;\n  }\n}\n\nexport function getOPFItemId(item: OPFItem): string | null {\n  return item.id;\n}\n\nexport function makeDeobfuscator(uid: string): (p1: Blob) => Task.Result<Blob> {\n  return (blob) => {\n    const frame = Task.newFrame(\"deobfuscator\") as Task.Frame<Blob>;\n    makeDigest(\"SHA-1\", uid).then((hash) => {\n      const head = blob.slice(0, 1040);\n      const tail = blob.slice(1040, blob.size);\n      Net.readBlob(head).then((buf) => {\n        const dataView = new DataView(buf);\n        for (let k = 0; k < dataView.byteLength; k++) {\n          let b = dataView.getUint8(k);\n          b ^= hash[k % 20];\n          dataView.setUint8(k, b);\n        }\n        frame.finish(Net.makeBlob([dataView, tail]));\n      });\n    });\n    return frame.result();\n  };\n}\n\nfunction makeDigest(algorithm: string, str: string): Task.Result<Uint8Array> {\n  const frame = Task.newFrame(\"makeDigest\") as Task.Frame<Uint8Array>;\n  const continuation = frame.suspend();\n  window.crypto.subtle\n    .digest(algorithm, new TextEncoder().encode(str))\n    .then((buf) => {\n      continuation.schedule(new Uint8Array(buf));\n    });\n  return frame.result();\n}\n\ntype RawMeta = {\n  [key: string]: RawMetaItem[];\n};\n\ntype RawMetaItem = {\n  name: string;\n  value: string;\n  id: string | null;\n  refines: string | null;\n  scheme: string | null;\n  lang: string | null;\n  order: number;\n  role: string | null;\n};\n\nexport interface Meta {\n  [key: string]: MetaItem[];\n}\n\nexport interface MetaItem {\n  v: string;\n  o?: number;\n  s?: string;\n  r?: Meta;\n}\n\nexport const predefinedPrefixes = {\n  dcterms: \"http://purl.org/dc/terms/\",\n  marc: \"http://id.loc.gov/vocabulary/\",\n  media: \"http://www.idpf.org/epub/vocab/overlays/#\",\n  rendition: \"http://www.idpf.org/vocab/rendition/#\",\n  onix: \"http://www.editeur.org/ONIX/book/codelists/current.html#\",\n  xsd: \"http://www.w3.org/2001/XMLSchema#\",\n  opf: \"http://www.idpf.org/2007/opf\",\n};\n\nexport const defaultIRI = \"http://idpf.org/epub/vocab/package/meta/#\";\n\nexport const metaTerms = {\n  language: `${predefinedPrefixes[\"dcterms\"]}language`,\n  title: `${predefinedPrefixes[\"dcterms\"]}title`,\n  creator: `${predefinedPrefixes[\"dcterms\"]}creator`,\n  layout: `${predefinedPrefixes[\"rendition\"]}layout`,\n  titleType: `${defaultIRI}title-type`,\n  displaySeq: `${defaultIRI}display-seq`,\n  alternateScript: `${defaultIRI}alternate-script`,\n  role: `${defaultIRI}role`,\n};\n\nexport function getMetadataComparator(\n  term: string,\n  lang: string,\n): (p1: MetaItem, p2: MetaItem) => number {\n  const empty = {};\n  return (item1, item2) => {\n    let m1: boolean;\n    let m2: boolean;\n    const r1 = item1[\"r\"] || empty;\n    const r2 = item2[\"r\"] || empty;\n    if (term == metaTerms.title) {\n      m1 = r1[metaTerms.titleType]?.[0].v == \"main\";\n      m2 = r2[metaTerms.titleType]?.[0].v == \"main\";\n      if (m1 != m2) {\n        return m1 ? -1 : 1;\n      }\n    }\n    let i1 = parseInt(r1[metaTerms.displaySeq]?.[0].v, 10);\n    if (isNaN(i1)) {\n      i1 = Number.MAX_VALUE;\n    }\n    let i2 = parseInt(r2[metaTerms.displaySeq]?.[0].v, 10);\n    if (isNaN(i2)) {\n      i2 = Number.MAX_VALUE;\n    }\n    if (i1 != i2) {\n      return i1 - i2;\n    }\n    if (term != metaTerms.language && lang) {\n      m1 =\n        (r1[metaTerms.language] || r1[metaTerms.alternateScript])?.[0].v ==\n        lang;\n      m2 =\n        (r2[metaTerms.language] || r2[metaTerms.alternateScript])?.[0].v ==\n        lang;\n      if (m1 != m2) {\n        return m1 ? -1 : 1;\n      }\n    }\n    return item1[\"o\"] - item2[\"o\"];\n  };\n}\n\nexport function readMetadata(\n  mroot: XmlDoc.NodeList,\n  prefixes: string | null,\n): Meta {\n  // Parse prefix map (if any)\n  let prefixMap;\n  if (!prefixes) {\n    prefixMap = predefinedPrefixes;\n  } else {\n    prefixMap = {};\n    for (const pn in predefinedPrefixes) {\n      prefixMap[pn] = predefinedPrefixes[pn];\n    }\n    let r: RegExpMatchArray;\n\n    // This code permits any non-ASCII characters in the name to avoid bloating\n    // the pattern.\n    while (\n      (r = prefixes.match(\n        /^\\s*([A-Z_a-z\\u007F-\\uFFFF][-.A-Z_a-z0-9\\u007F-\\uFFFF]*):\\s*(\\S+)/,\n      )) != null\n    ) {\n      prefixes = prefixes.substr(r[0].length);\n      prefixMap[r[1]] = r[2];\n    }\n  }\n  const resolveProperty = (val: string | null): string | null => {\n    if (val) {\n      const r = val.match(/^\\s*(([^:]*):)?(\\S+)\\s*$/);\n      if (r) {\n        const iri = r[2] ? prefixMap[r[2]] : defaultIRI;\n        if (iri) {\n          return iri + r[3];\n        }\n      }\n    }\n    return null;\n  };\n  let order = 1;\n\n  // List of metadata items.\n  const rawItems = mroot.childElements().forEachNonNull((node: Element) => {\n    if (node.localName == \"meta\") {\n      const p = resolveProperty(node.getAttribute(\"property\"));\n      if (p) {\n        return {\n          name: p,\n          value: node.textContent,\n          id: node.getAttribute(\"id\"),\n          order: order++,\n          refines: node.getAttribute(\"refines\"),\n          lang: null,\n          scheme: resolveProperty(node.getAttribute(\"scheme\")),\n          role: null,\n        };\n      }\n    } else if (node.namespaceURI == Base.NS.DC) {\n      return {\n        name: predefinedPrefixes[\"dcterms\"] + node.localName,\n        order: order++,\n        lang: node.getAttribute(\"xml:lang\"),\n        value: node.textContent,\n        id: node.getAttribute(\"id\"),\n        refines: null,\n        scheme: null,\n        role: node.getAttribute(\"role\") || node.getAttribute(\"opf:role\"),\n      };\n    }\n    return null;\n  });\n\n  // Items grouped by their target id.\n  const rawItemsByTarget = Base.multiIndexArray(\n    rawItems,\n    (rawItem) => rawItem.refines,\n  );\n  const makeMetadata = (map: RawMeta): Meta =>\n    Base.mapObj(map, (rawItemArr, _itemName) =>\n      rawItemArr.map((rawItem) => {\n        const entry = { v: rawItem.value, o: rawItem.order };\n        if (rawItem.scheme) {\n          entry[\"s\"] = rawItem.scheme;\n        }\n        let refs = rawItemsByTarget[`#${rawItem.id}`] || [];\n        if (refs.length || rawItem.lang || rawItem.role) {\n          if (rawItem.lang) {\n            // Special handling for xml:lang\n            refs.push({\n              name: metaTerms.language,\n              value: rawItem.lang,\n              lang: null,\n              id: null,\n              refines: rawItem.id,\n              scheme: null,\n              order: rawItem.order,\n              role: null,\n            });\n          }\n          if (rawItem.role) {\n            // Special handling for opf:role\n            refs.push({\n              name: metaTerms.role,\n              value: rawItem.role,\n              lang: null,\n              id: null,\n              refines: rawItem.id,\n              scheme: null,\n              order: rawItem.order,\n              role: null,\n            });\n          }\n          const entryMap = Base.multiIndexArray(\n            refs,\n            (rawItem) => rawItem.name,\n          );\n          entry[\"r\"] = makeMetadata(entryMap);\n        }\n        return entry;\n      }),\n    );\n  const metadata = makeMetadata(\n    Base.multiIndexArray(rawItems, (rawItem) =>\n      rawItem.refines ? null : rawItem.name,\n    ),\n  );\n  let lang: string | null = null;\n  if (metadata[metaTerms.language]) {\n    lang = metadata[metaTerms.language][0][\"v\"];\n  }\n  const sortMetadata = (metadata: Meta) => {\n    for (const term in metadata) {\n      const arr = metadata[term];\n      arr.sort(getMetadataComparator(term, lang));\n      for (let i = 0; i < arr.length; i++) {\n        const r = arr[i][\"r\"];\n        if (r) {\n          sortMetadata(r);\n        }\n      }\n    }\n  };\n  sortMetadata(metadata);\n  return metadata;\n}\n\nexport function getMathJaxHub(): object {\n  const math = window[\"MathJax\"];\n  if (math) {\n    return math[\"Hub\"];\n  }\n  return null;\n}\n\nexport const supportedMediaTypes = {\n  \"application/xhtml+xml\": true,\n  \"image/jpeg\": true,\n  \"image/png\": true,\n  \"image/svg+xml\": true,\n  \"image/gif\": true,\n  \"audio/mp3\": true,\n};\n\nexport const transformedIdPrefix = \"viv-id-\";\n\nexport class OPFDoc {\n  opfXML: XmlDoc.XMLDocHolder = null;\n  encXML: XmlDoc.XMLDocHolder = null;\n  items: OPFItem[] = null;\n  spine: OPFItem[] = null;\n  itemMap: { [key: string]: OPFItem } = null;\n  itemMapByPath: { [key: string]: OPFItem } = null;\n  uid: string | null = null;\n  bindings: { [key: string]: string } = {};\n  lang: string | null = null;\n  epageCount: number = 0;\n  prePaginated: boolean = false;\n  epageIsRenderedPage: boolean = true;\n  epageCountCallback: (p1: number) => void | null = null;\n  metadata: Meta = {};\n  toc: OPFItem = null;\n  cover: OPFItem = null;\n  fallbackMap: { [key: string]: string } = {};\n  pageProgression: Constants.PageProgression | null = null;\n  documentURLTransformer: Base.DocumentURLTransformer;\n\n  constructor(\n    public readonly store: EPUBDocStore,\n    public readonly pubURL: string,\n  ) {\n    this.documentURLTransformer = this.createDocumentURLTransformer();\n  }\n\n  // FIXME: TS4055\n  createDocumentURLTransformer(): Base.DocumentURLTransformer {\n    const self = this;\n    class OPFDocumentURLTransformer implements Base.DocumentURLTransformer {\n      /** @override */\n      transformFragment(fragment: string, baseURL: string): string {\n        const url = baseURL + (fragment ? `#${fragment}` : \"\");\n        return transformedIdPrefix + Base.escapeNameStrToHex(url, \":\");\n      }\n\n      /** @override */\n      transformURL(url: string, baseURL: string): string {\n        const r = url.match(/^([^#]*)#?(.*)$/);\n        if (r) {\n          const path = r[1] || baseURL.replace(/\\?viv-toc-box$/, \"\");\n          const fragment = decodeURIComponent(r[2]);\n          if (path) {\n            if (self.spine.some((item) => item.src === path)) {\n              return `#${this.transformFragment(fragment, path)}`;\n            }\n          }\n        }\n        return url;\n      }\n\n      /** @override */\n      restoreURL(encoded: string): string[] {\n        if (encoded.charAt(0) === \"#\") {\n          encoded = encoded.substring(1);\n        }\n        if (encoded.indexOf(transformedIdPrefix) === 0) {\n          encoded = encoded.substring(transformedIdPrefix.length);\n        }\n        const decoded = Base.unescapeStrFromHex(encoded, \":\");\n        const r = decoded.match(/^([^#]*)#?(.*)$/);\n        return r ? [r[1], r[2]] : [];\n      }\n    }\n    return new OPFDocumentURLTransformer();\n  }\n\n  /**\n   * Metadata is organized in the following way: fully-expanded property names\n   * (with IRI prefixes prepended) point to an array of values. Array contains\n   * at least one element. First element is primary and should be used by\n   * default. Element values are objects have the following keys:\n   * - \"v\" - item value as string,\n   * - \"s\" - scheme,\n   * - \"o\" - index in the order of appearing in the source,\n   * - \"r\" - refinement submetadata (organized just like the top-level\n   * metadata).\n   */\n  getMetadata(): Meta {\n    return this.metadata;\n  }\n\n  getPathFromURL(url: string): string | null {\n    if (url.startsWith(\"data:\")) {\n      return url === this.pubURL ? \"\" : url;\n    }\n    if (this.pubURL) {\n      let epubBaseURL = Base.resolveURL(\"\", this.pubURL);\n      if (url === epubBaseURL || url + \"/\" === epubBaseURL) {\n        return \"\";\n      }\n      if (epubBaseURL.charAt(epubBaseURL.length - 1) != \"/\") {\n        epubBaseURL += \"/\";\n      }\n      return url.substr(0, epubBaseURL.length) == epubBaseURL\n        ? decodeURIComponent(url.substr(epubBaseURL.length))\n        : null;\n    } else {\n      return url;\n    }\n  }\n\n  initWithXMLDoc(\n    opfXML: XmlDoc.XMLDocHolder,\n    encXML: XmlDoc.XMLDocHolder,\n  ): Task.Result<any> {\n    this.opfXML = opfXML;\n    this.encXML = encXML;\n    const pkg = opfXML.doc().child(\"package\");\n    const uidref = pkg.attribute(\"unique-identifier\")[0];\n    if (uidref) {\n      const uidElem = opfXML.getElement(`${opfXML.url}#${uidref}`);\n      if (uidElem) {\n        this.uid = uidElem.textContent.replace(/[ \\n\\r\\t]/g, \"\");\n      }\n    }\n    const srcToFallbackId = {};\n    this.items = pkg\n      .child(\"manifest\")\n      .child(\"item\")\n      .asArray()\n      .map((node) => {\n        const item = new OPFItem();\n        const elem = node as Element;\n        item.initWithElement(elem, opfXML.url);\n        const fallback = elem.getAttribute(\"fallback\");\n        if (fallback && !supportedMediaTypes[item.mediaType]) {\n          srcToFallbackId[item.src] = fallback;\n        }\n        if (!this.toc && item.itemProperties[\"nav\"]) {\n          this.toc = item;\n        }\n        if (!this.cover && item.itemProperties[\"cover-image\"]) {\n          this.cover = item;\n        }\n        return item;\n      });\n    this.itemMap = Base.indexArray(\n      this.items,\n      getOPFItemId as (p1: OPFItem) => string | null,\n    );\n    this.itemMapByPath = Base.indexArray(this.items, (item) =>\n      this.getPathFromURL(item.src),\n    );\n    for (const src in srcToFallbackId) {\n      let fallbackSrc = src;\n      while (true) {\n        const item = this.itemMap[srcToFallbackId[fallbackSrc]];\n        if (!item) {\n          break;\n        }\n        if (supportedMediaTypes[item.mediaType]) {\n          this.fallbackMap[src] = item.src;\n          break;\n        }\n        fallbackSrc = item.src;\n      }\n    }\n    this.spine = pkg\n      .child(\"spine\")\n      .child(\"itemref\")\n      .asArray()\n      .map((node, index) => {\n        const elem = node as Element;\n        const id = elem.getAttribute(\"idref\");\n        const item = this.itemMap[id as string];\n        if (item) {\n          item.itemRefElement = elem;\n          item.spineIndex = index;\n        }\n        return item;\n      });\n    const pageProgressionAttr = pkg\n      .child(\"spine\")\n      .attribute(\"page-progression-direction\")[0];\n    if (pageProgressionAttr) {\n      this.pageProgression = Constants.pageProgressionOf(pageProgressionAttr);\n    }\n    const idpfObfURLs = !encXML\n      ? []\n      : encXML\n          .doc()\n          .child(\"encryption\")\n          .child(\"EncryptedData\")\n          .predicate(\n            XmlDoc.predicate.withChild(\n              \"EncryptionMethod\",\n              XmlDoc.predicate.withAttribute(\n                \"Algorithm\",\n                \"http://www.idpf.org/2008/embedding\",\n              ),\n            ),\n          )\n          .child(\"CipherData\")\n          .child(\"CipherReference\")\n          .attribute(\"URI\");\n    const mediaTypeElems = pkg\n      .child(\"bindings\")\n      .child(\"mediaType\")\n      .asArray() as Element[];\n    for (let i = 0; i < mediaTypeElems.length; i++) {\n      const handlerId = mediaTypeElems[i].getAttribute(\"handler\");\n      const mediaType = mediaTypeElems[i].getAttribute(\"media-type\");\n      if (mediaType && handlerId && this.itemMap[handlerId]) {\n        this.bindings[mediaType] = this.itemMap[handlerId].src;\n      }\n    }\n    this.metadata = readMetadata(\n      pkg.child(\"metadata\"),\n      pkg.attribute(\"prefix\")[0],\n    );\n    if (this.metadata[metaTerms.language]) {\n      this.lang = this.metadata[metaTerms.language][0][\"v\"];\n    }\n    if (this.metadata[metaTerms.layout]) {\n      this.prePaginated =\n        this.metadata[metaTerms.layout][0][\"v\"] === \"pre-paginated\";\n    }\n\n    if (idpfObfURLs.length > 0 && this.uid) {\n      // Have to deobfuscate in JavaScript\n      const deobfuscator = makeDeobfuscator(this.uid);\n      for (let i = 0; i < idpfObfURLs.length; i++) {\n        this.store.deobfuscators[this.pubURL + idpfObfURLs[i]] = deobfuscator;\n      }\n    }\n    if (this.prePaginated) {\n      this.assignAutoPages();\n    }\n    return Task.newResult(true);\n  }\n\n  assignAutoPages(): void {\n    let epage = 0;\n    for (const item of this.spine) {\n      const epageCount = this.prePaginated\n        ? 1\n        : Math.ceil(item.compressedSize / 1024);\n      item.epage = epage;\n      item.epageCount = epageCount;\n      epage += epageCount;\n    }\n    this.epageCount = epage;\n\n    if (this.epageCountCallback) {\n      this.epageCountCallback(this.epageCount);\n    }\n  }\n\n  setEPageCountMode(epageIsRenderedPage: boolean) {\n    this.epageIsRenderedPage = epageIsRenderedPage || this.prePaginated;\n  }\n\n  countEPages(\n    epageCountCallback: ((p1: number) => void) | null,\n  ): Task.Result<boolean> {\n    this.epageCountCallback = epageCountCallback;\n\n    if (this.epageIsRenderedPage) {\n      if (this.prePaginated && this.epageCount == 0) {\n        this.assignAutoPages();\n      }\n      return Task.newResult(true);\n    }\n\n    let epage = 0;\n    let i = 0;\n    const frame: Task.Frame<boolean> = Task.newFrame(\"countEPages\");\n    frame\n      .loopWithFrame((loopFrame) => {\n        if (i === this.spine.length) {\n          loopFrame.breakLoop();\n          return;\n        }\n        const item = this.spine[i++];\n        item.epage = epage;\n        this.store.load(item.src).then((xmldoc) => {\n          // According to the old comment,\n          // \"Estimate that offset=2700 roughly corresponds to 1024 bytes of compressed size.\"\n          // However, it should depend on the language.\n          // Further adjustment needed.\n\n          //let offsetPerEPage = 2700;\n          let offsetPerEPage = 1800;\n          const lang = xmldoc.lang || this.lang;\n          if (lang && lang.match(/^(ja|ko|zh)/)) {\n            offsetPerEPage /= 3;\n          }\n          item.epageCount = Math.ceil(xmldoc.getTotalOffset() / offsetPerEPage);\n          epage += item.epageCount;\n          this.epageCount = epage;\n          if (this.epageCountCallback) {\n            this.epageCountCallback(this.epageCount);\n          }\n          loopFrame.continueLoop();\n        });\n      })\n      .thenFinish(frame);\n    return frame.result();\n  }\n\n  /**\n   * Creates a fake OPF \"document\" that contains OPS chapters.\n   */\n  initWithChapters(params: OPFItemParam[], doc?: Document | null) {\n    this.itemMap = {};\n    this.itemMapByPath = {};\n    this.items = [];\n    this.spine = this.items;\n\n    // create a minimum fake OPF XML for navigation with EPUB CFI\n    const opfXML = (this.opfXML = new XmlDoc.XMLDocHolder(\n      null,\n      \"\",\n      new DOMParser().parseFromString(\"<spine></spine>\", \"text/xml\"),\n    ));\n    params.forEach((param) => {\n      const item = new OPFItem();\n      item.initWithParam(param);\n      Asserts.assert(item.id);\n      const itemref = opfXML.document.createElement(\"itemref\");\n      itemref.setAttribute(\"idref\", item.id);\n      opfXML.root.appendChild(itemref);\n      item.itemRefElement = itemref;\n      this.itemMap[item.id] = item;\n      let path = this.getPathFromURL(param.url);\n      if (path == null) {\n        path = param.url;\n      }\n      this.itemMapByPath[path] = item;\n      this.items.push(item);\n    });\n    if (doc) {\n      return this.store.addDocument(params[0].url, doc);\n    } else {\n      return Task.newResult(null);\n    }\n  }\n\n  initWithWebPubManifest(\n    manifestObj: Base.JSON,\n    doc?: Document,\n    manifestUrl?: string,\n  ): Task.Result<boolean> {\n    if (manifestObj[\"readingProgression\"]) {\n      this.pageProgression = manifestObj[\"readingProgression\"];\n    }\n    if (this.metadata === undefined) {\n      this.metadata = {};\n    }\n    const title =\n      manifestObj[\"name\"] || manifestObj[\"metadata\"]?.[\"title\"] || doc?.title;\n    if (title) {\n      this.metadata[metaTerms.title] = (\n        Array.isArray(title) ? title : [title]\n      ).map((item) => ({ v: item.value ?? item }));\n    }\n    const author =\n      manifestObj[\"author\"] ||\n      manifestObj[\"creator\"] ||\n      manifestObj[\"metadata\"]?.[\"author\"] ||\n      Array.from(\n        doc?.querySelectorAll(\"meta[name='author'], meta[name='DC.Creator']\") ??\n          [],\n      ).map((meta: HTMLMetaElement) => meta.content);\n    if (author && author.length !== 0) {\n      this.metadata[metaTerms.creator] = (\n        Array.isArray(author) ? author : [author]\n      ).map((item) => ({ v: item.name ?? item }));\n    }\n    const language =\n      manifestObj[\"inLanguage\"] ||\n      manifestObj[\"metadata\"]?.[\"language\"] ||\n      doc?.documentElement.lang ||\n      doc?.documentElement.getAttribute(\"xml:lang\");\n    if (language) {\n      this.metadata[metaTerms.language] = (\n        Array.isArray(language) ? language : [language]\n      ).map((item) => ({ v: item }));\n    }\n    // TODO: other metadata...\n\n    const primaryEntryPath = this.getPathFromURL(this.pubURL);\n    if (!manifestObj[\"readingOrder\"] && doc && primaryEntryPath !== null) {\n      manifestObj[\"readingOrder\"] = [encodeURI(primaryEntryPath)];\n\n      // Find TOC in the primary entry (X)HTML\n      for (const anchorElem of Toc.findTocAnchorElements(doc)) {\n        const href = anchorElem.getAttribute(\"href\");\n        if (/^(https?:)?\\/\\//.test(href)) {\n          // Avoid link to external resources\n          continue;\n        }\n        if (/\\.(jpe?g|png|gif|pdf|svg|mml)([#?]|$)/.test(href)) {\n          // Avoid link to non-HTML resources\n          continue;\n        }\n        const hrefNoFragment = Base.stripFragment(\n          Base.resolveURL(href, this.pubURL),\n        );\n        const path = this.getPathFromURL(hrefNoFragment);\n        const url = path !== null ? encodeURI(path) : hrefNoFragment;\n        if (manifestObj[\"readingOrder\"].indexOf(url) == -1) {\n          manifestObj[\"readingOrder\"].push(url);\n        }\n      }\n    }\n\n    const params = [];\n    let itemCount = 0;\n    let tocFound = -1;\n    [manifestObj[\"readingOrder\"], manifestObj[\"resources\"]].forEach(\n      (readingOrderOrResources) => {\n        if (readingOrderOrResources instanceof Array) {\n          readingOrderOrResources.forEach((itemObj) => {\n            const isInReadingOrder =\n              readingOrderOrResources === manifestObj[\"readingOrder\"];\n            const url =\n              typeof itemObj === \"string\"\n                ? itemObj\n                : itemObj.url || itemObj.href;\n            const encodingFormat =\n              typeof itemObj === \"string\"\n                ? \"\"\n                : itemObj.encodingFormat ||\n                  (itemObj.href && itemObj.type) ||\n                  \"\";\n            if (\n              isInReadingOrder ||\n              encodingFormat === \"text/html\" ||\n              encodingFormat === \"application/xhtml+xml\" ||\n              (!encodingFormat &&\n                itemObj.rel !== \"stylesheet\" &&\n                /(^|\\/)([^/]+\\.(x?html|htm|xht)|[^/.]*)([#?]|$)/.test(url))\n            ) {\n              const baseUrl = manifestUrl\n                ? manifestUrl.replace(/\\/[^/]+$/, \"/\")\n                : this.pubURL;\n              const param = {\n                url: Base.resolveURL(Base.convertSpecialURL(url), baseUrl),\n                index: itemCount++,\n                startPage: null,\n                skipPagesBefore: null,\n              };\n              if (itemObj.rel === \"contents\" && tocFound === -1) {\n                tocFound = param.index;\n              }\n              params.push(param);\n            }\n          });\n        }\n      },\n    );\n    const frame: Task.Frame<boolean> = Task.newFrame(\"initWithWebPubManifest\");\n    this.initWithChapters(params).then(() => {\n      if (tocFound !== -1) {\n        this.toc = this.items[tocFound];\n      }\n\n      if (!this.toc) {\n        this.toc = manifestUrl\n          ? this.items?.[0]\n          : this.itemMapByPath[primaryEntryPath];\n      }\n\n      // remove items not in readingOrder (Issue #1257)\n      const readingOrderCount = manifestObj[\"readingOrder\"]?.length;\n      if (readingOrderCount && readingOrderCount < this.items.length) {\n        this.items.splice(readingOrderCount);\n      }\n\n      frame.finish(true);\n    });\n    return frame.result();\n  }\n\n  /**\n   * @return cfi\n   */\n  getCFI(spineIndex: number, offsetInItem: number): Task.Result<string | null> {\n    const item = this.spine[spineIndex];\n    const frame: Task.Frame<string | null> = Task.newFrame(\"getCFI\");\n    this.store.load(item.src).then((xmldoc: XmlDoc.XMLDocHolder) => {\n      const node = xmldoc.getNodeByOffset(offsetInItem);\n      let cfi: string | null = null;\n      if (node) {\n        const startOffset = xmldoc.getNodeOffset(node, 0, false);\n        const offsetInNode = offsetInItem - startOffset;\n        const fragment = new CFI.Fragment();\n        fragment.prependPathFromNode(node, offsetInNode, false, null);\n        if (item.itemRefElement) {\n          fragment.prependPathFromNode(item.itemRefElement, 0, false, null);\n        }\n        cfi = fragment.toString();\n      }\n      frame.finish(cfi);\n    });\n    return frame.result();\n  }\n\n  resolveFragment(fragstr: string | null): Task.Result<Position | null> {\n    return Task.handle(\n      \"resolveFragment\",\n      (frame: Task.Frame<Position | null>): void => {\n        if (!fragstr) {\n          frame.finish(null);\n          return;\n        }\n        let fragment = new CFI.Fragment();\n        fragment.fromString(fragstr);\n        let item: OPFItem;\n        if (this.opfXML) {\n          const opfNav = fragment.navigate(this.opfXML.document);\n          if (opfNav.node.nodeType != 1 || opfNav.after || !opfNav.ref) {\n            frame.finish(null);\n            return;\n          }\n          const elem = opfNav.node as Element;\n          const idref = elem.getAttribute(\"idref\");\n          if (elem.localName != \"itemref\" || !idref || !this.itemMap[idref]) {\n            frame.finish(null);\n            return;\n          }\n          item = this.itemMap[idref];\n          fragment = opfNav.ref;\n        } else {\n          item = this.spine[0];\n        }\n        this.store.load(item.src).then((xmldoc: XmlDoc.XMLDocHolder) => {\n          const nodeNav = fragment.navigate(xmldoc.document);\n          const offset = xmldoc.getNodeOffset(\n            nodeNav.node,\n            nodeNav.offset,\n            nodeNav.after,\n          );\n          frame.finish({\n            spineIndex: item.spineIndex,\n            offsetInItem: offset,\n            pageIndex: -1,\n          });\n        });\n      },\n      (frame: Task.Frame<Position | null>, err: Error): void => {\n        Logging.logger.warn(err, \"Cannot resolve fragment:\", fragstr);\n        frame.finish(null);\n      },\n    );\n  }\n\n  resolveEPage(epage: number): Task.Result<Position | null> {\n    return Task.handle(\n      \"resolveEPage\",\n      (frame: Task.Frame<Position | null>): void => {\n        if (epage <= 0) {\n          frame.finish({ spineIndex: 0, offsetInItem: 0, pageIndex: -1 });\n          return;\n        }\n        if (this.epageIsRenderedPage) {\n          let spineIndex = this.spine.findIndex((item) => {\n            return (\n              (item.epage == 0 && item.epageCount == 0) ||\n              (item.epage <= epage && item.epage + item.epageCount > epage)\n            );\n          });\n          if (spineIndex == -1) {\n            spineIndex = this.spine.length - 1;\n          }\n          let item = this.spine[spineIndex];\n          if (!item || item.epageCount == 0) {\n            item = this.spine[--spineIndex];\n          }\n          const pageIndex = Math.floor(epage - item.epage);\n          frame.finish({ spineIndex, offsetInItem: -1, pageIndex: pageIndex });\n          return;\n        }\n        let spineIndex = Base.binarySearch(this.spine.length, (index) => {\n          const item = this.spine[index];\n          return item.epage + item.epageCount > epage;\n        });\n        if (spineIndex == this.spine.length) {\n          spineIndex--;\n        }\n        const item = this.spine[spineIndex];\n        this.store.load(item.src).then((xmldoc: XmlDoc.XMLDocHolder) => {\n          epage -= item.epage;\n          if (epage > item.epageCount) {\n            epage = item.epageCount;\n          }\n          let offset = 0;\n          if (epage > 0) {\n            const totalOffset = xmldoc.getTotalOffset();\n            offset = Math.round((totalOffset * epage) / item.epageCount);\n            if (offset == totalOffset) {\n              offset--;\n            }\n          }\n          frame.finish({ spineIndex, offsetInItem: offset, pageIndex: -1 });\n        });\n      },\n      (frame: Task.Frame<Position | null>, err: Error): void => {\n        Logging.logger.warn(err, \"Cannot resolve epage:\", epage);\n        frame.finish(null);\n      },\n    );\n  }\n\n  getEPageFromPosition(position: Position): Task.Result<number> {\n    const item = this.spine[position.spineIndex];\n    if (this.epageIsRenderedPage) {\n      const epage = item.epage + position.pageIndex;\n      return Task.newResult(epage);\n    }\n    if (position.offsetInItem <= 0) {\n      return Task.newResult(item.epage);\n    }\n    const frame: Task.Frame<number> = Task.newFrame(\"getEPage\");\n    this.store.load(item.src).then((xmldoc: XmlDoc.XMLDocHolder) => {\n      const totalOffset = xmldoc.getTotalOffset();\n      const offset = Math.min(totalOffset, position.offsetInItem);\n      frame.finish(item.epage + (offset * item.epageCount) / totalOffset);\n    });\n    return frame.result();\n  }\n}\n\nexport type PageAndPosition = {\n  page: Vtree.Page;\n  position: Position;\n};\n\nexport const makePageAndPosition = (\n  page: Vtree.Page,\n  pageIndex: number,\n): PageAndPosition => ({\n  page,\n  position: {\n    spineIndex: page.spineIndex,\n    pageIndex,\n    offsetInItem: page.offset,\n  },\n});\n\nexport type OPFViewItem = {\n  item: OPFItem;\n  xmldoc: XmlDoc.XMLDocHolder;\n  instance: OPS.StyleInstance;\n  layoutPositions: Vtree.LayoutPosition[];\n  pages: Vtree.Page[];\n  complete: boolean;\n};\n\nexport class OPFView implements Vgen.CustomRendererFactory {\n  spineItems: OPFViewItem[] = [];\n  spineItemLoadingContinuations: Task.Continuation<any>[][] = [];\n  pref: Exprs.Preferences;\n  clientLayout: Vgen.DefaultClientLayout;\n  counterStore: Counters.CounterStore;\n  tocAutohide: boolean = false;\n  tocVisible: boolean = false;\n  tocView?: Toc.TOCView;\n\n  constructor(\n    public readonly opf: OPFDoc,\n    public readonly viewport: Vgen.Viewport,\n    public readonly fontMapper: Font.Mapper,\n    pref: Exprs.Preferences,\n    public readonly pageSheetSizeReporter: (\n      p1: { width: number; height: number },\n      p2: { [key: string]: { width: number; height: number } },\n      p3: number,\n      p4: number,\n    ) => any,\n  ) {\n    this.pref = Exprs.clonePreferences(pref);\n    this.clientLayout = new Vgen.DefaultClientLayout(viewport);\n    this.counterStore = new Counters.CounterStore(opf.documentURLTransformer);\n  }\n\n  private getPage(position: Position): Vtree.Page {\n    const viewItem = this.spineItems[position.spineIndex];\n    return viewItem ? viewItem.pages[position.pageIndex] : null;\n  }\n\n  getCurrentPageProgression(\n    position: Position,\n  ): Constants.PageProgression | null {\n    if (this.opf.pageProgression) {\n      return this.opf.pageProgression;\n    } else {\n      const viewItem = this.spineItems[position ? position.spineIndex : 0];\n      return viewItem ? viewItem.instance.pageProgression : null;\n    }\n  }\n\n  private finishPageContainer(\n    viewItem: OPFViewItem,\n    page: Vtree.Page,\n    pageIndex: number,\n  ) {\n    page.container.style.display = \"none\";\n    page.container.style.visibility = \"visible\";\n    page.container.style.position = \"\";\n    page.container.style.top = \"\";\n    page.container.style.left = \"\";\n    page.container.setAttribute(\n      \"data-vivliostyle-page-side\",\n      page.side as string,\n    );\n    const oldPage = viewItem.pages[pageIndex];\n    page.isFirstPage = viewItem.item.spineIndex == 0 && pageIndex == 0;\n    viewItem.pages[pageIndex] = page;\n\n    if (this.opf.epageIsRenderedPage) {\n      if (pageIndex == 0 && viewItem.item.spineIndex > 0) {\n        const prevItem = this.opf.spine[viewItem.item.spineIndex - 1];\n        viewItem.item.epage = prevItem.epage + prevItem.epageCount;\n      }\n      viewItem.item.epageCount = viewItem.pages.length;\n      this.opf.epageCount = this.opf.spine.reduce(\n        (count, item) => count + item.epageCount,\n        0,\n      );\n\n      if (this.opf.epageCountCallback) {\n        this.opf.epageCountCallback(this.opf.epageCount);\n      }\n    }\n\n    if (oldPage) {\n      viewItem.instance.viewport.contentContainer.replaceChild(\n        page.container,\n        oldPage.container,\n      );\n      oldPage.dispatchEvent({\n        type: \"replaced\",\n        target: null,\n        currentTarget: null,\n        preventDefault: null,\n        newPage: page,\n      });\n    } else {\n      // Find insert position in contentContainer.\n      let insertPos: Element | null = null;\n      if (pageIndex > 0) {\n        insertPos = viewItem.pages[pageIndex - 1].container.nextElementSibling;\n      } else {\n        for (\n          let i = viewItem.item.spineIndex + 1;\n          i < this.spineItems.length;\n          i++\n        ) {\n          const item = this.spineItems[i];\n          if (item && item.pages[0]) {\n            insertPos = item.pages[0].container;\n            break;\n          }\n        }\n      }\n      viewItem.instance.viewport.contentContainer.insertBefore(\n        page.container,\n        insertPos,\n      );\n    }\n    this.pageSheetSizeReporter(\n      {\n        width: viewItem.instance.pageSheetWidth,\n        height: viewItem.instance.pageSheetHeight,\n      },\n      viewItem.instance.pageSheetSize,\n      viewItem.item.spineIndex,\n      viewItem.instance.pageNumberOffset + pageIndex,\n    );\n  }\n\n  /**\n   * Render a single page. If the new page contains elements with ids that are\n   * referenced from other pages by 'target-counter()', those pages are rendered\n   * too (calling `renderSinglePage` recursively).\n   */\n  private renderSinglePage(\n    viewItem: OPFViewItem,\n    pos: Vtree.LayoutPosition,\n  ): Task.Result<RenderSinglePageResult> {\n    const frame: Task.Frame<RenderSinglePageResult> =\n      Task.newFrame(\"renderSinglePage\");\n\n    const oldPage = viewItem.pages[pos ? pos.page : 0];\n    let page = this.makePage(viewItem, pos);\n    if (oldPage) {\n      // If the old page exists, keep the pageType (named page).\n      // This is necessary for named page with target-counter() to work.\n      // (fix for issue #1136)\n      page.pageType = oldPage.pageType;\n    }\n\n    viewItem.instance.layoutNextPage(page, pos).then((posParam) => {\n      pos = posParam as Vtree.LayoutPosition;\n      const pageIndex = pos\n        ? pos.page - 1\n        : viewItem.layoutPositions.length - 1;\n      this.finishPageContainer(viewItem, page, pageIndex);\n      this.counterStore.finishPage(page.spineIndex, pageIndex);\n\n      // If the position of the page break change, we should re-layout the next\n      // page too.\n      let cont: Task.Result<any> = null;\n      if (pos) {\n        const prevPos = viewItem.layoutPositions[pos.page];\n        viewItem.layoutPositions[pos.page] = pos;\n        if (prevPos && viewItem.pages[pos.page]) {\n          if (!pos.isSamePosition(prevPos)) {\n            cont = this.renderSinglePage(viewItem, pos);\n          }\n        }\n      }\n      if (!cont) {\n        cont = Task.newResult(true);\n      }\n      cont.then(() => {\n        const unresolvedRefs = this.counterStore.getUnresolvedRefsToPage(page);\n        let index = 0;\n        frame\n          .loopWithFrame((loopFrame) => {\n            index++;\n            if (index > unresolvedRefs.length) {\n              loopFrame.breakLoop();\n              return;\n            }\n            const refs = unresolvedRefs[index - 1];\n            refs.refs = refs.refs.filter((ref) => !ref.isResolved());\n            if (refs.refs.length === 0) {\n              loopFrame.continueLoop();\n              return;\n            }\n            this.getPageViewItem(refs.spineIndex).then((viewItem) => {\n              if (!viewItem) {\n                loopFrame.continueLoop();\n                return;\n              }\n              // Save the page type and restore it after re-rendering page.\n              // This is necessary for named page with target-counter() to work.\n              // (fix for issue #1272)\n              const { currentPageType, previousPageType } =\n                viewItem.instance.styler.cascade;\n\n              // Save the scopes and restore them after re-rendering page.\n              // This is necessary for :blank page selector to work.\n              // (fix for issues #1131 and #1513)\n              const scopes = viewItem.instance.scopes;\n              viewItem.instance.scopes = {};\n\n              this.counterStore.pushPageCounters(refs.pageCounters);\n              this.counterStore.pushReferencesToSolve(refs.refs);\n              const pos = viewItem.layoutPositions[refs.pageIndex];\n\n              this.renderSinglePage(viewItem, pos).then((result) => {\n                viewItem.instance.styler.cascade.currentPageType =\n                  currentPageType;\n                viewItem.instance.styler.cascade.previousPageType =\n                  previousPageType;\n                viewItem.instance.scopes = scopes;\n                this.counterStore.popPageCounters();\n                this.counterStore.popReferencesToSolve();\n                const resultPosition = result.pageAndPosition.position;\n                if (\n                  resultPosition.spineIndex === page.spineIndex &&\n                  resultPosition.pageIndex === pageIndex\n                ) {\n                  page = result.pageAndPosition.page;\n                }\n                loopFrame.continueLoop();\n              });\n            });\n          })\n          .then(() => {\n            if (!page.container.parentElement) {\n              // page is replaced\n              page = viewItem.pages[pageIndex];\n            }\n            page.isLastPage =\n              !pos && viewItem.item.spineIndex === this.opf.spine.length - 1;\n            if (page.isLastPage) {\n              Asserts.assert(this.viewport);\n              this.counterStore.finishLastPage(this.viewport);\n            }\n            page.container.setAttribute(\n              \"data-vivliostyle-page-index\",\n              pageIndex,\n            );\n            page.container.setAttribute(\n              \"data-vivliostyle-spine-index\",\n              page.spineIndex,\n            );\n            frame.finish({\n              pageAndPosition: makePageAndPosition(page, pageIndex),\n              nextLayoutPosition: pos,\n            });\n          });\n      });\n    });\n    return frame.result();\n  }\n\n  private normalizeSeekPosition(\n    position: Position,\n    viewItem: OPFViewItem,\n  ): Position | null {\n    let pageIndex = position.pageIndex;\n    let seekOffset = -1;\n    if (pageIndex < 0) {\n      seekOffset = position.offsetInItem;\n\n      // page with offset higher than seekOffset\n      const seekOffsetPageIndex = Base.binarySearch(\n        viewItem.layoutPositions.length,\n        (pageIndex) => {\n          // 'noLookAhead' argument of getPosition must be true, since\n          // otherwise StyleInstance.currentLayoutPosition is modified\n          // unintentionally.\n          const offset = viewItem.instance.getPosition(\n            viewItem.layoutPositions[pageIndex],\n            true,\n          );\n          return offset > seekOffset;\n        },\n      );\n      if (seekOffsetPageIndex === viewItem.layoutPositions.length) {\n        if (viewItem.complete) {\n          pageIndex = viewItem.layoutPositions.length - 1;\n        } else {\n          // need to search through pages that are not yet produced\n          pageIndex = Number.POSITIVE_INFINITY;\n        }\n      } else {\n        // page that contains seekOffset\n        pageIndex = seekOffsetPageIndex - 1;\n      }\n    } else if (\n      pageIndex === Number.POSITIVE_INFINITY &&\n      position.offsetInItem !== -1\n    ) {\n      seekOffset = position.offsetInItem;\n    }\n    return {\n      spineIndex: position.spineIndex,\n      pageIndex,\n      offsetInItem: seekOffset,\n    } as Position;\n  }\n\n  /**\n   * Find a page corresponding to a specified position among already laid out\n   * pages.\n   * @param sync If true, find the page synchronously (not waiting another\n   *     rendering task)\n   */\n  findPage(\n    position: Position,\n    sync: boolean,\n  ): Task.Result<PageAndPosition | null> {\n    const frame: Task.Frame<PageAndPosition | null> = Task.newFrame(\"findPage\");\n    this.getPageViewItem(position.spineIndex).then((viewItem) => {\n      if (!viewItem) {\n        frame.finish(null);\n        return;\n      }\n      let resultPage: Vtree.Page = null;\n      let pageIndex: number;\n      frame\n        .loopWithFrame((loopFrame) => {\n          const normalizedPosition = this.normalizeSeekPosition(\n            position,\n            viewItem,\n          );\n          pageIndex = normalizedPosition.pageIndex;\n          resultPage = viewItem.pages[pageIndex];\n          if (resultPage) {\n            loopFrame.breakLoop();\n          } else if (viewItem.complete) {\n            pageIndex = viewItem.layoutPositions.length - 1;\n            resultPage = viewItem.pages[pageIndex];\n            loopFrame.breakLoop();\n          } else if (sync) {\n            this.renderPage(normalizedPosition).then((result) => {\n              if (result) {\n                resultPage = result.page;\n                pageIndex = result.position.pageIndex;\n              }\n              loopFrame.breakLoop();\n            });\n          } else {\n            // Wait for the layout task and retry\n            frame.sleep(100).then(() => {\n              loopFrame.continueLoop();\n            });\n          }\n        })\n        .then(() => {\n          Asserts.assert(resultPage);\n          frame.finish(makePageAndPosition(resultPage, pageIndex));\n        });\n    });\n    return frame.result();\n  }\n\n  /**\n   * Renders a page at the specified position.\n   */\n  renderPage(position: Position): Task.Result<PageAndPosition | null> {\n    const frame: Task.Frame<PageAndPosition | null> =\n      Task.newFrame(\"renderPage\");\n    this.getPageViewItem(position.spineIndex).then((viewItem) => {\n      if (!viewItem) {\n        frame.finish(null);\n        return;\n      }\n      const normalizedPosition = this.normalizeSeekPosition(position, viewItem);\n      let pageIndex = normalizedPosition.pageIndex;\n      const seekOffset = normalizedPosition.offsetInItem;\n      let resultPage = viewItem.pages[pageIndex];\n      if (resultPage) {\n        frame.finish(makePageAndPosition(resultPage, pageIndex));\n        return;\n      }\n      frame\n        .loopWithFrame((loopFrame) => {\n          if (pageIndex < viewItem.layoutPositions.length) {\n            loopFrame.breakLoop();\n            return;\n          }\n          if (viewItem.complete) {\n            pageIndex = viewItem.layoutPositions.length - 1;\n            loopFrame.breakLoop();\n            return;\n          }\n          let pos =\n            viewItem.layoutPositions[viewItem.layoutPositions.length - 1];\n          this.renderSinglePage(viewItem, pos).then((result) => {\n            const page = result.pageAndPosition.page;\n            pos = result.nextLayoutPosition;\n            if (pos) {\n              if (seekOffset >= 0) {\n                // Searching for offset, don't know the page number.\n                const offset = viewItem.instance.getPosition(pos);\n                if (offset > seekOffset) {\n                  resultPage = page;\n                  pageIndex = viewItem.layoutPositions.length - 2;\n                  loopFrame.breakLoop();\n                  return;\n                }\n              }\n              loopFrame.continueLoop();\n            } else {\n              resultPage = page;\n              pageIndex = result.pageAndPosition.position.pageIndex;\n              viewItem.complete = true;\n              loopFrame.breakLoop();\n            }\n          });\n        })\n        .then(() => {\n          resultPage = resultPage || viewItem.pages[pageIndex];\n          const pos = viewItem.layoutPositions[pageIndex];\n          if (resultPage) {\n            frame.finish(makePageAndPosition(resultPage, pageIndex));\n            return;\n          }\n          this.renderSinglePage(viewItem, pos).then((result) => {\n            if (!result.nextLayoutPosition) {\n              viewItem.complete = true;\n            }\n            frame.finish(result.pageAndPosition);\n          });\n        });\n    });\n    return frame.result();\n  }\n\n  renderAllPages(): Task.Result<PageAndPosition | null> {\n    const frame: Task.Frame<PageAndPosition | null> =\n      Task.newFrame(\"renderAllPages\");\n    this.renderPagesUpto(\n      {\n        spineIndex: this.opf.spine.length - 1,\n        pageIndex: Number.POSITIVE_INFINITY,\n        offsetInItem: -1,\n      },\n      false,\n    ).then((result) => {\n      // Wait until all images are loaded (Issue #1321)\n      frame\n        .loopWithFrame((loopFrame) => {\n          if (\n            this.spineItems.some((viewItem) =>\n              viewItem?.pages.some((page) =>\n                page?.fetchers.some((fetcher) => !fetcher.arrived),\n              ),\n            )\n          ) {\n            frame.sleep(100).then(() => {\n              loopFrame.continueLoop();\n            });\n          } else {\n            loopFrame.breakLoop();\n          }\n        })\n        .then(() => {\n          frame.finish(result);\n        });\n    });\n    return frame.result();\n  }\n\n  /**\n   * Render pages from (spineIndex=0, pageIndex=0) to the specified (spineIndex,\n   * pageIndex).\n   * @param notAllPages If true, render from biginning of specified spine item.\n   */\n  renderPagesUpto(\n    position: Position,\n    notAllPages: boolean,\n  ): Task.Result<PageAndPosition | null> {\n    const frame: Task.Frame<PageAndPosition | null> =\n      Task.newFrame(\"renderPagesUpto\");\n    if (!position) {\n      position = { spineIndex: 0, pageIndex: 0, offsetInItem: 0 };\n    }\n    const spineIndex = position.spineIndex;\n    const pageIndex = position.pageIndex;\n    let s = 0;\n\n    if (notAllPages) {\n      // Render pages from biginning of specified spine item.\n      s = spineIndex;\n    }\n\n    let lastResult: PageAndPosition;\n    frame\n      .loopWithFrame((loopFrame) => {\n        const pos = {\n          spineIndex: s,\n          pageIndex: s === spineIndex ? pageIndex : Number.POSITIVE_INFINITY,\n          offsetInItem: s === spineIndex ? position.offsetInItem : -1,\n        };\n        this.renderPage(pos).then((result) => {\n          lastResult = result;\n          if (++s > spineIndex) {\n            loopFrame.breakLoop();\n          } else {\n            loopFrame.continueLoop();\n          }\n        });\n      })\n      .then(() => {\n        frame.finish(lastResult);\n      });\n    return frame.result();\n  }\n\n  /**\n   * Move to the first page and render it.\n   */\n  firstPage(\n    position: Position,\n    sync: boolean,\n  ): Task.Result<PageAndPosition | null> {\n    return this.findPage(\n      { spineIndex: 0, pageIndex: 0, offsetInItem: -1 },\n      sync,\n    );\n  }\n\n  /**\n   * Move to the last page and render it.\n   */\n  lastPage(\n    position: Position,\n    sync: boolean,\n  ): Task.Result<PageAndPosition | null> {\n    return this.findPage(\n      {\n        spineIndex: this.opf.spine.length - 1,\n        pageIndex: Number.POSITIVE_INFINITY,\n        offsetInItem: -1,\n      },\n      sync,\n    );\n  }\n\n  /**\n   * Move to the next page position and render page.\n   * @param sync If true, get the page synchronously (not waiting another\n   *     rendering task)\n   */\n  nextPage(\n    position: Position,\n    sync: boolean,\n  ): Task.Result<PageAndPosition | null> {\n    let spineIndex = position.spineIndex;\n    let pageIndex = position.pageIndex;\n    const frame: Task.Frame<PageAndPosition | null> = Task.newFrame(\"nextPage\");\n    this.getPageViewItem(spineIndex).then((viewItem) => {\n      if (!viewItem) {\n        frame.finish(null);\n        return;\n      }\n      if (\n        viewItem.complete &&\n        pageIndex == viewItem.layoutPositions.length - 1\n      ) {\n        if (spineIndex >= this.opf.spine.length - 1) {\n          frame.finish(null);\n          return;\n        }\n        spineIndex++;\n        pageIndex = 0;\n\n        // Remove next viewItem if its first page has same side as the current page\n        // to avoid unpaired page.\n        const nextViewItem = this.spineItems[spineIndex];\n        const nextPage = nextViewItem && nextViewItem.pages[0];\n        const currentPage = viewItem.pages[viewItem.pages.length - 1];\n        if (nextPage && currentPage && nextPage.side == currentPage.side) {\n          nextViewItem.pages.forEach((page) => {\n            if (page.container) page.container.remove();\n          });\n          this.spineItems[spineIndex] = null;\n          this.spineItemLoadingContinuations[spineIndex] = null;\n        }\n      } else {\n        pageIndex++;\n      }\n      this.findPage(\n        { spineIndex, pageIndex, offsetInItem: -1 },\n        sync,\n      ).thenFinish(frame);\n    });\n    return frame.result();\n  }\n\n  /**\n   * Move to the previous page and render it.\n   */\n  previousPage(\n    position: Position,\n    sync: boolean,\n  ): Task.Result<PageAndPosition | null> {\n    let spineIndex = position.spineIndex;\n    let pageIndex = position.pageIndex;\n    if (pageIndex == 0) {\n      if (spineIndex == 0) {\n        return Task.newResult(null as PageAndPosition | null);\n      }\n      spineIndex--;\n      pageIndex = Number.POSITIVE_INFINITY;\n    } else {\n      pageIndex--;\n    }\n    return this.findPage({ spineIndex, pageIndex, offsetInItem: -1 }, sync);\n  }\n\n  /**\n   * @param page This page should be a currently displayed page.\n   */\n  private isRectoPage(page: Vtree.Page, position: Position): boolean {\n    const isLeft = page.side === Constants.PageSide.LEFT;\n    const isLTR =\n      this.getCurrentPageProgression(position) ===\n      Constants.PageProgression.LTR;\n    return (!isLeft && isLTR) || (isLeft && !isLTR);\n  }\n\n  /**\n   * Get a spread containing the currently displayed page.\n   * @param sync If true, get the spread synchronously (not waiting another\n   *     rendering task)\n   */\n  getSpread(position: Position, sync: boolean): Task.Result<Vtree.Spread> {\n    const page = this.getPage(position);\n    if (!page) {\n      return Task.newResult({ left: null, right: null });\n    }\n    const frame: Task.Frame<Vtree.Spread> = Task.newFrame(\"getSpread\");\n    const isLeft = page.side === Constants.PageSide.LEFT;\n    let other: Task.Result<PageAndPosition>;\n    if (this.isRectoPage(page, position)) {\n      other = this.previousPage(position, sync);\n    } else {\n      other = this.nextPage(position, sync);\n    }\n    other.then((otherPageAndPosition) => {\n      // this page may be replaced during nextPage(), so get thisPage again.\n      const thisPage = this.getPage(position);\n\n      let otherPage = otherPageAndPosition && otherPageAndPosition.page;\n      if (otherPage && otherPage.side === thisPage.side) {\n        // otherPage must not be same side\n        otherPage = null;\n      }\n\n      if (isLeft) {\n        frame.finish({ left: thisPage, right: otherPage });\n      } else {\n        frame.finish({ left: otherPage, right: thisPage });\n      }\n    });\n    return frame.result();\n  }\n\n  /**\n   * Move to the next spread and render pages.\n   * @param sync If true, get the spread synchronously (not waiting another\n   *     rendering task)\n   * @returns The 'verso' page of the next spread.\n   */\n  nextSpread(\n    position: Position,\n    sync: boolean,\n  ): Task.Result<PageAndPosition | null> {\n    const page = this.getPage(position);\n    if (!page) {\n      return Task.newResult(null as PageAndPosition | null);\n    }\n    const isRecto = this.isRectoPage(page, position);\n    const next = this.nextPage(position, sync);\n    if (isRecto) {\n      return next;\n    } else {\n      return next.thenAsync((result) => {\n        if (result) {\n          if (result.page.side === page.side) {\n            // If same side, this is the next spread.\n            return next;\n          }\n          const next2 = this.nextPage(result.position, sync);\n          return next2.thenAsync((result2) => {\n            if (result2) {\n              return next2;\n            } else {\n              // If this is tha last spread, move to next page in the same spread.\n              return next;\n            }\n          });\n        } else {\n          return Task.newResult(null as PageAndPosition | null);\n        }\n      });\n    }\n  }\n\n  /**\n   * Move to the previous spread and render pages.\n   * @returns The 'recto' page of the previous spread.\n   */\n  previousSpread(\n    position: Position,\n    sync: boolean,\n  ): Task.Result<PageAndPosition | null> {\n    const page = this.getPage(position);\n    if (!page) {\n      return Task.newResult(null as PageAndPosition | null);\n    }\n    const isRecto = this.isRectoPage(page, position);\n    const prev = this.previousPage(position, sync);\n    const oldPrevPageCont = page.container.previousElementSibling;\n    if (isRecto) {\n      return prev.thenAsync((result) => {\n        if (result) {\n          if (result.page.side === page.side) {\n            // If same side, this is the previous spread.\n            return prev;\n          }\n          if (result.page.container !== oldPrevPageCont) {\n            // If previous page is changed, return it.\n            return prev;\n          }\n          return this.previousPage(result.position, sync);\n        } else {\n          return Task.newResult(null as PageAndPosition | null);\n        }\n      });\n    } else {\n      return prev;\n    }\n  }\n\n  /**\n   * Move to the epage specified by the given number (zero-based) and render it.\n   */\n  navigateToEPage(\n    epage: number,\n    position: Position,\n    sync: boolean,\n  ): Task.Result<PageAndPosition | null> {\n    const frame: Task.Frame<PageAndPosition | null> =\n      Task.newFrame(\"navigateToEPage\");\n    this.opf.resolveEPage(epage).then((position) => {\n      if (position) {\n        this.findPage(position, sync).thenFinish(frame);\n      } else {\n        frame.finish(null);\n      }\n    });\n    return frame.result();\n  }\n\n  /**\n   * Move to the page specified by the given CFI and render it.\n   */\n  navigateToFragment(\n    fragment: string,\n    position: Position,\n    sync: boolean,\n  ): Task.Result<PageAndPosition | null> {\n    const frame: Task.Frame<PageAndPosition | null> =\n      Task.newFrame(\"navigateToCFI\");\n    this.opf.resolveFragment(fragment).then((position) => {\n      if (position) {\n        this.findPage(position, sync).thenFinish(frame);\n      } else {\n        frame.finish(null);\n      }\n    });\n    return frame.result();\n  }\n\n  /**\n   * Move to the page specified by the given URL and render it.\n   */\n  navigateTo(\n    href: string,\n    position: Position,\n    sync: boolean,\n  ): Task.Result<PageAndPosition | null> {\n    Logging.logger.debug(\"Navigate to\", href);\n    let path = this.opf.getPathFromURL(Base.stripFragment(href));\n    if (!path) {\n      if (this.opf.opfXML && href.match(/^#epubcfi\\(/)) {\n        // CFI fragment is \"relative\" to OPF.\n        path = this.opf.getPathFromURL(this.opf.opfXML.url);\n      } else if (href.charAt(0) === \"#\") {\n        const restored = this.opf.documentURLTransformer.restoreURL(href);\n        if (this.opf.opfXML) {\n          path = this.opf.getPathFromURL(restored[0]);\n          if (path == null) {\n            path = restored[0];\n          }\n        } else {\n          path = restored[0];\n        }\n        href = restored[0] + (restored[1] ? `#${restored[1]}` : \"\");\n      }\n      if (path == null) {\n        return Task.newResult(null as PageAndPosition | null);\n      }\n    }\n    const item = this.opf.itemMapByPath[path];\n    if (!item) {\n      if (\n        this.opf.opfXML &&\n        path == this.opf.getPathFromURL(this.opf.opfXML.url)\n      ) {\n        // CFI link?\n        const fragmentIndex = href.indexOf(\"#\");\n        if (fragmentIndex >= 0) {\n          return this.navigateToFragment(\n            href.substr(fragmentIndex + 1),\n            position,\n            sync,\n          );\n        }\n      }\n      return Task.newResult(null as PageAndPosition | null);\n    }\n    const frame: Task.Frame<PageAndPosition | null> =\n      Task.newFrame(\"navigateTo\");\n    this.getPageViewItem(item.spineIndex).then((viewItem) => {\n      if (!viewItem) {\n        frame.finish(null);\n        return;\n      }\n      const target = viewItem.xmldoc.getElement(href);\n      this.findPage(\n        {\n          spineIndex: item.spineIndex,\n          pageIndex: -1,\n          offsetInItem: target ? viewItem.xmldoc.getElementOffset(target) : 0,\n        },\n        sync,\n      ).thenFinish(frame);\n    });\n    return frame.result();\n  }\n\n  makePage(viewItem: OPFViewItem, pos: Vtree.LayoutPosition): Vtree.Page {\n    const viewport = viewItem.instance.viewport;\n    const pageCont = viewport.document.createElement(\"div\");\n    pageCont.setAttribute(\"data-vivliostyle-page-container\", \"true\");\n    pageCont.role = \"presentation\";\n\n    if (!Constants.isDebug) {\n      pageCont.style.visibility = \"hidden\";\n    }\n    viewport.layoutBox.appendChild(pageCont);\n    const bleedBox = viewport.document.createElement(\"div\");\n    bleedBox.setAttribute(\"data-vivliostyle-bleed-box\", \"true\");\n    bleedBox.role = \"presentation\";\n    pageCont.appendChild(bleedBox);\n    const page = new Vtree.Page(pageCont, bleedBox);\n    page.spineIndex = viewItem.item.spineIndex;\n    page.position = pos;\n    page.offset = viewItem.instance.getPosition(pos);\n    if (\n      page.offset === 0 &&\n      !(viewItem.instance.blankPageAtStart && viewItem.pages.length === 0)\n    ) {\n      const id = this.opf.documentURLTransformer.transformFragment(\n        \"\",\n        viewItem.item.src,\n      );\n      bleedBox.setAttribute(\"id\", id);\n      page.registerElementWithId(bleedBox, id);\n    }\n    if (viewport !== this.viewport) {\n      const matrix = Exprs.letterbox(\n        this.viewport.width,\n        this.viewport.height,\n        viewport.width,\n        viewport.height,\n      );\n      const cssMatrix = CssParser.parseValue(\n        null,\n        new CssTokenizer.Tokenizer(matrix, null),\n        \"\",\n      );\n      page.delayedItems.push(\n        new Vtree.DelayedItem(pageCont, \"transform\", cssMatrix),\n      );\n    }\n    return page;\n  }\n\n  makeObjectView(\n    xmldoc: XmlDoc.XMLDocHolder,\n    srcElem: Element,\n    viewParent: Element,\n    computedStyle: { [key: string]: Css.Val },\n  ): Task.Result<Element> {\n    let data = srcElem.getAttribute(\"data\");\n    let result: Element | null = null;\n    if (data) {\n      data = Base.resolveURL(data, xmldoc.url);\n      let mediaType = srcElem.getAttribute(\"media-type\");\n      if (!mediaType) {\n        const path = this.opf.getPathFromURL(data);\n        if (path) {\n          const item = this.opf.itemMapByPath[path];\n          if (item) {\n            mediaType = item.mediaType;\n          }\n        }\n      }\n      if (mediaType) {\n        const handlerSrc = this.opf.bindings[mediaType];\n        if (handlerSrc) {\n          result = this.viewport.document.createElement(\"iframe\");\n          (result as HTMLElement).style.border = \"none\";\n          const srcParam = Base.lightURLEncode(data);\n          const typeParam = Base.lightURLEncode(mediaType);\n          const sb = new Base.StringBuffer();\n          sb.append(handlerSrc);\n          sb.append(\"?src=\");\n          sb.append(srcParam);\n          sb.append(\"&type=\");\n          sb.append(typeParam);\n          for (let c: Node = srcElem.firstChild; c; c = c.nextSibling) {\n            if (c.nodeType == 1) {\n              const ce = c as Element;\n              if (ce.localName == \"param\" && ce.namespaceURI == Base.NS.XHTML) {\n                const pname = ce.getAttribute(\"name\");\n                const pvalue = ce.getAttribute(\"value\");\n                if (pname && pvalue) {\n                  sb.append(\"&\");\n                  sb.append(encodeURIComponent(pname));\n                  sb.append(\"=\");\n                  sb.append(encodeURIComponent(pvalue));\n                }\n              }\n            }\n          }\n          result.setAttribute(\"src\", sb.toString());\n          const width = srcElem.getAttribute(\"width\");\n          if (width) {\n            result.setAttribute(\"width\", width);\n          }\n          const height = srcElem.getAttribute(\"height\");\n          if (height) {\n            result.setAttribute(\"height\", height);\n          }\n        }\n      }\n    }\n    if (!result) {\n      result = this.viewport.document.createElement(\"object\");\n      if (data) {\n        result.setAttribute(\"data\", data);\n      }\n      result.setAttribute(\"data-adapt-process-children\", \"true\");\n    }\n\n    // Need to cast because we need {Element}, not {!Element}\n    return Task.newResult(result as Element);\n  }\n\n  makeMathJaxView(\n    xmldoc: XmlDoc.XMLDocHolder,\n    srcElem: Element,\n    viewParent: Element,\n    computedStyle: { [key: string]: Css.Val },\n  ): Task.Result<Element> {\n    // See if MathJax installed, use it if it is.\n    const hub = getMathJaxHub();\n    if (hub) {\n      const doc = viewParent.ownerDocument;\n      const span = doc.createElement(\"span\");\n      viewParent.appendChild(span);\n      const clonedMath = doc.importNode(srcElem, true);\n      this.resolveURLsInMathML(clonedMath, xmldoc);\n      span.appendChild(clonedMath);\n      const queue = hub[\"queue\"];\n      queue[\"Push\"]([\"Typeset\", hub, span]);\n      const frame: Task.Frame<Element> = Task.newFrame(\"makeMathJaxView\");\n      const continuation = frame.suspend();\n      queue[\"Push\"](() => {\n        continuation.schedule(span);\n      });\n      return frame.result();\n    }\n    return Task.newResult(null as Element);\n  }\n\n  private resolveURLsInMathML(node: Node, xmldoc: XmlDoc.XMLDocHolder) {\n    if (node == null) {\n      return;\n    }\n    if (node.nodeType === 1 && (node as Element).tagName === \"mglyph\") {\n      const attrs = Array.from((node as Element).attributes);\n      for (const attr of attrs) {\n        if (attr.name !== \"src\") {\n          continue;\n        }\n        const newUrl = Base.resolveURL(attr.nodeValue, xmldoc.url);\n        if (attr.namespaceURI) {\n          (node as Element).setAttributeNS(\n            attr.namespaceURI,\n            attr.name,\n            newUrl,\n          );\n        } else {\n          (node as Element).setAttribute(attr.name, newUrl);\n        }\n      }\n    }\n    if (node.firstChild) {\n      this.resolveURLsInMathML(node.firstChild, xmldoc);\n    }\n    if (node.nextSibling) {\n      this.resolveURLsInMathML(node.nextSibling, xmldoc);\n    }\n  }\n\n  /** @override */\n  makeCustomRenderer(xmldoc: XmlDoc.XMLDocHolder): Vgen.CustomRenderer {\n    return (\n      srcElem: Element,\n      viewParent: Element,\n      computedStyle: { [key: string]: Css.Val },\n    ): Task.Result<Element> => {\n      if (\n        srcElem.localName == \"object\" &&\n        srcElem.namespaceURI == Base.NS.XHTML\n      ) {\n        return this.makeObjectView(xmldoc, srcElem, viewParent, computedStyle);\n      } else if (srcElem.namespaceURI == Base.NS.MATHML) {\n        return this.makeMathJaxView(xmldoc, srcElem, viewParent, computedStyle);\n      } else if (\n        (srcElem as HTMLElement).dataset &&\n        (srcElem as HTMLElement).dataset[\"mathTypeset\"] == \"true\"\n      ) {\n        return this.makeMathJaxView(xmldoc, srcElem, viewParent, computedStyle);\n      }\n      return Task.newResult(null as Element);\n    };\n  }\n\n  getPageViewItem(spineIndex: number): Task.Result<OPFViewItem> {\n    if (spineIndex === -1 || spineIndex >= this.opf.spine.length) {\n      return Task.newResult(null as OPFViewItem);\n    }\n    let viewItem = this.spineItems[spineIndex];\n    if (viewItem) {\n      return Task.newResult(viewItem);\n    }\n    const frame: Task.Frame<OPFViewItem> = Task.newFrame(\"getPageViewItem\");\n\n    // If loading for the item has already been started, suspend and wait for\n    // the result.\n    let loadingContinuations = this.spineItemLoadingContinuations[spineIndex];\n    if (loadingContinuations) {\n      const cont = frame.suspend();\n      loadingContinuations.push(cont);\n      return frame.result();\n    } else {\n      loadingContinuations = this.spineItemLoadingContinuations[spineIndex] =\n        [];\n    }\n    const item = this.opf.spine[spineIndex];\n    const store = this.opf.store;\n    store.load(item.src).then((xmldoc: XmlDoc.XMLDocHolder) => {\n      // EPUB Spine properties support\n      const epubSpineProperties =\n        item.itemRefElement.getAttribute(\"properties\");\n      if (epubSpineProperties) {\n        xmldoc.root.setAttribute(\n          \"data-vivliostyle-epub-spine-properties\",\n          epubSpineProperties,\n        );\n      }\n      item.title = xmldoc.document.title;\n      const style = store.getStyleForDoc(xmldoc);\n      const customRenderer = this.makeCustomRenderer(xmldoc);\n      let viewport = this.viewport;\n      const viewportSize = style.sizeViewport(\n        viewport.width,\n        viewport.height,\n        viewport.fontSize,\n        this.pref,\n      );\n      if (\n        viewportSize.width != viewport.width ||\n        viewportSize.height != viewport.height ||\n        viewportSize.fontSize != viewport.fontSize\n      ) {\n        viewport = new Vgen.Viewport(\n          viewport.window,\n          viewportSize.fontSize,\n          viewport.pixelRatio,\n          viewport.root,\n          viewportSize.width,\n          viewportSize.height,\n        );\n      }\n      const isVersoFirstPage = this.spineItems[0]?.instance.isVersoFirstPage;\n      const previousViewItem = this.spineItems[spineIndex - 1];\n      let pageNumberOffset: number;\n      let pageCounterOffset: number;\n      if (item.startPage !== null) {\n        pageNumberOffset = item.startPage - 1;\n        pageCounterOffset = pageNumberOffset;\n      } else {\n        if (\n          spineIndex > 0 &&\n          (!previousViewItem || !previousViewItem.complete)\n        ) {\n          // When navigate to a new spine item skipping the previous items,\n          // give up calculate pageNumberOffset and use epage (or spineIndex if epage is unset).\n          pageNumberOffset = item.epage || spineIndex;\n          if (\n            !this.opf.prePaginated &&\n            pageNumberOffset % 2 == (isVersoFirstPage ? 1 : 0)\n          ) {\n            // Force to odd number to avoid unpaired page. (This is 0 based and even number is recto)\n            // (odd and even are reversed if isVersoFirstPage is true)\n            pageNumberOffset++;\n          }\n          pageCounterOffset = pageNumberOffset;\n        } else {\n          pageNumberOffset = previousViewItem\n            ? previousViewItem.instance.pageNumberOffset +\n              previousViewItem.pages.length\n            : 0;\n          const counters = this.counterStore.currentPageCounters[\"page\"];\n          pageCounterOffset =\n            !counters || !counters.length\n              ? pageNumberOffset\n              : counters[counters.length - 1];\n\n          // Note: The \"page\" counter value differs to the \"page-number\" value\n          // if the \"page\" counter has been reset by counter-reset/increment.\n          // (Fix for issue #701)\n        }\n        if (item.skipPagesBefore !== null) {\n          pageNumberOffset += item.skipPagesBefore;\n          pageCounterOffset += item.skipPagesBefore;\n        }\n      }\n      this.counterStore.forceSetPageCounter(pageCounterOffset);\n      const instance = new OPS.StyleInstance(\n        style,\n        xmldoc,\n        this.opf.lang,\n        viewport,\n        this.clientLayout,\n        this.fontMapper,\n        customRenderer,\n        this.opf.fallbackMap,\n        pageNumberOffset,\n        this.opf.documentURLTransformer,\n        this.counterStore,\n        this.opf.pageProgression,\n        isVersoFirstPage,\n      );\n      instance.pref = this.pref;\n\n      // For env(pub-title) and env(doc-title)\n      const pubTitles = this.opf.metadata && this.opf.metadata[metaTerms.title];\n      instance.pubTitle =\n        (pubTitles && pubTitles[0] && pubTitles[0][\"v\"]) || \"\";\n      instance.docTitle = item.title || \"\";\n\n      instance.init().then(() => {\n        if (!this.opf.pageProgression && instance.pageProgression) {\n          // Use the first instance's page progression as the global page progression.\n          // (Fix for issue #1260)\n          this.opf.pageProgression = instance.pageProgression;\n        }\n        viewItem = {\n          item,\n          xmldoc,\n          instance,\n          layoutPositions: [null],\n          pages: [],\n          complete: false,\n        };\n        this.spineItems[spineIndex] = viewItem;\n        frame.finish(viewItem);\n        loadingContinuations.forEach((c) => {\n          c.schedule(viewItem);\n        });\n      });\n    });\n    return frame.result();\n  }\n\n  removeRenderedPages() {\n    const items = this.spineItems;\n    for (const item of items) {\n      if (item) {\n        item.pages.splice(0);\n      }\n    }\n    this.viewport.clear();\n  }\n\n  /**\n   * Returns if at least one page has 'auto' size\n   */\n  hasAutoSizedPages(): boolean {\n    const items = this.spineItems;\n    for (const item of items) {\n      if (item) {\n        const pages = item.pages;\n        for (const page of pages) {\n          if (page.isAutoPageWidth && page.isAutoPageHeight) {\n            return true;\n          }\n        }\n      }\n    }\n    return false;\n  }\n\n  hasPages(): boolean {\n    return this.spineItems.some((item) => item && item.pages.length > 0);\n  }\n\n  showTOC(autohide: boolean): Task.Result<Vtree.Page> {\n    const opf = this.opf;\n    const toc = opf.toc;\n    this.tocAutohide = autohide;\n    if (!toc) {\n      return Task.newResult(null as Vtree.Page);\n    }\n    this.tocVisible = true;\n    if (this.tocView && this.tocView.page) {\n      this.tocView.page.container.style.visibility = \"visible\";\n      this.tocView.page.container.setAttribute(\"aria-hidden\", \"false\");\n      return Task.newResult(this.tocView.page);\n    }\n    const frame: Task.Frame<Vtree.Page> = Task.newFrame(\"showTOC\");\n    if (!this.tocView) {\n      this.tocView = new Toc.TOCView(\n        opf.store,\n        toc.src,\n        opf.lang,\n        this.clientLayout,\n        this.fontMapper,\n        this.pref,\n        this,\n        opf.fallbackMap,\n        opf.documentURLTransformer,\n        this.counterStore,\n      );\n    }\n    const viewport = this.viewport;\n    const tocWidth = Math.min(344, Math.round(0.67 * viewport.width) - 16);\n    const tocHeight = viewport.height - 6;\n    const pageCont = viewport.document.createElement(\"div\") as HTMLElement;\n    viewport.root.appendChild(pageCont);\n    // pageCont.style.position = \"absolute\";\n    if (!Constants.isDebug) {\n      pageCont.style.visibility = \"hidden\";\n    }\n    // pageCont.style.left = \"3px\";\n    // pageCont.style.top = \"3px\";\n    pageCont.style.width = `${tocWidth + 16}px`;\n    pageCont.style.maxHeight = `${tocHeight}px`;\n    // pageCont.style.overflow = \"scroll\";\n    // pageCont.style.overflowX = \"hidden\";\n    // pageCont.style.background = \"rgba(248,248,248,0.9)\";\n    // pageCont.style[\"borderRadius\"] = \"2px\";\n    // pageCont.style[\"boxShadow\"] = \"1px 1px 2px rgba(0,0,0,0.4)\";\n\n    pageCont.setAttribute(\"data-vivliostyle-toc-box\", \"true\");\n    pageCont.setAttribute(\"role\", \"navigation\");\n\n    this.tocView\n      .showTOC(pageCont, viewport, tocWidth, tocHeight, this.viewport.fontSize)\n      .then((page) => {\n        pageCont.style.visibility = \"visible\";\n        pageCont.setAttribute(\"aria-hidden\", \"false\");\n        frame.finish(page);\n      });\n    return frame.result();\n  }\n\n  hideTOC(): void {\n    this.tocVisible = false;\n    if (this.tocView) {\n      this.tocView.hideTOC();\n    }\n  }\n\n  isTOCVisible(): boolean {\n    return this.tocVisible && !!this.tocView && this.tocView.isTOCVisible();\n  }\n}\n\nexport interface RenderSinglePageResult {\n  pageAndPosition: PageAndPosition;\n  nextLayoutPosition: Vtree.LayoutPosition;\n}\n", "/**\n * Copyright 2013 Google, Inc.\n * Copyright 2015 Daishinsha Inc.\n * Copyright 2018 Vivliostyle Foundation\n *\n * Vivliostyle.js is free software: you can redistribute it and/or modify\n * it under the terms of the GNU Affero General Public License as published by\n * the Free Software Foundation, either version 3 of the License, or\n * (at your option) any later version.\n *\n * Vivliostyle.js is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n * GNU Affero General Public License for more details.\n *\n * You should have received a copy of the GNU Affero General Public License\n * along with Vivliostyle.js.  If not, see <http://www.gnu.org/licenses/>.\n *\n * @fileoverview AdaptiveViewer - Viewer implementation.\n */\nimport * as Asserts from \"./asserts\";\nimport * as Base from \"./base\";\nimport * as Constants from \"./constants\";\nimport * as Epub from \"./epub\";\nimport * as Exprs from \"./exprs\";\nimport * as Font from \"./font\";\nimport * as Logging from \"./logging\";\nimport * as Plugin from \"./plugin\";\nimport * as Profile from \"./profile\";\nimport * as Scripts from \"./scripts\";\nimport * as Task from \"./task\";\nimport * as TaskUtil from \"./task-util\";\nimport * as Vgen from \"./vgen\";\nimport * as Vtree from \"./vtree\";\nimport {\n  VivliostylePolyfillCss,\n  VivliostyleViewportCss,\n  VivliostyleViewportScreenCss,\n} from \"./assets\";\n\nexport type Action = (p1: Base.JSON) => Task.Result<boolean>;\n\nexport type ViewportSize = {\n  marginLeft: number;\n  marginRight: number;\n  marginTop: number;\n  marginBottom: number;\n  width: number;\n  height: number;\n};\n\nexport const VIEWPORT_STATUS_ATTRIBUTE = \"data-vivliostyle-viewer-status\";\n\nexport const VIEWPORT_SPREAD_VIEW_ATTRIBUTE = \"data-vivliostyle-spread-view\";\n\n/**\n * @enum {string}\n */\nexport enum PageViewMode {\n  SINGLE_PAGE = \"singlePage\",\n  SPREAD = \"spread\",\n  AUTO_SPREAD = \"autoSpread\",\n}\n\nexport type SingleDocumentParam = {\n  url: string;\n  startPage: number | null;\n  skipPagesBefore: number | null;\n};\n\nexport class AdaptiveViewer {\n  fontMapper: Font.Mapper;\n  kick: () => void;\n  sendCommand: (p1: Base.JSON | string) => void;\n  resizeListener: () => void;\n  hyperlinkListener: Base.EventListener;\n  pageRuleStyleElement: HTMLElement;\n  pageSheetSizeAlreadySet: boolean = false;\n  renderTask: Task.Task | null = null;\n  actions: { [key: string]: Action };\n  readyState: Constants.ReadyState;\n  packageURL: string[];\n  opf: Epub.OPFDoc;\n  touchActive: boolean;\n  touchX: number;\n  touchY: number;\n  needResize: boolean;\n  resized: boolean;\n  needRefresh: boolean;\n  viewportSize: ViewportSize | null;\n  currentPage: Vtree.Page;\n  currentSpread: Vtree.Spread | null;\n  pagePosition: Epub.Position | null;\n  fontSize: number;\n  zoom: number;\n  fitToScreen: boolean;\n  pageViewMode: PageViewMode;\n  waitForLoading: boolean;\n  renderAllPages: boolean;\n  pref: Exprs.Preferences;\n  pageSizes: { width: number; height: number }[];\n  pixelRatio: number;\n  pixelRatioLimit: number;\n\n  // force relayout\n  viewport: Vgen.Viewport | null;\n  opfView: Epub.OPFView;\n\n  constructor(\n    public readonly window: Window,\n    public readonly viewportElement: HTMLElement,\n    public readonly instanceId: string,\n    public readonly callbackFn: (p1: Base.JSON) => void,\n  ) {\n    const document = viewportElement.ownerDocument;\n    const findOrCreateStyleElement = (\n      id: string,\n      cssText?: string,\n    ): HTMLElement => {\n      let styleElement = document.getElementById(id);\n      if (!styleElement) {\n        styleElement = document.createElement(\"style\");\n        styleElement.id = id;\n        if (cssText) {\n          styleElement.textContent = cssText;\n        }\n        document.head.appendChild(styleElement);\n      }\n      return styleElement;\n    };\n    findOrCreateStyleElement(\n      \"vivliostyle-viewport-screen-css\",\n      VivliostyleViewportScreenCss,\n    );\n    findOrCreateStyleElement(\n      \"vivliostyle-viewport-css\",\n      VivliostyleViewportCss,\n    );\n    findOrCreateStyleElement(\n      \"vivliostyle-polyfill-css\",\n      VivliostylePolyfillCss,\n    );\n\n    viewportElement.setAttribute(\"data-vivliostyle-viewer-viewport\", true);\n    if (Constants.isDebug) {\n      viewportElement.setAttribute(\"data-vivliostyle-debug\", true);\n    }\n    viewportElement.setAttribute(VIEWPORT_STATUS_ATTRIBUTE, \"loading\");\n    this.fontMapper = new Font.Mapper(document.head, viewportElement);\n    this.init();\n    this.kick = () => {};\n    this.sendCommand = () => {};\n    this.resizeListener = () => {\n      this.needResize = true;\n      this.resized = true;\n      this.kick();\n    };\n    this.pageReplacedListener = this.pageReplacedListener.bind(this);\n    this.hyperlinkListener = (evt) => {};\n    this.pageRuleStyleElement = findOrCreateStyleElement(\n      \"vivliostyle-page-rules\",\n    );\n    this.actions = {\n      loadPublication: this.loadPublication,\n      loadXML: this.loadXML,\n      configure: this.configure,\n      moveTo: this.moveTo,\n      toc: this.showTOC,\n    };\n    this.addLogListeners();\n  }\n\n  private init(): void {\n    this.readyState = Constants.ReadyState.LOADING;\n    this.packageURL = [];\n    this.opf = null;\n    this.touchActive = false;\n    this.touchX = 0;\n    this.touchY = 0;\n    this.needResize = false;\n    this.resized = false;\n    this.needRefresh = false;\n    this.viewportSize = null;\n    this.currentPage = null;\n    this.currentSpread = null;\n    this.pagePosition = null;\n    this.fontSize = 16;\n    this.zoom = 1;\n    this.fitToScreen = false;\n    this.pageViewMode = PageViewMode.SINGLE_PAGE;\n    this.waitForLoading = false;\n    this.renderAllPages = true;\n    this.pref = Exprs.defaultPreferences();\n    this.pageSizes = [];\n\n    // Pixel ratio emulation on PDF output (PR #1079) does not work with\n    // non-Chromium browsers.\n    this.pixelRatioLimit =\n      Base.browserType === \"chromium\" &&\n      // Check non-legacy CSS zoom support (Chromium>=128)\n      \"currentCSSZoom\" in Element.prototype\n        ? 16 // max pixelRatio value on Chromium browsers\n        : 0; // disable pixelRatio emulation on non-Chromium browsers\n    this.pixelRatio = Math.min(8, this.pixelRatioLimit);\n  }\n\n  addLogListeners() {\n    const logLevel = Logging.LogLevel;\n    Logging.logger.addListener(logLevel.DEBUG, (info) => {\n      this.callback({ t: \"debug\", content: info });\n    });\n    Logging.logger.addListener(logLevel.INFO, (info) => {\n      this.callback({ t: \"info\", content: info });\n    });\n    Logging.logger.addListener(logLevel.WARN, (info) => {\n      this.callback({ t: \"warn\", content: info });\n    });\n    Logging.logger.addListener(logLevel.ERROR, (info) => {\n      this.callback({ t: \"error\", content: info });\n    });\n  }\n\n  private callback(message: Base.JSON): void {\n    message[\"i\"] = this.instanceId;\n    this.callbackFn(message);\n  }\n\n  /**\n   * Set readyState and notify to listeners\n   */\n  setReadyState(readyState: Constants.ReadyState) {\n    if (this.readyState !== readyState) {\n      this.readyState = readyState;\n      this.viewportElement.setAttribute(VIEWPORT_STATUS_ATTRIBUTE, readyState);\n      this.callback({ t: \"readystatechange\" });\n    }\n  }\n\n  loadPublication(command: Base.JSON): Task.Result<boolean> {\n    Profile.profiler.registerStartTiming(\"beforeRender\");\n    this.setReadyState(Constants.ReadyState.LOADING);\n    const url = command[\"url\"] as string;\n    const fragment = command[\"fragment\"] as string | null;\n    const authorStyleSheet = command[\"authorStyleSheet\"] as {\n      url: string | null;\n      text: string | null;\n    }[];\n    const userStyleSheet = command[\"userStyleSheet\"] as {\n      url: string | null;\n      text: string | null;\n    }[];\n    this.viewport = null;\n    const frame: Task.Frame<boolean> = Task.newFrame(\"loadPublication\");\n    this.configure(command).then(() => {\n      const store = new Epub.EPUBDocStore();\n      store.init(authorStyleSheet, userStyleSheet).then(() => {\n        const pubURL = Base.resolveURL(\n          Base.convertSpecialURL(url),\n          this.window.location.href,\n        );\n        this.packageURL = [pubURL];\n        store.loadPubDoc(pubURL).then((opf) => {\n          if (opf) {\n            this.opf = opf;\n            this.render(fragment).then(() => {\n              frame.finish(true);\n            });\n          } else {\n            frame.finish(false);\n          }\n        });\n      });\n    });\n    return frame.result();\n  }\n\n  loadXML(command: Base.JSON): Task.Result<boolean> {\n    Profile.profiler.registerStartTiming(\"beforeRender\");\n    this.setReadyState(Constants.ReadyState.LOADING);\n    const params: SingleDocumentParam[] = command[\"url\"];\n    const doc = command[\"document\"] as Document;\n    const fragment = command[\"fragment\"] as string | null;\n    const authorStyleSheet = command[\"authorStyleSheet\"] as {\n      url: string | null;\n      text: string | null;\n    }[];\n    const userStyleSheet = command[\"userStyleSheet\"] as {\n      url: string | null;\n      text: string | null;\n    }[];\n\n    // force relayout\n    this.viewport = null;\n    const frame: Task.Frame<boolean> = Task.newFrame(\"loadXML\");\n    this.configure(command).then(() => {\n      const store = new Epub.EPUBDocStore();\n      store.init(authorStyleSheet, userStyleSheet).then(() => {\n        const resolvedParams: Epub.OPFItemParam[] = params.map((p, index) => ({\n          url: Base.resolveURL(\n            Base.convertSpecialURL(p.url),\n            this.window.location.href,\n          ),\n          index,\n          startPage: p.startPage,\n          skipPagesBefore: p.skipPagesBefore,\n        }));\n        this.packageURL = resolvedParams.map((p) => p.url);\n        this.opf = new Epub.OPFDoc(store, \"\");\n        this.opf.initWithChapters(resolvedParams, doc).then(() => {\n          this.render(fragment).then(() => {\n            frame.finish(true);\n          });\n        });\n      });\n    });\n    return frame.result();\n  }\n\n  private render(fragment?: string | null): Task.Result<boolean> {\n    this.cancelRenderingTask();\n    let cont: Task.Result<boolean>;\n    if (fragment) {\n      cont = this.opf.resolveFragment(fragment).thenAsync((position) => {\n        this.pagePosition = position;\n        return Task.newResult(true);\n      });\n    } else {\n      cont = Task.newResult(true);\n    }\n    return cont.thenAsync(() => {\n      Profile.profiler.registerEndTiming(\"beforeRender\");\n      return this.resize();\n    });\n  }\n\n  private resolveLength(specified: string): number {\n    const value = parseFloat(specified);\n    const unitPattern = /[a-z]+$/;\n    let matched: RegExpMatchArray;\n    if (\n      typeof specified === \"string\" &&\n      (matched = specified.match(unitPattern))\n    ) {\n      const unit = matched[0];\n      if (unit === \"em\" || unit === \"rem\") {\n        return value * this.fontSize;\n      }\n      const unitSize = Exprs.defaultUnitSizes[unit];\n      if (unitSize) {\n        return value * unitSize;\n      }\n    }\n    return value;\n  }\n\n  configure(command: Base.JSON): Task.Result<boolean> {\n    if (typeof command[\"autoresize\"] == \"boolean\") {\n      if (command[\"autoresize\"]) {\n        this.viewportSize = null;\n        this.window.addEventListener(\"resize\", this.resizeListener, false);\n        this.needResize = true;\n      } else {\n        this.window.removeEventListener(\"resize\", this.resizeListener, false);\n      }\n    }\n    if (typeof command[\"fontSize\"] == \"number\") {\n      const fontSize = command[\"fontSize\"] as number;\n      if (fontSize >= 5 && fontSize <= 72 && this.fontSize != fontSize) {\n        this.fontSize = fontSize;\n        this.needResize = true;\n      }\n    }\n    if (typeof command[\"viewport\"] == \"object\" && command[\"viewport\"]) {\n      const vp = command[\"viewport\"];\n      const viewportSize = {\n        marginLeft: this.resolveLength(vp[\"margin-left\"]) || 0,\n        marginRight: this.resolveLength(vp[\"margin-right\"]) || 0,\n        marginTop: this.resolveLength(vp[\"margin-top\"]) || 0,\n        marginBottom: this.resolveLength(vp[\"margin-bottom\"]) || 0,\n        width: this.resolveLength(vp[\"width\"]) || 0,\n        height: this.resolveLength(vp[\"height\"]) || 0,\n      };\n      if (viewportSize.width >= 200 || viewportSize.height >= 200) {\n        this.window.removeEventListener(\"resize\", this.resizeListener, false);\n        this.viewportSize = viewportSize;\n        this.needResize = true;\n      }\n    }\n    if (typeof command[\"hyphenate\"] == \"boolean\") {\n      this.pref.hyphenate = command[\"hyphenate\"];\n      this.needResize = true;\n    }\n    if (typeof command[\"horizontal\"] == \"boolean\") {\n      this.pref.horizontal = command[\"horizontal\"];\n      this.needResize = true;\n    }\n    if (typeof command[\"nightMode\"] == \"boolean\") {\n      this.pref.nightMode = command[\"nightMode\"];\n      this.needResize = true;\n    }\n    if (typeof command[\"lineHeight\"] == \"number\") {\n      this.pref.lineHeight = command[\"lineHeight\"];\n      this.needResize = true;\n    }\n    if (typeof command[\"columnWidth\"] == \"number\") {\n      this.pref.columnWidth = command[\"columnWidth\"];\n      this.needResize = true;\n    }\n    if (typeof command[\"fontFamily\"] == \"string\") {\n      this.pref.fontFamily = command[\"fontFamily\"];\n      this.needResize = true;\n    }\n    if (typeof command[\"load\"] == \"boolean\") {\n      this.waitForLoading = command[\"load\"]; // Load images (and other resources) on the page.\n    }\n    if (typeof command[\"renderAllPages\"] == \"boolean\") {\n      this.renderAllPages = command[\"renderAllPages\"];\n    }\n    // for backward compatibility\n    if (typeof command[\"userAgentRootURL\"] == \"string\") {\n      Base.setBaseURL(command[\"userAgentRootURL\"].replace(/resources\\/?$/, \"\"));\n      Base.setResourceBaseURL(command[\"userAgentRootURL\"]);\n    }\n    if (typeof command[\"rootURL\"] == \"string\") {\n      Base.setBaseURL(command[\"rootURL\"]);\n      Base.setResourceBaseURL(`${Base.baseURL}resources/`);\n    }\n    if (\n      typeof command[\"pageViewMode\"] == \"string\" &&\n      command[\"pageViewMode\"] !== this.pageViewMode\n    ) {\n      this.pageViewMode = command[\"pageViewMode\"] as PageViewMode;\n      this.needResize = true;\n    }\n    if (\n      typeof command[\"pageBorder\"] == \"number\" &&\n      command[\"pageBorder\"] !== this.pref.pageBorder\n    ) {\n      // Force relayout\n      this.viewport = null;\n      this.pref.pageBorder = command[\"pageBorder\"];\n      this.needResize = true;\n    }\n    if (typeof command[\"zoom\"] == \"number\" && command[\"zoom\"] !== this.zoom) {\n      this.zoom = command[\"zoom\"];\n      this.needRefresh = true;\n    }\n    if (\n      typeof command[\"fitToScreen\"] == \"boolean\" &&\n      command[\"fitToScreen\"] !== this.fitToScreen\n    ) {\n      this.fitToScreen = command[\"fitToScreen\"];\n      this.needRefresh = true;\n    }\n    if (\n      typeof command[\"defaultPaperSize\"] == \"object\" &&\n      typeof command[\"defaultPaperSize\"].width == \"number\" &&\n      typeof command[\"defaultPaperSize\"].height == \"number\"\n    ) {\n      this.viewport = null;\n      this.pref.defaultPaperSize = command[\"defaultPaperSize\"];\n      this.needResize = true;\n    }\n    // JavaScript in HTML documents support\n    if (\n      typeof command[\"allowScripts\"] == \"boolean\" &&\n      command[\"allowScripts\"] !== Scripts.allowScripts\n    ) {\n      Scripts.setAllowScripts(command[\"allowScripts\"]);\n      this.needResize = true;\n    }\n    // output pixel ratio emulation\n    if (typeof command[\"pixelRatio\"] == \"number\") {\n      const pixelRatio = Math.min(command[\"pixelRatio\"], this.pixelRatioLimit);\n      if (pixelRatio !== this.pixelRatio) {\n        this.pixelRatio = pixelRatio;\n        this.needResize = true;\n      }\n    }\n    this.configurePlugins(command);\n    return Task.newResult(true);\n  }\n\n  configurePlugins(command: Base.JSON) {\n    const hooks: Plugin.ConfigurationHook[] = Plugin.getHooksForName(\n      Plugin.HOOKS.CONFIGURATION,\n    );\n    hooks.forEach((hook) => {\n      const result = hook(command);\n      this.needResize = result.needResize || this.needResize;\n      this.needRefresh = result.needRefresh || this.needRefresh;\n    });\n  }\n\n  /**\n   * Refresh view when a currently displayed page is replaced (by re-layout\n   * caused by cross reference resolutions)\n   */\n  pageReplacedListener(evt: Base.Event) {\n    const currentPage = this.currentPage;\n    const spread = this.currentSpread;\n    const target = evt.target;\n    if (spread) {\n      if (spread.left === target || spread.right === target) {\n        this.showCurrent(evt.newPage);\n      }\n    } else if (currentPage === evt.target) {\n      this.showCurrent(evt.newPage);\n    }\n  }\n\n  /**\n   * Iterate through currently displayed pages and do something\n   */\n  private forCurrentPages(fn: (p1: Vtree.Page) => any) {\n    const pages = [];\n    if (this.currentPage) {\n      pages.push(this.currentPage);\n    }\n    if (this.currentSpread) {\n      pages.push(this.currentSpread.left);\n      pages.push(this.currentSpread.right);\n    }\n    pages.forEach((page) => {\n      if (page) {\n        fn(page);\n      }\n    });\n  }\n\n  private removePageListeners() {\n    this.forCurrentPages((page) => {\n      page.removeEventListener(\"hyperlink\", this.hyperlinkListener, false);\n      page.removeEventListener(\"replaced\", this.pageReplacedListener, false);\n    });\n  }\n\n  /**\n   * Hide current pages (this.currentPage, this.currentSpread)\n   */\n  private hidePages() {\n    this.removePageListeners();\n    this.forCurrentPages((page) => {\n      Base.setCSSProperty(page.container, \"display\", \"none\");\n    });\n    this.currentPage = null;\n    this.currentSpread = null;\n  }\n\n  private showSinglePage(page: Vtree.Page) {\n    page.addEventListener(\"hyperlink\", this.hyperlinkListener, false);\n    page.addEventListener(\"replaced\", this.pageReplacedListener, false);\n    Base.setCSSProperty(page.container, \"visibility\", \"visible\");\n    Base.setCSSProperty(page.container, \"display\", \"block\");\n  }\n\n  private showPage(page: Vtree.Page): void {\n    this.hidePages();\n    this.currentPage = page;\n    page.container.style.marginLeft = \"\";\n    page.container.style.marginRight = \"\";\n    this.showSinglePage(page);\n  }\n\n  private showSpread(spread: Vtree.Spread) {\n    this.hidePages();\n    this.currentSpread = spread;\n    if (spread.left && spread.right) {\n      // Adjust spread horizontal alignment when left/right page widths differ\n      let leftWidth = parseFloat(spread.left.container.style.width);\n      let rightWidth = parseFloat(spread.right.container.style.width);\n      if (leftWidth && rightWidth && leftWidth !== rightWidth) {\n        if (leftWidth < rightWidth) {\n          spread.left.container.style.marginLeft = `${\n            rightWidth - leftWidth\n          }px`;\n        } else {\n          spread.right.container.style.marginRight = `${\n            leftWidth - rightWidth\n          }px`;\n        }\n      }\n    }\n    if (spread.left) {\n      this.showSinglePage(spread.left);\n      if (!spread.right) {\n        spread.left.container.setAttribute(\n          \"data-vivliostyle-unpaired-page\",\n          true,\n        );\n      } else {\n        spread.left.container.removeAttribute(\"data-vivliostyle-unpaired-page\");\n      }\n    }\n    if (spread.right) {\n      this.showSinglePage(spread.right);\n      if (!spread.left) {\n        spread.right.container.setAttribute(\n          \"data-vivliostyle-unpaired-page\",\n          true,\n        );\n      } else {\n        spread.right.container.removeAttribute(\n          \"data-vivliostyle-unpaired-page\",\n        );\n      }\n    }\n  }\n\n  private reportPosition(): Task.Result<boolean> {\n    const frame: Task.Frame<boolean> = Task.newFrame(\"reportPosition\");\n    Asserts.assert(this.pagePosition);\n    this.opf\n      .getCFI(this.pagePosition.spineIndex, this.pagePosition.offsetInItem)\n      .then((cfi) => {\n        const page = this.currentPage;\n        const r =\n          this.waitForLoading && page.fetchers.length > 0\n            ? TaskUtil.waitForFetchers(page.fetchers)\n            : Task.newResult(true);\n        r.then(() => {\n          this.sendLocationNotification(page, cfi).thenFinish(frame);\n        });\n      });\n    return frame.result();\n  }\n\n  private createViewport(): Vgen.Viewport {\n    const viewportElement = this.viewportElement;\n    if (this.viewportSize) {\n      const vs = this.viewportSize;\n      viewportElement.style.marginLeft = `${vs.marginLeft}px`;\n      viewportElement.style.marginRight = `${vs.marginRight}px`;\n      viewportElement.style.marginTop = `${vs.marginTop}px`;\n      viewportElement.style.marginBottom = `${vs.marginBottom}px`;\n      return new Vgen.Viewport(\n        this.window,\n        this.fontSize,\n        this.pixelRatio,\n        viewportElement,\n        vs.width,\n        vs.height,\n      );\n    } else {\n      return new Vgen.Viewport(\n        this.window,\n        this.fontSize,\n        this.pixelRatio,\n        viewportElement,\n      );\n    }\n  }\n\n  private resolveSpreadView(\n    viewport: Vgen.Viewport,\n    pageSize: { width: number; height: number } | null,\n  ): boolean {\n    switch (this.pageViewMode) {\n      case PageViewMode.SINGLE_PAGE:\n        return false;\n      case PageViewMode.SPREAD:\n        return true;\n      case PageViewMode.AUTO_SPREAD:\n      default:\n        return (\n          viewport != null &&\n          (viewport.width - this.pref.pageBorder) / viewport.height >=\n            (pageSize ? (pageSize.width * 2) / pageSize.height : 1.45) &&\n          (!!pageSize || viewport.width > 800)\n        );\n    }\n  }\n\n  private updateSpreadView(spreadView: boolean) {\n    this.pref.spreadView = spreadView;\n    this.viewportElement.setAttribute(\n      VIEWPORT_SPREAD_VIEW_ATTRIBUTE,\n      spreadView.toString(),\n    );\n  }\n\n  private sizeIsGood(): boolean {\n    const viewport = this.createViewport();\n    const hasNoAutoSizedPages =\n      this.opfView?.hasPages() && !this.opfView.hasAutoSizedPages();\n    const spreadView = this.resolveSpreadView(\n      viewport,\n      this.resized && hasNoAutoSizedPages ? this.pageSizes[0] : null,\n    );\n    this.resized = false;\n    const spreadViewChanged = this.pref.spreadView !== spreadView;\n    this.updateSpreadView(spreadView);\n\n    // check if window.devicePixelRatio is changed\n    const scaleRatioChanged =\n      this.pixelRatio &&\n      this.opfView &&\n      this.pixelRatio / this.window.devicePixelRatio !==\n        this.opfView.clientLayout.scaleRatio;\n\n    if (\n      scaleRatioChanged ||\n      this.viewportSize ||\n      !this.viewport ||\n      this.viewport.fontSize != this.fontSize\n    ) {\n      return false;\n    }\n    if (\n      !spreadViewChanged &&\n      viewport.width == this.viewport.width &&\n      viewport.height == this.viewport.height\n    ) {\n      return true;\n    }\n\n    if (\n      !spreadViewChanged &&\n      viewport.width == this.viewport.width &&\n      viewport.height != this.viewport.height &&\n      /Android|iPhone|iPad|iPod/.test(navigator.userAgent)\n    ) {\n      // On mobile browsers, the viewport height may change unexpectedly\n      // when soft keyboard appears or tab/address bar auto-hide occurs,\n      // so ignore resizing in this condition.\n      return true;\n    }\n\n    if (hasNoAutoSizedPages) {\n      this.viewport.width = viewport.width;\n      this.viewport.height = viewport.height;\n      this.needRefresh = true;\n      return true;\n    }\n    return false;\n  }\n\n  private setPageSize(\n    pageSize: { width: number; height: number },\n    pageSheetSize: { [key: string]: { width: number; height: number } },\n    spineIndex: number,\n    pageIndex: number,\n  ) {\n    this.pageSizes[pageIndex] = pageSize;\n    this.setPageSizePageRules(pageSheetSize, spineIndex, pageIndex);\n    if (\n      pageIndex === 0 &&\n      this.pageViewMode === PageViewMode.AUTO_SPREAD &&\n      !this.opfView.hasAutoSizedPages()\n    ) {\n      this.updateSpreadView(this.resolveSpreadView(this.viewport, pageSize));\n    }\n  }\n\n  private setPageSizePageRules(\n    pageSheetSize: { [key: string]: { width: number; height: number } },\n    spineIndex: number,\n    pageIndex: number,\n  ) {\n    // In this implementation, it generates one page rule with the largest\n    // page size both in width and height in the multiple page sizes.\n    // (Resolve issue #751)\n    if (\n      this.pageRuleStyleElement &&\n      (!this.pageSheetSizeAlreadySet ||\n        this.pageSizes[pageIndex].width !==\n          this.pageSizes[pageIndex - 1]?.width ||\n        this.pageSizes[pageIndex].height !==\n          this.pageSizes[pageIndex - 1]?.height)\n    ) {\n      const widthMax = Math.max(...this.pageSizes.map((p) => p.width));\n      const heightMax = Math.max(...this.pageSizes.map((p) => p.height));\n\n      function convertSize(px: number): number {\n        const pt = px * 0.75;\n        // Workaround for Chromium's rounded page size problem.\n        // (Fix for issue #934 and #936)\n        return Math.ceil(pt);\n      }\n      const widthPt = convertSize(widthMax);\n      const heightPt = convertSize(heightMax);\n\n      // Negative margin setting is necessary to prevent unexpected page breaking.\n      // Note that the high pixel ratio emulation, the pixelRatio setting, uses the CSS zoom property\n      // that enlarge the page content size, and Chromium splits such large pages unless this\n      // negative margin is specified.\n      const rightPt = widthPt * ((this.pixelRatio || 1) - 1) + 2;\n      const bottomPt = heightPt * ((this.pixelRatio || 1) - 1) + 2; // \"+ 2\" is for issue #947\n      const styleText = `@page {size: ${widthPt}pt ${heightPt}pt; margin: 0 ${-rightPt}pt ${-bottomPt}pt 0;}`;\n      this.pageRuleStyleElement.textContent = styleText;\n      this.pageSheetSizeAlreadySet = true;\n    }\n  }\n\n  removePageSizePageRules() {\n    if (this.pageRuleStyleElement) {\n      this.pageRuleStyleElement.textContent = \"\";\n      this.pageSheetSizeAlreadySet = false;\n    }\n  }\n\n  private reset(): void {\n    let tocVisible = false;\n    let tocAutohide = false;\n    if (this.opfView) {\n      tocVisible = this.opfView.tocVisible;\n      tocAutohide = this.opfView.tocAutohide;\n      this.opfView.removeRenderedPages();\n    }\n    this.pageSizes = [];\n    this.removePageSizePageRules();\n    this.viewport = this.createViewport();\n    this.viewport.resetZoom();\n    this.opfView = new Epub.OPFView(\n      this.opf,\n      this.viewport,\n      this.fontMapper,\n      this.pref,\n      this.setPageSize.bind(this),\n    );\n    if (tocVisible) {\n      this.sendCommand({ a: \"toc\", v: \"show\", autohide: tocAutohide });\n    }\n  }\n\n  /**\n   * Show current page or spread depending on the setting\n   * (this.pref.spreadView).\n   * @param sync If true, get the necessary page synchronously (not waiting\n   *     another rendering task)\n   */\n  private showCurrent(page: Vtree.Page, sync?: boolean): Task.Result<null> {\n    this.needRefresh = false;\n    this.removePageListeners();\n\n    const spreadView = this.resolveSpreadView(this.viewport, page.dimensions);\n    if (spreadView !== this.pref.spreadView) {\n      this.updateSpreadView(spreadView);\n    }\n\n    if (spreadView) {\n      return this.opfView\n        .getSpread(this.pagePosition, sync)\n        .thenAsync((spread) => {\n          if (!spread.left && !spread.right) {\n            return Task.newResult(null);\n          }\n          if (\n            spread.left &&\n            spread.right &&\n            (!this.resolveSpreadView(this.viewport, spread.left.dimensions) ||\n              !this.resolveSpreadView(this.viewport, spread.right.dimensions))\n          ) {\n            // Turn off spread view mode if either left or right page is not\n            // suitable for spread view.\n            this.updateSpreadView(false);\n            this.showPage(page);\n            this.setPageZoom(page);\n            this.currentPage = page;\n            return Task.newResult(null);\n          }\n          this.showSpread(spread);\n          this.setSpreadZoom(spread);\n          this.currentPage =\n            page.side === Constants.PageSide.LEFT ? spread.left : spread.right;\n          return Task.newResult(null);\n        });\n    } else {\n      this.showPage(page);\n      this.setPageZoom(page);\n      this.currentPage = page;\n      return Task.newResult(null);\n    }\n  }\n\n  setPageZoom(page: Vtree.Page) {\n    const zoom = this.getAdjustedZoomFactor(page.dimensions);\n    this.viewport?.zoom(page.dimensions.width, page.dimensions.height, zoom);\n  }\n\n  setSpreadZoom(spread: Vtree.Spread) {\n    const dim = this.getSpreadDimensions(spread);\n    this.viewport?.zoom(dim.width, dim.height, this.getAdjustedZoomFactor(dim));\n  }\n\n  /**\n   * @returns adjusted zoom factor\n   */\n  getAdjustedZoomFactor(pageDimension: {\n    width: number;\n    height: number;\n  }): number {\n    return this.fitToScreen\n      ? this.calculateZoomFactorToFitInsideViewPort(pageDimension)\n      : this.zoom;\n  }\n\n  /**\n   * Returns width and height of the spread, including the margin between pages.\n   */\n  getSpreadDimensions(spread: Vtree.Spread): { width: number; height: number } {\n    let width = 0;\n    let height = 0;\n    if (spread.left) {\n      width += spread.left.dimensions.width;\n      height = spread.left.dimensions.height;\n    }\n    if (spread.right) {\n      width += spread.right.dimensions.width;\n      height = Math.max(height, spread.right.dimensions.height);\n    }\n    if (spread.left && spread.right) {\n      width += this.pref.pageBorder * 2;\n      // Adjust spread horizontal alignment when left/right page widths differ\n      width += Math.abs(\n        spread.left.dimensions.width - spread.right.dimensions.width,\n      );\n    }\n    return { width, height };\n  }\n\n  /**\n   * Returns zoom factor corresponding to the specified zoom type.\n   */\n  queryZoomFactor(type: ZoomType): number {\n    if (!this.currentPage) {\n      throw new Error(\"no page exists.\");\n    }\n    switch (type) {\n      case ZoomType.FIT_INSIDE_VIEWPORT: {\n        let pageDim: { width: number; height: number };\n        if (this.pref.spreadView) {\n          Asserts.assert(this.currentSpread);\n          pageDim = this.getSpreadDimensions(this.currentSpread);\n        } else {\n          pageDim = this.currentPage.dimensions;\n        }\n        return this.calculateZoomFactorToFitInsideViewPort(pageDim);\n      }\n      default:\n        throw new Error(`unknown zoom type: ${type}`);\n    }\n  }\n\n  /**\n   * @returns zoom factor to fit inside viewport\n   */\n  calculateZoomFactorToFitInsideViewPort(pageDimension: {\n    width: number;\n    height: number;\n  }): number {\n    if (!this.viewport) {\n      return this.zoom;\n    }\n    const widthZoom = this.viewport.width / pageDimension.width;\n    const heightZoom = this.viewport.height / pageDimension.height;\n    return Math.min(widthZoom, heightZoom);\n  }\n\n  private cancelRenderingTask() {\n    if (this.renderTask) {\n      this.renderTask.interrupt(new RenderingCanceledError());\n    }\n    this.renderTask = null;\n  }\n\n  resize(): Task.Result<boolean> {\n    this.needResize = false;\n    this.needRefresh = false;\n    if (this.sizeIsGood()) {\n      return Task.newResult(true);\n    }\n    this.setReadyState(Constants.ReadyState.LOADING);\n    this.cancelRenderingTask();\n    const resizeTask = Task.currentTask()\n      .getScheduler()\n      .run(() =>\n        Task.handle(\n          \"resize\",\n          (frame) => {\n            if (!this.opf) {\n              frame.finish(false);\n              return;\n            }\n            this.renderTask = resizeTask;\n            Profile.profiler.registerStartTiming(\"render (resize)\");\n            this.reset();\n            if (this.pagePosition) {\n              // When resizing, do not use the current page index, for a page\n              // index corresponding to the current position in the document\n              // (offsetInItem) can change due to different layout caused by\n              // different viewport size.\n\n              // Update(2019-03): to avoid unexpected page move (first page to next),\n              // keep pageIndex == 0 when offsetInItem == 0\n              if (\n                !(\n                  this.pagePosition.pageIndex == 0 &&\n                  this.pagePosition.offsetInItem == 0\n                )\n              ) {\n                this.pagePosition.pageIndex = -1;\n              }\n            }\n\n            // epageCount counting depends renderAllPages mode\n            this.opf.setEPageCountMode(this.renderAllPages);\n\n            // With renderAllPages option specified, the rendering is\n            // performed after the initial page display, otherwise users are\n            // forced to wait the rendering finish in front of a blank page.\n            this.opfView\n              .renderPagesUpto(this.pagePosition, !this.renderAllPages)\n              .then((result) => {\n                if (!result) {\n                  frame.finish(false);\n                  return;\n                }\n                this.pagePosition = result.position;\n                this.showCurrent(result.page, true).then(() => {\n                  this.setReadyState(Constants.ReadyState.INTERACTIVE);\n\n                  this.opf\n                    .countEPages((epageCount) => {\n                      const notification = {\n                        t: \"nav\",\n                        epageCount: epageCount,\n                        first: this.currentPage.isFirstPage,\n                        last: this.currentPage.isLastPage,\n                        metadata: this.opf.metadata,\n                        docTitle:\n                          this.opf.spine[this.pagePosition.spineIndex].title,\n                      };\n                      if (\n                        this.currentPage.isFirstPage ||\n                        (this.pagePosition.pageIndex == 0 &&\n                          this.opf.spine[this.pagePosition.spineIndex].epage)\n                      ) {\n                        notification[\"epage\"] =\n                          this.opf.spine[this.pagePosition.spineIndex].epage;\n                      }\n                      this.callback(notification);\n                    })\n                    .then(() => {\n                      this.reportPosition().then((p) => {\n                        const r = this.renderAllPages\n                          ? this.opfView.renderAllPages()\n                          : Task.newResult(null);\n                        r.then(() => {\n                          if (this.renderTask === resizeTask) {\n                            this.renderTask = null;\n                          }\n                          Profile.profiler.registerEndTiming(\"render (resize)\");\n                          // JavaScript in HTML documents support\n                          if (\n                            Scripts.allowScripts &&\n                            Scripts.hasScripts(this.window)\n                          ) {\n                            Scripts.loadScriptsAtEnd(this.window).then(() => {\n                              if (this.renderAllPages) {\n                                this.setReadyState(\n                                  Constants.ReadyState.COMPLETE,\n                                );\n                              }\n                              this.callback({ t: \"loaded\" });\n                              frame.finish(p);\n                            });\n                          } else {\n                            if (this.renderAllPages) {\n                              this.setReadyState(Constants.ReadyState.COMPLETE);\n                            }\n                            this.callback({ t: \"loaded\" });\n                            frame.finish(p);\n                          }\n                        });\n                      });\n                    });\n                });\n              });\n          },\n          (frame, err) => {\n            if (err instanceof RenderingCanceledError) {\n              Profile.profiler.registerEndTiming(\"render (resize)\");\n              Logging.logger.debug(err.message);\n            } else {\n              throw err;\n            }\n          },\n        ),\n      );\n    return Task.newResult(true);\n  }\n\n  private sendLocationNotification(\n    page: Vtree.Page,\n    cfi: string | null,\n  ): Task.Result<boolean> {\n    const frame: Task.Frame<boolean> = Task.newFrame(\n      \"sendLocationNotification\",\n    );\n    const notification = {\n      t: \"nav\",\n      first: page.isFirstPage,\n      last: page.isLastPage,\n      metadata: this.opf.metadata,\n      docTitle: this.opf.spine[page.spineIndex].title,\n    };\n    this.opf\n      .getEPageFromPosition(this.pagePosition as Epub.Position)\n      .then((epage) => {\n        notification[\"epage\"] = epage;\n        notification[\"epageCount\"] = this.opf.epageCount;\n        if (cfi) {\n          notification[\"cfi\"] = cfi;\n        }\n        this.callback(notification);\n        frame.finish(true);\n      });\n    return frame.result();\n  }\n\n  getCurrentPageProgression(): Constants.PageProgression | null {\n    return this.opfView\n      ? this.opfView.getCurrentPageProgression(this.pagePosition)\n      : null;\n  }\n\n  moveTo(command: Base.JSON): Task.Result<boolean> {\n    let method: () => Task.Result<Epub.PageAndPosition>;\n    if (\n      this.readyState !== Constants.ReadyState.COMPLETE &&\n      command[\"where\"] !== \"next\"\n    ) {\n      this.setReadyState(Constants.ReadyState.LOADING);\n    }\n    if (typeof command[\"where\"] == \"string\") {\n      let m: (\n        position: Epub.Position,\n        sync: boolean,\n      ) => Task.Result<Epub.PageAndPosition>;\n      switch (command[\"where\"]) {\n        case \"next\":\n          m = this.pref.spreadView\n            ? this.opfView.nextSpread\n            : this.opfView.nextPage;\n          break;\n        case \"previous\":\n          m = this.pref.spreadView\n            ? this.opfView.previousSpread\n            : this.opfView.previousPage;\n          break;\n        case \"last\":\n          m = this.opfView.lastPage;\n          break;\n        case \"first\":\n          m = this.opfView.firstPage;\n          break;\n        default:\n          return Task.newResult(true);\n      }\n      if (m) {\n        method = () =>\n          m.call(this.opfView, this.pagePosition, !this.renderAllPages);\n      }\n    } else if (typeof command[\"epage\"] == \"number\") {\n      const epage = command[\"epage\"] as number;\n      method = () =>\n        this.opfView.navigateToEPage(\n          epage,\n          this.pagePosition,\n          !this.renderAllPages,\n        );\n    } else if (typeof command[\"url\"] == \"string\") {\n      const url = command[\"url\"] as string;\n      method = () =>\n        this.opfView.navigateTo(url, this.pagePosition, !this.renderAllPages);\n    } else if (typeof command[\"position\"]?.spineIndex == \"number\") {\n      const position = command[\"position\"] as Epub.Position;\n      method = () => this.opfView.findPage(position, !this.renderAllPages);\n    } else {\n      return Task.newResult(true);\n    }\n    if (!this.opfView) {\n      return Task.newResult(true);\n    }\n    const frame: Task.Frame<boolean> = Task.newFrame(\"moveTo\");\n    method.call(this.opfView).then((result) => {\n      let cont: Task.Result<boolean>;\n      if (result) {\n        this.pagePosition = result.position;\n        const innerFrame: Task.Frame<boolean> =\n          Task.newFrame(\"moveTo.showCurrent\");\n        cont = innerFrame.result();\n        this.showCurrent(result.page, !this.renderAllPages).then(() => {\n          this.reportPosition().thenFinish(innerFrame);\n        });\n      } else {\n        cont = Task.newResult(true);\n      }\n      cont.then((res) => {\n        if (this.readyState === Constants.ReadyState.LOADING) {\n          this.setReadyState(Constants.ReadyState.INTERACTIVE);\n        }\n        frame.finish(res);\n      });\n    });\n    return frame.result();\n  }\n\n  showTOC(command: Base.JSON): Task.Result<boolean> {\n    const autohide = !!command[\"autohide\"];\n    const visibility = command[\"v\"];\n    const currentVisibility = this.opfView.isTOCVisible();\n    const changeAutohide =\n      autohide != this.opfView.tocAutohide && visibility != \"hide\";\n    if (currentVisibility) {\n      if (visibility == \"show\" && !changeAutohide) {\n        return Task.newResult(true);\n      }\n    } else {\n      if (visibility == \"hide\") {\n        return Task.newResult(true);\n      }\n    }\n    if (currentVisibility && visibility != \"show\") {\n      this.opfView.hideTOC();\n      return Task.newResult(true);\n    } else {\n      const frame: Task.Frame<boolean> = Task.newFrame(\"showTOC\");\n      this.opfView.showTOC(autohide).then((page) => {\n        if (page) {\n          if (changeAutohide) {\n            page.listeners = {};\n          }\n          if (autohide) {\n            const hideTOC = () => {\n              this.opfView.hideTOC();\n            };\n            page.addEventListener(\"hyperlink\", hideTOC, false);\n            // page.container.addEventListener(\"click\", hideTOC, false);\n          }\n          page.addEventListener(\"hyperlink\", this.hyperlinkListener, false);\n        }\n        frame.finish(true);\n      });\n      return frame.result();\n    }\n  }\n\n  runCommand(command: Base.JSON): Task.Result<boolean> {\n    const actionName = command[\"a\"] || \"\";\n    return Task.handle(\n      \"runCommand\",\n      (frame) => {\n        const action = this.actions[actionName];\n        if (action) {\n          action.call(this, command).then(() => {\n            this.callback({ t: \"done\", a: actionName });\n            frame.finish(true);\n          });\n        } else {\n          Logging.logger.error(\"No such action:\", actionName);\n          frame.finish(true);\n        }\n      },\n      (frame, err) => {\n        Logging.logger.error(err, \"Error during action:\", actionName);\n        frame.finish(true);\n      },\n    );\n  }\n\n  initEmbed(cmd: Base.JSON | string): void {\n    let command = maybeParse(cmd);\n    let continuation: Task.Continuation<boolean> | null = null;\n    const viewer = this;\n    Task.start(() => {\n      const frame: Task.Frame<boolean> = Task.newFrame(\"commandLoop\");\n      const scheduler = Task.currentTask().getScheduler();\n      viewer.hyperlinkListener = (evt) => {\n        const hrefEvent = evt as Vtree.PageHyperlinkEvent;\n        const internal =\n          hrefEvent.href.charAt(0) === \"#\" ||\n          viewer.packageURL.some(\n            (url) => hrefEvent.href.substr(0, url.length) == url,\n          );\n        if (internal) {\n          evt.preventDefault();\n          const msg = {\n            t: \"hyperlink\",\n            href: hrefEvent.href,\n            internal: internal,\n          };\n          scheduler.run(() => {\n            viewer.callback(msg);\n            return Task.newResult(true);\n          });\n        }\n      };\n      frame\n        .loopWithFrame((loopFrame) => {\n          if (viewer.needResize) {\n            viewer.resize().then(() => {\n              loopFrame.continueLoop();\n            });\n          } else if (viewer.needRefresh) {\n            if (viewer.currentPage) {\n              viewer\n                .showCurrent(viewer.currentPage, !this.renderAllPages)\n                .then(() => {\n                  loopFrame.continueLoop();\n                });\n            }\n          } else if (command) {\n            const cmd = command;\n            command = null;\n            viewer.runCommand(cmd).then(() => {\n              loopFrame.continueLoop();\n            });\n          } else {\n            const frameInternal: Task.Frame<boolean> =\n              Task.newFrame(\"waitForCommand\");\n            continuation = frameInternal.suspend(this);\n            frameInternal.result().then(() => {\n              loopFrame.continueLoop();\n            });\n          }\n        })\n        .thenFinish(frame);\n      return frame.result();\n    });\n    viewer.kick = () => {\n      const cont = continuation;\n      if (cont) {\n        continuation = null;\n        cont.schedule(true);\n      }\n    };\n    viewer.sendCommand = (cmd) => {\n      if (command) {\n        return false;\n      }\n      command = maybeParse(cmd);\n      viewer.kick();\n      return true;\n    };\n    this.window[\"adapt_command\"] = viewer.sendCommand;\n  }\n}\n\n/**\n * @enum {string}\n */\nexport enum ZoomType {\n  FIT_INSIDE_VIEWPORT = \"fit inside viewport\",\n}\n\n/**\n * Error representing that the rendering has been canceled.\n */\nclass RenderingCanceledError extends Error {\n  name: string = \"RenderingCanceledError\";\n  message: string = \"Page rendering has been canceled\";\n  stack: string;\n\n  constructor() {\n    super();\n    // Set the prototype explicitly.\n    // https://github.com/Microsoft/TypeScript/wiki/Breaking-Changes#extending-built-ins-like-error-array-and-map-may-no-longer-work\n    Object.setPrototypeOf(this, RenderingCanceledError.prototype);\n    this.stack = new Error().stack;\n  }\n}\n\nexport function maybeParse(cmd: any): Base.JSON {\n  if (typeof cmd == \"string\") {\n    return Base.stringToJSON(cmd);\n  }\n  return cmd;\n}\n", "/**\n * Copyright 2015 Daishinsha Inc.\n * Copyright 2018 Vivliostyle Foundation\n *\n * Vivliostyle.js is free software: you can redistribute it and/or modify\n * it under the terms of the GNU Affero General Public License as published by\n * the Free Software Foundation, either version 3 of the License, or\n * (at your option) any later version.\n *\n * Vivliostyle.js is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n * GNU Affero General Public License for more details.\n *\n * You should have received a copy of the GNU Affero General Public License\n * along with Vivliostyle.js.  If not, see <http://www.gnu.org/licenses/>.\n *\n * @fileoverview CoreViewer - Vivliostyle CoreViewer class\n */\nimport * as AdaptiveViewer from \"./adaptive-viewer\";\nimport * as Base from \"./base\";\nimport * as Constants from \"./constants\";\nimport * as Epub from \"./epub\";\nimport * as Profile from \"./profile\";\nimport * as Toc from \"./toc\";\nimport { ErrorInfo } from \"./logging\";\n\nexport interface Payload {\n  type: string;\n  internal: boolean;\n  href: string;\n  content: ErrorInfo;\n  cfi: string;\n  first: boolean;\n  last: boolean;\n  epage: number;\n  epageCount: number;\n  metadata: unknown;\n  docTitle: string;\n}\n\nconst PageProgression = Constants.PageProgression;\n\n/**\n * Viewer settings that must be passed to Viewer's constructor.\n * - userAgentRootURL: URL of a directory from which viewer resource files\n *   (under resources/ directory in the source repository) are served.\n * - viewportElement: An element used as the viewport of the displayed contents.\n * - window: Window object. If omitted, current `window` is used.\n * - debug: Debug flag.\n */\nexport type CoreViewerSettings = {\n  userAgentRootURL?: string;\n  viewportElement: HTMLElement;\n  window?: Window;\n  debug?: boolean;\n};\n\n/**\n * Viewer options that can be set after the Viewer object is constructed.\n * - autoResize: Run layout again when the window is resized. default: true\n * - fontSize: Default font size (px). default: 16\n * - pageBorderWidth: Width of a border between two pages in a single\n *   spread (px). Effective only in spread view mode. default: 1\n * - renderAllPages: Render all pages at the document load time. default: true\n * - pageViewMode: Page view mode (singlePage / spread / autoSpread).\n *   default: singlePage\n * - zoom: Zoom factor with which pages are displayed. default: 1\n * - fitToScreen: Auto adjust zoom factor to fit the screen. default: false\n * - defaultPaperSize: Default paper size in px. Effective when `@page` size\n *   is set to auto. default: undefined (means the windows size is used as\n *   paper size).\n * - allowScripts: Allow JavaScript in documents. default: true\n * - pixelRatio: Set output pixel ratio. Enables very thin border width and\n *   improves layout precision, emulating high pixel ratio.\n *   default: 8. Set 0 to disable pixel ratio emulation.\n */\nexport type CoreViewerOptions = {\n  autoResize?: boolean;\n  fontSize?: number;\n  pageBorderWidth?: number;\n  renderAllPages?: boolean;\n  pageViewMode?: AdaptiveViewer.PageViewMode;\n  zoom?: number;\n  fitToScreen?: boolean;\n  defaultPaperSize?: { width: number; height: number };\n  allowScripts?: boolean;\n  pixelRatio?: number;\n};\n\nfunction getDefaultViewerOptions(): CoreViewerOptions {\n  return {\n    autoResize: true,\n    fontSize: 16,\n    pageBorderWidth: 1,\n    renderAllPages: true,\n    pageViewMode: AdaptiveViewer.PageViewMode.AUTO_SPREAD,\n    zoom: 1,\n    fitToScreen: false,\n    defaultPaperSize: undefined,\n    allowScripts: true,\n    pixelRatio: 8,\n  };\n}\n\nfunction convertViewerOptions(options: CoreViewerOptions): object {\n  const converted = {};\n  Object.keys(options).forEach((key) => {\n    const v = options[key];\n    switch (key) {\n      case \"autoResize\":\n        converted[\"autoresize\"] = v;\n        break;\n      case \"pageBorderWidth\":\n        converted[\"pageBorder\"] = v;\n        break;\n      default:\n        converted[key] = v;\n    }\n  });\n  return converted;\n}\n\n/**\n * Options for the displayed document.\n * - documentObject: Document object for the document. If provided, it is used\n *   directly without parsing the source again.\n * - fragment: Fragmentation identifier (EPUB CFI) of the location in the\n *   document which is to be displayed.\n * - authorStyleSheet: An array of author style sheets to be injected after all\n *   author style sheets referenced from the document. A single stylesheet may\n *   be a URL of the style sheet or a text content of the style sheet.\n * - userStyleSheet: An array of user style sheets to be injected.\n *   A single stylesheet may be a URL of the style sheet or a text content of\n *   the style sheet.\n */\nexport type DocumentOptions = {\n  documentObject?: Document;\n  fragment?: string;\n  authorStyleSheet?: { url?: string; text?: string }[];\n  userStyleSheet?: { url?: string; text?: string }[];\n};\n\n/**\n * Options for a single source document.\n * - url: URL of the document.\n * - startPage: If specified, the `page` page-based counter is set to the\n *   specified value on the first page of the document. It is equivalent to\n *   specifying `counter-reset: page [specified value - 1]` on that page.\n * - skipPagesBefore: If specified, the `page` page-based counter is\n *   incremented by the specified value *before* updating page-based counters\n *   on the first page of the document.\n *   This option is ignored if `startPageNumber` option is also specified.\n */\nexport type SingleDocumentOptions =\n  | string\n  | {\n      url: string;\n      startPage?: number;\n      skipPagesBefore?: number;\n    };\n\n/**\n * Vivliostyle Viewer class.\n */\nexport class CoreViewer {\n  private initialized: boolean = false;\n  private adaptViewer_: AdaptiveViewer.AdaptiveViewer;\n  private options: CoreViewerOptions;\n  private eventTarget: Base.SimpleEventTarget;\n  readyState: Constants.ReadyState;\n\n  constructor(\n    private readonly settings: CoreViewerSettings,\n    opt_options?: CoreViewerOptions,\n  ) {\n    Constants.setDebug(settings.debug);\n    this.adaptViewer_ = new AdaptiveViewer.AdaptiveViewer(\n      settings[\"window\"] || window,\n      settings[\"viewportElement\"],\n      \"main\",\n      this.dispatcher.bind(this),\n    );\n    this.options = getDefaultViewerOptions();\n    if (opt_options) {\n      this.setOptions(opt_options);\n    }\n    this.eventTarget = new Base.SimpleEventTarget();\n    Object.defineProperty(this, \"readyState\", {\n      get() {\n        return this.adaptViewer_.readyState;\n      },\n    });\n  }\n\n  /**\n   * Set ViewerOptions to the viewer.\n   */\n  setOptions(options: CoreViewerOptions) {\n    const command = Object.assign(\n      { a: \"configure\" },\n      convertViewerOptions(options),\n    );\n    this.adaptViewer_.sendCommand(command);\n    Object.assign(this.options, options);\n  }\n\n  private dispatcher(msg: Base.JSON) {\n    /** @dict */\n    const event = { type: msg[\"t\"] };\n    const o = msg as object;\n    Object.keys(o).forEach((key) => {\n      if (key !== \"t\") {\n        event[key] = o[key];\n      }\n    });\n    this.eventTarget.dispatchEvent(event);\n  }\n\n  /**\n   * Add a listener function, which is invoked when the specified type of event\n   * is dispatched.\n   * @param type Event type.\n   * @param listener Listener function.\n   */\n  addListener(type: string, listener: (payload: Payload) => void) {\n    this.eventTarget.addEventListener(\n      type,\n      listener as Base.EventListener,\n      false,\n    );\n  }\n\n  /**\n   * Remove an event listener.\n   * @param type Event type.\n   * @param listener Listener function.\n   */\n  removeListener(type: string, listener: (payload: Payload) => void) {\n    this.eventTarget.removeEventListener(\n      type,\n      listener as Base.EventListener,\n      false,\n    );\n  }\n\n  /**\n   * Load an HTML or XML document(s).\n   */\n  loadDocument(\n    singleDocumentOptions: SingleDocumentOptions | SingleDocumentOptions[],\n    opt_documentOptions?: DocumentOptions,\n    opt_viewerOptions?: CoreViewerOptions,\n  ) {\n    if (\n      !singleDocumentOptions ||\n      (Array.isArray(singleDocumentOptions)\n        ? !singleDocumentOptions[0] ||\n          (typeof singleDocumentOptions[0] !== \"string\" &&\n            !singleDocumentOptions[0].url)\n        : typeof singleDocumentOptions !== \"string\" &&\n          !singleDocumentOptions.url)\n    ) {\n      this.eventTarget.dispatchEvent({\n        type: \"error\",\n        content: { error: new Error(\"No URL specified\") },\n      });\n      return;\n    }\n    this.loadDocumentOrPublication(\n      singleDocumentOptions,\n      null,\n      opt_documentOptions,\n      opt_viewerOptions,\n    );\n  }\n\n  /**\n   * Load an EPUB/WebPub publication.\n   */\n  loadPublication(\n    pubUrl: string,\n    opt_documentOptions?: DocumentOptions,\n    opt_viewerOptions?: CoreViewerOptions,\n  ) {\n    if (!pubUrl) {\n      this.eventTarget.dispatchEvent({\n        type: \"error\",\n        content: { error: new Error(\"No URL specified\") },\n      });\n      return;\n    }\n    this.loadDocumentOrPublication(\n      null,\n      pubUrl,\n      opt_documentOptions,\n      opt_viewerOptions,\n    );\n  }\n\n  /**\n   * Load an HTML or XML document, or an EPUB/WebPub publication.\n   */\n  private loadDocumentOrPublication(\n    singleDocumentOptions:\n      | SingleDocumentOptions\n      | SingleDocumentOptions[]\n      | null,\n    pubUrl: string | null,\n    opt_documentOptions?: DocumentOptions,\n    opt_viewerOptions?: CoreViewerOptions,\n  ) {\n    const documentOptions = opt_documentOptions || {};\n\n    function convertStyleSheetArray(arr) {\n      if (arr) {\n        return arr.map((s) => ({ url: s.url || null, text: s.text || null }));\n      } else {\n        return undefined;\n      }\n    }\n    const authorStyleSheet = convertStyleSheetArray(\n      documentOptions[\"authorStyleSheet\"],\n    );\n    const userStyleSheet = convertStyleSheetArray(\n      documentOptions[\"userStyleSheet\"],\n    );\n    if (opt_viewerOptions) {\n      Object.assign(this.options, opt_viewerOptions);\n    }\n    const command = Object.assign(\n      {\n        a: singleDocumentOptions ? \"loadXML\" : \"loadPublication\",\n        userAgentRootURL: this.settings[\"userAgentRootURL\"],\n        url: convertSingleDocumentOptions(singleDocumentOptions) || pubUrl,\n        document: documentOptions[\"documentObject\"],\n        fragment: documentOptions[\"fragment\"],\n        authorStyleSheet: authorStyleSheet,\n        userStyleSheet: userStyleSheet,\n      },\n      convertViewerOptions(this.options),\n    );\n    if (this.initialized) {\n      this.adaptViewer_.sendCommand(command);\n    } else {\n      this.initialized = true;\n      this.adaptViewer_.initEmbed(command);\n    }\n  }\n\n  /**\n   * Returns the current page progression of the viewer. If no document is\n   * loaded, returns null.\n   */\n  getCurrentPageProgression(): Constants.PageProgression | null {\n    return this.adaptViewer_.getCurrentPageProgression();\n  }\n\n  private resolveNavigation(nav: Navigation): Navigation {\n    switch (nav) {\n      case Navigation.LEFT:\n        return this.getCurrentPageProgression() === PageProgression.LTR\n          ? Navigation.PREVIOUS\n          : Navigation.NEXT;\n      case Navigation.RIGHT:\n        return this.getCurrentPageProgression() === PageProgression.LTR\n          ? Navigation.NEXT\n          : Navigation.PREVIOUS;\n      default:\n        return nav;\n    }\n  }\n\n  /**\n   * Navigate to the specified page.\n   */\n  navigateToPage(nav: Navigation, opt_epage?: number) {\n    if (nav === Navigation.EPAGE) {\n      this.adaptViewer_.sendCommand({\n        a: \"moveTo\",\n        epage: opt_epage,\n      });\n    } else {\n      this.adaptViewer_.sendCommand({\n        a: \"moveTo\",\n        where: this.resolveNavigation(nav),\n      });\n    }\n  }\n\n  /**\n   * Navigate to the specified internal URL.\n   */\n  navigateToInternalUrl(url: string) {\n    this.adaptViewer_.sendCommand({ a: \"moveTo\", url: url });\n  }\n\n  /**\n   * Navigate to the specified position.\n   */\n  navigateToPosition(position: {\n    spineIndex: number;\n    pageIndex?: number;\n    offsetInItem?: number;\n  }) {\n    this.adaptViewer_.sendCommand({\n      a: \"moveTo\",\n      position: {\n        spineIndex: position.spineIndex,\n        pageIndex: position.pageIndex ?? -1,\n        offsetInItem: position.offsetInItem ?? -1,\n      },\n    });\n  }\n\n  /**\n   * @returns True if TOC is visible, false if hidden, null if TOC is unavailable\n   */\n  isTOCVisible(): boolean | null {\n    if (\n      this.adaptViewer_.opfView &&\n      this.adaptViewer_.opfView.opf &&\n      this.adaptViewer_.opfView.opf.toc\n    ) {\n      return !!this.adaptViewer_.opfView.isTOCVisible();\n    } else {\n      return null;\n    }\n  }\n\n  /**\n   * Show or hide TOC box\n   * @param opt_autohide If true, automatically hide when click TOC item\n   * @param opt_show If true show TOC, false hide TOC. If null or undefined toggle TOC.\n   */\n  showTOC(opt_show?: boolean | null, opt_autohide?: boolean) {\n    const visibility = opt_show == null ? \"toggle\" : opt_show ? \"show\" : \"hide\";\n    this.adaptViewer_.sendCommand({\n      a: \"toc\",\n      v: visibility,\n      autohide: opt_autohide,\n    });\n  }\n\n  /**\n   * Returns zoom factor corresponding to the specified zoom type.\n   */\n  queryZoomFactor(type: AdaptiveViewer.ZoomType): number {\n    return this.adaptViewer_.queryZoomFactor(type);\n  }\n\n  getPageSizes(): { width: number; height: number }[] {\n    return this.adaptViewer_.pageSizes;\n  }\n\n  /**\n   * Returns the current structure of the TOC once it has\n   * been shown, or the empty array if there is no TOC.\n   */\n  getTOC(): Toc.TOCItem[] {\n    return this.adaptViewer_.opfView?.tocView?.getTOC();\n  }\n\n  /**\n   * Returns metadata for the publication. Metadata is\n   * organized as an object of fully-qualified IRI properties\n   * containing arrays of metadata entries. The first element\n   * in the array is primary and should be used by default. Other\n   * entries may overload or refine that metadata.\n   */\n  getMetadata(): Epub.Meta {\n    return this.adaptViewer_.opf.getMetadata();\n  }\n\n  /**\n   * Returns the cover for an EPUB publication, if specified.\n   */\n  getCover(): Epub.OPFItem | null {\n    return this.adaptViewer_.opf.cover;\n  }\n}\n\nfunction convertSingleDocumentOptions(\n  singleDocumentOptions: SingleDocumentOptions | SingleDocumentOptions[],\n): AdaptiveViewer.SingleDocumentParam[] | null {\n  function toNumberOrNull(num: any): number | null {\n    return typeof num === \"number\" ? num : null;\n  }\n\n  function convert(opt) {\n    if (typeof opt === \"string\") {\n      return {\n        url: opt,\n        startPage: null,\n        skipPagesBefore: null,\n      } as AdaptiveViewer.SingleDocumentParam;\n    } else {\n      return {\n        url: opt[\"url\"],\n        startPage: toNumberOrNull(opt[\"startPage\"]),\n        skipPagesBefore: toNumberOrNull(opt[\"skipPagesBefore\"]),\n      } as AdaptiveViewer.SingleDocumentParam;\n    }\n  }\n  if (Array.isArray(singleDocumentOptions)) {\n    return singleDocumentOptions.map(convert);\n  } else if (singleDocumentOptions) {\n    return [convert(singleDocumentOptions)];\n  } else {\n    return null;\n  }\n}\n\n/**\n * @enum {string}\n */\nexport enum Navigation {\n  PREVIOUS = \"previous\",\n  NEXT = \"next\",\n  LEFT = \"left\",\n  RIGHT = \"right\",\n  FIRST = \"first\",\n  LAST = \"last\",\n  EPAGE = \"epage\",\n}\n\nexport type ZoomType = AdaptiveViewer.ZoomType;\nexport const ZoomType = AdaptiveViewer.ZoomType; // eslint-disable-line no-redeclare\n\nexport type PageViewMode = AdaptiveViewer.PageViewMode;\nexport const PageViewMode = AdaptiveViewer.PageViewMode; // eslint-disable-line no-redeclare\n\nProfile.profiler.forceRegisterEndTiming(\"load_vivliostyle\");\n", "// Johannes Wilm\n// Vivliostyle Foundation\n\nimport { CoreViewer } from \"./core-viewer\";\n\ninterface IFrameWindowForPrint {\n  printInstance?: VivliostylePrint;\n}\n\nexport interface PrintConfig {\n  title: string;\n  printCallback: (iframeWin: Window) => void;\n  errorCallback: (message: string) => void | null;\n  hideIframe: boolean;\n  removeIframe: boolean;\n}\n\nclass VivliostylePrint {\n  htmlDoc: string;\n  title: string;\n  printCallback: (iframeWin: Window) => void;\n  errorCallback: (message: string) => void;\n  hideIframe: boolean;\n  removeIframe: boolean;\n  iframe: HTMLIFrameElement;\n  iframeWin: Window;\n  window: Window & typeof globalThis & IFrameWindowForPrint;\n\n  constructor(\n    htmlDoc: string,\n    {\n      title = \"\",\n      printCallback = (iframeWin: Window) => iframeWin.print(),\n      errorCallback = null,\n      hideIframe = true,\n      removeIframe = true,\n    }: PrintConfig,\n  ) {\n    this.htmlDoc = htmlDoc;\n    this.title = title;\n    this.printCallback = printCallback;\n    this.errorCallback = errorCallback;\n    this.hideIframe = hideIframe;\n    this.removeIframe = removeIframe;\n  }\n\n  init() {\n    this.iframe = document.createElement(\"iframe\");\n\n    if (this.hideIframe) {\n      this.iframe.style.width = \"0\"; // We don't want the iframe to be seen, so we make it zero size with zero border.\n      this.iframe.style.height = \"0\";\n      this.iframe.style.borderWidth = \"0\";\n    }\n\n    this.window = window;\n    this.window.printInstance = this;\n    this.iframe.srcdoc = `\n      <!DOCTYPE html>\n      <html data-vivliostyle-paginated=\"true\">\n        <head>\n          <meta charset='utf-8'/>\n          <meta name='viewport' content='width=device-width, initial-scale=1.0'/>\n          <title>${this.title}</title>\n          <style>\n            html[data-vivliostyle-paginated] {\n              width: 100%;\n              height: 100%;\n            }\n            html[data-vivliostyle-paginated] body,\n            html[data-vivliostyle-paginated] [data-vivliostyle-viewer-viewport] {\n              width: 100% !important;\n              height: 100% !important;\n            }\n            html[data-vivliostyle-paginated],\n            html[data-vivliostyle-paginated] body {\n              margin: 0;\n              padding: 0;\n            }\n          </style>\n          <style id='vivliostyle-page-rules'></style>\n        </head>\n        <body onload='parent.printInstance.runInIframe(window)'>\n          <div id=\"vivliostyle-viewer-viewport\"></div>\n        </body>\n      </html>`;\n\n    document.body.appendChild(this.iframe);\n  }\n\n  runInIframe(iframeWin: Window) {\n    this.iframeWin = iframeWin;\n    return this.preparePrint()\n      .then(() => this.browserPrint())\n      .then(() => this.cleanUp());\n  }\n\n  preparePrint() {\n    this.iframeWin.document.title = this.title;\n    const docBlob = new Blob([this.htmlDoc], {\n        type: \"text/html\",\n      }),\n      docURL = URL.createObjectURL(docBlob),\n      Viewer = new CoreViewer({\n        viewportElement: this.iframeWin.document.body\n          .firstElementChild as HTMLElement,\n        window: this.iframeWin,\n        debug: true,\n      });\n    return new Promise<void>((resolve) => {\n      Viewer.addListener(\"readystatechange\", () => {\n        if (Viewer.readyState === \"complete\") {\n          resolve();\n        }\n      });\n\n      if (this.errorCallback) {\n        Viewer.addListener(\"error\", (payload) => {\n          const message =\n            payload.content.error?.toString() ??\n            payload.content.messages.join(\"\\n\");\n          this.errorCallback(message);\n        });\n      }\n\n      Viewer.loadDocument({\n        url: docURL,\n      });\n    });\n  }\n\n  browserPrint() {\n    this.printCallback(this.iframeWin);\n  }\n\n  cleanUp() {\n    delete this.window.printInstance;\n    if (this.removeIframe) {\n      this.iframe.parentElement.removeChild(this.iframe);\n    }\n  }\n}\n\nexport function printHTML(htmlDoc: string, config: PrintConfig) {\n  const instance = new VivliostylePrint(htmlDoc, config);\n  instance.init();\n}\n", "export {printHTML} from \"@vivliostyle/core\"\n", "import {\n    printHTML\n} from \"../src\"\n\n\ndocument.getElementById('print').addEventListener('click', () => {\n    const html = document.getElementById('html').value,\n        css = document.getElementById('css').value,\n        title = document.getElementById('title').value,\n        htmlDoc = `\n        <!doctype html>\n        <html>\n            <head>\n                <meta charset=\"UTF-8\">\n                <title>${title}</title>\n                <style>${css}</style>\n            <head>\n            <body>${html}</body>\n        </html>`,\n        printCallback = iframeWin => {\n            const pageCount = iframeWin.document.querySelectorAll('[data-vivliostyle-page-container]').length\n            console.log(`page count: ${pageCount}`)\n            iframeWin.print()\n        },\n        errorCallback = message => {\n            alert(message)\n        }\n\n    printHTML(htmlDoc, {\n        title,\n        printCallback,\n        errorCallback,\n        hideIframe: true, // Whether to use a hidden iframe (default: true)\n        removeIframe: true // Whether to remove the iframe after use (default: true)\n    })\n})\n"],
  "mappings": "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ACA,EACA,EACA,GACA,EACA,EACA,EACA,EACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,GACA,GACA,GACA,GACA,EACA,GACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EACA,GACA,GACA,GACA,GACA,EACF,EAEAA,GAAc,GAAG,EAAI,GAKd,IAAMC,GAAyB,CACpC,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,EACF,EAEAA,GAAa,GAAG,EAAI,GAKb,IAAMC,GAA8B,CACzC,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,EACF,EAEAD,GAAa,GAAG,EAAI,GAKb,IAAME,GAAyB,CACpC,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,EACF,EAEAA,GAAa,GAAG,EAAI,GAKb,IAAMC,GAA4B,CACvC,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,EACF,EAEAA,GAAgB,GAAG,EAAI,GAKhB,IAAMC,GAAuB,CAClC,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,EACF,EAEAA,GAAW,GAAG,EAAI,GAKX,IAAMC,GAA0B,CACrC,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,EACF,EAEAA,GAAc,GAAG,EAAI,GAEd,IAAMC,GAA2BT,GAAY,GAAY,CAC9D,GACA,EACF,CAAC,EAEYU,GAAyBV,GAAY,GAAY,CAC5D,GACA,EACF,CAAC,EAEYW,GAAuBX,GAAY,GAAY,CAC1D,GACA,GACA,IACA,EACF,CAAC,EAEYY,GAAuBZ,GAAY,GAAY,CAC1D,GACA,EACF,CAAC,EAEYa,GAAyBb,GAAY,GAAY,CAC5D,GACA,EACF,CAAC,EAEYc,GAA2Bd,GAAY,GAAa,CAC/D,GACA,EACF,CAAC,EAEYe,GAA+Bf,GAAY,GAAgB,CACtE,GACA,GACA,GACA,EACF,CAAC,EAEYgB,GAA8BhB,GAAY,GAAc,CACnE,GACA,EACF,CAAC,EAEYiB,GAAsBjB,GAAY,GAAY,CACzD,GACA,GACA,GACA,EACF,CAAC,EAEYkB,GAA0BlB,GAAY,GAAc,CAC/D,GACA,EACF,CAAC,EAEYmB,GAA+BnB,GAAY,GAAc,CACpE,GACA,EACF,CAAC,EAEYoB,GAA+BpB,GAAY,GAAe,CACrE,GACA,GACA,GACA,EACF,CAAC,EAEYqB,GAAwBrB,GAAY,GAAa,CAC5D,GACA,GACA,GACA,GACA,GACA,GACA,GACA,EACF,CAAC,EAEYsB,GAAwBtB,GAAY,GAAa,CAC5D,GACA,GACA,GACA,GACA,GACA,GACA,GACA,EACF,CAAC,EAEYuB,GAA2BvB,GAAY,GAAa,CAC/D,GACA,GACA,GACA,GACA,GACA,GACA,GACA,EACF,CAAC,EAEYwB,GAA2BxB,GAAY,GAAa,CAC/D,GACA,GACA,GACA,GACA,GACA,GACA,GACA,EACF,CAAC,EAEYyB,GAAuBzB,GAAY,GAAY,CAC1D,EACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,EACF,CAAC,EAEY0B,GAA6B1B,GAAY,GAAa,CACjE,GACA,GACA,EACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,IACA,GACA,IACA,GACA,IACA,EACF,CAAC,EAEY2B,GAA8B3B,GAAY,GAAa,CAClE,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,IACA,EACF,CAAC,EAEY4B,GAA8B5B,GAAY,GAAa,CAClE,GACA,GACA,GACA,GACA,GACA,GACA,GACA,GACA,IACA,EACF,CAAC,EAEY6B,GAA2B7B,GAAY,GAAgB,CAClE,EACA,GACA,GACA,GACA,GACA,GACA,GACA,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,CAAO,GACpD,KAAK,QAAQ,qBAAsB,KAAK,UAAWA,CAAO,GAC1D,KAAK,QAAQ,gBAAiB,KAAK,UAAWA,CAAO,GAErD,KAAK,eACP,KAAK,2BACH,KAAK,QAAQ,MAAO,KAAK,WAAYA,CAAO,GAC5C,KAAK,QAAQ,aAAc,KAAK,WAAYA,CAAO,GACnD,KAAK,QAAQ,mBAAoB,KAAK,WAAYA,CAAO,GACzD,KAAK,QAAQ,cAAe,KAAK,WAAYA,CAAO,GAExD,QAAWonE,KAAiB,KAAK,SAC/BA,EAAc,kBAAkBpnE,CAAO,CAE3C,CACF,EAKammE,GAAoB,CAC/B,oBACA,qBACA,mBACA,sBACA,oBACA,qBACA,mBACA,sBACA,aACA,gBACA,gBACA,gBACA,WACA,YACF,EAKaa,GAAqB,CAChC,yBACA,0BACA,6BACA,4BACA,4BACA,0BACA,0BACA,wBACA,sBACA,qBACA,qBACA,sBACA,sBACA,wBACA,mBACA,mBACA,oBACA,sBACA,kBACA,oBACA,kBACA,aACA,UACA,UACA,wBACA,YACA,iBACA,QACF,EAKaZ,GAAwB,CACnC,QACA,cACA,YACA,aACA,cACA,cACA,iBACA,aACA,kBACA,kBACA,cACA,iBACA,cACA,YACA,iBACA,kBACA,eACA,wBACA,eACA,mBACA,yBACA,oBACA,uBACA,0BACA,eACA,uBACA,wBACA,uBACA,uBACA,2BACA,wBACA,4BACA,gBACA,sBACA,yBACA,sBACA,kBACA,mBACA,cACA,oBACA,oBACA,wBACA,0BACA,eACF,EAEaG,GAAiC,CAC5C,QACA,SACA,mBACA,aACA,iBACF,EAEaU,GAAoB,CAAC,YAAa,kBAAkB,EAEpDE,GAA4B,kBAE5BE,GAAN,cAAkCtD,EAA6B,CACpE,YAAYC,EAAsB,CAChC,MAAM,KAAMA,CAAO,CACrB,CAES,oBACPthC,EACAwkC,EACM,CACN,MAAM,oBAAoBxkC,EAASwkC,CAAe,EAG9B,KAAK,SACa,KACpC,CAACrzE,EAAGyF,IACDA,EAAE,QAAgB,YAAezF,EAAE,QAAgB,aACpDA,EAAE,QAAQ,MAAQyF,EAAE,QAAQ,KAChC,C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3CpsC,EACAkqB,EACcb,GACAC,EAChB,CACF,CACF,EAEawrD,GAAN,cAAqCD,EAAqB,CAC/D,YACElpE,EACA6e,EACA4J,EACA4kB,EACA,CACA,MAAMrtC,EAAO6e,EAAO4J,EAAQ4kB,CAAY,CAC1C,CACF,EAEa+7B,GAAN,MAAMC,WAAoCH,EAAqB,CACpE,YACElpE,EACA6e,EACA4J,EACA4kB,EACA,CACA,MAAMrtC,EAAO6e,EAAO4J,EAAQ4kB,CAAY,EACxC5kB,EAAO,UAAU,MAAW,IAAegY,EACrCr5B,GACJ,CACF,EACAqhB,EAAO,UAAU,OAAY,IAAegY,EACtCr5B,GACJ,CACF,CACF,CAES,mBACP7R,EACA8oB,EACAC,EACM,CACN,IAAMgrD,EAAY,IAAI9E,GACpB,KAAK,MACLjvE,EACA8oB,EACAC,EACA,KAAK,MACP,EACM3G,EAAU,IAAIwxD,GAClB,KAAK,MACL,KAAK,MACLG,EACA,KAAK,YACP,EACA,KAAK,MAAM,YAAY3xD,CAAO,CAChC,CAES,wBACPpiB,EACA8oB,EACAC,EACM,CACN,IAAMirD,EAAiB,IAAIlF,GACzB,KAAK,MACL9uE,EACA8oB,EACAC,EACA,KAAK,MACP,EACM3G,EAAU,IAAI0xD,GAClB,KAAK,MACL,KAAK,MACLE,EACA,KAAK,YACP,EACA,KAAK,MAAM,YAAY5xD,CAAO,CAChC,CACF,EAEa6xD,GAAN,cAAsCN,EAAqB,CAChE,YACElpE,EACA6e,EACA4J,EACA4kB,EACA,CACA,MAAMrtC,EAAO6e,EAAO4J,EAAQ4kB,CAAY,CAC1C,CAES,mBACP93C,EACA8oB,EACAC,EACM,CACN,IAAMgrD,EAAY,IAAI9E,GACpB,KAAK,MACLjvE,EACA8oB,EACAC,EACA,KAAK,MACP,EACM3G,EAAU,IAAIwxD,GAClB,KAAK,MACL,KAAK,MACLG,EACA,KAAK,YACP,EACA,KAAK,MAAM,YAAY3xD,CAAO,CAChC,CAES,wBACPpiB,EACA8oB,EACAC,EACM,CACN,IAAMirD,EAAiB,IAAIlF,GACzB,KAAK,MACL9uE,EACA8oB,EACAC,EACA,KA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",
  "names": ["require_diff", "__commonJSMin", "exports", "module", "DIFF_DELETE", "DIFF_INSERT", "DIFF_EQUAL", "diff_main", "text1", "text2", "cursor_pos", "cleanup", "_fix_unicode", "editdiff", "find_cursor_edit_diff", "commonlength", "diff_commonPrefix", "commonprefix", "diff_commonSuffix", "commonsuffix", "diffs", "diff_compute_", "diff_cleanupMerge", "diff_cleanupSemantic", "longtext", "shorttext", "i", "hm", "diff_halfMatch_", "text1_a", "text1_b", "text2_a", "text2_b", "mid_common", "diffs_a", "diffs_b", "diff_bisect_", "text1_length", "text2_length", "max_d", "v_offset", "v_length", "v1", "v2", "x", "delta", "front", "k1start", "k1end", "k2start", "k2end", "d", "k1", "k1_offset", "x1", "y1", "k2_offset", "x2", "diff_bisectSplit_", "k2", "y2", "y", "text1a", "text2a", "text1b", "text2b", "diffsb", "pointermin", "pointermax", "pointermid", "pointerstart", "is_surrogate_pair_start", "diff_commonOverlap_", "text_length", "best", "length", "pattern", "found", "pointerend", "is_surrogate_pair_end", "diff_halfMatchI_", "seed", "j", "best_common", "best_longtext_a", "best_longtext_b", "best_shorttext_a", "best_shorttext_b", "prefixLength", "suffixLength", "hm1", "hm2", "changes", "equalities", "equalitiesLength", "lastequality", "pointer", "length_insertions1", "length_deletions1", "length_insertions2", "length_deletions2", "diff_cleanupSemanticLossless", "deletion", "insertion", "overlap_length1", "overlap_length2", "nonAlphaNumericRegex_", "whitespaceRegex_", "linebreakRegex_", "blanklineEndRegex_", "blanklineStartRegex_", "diff_cleanupSemanticScore_", "one", "two", "char1", "char2", "nonAlphaNumeric1", "nonAlphaNumeric2", "whitespace1", "whitespace2", "lineBreak1", "lineBreak2", "blankLine1", "blankLine2", "equality1", "edit", "equality2", "commonOffset", "commonString", "bestEquality1", "bestEdit", "bestEquality2", "bestScore", "score", "fix_unicode", "count_delete", "count_insert", "text_delete", "text_insert", "previous_equality", "ends_with_pair_start", "stray", "k", "starts_with_pair_end", "n", "charCode", "str", "remove_empty_tuples", "tuples", "ret", "make_edit_splice", "before", "oldMiddle", "newMiddle", "after", "oldText", "newText", "oldRange", "newRange", "oldLength", "newLength", "oldCursor", "oldBefore", "oldAfter", "maybeNewCursor", "editBefore", "newCursor", "newBefore", "newAfter", "oldPrefix", "newPrefix", "editAfter", "cursor", "oldSuffix", "newSuffix", "replaceRange", "diff", "vivliostyle_exports", "__export", "CoreViewer", "HOOKS", "Navigation", "PageProgression", "PageSide", "PageViewMode", "Profiler", "ReadyState", "UserAgentBaseCss", "UserAgentCounterStylesCss", "UserAgentPageCss", "UserAgentTocCss", "UserAgentXml", "ValidationTxt", "VivliostylePolyfillCss", "VivliostyleViewportCss", "VivliostyleViewportScreenCss", "ZoomType", "getHooksForName", "isDebug", "pageProgressionOf", "plugin", "printHTML", "profile", "profiler", "registerHook", "removeHook", "setDebug", "__toCommonJS", "value", "LogLevel", "Logger", "opt_console", "__publicField", "msg", "level", "args", "listener", "var_args", "argumentsToErrorInfo", "buildMessageAndStackTrace", "a", "e", "stack", "messages", "logger", "hooks", "name", "fn", "atFirst", "hooksForName", "index", "performanceInstance", "noop", "timestamp", "registerTiming", "timestamps", "st", "stamps", "l", "t", "registerStartTiming", "registerEndTiming", "startEnd", "fallbackPerformanceInstance", "browserType", "firstLetterPattern", "ELEMENT_OFFSET_ATTR", "emptyObj", "stringToJSON", "stripFragment", "url", "r", "stripFragmentAndQuery", "baseURL", "setBaseURL", "resourceBaseURL", "setResourceBaseURL", "resolveURL", "relURL", "urlOption", "convertSpecialURL", "asString", "v", "PriorityQueue", "item", "parentIndex", "parent", "result", "curr", "size", "childIndex", "knownPrefixes", "propNameMap", "checkIfPropertySupported", "prefix", "prop", "getPrefixedPropertyNames", "prefixed", "setCSSProperty", "elem", "elemStyle", "prefixedPropertyNames", "getCSSProperty", "opt_value", "propertyNames", "getLangAttribute", "element", "lang", "StringBuffer", "escapeChar", "escapeCSSIdent", "escapeCSSStr", "lightURLEncode", "isLetter", "ch", "escapeCharToHex", "escapeNameStrToHex", "s", "escapeRegExp", "unescapeCharFromHex", "unescapeStrFromHex", "unescapeChar", "regexp", "binarySearch", "high", "good", "h", "m", "numberCompare", "b", "indexArray", "arr", "key", "map", "arrayToSet", "set", "multiIndexArray", "mapObj", "obj", "res", "SimpleEventTarget", "evt", "list", "type", "capture", "mediaTags", "getId", "node", "idtxt", "escape", "unescape", "parseExtVal", "extstr", "p", "parseExt", "ext", "RefStep", "sb", "pos", "ChildStep", "id", "sideBias", "childElements", "childElementCount", "child", "next", "movedNode", "OffsetStep", "offset", "textBefore", "textAfter", "nodeType", "textLength", "Fragment", "_Fragment", "fragstr", "steps", "doc", "text", "defaultPreferences", "clonePreferences", "pref", "defaultPreferencesInstance", "Special", "letterbox", "viewW", "viewH", "objW", "objH", "scale", "cssString", "cssIdent", "makeQualifiedName", "objName", "memberName", "nextKeyIndex", "LexicalScope", "resolver", "Const", "builtIns", "Native", "qualifiedName", "val", "isAbsoluteLengthUnit", "unit", "isViewportRelativeLengthUnit", "isFontRelativeLengthUnit", "isRootFontRelativeLengthUnit", "defaultUnitSizes", "needUnitConversion", "Context", "rootScope", "viewportWidth", "viewportHeight", "fontSize", "scope", "isRoot", "vertical", "pvw", "pvh", "vw", "vh", "isVertical", "params", "noBuiltInEval", "body", "not", "enabled", "feature", "req", "actual", "isFunc", "Val", "buf", "priority", "context", "other", "dependencyCache", "cached", "Prefix", "Infix", "lhs", "rhs", "thisPriority", "Logical", "Comparison", "Additive", "Multiplicative", "Not", "NotMedia", "Negate", "And", "AndMedia", "Or", "Comma", "OrMedia", "Lt", "Le", "Gt", "Ge", "Eq", "Ne", "Add", "Subtract", "Multiply", "Divide", "Modulo", "Numeric", "num", "_a", "Named", "MediaName", "appendValArray", "expandValArray", "expanded", "Call", "_Call", "expandedParams", "Cond", "_Cond", "cond", "ifTrue", "ifFalse", "MediaTest", "_MediaTest", "SupportsTest", "Param", "and", "add", "sub", "mul", "div", "Visitor", "values", "empty", "slash", "ident", "numeric", "color", "urange", "func", "expr", "FilterVisitor", "SpaceList", "CommaList", "Func", "ref", "toString", "visitor", "_Empty", "Empty", "_Slash", "Slash", "Str", "nameTable", "Ident", "getName", "Num", "Int", "HexColor", "hex", "URL", "URange", "urangeText", "appendList", "separator", "_b", "Expr", "AnyToken", "toNumber", "convertNumericToPx", "hundredPercent", "fullWidth", "fullHeight", "numericZero", "fullURange", "processingOrder", "isDefaultingValue", "processingOrderFn", "name1", "name2", "n1", "n2", "isCustomPropName", "Rect", "Point", "Insets", "left", "top", "right", "bottom", "Segment", "low", "winding", "shapeId", "Band", "segmentCompare", "s1", "s2", "Shape", "_Shape", "points", "prev", "offsetX", "offsetY", "shapeForEllipse", "cx", "cy", "rx", "ry", "shapeForRect", "BandIntersection", "lowOrHigh", "intersectY", "addBandIntersections", "intersections", "w1", "w2", "mergeIntersections", "includeCount", "excludeCount", "shapeCount", "windings1", "windings2", "xranges", "inside", "intersectionCount", "intersection", "stillInside", "ceil", "floor", "rotatePoint", "point", "rotateBox", "box", "unrotateBox", "rotateShape", "shape", "shapesToBands", "include", "exclude", "granularity", "snapHeight", "segments", "segment", "segmentCount", "lowestIncludeIndex", "segmentIndex", "activeSegments", "y2min", "yn", "bandIntersections", "bi1", "bi2", "width", "rw", "normalize", "bands", "currBand", "prevBand", "findBand", "mid", "findUppermostFullyOpenRect", "rect", "topEdge", "band", "bottomEdge", "findBottommostFullyOpenRect", "positionFloat", "floatBox", "side", "floatWidth", "floatHeight", "floatBottom", "addFloatToBands", "floatBands", "lastY", "floatBand", "SetVisitor", "toSet", "err", "IntVisitor", "toInt", "def", "ShapeVisitor", "height", "numbers", "coord", "toShape", "CountersVisitor", "reset", "toCounters", "UrlTransformVisitor", "baseUrl", "transformer", "cloneCounterValues", "counters", "extractPseudoElementText", "pseudoElement", "clone", "pseudo", "pseudoElem", "TargetCounterReference", "targetId", "resolved", "CounterListener", "counterStore", "CounterResolver", "pageScope", "styler", "transformedId", "format", "getCounterNumber", "arrayFormat", "getCounterNumbers", "lookForElement", "targetCounters", "elements", "textMap", "countersOfName", "pageCounters", "pageCountersOfName", "elementCountersOfName", "beforeText", "contentText", "afterText", "match", "pageText", "retrievePosition", "namedRunningValues", "runningValues", "offsets", "currentPage", "pageStartOffset", "pageLastOffset", "firstOffset", "startOffset", "lastOffset", "firstExceptOffset", "offsetPrev", "offsetNext", "elementAtOffset", "elementAtPageStartOffset", "stringValue", "elementOffset", "CounterStore", "documentURLTransformer", "page", "counterName", "pageNumber", "cascadedPageStyle", "resetMap", "resetVal", "resetCounterName", "incrementMap", "increment", "incrementVal", "incrementCounterName", "counterValues", "unresolvedRefs", "resolvedRefs", "pushed", "spineIndex", "pageIndex", "ids", "currentPageCounters", "oldPageIndex", "prevPageCounters", "refs", "idRefs", "r1", "r2", "o", "document", "elemList", "clonedElem", "TARGET_COUNTER_ATTR", "TARGET_TEXT_ATTR", "foundPagesCounter", "foundPageCounter", "PAGES_COUNTER_ATTR", "PAGE_COUNTER_ATTR", "runningElem", "nodes", "counterExpr", "targetNodes", "TARGET_COUNTER_IN_RUNNING_ATTR", "targetTextNodes", "TARGET_TEXT_IN_RUNNING_ATTR", "viewport", "pages", "runningNodes", "counterValue", "runningTextNodes", "LayoutConstraint", "nodeContext", "viewNode", "escapeParseSingle", "code", "escapeParse", "Token", "makeActions", "spec", "actionsNormal", "actionsIdent", "actionsNumOrClass", "actionsMinus", "actionsIdentEsc", "actionsInt", "actionsNumber", "actionsCheckEq", "actionsColon", "actionsBar", "actionsAmp", "actionsSlash", "actionsComment", "actionsCommentStar", "actionsMinusMinus", "actionsLt", "actionsLtBang", "actionsLtBangMinus", "actionsIdentEscChr", "actionsStr1", "actionsStr2", "actionsStr1Esc", "actionsStr2Esc", "actionsURL", "actionsURLInside", "actionsURLInside1", "actionsURLInside2", "actionsURLTail", "INITIAL_INDEX_MASK", "Tokenizer", "input", "handler", "tail", "head", "indexMask", "actions", "position", "buffer", "tokenType", "tokenPosition", "tokenText", "tokenNum", "seenSpace", "token", "backslashPos", "privateCurrentTask", "primaryScheduler", "currentTask", "newFrame", "task", "frame", "Frame", "newScheduler", "opt_timer", "Scheduler", "TimerImpl", "newResult", "SyncResultImpl", "handle", "onErr", "start", "opt_name", "delay", "timer", "slice", "timeout", "newTime", "now", "continuation", "opt_delay", "c", "Task", "done", "callback", "savedTask", "Continuation", "otherComp", "scheduler", "opt_frame", "f", "out", "_SyncResultImpl", "ResultImpl", "res1", "res2", "step", "more", "LoopBodyFrame", "opt_waitTarget", "Fetcher", "fetch", "resource", "piggibacks", "waitForFetchers", "fetchers", "fetcher", "fetchFromURL", "opt_type", "opt_method", "requestInit", "response", "fetchedContent", "makeBlob", "parts", "readBlob", "blob", "fileReader", "createObjectURL", "ResourceStore", "parser", "opt_required", "opt_message", "isTocBox", "userAgentXmlUrl", "isUserAgentXml", "parseJSONResource", "store", "newJSONStore", "loadElement", "src", "alt", "timeoutId", "imgElem", "SPECIFICITY_USER_AGENT", "SPECIFICITY_USER", "SPECIFICITY_AUTHOR", "SPECIFICITY_STYLE", "SPECIFICITY_STYLE_IMPORTANT", "SPECIFICITY_AUTHOR_IMPORTANT", "SPECIFICITY_USER_IMPORTANT", "ParserHandler", "mnemonics", "flavor", "ns", "op", "pseudoelem", "flowName", "pseudoName", "classes", "important", "funcName", "selectorText", "DispatchParserHandler", "slave", "SkippingParserHandler", "owner", "topLevel", "SlaveParserHandler", "message", "actionsBase", "actionsStyleAttribute", "actionsSelector", "actionsSelectorInFunc", "actionsSelectorCont", "actionsSelectorStart", "actionsPropVal", "actionsExprVal", "actionsExprOp", "actionsError", "actionsErrorDecl", "actionsErrorSelector", "OP_MEDIA_AND", "OP_MEDIA_OR", "OP_MEDIA_NOT", "Parser", "tokenizer", "sep", "valStack", "parLevel", "count", "val2", "tok", "e1", "e2", "er", "startPosition", "token1", "token2", "tokenN", "commaCount", "endPosition", "hasLeadingPlus", "hasMinusSign", "hasSign", "condition", "classList", "className", "parsingValue", "parsingStyleAttr", "parsingMediaQuery", "parsingFunctionParam", "parsingRelationalSelector", "selectorStartPosition", "pseudoclassType", "len", "supportsTest", "ruleName", "rulePseudoName", "ErrorHandler", "parseStylesheet", "media", "parseMediaQuery", "resolvedURL", "innerFrame", "parseStylesheetFromURL", "parseStylesheetFromText", "parseValue", "parseStyleAttribute", "numProp", "takesOnlyNum", "propName", "evaluateExprToCSS", "createRegExpMap", "valueMaps", "toPhysical", "writingMode", "dest", "direction", "from", "to", "convert", "maps", "maps2", "replaced", "toPhysicalMaps", "toLogicalMaps", "toLogical", "lineRelativeValues", "toLineRelative", "getSize", "clientLayout", "sizes", "element1", "original", "getComputedValue", "inlineSizeName", "blockSizeName", "getSizeValue", "sizeName", "minMaxFitContent", "isCloneBoxDecorationBreak", "getBoxBreakFlags", "setBoxBreakFlags", "boxBreakFlags", "setBoxBreakFlag", "boxBreakFlag", "getMarginDiscardFlags", "setMarginDiscardFlags", "marginDiscardFlags", "setMarginDiscardFlag", "marginDiscardFlag", "MarginDiscardFlags", "convertPageBreakAliases", "forcedBreakValues", "isForcedBreakValue", "spreadBreakValues", "isSpreadBreakValue", "avoidBreakValues", "isAvoidBreakValue", "resolveEffectiveBreakValue", "first", "second", "firstIsForcedBreakValue", "secondIsForcedBreakValue", "breakValueToStartBreakType", "breakValue", "import_fast_diff", "SC", "ng", "diffChars", "originalText", "Vi", "fastdiff", "restoreNewText", "resolveNewIndex", "oldIndex", "resolveIndex", "resolveOriginalIndex", "newIndex", "coef", "current", "change", "LayoutProcessor", "isInstanceOfBlockFormattingContext", "object", "PageFloats", "FloatReference", "Selectors", "isInstanceOfAfterIfContinuesLayoutConstraint", "RepetitiveElement", "isInstanceOfRepetitiveElementsOwnerFormattingContext", "Table", "isInstanceOfRepetitiveElementsOwnerLayoutConstraint", "isInstanceOfTableFormattingContext", "isInstanceOfTableRowLayoutConstraint", "Vtree", "Whitespace", "ShadowType", "delayedProps", "delayedPropsIfRelativePositioned", "DelayedItem", "target", "makeListener", "action", "actionFn", "_Page", "container", "bleedBox", "anchorElement", "href", "isAuto", "triggers", "elems", "trigger", "observers", "Page", "whitespaceFromPropertyValue", "whitespace", "canIgnore", "Flow", "parentFlowName", "FlowChunk", "linger", "exclusive", "repeated", "last", "breakBefore", "clientrectIncreasingTop", "clientrectDecreasingRight", "isSameNodePositionStep", "nps1", "nps2", "isSameShadowContext", "isSameNodePosition", "np1", "np2", "newNodePositionFromNode", "newNodePositionFromNodeContext", "initialFragmentIndex", "makeNodeContextFromNodePositionStep", "NodeContext", "ShadowContext", "root", "xmldoc", "parentShadow", "superShadow", "sc1", "sc2", "FirstPseudo", "outer", "_NodeContext", "sourceNode", "boxOffset", "np", "npc", "npp", "_c", "nc", "actualOffsetInNode", "formattingContext", "ChunkPosition", "_ChunkPosition", "primary", "FlowChunkPosition", "_FlowChunkPosition", "chunkPosition", "flowChunk", "FlowPosition", "_FlowPosition", "newfp", "newarr", "LayoutPosition", "_LayoutPosition", "newcp", "thisFlowNames", "otherFlowNames", "flowPos", "startBreakType", "flowChunkPosition", "Container", "extent", "outerExtent", "paddingX", "paddingY", "paddingWidth", "paddingHeight", "outerShapeProp", "outerX", "outerY", "outerWidth", "outerHeight", "ContentPropertyHandler", "rootContentValue", "exprContentListener", "img", "ex", "nonTrivialContent", "floatReferenceOf", "isPageFloat", "floatReference", "resolveInlineFloatDirection", "floatSide", "pageSide", "physicalValue", "lineRelativeValue", "PageFloat", "nodePosition", "clearSide", "floatMinWrapBlock", "pageFloatLayoutContext", "PageFloatStore", "order", "float", "PageFloatFragment", "continuations", "area", "continues", "floats", "PageFloatContinuation", "PageFloatLayoutContext", "generatingNodePosition", "previousSibling", "PageFloatLayoutStrategyResolver", "floatFragment", "dontInvalidate", "fr1", "fr2", "fragment", "anchorViewNode", "anchors", "floatId", "cont", "ignoreReference", "lastFollowing", "lastFollowingOfParent", "c1", "c2", "notAllowedFloat", "deferredFloats", "floatsInFragments", "fr", "f1", "f2", "children", "isLeftPage", "sides", "logicalSides", "logicalSide", "logicalFloatSides", "foundSnapBlock", "foundSnapInline", "logicalFloatSide", "fragmentFloatSide", "stashed", "side2", "layoutContext", "physicalSide", "logicalSide2", "physicalSide2", "limit", "parentLimit", "limits", "paddingRect", "resolveLengthPercentage", "containerLength", "fragments", "logicalFloatSide2", "floatMinWrapBlockStart", "floatMinWrapBlockEnd", "anchorEdge", "init", "force", "inlineSideForBlockLimit", "blockSideForInlineLimit", "blockStart", "blockEnd", "inlineStart", "inlineEnd", "blockOffset", "inlineOffset", "limitBlockStartEndValueWithOpenRect", "getRect", "openRect", "blockSize", "inlineSize", "outerBlockSize", "outerInlineSize", "availableBlockSize", "containerRect", "fromStart", "fromEnd", "availableInlineSize", "edge", "clear", "column", "isContinuationOfAlreadyAppearedFloat", "isFragmentWithAlreadyAppearedFloat", "columnRect", "columnBlockEnd", "hasFragmentWithAlreadyAppearedFloat", "blockStartLimit", "logicalClearSide", "floatOrder", "isPrecedingFragment", "hasPrecedingFragmentInChildren", "hasPrecedingFragmentInParents", "layoutConstraint", "pageFloatLayoutStrategies", "strategy", "NormalPageFloatLayoutStrategy", "floatArea", "floatContainer", "Footnote", "_Footnote", "footnotePolicy", "FootnoteFragment", "LineFootnotePolicyLayoutConstraint", "footnote", "FootnoteLayoutStrategy", "regionContext", "constraint", "FLOW_ROOT_ATTR", "isFlowRoot", "blockify", "display", "displayStr", "blockifiedStr", "isAbsolutelyPositioned", "isRunning", "getComputedDisplayValue", "isBlock", "isDisplayType", "isInlineLevel", "isListItem", "isBlockLevel", "isRubyInternalDisplay", "establishesBFC", "overflow", "parentWritingMode", "establishesCBForAbsolute", "BIG_GAP", "setBrowserColumnBreaking", "style", "unsetBrowserColumnBreaking", "isUsingBrowserColumnBreaking", "setAsRootColumn", "isRootColumn", "checkIfBeyondColumnBreaks", "distance", "adjustRectForColumnBreaking", "columnOverEnd", "distanceStart", "columnOverStart", "shiftStart", "shiftEnd", "adjustRectsForColumnBreaking", "rects", "getElementClientRectAdjusted", "columnOver", "columnElem", "columnStyle", "blockSizeP", "columnHeight", "columnHeight2", "columnOver2", "paddingBlockEnd", "borderBlockEndWidth", "rect2", "clearForcedColumnBreaks", "prevNode", "currNode", "findAncestorNonRootMultiColumn", "fixOverflowAtForcedColumnBreak", "elementStyle", "breakBeforeColumn", "prevElem", "breakAfterColumn", "nonRootMultiColumn", "multiColumnStyle", "columnGap", "isRtl", "halfGap", "multiColumnRect", "elementRect", "calculateEdge", "extraOffset", "parentNode", "nextSibling", "cbox", "range", "boxes", "getElementHeight", "usingBrowserColumnBreaking", "margin", "isOrphan", "removeFollowingSiblings", "lastChild", "prevSibling", "SPECIAL_ATTR", "isSpecial", "isOutOfFlow", "isSpecialNodeContext", "isSpecialInlineDisplay", "findAncestorSpecialInlineNodeContext", "AbstractBreakPosition", "calculateOffset", "elementsOffsets", "repetitiveElement", "EdgeBreakPosition", "breakOnEdge", "overflows", "computedBlockSize", "penalty", "preferDropping", "clonedPaddingBorder", "marginBlockStart", "cell", "table", "collapse", "padding", "border", "repetitiveElements", "LayoutProcessorResolver", "processor", "BlockLayoutProcessor", "leadingEdge", "columnBlockSize", "stopAtOverflow", "parentNodeContext", "removeSelf", "forceRemoveSelf", "endOfColumn", "BlockFormattingContext", "firstTime", "state", "blockLayoutProcessor", "AbstractLayoutRetryer", "mode", "positionAfter", "accepted", "initialPosition", "sibling", "LayoutIteratorStrategy", "initialNodeContext", "LayoutIterator", "loopFrame", "nextResult", "nextNodeContext", "EdgeSkipper", "needForcedBreak", "violateConstraint", "repetitiveElementsCache", "clearRepetitiveElementsCache", "matchANPlusB", "AnyMatcher", "matchers", "matcher", "AllMatcher", "_NthFragmentMatcher", "fragmentIndex", "indices", "entry", "NthFragmentMatcher", "MatcherBuilder", "viewCondition", "strs", "inheritedProps", "polyfilledInheritedProps", "getPolyfilledInheritedProps", "props", "supportedNamespaces", "coupledPatterns", "coupledExtentPatterns", "geomNames", "names", "buildCouplingMap", "sideMap", "extentMap", "extentPattern", "couplingMapVert", "couplingMapHor", "couplingMapVertRtl", "couplingMapHorRtl", "couplingMapLeftPage", "couplingMapRightPage", "CascadeValue", "_CascadeValue", "specificity", "percentRef", "evaluateCSSToCSS", "ConditionalCascadeValue", "_ConditionalCascadeValue", "cascadeValues", "tv", "av", "setPropCascadeValue", "SPECIALS", "isSpecialName", "isMapName", "isPropName", "isInherited", "getProp", "setProp", "getStyleMap", "getMutableStyleMap", "getViewConditionalStyleMap", "getSpecial", "getMutableSpecial", "mergeIn", "pseudoelement", "regionId", "viewConditionMatcher", "styleMap", "as", "ts", "cascval", "propListLH", "propLH", "avLH", "mergeAll", "styles", "chainActions", "chain", "chained", "InheritanceVisitor", "convertFontSizeToPx", "convertFontRelativeLengthToPx", "baseFontSize", "parentFontSize", "CascadeAction", "cascadeInstance", "CompoundAction", "ConditionItemAction", "conditionItem", "_CompoundAction", "ApplyRuleAction", "viewConditionId", "ChainedAction", "cascade", "CheckClassAction", "CheckIdAction", "CheckLocalNameAction", "localName", "CheckNSTagAction", "nsTag", "CheckTargetEpubTypeAction", "epubTypePatt", "targetLocalName", "epubType", "CheckNamespaceAction", "checkAttribute", "pred", "qname", "CheckAttributePresentAction", "CheckAttributeEqAction", "CheckNamespaceSupportedAction", "CheckAttributeRegExpAction", "CheckLangAction", "langRegExp", "IsFirstAction", "IsRootAction", "IsNthAction", "IsNthSiblingAction", "IsNthSiblingOfTypeAction", "IsNthLastSiblingAction", "IsNthLastSiblingOfTypeAction", "counts", "nsCounts", "IsEmptyAction", "IsEnabledAction", "IsDisabledAction", "IsCheckedAction", "CheckConditionAction", "CheckAppliedAction", "_CheckAppliedAction", "cloned", "MatchesAction", "chains", "firstAction", "MatchesNoneAction", "MatchesRelationalAction", "selectorTexts", "selectorWithScope", "scopingRoot", "AbstractConditionItem", "DescendantConditionItem", "_DescendantConditionItem", "depth", "ChildConditionItem", "_ChildConditionItem", "AdjacentSiblingConditionItem", "_AdjacentSiblingConditionItem", "FollowingSiblingConditionItem", "_FollowingSiblingConditionItem", "AfterPseudoelementItem", "afterprop", "RestoreLangItem", "QuotesScopeItem", "oldQuotes", "AttrValueFilterVisitor", "attributeName", "defaultValue", "getStringValueFromCssContentVal", "ContentPropVisitor", "counterResolver", "quotes", "maxDepth", "numval", "numvals", "elementCounters", "targetUrl", "targetUrlStr", "_d", "_e", "_f", "pseudos", "leader", "getContentWidth", "acc", "postLayoutBlockLeader", "checkPoints", "leaders", "setLeaderTextContent", "leaderStr", "leaderElem", "overrun", "inner", "followingInlineSiblingsWidth", "setLeader", "lower", "upper", "templeader", "getInset", "inset", "marginInlineEnd", "columnContainer", "originalColumnFill", "innerInit", "innerMarginInlineEnd", "inlineNodes", "topmostInlineAncestor", "parentWidth", "pseudoWidth", "innerInline", "innerAligned", "ORDER_INCREMENT", "copyTable", "dst", "Cascade", "_Cascade", "counterListener", "counterStyleStore", "CascadeInstance", "dependentConditionMatchers", "conditionId", "conditions", "pageType", "baseStyle", "EMPTY", "scoping", "_g", "displayVal", "floatVal", "setMap", "setVal", "incrPropValue", "setCounterName", "listItemCounts", "listItemCount", "stringSet", "sets", "pseudoprops", "content", "types", "siblingOrderStack", "siblingTypeCountsStack", "currentSiblingTypeCounts", "currentNamespaceTypeCounts", "followingSiblingOrderStack", "followingSiblingTypeCountsStack", "currentFollowingSiblingTypeCounts", "quotesCasc", "itemToPushLast", "quotesVal", "pseudoNames", "pseudoProps", "listStyleType", "listStyleImage", "listStylePosition", "validatorSet", "currentStyle", "pseudoMap", "elementStyles", "VarFilterVisitor", "LIMIT_LOOP", "propsLH", "cascVal", "shorthand", "nameLH", "tvLH", "valueSH", "CalcFilterVisitor", "uaBaseCascade", "setUABaseCascade", "CascadeParserHandler", "MatchesParameterParserHandler", "patt", "langValue", "ActionClass", "nthSelectorActionClasses", "conditionCount", "hook", "converted", "parameterParserHandler", "NotParameterParserHandler", "WhereParameterParserHandler", "HasParameterParserHandler", "_MatchesParameterParserHandler", "forgiving", "DefineParserHandler", "dim", "PropSetParserHandler", "ruleType", "PropertyParserHandler", "forEachViewConditionalStyles", "viewConditionalStyles", "mergeViewConditionalStyles", "cascMap", "mergeStyle", "styleAttrValue", "cascaded", "writingModeCasc", "rtl", "directionCasc", "flattenCascadedStyle", "regionIds", "isFootnote", "forEachStylesInRegion", "regionStyle", "regions", "footnoteRegion", "property", "newVal", "oldVal", "convertToPhysical", "leftPageSide", "transform", "couplingMap1", "couplingMap2", "coupledName1", "coupledName2", "coupledName", "targetName", "coupledCascVal", "resolveViewportUnit", "exprText", "exprVal", "exprResult", "HANGING_PUNCTUATION_NONE", "hangingPunctuationFromPropertyValue", "cssval", "hangingPunctuation", "isHangingPunctuationNone", "SPACING_TRIM_NONE", "SPACING_TRIM_NORMAL", "SPACING_TRIM_BOTH", "spacingTrimFromPropertyValue", "textSpacing", "AUTOSPACE_NONE", "AUTOSPACE_NORMAL", "autospaceFromPropertyValue", "autospace", "isTextSpacingNone", "spacingTrim", "normalizeLang", "TextSpacingPolyfill", "nodeIter", "textArr", "lastIndex", "autospaceVal", "spacingTrimVal", "hangingPunctuationVal", "whiteSpaceSave", "nextNode", "isFirstInBlock", "isFirstAfterForcedLineBreak", "isLastBeforeForcedLineBreak", "isLastInBlock", "isFirstFragment", "checkIfFirstInBlock", "isAfterForcedLineBreak", "checkIfAfterForcedLineBreak", "isOutOfLine", "pp", "iFirst", "checkIfFirstAfterForcedLineBreak", "prevP", "checkIfLastBeforeForcedLineBreak", "nextP", "isFirstAfterBreak", "nextNext", "firstInInlineBlock", "lastInInlineBlock", "textNode", "currRange", "prevRange", "nextRange", "isAtStartOfLine", "prevRects", "prevRect", "isAtEndOfLine", "nextRect", "punctProcessing", "hangingFirst", "hangingLast", "hangingEnd", "tagName", "checkFullWidth", "fullWidthThreshold", "linePosition", "outerElem", "innerElem", "isFullWidth", "linePos", "atEnd", "atEndNoHang", "spaceIdeoAlnumProcessing", "checkUpright", "checkNonZeroMarginBorderPadding", "node1", "node2", "parent1", "parent2", "textPolyfill", "preprocessForTextSpacing", "processGeneratedContent", "textAutospace", "textSpacingTrim", "PSEUDO_ATTR", "getPseudoName", "setPseudoName", "PseudoelementStyler", "deep", "nest", "contentVal", "lowerName", "span", "registerFragmentIndex", "clearFragmentIndices", "AfterIfContinues", "viewRoot", "pseudoColumn", "PseudoColumn", "initialPageBreakType", "shadowContext", "AfterIfContinuesLayoutConstraint", "_AfterIfContinuesLayoutConstraint", "afterIfContinues", "pseudoElementHeight", "overflownNodeContext", "allowed", "AfterIfContinuesElementsOffset", "processAfterIfContinuesOfNodeContext", "calculatePseudoElementHeight", "processAfterIfContinues", "processAfterIfContinuesOfAncestors", "AllLayoutConstraint", "constraints", "BoxBreakPosition", "Column", "_Column", "pageFloatExclusions", "stepIndex", "prevContext", "firstLetterLength", "firstLetterText", "bodyFrame", "position1Param", "position1", "positionParam", "atUnforcedBreak", "foundNonZeroWidthBand", "lastBand", "insets", "nodeContextIn", "nodeContextAfter", "floatBBox", "probe", "parentBox", "floatBoxMeasure", "floatHorBox", "dir", "boxExtent", "containingBlockForAbsolute", "floatBoxEdge", "floatBoxTop", "floatLayoutContext", "containingBlockRect", "fitWithinContainer", "floatAreaElement", "parentPageFloatLayoutContext", "parentContainer", "PageFloatArea", "allowFragmented", "pageFloatFragment", "firstFloat", "failed", "floatChunkPosition", "newPosition", "newFragment", "cancelLayout", "success", "excluded", "stashedFloatFragments", "newFloatAreas", "newFragments", "stashedFragment", "anchor", "columnSpan", "columnContext", "resNodeContext", "lastCheckPoints", "totalLineCount", "firstPseudo", "linePositions", "lineBreak", "resNodeContextParam", "trailingEdgeContexts", "maxPos", "minNeg", "checkPointIndex", "overflown", "lineCont", "isUpdateMaxReachedAfterEdge", "effectiveLinePosition", "lowCP", "low1", "highCP", "high1", "mid1", "edgePosition", "TextNodeBreaker", "end", "wentUp", "lastGood", "haveStart", "endNotReached", "seekRange", "boxList", "positions", "lineBefore", "lineAfter", "lineEnd", "lineLength", "overlap", "boxSize", "paddingBorders", "bp", "block", "widows", "orphans", "repetitiveElementsOffset", "firstOverflowing", "lineIndex", "forceCutBeforeOverflowing", "lastNode", "blockEdge", "blockParent", "cp", "nextPenalty", "minPenalty", "initialComputedBlockSize", "flowPosition", "marginEdge", "footnoteEdge", "saveEvenOverflown", "breakAtTheEdge", "spacer", "spacerBox", "clearLR", "clearLogical", "clearEdge", "tolerance", "afterEdge", "wAdj", "hAdj", "forcedBreakValue", "fc", "lastAfterNodeContext", "leadingEdgeContexts", "onStartEdges", "atLeadingEdgeIgnoringOutOfFlow", "processForcedBreak", "layoutProcessor", "viewElement", "viewTag", "nodeContextParam", "resultNodeContext", "columnBBox", "breakAtEdge", "copy", "breakAfter", "nextInTreeListener", "retryer", "ColumnLayoutRetryer", "sortedFragmentLayoutConstraints", "pending", "chunkPositions", "blockStartEdgeOfBlockEndFloats", "parentClonedPaddingBorder", "allowBreakAtStartPosition", "startNodeContext", "checkpointIndex", "viewIndex", "zwj", "resolveHyphenateCharacter", "ch0", "ch1", "DefaultLayoutMode", "refWidth", "refHeight", "convertPercentageToPx", "refValue", "valueString", "percentageValue", "rootViewNode", "RepetitiveElementsOwnerFormattingContext", "rootSourceNode", "RepetitiveElements", "ownerSourceNode", "rootNodeContext", "firstChild", "cache", "calculator", "cacheEntry", "includeChildren", "parentsOfNode", "currentParent", "LayoutEntireBlock", "LayoutFragmentedBlock", "LayoutEntireOwnerBlock", "LayoutFragmentedOwnerBlock", "RepetitiveElementsOwnerLayoutConstraint", "_RepetitiveElementsOwnerLayoutConstraint", "getRepetitiveElementsOwnerFormattingContext", "appendHeader", "appendFooter", "RepetitiveElementsOwnerLayoutRetryer", "EntireBlockLayoutStrategy", "RepetitiveElementsOwnerLayoutProcessor", "appendHeaderToAncestors", "getRepetitiveElementsOwnerFormattingContextOrNull", "eachAncestorNodeContext", "repetitiveLayoutProcessor", "TableRow", "rowIndex", "TableCell", "columnIndex", "slot", "TableSlot", "TableCellFragment", "pseudoColumnContainer", "cellNodeContext", "verticalAlign", "alignContent", "TableCaptionView", "BetweenTableRowBreakPosition", "breakNodeContext", "cellFragments", "cf", "cellFragment", "InsideTableRowBreakPosition", "beforeNodeContext", "acceptableCellBreakPositions", "allCellsBreakable", "row", "breakPositions", "foundBoxBreakInRowSpanningCell", "penalty1", "TableFormattingContext", "tableSourceNode", "rowSlots", "rowUpper", "startColIndex", "uniqueCells", "sum", "tableCell", "col", "loop", "collected", "elementsInColumn", "ElementsOffsetOfTableCell", "repeatitiveElementsInColumns", "maxOffset", "getTableFormattingContext", "isTableRowGrouping", "isTableRoot", "isValidParentOfTableRow", "skipNestedTable", "parentDisplay", "isNestedInlineTable", "EntireTableLayoutStrategy", "captionView", "computedStyle", "_TableLayoutStrategy", "colWidths", "startChunkPosition", "colSpan", "cellViewNode", "slotIndex", "cellBreakPosition", "cellBreakPositions", "rowSpanningCellBreakPositions", "rowCount", "currentRow", "spanningCellRowIndex", "occupiedSlotIndices", "rowCellBreakPositions", "rowNodeContext", "cont1", "addDummyCellUntil", "upperColumnIndex", "dummy", "cellNodePosition", "breakChunkPosition", "tdNodeStep", "afterNodeContext", "startNodePosition", "TableLayoutStrategy", "tableLayoutOptionCache", "getTableLayoutOption", "tableRootSourceNode", "pair", "clearTableLayoutOptionCache", "TableLayoutProcessor", "lastRow", "columnCount", "dummyRow", "dummyCells", "tableElement", "colGroups", "cols", "colGroup", "tableLayoutOption", "tableBBox", "EntireTableBreakPosition", "captions", "caption", "iterator", "LayoutRetryer", "adjustRowHeight", "cells", "adjustCellHeight", "cellContentElement", "cellElement", "cellElementRect", "tbodyElement", "spanStartRows", "spanStartRowHeight", "totalHeight", "rowElement", "spanStartLastRow", "spanStartLastRowIndex", "rowSpan", "rowToBeAdjusted", "rowRect", "rowHeight", "newRowHeight", "tableFormattingContext", "LayoutEntireTable", "LayoutFragmentedTable", "tableNodeContext", "EntireTableLayoutConstraint", "_EntireTableLayoutConstraint", "tableRootNode", "TableRowLayoutConstraint", "_TableRowLayoutConstraint", "array", "dummyNode", "tableLayoutProcessor", "resolveFormattingContextHook", "resolveLayoutProcessor", "mean", "variance", "meanValue", "ColumnBalancingTrialResult", "layoutResult", "getBlockSize", "setBlockSize", "ColumnBalancer", "layoutContainer", "columnGenerator", "regionPageFloatLayoutContext", "candidates", "newLayoutResult", "COLUMN_LENGTH_STEP", "canReduceContainerSize", "lastCandidate", "secondLastCandidate", "columns", "maxColumnBlockSize", "maxPageFloatBlockSize", "reduceContainerSize", "newEdge", "BalanceLastColumnBalancer", "totalBlockSize", "isLastColumnLongerThanAnyOtherColumn", "lastColumnBlockSize", "otherColumns", "errorMargin", "BalanceNonLastColumnBalancer", "computedBlockSizes", "createColumnBalancer", "columnFill", "noMoreContent", "lastColumn", "isLastColumnForceBroken", "nonOverridableNameList", "nonOverridableNames", "validateNameForDefinition", "systemsDefinedBySingleIdentList", "systemsDefinedBySingleIdent", "systemsDefinedBySpaceListList", "systemsDefinedBySpaceList", "notCaseInsensitiveMatchForNoneBrand", "validateCounterStyleName", "extractCounterStyleName", "validateSystem", "isCyclicDescriptors", "descriptors", "system", "getDescriptorValue", "isFixedDescriptors", "extractFixedFirstSymbolValue", "isAlphabeticDescriptors", "isNumericDescriptors", "isAdditiveDescriptors", "isExtendsDescriptors", "extractExtendsBaseName", "validateSymbol", "extractSymbol", "symbol", "validateNegative", "extractNegative", "negative", "validateRangeBound", "extractRangeBound", "bound", "isLower", "upperAtOrAboveLowerBrand", "validateRangeTuple", "extractRangeTuple", "tuple", "validateRange", "extractRange", "nonNegativeBrand", "validateNonNegativeIntAndSymbolSet", "extractNonNegativeIntAndSymbolSet", "validatePad", "extractPad", "pad", "minLength", "validateSymbols", "extractSymbols", "symbols", "strictlyDescendingWeightOrderBrand", "validateAdditiveSymbols", "prevWeight", "weight", "extractAdditiveSymbols", "additiveSymbols", "speakAsIdentList", "speakAsIdents", "validateSpeakAs", "validateDescriptorValue", "cascadeValue", "isInRange", "getDecimal", "decimal", "CounterStyle", "_negative", "_prefix", "_suffix", "_range", "_pad", "_fallbackName", "_symbols", "_additiveSymbols", "_DECIMAL_DESCRIPTORS", "_DISC_DESCRIPTORS", "_SQUARE_DESCRIPTORS", "_CIRCLE_DESCRIPTORS", "_DISCLOSURE_OPEN_DESCRIPTORS", "_DISCLOSURE_CLOSED_DESCRIPTORS", "_NONE_DESCRIPTORS", "_CounterStyle_instances", "getNegative_fn", "getPrefix_fn", "getSuffix_fn", "getRange_fn", "getPad_fn", "getFallback_fn", "applyPadding_fn", "format_fn", "_CounterStyle", "__privateAdd", "__privateSet", "suffix", "fallbackName", "Cyclic", "Fixed", "Alphabetic", "Extends", "Symbolic", "__privateGet", "ChineseLonghand", "EthiopicNumeric", "__privateMethod", "initialRep", "usesNegative", "padSymbol", "negPrefix", "negSuffix", "negativeLength", "padLength", "visited", "fallback", "absValue", "padded", "_", "idx", "_firstSymbolValue", "chosen", "zeroTuple", "remaining", "reps", "_baseName", "_Extends_instances", "resolveBaseStyle_fn", "_Extends", "baseName", "targetStyle", "chineseLonghandNameList", "_SIMP_CHINESE_INFORMAL", "_SIMP_CHINESE_FORMAL", "_TRAD_CHINESE_INFORMAL", "_TRAD_CHINESE_FORMAL", "_SETTINGS", "_chars", "_ChineseLonghand", "chars", "digits", "temp", "removeTensDigit", "lastWasZero", "digit", "isLastDigit", "_DESCRIPTORS", "_TENS", "_UNITS", "_HUNDRED", "_TEN_THOUSAND", "_EthiopicNumeric", "groups", "numGroups", "groupValue", "isOddIndex", "isMostSignificant", "tens", "units", "_store", "CounterStyleStore", "counterStyle", "SlipRange", "endStuckFixed", "endFixed", "endSlipped", "SlipMap", "fixed", "slipped", "Box", "_Box", "atBlockStart", "atFlowStart", "isParentBoxDisplayed", "beforeBox", "beforeContent", "afterBox", "afterContent", "cv", "BoxStack", "lastBox", "newFlowChunk", "isAtFlowStart", "whitespaceValue", "atStart", "Styler", "primaryFlows", "rootOffset", "srcStyle", "pname", "isBody", "backgroundColor", "backgroundImage", "columnProps", "isRelativeFontSize", "px", "unitSize", "rootFontSize", "lineHeight", "rootStyle", "flowNameStr", "nodeOffset", "flowListener", "optionsCV", "options", "lingerCV", "priorityCV", "flow", "forcedBreakOffsets", "previousValue", "lookup", "targetSlippedOffset", "slippedOffset", "afterPseudoBreakBefore", "blockStartOffset", "pageCV", "beforePseudoBreakAfter", "Node", "validator", "Connection", "where", "ValidatingGroup", "_ValidatingGroup", "nodeIndex", "group", "clonedNode", "connection", "groupConnection", "clause", "ALWAYS_FAIL", "failure", "arrs", "PrimitiveValidator", "how", "connectionIndex", "successTerminal", "failTerminal", "ALLOW_EMPTY", "ALLOW_STR", "ALLOW_IDENT", "ALLOW_POS_NUMERIC", "ALLOW_POS_NUM", "ALLOW_POS_INT", "ALLOW_COLOR", "ALLOW_URL", "ALLOW_NEGATIVE", "ALLOW_ZERO", "ALLOW_ZERO_PERCENT", "ALLOW_SLASH", "ALLOW_URANGE", "ALLOW_IMAGE", "PropertyValidator", "rval", "_PrimitiveValidator", "idents", "NO_IDENTS", "ListValidator", "startIndex", "alternativeStack", "alternatives", "inval", "outval", "SpaceListValidator", "CommaListValidator", "hasCommaListValidator", "FuncValidator", "ShorthandSyntaxNode", "shorthandValidator", "ShorthandSyntaxProperty", "rvals", "ShorthandSyntaxPropertyN", "ShorthandSyntaxCompound", "index0", "ShorthandValidator", "syntax", "propList", "receiver", "SimpleShorthandValidator", "InsetsShorthandValidator", "InsetsSlashShorthandValidator", "slashIndex", "index1", "vals", "CommaShorthandValidator", "FontShorthandValidator", "fontVariant", "fontStretch", "validators", "fontFamily", "familyList", "family", "TextSpacingShorthandValidator", "propsExcludedFromAll", "AllShorthandValidator", "shorthandValidators", "ValidatorSet", "subgroup", "min", "max", "stdfont", "section", "rulePrefixes", "expectval", "reduce", "setop", "currop", "builtIn", "open", "insetShorthand", "compound", "containsVar", "origName", "rvalue", "baseValidatorSet", "VarCheckVisitor", "varCheckVisitor", "bogusFontData", "getFontTraitNames", "properties", "makeFontTraitKey", "prepareProperties", "Face", "fontBytes", "blobURL", "DocumentFaces", "deobfuscator", "srcFace", "viewFace", "srcFamily", "viewFamilyFromSrc", "viewFamilyFromView", "newValues", "rf", "Mapper", "opt_familyPrefix", "documentFaces", "viewFamily", "viewFontFace", "srcFamilySrc", "viewFaceParam", "srcFaces", "fonts", "unloadedCount", "fontFace", "keyCount", "PageBox", "parentInstance", "param", "specified", "destSpecified", "RootPageBox", "PageMasterScope", "pageMaster", "self", "boxInstance", "PageMaster", "_PageMaster", "PageMasterInstance", "PartitionGroup", "_PartitionGroup", "PartitionGroupInstance", "Partition", "_Partition", "PartitionInstance", "toExprIdent", "toExprAuto", "toExprNormal", "toExprZero", "toExprZeroAuto", "toExprZeroBorder", "styleVal", "toExprBool", "PageBoxInstance", "pageBox", "altName", "columnWidth", "minPageWidth", "minPageHeight", "marginLeft", "borderLeftWidth", "paddingLeft", "maxWidth", "paddingRight", "borderRightWidth", "marginRight", "leftBP", "rightBP", "extra", "remains", "snapWidthVal", "snapWidth", "parentHeight", "marginTop", "borderTopWidth", "paddingTop", "maxHeight", "paddingBottom", "borderBottomWidth", "marginBottom", "topBP", "bottomBP", "snapHeightVal", "StyleInstance", "PageRuleMasterInstance", "docFaces", "delayedItems", "xpos", "ypos", "passPreProperties", "passContentProperties", "hasWidth", "hasHeight", "passSingleUriContentProperties", "readHeight", "readWidth", "bbox", "ruleWidth", "ruleStyle", "ruleColor", "containerSize", "rule", "passPostProperties", "delayedProperties", "docElementStyle", "userAgentPageMasterPseudo", "childInstance", "RootPageBoxInstance", "listVal", "conflicting", "term", "required", "hasContent", "pmEnabledVal", "pmEnabled", "PageRuleMaster", "PageBoxParserHandler", "PartitionParserHandler", "PartitionGroupParserHandler", "_PartitionGroupParserHandler", "partition", "partitionGroup", "PageMasterParserHandler", "resolvePageProgression", "pageSizes", "defaultPrinterMarkLineWidth", "defaultPrinterMarkOffset", "defaultPrinterMarkLineLength", "defaultBleedOffset", "resolvePageSizeAndBleed", "pageSizeAndBleed", "val1", "marksCV", "bleedCV", "marks", "bleed", "hasCrop", "cropOffsetCV", "cropOffset", "evaluatePageSizeAndBleed", "evaluated", "bleedOffset", "createPrinterMarkSvg", "mark", "createPrinterMarkElement", "lineWidth", "lineColor", "elementType", "line", "CornerMarkPosition", "createCornerMark", "cropMarkLineLength", "bleedMarkLineLength", "maxLineLength", "svgWidth", "points1", "points2", "line1", "line2", "CrossMarkPosition", "createCrossMark", "longLineLength", "horizontalLine", "verticalLine", "circle", "opposite", "addPrinterMarks", "evaluatedPageSizeAndBleed", "crop", "cross", "printerMarkOffset", "lineColorCV", "propertiesAppliedToPartition", "pageMarginBoxes", "pageMarginBoxNames", "pageRuleMasterPseudoName", "marginBoxesKey", "pageSize", "PageRulePartition", "marginBoxesMap", "PageMarginBoxPartition", "PageAreaPartition", "PageRulePartitionInstance", "PageAreaPartitionInstance", "marginBoxName", "ownStyle", "ownVal", "PageMarginBoxPartitionInstance", "pageRuleMaster", "marginBoxContainers", "horizontalDimensions", "verticalDimensions", "isHorizontal", "dimensions", "START", "CENTER", "END", "containers", "boxInstances", "boxParams", "boxInfo", "boxParam", "SingleBoxMarginBoxSizingParam", "evaluatedDim", "needRecalculate", "maxOuterSizes", "maxSize", "evaluatedMaxSize", "FixedSizeMarginBoxSizingParam", "minOuterSizes", "minSize", "evaluatedMinSize", "endEdge", "startEndSum", "outerSize", "availableSize", "startBoxParam", "centerBoxParam", "endBoxParam", "startEndBoxParam", "MultipleBoxesMarginBoxSizingParam", "centerSizes", "centerSize", "startEndAutoSize", "startEndSizes", "xOuterMaxContentSize", "yOuterMaxContentSize", "maxContentSizeSum", "xOuterMinContentSize", "yOuterMinContentSize", "minContentSizeSum", "pageRulePartition", "startSide", "endSide", "extentName", "pageExtent", "marginStart", "marginEnd", "paddingStart", "paddingEnd", "borderStartWidth", "borderEndWidth", "borderPaddingSum", "marginSum", "borderBoxExtent", "contentBoxExtent", "pageAreaPartition", "parentStyle", "pageMarginBoxPartition", "pageRuleMasterInstance", "flexAlign", "align", "availableExtent", "borderBoxSizing", "insideName", "outsideName", "pageMargin", "marginInside", "marginOutside", "paddingInside", "paddingOutside", "borderInsideWidth", "borderOutsideWidth", "getComputedValues", "pageMarginValue", "borderAndPadding", "marginBoxes", "pageAreaDimension", "widthVal", "widthMinMaxFitContent", "minWidthVal", "maxWidthVal", "heightVal", "heightMinMaxFitContent", "minHeightVal", "maxHeightVal", "PageManager", "rootPageBoxInstance", "styleInstance", "isVersoFirstPage", "isVersoPage", "pageMasterInstance", "applied", "propsStr", "pageMod2", "newPageMaster", "pageMasterStyle", "CheckPageTypeAction", "IsFirstPageAction", "IsBlankPageAction", "IsLeftPageAction", "IsRightPageAction", "IsRectoPageAction", "IsVersoPageAction", "IsNthPageAction", "ApplyPageRuleAction", "mergeInPageRule", "targetMap", "boxName", "targetBox", "PageParserHandler", "pageProps", "selectors", "selector", "noPageSelectorProps", "marginBoxMap", "boxStyle", "PageMarginBoxParserHandler", "allowScripts", "setAllowScripts", "deferredScripts", "sameScripts", "getScriptsInOrNearHead", "scriptsInBodyNotNearHead", "script", "loadScript", "srcScriptElem", "window", "flags", "scriptContent", "isModule", "isMathJax", "async", "defer", "needDefer", "hasScripts", "scriptElem", "attr", "getAllFontFamilyList", "srcDocument", "fontFamilySet", "findFontFamilyInStyle", "family1", "marginBoxStyle", "findAllFontFamily", "arg", "prepareTextContentForWebFonts", "textContentDiv", "loadScriptsInHead", "srcScripts", "needPrepareForWebFonts", "savedDollar", "forceDefer", "loadScriptsAtEnd", "transformURIs", "attributeValue", "m1", "namespacePrefixMap", "initIFrame", "iframe", "version", "_ViewFactory", "footnoteStyle", "stylerProducer", "customRenderer", "fallbackMap", "cascStyle", "subShadow", "addedNames", "att", "childStyle", "childDisplay", "shadowStyler", "computedPseudoStyleMap", "computedPseudoStyle", "refDocParam", "refDoc", "refElement", "refStyler", "shadow", "templateURLVal", "cont2", "verticalParent", "verticalChanged", "displayValues", "shadowRoot", "nodeStyle", "inheritanceVisitor", "prop1", "lhUnitSize", "sname", "numericVal", "needToProcessChildren", "inheritedValues", "positionCV", "floatCV", "floatReferenceCV", "shadowParam", "isMultiColumn", "floating", "breakInside", "insideNonRootMultiColumn", "pageVal", "borderCollapse", "borderSpacing", "inlineBorderSpacing", "blockBorderSpacing", "outerPseudo", "hyphenateCharacter", "wordBreak", "overflowWrap", "custom", "tag", "originalTag", "hp", "elemResult", "imageResolution", "images", "cssWidth", "cssHeight", "attrWidth", "attrHeight", "hasAutoWidth", "hasAutoHeight", "attributes", "attributeCount", "delayedSrc", "delayedAlt", "attribute", "attributeNS", "transformedValue", "anchorElem", "image", "attributePrefix", "imageFetcher", "isInsideRunningElement", "listStyleURL", "marginBreak", "breakType", "anyBreak", "unforcedBreak", "markerOffset", "parentViewNode", "paddingBlockStart", "borderBlockStartWidth", "scaledWidth", "scaledHeight", "numericMaxWidth", "numericMaxHeight", "minWidth", "minHeight", "numericMinWidth", "numericMinHeight", "parentFormattingContext", "repeatOnBreak", "offsetInNode", "textContent", "originl", "processedText", "processChildren", "isPseudo", "contentNode", "contentShadowType", "contentShadow", "shadowNode", "sr", "transclusionType", "proc", "bg", "isRelativePositioned", "propertiesNotPassedToDOM", "emUnitSize", "parsedVal", "parentLineHeight", "lineHeightNum", "ancestorLH", "fontSizePx", "pn", "shadowSibling", "childComputedStyle", "nodeContext1", "isBeforeBlock", "nextElem", "blockNestCount", "extentBefore", "textAlign", "elem2", "paddingInlineEnd", "borderInlineEndWidth", "adjust", "checkForcedLineBreakElem", "elem1", "forcedBreakElem", "anonymousBlock", "step1", "step2", "nodePosition1", "nodePosition2", "ViewFactory", "DefaultClientLayout", "originRect", "viewportLeft", "viewportTop", "layoutBoxRect", "Viewport", "pixelRatio", "opt_root", "opt_width", "opt_height", "outerZoomBox", "contentContainer", "layoutBox", "fallbackPageSize", "isHeadlessBrowser", "XMLDocHolder", "NodeList", "offsetStr", "srcNode", "xmlid", "DOMParserSupportedType", "parseAndReturnNullIfError", "opt_parser", "docElement", "errorTagName", "resolveContentType", "contentType", "supportedKeys", "parseXMLResource", "newXMLDocStore", "Predicate", "_Predicate", "opt_childPredicate", "predicate", "_NodeList", "pr", "uaStylesheetBaseFetcher", "loadUABase", "CounterStyleParserHandler", "counterStyleName", "counterStyles", "Style", "rootBox", "fontFaces", "footnoteProps", "flowProps", "viewportProps", "textZoom", "scaleFactor", "defaultFontSize", "defaultLang", "fontMapper", "pageNumberOffset", "pageProgression", "flowStyle", "consume", "pageStyle", "isRectoStart", "isLTR", "instance", "supported", "SupportsReceiver", "supportsReceiver", "sph", "StyleParserHandler", "chunkOffset", "layoutPosition", "noLookAhead", "currentPosition", "consumedOffset", "flowChunkBreakBefore", "flowBreakAfter", "pageMasters", "coeff", "utilization", "em", "pageArea", "savedPageType", "flows", "breakOffsetBeforeStartIndex", "breakOffsetBeforeStart", "parentFlowPosition", "parentStartOffset", "checkPageFloatForLaterPage", "pageStartPos", "deferredFloatOffset", "invalidated", "parentInvalidated", "repeatedIndices", "removedIndices", "selected", "lastAfterPosition", "counterConstraint", "exclusions", "currentColumnIndex", "innerShape", "forceNonFitting", "dontApplyExclusions", "boxContainer", "columnPageFloatLayoutContext", "positionAtColumnStart", "columnY", "columnX", "pagePageFloatLayoutContext", "positionAtContainerStart", "isFirstTime", "layoutColumns", "generatorResult", "columnBalancer", "innerShapeVal", "dontExclude", "forwardOrderInLayout", "removed", "innerContainerTag", "innerContainer", "outerShape", "LIMIT_PAGES", "bleedBoxPaddingEdge", "BaseParserHandler", "_BaseParserHandler", "masterHandler", "pageHandler", "regionHandler", "parseOPSResource", "OPSDocStore", "fontDeobfuscator", "authorStyleSheets", "userStyleSheets", "stylesheet", "triggerList", "triggerElem", "observer", "event", "sources", "title", "rel", "source", "meta", "bulletClosed", "bulletOpen", "bulletEmpty", "findTocElements", "tocElems", "navs", "tocElem", "findTocAnchorElements", "TOCView", "rendererFactory", "renderer", "srcElem", "viewParent", "behavior", "adaptParentClass", "button", "toggleNodeExpansion", "tocBoxUrl", "viewportSize", "exportTree", "links", "exportLink", "topLevelTree", "tocNodeElem", "ce", "adaptClass", "EPUBDocStore", "opf", "pubURL", "manifestObj", "OPFDoc", "containerURL", "containerXML", "roots", "opfXML", "encXML", "manifestLink", "manifestUrl", "docURL", "removePath", "likelyCorsProblem", "domain", "prePaginated", "OPFItem", "itemElem", "opfURL", "propStr", "getOPFItemId", "makeDeobfuscator", "uid", "makeDigest", "hash", "dataView", "algorithm", "predefinedPrefixes", "defaultIRI", "metaTerms", "getMetadataComparator", "item1", "item2", "m2", "i1", "i2", "readMetadata", "mroot", "prefixes", "prefixMap", "resolveProperty", "iri", "rawItems", "rawItemsByTarget", "rawItem", "makeMetadata", "rawItemArr", "_itemName", "entryMap", "metadata", "sortMetadata", "getMathJaxHub", "math", "supportedMediaTypes", "transformedIdPrefix", "OPFDocumentURLTransformer", "path", "encoded", "epubBaseURL", "pkg", "uidref", "uidElem", "srcToFallbackId", "fallbackSrc", "pageProgressionAttr", "idpfObfURLs", "mediaTypeElems", "handlerId", "mediaType", "epage", "epageCount", "epageIsRenderedPage", "epageCountCallback", "offsetPerEPage", "itemref", "author", "language", "primaryEntryPath", "hrefNoFragment", "itemCount", "tocFound", "readingOrderOrResources", "itemObj", "isInReadingOrder", "encodingFormat", "readingOrderCount", "offsetInItem", "cfi", "opfNav", "idref", "nodeNav", "totalOffset", "makePageAndPosition", "OPFView", "pageSheetSizeReporter", "viewItem", "oldPage", "prevItem", "insertPos", "posParam", "prevPos", "currentPageType", "previousPageType", "scopes", "resultPosition", "seekOffset", "seekOffsetPageIndex", "sync", "resultPage", "normalizedPosition", "notAllPages", "lastResult", "nextViewItem", "nextPage", "isLeft", "otherPageAndPosition", "thisPage", "otherPage", "isRecto", "next2", "result2", "oldPrevPageCont", "restored", "pageCont", "matrix", "cssMatrix", "data", "handlerSrc", "srcParam", "typeParam", "pvalue", "hub", "clonedMath", "queue", "attrs", "newUrl", "loadingContinuations", "epubSpineProperties", "previousViewItem", "pageCounterOffset", "pubTitles", "items", "autohide", "toc", "tocWidth", "tocHeight", "VIEWPORT_STATUS_ATTRIBUTE", "VIEWPORT_SPREAD_VIEW_ATTRIBUTE", "AdaptiveViewer", "viewportElement", "instanceId", "callbackFn", "findOrCreateStyleElement", "cssText", "styleElement", "logLevel", "info", "readyState", "command", "authorStyleSheet", "userStyleSheet", "resolvedParams", "unitPattern", "matched", "vp", "spread", "leftWidth", "rightWidth", "vs", "spreadView", "hasNoAutoSizedPages", "spreadViewChanged", "pageSheetSize", "convertSize", "pt", "widthMax", "heightMax", "widthPt", "heightPt", "rightPt", "bottomPt", "styleText", "tocVisible", "tocAutohide", "zoom", "pageDimension", "pageDim", "widthZoom", "heightZoom", "RenderingCanceledError", "resizeTask", "notification", "method", "visibility", "currentVisibility", "changeAutohide", "hideTOC", "actionName", "cmd", "maybeParse", "viewer", "hrefEvent", "internal", "frameInternal", "_RenderingCanceledError", "getDefaultViewerOptions", "convertViewerOptions", "settings", "opt_options", "singleDocumentOptions", "opt_documentOptions", "opt_viewerOptions", "pubUrl", "documentOptions", "convertStyleSheetArray", "convertSingleDocumentOptions", "nav", "opt_epage", "opt_show", "opt_autohide", "toNumberOrNull", "opt", "VivliostylePrint", "htmlDoc", "printCallback", "iframeWin", "errorCallback", "hideIframe", "removeIframe", "docBlob", "Viewer", "resolve", "payload", "config", "import_core", "html", "css", "title", "htmlDoc", "iframeWin", "pageCount", "message"]
}
